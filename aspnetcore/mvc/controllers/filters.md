---
title: Filtres dans ASP.NET Core
author: ardalis
description: Découvrez comment les filtres fonctionnent et comment les utiliser dans ASP.NET Core MVC.
ms.author: riande
ms.custom: mvc
ms.date: 02/08/2019
uid: mvc/controllers/filters
ms.openlocfilehash: a9081a9938d56b7612bba13937eba384ff02455b
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/01/2019
ms.locfileid: "57035246"
---
# <a name="filters-in-aspnet-core"></a><span data-ttu-id="d5c33-103">Filtres dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="d5c33-103">Filters in ASP.NET Core</span></span>

<span data-ttu-id="d5c33-104">Par [Rick Anderson](https://twitter.com/RickAndMSFT), [Tom Dykstra](https://github.com/tdykstra/) et [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="d5c33-104">By [Rick Anderson](https://twitter.com/RickAndMSFT), [Tom Dykstra](https://github.com/tdykstra/), and [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="d5c33-105">Les *filtres* dans ASP.NET Core MVC vous permettent d’exécuter du code avant ou après des étapes spécifiques du pipeline de traitement des requêtes.</span><span class="sxs-lookup"><span data-stu-id="d5c33-105">*Filters* in ASP.NET Core MVC allow you to run code before or after specific stages in the request processing pipeline.</span></span>

 <span data-ttu-id="d5c33-106">Les filtres intégrés gèrent notamment les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="d5c33-106">Built-in filters handle tasks such as:</span></span>

 * <span data-ttu-id="d5c33-107">Autorisation (empêcher un utilisateur non autorisé d’accéder à des ressources).</span><span class="sxs-lookup"><span data-stu-id="d5c33-107">Authorization (preventing access to resources a user isn't authorized for).</span></span>
 * <span data-ttu-id="d5c33-108">Vérification de l’utilisation du protocole HTTPS par toutes les requêtes.</span><span class="sxs-lookup"><span data-stu-id="d5c33-108">Ensuring that all requests use HTTPS.</span></span>
 * <span data-ttu-id="d5c33-109">Mise en cache des réponses (court-circuitage du pipeline de requêtes pour retourner une réponse mise en cache).</span><span class="sxs-lookup"><span data-stu-id="d5c33-109">Response caching (short-circuiting the request pipeline to return a cached response).</span></span> 

<span data-ttu-id="d5c33-110">Il est possible de créer des filtres personnalisés pour gérer les problèmes transversaux.</span><span class="sxs-lookup"><span data-stu-id="d5c33-110">Custom filters can be created to handle cross-cutting concerns.</span></span> <span data-ttu-id="d5c33-111">Les filtres peuvent éviter la duplication de code entre les actions.</span><span class="sxs-lookup"><span data-stu-id="d5c33-111">Filters can avoid duplicating code across actions.</span></span> <span data-ttu-id="d5c33-112">Par exemple, un filtre d’exceptions de gestion des erreurs peut servir à consolider la gestion des erreurs.</span><span class="sxs-lookup"><span data-stu-id="d5c33-112">For example, an error handling exception filter could consolidate error handling.</span></span>

<span data-ttu-id="d5c33-113">[Affichez ou téléchargez un exemple depuis GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span><span class="sxs-lookup"><span data-stu-id="d5c33-113">[View or download sample from GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span></span>

## <a name="how-filters-work"></a><span data-ttu-id="d5c33-114">Fonctionnement des filtres</span><span class="sxs-lookup"><span data-stu-id="d5c33-114">How filters work</span></span>

<span data-ttu-id="d5c33-115">Les filtres s’exécutent dans le *pipeline des appels d’actions MVC*, parfois appelé *pipeline de filtres*.</span><span class="sxs-lookup"><span data-stu-id="d5c33-115">Filters run within the *MVC action invocation pipeline*, sometimes referred to as the *filter pipeline*.</span></span>  <span data-ttu-id="d5c33-116">Le pipeline de filtres s’exécute après la sélection par MVC de l’action à exécuter.</span><span class="sxs-lookup"><span data-stu-id="d5c33-116">The filter pipeline runs after MVC selects the action to execute.</span></span>

![La requête est traitée via un autre intergiciel, un intergiciel de routage, une sélection d’action et le pipeline d’appels d’actions MVC.](filters/_static/filter-pipeline-1.png)

### <a name="filter-types"></a><span data-ttu-id="d5c33-119">Types de filtres</span><span class="sxs-lookup"><span data-stu-id="d5c33-119">Filter types</span></span>

<span data-ttu-id="d5c33-120">Chaque type de filtre est exécuté dans une étape différente du pipeline de filtres.</span><span class="sxs-lookup"><span data-stu-id="d5c33-120">Each filter type is executed at a different stage in the filter pipeline.</span></span>

* <span data-ttu-id="d5c33-121">Les [filtres d’autorisations](#authorization-filters) s’exécutent en premier et sont utilisés pour déterminer si l’utilisateur actif est autorisé pour la requête active.</span><span class="sxs-lookup"><span data-stu-id="d5c33-121">[Authorization filters](#authorization-filters) run first and are used to determine whether the current user is authorized for the current request.</span></span> <span data-ttu-id="d5c33-122">Ils peuvent court-circuiter le pipeline si une requête n’est pas autorisée.</span><span class="sxs-lookup"><span data-stu-id="d5c33-122">They can short-circuit the pipeline if a request is unauthorized.</span></span> 

* <span data-ttu-id="d5c33-123">Les [filtres de ressources](#resource-filters) sont les premiers à traiter une requête après autorisation.</span><span class="sxs-lookup"><span data-stu-id="d5c33-123">[Resource filters](#resource-filters) are the first to handle a request after authorization.</span></span>  <span data-ttu-id="d5c33-124">Ils peuvent exécuter du code avant le reste du pipeline de filtres, et après que le reste du pipeline est terminé.</span><span class="sxs-lookup"><span data-stu-id="d5c33-124">They can run code before the rest of the filter pipeline, and after the rest of the pipeline has completed.</span></span> <span data-ttu-id="d5c33-125">Ils sont pratiques pour implémenter la mise en cache ou pour court-circuiter le pipeline de filtres pour des raisons de performances.</span><span class="sxs-lookup"><span data-stu-id="d5c33-125">They're useful to implement caching or otherwise short-circuit the filter pipeline for performance reasons.</span></span> <span data-ttu-id="d5c33-126">Comme ils s’exécutent avant la liaison de données, ils peuvent l’influencer.</span><span class="sxs-lookup"><span data-stu-id="d5c33-126">They run before model binding, so they can influence model binding.</span></span>

* <span data-ttu-id="d5c33-127">Les [filtres d’actions](#action-filters) peuvent exécuter du code juste avant et juste après l’appel d’une méthode d’action individuelle.</span><span class="sxs-lookup"><span data-stu-id="d5c33-127">[Action filters](#action-filters) can run code immediately before and after an individual action method is called.</span></span> <span data-ttu-id="d5c33-128">Ils peuvent être utilisés pour manipuler les arguments passés à une action et le résultat retourné depuis l’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-128">They can be used to manipulate the arguments passed into an action and the result returned from the action.</span></span> <span data-ttu-id="d5c33-129">Les filtres d’action ne sont pas pris en charge dans les Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="d5c33-129">Action filters are not supported in Razor Pages.</span></span>

* <span data-ttu-id="d5c33-130">Les [filtres d’exceptions](#exception-filters) sont utilisés pour appliquer des stratégies globales à des exceptions non gérées qui se produisent avant que des éléments aient été écrits dans le corps de la réponse.</span><span class="sxs-lookup"><span data-stu-id="d5c33-130">[Exception filters](#exception-filters) are used to apply global policies to unhandled exceptions that occur before anything has been written to the response body.</span></span>

* <span data-ttu-id="d5c33-131">Les [filtres de résultats](#result-filters) peuvent exécuter du code juste avant et juste après l’exécution des résultats d’une action individuelle.</span><span class="sxs-lookup"><span data-stu-id="d5c33-131">[Result filters](#result-filters) can run code immediately before and after the execution of individual action results.</span></span> <span data-ttu-id="d5c33-132">Ils s’exécutent uniquement au terme de l’exécution de la méthode d’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-132">They run only when the action method has executed successfully.</span></span> <span data-ttu-id="d5c33-133">Ils sont utiles pour la logique qui doit entourer l’exécution de la vue ou du formateur.</span><span class="sxs-lookup"><span data-stu-id="d5c33-133">They are useful for logic that must surround view or formatter execution.</span></span>

<span data-ttu-id="d5c33-134">Le diagramme suivant montre comment ces types de filtres interagissent dans le pipeline de filtres.</span><span class="sxs-lookup"><span data-stu-id="d5c33-134">The following diagram shows how these filter types interact in the filter pipeline.</span></span>

![La requête est traitée à travers les filtres d’autorisations, les filtres de ressources, la liaison de modèle, les filtres d’actions, l’exécution d’actions et la conversion des résultats d’actions, les filtres d’exceptions, les filtres de résultats et l’exécution de résultats.](filters/_static/filter-pipeline-2.png)

## <a name="implementation"></a><span data-ttu-id="d5c33-137">Implémentation</span><span class="sxs-lookup"><span data-stu-id="d5c33-137">Implementation</span></span>

<span data-ttu-id="d5c33-138">Les filtres prennent en charge les implémentations synchrones et asynchrones via différentes définitions d’interface.</span><span class="sxs-lookup"><span data-stu-id="d5c33-138">Filters support both synchronous and asynchronous implementations through different interface definitions.</span></span> 

<span data-ttu-id="d5c33-139">Les filtres synchrones qui peuvent exécuter du code avant et après leur étape de pipeline définissent les méthodes On*Stage*Executing et On*Stage*Executed.</span><span class="sxs-lookup"><span data-stu-id="d5c33-139">Synchronous filters that can run code both before and after their pipeline stage define On*Stage*Executing and On*Stage*Executed methods.</span></span> <span data-ttu-id="d5c33-140">Par exemple, `OnActionExecuting` est appelée avant l’appel de la méthode d’action, et `OnActionExecuted` est appelée après que la méthode d’action retourne.</span><span class="sxs-lookup"><span data-stu-id="d5c33-140">For example, `OnActionExecuting` is called before the action method is called, and `OnActionExecuted` is called after the action method returns.</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/SampleActionFilter.cs?name=snippet1)]

<span data-ttu-id="d5c33-141">Les filtres asynchrones définissent une méthode On*Stage*ExecutionAsync.</span><span class="sxs-lookup"><span data-stu-id="d5c33-141">Asynchronous filters define a single On*Stage*ExecutionAsync method.</span></span> <span data-ttu-id="d5c33-142">Cette méthode prend un délégué*FilterType*ExecutionDelegate qui exécute l’étape du pipeline du filtre.</span><span class="sxs-lookup"><span data-stu-id="d5c33-142">This method takes a *FilterType*ExecutionDelegate delegate which executes the filter's pipeline stage.</span></span> <span data-ttu-id="d5c33-143">Par exemple, `ActionExecutionDelegate` appelle la méthode d’action ou le filtre d’action suivant, et vous pouvez exécuter du code avant et après l’appel de cette méthode.</span><span class="sxs-lookup"><span data-stu-id="d5c33-143">For example, `ActionExecutionDelegate` calls the action method or next action filter, and you can execute code before and after you call it.</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/SampleAsyncActionFilter.cs?highlight=6,8-10,13)]

<span data-ttu-id="d5c33-144">Vous pouvez implémenter des interfaces pour plusieurs étapes de filtres dans une même classe.</span><span class="sxs-lookup"><span data-stu-id="d5c33-144">You can implement interfaces for multiple filter stages in a single class.</span></span> <span data-ttu-id="d5c33-145">Par exemple, la classe <xref:Microsoft.AspNetCore.Mvc.Filters.ActionFilterAttribute> implémente `IActionFilter`, `IResultFilter` et leurs équivalents asynchrones.</span><span class="sxs-lookup"><span data-stu-id="d5c33-145">For example, the <xref:Microsoft.AspNetCore.Mvc.Filters.ActionFilterAttribute> class implements `IActionFilter`, `IResultFilter`, and their async equivalents.</span></span>

> [!NOTE]
> <span data-ttu-id="d5c33-146">Implémentez la version synchrone **ou bien** la version asynchrone d’une interface de filtre, mais pas les deux.</span><span class="sxs-lookup"><span data-stu-id="d5c33-146">Implement **either** the synchronous or the async version of a filter interface, not both.</span></span> <span data-ttu-id="d5c33-147">Le framework vérifie d’abord si le filtre implémente l’interface asynchrone et, le cas échéant, il appelle cette interface.</span><span class="sxs-lookup"><span data-stu-id="d5c33-147">The framework checks first to see if the filter implements the async interface, and if so, it calls that.</span></span> <span data-ttu-id="d5c33-148">Dans le cas contraire, il appelle la ou les méthodes de l’interface synchrone.</span><span class="sxs-lookup"><span data-stu-id="d5c33-148">If not, it calls the synchronous interface's method(s).</span></span> <span data-ttu-id="d5c33-149">Si vous implémentez les deux interfaces sur une même classe, seule la méthode asynchrone est appelée.</span><span class="sxs-lookup"><span data-stu-id="d5c33-149">If you were to implement both interfaces on one class, only the async method would be called.</span></span> <span data-ttu-id="d5c33-150">Quand vous utilisez des classes abstraites comme <xref:Microsoft.AspNetCore.Mvc.Filters.ActionFilterAttribute>, vous devez remplacer seulement les méthodes synchrones ou bien la méthode asynchrone pour chaque type de filtre.</span><span class="sxs-lookup"><span data-stu-id="d5c33-150">When using abstract classes like <xref:Microsoft.AspNetCore.Mvc.Filters.ActionFilterAttribute> you would override only the synchronous methods or the async method for each filter type.</span></span>

### <a name="ifilterfactory"></a><span data-ttu-id="d5c33-151">IFilterFactory</span><span class="sxs-lookup"><span data-stu-id="d5c33-151">IFilterFactory</span></span>

<span data-ttu-id="d5c33-152">[IFilterFactory](/dotnet/api/microsoft.aspnetcore.mvc.filters.ifilterfactory) implémente <xref:Microsoft.AspNetCore.Mvc.Filters.IFilterMetadata>.</span><span class="sxs-lookup"><span data-stu-id="d5c33-152">[IFilterFactory](/dotnet/api/microsoft.aspnetcore.mvc.filters.ifilterfactory) implements <xref:Microsoft.AspNetCore.Mvc.Filters.IFilterMetadata>.</span></span> <span data-ttu-id="d5c33-153">Par conséquent, une instance de `IFilterFactory` peut être utilisée comme instance de `IFilterMetadata` n’importe où dans le pipeline de filtres.</span><span class="sxs-lookup"><span data-stu-id="d5c33-153">Therefore, an `IFilterFactory` instance can be used as an `IFilterMetadata` instance anywhere in the filter pipeline.</span></span> <span data-ttu-id="d5c33-154">Quand le framework se prépare à appeler le filtre, il tente d’effectuer un cast en `IFilterFactory`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-154">When the framework prepares to invoke the filter, it attempts to cast it to an `IFilterFactory`.</span></span> <span data-ttu-id="d5c33-155">Si ce cast réussit, la méthode [CreateInstance](/dotnet/api/microsoft.aspnetcore.mvc.filters.ifilterfactory.createinstance) est appelée pour créer l’instance de `IFilterMetadata` qui sera appelée.</span><span class="sxs-lookup"><span data-stu-id="d5c33-155">If that cast succeeds, the [CreateInstance](/dotnet/api/microsoft.aspnetcore.mvc.filters.ifilterfactory.createinstance) method is called to create the `IFilterMetadata` instance that will be invoked.</span></span> <span data-ttu-id="d5c33-156">La conception est flexible, car il n’est pas nécessaire de définir explicitement le pipeline de filtres exact quand l’application démarre.</span><span class="sxs-lookup"><span data-stu-id="d5c33-156">This provides a flexible design, since the precise filter pipeline doesn't need to be set explicitly when the app starts.</span></span>

<span data-ttu-id="d5c33-157">Une autre approche pour la création de filtres est d’implémenter `IFilterFactory` sur vos propres implémentations d’attributs :</span><span class="sxs-lookup"><span data-stu-id="d5c33-157">You can implement `IFilterFactory` on your own attribute implementations as another approach to creating filters:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/AddHeaderWithFactoryAttribute.cs?name=snippet_IFilterFactory&highlight=1,4,5,6,7)]

### <a name="built-in-filter-attributes"></a><span data-ttu-id="d5c33-158">Attributs de filtre intégrés</span><span class="sxs-lookup"><span data-stu-id="d5c33-158">Built-in filter attributes</span></span>

<span data-ttu-id="d5c33-159">Le framework inclut les filtres intégrés basés sur des attributs que vous pouvez définir dans une sous-classe et personnaliser.</span><span class="sxs-lookup"><span data-stu-id="d5c33-159">The framework includes built-in attribute-based filters that you can subclass and customize.</span></span> <span data-ttu-id="d5c33-160">Par exemple, le filtre de résultats suivant ajoute un en-tête à la réponse.</span><span class="sxs-lookup"><span data-stu-id="d5c33-160">For example, the following Result filter adds a header to the response.</span></span>

<a name="add-header-attribute"></a>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/AddHeaderAttribute.cs?highlight=5,16)]

<span data-ttu-id="d5c33-161">Les attributs autorisent les filtres à accepter des arguments, comme montré dans l’exemple ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="d5c33-161">Attributes allow filters to accept arguments, as shown in the example above.</span></span> <span data-ttu-id="d5c33-162">Vous pouvez ajouter cet attribut à une méthode de contrôleur ou d’action, et spécifier le nom et la valeur de l’en-tête HTTP :</span><span class="sxs-lookup"><span data-stu-id="d5c33-162">You would add this attribute to a controller or action method and specify the name and value of the HTTP header:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Controllers/SampleController.cs?name=snippet_AddHeader&highlight=1)]

<span data-ttu-id="d5c33-163">Le résultat de l’action `Index` est montré ci-dessous : les en-têtes de réponse apparaissent dans la partie inférieure droite.</span><span class="sxs-lookup"><span data-stu-id="d5c33-163">The result of the `Index` action is shown below - the response headers are displayed on the bottom right.</span></span>

![Les outils de développement de Microsoft Edge affichant des en-têtes de réponse, notamment l’auteur Steve Smith@ardalis](filters/_static/add-header.png)

<span data-ttu-id="d5c33-165">Plusieurs des interfaces de filtre ont des attributs correspondants qui peuvent être utilisés comme classes de base pour des implémentations personnalisées.</span><span class="sxs-lookup"><span data-stu-id="d5c33-165">Several of the filter interfaces have corresponding attributes that can be used as base classes for custom implementations.</span></span>

<span data-ttu-id="d5c33-166">Les attributs de filtre :</span><span class="sxs-lookup"><span data-stu-id="d5c33-166">Filter attributes:</span></span>

* `ActionFilterAttribute`
* `ExceptionFilterAttribute`
* `ResultFilterAttribute`
* `FormatFilterAttribute`
* `ServiceFilterAttribute`
* `TypeFilterAttribute`

<span data-ttu-id="d5c33-167">`TypeFilterAttribute` et `ServiceFilterAttribute` sont expliqués [ plus loin dans cet article](#dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="d5c33-167">`TypeFilterAttribute` and `ServiceFilterAttribute` are explained [later in this article](#dependency-injection).</span></span>

## <a name="filter-scopes-and-order-of-execution"></a><span data-ttu-id="d5c33-168">Étendues de filtre et ordre d’exécution</span><span class="sxs-lookup"><span data-stu-id="d5c33-168">Filter scopes and order of execution</span></span>

<span data-ttu-id="d5c33-169">Un filtre peut être ajouté au pipeline à une parmi trois *étendues*.</span><span class="sxs-lookup"><span data-stu-id="d5c33-169">A filter can be added to the pipeline at one of three *scopes*.</span></span> <span data-ttu-id="d5c33-170">Vous pouvez ajouter un filtre à une méthode d’action particulière ou à une classe de contrôleur en utilisant un attribut.</span><span class="sxs-lookup"><span data-stu-id="d5c33-170">You can add a filter to a particular action method or to a controller class by using an attribute.</span></span> <span data-ttu-id="d5c33-171">Vous pouvez également enregistrer un filtre globalement pour l’ensemble des contrôleurs et des actions.</span><span class="sxs-lookup"><span data-stu-id="d5c33-171">Or you can register a filter globally for all controllers and actions.</span></span> <span data-ttu-id="d5c33-172">Pour ajouter des filtres globalement, ajoutez-les à la collection `MvcOptions.Filters` dans `ConfigureServices` :</span><span class="sxs-lookup"><span data-stu-id="d5c33-172">Filters are added globally by adding it to the `MvcOptions.Filters` collection in `ConfigureServices`:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Startup.cs?name=snippet_ConfigureServices&highlight=5-8)]

### <a name="default-order-of-execution"></a><span data-ttu-id="d5c33-173">Ordre d’exécution par défaut</span><span class="sxs-lookup"><span data-stu-id="d5c33-173">Default order of execution</span></span>

<span data-ttu-id="d5c33-174">Quand il existe plusieurs filtres pour une étape particulière du pipeline, l’étendue détermine l’ordre par défaut de l’exécution du filtre.</span><span class="sxs-lookup"><span data-stu-id="d5c33-174">When there are multiple filters for a particular stage of the pipeline, scope determines the default order of filter execution.</span></span>  <span data-ttu-id="d5c33-175">Les filtres globaux entourent les filtres de classe, qui à leur tour entourent les filtres de méthode.</span><span class="sxs-lookup"><span data-stu-id="d5c33-175">Global filters surround class filters, which in turn surround method filters.</span></span> <span data-ttu-id="d5c33-176">On parle parfois d’imbrication en « poupées russes », car chaque accroissement d’étendue englobe l’étendue précédente, comme une [poupée gigogne](https://wikipedia.org/wiki/Matryoshka_doll).</span><span class="sxs-lookup"><span data-stu-id="d5c33-176">This is sometimes referred to as "Russian doll" nesting, as each increase in scope is wrapped around the previous scope, like a [nesting doll](https://wikipedia.org/wiki/Matryoshka_doll).</span></span> <span data-ttu-id="d5c33-177">En règle générale, vous obtenez le comportement de remplacement souhaité sans avoir à déterminer l’ordre explicitement.</span><span class="sxs-lookup"><span data-stu-id="d5c33-177">You generally get the desired overriding behavior without having to explicitly determine ordering.</span></span>

<span data-ttu-id="d5c33-178">En raison de cette imbrication, le code *après* des filtres s’exécute dans l’ordre inverse du code *avant*.</span><span class="sxs-lookup"><span data-stu-id="d5c33-178">As a result of this nesting, the *after* code of filters runs in the reverse order of the *before* code.</span></span> <span data-ttu-id="d5c33-179">La séquence ressemble à ceci :</span><span class="sxs-lookup"><span data-stu-id="d5c33-179">The sequence looks like this:</span></span>

* <span data-ttu-id="d5c33-180">Le code *avant* des filtres appliqués globalement</span><span class="sxs-lookup"><span data-stu-id="d5c33-180">The *before* code of filters applied globally</span></span>
  * <span data-ttu-id="d5c33-181">Le code *avant* des filtres appliqués aux contrôleurs</span><span class="sxs-lookup"><span data-stu-id="d5c33-181">The *before* code of filters applied to controllers</span></span>
    * <span data-ttu-id="d5c33-182">Le code *avant* des filtres appliqués aux méthodes d’action</span><span class="sxs-lookup"><span data-stu-id="d5c33-182">The *before* code of filters applied to action methods</span></span>
    * <span data-ttu-id="d5c33-183">Le code *après* des filtres appliqués aux méthodes d’action</span><span class="sxs-lookup"><span data-stu-id="d5c33-183">The *after* code of filters applied to action methods</span></span>
  * <span data-ttu-id="d5c33-184">Le code *après* des filtres appliqués aux contrôleurs</span><span class="sxs-lookup"><span data-stu-id="d5c33-184">The *after* code of filters applied to controllers</span></span>
* <span data-ttu-id="d5c33-185">Le code *après* des filtres appliqués globalement</span><span class="sxs-lookup"><span data-stu-id="d5c33-185">The *after* code of filters applied globally</span></span>
  
<span data-ttu-id="d5c33-186">Voici un exemple qui illustre l’ordre dans lequel les méthodes de filtre sont appelées pour les filtres d’actions synchrones.</span><span class="sxs-lookup"><span data-stu-id="d5c33-186">Here's an example that illustrates the order in which filter methods are called for synchronous Action filters.</span></span>

| <span data-ttu-id="d5c33-187">Séquence</span><span class="sxs-lookup"><span data-stu-id="d5c33-187">Sequence</span></span> | <span data-ttu-id="d5c33-188">Étendue de filtre</span><span class="sxs-lookup"><span data-stu-id="d5c33-188">Filter scope</span></span> | <span data-ttu-id="d5c33-189">Méthode de filtre</span><span class="sxs-lookup"><span data-stu-id="d5c33-189">Filter method</span></span> |
|:--------:|:------------:|:-------------:|
| <span data-ttu-id="d5c33-190">1</span><span class="sxs-lookup"><span data-stu-id="d5c33-190">1</span></span> | <span data-ttu-id="d5c33-191">Global</span><span class="sxs-lookup"><span data-stu-id="d5c33-191">Global</span></span> | `OnActionExecuting` |
| <span data-ttu-id="d5c33-192">2</span><span class="sxs-lookup"><span data-stu-id="d5c33-192">2</span></span> | <span data-ttu-id="d5c33-193">Contrôleur</span><span class="sxs-lookup"><span data-stu-id="d5c33-193">Controller</span></span> | `OnActionExecuting` |
| <span data-ttu-id="d5c33-194">3</span><span class="sxs-lookup"><span data-stu-id="d5c33-194">3</span></span> | <span data-ttu-id="d5c33-195">Méthode</span><span class="sxs-lookup"><span data-stu-id="d5c33-195">Method</span></span> | `OnActionExecuting` |
| <span data-ttu-id="d5c33-196">4</span><span class="sxs-lookup"><span data-stu-id="d5c33-196">4</span></span> | <span data-ttu-id="d5c33-197">Méthode</span><span class="sxs-lookup"><span data-stu-id="d5c33-197">Method</span></span> | `OnActionExecuted` |
| <span data-ttu-id="d5c33-198">5</span><span class="sxs-lookup"><span data-stu-id="d5c33-198">5</span></span> | <span data-ttu-id="d5c33-199">Contrôleur</span><span class="sxs-lookup"><span data-stu-id="d5c33-199">Controller</span></span> | `OnActionExecuted` |
| <span data-ttu-id="d5c33-200">6</span><span class="sxs-lookup"><span data-stu-id="d5c33-200">6</span></span> | <span data-ttu-id="d5c33-201">Global</span><span class="sxs-lookup"><span data-stu-id="d5c33-201">Global</span></span> | `OnActionExecuted` |

<span data-ttu-id="d5c33-202">Cette séquence montre que :</span><span class="sxs-lookup"><span data-stu-id="d5c33-202">This sequence shows:</span></span>

* <span data-ttu-id="d5c33-203">Le filtre de méthode est imbriqué dans le filtre de contrôleur.</span><span class="sxs-lookup"><span data-stu-id="d5c33-203">The method filter is nested within the controller filter.</span></span>
* <span data-ttu-id="d5c33-204">Le filtre de contrôleur est imbriqué dans le filtre global.</span><span class="sxs-lookup"><span data-stu-id="d5c33-204">The controller filter is nested within the global filter.</span></span> 

<span data-ttu-id="d5c33-205">En d’autres termes, si vous êtes à l’intérieur d’un méthode On*Stage*ExecutionAsync d’un filtre asynchrone, tous les filtres avec une étendue plus étroite s’exécutent alors que votre code est sur la pile.</span><span class="sxs-lookup"><span data-stu-id="d5c33-205">To put it another way, if you're inside an async filter's On*Stage*ExecutionAsync method, all of the filters with a tighter scope run while your code is on the stack.</span></span>

> [!NOTE]
> <span data-ttu-id="d5c33-206">Chaque contrôleur qui hérite de la classe de base `Controller` inclut des méthodes `OnActionExecuting` et `OnActionExecuted`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-206">Every controller that inherits from the `Controller` base class includes `OnActionExecuting` and `OnActionExecuted` methods.</span></span> <span data-ttu-id="d5c33-207">Ces méthodes encapsulent les filtres qui s’exécutent pour une action donnée : `OnActionExecuting` est appelée avant tous les filtres, et `OnActionExecuted` est appelée après tous les filtres.</span><span class="sxs-lookup"><span data-stu-id="d5c33-207">These methods wrap the filters that run for a given action:  `OnActionExecuting` is called before any of the filters, and `OnActionExecuted` is called after all of the filters.</span></span>

### <a name="overriding-the-default-order"></a><span data-ttu-id="d5c33-208">Remplacement de l’ordre par défaut</span><span class="sxs-lookup"><span data-stu-id="d5c33-208">Overriding the default order</span></span>

<span data-ttu-id="d5c33-209">Vous pouvez remplacer la séquence d’exécution par défaut en implémentant `IOrderedFilter`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-209">You can override the default sequence of execution by implementing `IOrderedFilter`.</span></span> <span data-ttu-id="d5c33-210">Cette interface expose une propriété `Order` qui est prioritaire sur l’étendue afin de déterminer l’ordre d’exécution.</span><span class="sxs-lookup"><span data-stu-id="d5c33-210">This interface exposes an `Order` property that takes precedence over scope to determine the order of execution.</span></span> <span data-ttu-id="d5c33-211">Un filtre avec une valeur `Order` inférieure verra son code *avant* exécuté avant celui d’un filtre avec une valeur plus élevée de `Order`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-211">A filter with a lower `Order` value will have its *before* code executed before that of a filter with a higher value of `Order`.</span></span> <span data-ttu-id="d5c33-212">Un filtre avec une valeur `Order` inférieure verra son code *après* exécuté après celui d’un filtre avec une valeur plus élevée de `Order`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-212">A filter with a lower `Order` value will have its *after* code executed after that of a filter with a higher `Order` value.</span></span> <span data-ttu-id="d5c33-213">Vous pouvez définir la propriété `Order` en utilisant un paramètre de constructeur :</span><span class="sxs-lookup"><span data-stu-id="d5c33-213">You can set the `Order` property by using a constructor parameter:</span></span>

```csharp
[MyFilter(Name = "Controller Level Attribute", Order=1)]
```

<span data-ttu-id="d5c33-214">Si vous avez les 3 mêmes filtres d’action de l’exemple précédent, mais que vous définissez la propriété `Order` du filtre de contrôleur et du filtre global respectivement sur 1 et sur 2, l’ordre d’exécution est inversé.</span><span class="sxs-lookup"><span data-stu-id="d5c33-214">If you have the same 3 Action filters shown in the preceding example but set the `Order` property of the controller and global filters to 1 and 2 respectively, the order of execution would be reversed.</span></span>

| <span data-ttu-id="d5c33-215">Séquence</span><span class="sxs-lookup"><span data-stu-id="d5c33-215">Sequence</span></span> | <span data-ttu-id="d5c33-216">Étendue de filtre</span><span class="sxs-lookup"><span data-stu-id="d5c33-216">Filter scope</span></span> | <span data-ttu-id="d5c33-217">Propriété `Order`</span><span class="sxs-lookup"><span data-stu-id="d5c33-217">`Order` property</span></span> | <span data-ttu-id="d5c33-218">Méthode de filtre</span><span class="sxs-lookup"><span data-stu-id="d5c33-218">Filter method</span></span> |
|:--------:|:------------:|:-----------------:|:-------------:|
| <span data-ttu-id="d5c33-219">1</span><span class="sxs-lookup"><span data-stu-id="d5c33-219">1</span></span> | <span data-ttu-id="d5c33-220">Méthode</span><span class="sxs-lookup"><span data-stu-id="d5c33-220">Method</span></span> | <span data-ttu-id="d5c33-221">0</span><span class="sxs-lookup"><span data-stu-id="d5c33-221">0</span></span> | `OnActionExecuting` |
| <span data-ttu-id="d5c33-222">2</span><span class="sxs-lookup"><span data-stu-id="d5c33-222">2</span></span> | <span data-ttu-id="d5c33-223">Contrôleur</span><span class="sxs-lookup"><span data-stu-id="d5c33-223">Controller</span></span> | <span data-ttu-id="d5c33-224">1</span><span class="sxs-lookup"><span data-stu-id="d5c33-224">1</span></span>  | `OnActionExecuting` |
| <span data-ttu-id="d5c33-225">3</span><span class="sxs-lookup"><span data-stu-id="d5c33-225">3</span></span> | <span data-ttu-id="d5c33-226">Global</span><span class="sxs-lookup"><span data-stu-id="d5c33-226">Global</span></span> | <span data-ttu-id="d5c33-227">2</span><span class="sxs-lookup"><span data-stu-id="d5c33-227">2</span></span>  | `OnActionExecuting` |
| <span data-ttu-id="d5c33-228">4</span><span class="sxs-lookup"><span data-stu-id="d5c33-228">4</span></span> | <span data-ttu-id="d5c33-229">Global</span><span class="sxs-lookup"><span data-stu-id="d5c33-229">Global</span></span> | <span data-ttu-id="d5c33-230">2</span><span class="sxs-lookup"><span data-stu-id="d5c33-230">2</span></span>  | `OnActionExecuted` |
| <span data-ttu-id="d5c33-231">5</span><span class="sxs-lookup"><span data-stu-id="d5c33-231">5</span></span> | <span data-ttu-id="d5c33-232">Contrôleur</span><span class="sxs-lookup"><span data-stu-id="d5c33-232">Controller</span></span> | <span data-ttu-id="d5c33-233">1</span><span class="sxs-lookup"><span data-stu-id="d5c33-233">1</span></span>  | `OnActionExecuted` |
| <span data-ttu-id="d5c33-234">6</span><span class="sxs-lookup"><span data-stu-id="d5c33-234">6</span></span> | <span data-ttu-id="d5c33-235">Méthode</span><span class="sxs-lookup"><span data-stu-id="d5c33-235">Method</span></span> | <span data-ttu-id="d5c33-236">0</span><span class="sxs-lookup"><span data-stu-id="d5c33-236">0</span></span>  | `OnActionExecuted` |

<span data-ttu-id="d5c33-237">La propriété `Order` prévaut sur l’étendue lors de la détermination de l’ordre dans lequel les filtres s’exécutent.</span><span class="sxs-lookup"><span data-stu-id="d5c33-237">The `Order` property trumps scope when determining the order in which filters will run.</span></span> <span data-ttu-id="d5c33-238">Les filtres sont d’abord classés par ordre, puis l’étendue est utilisée pour couper les liens.</span><span class="sxs-lookup"><span data-stu-id="d5c33-238">Filters are sorted first by order, then scope is used to break ties.</span></span> <span data-ttu-id="d5c33-239">Tous les filtres intégrés implémentent `IOrderedFilter` et affectent 0 à la valeur `Order` par défaut.</span><span class="sxs-lookup"><span data-stu-id="d5c33-239">All of the built-in filters implement `IOrderedFilter` and set the default `Order` value to 0.</span></span> <span data-ttu-id="d5c33-240">Pour les filtres intégrés, l’étendue détermine l’ordre, sauf si vous affectez à `Order` une valeur différente de zéro.</span><span class="sxs-lookup"><span data-stu-id="d5c33-240">For built-in filters, scope determines order unless you set `Order` to a non-zero value.</span></span>

## <a name="cancellation-and-short-circuiting"></a><span data-ttu-id="d5c33-241">Annulation et court-circuit</span><span class="sxs-lookup"><span data-stu-id="d5c33-241">Cancellation and short circuiting</span></span>

<span data-ttu-id="d5c33-242">Vous pouvez court-circuiter le pipeline de filtres à n’importe quel endroit en définissant la propriété `Result` sur le paramètre `context` fourni à la méthode de filtre.</span><span class="sxs-lookup"><span data-stu-id="d5c33-242">You can short-circuit the filter pipeline at any point by setting the `Result` property on the `context` parameter provided to the filter method.</span></span> <span data-ttu-id="d5c33-243">Par exemple, le filtre de ressources suivant empêche l’exécution du reste du pipeline.</span><span class="sxs-lookup"><span data-stu-id="d5c33-243">For instance, the following Resource filter prevents the rest of the pipeline from executing.</span></span>

<a name="short-circuiting-resource-filter"></a>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/ShortCircuitingResourceFilterAttribute.cs?highlight=12,13,14,15)]

<span data-ttu-id="d5c33-244">Dans le code suivant, les filtres `ShortCircuitingResourceFilter` et `AddHeader` ciblent tous deux la méthode d’action `SomeResource`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-244">In the following code, both the `ShortCircuitingResourceFilter` and the `AddHeader` filter target the `SomeResource` action method.</span></span> <span data-ttu-id="d5c33-245">Voici le `ShortCircuitingResourceFilter` :</span><span class="sxs-lookup"><span data-stu-id="d5c33-245">The `ShortCircuitingResourceFilter`:</span></span>

* <span data-ttu-id="d5c33-246">S’exécute en premier (puisqu’il s’agit d’un filtre de ressources et que `AddHeader` est un filtre d’action).</span><span class="sxs-lookup"><span data-stu-id="d5c33-246">Runs first, because it's a Resource Filter and `AddHeader` is an Action Filter.</span></span>
* <span data-ttu-id="d5c33-247">Court-circuite le reste du pipeline.</span><span class="sxs-lookup"><span data-stu-id="d5c33-247">Short-circuits the rest of the pipeline.</span></span>

<span data-ttu-id="d5c33-248">Le filtre `AddHeader` ne s’exécute donc jamais pour l’action `SomeResource`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-248">Therefore the `AddHeader` filter never runs for the `SomeResource` action.</span></span> <span data-ttu-id="d5c33-249">Ce comportement est le même si les deux filtres sont appliqués au niveau de la méthode d’action, à condition que `ShortCircuitingResourceFilter` soit exécuté en premier.</span><span class="sxs-lookup"><span data-stu-id="d5c33-249">This behavior would be the same if both filters were applied at the action method level, provided the `ShortCircuitingResourceFilter` ran first.</span></span> <span data-ttu-id="d5c33-250">`ShortCircuitingResourceFilter` s’exécute en premier en raison de son type de filtre ou de l’utilisation explicite de la propriété `Order`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-250">The `ShortCircuitingResourceFilter` runs first because of its filter type, or by explicit use of `Order` property.</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Controllers/SampleController.cs?name=snippet_AddHeader&highlight=1,9)]

## <a name="dependency-injection"></a><span data-ttu-id="d5c33-251">Injection de dépendances</span><span class="sxs-lookup"><span data-stu-id="d5c33-251">Dependency injection</span></span>

<span data-ttu-id="d5c33-252">Les filtres peuvent être ajoutés par type ou par instance.</span><span class="sxs-lookup"><span data-stu-id="d5c33-252">Filters can be added by type or by instance.</span></span> <span data-ttu-id="d5c33-253">Si vous ajoutez une instance, celle-ci sera utilisée pour chaque requête.</span><span class="sxs-lookup"><span data-stu-id="d5c33-253">If you add an instance, that instance will be used for every request.</span></span> <span data-ttu-id="d5c33-254">Si vous ajoutez un type, il sera activé par type, ce qui signifie qu’une instance sera créée pour chaque requête et toutes les dépendances du constructeur seront remplies par [injection de dépendances](../../fundamentals/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="d5c33-254">If you add a type, it will be type-activated, meaning an instance will be created for each request and any constructor dependencies will be populated by [dependency injection](../../fundamentals/dependency-injection.md) (DI).</span></span> <span data-ttu-id="d5c33-255">L’ajout d’un filtre par type équivaut à `filters.Add(new TypeFilterAttribute(typeof(MyFilter)))`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-255">Adding a filter by type is equivalent to `filters.Add(new TypeFilterAttribute(typeof(MyFilter)))`.</span></span>

<span data-ttu-id="d5c33-256">Les filtres qui sont implémentés en tant qu’attributs et ajoutés directement à des classes de contrôleur ou à de méthodes d’action ne peut pas avoir de dépendances de constructeur fournies par [injection de dépendances](../../fundamentals/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="d5c33-256">Filters that are implemented as attributes and added directly to controller classes or action methods cannot have constructor dependencies provided by [dependency injection](../../fundamentals/dependency-injection.md) (DI).</span></span> <span data-ttu-id="d5c33-257">La raison en est que les paramètres du constructeur des attributs doivent être fournis là où ils sont appliqués.</span><span class="sxs-lookup"><span data-stu-id="d5c33-257">This is because attributes must have their constructor parameters supplied where they're applied.</span></span> <span data-ttu-id="d5c33-258">Il s’agit d’une limitation de la façon dont les attributs fonctionnent.</span><span class="sxs-lookup"><span data-stu-id="d5c33-258">This is a limitation of how attributes work.</span></span>

<span data-ttu-id="d5c33-259">Si vos filtres ont des dépendances auxquelles vous devez accéder à partir de l’injection de dépendances, plusieurs approches sont prises en charge.</span><span class="sxs-lookup"><span data-stu-id="d5c33-259">If your filters have dependencies that you need to access from DI, there are several supported approaches.</span></span> <span data-ttu-id="d5c33-260">Vous pouvez appliquer votre filtre à une méthode de classe ou d’action de l’une des façons suivantes :</span><span class="sxs-lookup"><span data-stu-id="d5c33-260">You can apply your filter to a class or action method using one of the following:</span></span>

* `ServiceFilterAttribute`
* `TypeFilterAttribute`
* <span data-ttu-id="d5c33-261">`IFilterFactory` implémenté sur votre attribut</span><span class="sxs-lookup"><span data-stu-id="d5c33-261">`IFilterFactory` implemented on your attribute</span></span>

> [!NOTE]
> <span data-ttu-id="d5c33-262">Un journaliseur est une dépendance que vous pouvez obtenir de l’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="d5c33-262">One dependency you might want to get from DI is a logger.</span></span> <span data-ttu-id="d5c33-263">Évitez cependant de créer et d’utiliser des filtres uniquement à des fins de journalisation, car les [fonctionnalités de journalisation intégrées du framework](xref:fundamentals/logging/index) peuvent parfois fournir ce dont vous avez besoin.</span><span class="sxs-lookup"><span data-stu-id="d5c33-263">However, avoid creating and using filters purely for logging purposes, since the [built-in framework logging features](xref:fundamentals/logging/index) may already provide what you need.</span></span> <span data-ttu-id="d5c33-264">Si vous voulez ajouter une journalisation à vos filtres, elle doit être centrée sur les problèmes du domaine métier ou sur un comportement spécifique à votre filtre, au lieu de porter sur les actions de MVC ou sur d’autres événements du framework.</span><span class="sxs-lookup"><span data-stu-id="d5c33-264">If you're going to add logging to your filters, it should focus on business domain concerns or behavior specific to your filter, rather than MVC actions or other framework events.</span></span>

### <a name="servicefilterattribute"></a><span data-ttu-id="d5c33-265">ServiceFilterAttribute</span><span class="sxs-lookup"><span data-stu-id="d5c33-265">ServiceFilterAttribute</span></span>

<span data-ttu-id="d5c33-266">Les types d’implémentation du filtre de service sont enregistrés dans l’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="d5c33-266">Service filter implementation types are registered in DI.</span></span> <span data-ttu-id="d5c33-267">Un `ServiceFilterAttribute` récupère une instance du filtre à partir de l’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="d5c33-267">A `ServiceFilterAttribute` retrieves an instance of the filter from DI.</span></span> <span data-ttu-id="d5c33-268">Ajoutez `ServiceFilterAttribute` au conteneur dans `Startup.ConfigureServices`, et vous le référencez dans un attribut `[ServiceFilter]` :</span><span class="sxs-lookup"><span data-stu-id="d5c33-268">Add the `ServiceFilterAttribute` to the container in `Startup.ConfigureServices`, and reference it in a `[ServiceFilter]` attribute:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Startup.cs?name=snippet_ConfigureServices&highlight=11)]

[!code-csharp[](../../mvc/controllers/filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_ServiceFilter&highlight=1)]

<span data-ttu-id="d5c33-269">Lorsque vous utilisez `ServiceFilterAttribute`, la définition de `IsReusable` indique que l’instance de filtre *peut* être réutilisée en dehors de l’étendue de la requête dans laquelle il a été créé.</span><span class="sxs-lookup"><span data-stu-id="d5c33-269">When using `ServiceFilterAttribute`, setting `IsReusable` is a hint that the filter instance *may* be reused outside of the request scope it was created within.</span></span> <span data-ttu-id="d5c33-270">Le framework ne fournit aucune garantie qu’une seule instance du filtre sera créée ou que le filtre ne sera pas demandé à nouveau par le conteneur d’injection de dépendances à un stade ultérieur.</span><span class="sxs-lookup"><span data-stu-id="d5c33-270">The framework provides no guarantees that a single instance of the filter will be created or the filter will not be re-requested from the DI container at some later point.</span></span> <span data-ttu-id="d5c33-271">Évitez d’utiliser `IsReusable` lors de l’utilisation d’un filtre qui dépend de services avec une durée de vie autre que singleton.</span><span class="sxs-lookup"><span data-stu-id="d5c33-271">Avoid using `IsReusable` when using a filter that depends on services with a lifetime other than singleton.</span></span>

<span data-ttu-id="d5c33-272">L’utilisation de `ServiceFilterAttribute` sans inscription du type de filtre provoque une exception :</span><span class="sxs-lookup"><span data-stu-id="d5c33-272">Using `ServiceFilterAttribute` without registering the filter type results in an exception:</span></span>

```
System.InvalidOperationException: No service for type
'FiltersSample.Filters.AddHeaderFilterWithDI' has been registered.
```

<span data-ttu-id="d5c33-273">L'objet `ServiceFilterAttribute` implémente l'objet `IFilterFactory`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-273">`ServiceFilterAttribute` implements `IFilterFactory`.</span></span> <span data-ttu-id="d5c33-274">`IFilterFactory` expose la méthode `CreateInstance` pour la création d’une instance `IFilterMetadata`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-274">`IFilterFactory` exposes the `CreateInstance` method for creating an `IFilterMetadata` instance.</span></span> <span data-ttu-id="d5c33-275">La méthode `CreateInstance` charge le type spécifié à partir du conteneur de services (injection de dépendances).</span><span class="sxs-lookup"><span data-stu-id="d5c33-275">The `CreateInstance` method loads the specified type from the services container (DI).</span></span>

### <a name="typefilterattribute"></a><span data-ttu-id="d5c33-276">TypeFilterAttribute</span><span class="sxs-lookup"><span data-stu-id="d5c33-276">TypeFilterAttribute</span></span>

<span data-ttu-id="d5c33-277">`TypeFilterAttribute` est similaire à `ServiceFilterAttribute`, mais son type n’est pas résolu directement à partir du conteneur d’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="d5c33-277">`TypeFilterAttribute` is similar to `ServiceFilterAttribute`, but its type isn't resolved directly from the DI container.</span></span> <span data-ttu-id="d5c33-278">Il instancie le type en utilisant `Microsoft.Extensions.DependencyInjection.ObjectFactory`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-278">It instantiates the type by using `Microsoft.Extensions.DependencyInjection.ObjectFactory`.</span></span>

<span data-ttu-id="d5c33-279">En raison de cette différence :</span><span class="sxs-lookup"><span data-stu-id="d5c33-279">Because of this difference:</span></span>

* <span data-ttu-id="d5c33-280">Les types qui sont référencés avec `TypeFilterAttribute` ne doivent pas d’abord être inscrits auprès du conteneur.</span><span class="sxs-lookup"><span data-stu-id="d5c33-280">Types that are referenced using the `TypeFilterAttribute` don't need to be registered with the container first.</span></span>  <span data-ttu-id="d5c33-281">Leurs dépendances sont remplies par le conteneur.</span><span class="sxs-lookup"><span data-stu-id="d5c33-281">They do have their dependencies fulfilled by the container.</span></span> 
* <span data-ttu-id="d5c33-282">`TypeFilterAttribute` peut éventuellement accepter des arguments de constructeur pour le type.</span><span class="sxs-lookup"><span data-stu-id="d5c33-282">`TypeFilterAttribute` can optionally accept constructor arguments for the type.</span></span>

<span data-ttu-id="d5c33-283">Lorsque vous utilisez `TypeFilterAttribute`, la définition de `IsReusable` indique que l’instance de filtre *peut* être réutilisée en dehors de l’étendue de la requête dans laquelle il a été créé.</span><span class="sxs-lookup"><span data-stu-id="d5c33-283">When using `TypeFilterAttribute`, setting `IsReusable` is a hint that the filter instance *may* be reused outside of the request scope it was created within.</span></span> <span data-ttu-id="d5c33-284">Le framework ne fournit aucune garantie qu’une seule instance du filtre sera créée.</span><span class="sxs-lookup"><span data-stu-id="d5c33-284">The framework provides no guarantees that a single instance of the filter will be created.</span></span> <span data-ttu-id="d5c33-285">Évitez d’utiliser `IsReusable` lors de l’utilisation d’un filtre qui dépend de services avec une durée de vie autre que singleton.</span><span class="sxs-lookup"><span data-stu-id="d5c33-285">Avoid using `IsReusable` when using a filter that depends on services with a lifetime other than singleton.</span></span>

<span data-ttu-id="d5c33-286">L’exemple suivant montre comment passer des arguments à un type en utilisant `TypeFilterAttribute` :</span><span class="sxs-lookup"><span data-stu-id="d5c33-286">The following example demonstrates how to pass arguments to a type using `TypeFilterAttribute`:</span></span>

[!code-csharp[](../../mvc/controllers/filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_TypeFilter&highlight=1,2)]
[!code-csharp[](../../mvc/controllers/filters/sample/src/FiltersSample/Filters/LogConstantFilter.cs?name=snippet_TypeFilter_Implementation&highlight=6)]

### <a name="ifilterfactory-implemented-on-your-attribute"></a><span data-ttu-id="d5c33-287">IFilterFactory implémenté sur votre attribut</span><span class="sxs-lookup"><span data-stu-id="d5c33-287">IFilterFactory implemented on your attribute</span></span>

<span data-ttu-id="d5c33-288">Si vous avez un filtre qui :</span><span class="sxs-lookup"><span data-stu-id="d5c33-288">If you have a filter that:</span></span>

* <span data-ttu-id="d5c33-289">Ne nécessite pas d’arguments.</span><span class="sxs-lookup"><span data-stu-id="d5c33-289">Doesn't require any arguments.</span></span>
* <span data-ttu-id="d5c33-290">A des dépendances de constructeur qui doivent être remplies par l’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="d5c33-290">Has constructor dependencies that need to be filled by DI.</span></span>

<span data-ttu-id="d5c33-291">Vous pouvez utiliser votre propre attribut nommé sur les classes et méthodes à la place de `[TypeFilter(typeof(FilterType))]`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-291">You can use your own named attribute on classes and methods instead of `[TypeFilter(typeof(FilterType))]`).</span></span> <span data-ttu-id="d5c33-292">Le filtre suivant montre comment vous pouvez implémenter ceci :</span><span class="sxs-lookup"><span data-stu-id="d5c33-292">The following filter shows how this can be implemented:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/SampleActionFilterAttribute.cs?name=snippet_TypeFilterAttribute&highlight=1,3,7)]

<span data-ttu-id="d5c33-293">Ce filtre peut être appliqué à des classes ou des méthodes avec la syntaxe `[SampleActionFilter]`, au lieu de devoir utiliser `[TypeFilter]` ou `[ServiceFilter]`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-293">This filter can be applied to classes or methods using the `[SampleActionFilter]` syntax, instead of having to use `[TypeFilter]` or `[ServiceFilter]`.</span></span>

## <a name="authorization-filters"></a><span data-ttu-id="d5c33-294">Filtres d’autorisations</span><span class="sxs-lookup"><span data-stu-id="d5c33-294">Authorization filters</span></span>

<span data-ttu-id="d5c33-295">Les *filtres d’autorisations* :</span><span class="sxs-lookup"><span data-stu-id="d5c33-295">*Authorization filters*:</span></span>

* <span data-ttu-id="d5c33-296">Contrôlent l’accès aux méthodes d’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-296">Control access to action methods.</span></span>
* <span data-ttu-id="d5c33-297">Sont les premiers filtres à être exécutée dans le pipeline de filtres.</span><span class="sxs-lookup"><span data-stu-id="d5c33-297">Are the first filters to be executed within the filter pipeline.</span></span> 
* <span data-ttu-id="d5c33-298">Ont une méthode avant, mais pas de méthode après.</span><span class="sxs-lookup"><span data-stu-id="d5c33-298">Have a before method, but no after method.</span></span> 

<span data-ttu-id="d5c33-299">Vous devez écrire un filtre d’autorisation personnalisé seulement si vous écrivez votre propre framework d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="d5c33-299">You should only write a custom authorization filter if you are writing your own authorization framework.</span></span> <span data-ttu-id="d5c33-300">Préférez la configuration de vos stratégies d’autorisation ou l’écriture d’une stratégie d’autorisation personnalisée à l’écriture d’un filtre personnalisé.</span><span class="sxs-lookup"><span data-stu-id="d5c33-300">Prefer configuring your authorization policies or writing a custom authorization policy over writing a custom filter.</span></span> <span data-ttu-id="d5c33-301">L’implémentation des filtres intégrés est responsable seulement de l’appel du système d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="d5c33-301">The built-in filter implementation is just responsible for calling the authorization system.</span></span>

<span data-ttu-id="d5c33-302">Vous ne devez pas lever d’exceptions dans les filtres d’autorisations, car rien ne gère les exceptions (les filtres d’exceptions ne les gèrent pas).</span><span class="sxs-lookup"><span data-stu-id="d5c33-302">You shouldn't throw exceptions within authorization filters, since nothing will handle the exception (exception filters won't handle them).</span></span> <span data-ttu-id="d5c33-303">Songez à émettre un challenge quand une exception se produit.</span><span class="sxs-lookup"><span data-stu-id="d5c33-303">Consider issuing a challenge when an exception occurs.</span></span>

<span data-ttu-id="d5c33-304">Découvrez plus d’informations sur [l’autorisation](xref:security/authorization/introduction).</span><span class="sxs-lookup"><span data-stu-id="d5c33-304">Learn more about [Authorization](xref:security/authorization/introduction).</span></span>

## <a name="resource-filters"></a><span data-ttu-id="d5c33-305">Filtres de ressources</span><span class="sxs-lookup"><span data-stu-id="d5c33-305">Resource filters</span></span>

* <span data-ttu-id="d5c33-306">Implémentez l’interface `IResourceFilter` ou `IAsyncResourceFilter`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-306">Implement either the `IResourceFilter` or `IAsyncResourceFilter` interface,</span></span>
* <span data-ttu-id="d5c33-307">Leur exécution inclut dans un wrapper la majeure partie du pipeline de filtres.</span><span class="sxs-lookup"><span data-stu-id="d5c33-307">Their execution wraps most of the filter pipeline.</span></span> 
* <span data-ttu-id="d5c33-308">Seuls les [filtres d’autorisations](#authorization-filters) s’exécutent avant les filtres de ressources.</span><span class="sxs-lookup"><span data-stu-id="d5c33-308">Only [Authorization filters](#authorization-filters) run before Resource filters.</span></span>

<span data-ttu-id="d5c33-309">Les filtres de ressources sont utiles pour court-circuiter la majeure partie du travail effectué par une requête.</span><span class="sxs-lookup"><span data-stu-id="d5c33-309">Resource filters are useful to short-circuit most of the work a request is doing.</span></span> <span data-ttu-id="d5c33-310">Par exemple, un filtre de mise en cache peut éviter le reste du pipeline si la réponse est dans le cache.</span><span class="sxs-lookup"><span data-stu-id="d5c33-310">For example, a caching filter can avoid the rest of the pipeline if the response is in the cache.</span></span>

<span data-ttu-id="d5c33-311">Le [filtre de ressources de court-circuit](#short-circuiting-resource-filter) montré plus haut est un exemple de filtre de ressources.</span><span class="sxs-lookup"><span data-stu-id="d5c33-311">The [short circuiting resource filter](#short-circuiting-resource-filter) shown earlier is one example of a resource filter.</span></span> <span data-ttu-id="d5c33-312">Un autre exemple est [DisableFormValueModelBindingAttribute](https://github.com/aspnet/Entropy/blob/rel/1.1.1/samples/Mvc.FileUpload/Filters/DisableFormValueModelBindingAttribute.cs) :</span><span class="sxs-lookup"><span data-stu-id="d5c33-312">Another example is [DisableFormValueModelBindingAttribute](https://github.com/aspnet/Entropy/blob/rel/1.1.1/samples/Mvc.FileUpload/Filters/DisableFormValueModelBindingAttribute.cs):</span></span>

* <span data-ttu-id="d5c33-313">Il empêche la liaison de données d’accéder aux données de formulaire.</span><span class="sxs-lookup"><span data-stu-id="d5c33-313">It prevents model binding from accessing the form data.</span></span> 
* <span data-ttu-id="d5c33-314">Il est utile pour les chargements de fichiers volumineux et pour empêcher que le formulaire ne soit lu en mémoire.</span><span class="sxs-lookup"><span data-stu-id="d5c33-314">It's useful for large file uploads and want to prevent the form from being read into memory.</span></span>

## <a name="action-filters"></a><span data-ttu-id="d5c33-315">Filtres d’actions</span><span class="sxs-lookup"><span data-stu-id="d5c33-315">Action filters</span></span>

> [!IMPORTANT]
> <span data-ttu-id="d5c33-316">Les filtres d’action ne s’appliquent **pas** aux Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="d5c33-316">Action filters do **not** apply to Razor Pages.</span></span> <span data-ttu-id="d5c33-317">Razor Pages prennent en charge <xref:Microsoft.AspNetCore.Mvc.Filters.IPageFilter> et <xref:Microsoft.AspNetCore.Mvc.Filters.IAsyncPageFilter> .</span><span class="sxs-lookup"><span data-stu-id="d5c33-317">Razor Pages supports <xref:Microsoft.AspNetCore.Mvc.Filters.IPageFilter> and <xref:Microsoft.AspNetCore.Mvc.Filters.IAsyncPageFilter> .</span></span> <span data-ttu-id="d5c33-318">Pour plus d’informations, consultez [Méthodes de filtre pour les pages Razor](xref:razor-pages/filter).</span><span class="sxs-lookup"><span data-stu-id="d5c33-318">For more information, see [Filter methods for Razor Pages](xref:razor-pages/filter).</span></span>

<span data-ttu-id="d5c33-319">*Filtres d’actions* :</span><span class="sxs-lookup"><span data-stu-id="d5c33-319">*Action filters*:</span></span>

* <span data-ttu-id="d5c33-320">Implémentez l’interface `IActionFilter` ou `IAsyncActionFilter`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-320">Implement either the `IActionFilter` or `IAsyncActionFilter` interface.</span></span>
* <span data-ttu-id="d5c33-321">Leur exécution entoure l’exécution de méthodes d’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-321">Their execution surrounds the execution of action methods.</span></span>

<span data-ttu-id="d5c33-322">Voici un exemple de filtre d’actions :</span><span class="sxs-lookup"><span data-stu-id="d5c33-322">Here's a sample action filter:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/SampleActionFilter.cs?name=snippet_ActionFilter)]

<span data-ttu-id="d5c33-323"><xref:Microsoft.AspNetCore.Mvc.Filters.ActionExecutingContext> fournit les propriétés suivantes :</span><span class="sxs-lookup"><span data-stu-id="d5c33-323">The <xref:Microsoft.AspNetCore.Mvc.Filters.ActionExecutingContext> provides the following properties:</span></span>

* <span data-ttu-id="d5c33-324">`ActionArguments` : vous permet de manipuler les entrées de l’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-324">`ActionArguments` - lets you manipulate the inputs to the action.</span></span>
* <span data-ttu-id="d5c33-325">`Controller` : vous permet de manipuler l’instance de contrôleur.</span><span class="sxs-lookup"><span data-stu-id="d5c33-325">`Controller` - lets you manipulate the controller instance.</span></span> 
* <span data-ttu-id="d5c33-326">`Result` : la définition de ce paramètre court-circuite l’exécution de la méthode d’action et les filtres d’actions suivants.</span><span class="sxs-lookup"><span data-stu-id="d5c33-326">`Result` - setting this short-circuits execution of the action method and subsequent action filters.</span></span> <span data-ttu-id="d5c33-327">Lever une exception empêche également l’exécution de la méthode d’action et des filtres suivants, mais elle est traitée comme une erreur au lieu d’un résultat correct.</span><span class="sxs-lookup"><span data-stu-id="d5c33-327">Throwing an exception also prevents execution of the action method and subsequent filters, but is treated as a failure instead of a successful result.</span></span>

<span data-ttu-id="d5c33-328"><xref:Microsoft.AspNetCore.Mvc.Filters.ActionExecutedContext> fournit `Controller` et `Result`, en plus des propriétés suivantes :</span><span class="sxs-lookup"><span data-stu-id="d5c33-328">The <xref:Microsoft.AspNetCore.Mvc.Filters.ActionExecutedContext> provides `Controller` and `Result` plus the following properties:</span></span>

* <span data-ttu-id="d5c33-329">`Canceled` : sa valeur est true si l’exécution de l’action a été court-circuitée par un autre filtre.</span><span class="sxs-lookup"><span data-stu-id="d5c33-329">`Canceled` - will be true if the action execution was short-circuited by another filter.</span></span>
* <span data-ttu-id="d5c33-330">`Exception` : sa valeur est non Null si l’action ou un filtre d’actions suivant a levé une exception.</span><span class="sxs-lookup"><span data-stu-id="d5c33-330">`Exception` - will be non-null if the action or a subsequent action filter threw an exception.</span></span> <span data-ttu-id="d5c33-331">La définition de cette propriété sur Null « gère » effectivement une exception, et `Result` est exécuté comme s’il avait été retourné normalement depuis la méthode d’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-331">Setting this property to null effectively 'handles' an exception, and `Result` will be executed as if it were returned from the action method normally.</span></span>

<span data-ttu-id="d5c33-332">Pour un `IAsyncActionFilter`, un appel à `ActionExecutionDelegate` :</span><span class="sxs-lookup"><span data-stu-id="d5c33-332">For an `IAsyncActionFilter`, a call to the `ActionExecutionDelegate`:</span></span>

* <span data-ttu-id="d5c33-333">Exécute tous les filtres d’actions suivants et la méthode d’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-333">Executes any subsequent action filters and the action method.</span></span>
* <span data-ttu-id="d5c33-334">Retourne `ActionExecutedContext`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-334">returns `ActionExecutedContext`.</span></span> 

<span data-ttu-id="d5c33-335">Pour court-circuiter, affectez `ActionExecutingContext.Result` à une instance de résultat et n’appelez pas le `ActionExecutionDelegate`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-335">To short-circuit, assign `ActionExecutingContext.Result` to some result instance and don't call the `ActionExecutionDelegate`.</span></span>

<span data-ttu-id="d5c33-336">Le framework fournit un `ActionFilterAttribute` abstrait que vous pouvez placer dans une sous-classe.</span><span class="sxs-lookup"><span data-stu-id="d5c33-336">The framework provides an abstract `ActionFilterAttribute` that you can subclass.</span></span> 

<span data-ttu-id="d5c33-337">Vous pouvez utiliser un filtre d’actions pour valider l’état du modèle et retourner des erreurs si l’état n’est pas valide :</span><span class="sxs-lookup"><span data-stu-id="d5c33-337">You can use an action filter to validate model state and return any errors if the state is invalid:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/ValidateModelAttribute.cs)]

<span data-ttu-id="d5c33-338">La méthode `OnActionExecuted` s’exécute après la méthode d’action, et peut voir et manipuler les résultats de l’action via la propriété `ActionExecutedContext.Result`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-338">The `OnActionExecuted` method runs after the action method and can see and manipulate the results of the action through the `ActionExecutedContext.Result` property.</span></span> <span data-ttu-id="d5c33-339">`ActionExecutedContext.Canceled` est défini sur true si l’exécution de l’action a été court-circuitée par un autre filtre.</span><span class="sxs-lookup"><span data-stu-id="d5c33-339">`ActionExecutedContext.Canceled` will be set to true if the action execution was short-circuited by another filter.</span></span> <span data-ttu-id="d5c33-340">`ActionExecutedContext.Exception` est défini sur une valeur non Null si l’action ou un filtre d’actions suivant a levé une exception.</span><span class="sxs-lookup"><span data-stu-id="d5c33-340">`ActionExecutedContext.Exception` will be set to a non-null value if the action or a subsequent action filter threw an exception.</span></span> <span data-ttu-id="d5c33-341">Le fait de définir `ActionExecutedContext.Exception` avec la valeur null :</span><span class="sxs-lookup"><span data-stu-id="d5c33-341">Setting `ActionExecutedContext.Exception` to null:</span></span>

* <span data-ttu-id="d5c33-342">« Gère » effectivement une exception.</span><span class="sxs-lookup"><span data-stu-id="d5c33-342">Effectively 'handles' an exception.</span></span>
* <span data-ttu-id="d5c33-343">`ActionExecutedContext.Result` est exécuté comme s’il avait été retourné normalement à partir de la méthode d’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-343">`ActionExecutedContext.Result` is executed as if it were returned normally from the action method.</span></span>

## <a name="exception-filters"></a><span data-ttu-id="d5c33-344">Filtres d’exceptions</span><span class="sxs-lookup"><span data-stu-id="d5c33-344">Exception filters</span></span>

<span data-ttu-id="d5c33-345">Les *filtres d’exceptions* implémentent l’interface `IExceptionFilter` ou `IAsyncExceptionFilter`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-345">*Exception filters* implement either the `IExceptionFilter` or `IAsyncExceptionFilter` interface.</span></span> <span data-ttu-id="d5c33-346">Ils peuvent être utilisés pour implémenter des stratégies de gestion des erreurs courantes pour une application.</span><span class="sxs-lookup"><span data-stu-id="d5c33-346">They can be used to implement common error handling policies for an app.</span></span> 

<span data-ttu-id="d5c33-347">L’exemple de filtre d’exceptions suivant utilise une vue personnalisée des erreurs pour le développeur, pour afficher des détails sur les exceptions qui se produisent pendant que l’application est en développement :</span><span class="sxs-lookup"><span data-stu-id="d5c33-347">The following sample exception filter uses a custom developer error view to display details about exceptions that occur when the app is in development:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/CustomExceptionFilterAttribute.cs?name=snippet_ExceptionFilter&highlight=1,14)]

<span data-ttu-id="d5c33-348">Les filtres d’exceptions :</span><span class="sxs-lookup"><span data-stu-id="d5c33-348">Exception filters:</span></span>

* <span data-ttu-id="d5c33-349">N’ont pas d’événements avant et après.</span><span class="sxs-lookup"><span data-stu-id="d5c33-349">Don't have before and after events.</span></span> 
* <span data-ttu-id="d5c33-350">Implémentent `OnException` ou `OnExceptionAsync`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-350">Implement `OnException` or `OnExceptionAsync`.</span></span> 
* <span data-ttu-id="d5c33-351">Gèrent les exceptions non gérées qui se produisent dans la création des contrôleurs, la [liaison de données](../models/model-binding.md), les filtres d’actions ou les méthodes d’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-351">Handle unhandled exceptions that occur in controller creation, [model binding](../models/model-binding.md), action filters, or action methods.</span></span> 
* <span data-ttu-id="d5c33-352">N’interceptent pas les exceptions qui se produisent dans l’exécution des filtres de ressources, des filtres de résultats ou des résultats MVC.</span><span class="sxs-lookup"><span data-stu-id="d5c33-352">Do not catch exceptions that occur in Resource filters, Result filters, or MVC Result execution.</span></span>

<span data-ttu-id="d5c33-353">Pour gérer une exception, définissez la propriété `ExceptionContext.ExceptionHandled` ou écrivez une réponse.</span><span class="sxs-lookup"><span data-stu-id="d5c33-353">To handle an exception, set the `ExceptionContext.ExceptionHandled` property to true or write a response.</span></span> <span data-ttu-id="d5c33-354">Ceci arrête la propagation de l’exception.</span><span class="sxs-lookup"><span data-stu-id="d5c33-354">This stops propagation of the exception.</span></span> <span data-ttu-id="d5c33-355">Un filtre d’exceptions ne peut pas changer une exception en « réussite ».</span><span class="sxs-lookup"><span data-stu-id="d5c33-355">An Exception filter can't turn an exception into a "success".</span></span> <span data-ttu-id="d5c33-356">Seul un filtre d’actions peut le faire.</span><span class="sxs-lookup"><span data-stu-id="d5c33-356">Only an Action filter can do that.</span></span>

> [!NOTE]
> <span data-ttu-id="d5c33-357">Dans ASP.NET Core 1.1, la réponse n’est pas envoyée si vous définissez `ExceptionHandled` avec la valeur true **et** que vous écrivez une réponse.</span><span class="sxs-lookup"><span data-stu-id="d5c33-357">In ASP.NET Core 1.1, the response isn't sent if you set `ExceptionHandled` to true **and** write a response.</span></span> <span data-ttu-id="d5c33-358">Dans ce scénario, ASP.NET Core 1.0 envoie la réponse, et ASP.NET Core 1.1.2 revient au comportement de la version 1.0.</span><span class="sxs-lookup"><span data-stu-id="d5c33-358">In that scenario, ASP.NET Core 1.0 does send the response, and ASP.NET Core 1.1.2 will return to the 1.0 behavior.</span></span> <span data-ttu-id="d5c33-359">Pour plus d’informations, consultez le [problème #5594](https://github.com/aspnet/Mvc/issues/5594) dans le dépôt GitHub.</span><span class="sxs-lookup"><span data-stu-id="d5c33-359">For more information, see [issue #5594](https://github.com/aspnet/Mvc/issues/5594) in the GitHub repository.</span></span> 

<span data-ttu-id="d5c33-360">Les filtres d’exceptions :</span><span class="sxs-lookup"><span data-stu-id="d5c33-360">Exception filters:</span></span>

* <span data-ttu-id="d5c33-361">Conviennent pour intercepter des exceptions qui se produisent dans les actions MVC.</span><span class="sxs-lookup"><span data-stu-id="d5c33-361">Are good for trapping exceptions that occur within MVC actions.</span></span>
* <span data-ttu-id="d5c33-362">N’offrent pas la même souplesse que le middleware (intergiciel) de gestion des erreurs.</span><span class="sxs-lookup"><span data-stu-id="d5c33-362">Are not as flexible as error handling middleware.</span></span> 

<span data-ttu-id="d5c33-363">Privilégiez le middleware pour la gestion des exceptions.</span><span class="sxs-lookup"><span data-stu-id="d5c33-363">Prefer middleware for exception handling.</span></span> <span data-ttu-id="d5c33-364">Utilisez uniquement des filtres d’exceptions si vous devez gérer les erreurs *différemment* en fonction de l’action MVC choisie.</span><span class="sxs-lookup"><span data-stu-id="d5c33-364">Use exception filters only where you need to do error handling *differently* based on which MVC action was chosen.</span></span> <span data-ttu-id="d5c33-365">Par exemple, votre application peut avoir des méthodes d’action à la fois pour des points de terminaison d’API et pour des vues/HTML.</span><span class="sxs-lookup"><span data-stu-id="d5c33-365">For example, your app might have action methods for both API endpoints and for views/HTML.</span></span> <span data-ttu-id="d5c33-366">Les points de terminaison d’API peuvent retourner des informations d’erreur au format JSON, tandis que les actions basées sur une vue peuvent retourner une page d’erreur au format HTML.</span><span class="sxs-lookup"><span data-stu-id="d5c33-366">The API endpoints could return error information as JSON, while the view-based actions could return an error page as HTML.</span></span>

<span data-ttu-id="d5c33-367">`ExceptionFilterAttribute` peut être sous-classé.</span><span class="sxs-lookup"><span data-stu-id="d5c33-367">The `ExceptionFilterAttribute` can be subclassed.</span></span> 

## <a name="result-filters"></a><span data-ttu-id="d5c33-368">Filtres de résultats</span><span class="sxs-lookup"><span data-stu-id="d5c33-368">Result filters</span></span>

* <span data-ttu-id="d5c33-369">Implémenter une interface :</span><span class="sxs-lookup"><span data-stu-id="d5c33-369">Implement an interface:</span></span>
  * <span data-ttu-id="d5c33-370">`IResultFilter` ou `IAsyncResultFilter`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-370">`IResultFilter` or `IAsyncResultFilter`.</span></span>
  * <span data-ttu-id="d5c33-371">`IAlwaysRunResultFilter` ou `IAsyncAlwaysRunResultFilter`</span><span class="sxs-lookup"><span data-stu-id="d5c33-371">`IAlwaysRunResultFilter` or `IAsyncAlwaysRunResultFilter`</span></span>
* <span data-ttu-id="d5c33-372">Leur exécution entoure l’exécution de résultats d’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-372">Their execution surrounds the execution of action results.</span></span> 

### <a name="iresultfilter-and-iasyncresultfilter"></a><span data-ttu-id="d5c33-373">IResultFilter et IAsyncResultFilter</span><span class="sxs-lookup"><span data-stu-id="d5c33-373">IResultFilter and IAsyncResultFilter</span></span>

<span data-ttu-id="d5c33-374">Voici un exemple de filtre de résultats qui ajoute un en-tête HTTP.</span><span class="sxs-lookup"><span data-stu-id="d5c33-374">Here's an example of a Result filter that adds an HTTP header.</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/LoggingAddHeaderFilter.cs?name=snippet_ResultFilter)]

<span data-ttu-id="d5c33-375">Le type de résultat à exécuter dépend de l’action en question.</span><span class="sxs-lookup"><span data-stu-id="d5c33-375">The kind of result being executed depends on the action in question.</span></span> <span data-ttu-id="d5c33-376">Une action MVC retournant une vue inclut tous les traitements Razor dans le cadre de la `ViewResult` à exécuter.</span><span class="sxs-lookup"><span data-stu-id="d5c33-376">An MVC action returning a view would include all razor processing as part of the `ViewResult` being executed.</span></span> <span data-ttu-id="d5c33-377">Une méthode d’API peut effectuer une sérialisation dans le cadre de l’exécution du résultat.</span><span class="sxs-lookup"><span data-stu-id="d5c33-377">An API method might perform some serialization as part of the execution of the result.</span></span> <span data-ttu-id="d5c33-378">Découvrez plus d’informations sur les [résultats d’actions](actions.md).</span><span class="sxs-lookup"><span data-stu-id="d5c33-378">Learn more about [action results](actions.md)</span></span>

<span data-ttu-id="d5c33-379">Les filtres de résultats sont exécutés seulement pour les résultats qui sont des réussites, quand l’action ou les filtres d’actions produisent un résultat d’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-379">Result filters are only executed for successful results - when the action or action filters produce an action result.</span></span> <span data-ttu-id="d5c33-380">Les filtres de résultats ne sont pas exécutés quand les filtres d’exceptions gèrent une exception.</span><span class="sxs-lookup"><span data-stu-id="d5c33-380">Result filters are not executed when exception filters handle an exception.</span></span>

<span data-ttu-id="d5c33-381">La méthode `OnResultExecuting` peut court-circuiter l’exécution du résultat d’action et les filtres de résultats suivants en définissant `ResultExecutingContext.Cancel` sur true.</span><span class="sxs-lookup"><span data-stu-id="d5c33-381">The `OnResultExecuting` method can short-circuit execution of the action result and subsequent result filters by setting `ResultExecutingContext.Cancel` to true.</span></span> <span data-ttu-id="d5c33-382">D’une façon générale, vous devez écrire dans l’objet de réponse quand vous court-circuitez pour éviter de générer une réponse vide.</span><span class="sxs-lookup"><span data-stu-id="d5c33-382">You should generally write to the response object when short-circuiting to avoid generating an empty response.</span></span> <span data-ttu-id="d5c33-383">La levée d’une exception :</span><span class="sxs-lookup"><span data-stu-id="d5c33-383">Throwing an exception will:</span></span>

* <span data-ttu-id="d5c33-384">Empêche l’exécution du résultat d’action et des filtres suivants.</span><span class="sxs-lookup"><span data-stu-id="d5c33-384">Prevent execution of the action result and subsequent filters.</span></span>
* <span data-ttu-id="d5c33-385">Est traitée comme une erreur et non comme une réussite.</span><span class="sxs-lookup"><span data-stu-id="d5c33-385">Be treated as a failure instead of a successful result.</span></span>

<span data-ttu-id="d5c33-386">Quand la méthode `OnResultExecuted` s’exécute, la réponse a probablement déjà été envoyée au client et ne peut plus être changée (sauf si une exception a été levée).</span><span class="sxs-lookup"><span data-stu-id="d5c33-386">When the `OnResultExecuted` method runs, the response has likely been sent to the client and cannot be changed further (unless an exception was thrown).</span></span> <span data-ttu-id="d5c33-387">`ResultExecutedContext.Canceled` est défini sur true si l’exécution du résultat d’action a été court-circuitée par un autre filtre.</span><span class="sxs-lookup"><span data-stu-id="d5c33-387">`ResultExecutedContext.Canceled` will be set to true if the action result execution was short-circuited by another filter.</span></span>

<span data-ttu-id="d5c33-388">`ResultExecutedContext.Exception` est défini sur une valeur non Null si le résultat d’action ou un filtre de résultats suivant a levé une exception.</span><span class="sxs-lookup"><span data-stu-id="d5c33-388">`ResultExecutedContext.Exception` will be set to a non-null value if the action result or a subsequent result filter threw an exception.</span></span> <span data-ttu-id="d5c33-389">Le fait de définir `Exception` sur Null « gère » effectivement une exception et évite à l’exception d’être à nouveau levée par MVC plus loin dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="d5c33-389">Setting `Exception` to null effectively 'handles' an exception and prevents the exception from being rethrown by MVC later in the pipeline.</span></span> <span data-ttu-id="d5c33-390">Quand vous gérez une exception dans un filtre de résultats, il peut être impossible d’écrire des données dans la réponse.</span><span class="sxs-lookup"><span data-stu-id="d5c33-390">When you're handling an exception in a result filter, you might not be able to write any data to the response.</span></span> <span data-ttu-id="d5c33-391">Si le résultat d’une action lève une exception à mi-chemin de son exécution et que les en-têtes ont déjà été envoyés au client, il n’existe aucun mécanisme fiable pour envoyer un code d’échec.</span><span class="sxs-lookup"><span data-stu-id="d5c33-391">If the action result throws partway through its execution, and the headers have already been flushed to the client, there's no reliable mechanism to send a failure code.</span></span>

<span data-ttu-id="d5c33-392">Pour un `IAsyncResultFilter`, un appel à `await next` sur le `ResultExecutionDelegate` exécute tous les filtres de résultats suivants et le résultat de l’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-392">For an `IAsyncResultFilter` a call to `await next` on the `ResultExecutionDelegate` executes any subsequent result filters and the action result.</span></span> <span data-ttu-id="d5c33-393">Pour court-circuiter, définissez `ResultExecutingContext.Cancel` sur true et n’appelez pas le `ResultExectionDelegate`.</span><span class="sxs-lookup"><span data-stu-id="d5c33-393">To short-circuit, set `ResultExecutingContext.Cancel` to true and don't call the `ResultExectionDelegate`.</span></span>

<span data-ttu-id="d5c33-394">Le framework fournit un `ResultFilterAttribute` abstrait que vous pouvez placer dans une sous-classe.</span><span class="sxs-lookup"><span data-stu-id="d5c33-394">The framework provides an abstract `ResultFilterAttribute` that you can subclass.</span></span> <span data-ttu-id="d5c33-395">La classe [AddHeaderAttribute](#add-header-attribute) ci-dessus est un exemple d’un attribut de filtre de résultats.</span><span class="sxs-lookup"><span data-stu-id="d5c33-395">The [AddHeaderAttribute](#add-header-attribute) class shown earlier is an example of a result filter attribute.</span></span>

### <a name="ialwaysrunresultfilter-and-iasyncalwaysrunresultfilter"></a><span data-ttu-id="d5c33-396">IAlwaysRunResultFilter et IAsyncAlwaysRunResultFilter</span><span class="sxs-lookup"><span data-stu-id="d5c33-396">IAlwaysRunResultFilter and IAsyncAlwaysRunResultFilter</span></span>

<span data-ttu-id="d5c33-397">Les interfaces <xref:Microsoft.AspNetCore.Mvc.Filters.IAlwaysRunResultFilter> et <xref:Microsoft.AspNetCore.Mvc.Filters.IAsyncAlwaysRunResultFilter> déclarent une implémentation <xref:Microsoft.AspNetCore.Mvc.Filters.IResultFilter> qui s’exécute pour les résultats d’action.</span><span class="sxs-lookup"><span data-stu-id="d5c33-397">The <xref:Microsoft.AspNetCore.Mvc.Filters.IAlwaysRunResultFilter> and <xref:Microsoft.AspNetCore.Mvc.Filters.IAsyncAlwaysRunResultFilter> interfaces declare an <xref:Microsoft.AspNetCore.Mvc.Filters.IResultFilter> implementation that runs for action results.</span></span> <span data-ttu-id="d5c33-398">Le filtre est appliqué à un résultat d’action, sauf si un <xref:Microsoft.AspNetCore.Mvc.Filters.IExceptionFilter> ou <xref:Microsoft.AspNetCore.Mvc.Filters.IAuthorizationFilter> s’applique et court-circuite la réponse.</span><span class="sxs-lookup"><span data-stu-id="d5c33-398">The filter is applied to an action result unless an <xref:Microsoft.AspNetCore.Mvc.Filters.IExceptionFilter> or <xref:Microsoft.AspNetCore.Mvc.Filters.IAuthorizationFilter> applies and short-circuits the response.</span></span>

<span data-ttu-id="d5c33-399">En d’autres termes, ces filtres « toujours exécuter », s’exécutent toujours, sauf lorsqu’un filtre d’exception ou d’autorisation les court-circuite.</span><span class="sxs-lookup"><span data-stu-id="d5c33-399">In other words, these "always run" filters, always run, except when an exception or authorization filter short-circuits them.</span></span> <span data-ttu-id="d5c33-400">Les filtres autres que `IExceptionFilter` et `IAuthorizationFilter` ne les court-circuitent pas.</span><span class="sxs-lookup"><span data-stu-id="d5c33-400">Filters other than `IExceptionFilter` and `IAuthorizationFilter` don't short circuit them.</span></span>

<span data-ttu-id="d5c33-401">Par exemple, le filtre suivant exécute et définit toujours un résultat d’action (<xref:Microsoft.AspNetCore.Mvc.ObjectResult>) avec un code d’état *422 Entité non traitée* en cas d’échec de la négociation de contenu :</span><span class="sxs-lookup"><span data-stu-id="d5c33-401">For example, the following filter always runs and sets an action result (<xref:Microsoft.AspNetCore.Mvc.ObjectResult>) with a *422 Unprocessable Entity* status code when content negotiation fails:</span></span>

```csharp
public class UnprocessableResultFilter : Attribute, IAlwaysRunResultFilter
{
    public void OnResultExecuting(ResultExecutingContext context)
    {
        if (context.Result is StatusCodeResult statusCodeResult &&
            statusCodeResult.StatusCode == 415)
        {
            context.Result = new ObjectResult("Can't process this!")
            {
                StatusCode = 422,
            };
        }
    }

    public void OnResultExecuted(ResultExecutedContext context)
    {
    }
}
```

## <a name="using-middleware-in-the-filter-pipeline"></a><span data-ttu-id="d5c33-402">Utilisation d’un intergiciel dans le pipeline de filtres</span><span class="sxs-lookup"><span data-stu-id="d5c33-402">Using middleware in the filter pipeline</span></span>

<span data-ttu-id="d5c33-403">Les filtres de ressources fonctionnent comme un [intergiciel](xref:fundamentals/middleware/index) dans la mesure où ils entourent l’exécution de tout ce qui vient plus tard dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="d5c33-403">Resource filters work like [middleware](xref:fundamentals/middleware/index) in that they surround the execution of everything that comes later in the pipeline.</span></span> <span data-ttu-id="d5c33-404">Les filtres diffèrent cependant d’un intergiciel dans la mesure où ils font partie de MVC, ce qui signifie qu’ils ont accès au contexte et aux constructions MVC.</span><span class="sxs-lookup"><span data-stu-id="d5c33-404">But filters differ from middleware in that they're part of MVC, which means that they have access to MVC context and constructs.</span></span>

<span data-ttu-id="d5c33-405">Dans ASP.NET Core 1.1, vous pouvez utiliser un intergiciel dans le pipeline de filtres.</span><span class="sxs-lookup"><span data-stu-id="d5c33-405">In ASP.NET Core 1.1, you can use middleware in the filter pipeline.</span></span> <span data-ttu-id="d5c33-406">Vous pouvez faire cela si vous avez un composant d’intergiciel qui doit accéder aux données de route de MVC, ou qui doit s’exécuter seulement pour certains contrôleurs ou certaines actions.</span><span class="sxs-lookup"><span data-stu-id="d5c33-406">You might want to do that if you have a middleware component that needs access to MVC route data, or one that should run only for certain controllers or actions.</span></span>

<span data-ttu-id="d5c33-407">Pour utiliser un intergiciel comme filtre, créez un type avec une méthode `Configure` qui spécifie l’intergiciel que vous voulez injecter dans le pipeline de filtres.</span><span class="sxs-lookup"><span data-stu-id="d5c33-407">To use middleware as a filter, create a type with a `Configure` method that specifies the middleware that you want to inject into the filter pipeline.</span></span> <span data-ttu-id="d5c33-408">Voici un exemple qui utilise l’intergiciel de localisation pour établir la culture d’une requête :</span><span class="sxs-lookup"><span data-stu-id="d5c33-408">Here's an example that uses the localization middleware to establish the current culture for a request:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Filters/LocalizationPipeline.cs?name=snippet_MiddlewareFilter&highlight=3,21)]

<span data-ttu-id="d5c33-409">Vous pouvez ensuite utiliser `MiddlewareFilterAttribute` pour exécuter l’intergiciel pour un contrôleur ou une action sélectionnés, ou globalement :</span><span class="sxs-lookup"><span data-stu-id="d5c33-409">You can then use the `MiddlewareFilterAttribute` to run the middleware for a selected controller or action or globally:</span></span>

[!code-csharp[](./filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_MiddlewareFilter&highlight=2)]

<span data-ttu-id="d5c33-410">Les filtres d’intergiciels s’exécutent à la même étape du pipeline de filtres en tant que filtres de ressources, avant la liaison de modèle et après le reste du pipeline.</span><span class="sxs-lookup"><span data-stu-id="d5c33-410">Middleware filters run at the same stage of the filter pipeline as Resource filters, before model binding and after the rest of the pipeline.</span></span>

## <a name="next-actions"></a><span data-ttu-id="d5c33-411">Actions suivantes</span><span class="sxs-lookup"><span data-stu-id="d5c33-411">Next actions</span></span>

* <span data-ttu-id="d5c33-412">Consultez [Méthodes de filtre pour les Razor Pages](xref:razor-pages/filter)</span><span class="sxs-lookup"><span data-stu-id="d5c33-412">See [Filter methods for Razor Pages](xref:razor-pages/filter)</span></span>
* <span data-ttu-id="d5c33-413">Pour expérimenter les filtres, [téléchargez, testez et modifiez l’exemple Github](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span><span class="sxs-lookup"><span data-stu-id="d5c33-413">To experiment with filters, [download, test and modify the Github sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span></span>
