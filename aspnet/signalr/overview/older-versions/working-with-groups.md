---
uid: signalr/overview/older-versions/working-with-groups
title: Utilisation des groupes dans Signalr 1. x | Microsoft Docs
author: bradygaster
description: Cette rubrique explique comment conserver les informations d’appartenance à un groupe à l’aide de l’API Hub.
ms.author: bradyg
ms.date: 10/21/2013
ms.assetid: 22929efd-68c9-4609-b76d-f8ba42fda01e
msc.legacyurl: /signalr/overview/older-versions/working-with-groups
msc.type: authoredcontent
ms.openlocfilehash: 5f50dc162d6cdcfbf2261e6a751f5f99078d5c54
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78579365"
---
# <a name="working-with-groups-in-signalr-1x"></a><span data-ttu-id="4ffb6-103">Utilisation des groupes dans SignalR 1.x</span><span class="sxs-lookup"><span data-stu-id="4ffb6-103">Working with Groups in SignalR 1.x</span></span>

<span data-ttu-id="4ffb6-104">de [Patrick Fletcher](https://github.com/pfletcher), [Tom FitzMacken](https://github.com/tfitzmac)</span><span class="sxs-lookup"><span data-stu-id="4ffb6-104">by [Patrick Fletcher](https://github.com/pfletcher), [Tom FitzMacken](https://github.com/tfitzmac)</span></span>

[!INCLUDE [Consider ASP.NET Core SignalR](~/includes/signalr/signalr-version-disambiguation.md)]

> <span data-ttu-id="4ffb6-105">Cette rubrique explique comment ajouter des utilisateurs à des groupes et rendre des informations d’appartenance à un groupe persistantes.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-105">This topic describes how to add users to groups and persist group membership information.</span></span>

## <a name="overview"></a><span data-ttu-id="4ffb6-106">Présentation</span><span class="sxs-lookup"><span data-stu-id="4ffb6-106">Overview</span></span>

<span data-ttu-id="4ffb6-107">Dans Signalr, les groupes fournissent une méthode de diffusion des messages aux sous-ensembles spécifiés de clients connectés.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-107">Groups in SignalR provide a method for broadcasting messages to specified subsets of connected clients.</span></span> <span data-ttu-id="4ffb6-108">Un groupe peut avoir un nombre quelconque de clients et un client peut être membre d’un nombre quelconque de groupes.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-108">A group can have any number of clients, and a client can be a member of any number of groups.</span></span> <span data-ttu-id="4ffb6-109">Vous n’êtes pas obligé de créer explicitement des groupes.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-109">You don't have to explicitly create groups.</span></span> <span data-ttu-id="4ffb6-110">En effet, un groupe est créé automatiquement la première fois que vous spécifiez son nom dans un appel à groups. Add, et il est supprimé lorsque vous supprimez la dernière connexion de l’appartenance à celui-ci.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-110">In effect, a group is automatically created the first time you specify its name in a call to Groups.Add, and it is deleted when you remove the last connection from membership in it.</span></span> <span data-ttu-id="4ffb6-111">Pour une introduction à l’utilisation de groupes, consultez [Comment gérer l’appartenance à un groupe à partir de la classe Hub](index.md) dans le Guide de serveur de l’API hubs.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-111">For an introduction to using groups, see [How to manage group membership from the Hub class](index.md) in the Hubs API - Server Guide.</span></span>

<span data-ttu-id="4ffb6-112">Il n’existe aucune API pour obtenir une liste d’appartenance à un groupe ou une liste de groupes.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-112">There is no API for getting a group membership list or a list of groups.</span></span> <span data-ttu-id="4ffb6-113">Signalr envoie des messages aux clients et aux groupes en fonction d’un modèle Pub/Sub, et le serveur ne gère pas les listes de groupes ou d’appartenances aux groupes.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-113">SignalR sends messages to clients and groups based on a pub/sub model, and the server does not maintain lists of groups or group memberships.</span></span> <span data-ttu-id="4ffb6-114">Cela permet d’optimiser l’évolutivité, car chaque fois que vous ajoutez un nœud à une batterie de serveurs Web, tout état géré par Signalr doit être propagé vers le nouveau nœud.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-114">This helps maximize scalability, because whenever you add a node to a web farm, any state that SignalR maintains has to be propagated to the new node.</span></span>

<span data-ttu-id="4ffb6-115">Lorsque vous ajoutez un utilisateur à un groupe à l’aide de la méthode `Groups.Add`, l’utilisateur reçoit les messages dirigés vers ce groupe pendant la durée de la connexion actuelle, mais l’appartenance de l’utilisateur à ce groupe n’est pas conservée au-delà de la connexion actuelle.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-115">When you add a user to a group using the `Groups.Add` method, the user receives messages directed to that group for the duration of the current connection, but the user's membership in that group is not persisted beyond the current connection.</span></span> <span data-ttu-id="4ffb6-116">Si vous souhaitez conserver définitivement des informations sur les groupes et l’appartenance au groupe, vous devez stocker ces données dans un référentiel tel qu’une base de données ou un stockage table Azure.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-116">If you want to permanently retain information about groups and group membership, you must store that data in a repository such as a database or Azure table storage.</span></span> <span data-ttu-id="4ffb6-117">Ensuite, chaque fois qu’un utilisateur se connecte à votre application, vous récupérez à partir du référentiel auquel appartient l’utilisateur et vous ajoutez manuellement cet utilisateur à ces groupes.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-117">Then, each time a user connects to your application, you retrieve from the repository which groups the user belongs to, and manually add that user to those groups.</span></span>

<span data-ttu-id="4ffb6-118">Lorsqu’il se reconnecte après une interruption temporaire, l’utilisateur rejoint automatiquement les groupes précédemment affectés.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-118">When reconnecting after a temporary disruption, the user automatically re-joins the previously-assigned groups.</span></span> <span data-ttu-id="4ffb6-119">La rejointure automatique d’un groupe s’applique uniquement lors de la reconnexion, et non lors de l’établissement d’une nouvelle connexion.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-119">Automatically rejoining a group only applies when reconnecting, not when establishing a new connection.</span></span> <span data-ttu-id="4ffb6-120">Un jeton signé numériquement est transmis à partir du client qui contient la liste des groupes précédemment affectés.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-120">A digitally-signed token is passed from the client that contains the list of previously-assigned groups.</span></span> <span data-ttu-id="4ffb6-121">Si vous souhaitez vérifier si l’utilisateur appartient aux groupes demandés, vous pouvez remplacer le comportement par défaut.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-121">If you want to verify whether the user belongs to the requested groups, you can override the default behavior.</span></span>

<span data-ttu-id="4ffb6-122">Cette rubrique comporte les sections suivantes :</span><span class="sxs-lookup"><span data-stu-id="4ffb6-122">This topic includes the following sections:</span></span>

- [<span data-ttu-id="4ffb6-123">Ajout et suppression d’utilisateurs</span><span class="sxs-lookup"><span data-stu-id="4ffb6-123">Adding and removing users</span></span>](#add)
- [<span data-ttu-id="4ffb6-124">Appel de membres d’un groupe</span><span class="sxs-lookup"><span data-stu-id="4ffb6-124">Calling members of a group</span></span>](#call)
- [<span data-ttu-id="4ffb6-125">Stockage de l’appartenance à un groupe dans une base de données</span><span class="sxs-lookup"><span data-stu-id="4ffb6-125">Storing group membership in a database</span></span>](#storedatabase)
- [<span data-ttu-id="4ffb6-126">Stockage de l’appartenance aux groupes dans le stockage table Azure</span><span class="sxs-lookup"><span data-stu-id="4ffb6-126">Storing group membership in Azure table storage</span></span>](#storeazuretable)
- [<span data-ttu-id="4ffb6-127">Vérification de l’appartenance au groupe lors de la reconnexion</span><span class="sxs-lookup"><span data-stu-id="4ffb6-127">Verifying group membership when reconnecting</span></span>](#verify)

<a id="add"></a>

## <a name="adding-and-removing-users"></a><span data-ttu-id="4ffb6-128">Ajout et suppression d’utilisateurs</span><span class="sxs-lookup"><span data-stu-id="4ffb6-128">Adding and removing users</span></span>

<span data-ttu-id="4ffb6-129">Pour ajouter ou supprimer des utilisateurs d’un groupe, appelez les méthodes [Add](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.igroupmanager.add(v=vs.111).aspx) ou [Remove](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.igroupmanager.remove(v=vs.111).aspx) , puis transmettez l’ID de connexion et le nom du groupe de l’utilisateur en tant que paramètres.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-129">To add or remove users from a group, you call the [Add](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.igroupmanager.add(v=vs.111).aspx) or [Remove](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.igroupmanager.remove(v=vs.111).aspx) methods, and pass in the user's connection id and group's name as parameters.</span></span> <span data-ttu-id="4ffb6-130">Vous n’avez pas besoin de supprimer manuellement un utilisateur d’un groupe lorsque la connexion se termine.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-130">You do not need to manually remove a user from a group when the connection ends.</span></span>

<span data-ttu-id="4ffb6-131">L’exemple suivant montre les méthodes `Groups.Add` et `Groups.Remove` utilisées dans les méthodes de concentrateur.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-131">The following example shows the `Groups.Add` and `Groups.Remove` methods used in Hub methods.</span></span>

[!code-csharp[Main](working-with-groups/samples/sample1.cs?highlight=5,10)]

<span data-ttu-id="4ffb6-132">Les méthodes `Groups.Add` et `Groups.Remove` s’exécutent de façon asynchrone.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-132">The `Groups.Add` and `Groups.Remove` methods execute asynchronously.</span></span>

<span data-ttu-id="4ffb6-133">Si vous souhaitez ajouter un client à un groupe et envoyer immédiatement un message au client à l’aide du groupe, vous devez vous assurer que la méthode groups. Add se termine en premier.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-133">If you want to add a client to a group and immediately send a message to the client by using the group, you have to make sure that the Groups.Add method finishes first.</span></span> <span data-ttu-id="4ffb6-134">Les exemples de code suivants montrent comment procéder, l’un à l’aide du code qui fonctionne dans .NET 4,5, et l’autre à l’aide du code qui fonctionne dans .NET 4.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-134">The following code examples show how to do that, one by using code that works in .NET 4.5, and one by using code that works in .NET 4.</span></span>

#### <a name="asynchronous-net-45-example"></a><span data-ttu-id="4ffb6-135">Exemple .NET 4,5 asynchrone</span><span class="sxs-lookup"><span data-stu-id="4ffb6-135">Asynchronous .NET 4.5 Example</span></span>

[!code-csharp[Main](working-with-groups/samples/sample2.cs?highlight=1,3)]

#### <a name="asynchronous-net-4-example"></a><span data-ttu-id="4ffb6-136">Exemple de .NET 4 asynchrone</span><span class="sxs-lookup"><span data-stu-id="4ffb6-136">Asynchronous .NET 4 Example</span></span>

[!code-csharp[Main](working-with-groups/samples/sample3.cs?highlight=3-4)]

<span data-ttu-id="4ffb6-137">En général, vous ne devez pas inclure `await` lors de l’appel de la méthode `Groups.Remove`, car l’ID de connexion que vous essayez de supprimer n’est peut-être plus disponible.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-137">In general, you should not include `await` when calling the `Groups.Remove` method because the connection id that you are trying to remove might no longer be available.</span></span> <span data-ttu-id="4ffb6-138">Dans ce cas, `TaskCanceledException` est levée après l’expiration de la demande. Si votre application doit s’assurer que l’utilisateur a été supprimé du groupe avant d’envoyer un message au groupe, vous pouvez ajouter `await` avant groups. Remove, puis intercepter l’exception `TaskCanceledException` qui peut être levée.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-138">In that case, `TaskCanceledException` is thrown after the request times out. If your application must ensure that the user has been removed from the group before sending a message to the group, you can add `await` before Groups.Remove, and then catch the `TaskCanceledException` exception that might be thrown.</span></span>

<a id="call"></a>

## <a name="calling-members-of-a-group"></a><span data-ttu-id="4ffb6-139">Appel de membres d’un groupe</span><span class="sxs-lookup"><span data-stu-id="4ffb6-139">Calling members of a group</span></span>

<span data-ttu-id="4ffb6-140">Vous pouvez envoyer des messages à tous les membres d’un groupe ou uniquement aux membres spécifiés du groupe, comme indiqué dans les exemples suivants.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-140">You can send messages to all of the members of a group or only specified members of the group, as shown in the following examples.</span></span>

- <span data-ttu-id="4ffb6-141">**Tous les** clients connectés dans un groupe spécifié.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-141">**All** connected clients in a specified group.</span></span> 

    [!code-css[Main](working-with-groups/samples/sample4.css)]
- <span data-ttu-id="4ffb6-142">Tous les clients connectés dans un groupe spécifié, **à l’exception des clients spécifiés**, identifiés par l’ID de connexion.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-142">All connected clients in a specified group **except the specified clients**, identified by connection ID.</span></span> 

    [!code-csharp[Main](working-with-groups/samples/sample5.cs)]
- <span data-ttu-id="4ffb6-143">Tous les clients connectés dans un groupe spécifié **, à l’exception du client appelant**.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-143">All connected clients in a specified group **except the calling client**.</span></span> 

    [!code-css[Main](working-with-groups/samples/sample6.css)]

<a id="storedatabase"></a>

## <a name="storing-group-membership-in-a-database"></a><span data-ttu-id="4ffb6-144">Stockage de l’appartenance à un groupe dans une base de données</span><span class="sxs-lookup"><span data-stu-id="4ffb6-144">Storing group membership in a database</span></span>

<span data-ttu-id="4ffb6-145">Les exemples suivants montrent comment conserver des informations sur les groupes et les utilisateurs dans une base de données.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-145">The following examples show how to retain group and user information in a database.</span></span> <span data-ttu-id="4ffb6-146">Vous pouvez utiliser n’importe quelle technologie d’accès aux données ; Toutefois, l’exemple ci-dessous montre comment définir des modèles à l’aide de Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-146">You can use any data access technology; however, the example below shows how to define models using Entity Framework.</span></span> <span data-ttu-id="4ffb6-147">Ces modèles d’entité correspondent aux tables et aux champs de la base de données.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-147">These entity models correspond to database tables and fields.</span></span> <span data-ttu-id="4ffb6-148">La structure de vos données peut varier considérablement en fonction des exigences de votre application.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-148">Your data structure could vary considerably depending on the requirements of your application.</span></span> <span data-ttu-id="4ffb6-149">Cet exemple comprend une classe nommée `ConversationRoom` qui est propre à une application qui permet aux utilisateurs de joindre des conversations sur différents sujets, tels que des sports ou des jardins.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-149">This example includes a class named `ConversationRoom` which would be unique to an application that enables users to join conversations about different subjects, such as sports or gardening.</span></span> <span data-ttu-id="4ffb6-150">Cet exemple comprend également une classe pour les connexions.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-150">This example also includes a class for the connections.</span></span> <span data-ttu-id="4ffb6-151">La classe de connexion n’est pas absolument requise pour le suivi de l’appartenance à un groupe, mais fait souvent partie d’une solution robuste pour le suivi des utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-151">The connection class is not absolutely required for tracking group membership but is frequently part of robust solution to tracking users.</span></span>

[!code-csharp[Main](working-with-groups/samples/sample7.cs)]

<span data-ttu-id="4ffb6-152">Ensuite, dans le Hub, vous pouvez récupérer les informations de groupe et d’utilisateur à partir de la base de données et ajouter manuellement l’utilisateur aux groupes appropriés.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-152">Then, in the hub, you can retrieve the group and user information from the database and manually add the user to the appropriate groups.</span></span> <span data-ttu-id="4ffb6-153">L’exemple n’inclut pas de code pour le suivi des connexions utilisateur.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-153">The example does not include code for tracking the user connections.</span></span> <span data-ttu-id="4ffb6-154">Dans cet exemple, le mot clé `await` n’est pas appliqué avant `Groups.Add` car un message n’est pas immédiatement envoyé aux membres du groupe.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-154">In this example, the `await` keyword is not applied before `Groups.Add` because a message is not immediately sent to members of the group.</span></span> <span data-ttu-id="4ffb6-155">Si vous souhaitez envoyer un message à tous les membres du groupe immédiatement après avoir ajouté le nouveau membre, vous souhaiterez appliquer le mot clé `await` pour vous assurer que l’opération asynchrone est terminée.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-155">If you want to send a message to all members of the group immediately after adding the new member, you would want to apply the `await` keyword to make sure the asynchronous operation has completed.</span></span>

[!code-csharp[Main](working-with-groups/samples/sample8.cs)]

<a id="storeazuretable"></a>

## <a name="storing-group-membership-in-azure-table-storage"></a><span data-ttu-id="4ffb6-156">Stockage de l’appartenance aux groupes dans le stockage table Azure</span><span class="sxs-lookup"><span data-stu-id="4ffb6-156">Storing group membership in Azure table storage</span></span>

<span data-ttu-id="4ffb6-157">L’utilisation du stockage table Azure pour stocker les informations sur les groupes et les utilisateurs est semblable à l’utilisation d’une base de données.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-157">Using Azure table storage to store group and user information is similar to using a database.</span></span> <span data-ttu-id="4ffb6-158">L’exemple suivant montre une entité de table qui stocke le nom d’utilisateur et le nom de groupe.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-158">The following example shows a table entity that stores the user name and group name.</span></span>

[!code-csharp[Main](working-with-groups/samples/sample9.cs)]

<span data-ttu-id="4ffb6-159">Dans le Hub, vous récupérez les groupes affectés lorsque l’utilisateur se connecte.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-159">In the hub, you retrieve the assigned groups when the user connects.</span></span>

[!code-csharp[Main](working-with-groups/samples/sample10.cs)]

<a id="verify"></a>

## <a name="verifying-group-membership-when-reconnecting"></a><span data-ttu-id="4ffb6-160">Vérification de l’appartenance au groupe lors de la reconnexion</span><span class="sxs-lookup"><span data-stu-id="4ffb6-160">Verifying group membership when reconnecting</span></span>

<span data-ttu-id="4ffb6-161">Par défaut, Signalr réattribue automatiquement un utilisateur aux groupes appropriés lors de la reconnexion après une interruption temporaire, par exemple lorsqu’une connexion est supprimée et rétablie avant l’expiration du délai de connexion. Les informations de groupe de l’utilisateur sont transmises dans un jeton lors de la reconnexion, et ce jeton est vérifié sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-161">By default, SignalR automatically re-assigns a user to the appropriate groups when reconnecting from a temporary disruption, such as when a connection is dropped and re-established before the connection times out. The user's group information is passed in a token when reconnecting, and that token is verified on the server.</span></span> <span data-ttu-id="4ffb6-162">Pour plus d’informations sur le processus de vérification pour rattacher des utilisateurs à des groupes, consultez [rejoindre des groupes lors de la reconnexion](index.md).</span><span class="sxs-lookup"><span data-stu-id="4ffb6-162">For information about the verification process for rejoining users to groups, see [Rejoining groups when reconnecting](index.md).</span></span>

<span data-ttu-id="4ffb6-163">En général, vous devez utiliser le comportement par défaut de rejointure automatique des groupes lors de la reconnexion.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-163">In general, you should use the default behavior of automatically rejoining groups on reconnect.</span></span> <span data-ttu-id="4ffb6-164">Les groupes signalr ne sont pas conçus comme un mécanisme de sécurité pour restreindre l’accès aux données sensibles.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-164">SignalR groups are not intended as a security mechanism for restricting access to sensitive data.</span></span> <span data-ttu-id="4ffb6-165">Toutefois, si votre application doit doubler la vérification de l’appartenance à un groupe d’un utilisateur lors de la reconnexion, vous pouvez remplacer le comportement par défaut.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-165">However, if your application must double-check a user's group membership when reconnecting, you can override the default behavior.</span></span> <span data-ttu-id="4ffb6-166">La modification du comportement par défaut peut ajouter une charge à votre base de données, car l’appartenance au groupe d’un utilisateur doit être récupérée pour chaque reconnexion, et non uniquement lorsque l’utilisateur se connecte.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-166">Changing the default behavior can add a burden to your database because a user's group membership must be retrieved for each reconnection rather than just when the user connects.</span></span>

<span data-ttu-id="4ffb6-167">Si vous devez vérifier l’appartenance au groupe lors de la reconnexion, créez un module de pipeline Hub qui retourne la liste des groupes attribués, comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-167">If you must verify group membership on reconnect, create a new hub pipeline module that returns a list of assigned groups, as shown below.</span></span>

[!code-csharp[Main](working-with-groups/samples/sample11.cs)]

<span data-ttu-id="4ffb6-168">Ensuite, ajoutez ce module au pipeline Hub, comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="4ffb6-168">Then, add that module to the hub pipeline, as highlighted below.</span></span>

[!code-csharp[Main](working-with-groups/samples/sample12.cs?highlight=10)]
