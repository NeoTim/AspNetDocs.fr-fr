---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Serveur de d’autorisation OAuth 2.0 OWIN | Microsoft Docs
author: hongyes
description: Ce didacticiel vous guide sur la façon d’implémenter un serveur d’autorisation OAuth 2.0 à l’aide d’intergiciel (middleware) OWIN OAuth. Ceci est un didacticiel avancé que seule Group...
ms.author: riande
ms.date: 01/28/2019
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: 6523d09e41fe10475d1bcb7fca06b2e0e2d3182c
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 05/06/2019
ms.locfileid: "65118199"
---
# <a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="c3acb-104">Serveur d’autorisation OAuth 2.0 OWIN</span><span class="sxs-lookup"><span data-stu-id="c3acb-104">OWIN OAuth 2.0 Authorization Server</span></span>

> <span data-ttu-id="c3acb-105">Ce didacticiel vous guide sur la façon d’implémenter un serveur d’autorisation OAuth 2.0 à l’aide d’intergiciel (middleware) OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="c3acb-105">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="c3acb-106">Il s’agit d’un didacticiel avancé qui ne présente les étapes pour créer un serveur d’autorisation de OWIN OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="c3acb-106">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="c3acb-107">Cela n’est pas un didacticiel étape par étape.</span><span class="sxs-lookup"><span data-stu-id="c3acb-107">This is not a step by step tutorial.</span></span> <span data-ttu-id="c3acb-108">[Télécharger l’exemple de code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="c3acb-108">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="c3acb-109">Ce plan ne doit pas être destiné à utiliser pour la création d’une application de production sécurisé.</span><span class="sxs-lookup"><span data-stu-id="c3acb-109">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="c3acb-110">Ce didacticiel vise à fournir uniquement un plan d’implémentation d’un serveur d’autorisation OAuth 2.0 à l’aide d’intergiciel (middleware) OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="c3acb-110">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="c3acb-111">Versions des logiciels</span><span class="sxs-lookup"><span data-stu-id="c3acb-111">Software versions</span></span>
>
> | <span data-ttu-id="c3acb-112">**Indiqué dans le didacticiel**</span><span class="sxs-lookup"><span data-stu-id="c3acb-112">**Shown in the tutorial**</span></span> | <span data-ttu-id="c3acb-113">**Fonctionne également avec**</span><span class="sxs-lookup"><span data-stu-id="c3acb-113">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="c3acb-114">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="c3acb-114">Windows 8.1</span></span> | <span data-ttu-id="c3acb-115">Windows 10, Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="c3acb-115">Windows 10, Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="c3acb-116">Visual Studio 2017</span><span class="sxs-lookup"><span data-stu-id="c3acb-116">Visual Studio 2017</span></span>](https://visualstudio.microsoft.com/downloads/)
> | <span data-ttu-id="c3acb-117">.NET 4.7.2</span><span class="sxs-lookup"><span data-stu-id="c3acb-117">.NET 4.7.2</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="c3acb-118">Questions et commentaires</span><span class="sxs-lookup"><span data-stu-id="c3acb-118">Questions and comments</span></span>
>
> <span data-ttu-id="c3acb-119">Si vous avez des questions qui ne sont pas directement liées à ce didacticiel, vous pouvez les publier à [projet Katana sur GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="c3acb-119">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="c3acb-120">Pour les questions et commentaires concernant ce didacticiel, consultez la section des commentaires en bas de la page.</span><span class="sxs-lookup"><span data-stu-id="c3acb-120">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>

<span data-ttu-id="c3acb-121">Le [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) permet à une application tierce obtenir un accès limité à un service HTTP.</span><span class="sxs-lookup"><span data-stu-id="c3acb-121">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="c3acb-122">Au lieu d’utiliser les informations d’identification du propriétaire des ressources pour accéder à une ressource protégée, le client obtient un jeton d’accès (qui est une chaîne qui dénote une étendue spécifique, de durée de vie et d’autres attributs d’accès).</span><span class="sxs-lookup"><span data-stu-id="c3acb-122">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="c3acb-123">Jetons d’accès sont émis pour les clients tiers par un serveur d’autorisation avec l’approbation du propriétaire de la ressource.</span><span class="sxs-lookup"><span data-stu-id="c3acb-123">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="c3acb-124">Ce didacticiel couvre :</span><span class="sxs-lookup"><span data-stu-id="c3acb-124">This tutorial will cover:</span></span>

- <span data-ttu-id="c3acb-125">Comment créer un serveur d’autorisation pour prendre en charge d’autorisation quatre types d’octroi et jetons d’actualisation :</span><span class="sxs-lookup"><span data-stu-id="c3acb-125">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="c3acb-126">Octroi de code d’autorisation</span><span class="sxs-lookup"><span data-stu-id="c3acb-126">Authorization code grant</span></span>
    - <span data-ttu-id="c3acb-127">Octroi implicite</span><span class="sxs-lookup"><span data-stu-id="c3acb-127">Implicit Grant</span></span>
    - <span data-ttu-id="c3acb-128">Octroi des informations d’identification mot de passe de propriétaire de la ressource</span><span class="sxs-lookup"><span data-stu-id="c3acb-128">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="c3acb-129">Octroi des informations d’identification client</span><span class="sxs-lookup"><span data-stu-id="c3acb-129">Client Credentials Grant</span></span>
- <span data-ttu-id="c3acb-130">Création d’un serveur de ressource qui est protégé par un jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="c3acb-130">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="c3acb-131">Création de clients de OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="c3acb-131">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="c3acb-132">Prérequis</span><span class="sxs-lookup"><span data-stu-id="c3acb-132">Prerequisites</span></span>

- <span data-ttu-id="c3acb-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) comme indiqué dans **Versions logicielles** en haut de la page.</span><span class="sxs-lookup"><span data-stu-id="c3acb-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="c3acb-134">Vous êtes familiarisé avec OWIN.</span><span class="sxs-lookup"><span data-stu-id="c3acb-134">Familiarity with OWIN.</span></span> <span data-ttu-id="c3acb-135">Consultez [mise en route avec le projet Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) et [Nouveautés OWIN et Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="c3acb-135">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="c3acb-136">Vous êtes familiarisé avec [OAuth](http://tools.ietf.org/html/rfc6749) la terminologie, y compris [rôles](http://tools.ietf.org/html/rfc6749#section-1.1), [flux du protocole](http://tools.ietf.org/html/rfc6749#section-1.2), et [octroi d’autorisation](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="c3acb-136">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="c3acb-137">[Présentation d’OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) constitue une bonne introduction.</span><span class="sxs-lookup"><span data-stu-id="c3acb-137">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="c3acb-138">Créer un serveur d’autorisation</span><span class="sxs-lookup"><span data-stu-id="c3acb-138">Create an Authorization Server</span></span>

<span data-ttu-id="c3acb-139">Dans ce didacticiel, nous sera à peu près esquissez comment utiliser [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) et ASP.NET MVC pour créer un serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-139">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="c3acb-140">Nous espérons que bientôt proposer un téléchargement pour l’exemple terminé, que ce didacticiel n’inclut pas chaque étape.</span><span class="sxs-lookup"><span data-stu-id="c3acb-140">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="c3acb-141">Commencez par créer une application web vide nommée *AuthorizationServer* et installez les packages suivants :</span><span class="sxs-lookup"><span data-stu-id="c3acb-141">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="c3acb-142">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="c3acb-142">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="c3acb-143">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="c3acb-143">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="c3acb-144">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="c3acb-144">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="c3acb-145">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="c3acb-145">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="c3acb-146">Microsoft.Owin.Security.Google (ou toute autre connexion de réseau social de package telles que Microsoft.owin.Security.Facebook contient)</span><span class="sxs-lookup"><span data-stu-id="c3acb-146">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="c3acb-147">Ajouter un [classe de démarrage OWIN](owin-startup-class-detection.md) sous le dossier racine du projet nommé *démarrage*.</span><span class="sxs-lookup"><span data-stu-id="c3acb-147">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="c3acb-148">Créer un *application\_Démarrer* dossier.</span><span class="sxs-lookup"><span data-stu-id="c3acb-148">Create an *App\_Start* folder.</span></span> <span data-ttu-id="c3acb-149">Sélectionnez le *application\_Démarrer* dossier et utilisez Maj + Alt + A pour ajouter la version téléchargée de le *AuthorizationServer\App\_Start\Startup.Auth.cs* fichier.</span><span class="sxs-lookup"><span data-stu-id="c3acb-149">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="c3acb-150">Le code ci-dessus autorise les cookies et l’authentification de Google, qui sont utilisés par le serveur d’autorisation lui-même pour gérer les comptes de connexion/externe de l’application.</span><span class="sxs-lookup"><span data-stu-id="c3acb-150">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="c3acb-151">Le `UseOAuthAuthorizationServer` méthode d’extension consiste à configurer le serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-151">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="c3acb-152">Les options d’installation sont :</span><span class="sxs-lookup"><span data-stu-id="c3acb-152">The setup options are:</span></span>

- <span data-ttu-id="c3acb-153">`AuthorizeEndpointPath`: Le chemin d’accès de requête où les applications clientes redirigeront l’agent utilisateur afin d’obtenir les utilisateurs de consentement pour émettre un jeton ou du code.</span><span class="sxs-lookup"><span data-stu-id="c3acb-153">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="c3acb-154">Il doit commencer par une barre oblique, par exemple, «`/Authorize`».</span><span class="sxs-lookup"><span data-stu-id="c3acb-154">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="c3acb-155">`TokenEndpointPath`: Les applications clientes de chemin d’accès demande communiquent directement pour obtenir le jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="c3acb-155">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="c3acb-156">Il doit commencer par une barre oblique, par exemple « /Token ».</span><span class="sxs-lookup"><span data-stu-id="c3acb-156">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="c3acb-157">Si le client reçoit un [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), elle doit être fournie à ce point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="c3acb-157">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="c3acb-158">`ApplicationCanDisplayErrors`: La valeur `true` si l’application web veut générer une page d’erreur personnalisée pour les erreurs de validation client sur `/Authorize` point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="c3acb-158">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="c3acb-159">Ce paramètre est uniquement nécessaire pour les cas où le navigateur n’est pas redirigé sauvegarder à l’application cliente, par exemple, lorsque le `client_id` ou `redirect_uri` sont incorrectes.</span><span class="sxs-lookup"><span data-stu-id="c3acb-159">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="c3acb-160">Le `/Authorize` point de terminaison doit s’attendre à voir le « oauth. Erreur «, « oauth. ErrorDescription » et « oauth. Propriétés de ErrorUri » sont ajoutées à l’environnement OWIN.</span><span class="sxs-lookup"><span data-stu-id="c3acb-160">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="c3acb-161">Si ce n’est pas le cas, la valeur est true, le serveur d’autorisation renverra une page d’erreur par défaut avec les détails de l’erreur.</span><span class="sxs-lookup"><span data-stu-id="c3acb-161">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="c3acb-162">`AllowInsecureHttp`: True pour permettre à autoriser et demandes de jetons pour arriver sur des adresses URI HTTP et pour autoriser le trafic entrant `redirect_uri` autoriser les paramètres de la demande d’avoir des adresses URI HTTP.</span><span class="sxs-lookup"><span data-stu-id="c3acb-162">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="c3acb-163">Sécurité - Il s’agit uniquement pour le développement.</span><span class="sxs-lookup"><span data-stu-id="c3acb-163">Security - This is for development only.</span></span>
- <span data-ttu-id="c3acb-164">`Provider`: L’objet fourni par l’application pour traiter les événements déclenchés par l’intergiciel (middleware) serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-164">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="c3acb-165">L’application peut implémenter totalement l’interface, ou il peut créer une instance de `OAuthAuthorizationServerProvider` et attribuer des délégués nécessaire pour les flux OAuth prend en charge par ce serveur.</span><span class="sxs-lookup"><span data-stu-id="c3acb-165">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="c3acb-166">`AuthorizationCodeProvider`: Génère un code d’autorisation à usage unique pour revenir à l’application cliente.</span><span class="sxs-lookup"><span data-stu-id="c3acb-166">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="c3acb-167">Sécurisation de l’application pour le serveur OAuth soit **doit** fournir une instance de `AuthorizationCodeProvider` où le jeton produit par le `OnCreate/OnCreateAsync` événement est considéré comme valide pour un seul appel à `OnReceive/OnReceiveAsync`.</span><span class="sxs-lookup"><span data-stu-id="c3acb-167">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="c3acb-168">`RefreshTokenProvider`: Génère un jeton d’actualisation qui peut-être être utilisé pour produire un nouveau jeton d’accès si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="c3acb-168">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="c3acb-169">Si ne pas fourni le serveur d’autorisation ne retourne pas les jetons d’actualisation à partir de la `/Token` point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="c3acb-169">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="c3acb-170">Gestion des comptes</span><span class="sxs-lookup"><span data-stu-id="c3acb-170">Account Management</span></span>

<span data-ttu-id="c3acb-171">OAuth ne soucie pas où et comment gérer les informations de votre compte d’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="c3acb-171">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="c3acb-172">Il a [ASP.NET Identity](../../../identity/index.md) qui en est responsable.</span><span class="sxs-lookup"><span data-stu-id="c3acb-172">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="c3acb-173">Dans ce didacticiel, nous simplifier le code de gestion de compte et vérifiez simplement que cet utilisateur peut ouvrir une session à l’aide de l’intergiciel OWIN cookie.</span><span class="sxs-lookup"><span data-stu-id="c3acb-173">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="c3acb-174">Voici le code exemple simplifié pour le `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="c3acb-174">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="c3acb-175">`ValidateClientRedirectUri` est utilisé pour valider le client avec son URL de redirection inscrits.</span><span class="sxs-lookup"><span data-stu-id="c3acb-175">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="c3acb-176">`ValidateClientAuthentication` vérifie l’en-tête du schéma de base et le corps de formulaire pour obtenir des informations d’identification du client.</span><span class="sxs-lookup"><span data-stu-id="c3acb-176">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="c3acb-177">La page de connexion est indiquée ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="c3acb-177">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="c3acb-178">Passez en revue OAuth 2 l’IETF [octroi de Code d’autorisation](http://tools.ietf.org/html/rfc6749#section-4.1) section maintenant.</span><span class="sxs-lookup"><span data-stu-id="c3acb-178">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="c3acb-179">**Fournisseur** (dans le tableau ci-dessous) est [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Fournisseur, qui est de type `OAuthAuthorizationServerProvider`, qui contient tous les événements de serveur OAuth.</span><span class="sxs-lookup"><span data-stu-id="c3acb-179">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="c3acb-180">Étapes du flux à partir de la section d’octroi de Code d’autorisation</span><span class="sxs-lookup"><span data-stu-id="c3acb-180">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="c3acb-181">Téléchargement de l’exemple effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="c3acb-181">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="c3acb-182">(A) le client lance le flux en dirigeant l’agent utilisateur du propriétaire des ressources au point de terminaison d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-182">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="c3acb-183">Le client inclut son identificateur client, étendue demandée, état local et un URI de redirection auquel le serveur d’autorisation envoie l’agent utilisateur une fois l’accès est accordé (ou refusé).</span><span class="sxs-lookup"><span data-stu-id="c3acb-183">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="c3acb-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="c3acb-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="c3acb-185">(B) le serveur d’autorisation authentifie le propriétaire de la ressource (par le biais de l’agent utilisateur) et détermine si le propriétaire de la ressource accorde ou refuse la demande d’accès du client.</span><span class="sxs-lookup"><span data-stu-id="c3acb-185">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="c3acb-186">**&lt;Si l’utilisateur accorde l’accès&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="c3acb-186">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="c3acb-187">(C) en supposant que le propriétaire de la ressource accorde l’accès, le serveur d’autorisation redirige l’agent utilisateur vers le client à l’aide de l’URI de redirection fourni précédemment (dans la demande ou lors de l’inscription du client).</span><span class="sxs-lookup"><span data-stu-id="c3acb-187">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="c3acb-188">...</span><span class="sxs-lookup"><span data-stu-id="c3acb-188">...</span></span> |  |
|  |  |
| <span data-ttu-id="c3acb-189">(D) le client demande un jeton d’accès à partir du point de terminaison de jeton du serveur d’autorisation en incluant le code d’autorisation reçu à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="c3acb-189">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="c3acb-190">Lors de sa demande, le client s’authentifie auprès du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-190">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="c3acb-191">Le client inclut l’URI de redirection utilisé pour obtenir le code d’autorisation pour la vérification.</span><span class="sxs-lookup"><span data-stu-id="c3acb-191">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="c3acb-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="c3acb-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="c3acb-193">Un exemple d’implémentation pour `AuthorizationCodeProvider.CreateAsync` et `ReceiveAsync` pour contrôler la création et la validation de code d’autorisation est indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="c3acb-193">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="c3acb-194">Le code ci-dessus utilise un dictionnaire simultané en mémoire pour stocker le ticket d’identité et de code et de restaurer l’identité après avoir reçu le code.</span><span class="sxs-lookup"><span data-stu-id="c3acb-194">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="c3acb-195">Dans une application réelle, il serait remplacé par un magasin de données persistantes.</span><span class="sxs-lookup"><span data-stu-id="c3acb-195">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="c3acb-196">Le point de terminaison d’autorisation est propriétaire de la ressource accorder l’accès au client.</span><span class="sxs-lookup"><span data-stu-id="c3acb-196">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="c3acb-197">En règle générale, il a besoin d’une interface utilisateur pour autoriser l’utilisateur à cliquer sur un bouton et à confirmer l’octroi.</span><span class="sxs-lookup"><span data-stu-id="c3acb-197">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="c3acb-198">Intergiciel (middleware) OWIN OAuth permet au code d’application gérer le point de terminaison d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-198">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="c3acb-199">Dans notre exemple d’application, nous utilisons un contrôleur MVC appelé `OAuthController` afin de le gérer.</span><span class="sxs-lookup"><span data-stu-id="c3acb-199">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="c3acb-200">Voici l’exemple d’implémentation :</span><span class="sxs-lookup"><span data-stu-id="c3acb-200">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="c3acb-201">Le `Authorize` action vérifie d’abord si l’utilisateur s’est connecté au serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-201">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="c3acb-202">Si ce n’est pas le cas, le middleware d’authentification défis en matière de l’appelant de s’authentifier en utilisant le cookie de « Application » et redirige vers la page de connexion.</span><span class="sxs-lookup"><span data-stu-id="c3acb-202">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="c3acb-203">(Voir le code en surbrillance ci-dessus). Si l’utilisateur s’est connecté, il restitue la vue Authorize, comme indiqué ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="c3acb-203">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="c3acb-204">Si le **Grant** bouton est sélectionné, le `Authorize` action crée une nouvelle identité de « Porteur » et connectez-vous avec elle.</span><span class="sxs-lookup"><span data-stu-id="c3acb-204">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="c3acb-205">Il déclenche le serveur d’autorisation pour générer un jeton du porteur et l’envoyer au client avec une charge utile JSON.</span><span class="sxs-lookup"><span data-stu-id="c3acb-205">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="c3acb-206">Octroi implicite</span><span class="sxs-lookup"><span data-stu-id="c3acb-206">Implicit Grant</span></span>

<span data-ttu-id="c3acb-207">Reportez-vous à OAuth 2 l’IETF [octroi implicite](http://tools.ietf.org/html/rfc6749#section-4.2) section maintenant.</span><span class="sxs-lookup"><span data-stu-id="c3acb-207">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="c3acb-208">Le [octroi implicite](http://tools.ietf.org/html/rfc6749#section-4.2) flux illustré Figure 4 est le flux et le OAuth OWIN de mappage qui la suit intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="c3acb-208">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="c3acb-209">Étapes du flux à partir de la section d’octroi implicite</span><span class="sxs-lookup"><span data-stu-id="c3acb-209">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="c3acb-210">Téléchargement de l’exemple effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="c3acb-210">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="c3acb-211">(A) le client lance le flux en dirigeant l’agent utilisateur du propriétaire des ressources au point de terminaison d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-211">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="c3acb-212">Le client inclut son identificateur client, étendue demandée, état local et un URI de redirection auquel le serveur d’autorisation envoie l’agent utilisateur une fois l’accès est accordé (ou refusé).</span><span class="sxs-lookup"><span data-stu-id="c3acb-212">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="c3acb-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="c3acb-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="c3acb-214">(B) le serveur d’autorisation authentifie le propriétaire de la ressource (par le biais de l’agent utilisateur) et détermine si le propriétaire de la ressource accorde ou refuse la demande d’accès du client.</span><span class="sxs-lookup"><span data-stu-id="c3acb-214">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="c3acb-215">**&lt;Si l’utilisateur accorde l’accès&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="c3acb-215">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="c3acb-216">(C) en supposant que le propriétaire de la ressource accorde l’accès, le serveur d’autorisation redirige l’agent utilisateur vers le client à l’aide de l’URI de redirection fourni précédemment (dans la demande ou lors de l’inscription du client).</span><span class="sxs-lookup"><span data-stu-id="c3acb-216">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="c3acb-217">...</span><span class="sxs-lookup"><span data-stu-id="c3acb-217">...</span></span> |  |
|  |  |
| <span data-ttu-id="c3acb-218">(D) le client demande un jeton d’accès à partir du point de terminaison de jeton du serveur d’autorisation en incluant le code d’autorisation reçu à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="c3acb-218">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="c3acb-219">Lors de sa demande, le client s’authentifie auprès du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-219">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="c3acb-220">Le client inclut l’URI de redirection utilisé pour obtenir le code d’autorisation pour la vérification.</span><span class="sxs-lookup"><span data-stu-id="c3acb-220">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="c3acb-221">Étant donné que nous avons déjà implémenté le point de terminaison d’autorisation (`OAuthController.Authorize` action) pour l’octroi de code d’autorisation, il active automatiquement également le flux implicite.</span><span class="sxs-lookup"><span data-stu-id="c3acb-221">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="c3acb-222">Remarque : `Provider.ValidateClientRedirectUri` est utilisé pour valider l’ID de client avec son URL de redirection, qui protège le flux d’octroi implicite d’envoyer des jetons aux clients l’accès ([attaque de Man-in-the-middle](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="c3acb-222">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="c3acb-223">Octroi des informations d’identification mot de passe de propriétaire de la ressource</span><span class="sxs-lookup"><span data-stu-id="c3acb-223">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="c3acb-224">Reportez-vous à OAuth 2 l’IETF [octroi des informations de mot de passe propriétaire de la ressource](http://tools.ietf.org/html/rfc6749#section-4.3) section maintenant.</span><span class="sxs-lookup"><span data-stu-id="c3acb-224">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="c3acb-225">Le [octroi des informations de mot de passe propriétaire de la ressource](http://tools.ietf.org/html/rfc6749#section-4.3) flux illustré Figure 5 est le flux et le OAuth OWIN de mappage qui la suit intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="c3acb-225">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="c3acb-226">Étapes du flux à partir de la section d’octroi des informations de mot de passe propriétaire de la ressource</span><span class="sxs-lookup"><span data-stu-id="c3acb-226">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="c3acb-227">Téléchargement de l’exemple effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="c3acb-227">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="c3acb-228">(A) le propriétaire de la ressource fournit au client avec son nom d’utilisateur et le mot de passe.</span><span class="sxs-lookup"><span data-stu-id="c3acb-228">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="c3acb-229">(B) le client demande un jeton d’accès à partir du point de terminaison de jeton du serveur d’autorisation en incluant les informations d’identification reçues du propriétaire de ressources.</span><span class="sxs-lookup"><span data-stu-id="c3acb-229">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="c3acb-230">Lors de sa demande, le client s’authentifie auprès du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-230">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="c3acb-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="c3acb-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="c3acb-232">(C) le serveur d’autorisation authentifie le client et valide les informations d’identification du propriétaire de ressource et s’il est valide, émet un jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="c3acb-232">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="c3acb-233">Voici l’exemple d’implémentation pour `Provider.GrantResourceOwnerCredentials`:</span><span class="sxs-lookup"><span data-stu-id="c3acb-233">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="c3acb-234">Le code ci-dessus a vocation d’expliquer cette section du didacticiel et ne doit pas être utilisé dans sécurisée ou les applications de production.</span><span class="sxs-lookup"><span data-stu-id="c3acb-234">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="c3acb-235">Il ne vérifie pas les informations d’identification des propriétaires de ressources.</span><span class="sxs-lookup"><span data-stu-id="c3acb-235">It does not check the resource owners credentials.</span></span> <span data-ttu-id="c3acb-236">Il part du principe que chaque information d’identification n’est valide et crée une nouvelle identité pour celle-ci.</span><span class="sxs-lookup"><span data-stu-id="c3acb-236">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="c3acb-237">La nouvelle identité sera utilisée pour générer le jeton d’accès et le jeton d’actualisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-237">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="c3acb-238">Remplacez le code avec votre propre code de gestion de compte sécurisé.</span><span class="sxs-lookup"><span data-stu-id="c3acb-238">Please replace the code with your own secure account management code.</span></span>

### <a name="client-credentials-grant"></a><span data-ttu-id="c3acb-239">Octroi des informations d’identification client</span><span class="sxs-lookup"><span data-stu-id="c3acb-239">Client Credentials Grant</span></span>

<span data-ttu-id="c3acb-240">Reportez-vous à OAuth 2 l’IETF [octroi des informations d’identification du Client](http://tools.ietf.org/html/rfc6749#section-4.4) section maintenant.</span><span class="sxs-lookup"><span data-stu-id="c3acb-240">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="c3acb-241">Le [octroi des informations d’identification du Client](http://tools.ietf.org/html/rfc6749#section-4.4) flux indiqué dans la Figure 6 est le flux et le OAuth OWIN de mappage qui la suit intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="c3acb-241">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="c3acb-242">Étapes du flux à partir de la section d’octroi des informations d’identification du Client</span><span class="sxs-lookup"><span data-stu-id="c3acb-242">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="c3acb-243">Téléchargement de l’exemple effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="c3acb-243">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="c3acb-244">(A) le client s’authentifie auprès du serveur d’autorisation et demande un jeton d’accès du point de terminaison de jeton.</span><span class="sxs-lookup"><span data-stu-id="c3acb-244">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="c3acb-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="c3acb-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="c3acb-246">(B) le serveur d’autorisation authentifie le client et s’il est valide, émet un jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="c3acb-246">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="c3acb-247">Voici l’exemple d’implémentation pour `Provider.GrantClientCredentials`:</span><span class="sxs-lookup"><span data-stu-id="c3acb-247">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="c3acb-248">Le code ci-dessus a vocation d’expliquer cette section du didacticiel et ne doit pas être utilisé dans sécurisée ou les applications de production.</span><span class="sxs-lookup"><span data-stu-id="c3acb-248">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="c3acb-249">Remplacez le code avec votre propre code de gestion de client sécurisé.</span><span class="sxs-lookup"><span data-stu-id="c3acb-249">Please replace the code with your own secure client management code.</span></span>

### <a name="refresh-token"></a><span data-ttu-id="c3acb-250">Jeton d’actualisation</span><span class="sxs-lookup"><span data-stu-id="c3acb-250">Refresh Token</span></span>

<span data-ttu-id="c3acb-251">Reportez-vous à OAuth 2 l’IETF [jeton d’actualisation](http://tools.ietf.org/html/rfc6749#section-1.5) section maintenant.</span><span class="sxs-lookup"><span data-stu-id="c3acb-251">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="c3acb-252">Le [jeton d’actualisation](http://tools.ietf.org/html/rfc6749#section-1.5) flux indiqué dans la Figure 2 est le flux et le OAuth OWIN de mappage qui la suit intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="c3acb-252">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="c3acb-253">Étapes du flux à partir de la section d’octroi des informations d’identification du Client</span><span class="sxs-lookup"><span data-stu-id="c3acb-253">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="c3acb-254">Téléchargement de l’exemple effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="c3acb-254">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="c3acb-255">(G), le client demande un nouveau jeton d’accès en authentifie auprès du serveur d’autorisation et en fournissant le jeton d’actualisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-255">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="c3acb-256">Les exigences d’authentification client sont basées sur le type de client et sur les stratégies de serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-256">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="c3acb-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="c3acb-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="c3acb-258">(H) le serveur d’autorisation authentifie le client et valide le jeton d’actualisation et s’il est valide, émet un nouveau jeton d’accès (et, éventuellement, un nouveau jeton d’actualisation).</span><span class="sxs-lookup"><span data-stu-id="c3acb-258">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="c3acb-259">Voici l’exemple d’implémentation pour `Provider.GrantRefreshToken`:</span><span class="sxs-lookup"><span data-stu-id="c3acb-259">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="c3acb-260">Créer un serveur de ressources qui est protégé par le jeton d’accès</span><span class="sxs-lookup"><span data-stu-id="c3acb-260">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="c3acb-261">Créez un projet d’application web vide et installez après les packages dans le projet :</span><span class="sxs-lookup"><span data-stu-id="c3acb-261">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="c3acb-262">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="c3acb-262">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="c3acb-263">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="c3acb-263">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="c3acb-264">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="c3acb-264">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="c3acb-265">Créez une classe de démarrage et configurer l’authentification et l’API Web.</span><span class="sxs-lookup"><span data-stu-id="c3acb-265">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="c3acb-266">Consultez *AuthorizationServer\ResourceServer\Startup.cs* dans le téléchargement d’exemple.</span><span class="sxs-lookup"><span data-stu-id="c3acb-266">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="c3acb-267">Consultez *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* dans le téléchargement d’exemple.</span><span class="sxs-lookup"><span data-stu-id="c3acb-267">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="c3acb-268">Consultez *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* dans le téléchargement d’exemple.</span><span class="sxs-lookup"><span data-stu-id="c3acb-268">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="c3acb-269">`UseCors` méthode permet de CORS pour tous les domaines.</span><span class="sxs-lookup"><span data-stu-id="c3acb-269">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="c3acb-270">`UseOAuthBearerAuthentication` méthode permet d’intergiciel d’authentification du jeton de support OAuth qui recevra et valider le jeton de porteur dans l’en-tête d’autorisation dans la demande.</span><span class="sxs-lookup"><span data-stu-id="c3acb-270">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="c3acb-271">`Config.SuppressDefaultHostAuthentication` Supprime la valeur par défaut hôte principal authentifié à partir de l’application, par conséquent, toutes les demandes seront anonymes après cet appel.</span><span class="sxs-lookup"><span data-stu-id="c3acb-271">`Config.SuppressDefaultHostAuthentication` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="c3acb-272">`HostAuthenticationFilter` Active l’authentification uniquement pour le type d’authentification spécifié.</span><span class="sxs-lookup"><span data-stu-id="c3acb-272">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="c3acb-273">Dans ce cas, il est de type d’authentification du porteur.</span><span class="sxs-lookup"><span data-stu-id="c3acb-273">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="c3acb-274">Pour illustrer l’identité authentifiée, nous créons une classe ApiController pour générer des revendications de l’utilisateur actuel.</span><span class="sxs-lookup"><span data-stu-id="c3acb-274">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="c3acb-275">Si le serveur d’autorisation et le serveur de ressources ne sont pas sur le même ordinateur, le middleware OAuth utilise les clés de l’autre ordinateur pour chiffrer et déchiffrer le jeton d’accès du porteur.</span><span class="sxs-lookup"><span data-stu-id="c3acb-275">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="c3acb-276">Afin de partager la même clé privée entre les deux projets, nous ajoutons le même `machinekey` définition dans les deux *web.config* fichiers.</span><span class="sxs-lookup"><span data-stu-id="c3acb-276">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="c3acb-277">Créer des Clients OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="c3acb-277">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="c3acb-278">Nous utilisons le [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) package NuGet pour simplifier le code client.</span><span class="sxs-lookup"><span data-stu-id="c3acb-278">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="c3acb-279">Octroi de Code d’autorisation Client</span><span class="sxs-lookup"><span data-stu-id="c3acb-279">Authorization Code Grant Client</span></span>

 <span data-ttu-id="c3acb-280">Ce client est une application MVC.</span><span class="sxs-lookup"><span data-stu-id="c3acb-280">This client is an MVC application.</span></span> <span data-ttu-id="c3acb-281">Il déclenche un flux d’octroi de code d’autorisation pour obtenir l’accès au jeton du serveur principal.</span><span class="sxs-lookup"><span data-stu-id="c3acb-281">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="c3acb-282">Il possède une seule page comme indiqué ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="c3acb-282">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="c3acb-283">Le **Authorize** bouton redirigera le navigateur vers le serveur d’autorisation pour notifier le propriétaire de la ressource à accorder l’accès à ce client.</span><span class="sxs-lookup"><span data-stu-id="c3acb-283">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="c3acb-284">Le **Actualiser** bouton obtiendra un nouveau jeton d’accès et le jeton d’actualisation à l’aide de l’actualisation en cours jeton.</span><span class="sxs-lookup"><span data-stu-id="c3acb-284">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="c3acb-285">Le **accès protégé ressources API** bouton appellera le serveur de ressources pour obtenir des données de revendications de l’utilisateur actuel et les afficher sur la page.</span><span class="sxs-lookup"><span data-stu-id="c3acb-285">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="c3acb-286">Voici l’exemple de code de la `HomeController` du client.</span><span class="sxs-lookup"><span data-stu-id="c3acb-286">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="c3acb-287">`DotNetOpenAuth` nécessite SSL par défaut.</span><span class="sxs-lookup"><span data-stu-id="c3acb-287">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="c3acb-288">Étant donné que notre démonstration à l’aide de HTTP, vous devez ajouter suivant paramètre dans le fichier de configuration :</span><span class="sxs-lookup"><span data-stu-id="c3acb-288">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="c3acb-289">Sécurité - jamais désactiver SSL dans une application de production.</span><span class="sxs-lookup"><span data-stu-id="c3acb-289">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="c3acb-290">Vos informations d’identification de connexion sont désormais envoyées en texte clair sur le réseau.</span><span class="sxs-lookup"><span data-stu-id="c3acb-290">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="c3acb-291">Le code ci-dessus est uniquement pour le débogage local exemple et l’exploration.</span><span class="sxs-lookup"><span data-stu-id="c3acb-291">The code above is just for local sample debugging and exploration.</span></span>

### <a name="implicit-grant-client"></a><span data-ttu-id="c3acb-292">Client d’octroi implicite</span><span class="sxs-lookup"><span data-stu-id="c3acb-292">Implicit Grant Client</span></span>

<span data-ttu-id="c3acb-293">Ce client utilise JavaScript pour :</span><span class="sxs-lookup"><span data-stu-id="c3acb-293">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="c3acb-294">Ouvrez une nouvelle fenêtre et rediriger vers le point de terminaison authorize du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c3acb-294">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="c3acb-295">Obtenir le jeton d’accès à partir de fragments d’URL quand il redirige le retour.</span><span class="sxs-lookup"><span data-stu-id="c3acb-295">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="c3acb-296">L’illustration suivante montre ce processus :</span><span class="sxs-lookup"><span data-stu-id="c3acb-296">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="c3acb-297">Le client doit avoir deux pages : une pour la page d’accueil et l’autre pour le rappel. Voici l’exemple de code JavaScript de code se trouve dans le *Index.cshtml* fichier :</span><span class="sxs-lookup"><span data-stu-id="c3acb-297">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="c3acb-298">Voici le code dans de gestion de rappel *SignIn.cshtml* fichier :</span><span class="sxs-lookup"><span data-stu-id="c3acb-298">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="c3acb-299">Une bonne pratique consiste à déplacer le code JavaScript dans un fichier externe et pas l’incorporer avec le balisage Razor.</span><span class="sxs-lookup"><span data-stu-id="c3acb-299">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="c3acb-300">Pour simplifier cet exemple, ils ont été combinés.</span><span class="sxs-lookup"><span data-stu-id="c3acb-300">To keep this sample simple, they have been combined.</span></span>

### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="c3acb-301">Mot de passe de propriétaire de la ressource Client de l’octroi des informations d’identification</span><span class="sxs-lookup"><span data-stu-id="c3acb-301">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="c3acb-302">Nous utilise une application de console pour ce client de démonstration.</span><span class="sxs-lookup"><span data-stu-id="c3acb-302">We uses a console app to demo this client.</span></span> <span data-ttu-id="c3acb-303">Voici le code :</span><span class="sxs-lookup"><span data-stu-id="c3acb-303">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="c3acb-304">Client de l’octroi des informations d’identification client</span><span class="sxs-lookup"><span data-stu-id="c3acb-304">Client Credentials Grant Client</span></span>

<span data-ttu-id="c3acb-305">Comme pour l’octroi d’informations d’identification de mot de passe ressource propriétaire, voici code d’application de console :</span><span class="sxs-lookup"><span data-stu-id="c3acb-305">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
