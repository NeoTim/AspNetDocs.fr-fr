---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: OWIN OAuth 2.0 Serveur d’autorisation (fr) Microsoft Docs
author: hongyes
description: Ce tutoriel vous guidera sur la façon de mettre en œuvre un serveur d’autorisation OAuth 2.0 en utilisant OWIN OAuth middleware. Il s’agit d’un tutoriel avancé qui ne fait que souligner ...
ms.author: riande
ms.date: 03/20/2014
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: d758fa2639d10e1b7be8d87c5d1f7adb7e292ac7
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/17/2020
ms.locfileid: "81540394"
---
<a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="4fb04-104">Serveur d’autorisation OAuth 2.0 OWIN</span><span class="sxs-lookup"><span data-stu-id="4fb04-104">OWIN OAuth 2.0 Authorization Server</span></span>
====================
<span data-ttu-id="4fb04-105">par [Hongye Sun](https://github.com/hongyes) et [Praburaj Thiagarajan](https://github.com/Praburaj)</span><span class="sxs-lookup"><span data-stu-id="4fb04-105">by [Hongye Sun](https://github.com/hongyes) and [Praburaj Thiagarajan](https://github.com/Praburaj)</span></span>

> <span data-ttu-id="4fb04-106">Ce tutoriel vous guidera sur la façon de mettre en œuvre un serveur d’autorisation OAuth 2.0 en utilisant OWIN OAuth middleware.</span><span class="sxs-lookup"><span data-stu-id="4fb04-106">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="4fb04-107">Il s’agit d’un tutoriel avancé qui ne décrit que les étapes pour créer un serveur d’autorisation OWIN OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="4fb04-107">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="4fb04-108">Ce n’est pas un tutoriel étape par étape.</span><span class="sxs-lookup"><span data-stu-id="4fb04-108">This is not a step by step tutorial.</span></span> <span data-ttu-id="4fb04-109">[Téléchargez le code de l’échantillon](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="4fb04-109">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="4fb04-110">Ce contour ne doit pas être destiné à être utilisé pour créer une application de production sécurisée.</span><span class="sxs-lookup"><span data-stu-id="4fb04-110">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="4fb04-111">Ce tutoriel est destiné à fournir seulement un aperçu sur la façon de mettre en œuvre un serveur d’autorisation OAuth 2.0 en utilisant OWIN OAuth middleware.</span><span class="sxs-lookup"><span data-stu-id="4fb04-111">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="4fb04-112">Versions logicielles</span><span class="sxs-lookup"><span data-stu-id="4fb04-112">Software versions</span></span>
>
> | <span data-ttu-id="4fb04-113">**Présenté dans le tutoriel**</span><span class="sxs-lookup"><span data-stu-id="4fb04-113">**Shown in the tutorial**</span></span> | <span data-ttu-id="4fb04-114">**Travaille également avec**</span><span class="sxs-lookup"><span data-stu-id="4fb04-114">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="4fb04-115">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="4fb04-115">Windows 8.1</span></span> | <span data-ttu-id="4fb04-116">Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="4fb04-116">Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="4fb04-117">Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="4fb04-117">Visual Studio 2013</span></span>](https://my.visualstudio.com/Downloads?q=visual%20studio%202013) | <span data-ttu-id="4fb04-118">[Visual Studio 2013 Express pour Desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span><span class="sxs-lookup"><span data-stu-id="4fb04-118">[Visual Studio 2013 Express for Desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span></span> <span data-ttu-id="4fb04-119">Visual Studio 2012 avec la dernière mise à jour devrait fonctionner, mais le tutoriel n’a pas été testé avec elle, et certaines sélections de menu et des boîtes de dialogue sont différentes.</span><span class="sxs-lookup"><span data-stu-id="4fb04-119">Visual Studio 2012 with the latest update should work, but the tutorial has not been tested with it, and some menu selections and dialog boxes are different.</span></span> |
> | <span data-ttu-id="4fb04-120">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="4fb04-120">.NET 4.5</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="4fb04-121">Questions et commentaires</span><span class="sxs-lookup"><span data-stu-id="4fb04-121">Questions and Comments</span></span>
>
> <span data-ttu-id="4fb04-122">Si vous avez des questions qui ne sont pas directement liées au tutoriel, vous pouvez les poster au [projet Katana sur GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="4fb04-122">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="4fb04-123">Pour les questions et les commentaires concernant le tutoriel lui-même, voir la section commentaires au bas de la page.</span><span class="sxs-lookup"><span data-stu-id="4fb04-123">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="4fb04-124">Le [cadre OAuth 2.0](http://tools.ietf.org/html/rfc6749) permet à une application tierce d’obtenir un accès limité à un service HTTP.</span><span class="sxs-lookup"><span data-stu-id="4fb04-124">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="4fb04-125">Au lieu d’utiliser les informations d’identification du propriétaire de la ressource pour accéder à une ressource protégée, le client obtient un jeton d’accès (qui est une chaîne indiquant une portée spécifique, la durée de vie et d’autres attributs d’accès).</span><span class="sxs-lookup"><span data-stu-id="4fb04-125">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="4fb04-126">Les jetons d’accès sont délivrés à des clients tiers par un serveur d’autorisation avec l’approbation du propriétaire de la ressource.</span><span class="sxs-lookup"><span data-stu-id="4fb04-126">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="4fb04-127">Ce tutoriel couvrira:</span><span class="sxs-lookup"><span data-stu-id="4fb04-127">This tutorial will cover:</span></span>

- <span data-ttu-id="4fb04-128">Comment créer un serveur d’autorisation pour prendre en charge quatre types de subventions d’autorisation et rafraîchir les jetons :</span><span class="sxs-lookup"><span data-stu-id="4fb04-128">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="4fb04-129">Subvention de code d’autorisation</span><span class="sxs-lookup"><span data-stu-id="4fb04-129">Authorization code grant</span></span>
    - <span data-ttu-id="4fb04-130">Subvention implicite</span><span class="sxs-lookup"><span data-stu-id="4fb04-130">Implicit Grant</span></span>
    - <span data-ttu-id="4fb04-131">Subvention d’identification de mot de passe du propriétaire des ressources</span><span class="sxs-lookup"><span data-stu-id="4fb04-131">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="4fb04-132">Subvention pour les titres de compétences des clients</span><span class="sxs-lookup"><span data-stu-id="4fb04-132">Client Credentials Grant</span></span>
- <span data-ttu-id="4fb04-133">Création d’un serveur de ressources qui est protégé par un jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="4fb04-133">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="4fb04-134">Création de clients OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="4fb04-134">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="4fb04-135">Prérequis</span><span class="sxs-lookup"><span data-stu-id="4fb04-135">Prerequisites</span></span>

- <span data-ttu-id="4fb04-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) ou le [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express)gratuit , comme indiqué dans **Software Versions** en haut de la page.</span><span class="sxs-lookup"><span data-stu-id="4fb04-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) or the free [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="4fb04-137">Familiarité avec OWIN.</span><span class="sxs-lookup"><span data-stu-id="4fb04-137">Familiarity with OWIN.</span></span> <span data-ttu-id="4fb04-138">Voir [Getting Started avec le projet Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) et ce qui est nouveau dans [OWIN et Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="4fb04-138">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="4fb04-139">Familiarité avec la terminologie [OAuth,](http://tools.ietf.org/html/rfc6749) y compris [les rôles](http://tools.ietf.org/html/rfc6749#section-1.1), [flux de protocole](http://tools.ietf.org/html/rfc6749#section-1.2), et la subvention [d’autorisation](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="4fb04-139">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="4fb04-140">[L’introduction OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) offre une bonne introduction.</span><span class="sxs-lookup"><span data-stu-id="4fb04-140">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="4fb04-141">Créer un serveur d’autorisation</span><span class="sxs-lookup"><span data-stu-id="4fb04-141">Create an Authorization Server</span></span>

<span data-ttu-id="4fb04-142">Dans ce tutoriel, nous allons grossièrement esquisser comment utiliser [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) et ASP.NET MVC pour créer un serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-142">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="4fb04-143">Nous espérons bientôt fournir un téléchargement pour l’échantillon terminé, car ce tutoriel n’inclut pas chaque étape.</span><span class="sxs-lookup"><span data-stu-id="4fb04-143">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="4fb04-144">Tout d’abord, créez une application web vide nommée *AuthorizationServer* et installez les paquets suivants :</span><span class="sxs-lookup"><span data-stu-id="4fb04-144">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="4fb04-145">Microsoft.AspNet.Mvc (en anglais seulement)</span><span class="sxs-lookup"><span data-stu-id="4fb04-145">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="4fb04-146">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="4fb04-146">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="4fb04-147">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="4fb04-147">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="4fb04-148">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="4fb04-148">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="4fb04-149">Microsoft.Owin.Security.Google (Ou tout autre paquet de connexion sociale comme Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="4fb04-149">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="4fb04-150">Ajoutez une [classe OWIN Startup](owin-startup-class-detection.md) dans le cadre du dossier racine du projet nommé *Startup*.</span><span class="sxs-lookup"><span data-stu-id="4fb04-150">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="4fb04-151">Créez un dossier *\_App Start.*</span><span class="sxs-lookup"><span data-stu-id="4fb04-151">Create an *App\_Start* folder.</span></span> <span data-ttu-id="4fb04-152">Sélectionnez le dossier *App\_Start* et utilisez Shift-Alt-A pour ajouter la version téléchargée du fichier *AuthorizationServer-App\_Start-Startup.Auth.cs.*</span><span class="sxs-lookup"><span data-stu-id="4fb04-152">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="4fb04-153">Le code ci-dessus permet l’application / signe externe dans les cookies et l’authentification de Google, qui sont utilisés par le serveur d’autorisation lui-même pour gérer les comptes.</span><span class="sxs-lookup"><span data-stu-id="4fb04-153">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="4fb04-154">La `UseOAuthAuthorizationServer` méthode d’extension consiste à configurer le serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-154">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="4fb04-155">Les options de configuration sont les suivantes:</span><span class="sxs-lookup"><span data-stu-id="4fb04-155">The setup options are:</span></span>

- <span data-ttu-id="4fb04-156">`AuthorizeEndpointPath`: Le chemin de demande où les applications client redirigeront l’utilisateur-agent afin d’obtenir le consentement des utilisateurs à émettre un jeton ou un code.</span><span class="sxs-lookup"><span data-stu-id="4fb04-156">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="4fb04-157">Il doit commencer par une barre`/Authorize`oblique de premier plan, par exemple, ".</span><span class="sxs-lookup"><span data-stu-id="4fb04-157">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="4fb04-158">`TokenEndpointPath`: Les demandes de la clientèle sur le chemin de demande communiquent directement pour obtenir le jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="4fb04-158">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="4fb04-159">Il doit commencer par une barre oblique de premier plan, comme "/Token".</span><span class="sxs-lookup"><span data-stu-id="4fb04-159">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="4fb04-160">Si le client est délivré un [secret client\_](http://tools.ietf.org/html/rfc6749#appendix-A.2), il doit être fourni à ce point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="4fb04-160">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="4fb04-161">`ApplicationCanDisplayErrors`: Définissez-le `true` si l’application web veut générer une `/Authorize` page d’erreur personnalisée pour les erreurs de validation du client sur le point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="4fb04-161">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="4fb04-162">Cela n’est nécessaire que pour les cas où le navigateur n’est pas redirigé vers l’application client, par exemple, lorsque le `client_id` ou `redirect_uri` sont incorrects.</span><span class="sxs-lookup"><span data-stu-id="4fb04-162">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="4fb04-163">Le `/Authorize` point final devrait s’attendre à voir le "oauth. Erreur", "oauth. ErreurDescription», et "oauth. Les propriétés ErrorUri" sont ajoutées à l’environnement OWIN.</span><span class="sxs-lookup"><span data-stu-id="4fb04-163">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="4fb04-164">Si ce n’est pas vrai, le serveur d’autorisation retournera une page d’erreur par défaut avec les détails de l’erreur.</span><span class="sxs-lookup"><span data-stu-id="4fb04-164">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="4fb04-165">`AllowInsecureHttp`: Fidèle pour permettre aux demandes d’autorisation et de jetons `redirect_uri` d’arriver sur les adresses HTTP URI, et de permettre aux paramètres de demande d’autorisation entrant d’avoir des adresses HTTP URI.</span><span class="sxs-lookup"><span data-stu-id="4fb04-165">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="4fb04-166">Sécurité - C’est uniquement pour le développement.</span><span class="sxs-lookup"><span data-stu-id="4fb04-166">Security - This is for development only.</span></span>
- <span data-ttu-id="4fb04-167">`Provider`: L’objet fourni par la demande pour traiter les événements soulevés par le middleware Authorization Server.</span><span class="sxs-lookup"><span data-stu-id="4fb04-167">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="4fb04-168">L’application peut implémenter l’interface `OAuthAuthorizationServerProvider` entièrement, ou elle peut créer une instance et affecter les délégués nécessaires pour les flux OAuth de ce serveur prend en charge.</span><span class="sxs-lookup"><span data-stu-id="4fb04-168">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="4fb04-169">`AuthorizationCodeProvider`: Produit un code d’autorisation à usage unique pour revenir à l’application client.</span><span class="sxs-lookup"><span data-stu-id="4fb04-169">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="4fb04-170">Pour que le serveur OAuth **MUST** soit sécurisé, `AuthorizationCodeProvider` l’application DOIT `OnCreate/OnCreateAsync` fournir un exemple pour lequel `OnReceive/OnReceiveAsync`le jeton produit par l’événement est considéré comme valide pour un seul appel à .</span><span class="sxs-lookup"><span data-stu-id="4fb04-170">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="4fb04-171">`RefreshTokenProvider`: Produit un jeton de rafraîchissement qui peut être utilisé pour produire un nouveau jeton d’accès en cas de besoin.</span><span class="sxs-lookup"><span data-stu-id="4fb04-171">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="4fb04-172">Si ce n’est pas fourni le serveur `/Token` d’autorisation ne retournera pas les jetons de rafraîchissement à partir du point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="4fb04-172">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="4fb04-173">Gestion de compte</span><span class="sxs-lookup"><span data-stu-id="4fb04-173">Account Management</span></span>

<span data-ttu-id="4fb04-174">OAuth ne se soucie pas où et comment vous gérez les informations de votre compte utilisateur.</span><span class="sxs-lookup"><span data-stu-id="4fb04-174">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="4fb04-175">C’est [ASP.NET Identité](../../../identity/index.md) qui en est responsable.</span><span class="sxs-lookup"><span data-stu-id="4fb04-175">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="4fb04-176">Dans ce tutoriel, nous allons simplifier le code de gestion de compte et assurez-vous que l’utilisateur peut se connecter à l’aide de cookie middleware OWIN.</span><span class="sxs-lookup"><span data-stu-id="4fb04-176">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="4fb04-177">Voici le code d’échantillon simplifié pour le `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="4fb04-177">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="4fb04-178">`ValidateClientRedirectUri`est utilisé pour valider le client avec son URL de redirection enregistrée.</span><span class="sxs-lookup"><span data-stu-id="4fb04-178">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="4fb04-179">`ValidateClientAuthentication`vérifie l’en-tête du schéma de base et le corps de forme pour obtenir les informations d’identification du client.</span><span class="sxs-lookup"><span data-stu-id="4fb04-179">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="4fb04-180">La page de connexion est affichée ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="4fb04-180">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="4fb04-181">Examinez maintenant la section des subventions au [Code d’autorisation](http://tools.ietf.org/html/rfc6749#section-4.1) de l’UET 2.</span><span class="sxs-lookup"><span data-stu-id="4fb04-181">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="4fb04-182">**Fournisseur** (dans le tableau ci-dessous) est [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Fournisseur, qui est `OAuthAuthorizationServerProvider`de type , qui contient tous les événements serveur OAuth.</span><span class="sxs-lookup"><span data-stu-id="4fb04-182">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="4fb04-183">Étapes de flux de la section de subvention de code d’autorisation</span><span class="sxs-lookup"><span data-stu-id="4fb04-183">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="4fb04-184">Le téléchargement d’échantillons effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="4fb04-184">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="4fb04-185">(A) Le client initie le flux en orientant l’agent d’utilisateur du propriétaire de la ressource vers le critère d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-185">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="4fb04-186">Le client comprend son identifiant client, la portée demandée, l’état local, et une redirection URI à laquelle le serveur d’autorisation enverra l’agent utilisateur en arrière une fois l’accès est accordé (ou refusé).</span><span class="sxs-lookup"><span data-stu-id="4fb04-186">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="4fb04-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="4fb04-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="4fb04-188">(B) Le serveur d’autorisation authentifie le propriétaire de la ressource (par l’intermédiaire de l’agent utilisateur) et établit si le propriétaire de la ressource accorde ou refuse la demande d’accès du client.</span><span class="sxs-lookup"><span data-stu-id="4fb04-188">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="4fb04-189">**Si l’utilisateur accorde l’accès&gt; &lt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4fb04-189">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="4fb04-190">(C) En supposant que le propriétaire de la ressource accorde l’accès, le serveur d’autorisation redirige l’agent d’utilisation vers le client en utilisant la redirection URI fournie plus tôt (dans la demande ou lors de l’enregistrement du client).</span><span class="sxs-lookup"><span data-stu-id="4fb04-190">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="4fb04-191">...</span><span class="sxs-lookup"><span data-stu-id="4fb04-191">...</span></span> |  |
|  |  |
| <span data-ttu-id="4fb04-192">(D) Le client demande un jeton d’accès à partir du critère de fin symbolique du serveur d’autorisation en incluant le code d’autorisation reçu dans l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="4fb04-192">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="4fb04-193">Lors de la demande, le client authentifie avec le serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-193">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="4fb04-194">Le client comprend la redirection URI utilisée pour obtenir le code d’autorisation pour la vérification.</span><span class="sxs-lookup"><span data-stu-id="4fb04-194">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="4fb04-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4fb04-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="4fb04-196">Une mise `AuthorizationCodeProvider.CreateAsync` en `ReceiveAsync` œuvre d’échantillons pour et pour contrôler la création et la validation du code d’autorisation est indiquée ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="4fb04-196">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="4fb04-197">Le code ci-dessus utilise un dictionnaire simultané dans la mémoire pour stocker le code et le billet d’identité et restaurer l’identité après avoir reçu le code.</span><span class="sxs-lookup"><span data-stu-id="4fb04-197">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="4fb04-198">Dans une application réelle, il serait remplacé par un magasin de données persistant.</span><span class="sxs-lookup"><span data-stu-id="4fb04-198">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="4fb04-199">Le critère d’autorisation est pour le propriétaire de la ressource d’accorder l’accès au client.</span><span class="sxs-lookup"><span data-stu-id="4fb04-199">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="4fb04-200">Habituellement, il a besoin d’une interface utilisateur pour permettre à l’utilisateur de cliquer sur un bouton et de confirmer la subvention.</span><span class="sxs-lookup"><span data-stu-id="4fb04-200">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="4fb04-201">OWIN OAuth middleware permet au code d’application de gérer le critère d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-201">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="4fb04-202">Dans notre application d’exemple, nous `OAuthController` utilisons un contrôleur MVC appelé pour le gérer.</span><span class="sxs-lookup"><span data-stu-id="4fb04-202">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="4fb04-203">Voici l’exemple de mise en œuvre :</span><span class="sxs-lookup"><span data-stu-id="4fb04-203">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="4fb04-204">L’action `Authorize` vérifiera d’abord si l’utilisateur s’est connecté au serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-204">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="4fb04-205">Si ce n’est pas le cas, le middleware d’authentification met l’appelant authentifier à l’aide du cookie "Application" et redirige vers la page de connexion.</span><span class="sxs-lookup"><span data-stu-id="4fb04-205">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="4fb04-206">(Voir le code mis en évidence ci-dessus.) Si l’utilisateur s’est connecté, il rendra la vue d’autorisation, comme indiqué ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="4fb04-206">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="4fb04-207">Si le bouton **Grant** `Authorize` est sélectionné, l’action créera une nouvelle identité « Porteur » et vous connectera avec elle.</span><span class="sxs-lookup"><span data-stu-id="4fb04-207">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="4fb04-208">Il déclenchera le serveur d’autorisation pour générer un jeton porteur et le renvoyer au client avec la charge utile JSON.</span><span class="sxs-lookup"><span data-stu-id="4fb04-208">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="4fb04-209">Subvention implicite</span><span class="sxs-lookup"><span data-stu-id="4fb04-209">Implicit Grant</span></span>

<span data-ttu-id="4fb04-210">Faites maintenant référence à la section OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) de l’IETF.</span><span class="sxs-lookup"><span data-stu-id="4fb04-210">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="4fb04-211">Le flux [implicite de subvention](http://tools.ietf.org/html/rfc6749#section-4.2) indiqué dans la figure 4 est le flux et la cartographie que le middleware OWIN OAuth suit.</span><span class="sxs-lookup"><span data-stu-id="4fb04-211">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="4fb04-212">Étapes de flux de la section Subvention implicite</span><span class="sxs-lookup"><span data-stu-id="4fb04-212">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="4fb04-213">Le téléchargement d’échantillons effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="4fb04-213">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="4fb04-214">(A) Le client initie le flux en orientant l’agent d’utilisateur du propriétaire de la ressource vers le critère d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-214">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="4fb04-215">Le client comprend son identifiant client, la portée demandée, l’état local, et une redirection URI à laquelle le serveur d’autorisation enverra l’agent utilisateur en arrière une fois l’accès est accordé (ou refusé).</span><span class="sxs-lookup"><span data-stu-id="4fb04-215">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="4fb04-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="4fb04-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="4fb04-217">(B) Le serveur d’autorisation authentifie le propriétaire de la ressource (par l’intermédiaire de l’agent utilisateur) et établit si le propriétaire de la ressource accorde ou refuse la demande d’accès du client.</span><span class="sxs-lookup"><span data-stu-id="4fb04-217">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="4fb04-218">**Si l’utilisateur accorde l’accès&gt; &lt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4fb04-218">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="4fb04-219">(C) En supposant que le propriétaire de la ressource accorde l’accès, le serveur d’autorisation redirige l’agent d’utilisation vers le client en utilisant la redirection URI fournie plus tôt (dans la demande ou lors de l’enregistrement du client).</span><span class="sxs-lookup"><span data-stu-id="4fb04-219">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="4fb04-220">...</span><span class="sxs-lookup"><span data-stu-id="4fb04-220">...</span></span> |  |
|  |  |
| <span data-ttu-id="4fb04-221">(D) Le client demande un jeton d’accès à partir du critère de fin symbolique du serveur d’autorisation en incluant le code d’autorisation reçu dans l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="4fb04-221">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="4fb04-222">Lors de la demande, le client authentifie avec le serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-222">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="4fb04-223">Le client comprend la redirection URI utilisée pour obtenir le code d’autorisation pour la vérification.</span><span class="sxs-lookup"><span data-stu-id="4fb04-223">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="4fb04-224">Étant donné que nous avons`OAuthController.Authorize` déjà mis en œuvre le critère d’autorisation (action) pour la subvention de code d’autorisation, il permet automatiquement le flux implicite ainsi.</span><span class="sxs-lookup"><span data-stu-id="4fb04-224">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="4fb04-225">Remarque `Provider.ValidateClientRedirectUri` : est utilisé pour valider l’ID du client avec son URL de redirection, qui protège le flux implicite de subvention de l’envoi du jeton d’accès à des clients malveillants ([attaque man-in-the-middle](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="4fb04-225">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="4fb04-226">Subvention d’identification de mot de passe du propriétaire des ressources</span><span class="sxs-lookup"><span data-stu-id="4fb04-226">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="4fb04-227">Consultez maintenant la section subvention de la subvention de la subvention de référence des [certificats d’identification des propriétaires de ressources](http://tools.ietf.org/html/rfc6749#section-4.3) de l’IETF 2.</span><span class="sxs-lookup"><span data-stu-id="4fb04-227">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="4fb04-228">Le flux [de subvention de subvention de mot de passe de propriétaire de ressource](http://tools.ietf.org/html/rfc6749#section-4.3) indiqué dans la figure 5 est le flux et la cartographie que le middleware OWIN OAuth suit.</span><span class="sxs-lookup"><span data-stu-id="4fb04-228">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="4fb04-229">Étapes de flux de la section subvention de la subvention de mot de passe de propriétaire de ressource</span><span class="sxs-lookup"><span data-stu-id="4fb04-229">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="4fb04-230">Le téléchargement d’échantillons effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="4fb04-230">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="4fb04-231">(A) Le propriétaire de la ressource fournit au client son nom d’utilisateur et son mot de passe.</span><span class="sxs-lookup"><span data-stu-id="4fb04-231">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="4fb04-232">(B) Le client demande un jeton d’accès à partir du point de terminaison symbolique du serveur d’autorisation en incluant les informations d’identification reçues du propriétaire de la ressource.</span><span class="sxs-lookup"><span data-stu-id="4fb04-232">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="4fb04-233">Lors de la demande, le client authentifie avec le serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-233">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="4fb04-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4fb04-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="4fb04-235">(C) Le serveur d’autorisation authentifie le client et valide les informations d’identification du propriétaire de la ressource et, si elle est valide, émet un jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="4fb04-235">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="4fb04-236">Voici l’exemple `Provider.GrantResourceOwnerCredentials`de mise en œuvre pour :</span><span class="sxs-lookup"><span data-stu-id="4fb04-236">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="4fb04-237">Le code ci-dessus est destiné à expliquer cette section du tutoriel et ne doit pas être utilisé dans les applications sécurisées ou de production.</span><span class="sxs-lookup"><span data-stu-id="4fb04-237">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="4fb04-238">Il ne vérifie pas les informations d’identification des propriétaires de ressources.</span><span class="sxs-lookup"><span data-stu-id="4fb04-238">It does not check the resource owners credentials.</span></span> <span data-ttu-id="4fb04-239">Il suppose que chaque titre de compétence est valide et crée une nouvelle identité pour elle.</span><span class="sxs-lookup"><span data-stu-id="4fb04-239">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="4fb04-240">La nouvelle identité sera utilisée pour générer le jeton d’accès et rafraîchir le jeton.</span><span class="sxs-lookup"><span data-stu-id="4fb04-240">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="4fb04-241">Veuillez remplacer le code par votre propre code de gestion de compte sécurisé.</span><span class="sxs-lookup"><span data-stu-id="4fb04-241">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="4fb04-242">Subvention pour les titres de compétences des clients</span><span class="sxs-lookup"><span data-stu-id="4fb04-242">Client Credentials Grant</span></span>

<span data-ttu-id="4fb04-243">Consultez maintenant la section subvention pour les [titres de compétences des](http://tools.ietf.org/html/rfc6749#section-4.4) clients de l’IETF 2.</span><span class="sxs-lookup"><span data-stu-id="4fb04-243">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="4fb04-244">Le flux [de subvention pour les titres de compétences](http://tools.ietf.org/html/rfc6749#section-4.4) des clients indiqué dans la figure 6 est le flux et la cartographie que le middleware OWIN OAuth suit.</span><span class="sxs-lookup"><span data-stu-id="4fb04-244">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="4fb04-245">Étapes de flux de la section Subvention pour les titres de compétences des clients</span><span class="sxs-lookup"><span data-stu-id="4fb04-245">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="4fb04-246">Le téléchargement d’échantillons effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="4fb04-246">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="4fb04-247">(A) Le client authentifie avec le serveur d’autorisation et demande un signe d’accès à partir du point de terminaison symbolique.</span><span class="sxs-lookup"><span data-stu-id="4fb04-247">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="4fb04-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4fb04-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="4fb04-249">(B) Le serveur d’autorisation authentifie le client et, le cas échéant, émet un signe d’accès.</span><span class="sxs-lookup"><span data-stu-id="4fb04-249">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="4fb04-250">Voici l’exemple `Provider.GrantClientCredentials`de mise en œuvre pour :</span><span class="sxs-lookup"><span data-stu-id="4fb04-250">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="4fb04-251">Le code ci-dessus est destiné à expliquer cette section du tutoriel et ne doit pas être utilisé dans les applications sécurisées ou de production.</span><span class="sxs-lookup"><span data-stu-id="4fb04-251">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="4fb04-252">Veuillez remplacer le code par votre propre code de gestion client sécurisé.</span><span class="sxs-lookup"><span data-stu-id="4fb04-252">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="4fb04-253">Actualiser le jeton</span><span class="sxs-lookup"><span data-stu-id="4fb04-253">Refresh Token</span></span>

<span data-ttu-id="4fb04-254">Faites référence à la section Jet 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) de l’IETF dès maintenant.</span><span class="sxs-lookup"><span data-stu-id="4fb04-254">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="4fb04-255">Le flux [de jet de jet de rafraîchissement](http://tools.ietf.org/html/rfc6749#section-1.5) indiqué dans la figure 2 est le flux et la cartographie que le middleware OWIN OAuth suit.</span><span class="sxs-lookup"><span data-stu-id="4fb04-255">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="4fb04-256">Étapes de flux de la section Subvention pour les titres de compétences des clients</span><span class="sxs-lookup"><span data-stu-id="4fb04-256">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="4fb04-257">Le téléchargement d’échantillons effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="4fb04-257">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="4fb04-258">(G) Le client demande un nouveau jeton d’accès en authentifiant avec le serveur d’autorisation et en présentant le jeton de rafraîchissement.</span><span class="sxs-lookup"><span data-stu-id="4fb04-258">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="4fb04-259">Les exigences d’authentification du client sont basées sur le type de client et sur les stratégies du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-259">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="4fb04-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4fb04-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="4fb04-261">(H) Le serveur d’autorisation authentifie le client et valide le jeton de rafraîchissement, et si elle est valide, émet un nouveau jeton d’accès (et, optionnellement, un nouveau jeton de rafraîchissement).</span><span class="sxs-lookup"><span data-stu-id="4fb04-261">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="4fb04-262">Voici l’exemple `Provider.GrantRefreshToken`de mise en œuvre pour :</span><span class="sxs-lookup"><span data-stu-id="4fb04-262">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="4fb04-263">Créer un serveur de ressources protégé par Access Token</span><span class="sxs-lookup"><span data-stu-id="4fb04-263">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="4fb04-264">Créez un projet d’application web vide et installez les paquets suivants dans le projet :</span><span class="sxs-lookup"><span data-stu-id="4fb04-264">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="4fb04-265">Microsoft.AspNet.WebApi.Owin (en anglais seulement)</span><span class="sxs-lookup"><span data-stu-id="4fb04-265">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="4fb04-266">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="4fb04-266">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="4fb04-267">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="4fb04-267">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="4fb04-268">Créez une classe de démarrage et configurez l’authentification et l’API Web.</span><span class="sxs-lookup"><span data-stu-id="4fb04-268">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="4fb04-269">Voir *AuthorizationServer-ResourceServer-Startup.cs* dans le téléchargement de l’échantillon.</span><span class="sxs-lookup"><span data-stu-id="4fb04-269">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="4fb04-270">Voir *AuthorizationServer-ResourceServer-App\_Start-Startup.Auth.cs* dans le téléchargement de l’échantillon.</span><span class="sxs-lookup"><span data-stu-id="4fb04-270">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="4fb04-271">Voir *AuthorizationServer-ResourceServer-App\_Start-Startup.WebApi.cs* dans le téléchargement de l’échantillon.</span><span class="sxs-lookup"><span data-stu-id="4fb04-271">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="4fb04-272">`UseCors`permet CORS pour tous les domaines.</span><span class="sxs-lookup"><span data-stu-id="4fb04-272">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="4fb04-273">`UseOAuthBearerAuthentication`la méthode permet à oAuth porte-à-porter d’authentification middleware qui recevra et validera le signeur de l’en-tête d’autorisation dans la demande.</span><span class="sxs-lookup"><span data-stu-id="4fb04-273">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="4fb04-274">`Config.SuppressDefaultHostAuthenticaiton`supprime l’hôte par défaut authentifié principal de l’application, donc toutes les demandes seront anonymes après cet appel.</span><span class="sxs-lookup"><span data-stu-id="4fb04-274">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="4fb04-275">`HostAuthenticationFilter`permet l’authentification uniquement pour le type d’authentification spécifié.</span><span class="sxs-lookup"><span data-stu-id="4fb04-275">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="4fb04-276">Dans ce cas, c’est le type d’authentification du porteur.</span><span class="sxs-lookup"><span data-stu-id="4fb04-276">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="4fb04-277">Afin de démontrer l’identité authentifiée, nous créons un ApiController pour obtenir les revendications actuelles de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="4fb04-277">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="4fb04-278">Si le serveur d’autorisation et le serveur de ressources ne sont pas sur le même ordinateur, le middleware OAuth utilisera les différentes clés de la machine pour crypter et déchiffrer le jeton d’accès au porteur.</span><span class="sxs-lookup"><span data-stu-id="4fb04-278">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="4fb04-279">Afin de partager la même clé privée entre `machinekey` les deux projets, nous ajoutons le même paramètre dans les deux fichiers *web.config.*</span><span class="sxs-lookup"><span data-stu-id="4fb04-279">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="4fb04-280">Créer des clients OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="4fb04-280">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="4fb04-281">Nous utilisons le package [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet pour simplifier le code client.</span><span class="sxs-lookup"><span data-stu-id="4fb04-281">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="4fb04-282">Client de subvention de code d’autorisation</span><span class="sxs-lookup"><span data-stu-id="4fb04-282">Authorization Code Grant Client</span></span>

 <span data-ttu-id="4fb04-283">Ce client est une application MVC.</span><span class="sxs-lookup"><span data-stu-id="4fb04-283">This client is an MVC application.</span></span> <span data-ttu-id="4fb04-284">Il déclenchera un flux de subvention de code d’autorisation pour obtenir le jeton d’accès de backend.</span><span class="sxs-lookup"><span data-stu-id="4fb04-284">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="4fb04-285">Il a une seule page comme indiqué ci-dessous:</span><span class="sxs-lookup"><span data-stu-id="4fb04-285">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="4fb04-286">Le bouton **Autoriser** redirigera le navigateur vers le serveur d’autorisation pour aviser le propriétaire de la ressource d’accorder l’accès à ce client.</span><span class="sxs-lookup"><span data-stu-id="4fb04-286">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="4fb04-287">Le bouton **Refresh** recevra un nouveau jeton d’accès et rafraîchira le jeton à l’aide du jeton de rafraîchissement actuel.</span><span class="sxs-lookup"><span data-stu-id="4fb04-287">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="4fb04-288">Le bouton **Access Protected Resource API** appellera le serveur de ressources pour obtenir les données de réclamation de l’utilisateur actuel et les afficher sur la page.</span><span class="sxs-lookup"><span data-stu-id="4fb04-288">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="4fb04-289">Voici l’exemple de `HomeController` code du client.</span><span class="sxs-lookup"><span data-stu-id="4fb04-289">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="4fb04-290">`DotNetOpenAuth`exige SSL par défaut.</span><span class="sxs-lookup"><span data-stu-id="4fb04-290">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="4fb04-291">Puisque notre démo utilise HTTP, vous devez ajouter le paramètre suivant dans le fichier config :</span><span class="sxs-lookup"><span data-stu-id="4fb04-291">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="4fb04-292">Sécurité - Ne désactivez jamais SSL dans une application de production.</span><span class="sxs-lookup"><span data-stu-id="4fb04-292">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="4fb04-293">Vos identifiants de connexion sont maintenant envoyés en texte clair sur le fil.</span><span class="sxs-lookup"><span data-stu-id="4fb04-293">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="4fb04-294">Le code ci-dessus est juste pour le débogage d’échantillons locaux et l’exploration.</span><span class="sxs-lookup"><span data-stu-id="4fb04-294">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="4fb04-295">Client implicite de subvention</span><span class="sxs-lookup"><span data-stu-id="4fb04-295">Implicit Grant Client</span></span>

<span data-ttu-id="4fb04-296">Ce client utilise JavaScript pour :</span><span class="sxs-lookup"><span data-stu-id="4fb04-296">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="4fb04-297">Ouvrez une nouvelle fenêtre et rediriger vers le point de terminaison autorisé du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="4fb04-297">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="4fb04-298">Obtenez le jeton d’accès à partir de fragments d’URL lorsqu’il redirige.</span><span class="sxs-lookup"><span data-stu-id="4fb04-298">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="4fb04-299">L’image suivante montre ce processus :</span><span class="sxs-lookup"><span data-stu-id="4fb04-299">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="4fb04-300">Le client doit avoir deux pages : l’une pour la page d’accueil et l’autre pour rappel. Voici l’exemple de code JavaScript trouvé dans le fichier *Index.cshtml:*</span><span class="sxs-lookup"><span data-stu-id="4fb04-300">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="4fb04-301">Voici le code de traitement de rappel dans le fichier *SignIn.cshtml* :</span><span class="sxs-lookup"><span data-stu-id="4fb04-301">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="4fb04-302">Une meilleure pratique est de déplacer le JavaScript vers un fichier externe et ne pas l’intégrer avec la balisage Razor.</span><span class="sxs-lookup"><span data-stu-id="4fb04-302">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="4fb04-303">Pour garder cet échantillon simple, ils ont été combinés.</span><span class="sxs-lookup"><span data-stu-id="4fb04-303">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="4fb04-304">Ressources Propriétaire d’informations d’identification de mot de passe Grant Client</span><span class="sxs-lookup"><span data-stu-id="4fb04-304">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="4fb04-305">Nous avons recours à une application console pour démor égarder ce client.</span><span class="sxs-lookup"><span data-stu-id="4fb04-305">We uses a console app to demo this client.</span></span> <span data-ttu-id="4fb04-306">Voici le code :</span><span class="sxs-lookup"><span data-stu-id="4fb04-306">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="4fb04-307">Client Credentials Grant Client</span><span class="sxs-lookup"><span data-stu-id="4fb04-307">Client Credentials Grant Client</span></span>

<span data-ttu-id="4fb04-308">Semblable à la subvention d’identification de mot de passe de propriétaire de ressource, voici le code d’application de console :</span><span class="sxs-lookup"><span data-stu-id="4fb04-308">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
