---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: 'Utilisation de l’Entity Framework 4,0 et du contrôle ObjectDataSource, partie 2 : ajout d’une couche de logique métier et de tests unitaires | Microsoft Docs'
author: tdykstra
description: Cette série de didacticiels s’appuie sur l’application Web Contoso University qui est créée par le Prise en main avec la série de didacticiels Entity Framework 4,0. ...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: 24344cc33d7c26d7c408db26c0530ef2c708a7d3
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78546766"
---
# <a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="c6596-104">Utilisation de l’Entity Framework 4,0 et du contrôle ObjectDataSource, partie 2 : ajout d’une couche de logique métier et de tests unitaires</span><span class="sxs-lookup"><span data-stu-id="c6596-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>

<span data-ttu-id="c6596-105">par [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="c6596-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="c6596-106">Cette série de didacticiels s’appuie sur l’application Web Contoso University qui est créée par le [prise en main avec la](https://asp.net/entity-framework/tutorials#Getting%20Started) série de didacticiels Entity Framework 4,0.</span><span class="sxs-lookup"><span data-stu-id="c6596-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="c6596-107">Si vous n’avez pas terminé les didacticiels précédents, comme point de départ pour ce didacticiel, vous pouvez [Télécharger l’application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) que vous auriez créée.</span><span class="sxs-lookup"><span data-stu-id="c6596-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="c6596-108">Vous pouvez également [Télécharger l’application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) qui est créée par la série de didacticiels complète.</span><span class="sxs-lookup"><span data-stu-id="c6596-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="c6596-109">Si vous avez des questions sur les didacticiels, vous pouvez les poster sur le [Forum de Entity Framework ASP.net](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="c6596-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="c6596-110">Dans le didacticiel précédent, vous avez créé une application Web multiniveau à l’aide de la Entity Framework et du contrôle `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="c6596-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="c6596-111">Ce didacticiel montre comment ajouter une logique métier tout en conservant la couche logique métier (BLL) et la couche d’accès aux données (DAL) séparément, et indique comment créer des tests unitaires automatisés pour la couche BLL.</span><span class="sxs-lookup"><span data-stu-id="c6596-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="c6596-112">Dans ce didacticiel, vous allez effectuer les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="c6596-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="c6596-113">Créez une interface de référentiel qui déclare les méthodes d’accès aux données dont vous avez besoin.</span><span class="sxs-lookup"><span data-stu-id="c6596-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="c6596-114">Implémentez l’interface de référentiel dans la classe de référentiel.</span><span class="sxs-lookup"><span data-stu-id="c6596-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="c6596-115">Créez une classe de logique métier qui appelle la classe de référentiel pour exécuter des fonctions d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="c6596-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="c6596-116">Connectez le contrôle `ObjectDataSource` à la classe de logique métier au lieu de la classe de référentiel.</span><span class="sxs-lookup"><span data-stu-id="c6596-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="c6596-117">Créez un projet de test unitaire et une classe de référentiel qui utilise des collections en mémoire pour son magasin de données.</span><span class="sxs-lookup"><span data-stu-id="c6596-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="c6596-118">Créez un test unitaire pour la logique métier que vous souhaitez ajouter à la classe de logique métier, puis exécutez le test et observez l’échec.</span><span class="sxs-lookup"><span data-stu-id="c6596-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="c6596-119">Implémentez la logique métier dans la classe de logique métier, puis réexécutez le test unitaire et consultez-le Pass.</span><span class="sxs-lookup"><span data-stu-id="c6596-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="c6596-120">Vous utiliserez les pages *Departments. aspx* et *DepartmentsAdd. aspx* que vous avez créées dans le didacticiel précédent.</span><span class="sxs-lookup"><span data-stu-id="c6596-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="c6596-121">Création d’une interface de référentiel</span><span class="sxs-lookup"><span data-stu-id="c6596-121">Creating a Repository Interface</span></span>

<span data-ttu-id="c6596-122">Vous commencerez par créer l’interface de référentiel.</span><span class="sxs-lookup"><span data-stu-id="c6596-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="c6596-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="c6596-124">Dans le dossier *dal* , créez un nouveau fichier de classe, nommez-le *ISchoolRepository.cs*, puis remplacez le code existant par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="c6596-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="c6596-125">L’interface définit une méthode pour chacune des méthodes CRUD (création, lecture, mise à jour, suppression) que vous avez créées dans la classe de référentiel.</span><span class="sxs-lookup"><span data-stu-id="c6596-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="c6596-126">Dans la classe `SchoolRepository` dans *SchoolRepository.cs*, indiquez que cette classe implémente l’interface `ISchoolRepository` :</span><span class="sxs-lookup"><span data-stu-id="c6596-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="c6596-127">Création d’une classe de logique métier</span><span class="sxs-lookup"><span data-stu-id="c6596-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="c6596-128">Ensuite, vous allez créer la classe de logique métier.</span><span class="sxs-lookup"><span data-stu-id="c6596-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="c6596-129">Pour cela, vous pouvez ajouter la logique métier qui sera exécutée par le contrôle `ObjectDataSource`, même si vous ne le faites pas encore.</span><span class="sxs-lookup"><span data-stu-id="c6596-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="c6596-130">Pour le moment, la nouvelle classe de logique métier effectuera uniquement les mêmes opérations CRUD que le référentiel.</span><span class="sxs-lookup"><span data-stu-id="c6596-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="c6596-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="c6596-132">Créez un nouveau dossier et nommez-le *BLL*.</span><span class="sxs-lookup"><span data-stu-id="c6596-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="c6596-133">(Dans une application réelle, la couche logique métier est généralement implémentée en tant que bibliothèque de classes : un projet distinct, mais pour conserver ce didacticiel simple, les classes BLL sont conservées dans un dossier de projet.)</span><span class="sxs-lookup"><span data-stu-id="c6596-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="c6596-134">Dans le dossier *BLL* , créez un nouveau fichier de classe, nommez-le *SchoolBL.cs*, puis remplacez le code existant par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="c6596-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="c6596-135">Ce code crée les mêmes méthodes CRUD que celles que vous avez vues précédemment dans la classe de référentiel, mais au lieu d’accéder directement aux méthodes Entity Framework, il appelle les méthodes de la classe de référentiel.</span><span class="sxs-lookup"><span data-stu-id="c6596-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="c6596-136">La variable de classe qui contient une référence à la classe de référentiel est définie comme un type d’interface et le code qui instancie la classe de référentiel est contenu dans deux constructeurs.</span><span class="sxs-lookup"><span data-stu-id="c6596-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="c6596-137">Le constructeur sans paramètre sera utilisé par le contrôle `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="c6596-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="c6596-138">Il crée une instance de la classe `SchoolRepository` que vous avez créée précédemment.</span><span class="sxs-lookup"><span data-stu-id="c6596-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="c6596-139">L’autre constructeur autorise tout code qui instancie la classe de logique métier à passer dans tout objet qui implémente l’interface de référentiel.</span><span class="sxs-lookup"><span data-stu-id="c6596-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="c6596-140">Les méthodes CRUD qui appellent la classe de référentiel et les deux constructeurs permettent d’utiliser la classe de logique métier avec n’importe quel magasin de données principal que vous choisissez.</span><span class="sxs-lookup"><span data-stu-id="c6596-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="c6596-141">La classe de logique métier n’a pas besoin d’être conscient de la façon dont la classe qu’elle appelle rend persistantes les données.</span><span class="sxs-lookup"><span data-stu-id="c6596-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="c6596-142">(Cela est souvent appelé *ignorance de la persistance*.) Cela facilite les tests unitaires, car vous pouvez connecter la classe de logique métier à une implémentation de référentiel qui utilise des éléments aussi simples que les collections en mémoire `List` pour stocker des données.</span><span class="sxs-lookup"><span data-stu-id="c6596-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="c6596-143">Techniquement, les objets d’entité n’ignorent toujours pas la persistance, car ils sont instanciés à partir des classes qui héritent de la classe `EntityObject` de l’Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="c6596-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="c6596-144">Pour l’ignorance de la persistance complète, vous pouvez utiliser des *objets CLR ordinaires*, ou *poco*, à la place des objets qui héritent de la classe `EntityObject`.</span><span class="sxs-lookup"><span data-stu-id="c6596-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="c6596-145">L’utilisation des POCO n’entre pas dans le cadre de ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="c6596-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="c6596-146">Pour plus d’informations, consultez [testabilité et Entity Framework 4,0](https://msdn.microsoft.com/library/ff714955.aspx) sur le site Web MSDN.)</span><span class="sxs-lookup"><span data-stu-id="c6596-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) on the MSDN website.)</span></span>

<span data-ttu-id="c6596-147">À présent, vous pouvez connecter les contrôles de `ObjectDataSource` à la classe de logique métier plutôt qu’au référentiel et vérifier que tout fonctionne comme avant.</span><span class="sxs-lookup"><span data-stu-id="c6596-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="c6596-148">Dans *Departments. aspx* et *DepartmentsAdd. aspx*, remplacez chaque occurrence de `TypeName="ContosoUniversity.DAL.SchoolRepository"` par `TypeName="ContosoUniversity.BLL.SchoolBL`».</span><span class="sxs-lookup"><span data-stu-id="c6596-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="c6596-149">(Il y a quatre instances dans tout.)</span><span class="sxs-lookup"><span data-stu-id="c6596-149">(There are four instances in all.)</span></span>

<span data-ttu-id="c6596-150">Exécutez les pages *Departments. aspx* et *DepartmentsAdd. aspx* pour vérifier qu’elles fonctionnent toujours comme avant.</span><span class="sxs-lookup"><span data-stu-id="c6596-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="c6596-151">[![image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="c6596-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="c6596-153">Création d’un projet de test unitaire et d’une implémentation de référentiel</span><span class="sxs-lookup"><span data-stu-id="c6596-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="c6596-154">Ajoutez un nouveau projet à la solution à l’aide du modèle de **projet de test** , puis nommez-le `ContosoUniversity.Tests`.</span><span class="sxs-lookup"><span data-stu-id="c6596-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="c6596-155">Dans le projet de test, ajoutez une référence à `System.Data.Entity` et ajoutez une référence de projet au projet `ContosoUniversity`.</span><span class="sxs-lookup"><span data-stu-id="c6596-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="c6596-156">Vous pouvez maintenant créer la classe de référentiel que vous allez utiliser avec les tests unitaires.</span><span class="sxs-lookup"><span data-stu-id="c6596-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="c6596-157">Le magasin de données pour ce dépôt sera dans la classe.</span><span class="sxs-lookup"><span data-stu-id="c6596-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="c6596-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="c6596-159">Dans le projet de test, créez un nouveau fichier de classe, nommez-le *MockSchoolRepository.cs*, puis remplacez le code existant par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="c6596-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="c6596-160">Cette classe de référentiel a les mêmes méthodes CRUD que celle qui accède directement au Entity Framework, mais elles fonctionnent avec `List` collections en mémoire et non avec une base de données.</span><span class="sxs-lookup"><span data-stu-id="c6596-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="c6596-161">Il est ainsi plus facile pour une classe de test de configurer et de valider des tests unitaires pour la classe de logique métier.</span><span class="sxs-lookup"><span data-stu-id="c6596-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="c6596-162">Création de tests unitaires</span><span class="sxs-lookup"><span data-stu-id="c6596-162">Creating Unit Tests</span></span>

<span data-ttu-id="c6596-163">Le modèle de projet de **test** a créé une classe de test unitaire stub pour vous, et la tâche suivante consiste à modifier cette classe en y ajoutant des méthodes de test unitaire pour la logique métier que vous souhaitez ajouter à la classe de logique métier.</span><span class="sxs-lookup"><span data-stu-id="c6596-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="c6596-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="c6596-165">Chez Contoso University, tout formateur individuel ne peut être administrateur que d’un seul service et vous devez ajouter une logique métier pour appliquer cette règle.</span><span class="sxs-lookup"><span data-stu-id="c6596-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="c6596-166">Vous allez commencer par ajouter des tests et exécuter les tests pour les voir échouer.</span><span class="sxs-lookup"><span data-stu-id="c6596-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="c6596-167">Vous allez ensuite ajouter le code et réexécuter les tests, en attendant de les voir passer.</span><span class="sxs-lookup"><span data-stu-id="c6596-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="c6596-168">Ouvrez le fichier *UnitTest1.cs* et ajoutez `using` instructions pour la logique métier et les couches d’accès aux données que vous avez créées dans le projet ContosoUniversity :</span><span class="sxs-lookup"><span data-stu-id="c6596-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="c6596-169">Remplacez la méthode `TestMethod1` par les méthodes suivantes :</span><span class="sxs-lookup"><span data-stu-id="c6596-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="c6596-170">La méthode `CreateSchoolBL` crée une instance de la classe de référentiel que vous avez créée pour le projet de test unitaire, qu’elle passe ensuite à une nouvelle instance de la classe logique métier.</span><span class="sxs-lookup"><span data-stu-id="c6596-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="c6596-171">La méthode utilise ensuite la classe de logique métier pour insérer trois services que vous pouvez utiliser dans les méthodes de test.</span><span class="sxs-lookup"><span data-stu-id="c6596-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="c6596-172">Les méthodes de test vérifient que la classe de logique métier lève une exception si quelqu’un tente d’insérer un nouveau service avec le même administrateur qu’un service existant, ou si quelqu’un tente de mettre à jour l’administrateur d’un service en lui attribuant l’ID d’une personne qui est déjà l’administrateur d’un autre service.</span><span class="sxs-lookup"><span data-stu-id="c6596-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="c6596-173">Vous n’avez pas encore créé la classe d’exception, ce code ne sera donc pas compilé.</span><span class="sxs-lookup"><span data-stu-id="c6596-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="c6596-174">Pour le faire, cliquez avec le bouton droit sur `DuplicateAdministratorException`, puis sélectionnez **générer**, puis **classe**.</span><span class="sxs-lookup"><span data-stu-id="c6596-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="c6596-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="c6596-176">Cela crée une classe dans le projet de test que vous pouvez supprimer après avoir créé la classe d’exception dans le projet principal.</span><span class="sxs-lookup"><span data-stu-id="c6596-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="c6596-177">et implémenté la logique métier.</span><span class="sxs-lookup"><span data-stu-id="c6596-177">and implemented the business logic.</span></span>

<span data-ttu-id="c6596-178">Exécutez le projet de test.</span><span class="sxs-lookup"><span data-stu-id="c6596-178">Run the test project.</span></span> <span data-ttu-id="c6596-179">Comme prévu, les tests échouent.</span><span class="sxs-lookup"><span data-stu-id="c6596-179">As expected, the tests fail.</span></span>

<span data-ttu-id="c6596-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="c6596-181">Ajout d’une logique métier pour effectuer un test</span><span class="sxs-lookup"><span data-stu-id="c6596-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="c6596-182">Ensuite, vous allez implémenter la logique métier qui rend impossible de définir en tant qu’administrateur d’un service une personne qui est déjà administrateur d’un autre service.</span><span class="sxs-lookup"><span data-stu-id="c6596-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="c6596-183">Vous allez lever une exception à partir de la couche de logique métier, puis l’intercepter dans la couche de présentation si un utilisateur modifie un service et clique sur **mettre à jour** après avoir sélectionné une personne qui est déjà administrateur.</span><span class="sxs-lookup"><span data-stu-id="c6596-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="c6596-184">(Vous pouvez également supprimer des formateurs de la liste déroulante qui sont déjà administrateurs avant le rendu de la page, mais l’objectif ici est de travailler avec la couche logique métier.)</span><span class="sxs-lookup"><span data-stu-id="c6596-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="c6596-185">Commencez par créer la classe d’exception que vous allez lever lorsqu’un utilisateur tente de faire d’un formateur l’administrateur de plusieurs départements.</span><span class="sxs-lookup"><span data-stu-id="c6596-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="c6596-186">Dans le projet principal, créez un nouveau fichier de classe dans le dossier *BLL* , nommez-le *DuplicateAdministratorException.cs*et remplacez le code existant par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="c6596-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="c6596-187">Maintenant, supprimez le fichier *DuplicateAdministratorException.cs* temporaire que vous avez créé précédemment dans le projet de test afin de pouvoir le compiler.</span><span class="sxs-lookup"><span data-stu-id="c6596-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="c6596-188">Dans le projet principal, ouvrez le fichier *SchoolBL.cs* et ajoutez la méthode suivante qui contient la logique de validation.</span><span class="sxs-lookup"><span data-stu-id="c6596-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="c6596-189">(Le code fait référence à une méthode que vous allez créer ultérieurement.)</span><span class="sxs-lookup"><span data-stu-id="c6596-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="c6596-190">Vous appellerez cette méthode lors de l’insertion ou de la mise à jour de `Department` entités afin de vérifier si un autre service a déjà le même administrateur.</span><span class="sxs-lookup"><span data-stu-id="c6596-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="c6596-191">Le code appelle une méthode pour rechercher dans la base de données une entité `Department` ayant la même valeur de propriété `Administrator` que l’entité insérée ou mise à jour.</span><span class="sxs-lookup"><span data-stu-id="c6596-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="c6596-192">Si un est trouvé, le code lève une exception.</span><span class="sxs-lookup"><span data-stu-id="c6596-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="c6596-193">Aucun contrôle de validation n’est nécessaire si l’entité qui est insérée ou mise à jour n’a pas de valeur `Administrator`, et si aucune exception n’est levée si la méthode est appelée pendant une mise à jour et que l’entité `Department` trouvée correspond à la `Department` entité en cours de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="c6596-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="c6596-194">Appelez la nouvelle méthode à partir des méthodes `Insert` et `Update` :</span><span class="sxs-lookup"><span data-stu-id="c6596-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="c6596-195">Dans *ISchoolRepository.cs*, ajoutez la déclaration suivante pour la nouvelle méthode d’accès aux données :</span><span class="sxs-lookup"><span data-stu-id="c6596-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="c6596-196">Dans *SchoolRepository.cs*, ajoutez l’instruction `using` suivante :</span><span class="sxs-lookup"><span data-stu-id="c6596-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="c6596-197">Dans *SchoolRepository.cs*, ajoutez la nouvelle méthode d’accès aux données suivante :</span><span class="sxs-lookup"><span data-stu-id="c6596-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="c6596-198">Ce code récupère `Department` entités qui ont un administrateur spécifié.</span><span class="sxs-lookup"><span data-stu-id="c6596-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="c6596-199">Un seul service doit être trouvé (le cas échéant).</span><span class="sxs-lookup"><span data-stu-id="c6596-199">Only one department should be found (if any).</span></span> <span data-ttu-id="c6596-200">Toutefois, étant donné qu’aucune contrainte n’est intégrée à la base de données, le type de retour est une collection au cas où plusieurs services seraient trouvés.</span><span class="sxs-lookup"><span data-stu-id="c6596-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="c6596-201">Par défaut, lorsque le contexte de l’objet récupère des entités de la base de données, il les conserve dans son gestionnaire d’état d’objet.</span><span class="sxs-lookup"><span data-stu-id="c6596-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="c6596-202">Le paramètre `MergeOption.NoTracking` spécifie que ce suivi ne sera pas effectué pour cette requête.</span><span class="sxs-lookup"><span data-stu-id="c6596-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="c6596-203">Cela est nécessaire, car la requête peut retourner l’entité exacte que vous essayez de mettre à jour, puis vous ne pouvez pas attacher cette entité.</span><span class="sxs-lookup"><span data-stu-id="c6596-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="c6596-204">Par exemple, si vous modifiez le service d’historique dans la page *Departments. aspx* et que vous laissez l’administrateur inchangé, cette requête retourne le département de l’historique.</span><span class="sxs-lookup"><span data-stu-id="c6596-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="c6596-205">Si `NoTracking` n’est pas défini, le contexte de l’objet a déjà l’entité de service d’historique dans son gestionnaire d’état d’objet.</span><span class="sxs-lookup"><span data-stu-id="c6596-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="c6596-206">Ensuite, lorsque vous attachez l’entité de service d’historique qui est recréée à partir de l’état d’affichage, le contexte de l’objet lèvera une exception qui indique `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span><span class="sxs-lookup"><span data-stu-id="c6596-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="c6596-207">(Au lieu de spécifier `MergeOption.NoTracking`, vous pouvez créer un nouveau contexte d’objet uniquement pour cette requête.</span><span class="sxs-lookup"><span data-stu-id="c6596-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="c6596-208">Étant donné que le nouveau contexte d’objet a son propre gestionnaire d’état d’objet, il n’y aurait aucun conflit quand vous appelez la méthode `Attach`.</span><span class="sxs-lookup"><span data-stu-id="c6596-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="c6596-209">Le nouveau contexte d’objet partageait les métadonnées et la connexion de base de données avec le contexte d’objet d’origine, de sorte que la baisse des performances de cette approche serait minime.</span><span class="sxs-lookup"><span data-stu-id="c6596-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="c6596-210">Toutefois, l’approche présentée ici présente l’option `NoTracking`, que vous trouverez utile dans d’autres contextes.</span><span class="sxs-lookup"><span data-stu-id="c6596-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="c6596-211">L’option `NoTracking` est décrite plus en détail dans un didacticiel ultérieur de cette série.)</span><span class="sxs-lookup"><span data-stu-id="c6596-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="c6596-212">Dans le projet de test, ajoutez la nouvelle méthode d’accès aux données à *MockSchoolRepository.cs*:</span><span class="sxs-lookup"><span data-stu-id="c6596-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="c6596-213">Ce code utilise LINQ pour effectuer la même sélection de données que celle utilisée par le dépôt de projet `ContosoUniversity` LINQ to Entities.</span><span class="sxs-lookup"><span data-stu-id="c6596-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="c6596-214">Réexécutez le projet de test.</span><span class="sxs-lookup"><span data-stu-id="c6596-214">Run the test project again.</span></span> <span data-ttu-id="c6596-215">Cette fois-ci, les tests réussissent.</span><span class="sxs-lookup"><span data-stu-id="c6596-215">This time the tests pass.</span></span>

<span data-ttu-id="c6596-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="c6596-217">Gestion des exceptions ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="c6596-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="c6596-218">Dans le projet `ContosoUniversity`, exécutez la page *Departments. aspx* et essayez de modifier l’administrateur d’un service pour qu’une personne qui est déjà administrateur d’un autre service.</span><span class="sxs-lookup"><span data-stu-id="c6596-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="c6596-219">(N’oubliez pas que vous ne pouvez modifier que les services que vous avez ajoutés au cours de ce didacticiel, car la base de données est préchargée avec des données non valides.) Vous recevez la page d’erreur de serveur suivante :</span><span class="sxs-lookup"><span data-stu-id="c6596-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="c6596-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="c6596-221">Vous ne souhaitez pas que les utilisateurs voient ce type de page d’erreur. vous devez donc ajouter du code de gestion des erreurs.</span><span class="sxs-lookup"><span data-stu-id="c6596-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="c6596-222">Ouvrez *Departments. aspx* et spécifiez un gestionnaire pour l’événement `OnUpdated` de l' `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="c6596-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="c6596-223">La balise d’ouverture `ObjectDataSource` ressemble maintenant à l’exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="c6596-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="c6596-224">Dans *Departments.aspx.cs*, ajoutez l’instruction `using` suivante :</span><span class="sxs-lookup"><span data-stu-id="c6596-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="c6596-225">Ajoutez le gestionnaire suivant pour l’événement `Updated` :</span><span class="sxs-lookup"><span data-stu-id="c6596-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="c6596-226">Si le contrôle de `ObjectDataSource` intercepte une exception lorsqu’il essaie d’effectuer la mise à jour, il passe l’exception dans l’argument d’événement (`e`) à ce gestionnaire.</span><span class="sxs-lookup"><span data-stu-id="c6596-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="c6596-227">Le code dans le gestionnaire vérifie si l’exception est l’exception d’administrateur en double.</span><span class="sxs-lookup"><span data-stu-id="c6596-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="c6596-228">Si c’est le cas, le code crée un contrôle de validateur qui contient un message d’erreur pour le contrôle `ValidationSummary` à afficher.</span><span class="sxs-lookup"><span data-stu-id="c6596-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="c6596-229">Exécutez la page et essayez à nouveau de faire de la part de l’administrateur de deux départements.</span><span class="sxs-lookup"><span data-stu-id="c6596-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="c6596-230">Cette fois, le contrôle de `ValidationSummary` affiche un message d’erreur.</span><span class="sxs-lookup"><span data-stu-id="c6596-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="c6596-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="c6596-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="c6596-232">Apportez des modifications similaires à la page *DepartmentsAdd. aspx* .</span><span class="sxs-lookup"><span data-stu-id="c6596-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="c6596-233">Dans *DepartmentsAdd. aspx*, spécifiez un gestionnaire pour l’événement `OnInserted` de l' `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="c6596-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="c6596-234">Le balisage résultant ressemble à l’exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="c6596-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="c6596-235">Dans *DepartmentsAdd.aspx.cs*, ajoutez la même instruction `using` :</span><span class="sxs-lookup"><span data-stu-id="c6596-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="c6596-236">Ajoutez le gestionnaire d’événements suivant :</span><span class="sxs-lookup"><span data-stu-id="c6596-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="c6596-237">Vous pouvez maintenant tester la page *DepartmentsAdd.aspx.cs* pour vérifier qu’elle gère également correctement les tentatives de faire d’une personne l’administrateur de plusieurs départements.</span><span class="sxs-lookup"><span data-stu-id="c6596-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="c6596-238">Cela termine la présentation de l’implémentation du modèle de référentiel pour l’utilisation du contrôle `ObjectDataSource` avec l’Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="c6596-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="c6596-239">Pour plus d’informations sur le modèle de référentiel et la testabilité, consultez le livre blanc [testabilité de MSDN et Entity Framework 4,0](https://msdn.microsoft.com/library/ff714955.aspx).</span><span class="sxs-lookup"><span data-stu-id="c6596-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span></span>

<span data-ttu-id="c6596-240">Dans le didacticiel suivant, vous allez apprendre à ajouter des fonctionnalités de tri et de filtrage à l’application.</span><span class="sxs-lookup"><span data-stu-id="c6596-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="c6596-241">[Précédent](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
> [Suivant](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="c6596-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
