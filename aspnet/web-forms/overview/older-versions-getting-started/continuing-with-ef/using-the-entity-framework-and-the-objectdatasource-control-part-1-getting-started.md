---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started
title: 'À l’aide de l’Entity Framework 4,0 et du contrôle ObjectDataSource, partie 1 : Prise en main | Microsoft Docs'
author: tdykstra
description: Cette série de didacticiels s’appuie sur l’application Web Contoso University qui est créée par le Prise en main avec la série de didacticiels Entity Framework. Si Yo...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: 244278c1-fec8-4255-8a8a-13bde491c4f5
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started
msc.type: authoredcontent
ms.openlocfilehash: 2f14707eb058d438495dd2bc4c17b976c471fc97
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78547291"
---
# <a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-1-getting-started"></a><span data-ttu-id="45df9-104">À l’aide de l’Entity Framework 4,0 et du contrôle ObjectDataSource, partie 1 : Prise en main</span><span class="sxs-lookup"><span data-stu-id="45df9-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 1: Getting Started</span></span>

<span data-ttu-id="45df9-105">par [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="45df9-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="45df9-106">Cette série de didacticiels s’appuie sur l’application Web Contoso University qui est créée par le [prise en main avec la](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) série de didacticiels Entity Framework 4,0.</span><span class="sxs-lookup"><span data-stu-id="45df9-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorial series.</span></span> <span data-ttu-id="45df9-107">Si vous n’avez pas terminé les didacticiels précédents, comme point de départ pour ce didacticiel, vous pouvez [Télécharger l’application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) que vous auriez créée.</span><span class="sxs-lookup"><span data-stu-id="45df9-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="45df9-108">Vous pouvez également [Télécharger l’application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) qui est créée par la série de didacticiels complète.</span><span class="sxs-lookup"><span data-stu-id="45df9-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span>
> 
> <span data-ttu-id="45df9-109">L’exemple d’application Web Contoso University montre comment créer des applications ASP.NET Web Forms à l’aide de la Entity Framework 4,0 et de Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="45df9-109">The Contoso University sample web application demonstrates how to create ASP.NET Web Forms applications using the Entity Framework 4.0 and Visual Studio 2010.</span></span> <span data-ttu-id="45df9-110">L’exemple d’application est un site Web pour une université contoso fictive.</span><span class="sxs-lookup"><span data-stu-id="45df9-110">The sample application is a website for a fictional Contoso University.</span></span> <span data-ttu-id="45df9-111">Il comprend des fonctionnalités telles que l’admission des étudiants, la création des cours et les affectations des formateurs.</span><span class="sxs-lookup"><span data-stu-id="45df9-111">It includes functionality such as student admission, course creation, and instructor assignments.</span></span>
> 
> <span data-ttu-id="45df9-112">Ce didacticiel présente des exemples C#dans.</span><span class="sxs-lookup"><span data-stu-id="45df9-112">The tutorial shows examples in C#.</span></span> <span data-ttu-id="45df9-113">L' [exemple téléchargeable](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) contient du code C# à la fois dans et Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="45df9-113">The [downloadable sample](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) contains code in both C# and Visual Basic.</span></span>
> 
> ## <a name="database-first"></a><span data-ttu-id="45df9-114">Database First</span><span class="sxs-lookup"><span data-stu-id="45df9-114">Database First</span></span>
> 
> <span data-ttu-id="45df9-115">Il existe trois façons de travailler avec des données dans le Entity Framework : *Database First*, *Model First*et *Code First*.</span><span class="sxs-lookup"><span data-stu-id="45df9-115">There are three ways you can work with data in the Entity Framework: *Database First*, *Model First*, and *Code First*.</span></span> <span data-ttu-id="45df9-116">Ce didacticiel est destiné à Database First.</span><span class="sxs-lookup"><span data-stu-id="45df9-116">This tutorial is for Database First.</span></span> <span data-ttu-id="45df9-117">Pour plus d’informations sur les différences entre ces flux de travail et des conseils sur la façon de choisir le meilleur pour votre scénario, consultez [Entity Framework des flux de travail de développement](https://msdn.microsoft.com/library/ms178359.aspx#dbfmfcf).</span><span class="sxs-lookup"><span data-stu-id="45df9-117">For information about the differences between these workflows and guidance on how to choose the best one for your scenario, see [Entity Framework Development Workflows](https://msdn.microsoft.com/library/ms178359.aspx#dbfmfcf).</span></span>
> 
> ## <a name="web-forms"></a><span data-ttu-id="45df9-118">Web Forms</span><span class="sxs-lookup"><span data-stu-id="45df9-118">Web Forms</span></span>
> 
> <span data-ttu-id="45df9-119">À l’instar de la série Prise en main, cette série de didacticiels utilise le modèle ASP.NET Web Forms et suppose que vous savez utiliser ASP.NET Web Forms dans Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="45df9-119">Like the Getting Started series, this tutorial series uses the ASP.NET Web Forms model and assumes you know how to work with ASP.NET Web Forms in Visual Studio.</span></span> <span data-ttu-id="45df9-120">Si ce n’est pas le cas, consultez [prise en main avec ASP.NET 4,5 Web Forms](../../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md).</span><span class="sxs-lookup"><span data-stu-id="45df9-120">If you don't, see [Getting Started with ASP.NET 4.5 Web Forms](../../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md).</span></span> <span data-ttu-id="45df9-121">Si vous préférez utiliser l’infrastructure MVC ASP.NET, consultez [prise en main avec le Entity Framework à l’aide de ASP.NET MVC](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span><span class="sxs-lookup"><span data-stu-id="45df9-121">If you prefer to work with the ASP.NET MVC framework, see [Getting Started with the Entity Framework using ASP.NET MVC](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span>
> 
> ## <a name="software-versions"></a><span data-ttu-id="45df9-122">Versions de logiciels</span><span class="sxs-lookup"><span data-stu-id="45df9-122">Software versions</span></span>
> 
> | <span data-ttu-id="45df9-123">**Indiqué dans le didacticiel**</span><span class="sxs-lookup"><span data-stu-id="45df9-123">**Shown in the tutorial**</span></span> | <span data-ttu-id="45df9-124">**Fonctionne également avec**</span><span class="sxs-lookup"><span data-stu-id="45df9-124">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="45df9-125">Windows 7</span><span class="sxs-lookup"><span data-stu-id="45df9-125">Windows 7</span></span> | <span data-ttu-id="45df9-126">Windows 8</span><span class="sxs-lookup"><span data-stu-id="45df9-126">Windows 8</span></span> |
> | <span data-ttu-id="45df9-127">Visual Studio 2010</span><span class="sxs-lookup"><span data-stu-id="45df9-127">Visual Studio 2010</span></span> | <span data-ttu-id="45df9-128">Visual Studio 2010 Express pour le Web.</span><span class="sxs-lookup"><span data-stu-id="45df9-128">Visual Studio 2010 Express for Web.</span></span> <span data-ttu-id="45df9-129">Ce didacticiel n’a pas été testé avec les versions ultérieures de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="45df9-129">The tutorial has not been tested with later versions of Visual Studio.</span></span> <span data-ttu-id="45df9-130">Il existe de nombreuses différences dans les sélections de menus, les boîtes de dialogue et les modèles.</span><span class="sxs-lookup"><span data-stu-id="45df9-130">There are many differences in menu selections, dialog boxes, and templates.</span></span> |
> | <span data-ttu-id="45df9-131">.NET 4</span><span class="sxs-lookup"><span data-stu-id="45df9-131">.NET 4</span></span> | <span data-ttu-id="45df9-132">.NET 4,5 offre une compatibilité descendante avec .NET 4, mais le didacticiel n’a pas été testé avec .NET 4,5.</span><span class="sxs-lookup"><span data-stu-id="45df9-132">.NET 4.5 is backward compatible with .NET 4, but the tutorial has not been tested with .NET 4.5.</span></span> |
> | <span data-ttu-id="45df9-133">Entity Framework 4</span><span class="sxs-lookup"><span data-stu-id="45df9-133">Entity Framework 4</span></span> | <span data-ttu-id="45df9-134">Ce didacticiel n’a pas été testé avec les versions ultérieures de Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="45df9-134">The tutorial has not been tested with later versions of Entity Framework.</span></span> <span data-ttu-id="45df9-135">À partir de Entity Framework 5, EF utilise par défaut le `DbContext API` introduit avec EF 4,1.</span><span class="sxs-lookup"><span data-stu-id="45df9-135">Starting with Entity Framework 5, EF uses by default the `DbContext API` that was introduced with EF 4.1.</span></span> <span data-ttu-id="45df9-136">Le contrôle EntityDataSource a été conçu pour utiliser l’API `ObjectContext`.</span><span class="sxs-lookup"><span data-stu-id="45df9-136">The EntityDataSource control was designed to use the `ObjectContext` API.</span></span> <span data-ttu-id="45df9-137">Pour plus d’informations sur l’utilisation du contrôle EntityDataSource avec l’API `DbContext`, consultez ce billet de [blog](https://blogs.msdn.com/b/webdev/archive/2012/09/13/how-to-use-the-entitydatasource-control-with-entity-framework-code-first.aspx).</span><span class="sxs-lookup"><span data-stu-id="45df9-137">For information about how to use the EntityDataSource control with the `DbContext` API, see [this blog post](https://blogs.msdn.com/b/webdev/archive/2012/09/13/how-to-use-the-entitydatasource-control-with-entity-framework-code-first.aspx).</span></span> |
> 
> ## <a name="questions"></a><span data-ttu-id="45df9-138">Questions</span><span class="sxs-lookup"><span data-stu-id="45df9-138">Questions</span></span>
> 
> <span data-ttu-id="45df9-139">Si vous avez des questions qui ne sont pas directement liées au didacticiel, vous pouvez les poster sur le [forum ASP.NET Entity Framework](https://forums.asp.net/1227.aspx), sur le [forum Entity Framework et LINQ to Entities](https://social.msdn.microsoft.com/forums/adodotnetentityframework/threads/), ou sur [StackOverflow.com](http://stackoverflow.com/).</span><span class="sxs-lookup"><span data-stu-id="45df9-139">If you have questions that are not directly related to the tutorial, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx), the [Entity Framework and LINQ to Entities forum](https://social.msdn.microsoft.com/forums/adodotnetentityframework/threads/), or [StackOverflow.com](http://stackoverflow.com/).</span></span>

<span data-ttu-id="45df9-140">Le contrôle `EntityDataSource` vous permet de créer une application très rapidement, mais elle vous oblige généralement à conserver une quantité significative de logique métier et d’accès aux données dans vos pages *. aspx* .</span><span class="sxs-lookup"><span data-stu-id="45df9-140">The `EntityDataSource` control enables you to create an application very quickly, but it typically requires you to keep a significant amount of business logic and data-access logic in your *.aspx* pages.</span></span> <span data-ttu-id="45df9-141">Si vous vous attendez à ce que votre application se développe en complexité et qu’elle nécessite une maintenance continue, vous pouvez investir plus de temps pour le développement en amont afin de créer une structure d’application *multicouche ou* en *couches* plus facile à gérer.</span><span class="sxs-lookup"><span data-stu-id="45df9-141">If you expect your application to grow in complexity and to require ongoing maintenance, you can invest more development time up front in order to create an *n-tier* or *layered* application structure that's more maintainable.</span></span> <span data-ttu-id="45df9-142">Pour implémenter cette architecture, vous séparez la couche de présentation de la couche de logique métier (BLL) et de la couche d’accès aux données (DAL).</span><span class="sxs-lookup"><span data-stu-id="45df9-142">To implement this architecture, you separate the presentation layer from the business logic layer (BLL) and the data access layer (DAL).</span></span> <span data-ttu-id="45df9-143">L’une des façons d’implémenter cette structure est d’utiliser le contrôle `ObjectDataSource` au lieu du contrôle `EntityDataSource`.</span><span class="sxs-lookup"><span data-stu-id="45df9-143">One way to implement this structure is to use the `ObjectDataSource` control instead of the `EntityDataSource` control.</span></span> <span data-ttu-id="45df9-144">Lorsque vous utilisez le contrôle `ObjectDataSource`, vous implémentez votre propre code d’accès aux données, puis vous l’appelez dans des pages *. aspx* à l’aide d’un contrôle qui possède un grand nombre des mêmes fonctionnalités que les autres contrôles de source de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-144">When you use the `ObjectDataSource` control, you implement your own data-access code and then invoke it in *.aspx* pages using a control that has many of the same features as other data-source controls.</span></span> <span data-ttu-id="45df9-145">Cela vous permet de combiner les avantages d’une approche multiniveau avec les avantages de l’utilisation d’un contrôle de Web Forms pour l’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="45df9-145">This lets you combine the advantages of an n-tier approach with the benefits of using a Web Forms control for data access.</span></span>

<span data-ttu-id="45df9-146">Le contrôle `ObjectDataSource` offre également davantage de flexibilité.</span><span class="sxs-lookup"><span data-stu-id="45df9-146">The `ObjectDataSource` control gives you more flexibility in other ways as well.</span></span> <span data-ttu-id="45df9-147">Étant donné que vous écrivez votre propre code d’accès aux données, il est plus facile de faire plus que simplement lire, insérer, mettre à jour ou supprimer un type d’entité spécifique, qui sont les tâches que le contrôle de `EntityDataSource` est conçu pour effectuer.</span><span class="sxs-lookup"><span data-stu-id="45df9-147">Because you write your own data-access code, it's easier to do more than just read, insert, update, or delete a specific entity type, which are the tasks that the `EntityDataSource` control is designed to perform.</span></span> <span data-ttu-id="45df9-148">Par exemple, vous pouvez effectuer la journalisation chaque fois qu’une entité est mise à jour, archiver des données chaque fois qu’une entité est supprimée, ou vérifier et mettre à jour automatiquement les données associées en fonction des besoins lors de l’insertion d’une ligne avec une valeur de clé étrangère.</span><span class="sxs-lookup"><span data-stu-id="45df9-148">For example, you can perform logging every time an entity is updated, archive data whenever an entity is deleted, or automatically check and update related data as needed when inserting a row with a foreign key value.</span></span>

## <a name="business-logic-and-repository-classes"></a><span data-ttu-id="45df9-149">Logique métier et classes de référentiel</span><span class="sxs-lookup"><span data-stu-id="45df9-149">Business Logic and Repository Classes</span></span>

<span data-ttu-id="45df9-150">Un contrôle `ObjectDataSource` fonctionne en appelant une classe que vous créez.</span><span class="sxs-lookup"><span data-stu-id="45df9-150">An `ObjectDataSource` control works by invoking a class that you create.</span></span> <span data-ttu-id="45df9-151">La classe comprend des méthodes qui récupèrent et mettent à jour des données, et vous fournissez les noms de ces méthodes au contrôle `ObjectDataSource` dans le balisage.</span><span class="sxs-lookup"><span data-stu-id="45df9-151">The class includes methods that retrieve and update data, and you provide the names of those methods to the `ObjectDataSource` control in markup.</span></span> <span data-ttu-id="45df9-152">Pendant le rendu ou le traitement des publications (postback), le `ObjectDataSource` appelle les méthodes que vous avez spécifiées.</span><span class="sxs-lookup"><span data-stu-id="45df9-152">During rendering or postback processing, the `ObjectDataSource` calls the methods that you've specified.</span></span>

<span data-ttu-id="45df9-153">Outre les opérations CRUD de base, la classe que vous créez à utiliser avec le contrôle `ObjectDataSource` peut avoir besoin d’exécuter la logique métier lorsque le `ObjectDataSource` lit ou met à jour les données.</span><span class="sxs-lookup"><span data-stu-id="45df9-153">Besides basic CRUD operations, the class that you create to use with the `ObjectDataSource` control might need to execute business logic when the `ObjectDataSource` reads or updates data.</span></span> <span data-ttu-id="45df9-154">Par exemple, lorsque vous mettez à jour un service, vous devrez peut-être vérifier qu’aucun autre service n’a le même administrateur, car une personne ne peut pas être administrateur de plusieurs départements.</span><span class="sxs-lookup"><span data-stu-id="45df9-154">For example, when you update a department, you might need to validate that no other departments have the same administrator because one person cannot be administrator of more than one department.</span></span>

<span data-ttu-id="45df9-155">Dans une documentation `ObjectDataSource`, telle que la [vue d’ensemble de la classe ObjectDataSource](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.aspx), le contrôle appelle une classe appelée *objet métier* qui comprend à la fois la logique métier et la logique d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="45df9-155">In some `ObjectDataSource` documentation, such as the [ObjectDataSource Class overview](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.aspx), the control calls a class referred to as a *business object* that includes both business logic and data-access logic.</span></span> <span data-ttu-id="45df9-156">Dans ce didacticiel, vous allez créer des classes distinctes pour la logique métier et pour la logique d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="45df9-156">In this tutorial you will create separate classes for business logic and for data-access logic.</span></span> <span data-ttu-id="45df9-157">La classe qui encapsule la logique d’accès aux données est appelée un *référentiel*.</span><span class="sxs-lookup"><span data-stu-id="45df9-157">The class that encapsulates data-access logic is called a *repository*.</span></span> <span data-ttu-id="45df9-158">La classe de logique métier comprend à la fois des méthodes de logique métier et des méthodes d’accès aux données, mais les méthodes d’accès aux données appellent le référentiel pour effectuer des tâches d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="45df9-158">The business logic class includes both business-logic methods and data-access methods, but the data-access methods call the repository to perform data-access tasks.</span></span>

<span data-ttu-id="45df9-159">Vous allez également créer une couche d’abstraction entre vos couches BLL et DAL qui facilite le test unitaire automatisé de la couche BLL.</span><span class="sxs-lookup"><span data-stu-id="45df9-159">You will also create an abstraction layer between your BLL and DAL that facilitates automated unit testing of the BLL.</span></span> <span data-ttu-id="45df9-160">Cette couche d’abstraction est implémentée en créant une interface et en utilisant l’interface quand vous instanciez le référentiel dans la classe de logique métier.</span><span class="sxs-lookup"><span data-stu-id="45df9-160">This abstraction layer is implemented by creating an interface and using the interface when you instantiate the repository in the business-logic class.</span></span> <span data-ttu-id="45df9-161">Cela vous permet de fournir la classe de logique métier avec une référence à n’importe quel objet qui implémente l’interface de référentiel.</span><span class="sxs-lookup"><span data-stu-id="45df9-161">This makes it possible for you to provide the business-logic class with a reference to any object that implements the repository interface.</span></span> <span data-ttu-id="45df9-162">Pour un fonctionnement normal, vous fournissez un objet de référentiel qui fonctionne avec l’Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="45df9-162">For normal operation, you provide a repository object that works with the Entity Framework.</span></span> <span data-ttu-id="45df9-163">À des fins de test, vous fournissez un objet de référentiel qui fonctionne avec les données stockées d’une manière que vous pouvez facilement manipuler, comme les variables de classe définies en tant que Collections.</span><span class="sxs-lookup"><span data-stu-id="45df9-163">For testing, you provide a repository object that works with data stored in a way that you can easily manipulate, such as class variables defined as collections.</span></span>

<span data-ttu-id="45df9-164">L’illustration suivante montre la différence entre une classe de logique métier qui comprend une logique d’accès aux données sans référentiel et une classe qui utilise un référentiel.</span><span class="sxs-lookup"><span data-stu-id="45df9-164">The following illustration shows the difference between a business-logic class that includes data-access logic without a repository and one that uses a repository.</span></span>

<span data-ttu-id="45df9-165">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-165">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image1.png)</span></span>

<span data-ttu-id="45df9-166">Vous commencerez par créer des pages Web dans lesquelles le contrôle `ObjectDataSource` est lié directement à un référentiel, car il effectue uniquement des tâches d’accès aux données de base.</span><span class="sxs-lookup"><span data-stu-id="45df9-166">You will begin by creating web pages in which the `ObjectDataSource` control is bound directly to a repository because it only performs basic data-access tasks.</span></span> <span data-ttu-id="45df9-167">Dans le didacticiel suivant, vous allez créer une classe de logique métier avec une logique de validation et lier le contrôle `ObjectDataSource` à cette classe au lieu de la classe de référentiel.</span><span class="sxs-lookup"><span data-stu-id="45df9-167">In the next tutorial you will create a business logic class with validation logic and bind the `ObjectDataSource` control to that class instead of to the repository class.</span></span> <span data-ttu-id="45df9-168">Vous allez également créer des tests unitaires pour la logique de validation.</span><span class="sxs-lookup"><span data-stu-id="45df9-168">You will also create unit tests for the validation logic.</span></span> <span data-ttu-id="45df9-169">Dans le troisième didacticiel de cette série, vous allez ajouter des fonctionnalités de tri et de filtrage à l’application.</span><span class="sxs-lookup"><span data-stu-id="45df9-169">In the third tutorial in this series you will add sorting and filtering functionality to the application.</span></span>

<span data-ttu-id="45df9-170">Les pages que vous créez dans ce didacticiel fonctionnent avec le jeu d’entités `Departments` du modèle de données que vous avez créé dans le [prise en main série de didacticiels](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md).</span><span class="sxs-lookup"><span data-stu-id="45df9-170">The pages you create in this tutorial work with the `Departments` entity set of the data model that you created in the [Getting Started tutorial series](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md).</span></span>

<span data-ttu-id="45df9-171">[![image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-171">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image3.png)</span></span>

<span data-ttu-id="45df9-172">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-172">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image5.png)</span></span>

## <a name="updating-the-database-and-the-data-model"></a><span data-ttu-id="45df9-173">Mise à jour de la base de données et du modèle de données</span><span class="sxs-lookup"><span data-stu-id="45df9-173">Updating the Database and the Data Model</span></span>

<span data-ttu-id="45df9-174">Vous allez commencer ce didacticiel en apportant deux modifications à la base de données, qui nécessitent toutes deux des modifications correspondantes au modèle de données que vous avez créé dans le [prise en main avec les didacticiels Entity Framework et Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) .</span><span class="sxs-lookup"><span data-stu-id="45df9-174">You will begin this tutorial by making two changes to the database, both of which require corresponding changes to the data model that you created in the [Getting Started with the Entity Framework and Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorials.</span></span> <span data-ttu-id="45df9-175">Dans l’un de ces didacticiels, vous avez apporté manuellement des modifications au concepteur pour synchroniser le modèle de données avec la base de données après une modification de la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-175">In one of those tutorials, you made changes in the designer manually to synchronize the data model with the database after a database change.</span></span> <span data-ttu-id="45df9-176">Dans ce didacticiel, vous allez utiliser l’outil de **mise à jour du modèle de base** de données du concepteur pour mettre à jour le modèle de données automatiquement.</span><span class="sxs-lookup"><span data-stu-id="45df9-176">In this tutorial, you will use the designer's **Update Model From Database** tool to update the data model automatically.</span></span>

### <a name="adding-a-relationship-to-the-database"></a><span data-ttu-id="45df9-177">Ajout d’une relation à la base de données</span><span class="sxs-lookup"><span data-stu-id="45df9-177">Adding a Relationship to the Database</span></span>

<span data-ttu-id="45df9-178">Dans Visual Studio, ouvrez l’application Web Contoso University que vous avez créée dans le [prise en main à l’aide de la](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) série de didacticiels Entity Framework et Web Forms, puis ouvrez le schéma de base de données `SchoolDiagram`.</span><span class="sxs-lookup"><span data-stu-id="45df9-178">In Visual Studio, open the Contoso University web application you created in the [Getting Started with the Entity Framework and Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorial series, and then open the `SchoolDiagram` database diagram.</span></span>

<span data-ttu-id="45df9-179">Si vous examinez la table `Department` dans le schéma de base de données, vous verrez qu’elle contient une colonne `Administrator`.</span><span class="sxs-lookup"><span data-stu-id="45df9-179">If you look at the `Department` table in the database diagram, you will see that it has an `Administrator` column.</span></span> <span data-ttu-id="45df9-180">Cette colonne est une clé étrangère de la table `Person`, mais aucune relation de clé étrangère n’est définie dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-180">This column is a foreign key to the `Person` table, but no foreign key relationship is defined in the database.</span></span> <span data-ttu-id="45df9-181">Vous devez créer la relation et mettre à jour le modèle de données afin que le Entity Framework puisse gérer automatiquement cette relation.</span><span class="sxs-lookup"><span data-stu-id="45df9-181">You need to create the relationship and update the data model so that the Entity Framework can automatically handle this relationship.</span></span>

<span data-ttu-id="45df9-182">Dans le schéma de base de données, cliquez avec le bouton droit sur la table `Department`, puis sélectionnez **relations**.</span><span class="sxs-lookup"><span data-stu-id="45df9-182">In the database diagram, right-click the `Department` table, and select **Relationships**.</span></span>

<span data-ttu-id="45df9-183">[![Image80](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-183">[![Image80](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image7.png)</span></span>

<span data-ttu-id="45df9-184">Dans la zone **relations de clé étrangère** , cliquez sur **Ajouter**, puis sur les points de suspension pour la **spécification de tables et de colonnes**.</span><span class="sxs-lookup"><span data-stu-id="45df9-184">In the **Foreign Key Relationships** box click **Add**, then click the ellipsis for **Tables and Columns Specification**.</span></span>

<span data-ttu-id="45df9-185">[![Image81](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-185">[![Image81](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image9.png)</span></span>

<span data-ttu-id="45df9-186">Dans la boîte de dialogue **tables et colonnes** , définissez la table et le champ de clé primaire sur `Person` et `PersonID`, puis définissez la table et le champ de clé étrangère sur `Department` et `Administrator`.</span><span class="sxs-lookup"><span data-stu-id="45df9-186">In the **Tables and Columns** dialog box, set the primary key table and field to `Person` and `PersonID`, and set the foreign key table and field to `Department` and `Administrator`.</span></span> <span data-ttu-id="45df9-187">(Dans ce cas, le nom de la relation passe de `FK_Department_Department` à `FK_Department_Person`.)</span><span class="sxs-lookup"><span data-stu-id="45df9-187">(When you do this, the relationship name will change from `FK_Department_Department` to `FK_Department_Person`.)</span></span>

<span data-ttu-id="45df9-188">[![Image82](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-188">[![Image82](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image11.png)</span></span>

<span data-ttu-id="45df9-189">Cliquez sur **OK** dans la zone **tables et colonnes** , cliquez sur **Fermer** dans la zone **relations de clé étrangère** , puis enregistrez les modifications.</span><span class="sxs-lookup"><span data-stu-id="45df9-189">Click **OK** in the **Tables and Columns** box, click **Close** in the **Foreign Key Relationships** box, and save the changes.</span></span> <span data-ttu-id="45df9-190">Si vous êtes invité à enregistrer les `Person` et les tables `Department`, cliquez sur **Oui**.</span><span class="sxs-lookup"><span data-stu-id="45df9-190">If you're asked if you want to save the `Person` and `Department` tables, click **Yes**.</span></span>

> [!NOTE]
> <span data-ttu-id="45df9-191">Si vous avez supprimé `Person` lignes qui correspondent à des données qui se trouvent déjà dans la colonne `Administrator`, vous ne pourrez pas enregistrer cette modification.</span><span class="sxs-lookup"><span data-stu-id="45df9-191">If you've deleted `Person` rows that correspond to data that's already in the `Administrator` column, you will not be able to save this change.</span></span> <span data-ttu-id="45df9-192">Dans ce cas, utilisez l’éditeur de table dans **Explorateur de serveurs** pour vous assurer que la valeur `Administrator` de chaque ligne de `Department` contient l’ID d’un enregistrement qui existe réellement dans la table `Person`.</span><span class="sxs-lookup"><span data-stu-id="45df9-192">In that case, use the table editor in **Server Explorer** to make sure that the `Administrator` value in every `Department` row contains the ID of a record that actually exists in the `Person` table.</span></span>
> 
> <span data-ttu-id="45df9-193">Une fois que vous avez enregistré la modification, vous ne pouvez pas supprimer une ligne de la table `Person` si cette personne est un administrateur de service.</span><span class="sxs-lookup"><span data-stu-id="45df9-193">After you save the change, you will not be able to delete a row from the `Person` table if that person is a department administrator.</span></span> <span data-ttu-id="45df9-194">Dans une application de production, vous devez fournir un message d’erreur spécifique lorsqu’une contrainte de base de données empêche une suppression ou si vous spécifiez une suppression en cascade.</span><span class="sxs-lookup"><span data-stu-id="45df9-194">In a production application, you would provide a specific error message when a database constraint prevents a deletion, or you would specify a cascading delete.</span></span> <span data-ttu-id="45df9-195">Pour obtenir un exemple de la façon de spécifier une suppression en cascade, consultez [les Entity Framework et ASP.net – prise en main Partie 2](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-2.md).</span><span class="sxs-lookup"><span data-stu-id="45df9-195">For an example of how to specify a cascading delete, see [The Entity Framework and ASP.NET – Getting Started Part 2](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-2.md).</span></span>

### <a name="adding-a-view-to-the-database"></a><span data-ttu-id="45df9-196">Ajout d’une vue à la base de données</span><span class="sxs-lookup"><span data-stu-id="45df9-196">Adding a View to the Database</span></span>

<span data-ttu-id="45df9-197">Dans la nouvelle page *Departments. aspx* que vous allez créer, vous souhaitez fournir une liste déroulante d’instructeurs, dont les noms sont au format « Last, First », afin que les utilisateurs puissent sélectionner des administrateurs de service.</span><span class="sxs-lookup"><span data-stu-id="45df9-197">In the new *Departments.aspx* page that you will be creating, you want to provide a drop-down list of instructors, with names in "last, first" format so that users can select department administrators.</span></span> <span data-ttu-id="45df9-198">Pour faciliter cette opération, vous allez créer une vue dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-198">To make it easier to do that, you will create a view in the database.</span></span> <span data-ttu-id="45df9-199">La vue se compose uniquement des données requises par la liste déroulante : le nom complet (correctement mis en forme) et la clé d’enregistrement.</span><span class="sxs-lookup"><span data-stu-id="45df9-199">The view will consist of just the data needed by the drop-down list: the full name (properly formatted) and the record key.</span></span>

<span data-ttu-id="45df9-200">Dans **Explorateur de serveurs**, développez *School. mdf*, cliquez avec le bouton droit sur le dossier **views** , puis sélectionnez **Ajouter une nouvelle vue**.</span><span class="sxs-lookup"><span data-stu-id="45df9-200">In **Server Explorer**, expand *School.mdf*, right-click the **Views** folder, and select **Add New View**.</span></span>

<span data-ttu-id="45df9-201">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-201">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image13.png)</span></span>

<span data-ttu-id="45df9-202">Cliquez sur **Fermer** lorsque la boîte de dialogue **Ajouter une table** s’affiche et collez l’instruction SQL suivante dans le volet SQL :</span><span class="sxs-lookup"><span data-stu-id="45df9-202">Click **Close** when the **Add Table** dialog box appears, and paste the following SQL statement into the SQL pane:</span></span>

[!code-sql[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample1.sql)]

<span data-ttu-id="45df9-203">Enregistrez la vue en tant que `vInstructorName`.</span><span class="sxs-lookup"><span data-stu-id="45df9-203">Save the view as `vInstructorName`.</span></span>

### <a name="updating-the-data-model"></a><span data-ttu-id="45df9-204">Mise à jour du modèle de données</span><span class="sxs-lookup"><span data-stu-id="45df9-204">Updating the Data Model</span></span>

<span data-ttu-id="45df9-205">Dans le dossier *dal* , ouvrez le fichier *SchoolModel. edmx* , cliquez avec le bouton droit sur l’aire de conception, puis sélectionnez **mettre à jour le modèle à partir de la base de données**.</span><span class="sxs-lookup"><span data-stu-id="45df9-205">In the *DAL* folder, open the *SchoolModel.edmx* file, right-click the design surface, and select **Update Model from Database**.</span></span>

<span data-ttu-id="45df9-206">[![Image07](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-206">[![Image07](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image15.png)</span></span>

<span data-ttu-id="45df9-207">Dans la boîte **de dialogue choisir vos objets de base de données** , sélectionnez l’onglet **Ajouter** et sélectionnez la vue que vous venez de créer.</span><span class="sxs-lookup"><span data-stu-id="45df9-207">In the **Choose Your Database Objects** dialog box, select the **Add** tab and select the view you just created.</span></span>

<span data-ttu-id="45df9-208">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-208">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image17.png)</span></span>

<span data-ttu-id="45df9-209">Cliquez sur **Finish**.</span><span class="sxs-lookup"><span data-stu-id="45df9-209">Click **Finish**.</span></span>

<span data-ttu-id="45df9-210">Dans le concepteur, vous voyez que l’outil a créé une entité `vInstructorName` et une nouvelle association entre les entités `Department` et `Person`.</span><span class="sxs-lookup"><span data-stu-id="45df9-210">In the designer, you see that the tool created a `vInstructorName` entity and a new association between the `Department` and `Person` entities.</span></span>

<span data-ttu-id="45df9-211">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-211">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image19.png)</span></span>

> [!NOTE]
> <span data-ttu-id="45df9-212">Dans les fenêtres **sortie** et **liste d’erreurs** , vous pouvez voir un message d’avertissement vous informant que l’outil a créé automatiquement une clé primaire pour la nouvelle vue de `vInstructorName`.</span><span class="sxs-lookup"><span data-stu-id="45df9-212">In the **Output** and **Error List** windows you might see a warning message informing you that the tool automatically created a primary key for the new `vInstructorName` view.</span></span> <span data-ttu-id="45df9-213">Ce comportement est normal.</span><span class="sxs-lookup"><span data-stu-id="45df9-213">This is expected behavior.</span></span>

<span data-ttu-id="45df9-214">Quand vous faites référence à la nouvelle entité `vInstructorName` dans le code, vous ne souhaitez pas utiliser la Convention de base de données de préfixe de « v » en minuscules.</span><span class="sxs-lookup"><span data-stu-id="45df9-214">When you refer to the new `vInstructorName` entity in code, you don't want to use the database convention of prefixing a lower-case "v" to it.</span></span> <span data-ttu-id="45df9-215">Par conséquent, vous allez renommer l’entité et le jeu d’entités dans le modèle.</span><span class="sxs-lookup"><span data-stu-id="45df9-215">Therefore, you will rename the entity and entity set in the model.</span></span>

<span data-ttu-id="45df9-216">Ouvrez l' **Explorateur de modèles**.</span><span class="sxs-lookup"><span data-stu-id="45df9-216">Open the **Model Browser**.</span></span> <span data-ttu-id="45df9-217">Vous voyez `vInstructorName` listé comme un type d’entité et une vue.</span><span class="sxs-lookup"><span data-stu-id="45df9-217">You see `vInstructorName` listed as an entity type and a view.</span></span>

<span data-ttu-id="45df9-218">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-218">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image21.png)</span></span>

<span data-ttu-id="45df9-219">Sous **SchoolModel** (non **SchoolModel. Store**), cliquez avec le bouton droit sur **vInstructorName** et sélectionnez **Propriétés**.</span><span class="sxs-lookup"><span data-stu-id="45df9-219">Under **SchoolModel** (not **SchoolModel.Store**), right-click **vInstructorName** and select **Properties**.</span></span> <span data-ttu-id="45df9-220">Dans la fenêtre **Propriétés** , modifiez la propriété **nom** en « InstructorName » et définissez la propriété nom du **jeu d’entités** sur « InstructorNames ».</span><span class="sxs-lookup"><span data-stu-id="45df9-220">In the **Properties** window, change the **Name** property to "InstructorName" and change the **Entity Set Name** property to "InstructorNames".</span></span>

<span data-ttu-id="45df9-221">[![Image15](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image24.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-221">[![Image15](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image24.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image23.png)</span></span>

<span data-ttu-id="45df9-222">Enregistrez et fermez le modèle de données, puis régénérez le projet.</span><span class="sxs-lookup"><span data-stu-id="45df9-222">Save and close the data model, and then rebuild the project.</span></span>

## <a name="using-a-repository-class-and-an-objectdatasource-control"></a><span data-ttu-id="45df9-223">Utilisation d’une classe de référentiel et d’un contrôle ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="45df9-223">Using a Repository Class and an ObjectDataSource Control</span></span>

<span data-ttu-id="45df9-224">Créez un nouveau fichier de classe dans le dossier *dal* , nommez-le *SchoolRepository.cs*et remplacez le code existant par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="45df9-224">Create a new class file in the *DAL* folder, name it *SchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample2.cs)]

<span data-ttu-id="45df9-225">Ce code fournit une seule méthode `GetDepartments` qui retourne toutes les entités du jeu d’entités `Departments`.</span><span class="sxs-lookup"><span data-stu-id="45df9-225">This code provides a single `GetDepartments` method that returns all of the entities in the `Departments` entity set.</span></span> <span data-ttu-id="45df9-226">Comme vous savez que vous allez accéder à la propriété de navigation `Person` pour chaque ligne retournée, vous spécifiez un chargement hâtif pour cette propriété à l’aide de la méthode `Include`.</span><span class="sxs-lookup"><span data-stu-id="45df9-226">Because you know that you will be accessing the `Person` navigation property for every row returned, you specify eager loading for that property by using the `Include` method.</span></span> <span data-ttu-id="45df9-227">La classe implémente également l’interface `IDisposable` pour garantir la libération de la connexion de base de données lorsque l’objet est supprimé.</span><span class="sxs-lookup"><span data-stu-id="45df9-227">The class also implements the `IDisposable` interface to ensure that the database connection is released when the object is disposed.</span></span>

> [!NOTE]
> <span data-ttu-id="45df9-228">Une pratique courante consiste à créer une classe de référentiel pour chaque type d’entité.</span><span class="sxs-lookup"><span data-stu-id="45df9-228">A common practice is to create a repository class for each entity type.</span></span> <span data-ttu-id="45df9-229">Dans ce didacticiel, vous utilisez une classe de référentiel pour plusieurs types d’entités.</span><span class="sxs-lookup"><span data-stu-id="45df9-229">In this tutorial, one repository class for multiple entity types is used.</span></span> <span data-ttu-id="45df9-230">Pour plus d’informations sur le modèle de référentiel, consultez les publications sur le blog de l' [équipe Entity Framework](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) et le [blog de Julie Lerman](http://thedatafarm.com/blog/data-access/agile-ef4-repository-part-3-fine-tuning-the-repository/).</span><span class="sxs-lookup"><span data-stu-id="45df9-230">For more information about the repository pattern, see the posts in [the Entity Framework team's blog](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) and [Julie Lerman's blog](http://thedatafarm.com/blog/data-access/agile-ef4-repository-part-3-fine-tuning-the-repository/).</span></span>

<span data-ttu-id="45df9-231">La méthode `GetDepartments` retourne un objet `IEnumerable` plutôt qu’un objet `IQueryable` afin de garantir que la collection retournée est utilisable même après la suppression de l’objet de référentiel.</span><span class="sxs-lookup"><span data-stu-id="45df9-231">The `GetDepartments` method returns an `IEnumerable` object rather than an `IQueryable` object in order to ensure that the returned collection is usable even after the repository object itself is disposed.</span></span> <span data-ttu-id="45df9-232">Un objet `IQueryable` peut provoquer l’accès à la base de données à chaque fois qu’il est utilisé, mais l’objet de l’espace de stockage peut être supprimé au moment où un contrôle DataBound tente d’afficher les données.</span><span class="sxs-lookup"><span data-stu-id="45df9-232">An `IQueryable` object can cause database access whenever it's accessed, but the repository object might be disposed by the time a databound control attempts to render the data.</span></span> <span data-ttu-id="45df9-233">Vous pouvez retourner un autre type de collection, tel qu’un objet `IList` au lieu d’un objet `IEnumerable`.</span><span class="sxs-lookup"><span data-stu-id="45df9-233">You could return another collection type, such as an `IList` object instead of an `IEnumerable` object.</span></span> <span data-ttu-id="45df9-234">Toutefois, le retour d’un objet `IEnumerable` garantit que vous pouvez effectuer des tâches de traitement de liste en lecture seule typiques, telles que des boucles `foreach` et des requêtes LINQ, mais vous ne pouvez pas ajouter ou supprimer des éléments dans la collection, ce qui peut impliquer que ces modifications sont conservées dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-234">However, returning an `IEnumerable` object ensures that you can perform typical read-only list processing tasks such as `foreach` loops and LINQ queries, but you cannot add to or remove items in the collection, which might imply that such changes would be persisted to the database.</span></span>

<span data-ttu-id="45df9-235">Créez une page *Departments. aspx* qui utilise la page maître *site. Master* , puis ajoutez le balisage suivant dans le contrôle `Content` nommé `Content2`:</span><span class="sxs-lookup"><span data-stu-id="45df9-235">Create a *Departments.aspx* page that uses the *Site.Master* master page, and add the following markup in the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample3.aspx)]

<span data-ttu-id="45df9-236">Ce balisage crée un contrôle `ObjectDataSource` qui utilise la classe de référentiel que vous venez de créer, et un contrôle `GridView` pour afficher les données.</span><span class="sxs-lookup"><span data-stu-id="45df9-236">This markup creates an `ObjectDataSource` control that uses the repository class you just created, and a `GridView` control to display the data.</span></span> <span data-ttu-id="45df9-237">Le contrôle `GridView` spécifie des commandes **modifier** et **supprimer** , mais vous n’avez pas encore ajouté de code pour les prendre en charge.</span><span class="sxs-lookup"><span data-stu-id="45df9-237">The `GridView` control specifies **Edit** and **Delete** commands, but you haven't added code to support them yet.</span></span>

<span data-ttu-id="45df9-238">Plusieurs colonnes utilisent des contrôles `DynamicField` afin que vous puissiez tirer parti de la fonctionnalité de validation et de mise en forme automatique des données.</span><span class="sxs-lookup"><span data-stu-id="45df9-238">Several columns use `DynamicField` controls so that you can take advantage of automatic data formatting and validation functionality.</span></span> <span data-ttu-id="45df9-239">Pour que cela fonctionne, vous devez appeler la méthode `EnableDynamicData` dans le gestionnaire d’événements `Page_Init`.</span><span class="sxs-lookup"><span data-stu-id="45df9-239">For these to work, you will have to call the `EnableDynamicData` method in the `Page_Init` event handler.</span></span> <span data-ttu-id="45df9-240">(les contrôles`DynamicControl` ne sont pas utilisés dans le champ `Administrator`, car ils ne fonctionnent pas avec les propriétés de navigation.)</span><span class="sxs-lookup"><span data-stu-id="45df9-240">(`DynamicControl` controls are not used in the `Administrator` field because they don't work with navigation properties.)</span></span>

<span data-ttu-id="45df9-241">Les attributs `Vertical-Align="Top"` deviennent importants ultérieurement lorsque vous ajoutez une colonne qui a un contrôle `GridView` imbriqué à la grille.</span><span class="sxs-lookup"><span data-stu-id="45df9-241">The `Vertical-Align="Top"` attributes will become important later when you add a column that has a nested `GridView` control to the grid.</span></span>

<span data-ttu-id="45df9-242">Ouvrez le fichier *Departments.aspx.cs* et ajoutez l’instruction `using` suivante :</span><span class="sxs-lookup"><span data-stu-id="45df9-242">Open the *Departments.aspx.cs* file and add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample4.cs)]

<span data-ttu-id="45df9-243">Ajoutez ensuite le gestionnaire suivant pour l’événement `Init` de la page :</span><span class="sxs-lookup"><span data-stu-id="45df9-243">Then add the following handler for the page's `Init` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample5.cs)]

<span data-ttu-id="45df9-244">Dans le dossier *dal* , créez un fichier de classe nommé *Department.cs* et remplacez le code existant par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="45df9-244">In the *DAL* folder, create a new class file named *Department.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample6.cs)]

<span data-ttu-id="45df9-245">Ce code ajoute des métadonnées au modèle de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-245">This code adds metadata to the data model.</span></span> <span data-ttu-id="45df9-246">Il spécifie que la propriété `Budget` de l’entité `Department` représente en réalité la devise, bien que son type de données soit `Decimal`et qu’elle spécifie que la valeur doit être comprise entre 0 et $1 000 000,00.</span><span class="sxs-lookup"><span data-stu-id="45df9-246">It specifies that the `Budget` property of the `Department` entity actually represents currency although its data type is `Decimal`, and it specifies that the value must be between 0 and $1,000,000.00.</span></span> <span data-ttu-id="45df9-247">Il spécifie également que la propriété `StartDate` doit être mise en forme en tant que date au format mm/jj/aaaa.</span><span class="sxs-lookup"><span data-stu-id="45df9-247">It also specifies that the `StartDate` property should be formatted as a date in the format mm/dd/yyyy.</span></span>

<span data-ttu-id="45df9-248">Exécutez la page *Departments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="45df9-248">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="45df9-249">[![image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image26.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-249">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image26.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image25.png)</span></span>

<span data-ttu-id="45df9-250">Notez que même si vous n’avez pas spécifié de chaîne de format dans le balisage de page *Departments. aspx* pour les colonnes de **Date de début** ou de **budget** , la devise par défaut et la mise en forme des dates ont été appliquées par les contrôles `DynamicField`, à l’aide des métadonnées que vous avez fournies dans le fichier *Department.cs* .</span><span class="sxs-lookup"><span data-stu-id="45df9-250">Notice that although you did not specify a format string in the *Departments.aspx* page markup for the **Budget** or **Start Date** columns, default currency and date formatting has been applied to them by the `DynamicField` controls, using the metadata that you supplied in the *Department.cs* file.</span></span>

## <a name="adding-insert-and-delete-functionality"></a><span data-ttu-id="45df9-251">Ajout de la fonctionnalité d’insertion et de suppression</span><span class="sxs-lookup"><span data-stu-id="45df9-251">Adding Insert and Delete Functionality</span></span>

<span data-ttu-id="45df9-252">Ouvrez *SchoolRepository.cs*, ajoutez le code suivant afin de créer une méthode `Insert` et une méthode `Delete`.</span><span class="sxs-lookup"><span data-stu-id="45df9-252">Open *SchoolRepository.cs*, add the following code in order to create an `Insert` method and a `Delete` method.</span></span> <span data-ttu-id="45df9-253">Le code comprend également une méthode nommée `GenerateDepartmentID` qui calcule la valeur de clé d’enregistrement disponible suivante pour une utilisation par la méthode `Insert`.</span><span class="sxs-lookup"><span data-stu-id="45df9-253">The code also includes a method named `GenerateDepartmentID` that calculates the next available record key value for use by the `Insert` method.</span></span> <span data-ttu-id="45df9-254">Cela est nécessaire, car la base de données n’est pas configurée pour calculer cette valeur automatiquement pour la table `Department`.</span><span class="sxs-lookup"><span data-stu-id="45df9-254">This is required because the database is not configured to calculate this automatically for the `Department` table.</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample7.cs)]

### <a name="the-attach-method"></a><span data-ttu-id="45df9-255">Méthode Attach</span><span class="sxs-lookup"><span data-stu-id="45df9-255">The Attach Method</span></span>

<span data-ttu-id="45df9-256">La méthode `DeleteDepartment` appelle la méthode `Attach` afin de rétablir le lien maintenu dans le gestionnaire d’état d’objet du contexte de l’objet entre l’entité en mémoire et la ligne de base de données qu’elle représente.</span><span class="sxs-lookup"><span data-stu-id="45df9-256">The `DeleteDepartment` method calls the `Attach` method in order to re-establish the link that's maintained in the object context's object state manager between the entity in memory and the database row it represents.</span></span> <span data-ttu-id="45df9-257">Cela doit se produire avant que la méthode appelle la méthode `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="45df9-257">This must occur before the method calls the `SaveChanges` method.</span></span>

<span data-ttu-id="45df9-258">Le terme *contexte* de l’objet fait référence à la classe Entity Framework qui dérive de la classe `ObjectContext` que vous utilisez pour accéder à vos jeux d’entités et entités.</span><span class="sxs-lookup"><span data-stu-id="45df9-258">The term *object context* refers to the Entity Framework class that derives from the `ObjectContext` class that you use to access your entity sets and entities.</span></span> <span data-ttu-id="45df9-259">Dans le code de ce projet, la classe est nommée `SchoolEntities`et une instance de celle-ci est toujours nommée `context`.</span><span class="sxs-lookup"><span data-stu-id="45df9-259">In the code for this project, the class is named `SchoolEntities`, and an instance of it is always named `context`.</span></span> <span data-ttu-id="45df9-260">Le *Gestionnaire d’état d’objet* du contexte de l’objet est une classe qui dérive de la classe `ObjectStateManager`.</span><span class="sxs-lookup"><span data-stu-id="45df9-260">The object context's *object state manager* is a class that derives from the `ObjectStateManager` class.</span></span> <span data-ttu-id="45df9-261">Le contact de l’objet utilise le gestionnaire d’état d’objet pour stocker les objets d’entité et effectuer le suivi de la synchronisation de chacun d’entre eux avec la ou les lignes de table correspondantes dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-261">The object contact uses the object state manager to store entity objects and to keep track of whether each one is in sync with its corresponding table row or rows in the database.</span></span>

<span data-ttu-id="45df9-262">Lorsque vous lisez une entité, le contexte de l’objet la stocke dans le gestionnaire d’état d’objet et assure le suivi de la synchronisation de cette représentation de l’objet avec la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-262">When you read an entity, the object context stores it in the object state manager and keeps track of whether that representation of the object is in sync with the database.</span></span> <span data-ttu-id="45df9-263">Par exemple, si vous modifiez une valeur de propriété, un indicateur est défini pour indiquer que la propriété que vous avez modifiée n’est plus synchronisée avec la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-263">For example, if you change a property value, a flag is set to indicate that the property you changed is no longer in sync with the database.</span></span> <span data-ttu-id="45df9-264">Ensuite, lorsque vous appelez la méthode `SaveChanges`, le contexte de l’objet sait quoi faire dans la base de données, car le gestionnaire d’état d’objet sait exactement ce qui est différent de l’état actuel de l’entité et de l’état de la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-264">Then when you call the `SaveChanges` method, the object context knows what to do in the database because the object state manager knows exactly what's different between the current state of the entity and the state of the database.</span></span>

<span data-ttu-id="45df9-265">Toutefois, ce processus ne fonctionne généralement pas dans une application Web, car l’instance de contexte de l’objet qui lit une entité, ainsi que tout ce qui se trouve dans son gestionnaire d’état d’objet, est supprimée après le rendu d’une page.</span><span class="sxs-lookup"><span data-stu-id="45df9-265">However, this process typically does not work in a web application, because the object context instance that reads an entity, along with everything in its object state manager, is disposed after a page is rendered.</span></span> <span data-ttu-id="45df9-266">L’instance de contexte de l’objet qui doit appliquer les modifications est une nouvelle instance qui est instanciée pour le traitement de la publication (postback).</span><span class="sxs-lookup"><span data-stu-id="45df9-266">The object context instance that must apply changes is a new one that's instantiated for postback processing.</span></span> <span data-ttu-id="45df9-267">Dans le cas de la méthode `DeleteDepartment`, le `ObjectDataSource` contrôle recrée la version d’origine de l’entité pour vous à partir de valeurs dans l’état d’affichage, mais cette entité `Department` recréée n’existe pas dans le gestionnaire d’état d’objet.</span><span class="sxs-lookup"><span data-stu-id="45df9-267">In the case of the `DeleteDepartment` method, the `ObjectDataSource` control re-creates the original version of the entity for you from values in view state, but this re-created `Department` entity does not exist in the object state manager.</span></span> <span data-ttu-id="45df9-268">Si vous avez appelé la méthode `DeleteObject` sur cette entité recréée, l’appel échoue parce que le contexte de l’objet ne sait pas si l’entité est synchronisée avec la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-268">If you called the `DeleteObject` method on this re-created entity, the call would fail because the object context does not know whether the entity is in sync with the database.</span></span> <span data-ttu-id="45df9-269">Toutefois, l’appel de la méthode `Attach` rétablit le même suivi entre l’entité recréée et les valeurs de la base de données qui a été initialement effectuée automatiquement lors de la lecture de l’entité dans une instance antérieure du contexte de l’objet.</span><span class="sxs-lookup"><span data-stu-id="45df9-269">However, calling the `Attach` method re-establishes the same tracking between the re-created entity and the values in the database that was originally done automatically when the entity was read in an earlier instance of the object context.</span></span>

<span data-ttu-id="45df9-270">Il peut arriver que vous ne souhaitiez pas que le contexte de l’objet effectue le suivi des entités dans le gestionnaire d’état d’objet, et vous pouvez définir des indicateurs pour empêcher l’exécution de ce dernier.</span><span class="sxs-lookup"><span data-stu-id="45df9-270">There are times when you don't want the object context to track entities in the object state manager, and you can set flags to prevent it from doing that.</span></span> <span data-ttu-id="45df9-271">Des exemples sont présentés dans les didacticiels ultérieurs de cette série.</span><span class="sxs-lookup"><span data-stu-id="45df9-271">Examples of this are shown in later tutorials in this series.</span></span>

### <a name="the-savechanges-method"></a><span data-ttu-id="45df9-272">Méthode SaveChanges</span><span class="sxs-lookup"><span data-stu-id="45df9-272">The SaveChanges Method</span></span>

<span data-ttu-id="45df9-273">Cette classe de référentiel simple illustre les principes de base de l’exécution d’opérations CRUD.</span><span class="sxs-lookup"><span data-stu-id="45df9-273">This simple repository class illustrates basic principles of how to perform CRUD operations.</span></span> <span data-ttu-id="45df9-274">Dans cet exemple, la méthode `SaveChanges` est appelée immédiatement après chaque mise à jour.</span><span class="sxs-lookup"><span data-stu-id="45df9-274">In this example, the `SaveChanges` method is called immediately after each update.</span></span> <span data-ttu-id="45df9-275">Dans une application de production, vous souhaiterez peut-être appeler la méthode `SaveChanges` à partir d’une méthode distincte pour mieux contrôler le moment où la base de données est mise à jour.</span><span class="sxs-lookup"><span data-stu-id="45df9-275">In a production application you might want to call the `SaveChanges` method from a separate method to give you more control over when the database is updated.</span></span> <span data-ttu-id="45df9-276">(À la fin du didacticiel suivant, vous trouverez un lien vers un livre blanc qui aborde le modèle d’unité de travail qui constitue une approche pour coordonner les mises à jour associées.) Notez également que dans l’exemple, la méthode `DeleteDepartment` n’inclut pas de code pour gérer les conflits d’accès concurrentiel. le code à cette fin sera ajouté dans un didacticiel ultérieur de cette série.</span><span class="sxs-lookup"><span data-stu-id="45df9-276">(At the end of the next tutorial you will find a link to a white paper that discusses the unit of work pattern which is one approach to coordinating related updates.) Notice also that in the example, the `DeleteDepartment` method does not include code for handling concurrency conflicts; code to do that will be added in a later tutorial in this series.</span></span>

### <a name="retrieving-instructor-names-to-select-when-inserting"></a><span data-ttu-id="45df9-277">Récupération des noms de formateur à sélectionner lors de l’insertion</span><span class="sxs-lookup"><span data-stu-id="45df9-277">Retrieving Instructor Names to Select When Inserting</span></span>

<span data-ttu-id="45df9-278">Les utilisateurs doivent être en mesure de sélectionner un administrateur dans une liste déroulante lors de la création de nouveaux services.</span><span class="sxs-lookup"><span data-stu-id="45df9-278">Users must be able to select an administrator from a list of instructors in a drop-down list when creating new departments.</span></span> <span data-ttu-id="45df9-279">Par conséquent, ajoutez le code suivant à *SchoolRepository.cs* pour créer une méthode permettant de récupérer la liste des instructeurs à l’aide de la vue que vous avez créée précédemment :</span><span class="sxs-lookup"><span data-stu-id="45df9-279">Therefore, add the following code to *SchoolRepository.cs* to create a method to retrieve the list of instructors using the view that you created earlier:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample8.cs)]

### <a name="creating-a-page-for-inserting-departments"></a><span data-ttu-id="45df9-280">Création d’une page pour l’insertion de services</span><span class="sxs-lookup"><span data-stu-id="45df9-280">Creating a Page for Inserting Departments</span></span>

<span data-ttu-id="45df9-281">Créez une page *DepartmentsAdd. aspx* qui utilise la page *site. Master* , puis ajoutez le balisage suivant dans le contrôle `Content` nommé `Content2`:</span><span class="sxs-lookup"><span data-stu-id="45df9-281">Create a *DepartmentsAdd.aspx* page that uses the *Site.Master* page, and add the following markup in the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample9.aspx)]

<span data-ttu-id="45df9-282">Ce balisage crée deux contrôles `ObjectDataSource`, un pour insérer de nouvelles entités `Department` et une pour récupérer les noms des enseignants pour le contrôle `DropDownList` utilisé pour la sélection des administrateurs de service.</span><span class="sxs-lookup"><span data-stu-id="45df9-282">This markup creates two `ObjectDataSource` controls, one for inserting new `Department` entities and one for retrieving instructor names for the `DropDownList` control that's used for selecting department administrators.</span></span> <span data-ttu-id="45df9-283">Le balisage crée un contrôle de `DetailsView` pour l’entrée de nouveaux services, et spécifie un gestionnaire pour l’événement `ItemInserting` du contrôle afin que vous puissiez définir la valeur de clé étrangère `Administrator`.</span><span class="sxs-lookup"><span data-stu-id="45df9-283">The markup creates a `DetailsView` control for entering new departments, and it specifies a handler for the control's `ItemInserting` event so that you can set the `Administrator` foreign key value.</span></span> <span data-ttu-id="45df9-284">À la fin, est un contrôle de `ValidationSummary` pour afficher les messages d’erreur.</span><span class="sxs-lookup"><span data-stu-id="45df9-284">At the end is a `ValidationSummary` control to display error messages.</span></span>

<span data-ttu-id="45df9-285">Ouvrez *DepartmentsAdd.aspx.cs* et ajoutez l’instruction `using` suivante :</span><span class="sxs-lookup"><span data-stu-id="45df9-285">Open *DepartmentsAdd.aspx.cs* and add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample10.cs)]

<span data-ttu-id="45df9-286">Ajoutez la variable de classe et les méthodes suivantes :</span><span class="sxs-lookup"><span data-stu-id="45df9-286">Add the following class variable and methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample11.cs)]

<span data-ttu-id="45df9-287">La méthode `Page_Init` active les fonctionnalités Dynamic Data.</span><span class="sxs-lookup"><span data-stu-id="45df9-287">The `Page_Init` method enables Dynamic Data functionality.</span></span> <span data-ttu-id="45df9-288">Le gestionnaire de l’événement `Init` du contrôle `DropDownList` enregistre une référence au contrôle, et le gestionnaire de l’événement `Inserting` du contrôle `DetailsView` utilise cette référence pour obtenir la valeur `PersonID` de l’instructeur sélectionné et mettre à jour la propriété de clé étrangère `Administrator` de l’entité `Department`.</span><span class="sxs-lookup"><span data-stu-id="45df9-288">The handler for the `DropDownList` control's `Init` event saves a reference to the control, and the handler for the `DetailsView` control's `Inserting` event uses that reference to get the `PersonID` value of the selected instructor and update the `Administrator` foreign key property of the `Department` entity.</span></span>

<span data-ttu-id="45df9-289">Exécutez la page, ajoutez des informations pour un nouveau service, puis cliquez sur le lien **Insérer** .</span><span class="sxs-lookup"><span data-stu-id="45df9-289">Run the page, add information for a new department, and then click the **Insert** link.</span></span>

<span data-ttu-id="45df9-290">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image28.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-290">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image28.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image27.png)</span></span>

<span data-ttu-id="45df9-291">Entrez les valeurs d’un autre nouveau service.</span><span class="sxs-lookup"><span data-stu-id="45df9-291">Enter values for another new department.</span></span> <span data-ttu-id="45df9-292">Entrez un nombre supérieur à 1 000 000,00 dans le champ **budget** et l’onglet suivant.</span><span class="sxs-lookup"><span data-stu-id="45df9-292">Enter a number greater than 1,000,000.00 in the **Budget** field and tab to the next field.</span></span> <span data-ttu-id="45df9-293">Un astérisque apparaît dans le champ et, si vous maintenez le pointeur de la souris sur celui-ci, vous pouvez voir le message d’erreur que vous avez entré dans les métadonnées de ce champ.</span><span class="sxs-lookup"><span data-stu-id="45df9-293">An asterisk appears in the field, and if you hold the mouse pointer over it, you can see the error message that you entered in the metadata for that field.</span></span>

<span data-ttu-id="45df9-294">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image30.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-294">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image30.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image29.png)</span></span>

<span data-ttu-id="45df9-295">Cliquez sur **Insérer**pour afficher le message d’erreur affiché par le contrôle `ValidationSummary` au bas de la page.</span><span class="sxs-lookup"><span data-stu-id="45df9-295">Click **Insert**, and you see the error message displayed by the `ValidationSummary` control at the bottom of the page.</span></span>

<span data-ttu-id="45df9-296">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image32.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-296">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image32.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image31.png)</span></span>

<span data-ttu-id="45df9-297">Fermez ensuite le navigateur et ouvrez la page *Departments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="45df9-297">Next, close the browser and open the *Departments.aspx* page.</span></span> <span data-ttu-id="45df9-298">Ajoutez la fonctionnalité de suppression à la page *Departments. aspx* en ajoutant un attribut `DeleteMethod` au contrôle `ObjectDataSource` et un attribut `DataKeyNames` au contrôle `GridView`.</span><span class="sxs-lookup"><span data-stu-id="45df9-298">Add delete capability to the *Departments.aspx* page by adding a `DeleteMethod` attribute to the `ObjectDataSource` control, and a `DataKeyNames` attribute to the `GridView` control.</span></span> <span data-ttu-id="45df9-299">Les balises d’ouverture de ces contrôles ressemblent maintenant à l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="45df9-299">The opening tags for these controls will now resemble the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample12.aspx)]

<span data-ttu-id="45df9-300">Exécutez la page.</span><span class="sxs-lookup"><span data-stu-id="45df9-300">Run the page.</span></span>

<span data-ttu-id="45df9-301">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image34.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-301">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image34.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image33.png)</span></span>

<span data-ttu-id="45df9-302">Supprimez le service que vous avez ajouté lors de l’exécution de la page *DepartmentsAdd. aspx* .</span><span class="sxs-lookup"><span data-stu-id="45df9-302">Delete the department you added when you ran the *DepartmentsAdd.aspx* page.</span></span>

## <a name="adding-update-functionality"></a><span data-ttu-id="45df9-303">Ajout de la fonctionnalité de mise à jour</span><span class="sxs-lookup"><span data-stu-id="45df9-303">Adding Update Functionality</span></span>

<span data-ttu-id="45df9-304">Ouvrez *SchoolRepository.cs* et ajoutez la méthode `Update` suivante :</span><span class="sxs-lookup"><span data-stu-id="45df9-304">Open *SchoolRepository.cs* and add the following `Update` method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample13.cs)]

<span data-ttu-id="45df9-305">Quand vous cliquez sur **mettre à jour** dans la page *services. aspx* , le contrôle `ObjectDataSource` crée deux entités `Department` à passer à la méthode `UpdateDepartment`.</span><span class="sxs-lookup"><span data-stu-id="45df9-305">When you click **Update** in the *Departments.aspx* page, the `ObjectDataSource` control creates two `Department` entities to pass to the `UpdateDepartment` method.</span></span> <span data-ttu-id="45df9-306">L’un contient les valeurs d’origine qui ont été stockées dans l’état d’affichage, tandis que l’autre contient les nouvelles valeurs qui ont été entrées dans le contrôle `GridView`.</span><span class="sxs-lookup"><span data-stu-id="45df9-306">One contains the original values that have been stored in view state, and the other contains the new values that were entered in the `GridView` control.</span></span> <span data-ttu-id="45df9-307">Le code de la méthode `UpdateDepartment` passe l’entité `Department` qui contient les valeurs d’origine à la méthode `Attach` afin d’établir le suivi entre l’entité et ce qui se trouve dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-307">The code in the `UpdateDepartment` method passes the `Department` entity that has the original values to the `Attach` method in order to establish the tracking between the entity and what's in the database.</span></span> <span data-ttu-id="45df9-308">Ensuite, le code passe l’entité `Department` qui a les nouvelles valeurs à la méthode `ApplyCurrentValues`.</span><span class="sxs-lookup"><span data-stu-id="45df9-308">Then the code passes the `Department` entity that has the new values to the `ApplyCurrentValues` method.</span></span> <span data-ttu-id="45df9-309">Le contexte de l’objet compare les valeurs anciennes et nouvelles.</span><span class="sxs-lookup"><span data-stu-id="45df9-309">The object context compares the old and new values.</span></span> <span data-ttu-id="45df9-310">Si une nouvelle valeur est différente d’une ancienne valeur, le contexte de l’objet modifie la valeur de la propriété.</span><span class="sxs-lookup"><span data-stu-id="45df9-310">If a new value is different from an old value, the object context changes the property value.</span></span> <span data-ttu-id="45df9-311">La méthode `SaveChanges` met alors à jour uniquement les colonnes modifiées dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="45df9-311">The `SaveChanges` method then updates only the changed columns in the database.</span></span> <span data-ttu-id="45df9-312">(Toutefois, si la fonction de mise à jour de cette entité a été mappée à une procédure stockée, la ligne entière serait mise à jour indépendamment des colonnes qui ont été modifiées.)</span><span class="sxs-lookup"><span data-stu-id="45df9-312">(However, if the update function for this entity were mapped to a stored procedure, the entire row would be updated regardless of which columns were changed.)</span></span>

<span data-ttu-id="45df9-313">Ouvrez le fichier *Departments. aspx* et ajoutez les attributs suivants au contrôle `DepartmentsObjectDataSource` :</span><span class="sxs-lookup"><span data-stu-id="45df9-313">Open the *Departments.aspx* file and add the following attributes to the `DepartmentsObjectDataSource` control:</span></span>

- `UpdateMethod="UpdateDepartment"`
- `ConflictDetection="CompareAllValues"`   
 <span data-ttu-id="45df9-314">Cela entraîne le stockage des anciennes valeurs dans l’état d’affichage afin qu’elles puissent être comparées aux nouvelles valeurs de la méthode `Update`.</span><span class="sxs-lookup"><span data-stu-id="45df9-314">This causes old values to be stored in view state so that they can be compared with the new values in the `Update` method.</span></span>
- `OldValuesParameterFormatString="orig{0}"`   
 <span data-ttu-id="45df9-315">Cela indique au contrôle que le nom du paramètre de valeurs d’origine est `origDepartment`.</span><span class="sxs-lookup"><span data-stu-id="45df9-315">This informs the control that the name of the original values parameter is `origDepartment` .</span></span>

<span data-ttu-id="45df9-316">Le balisage de la balise d’ouverture du contrôle `ObjectDataSource` ressemble maintenant à l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="45df9-316">The markup for the opening tag of the `ObjectDataSource` control now resembles the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample14.aspx)]

<span data-ttu-id="45df9-317">Ajoutez un attribut `OnRowUpdating="DepartmentsGridView_RowUpdating"` au contrôle `GridView`.</span><span class="sxs-lookup"><span data-stu-id="45df9-317">Add an `OnRowUpdating="DepartmentsGridView_RowUpdating"` attribute to the `GridView` control.</span></span> <span data-ttu-id="45df9-318">Vous allez l’utiliser pour définir la valeur de la propriété `Administrator` en fonction de la ligne sélectionnée par l’utilisateur dans une liste déroulante.</span><span class="sxs-lookup"><span data-stu-id="45df9-318">You will use this to set the `Administrator` property value based on the row the user selects in a drop-down list.</span></span> <span data-ttu-id="45df9-319">La balise d’ouverture `GridView` ressemble maintenant à l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="45df9-319">The `GridView` opening tag now resembles the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample15.aspx)]

<span data-ttu-id="45df9-320">Ajoutez un contrôle `EditItemTemplate` pour la colonne `Administrator` au contrôle `GridView`, immédiatement après le contrôle `ItemTemplate` pour cette colonne :</span><span class="sxs-lookup"><span data-stu-id="45df9-320">Add an `EditItemTemplate` control for the `Administrator` column to the `GridView` control, immediately after the `ItemTemplate` control for that column:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample16.aspx)]

<span data-ttu-id="45df9-321">Ce contrôle de `EditItemTemplate` est similaire au contrôle `InsertItemTemplate` dans la page *DepartmentsAdd. aspx* .</span><span class="sxs-lookup"><span data-stu-id="45df9-321">This `EditItemTemplate` control is similar to the `InsertItemTemplate` control in the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="45df9-322">La différence réside dans le fait que la valeur initiale du contrôle est définie à l’aide de l’attribut `SelectedValue`.</span><span class="sxs-lookup"><span data-stu-id="45df9-322">The difference is that the initial value of the control is set using the `SelectedValue` attribute.</span></span>

<span data-ttu-id="45df9-323">Avant le contrôle `GridView`, ajoutez un contrôle `ValidationSummary` comme vous l’avez fait dans la page *DepartmentsAdd. aspx* .</span><span class="sxs-lookup"><span data-stu-id="45df9-323">Before the `GridView` control, add a `ValidationSummary` control as you did in the *DepartmentsAdd.aspx* page.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample17.aspx)]

<span data-ttu-id="45df9-324">Ouvrez *Departments.aspx.cs* et immédiatement après la déclaration de classe partielle, ajoutez le code suivant pour créer un champ privé afin de référencer le contrôle `DropDownList` :</span><span class="sxs-lookup"><span data-stu-id="45df9-324">Open *Departments.aspx.cs* and immediately after the partial-class declaration, add the following code to create a private field to reference the `DropDownList` control:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample18.cs)]

<span data-ttu-id="45df9-325">Ajoutez ensuite des gestionnaires pour l’événement `Init` du contrôle `DropDownList` et l’événement `RowUpdating` du contrôle `GridView` :</span><span class="sxs-lookup"><span data-stu-id="45df9-325">Then add handlers for the `DropDownList` control's `Init` event and the `GridView` control's `RowUpdating` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample19.cs)]

<span data-ttu-id="45df9-326">Le gestionnaire de l’événement `Init` enregistre une référence au contrôle `DropDownList` dans le champ de classe.</span><span class="sxs-lookup"><span data-stu-id="45df9-326">The handler for the `Init` event saves a reference to the `DropDownList` control in the class field.</span></span> <span data-ttu-id="45df9-327">Le gestionnaire de l’événement `RowUpdating` utilise la référence pour obtenir la valeur entrée par l’utilisateur et l’appliquer à la propriété `Administrator` de l’entité `Department`.</span><span class="sxs-lookup"><span data-stu-id="45df9-327">The handler for the `RowUpdating` event uses the reference to get the value the user entered and apply it to the `Administrator` property of the `Department` entity.</span></span>

<span data-ttu-id="45df9-328">Utilisez la page *DepartmentsAdd. aspx* pour ajouter un nouveau service, puis exécutez la page *Departments. aspx* , puis cliquez sur **modifier** sur la ligne que vous avez ajoutée.</span><span class="sxs-lookup"><span data-stu-id="45df9-328">Use the *DepartmentsAdd.aspx* page to add a new department, then run the *Departments.aspx* page and click **Edit** on the row that you added.</span></span>

> [!NOTE]
> <span data-ttu-id="45df9-329">Vous ne pouvez pas modifier les lignes que vous n’avez pas ajoutées (c’est-à-dire qui se trouvent déjà dans la base de données) en raison de données non valides dans la base de données ; les administrateurs des lignes créées avec la base de données sont les élèves.</span><span class="sxs-lookup"><span data-stu-id="45df9-329">You will not be able to edit rows that you did not add (that is, that were already in the database), because of invalid data in the database; the administrators for the rows that were created with the database are students.</span></span> <span data-ttu-id="45df9-330">Si vous essayez de modifier l’une d’entre elles, vous obtiendrez une page d’erreur qui signale une erreur telle que `'InstructorsDropDownList' has a SelectedValue which is invalid because it does not exist in the list of items.`</span><span class="sxs-lookup"><span data-stu-id="45df9-330">If you try to edit one of them, you will get an error page that reports an error like `'InstructorsDropDownList' has a SelectedValue which is invalid because it does not exist in the list of items.`</span></span>

<span data-ttu-id="45df9-331">[![Image10](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image36.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-331">[![Image10](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image36.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image35.png)</span></span>

<span data-ttu-id="45df9-332">Si vous entrez un montant de **budget** non valide, puis cliquez sur **mettre à jour**, vous voyez le même astérisque et le même message d’erreur que ceux que vous avez vus dans la page *Departments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="45df9-332">If you enter an invalid **Budget** amount and then click **Update**, you see the same asterisk and error message that you saw in the *Departments.aspx* page.</span></span>

<span data-ttu-id="45df9-333">Modifiez une valeur de champ ou sélectionnez un autre administrateur, puis cliquez sur **mettre à jour**.</span><span class="sxs-lookup"><span data-stu-id="45df9-333">Change a field value or select a different administrator and click **Update**.</span></span> <span data-ttu-id="45df9-334">La modification s’affiche.</span><span class="sxs-lookup"><span data-stu-id="45df9-334">The change is displayed.</span></span>

<span data-ttu-id="45df9-335">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image38.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="45df9-335">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image38.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image37.png)</span></span>

<span data-ttu-id="45df9-336">Cela termine la présentation de l’utilisation du contrôle `ObjectDataSource` pour les opérations CRUD (création, lecture, mise à jour, suppression) de base avec le Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="45df9-336">This completes the introduction to using the `ObjectDataSource` control for basic CRUD (create, read, update, delete) operations with the Entity Framework.</span></span> <span data-ttu-id="45df9-337">Vous avez créé une application multiniveau simple, mais la couche logique métier est toujours étroitement couplée à la couche d’accès aux données, ce qui complique les tests unitaires automatisés.</span><span class="sxs-lookup"><span data-stu-id="45df9-337">You've built a simple n-tier application, but the business-logic layer is still tightly coupled to the data-access layer, which complicates automated unit testing.</span></span> <span data-ttu-id="45df9-338">Dans le didacticiel suivant, vous allez apprendre à implémenter le modèle de référentiel pour faciliter les tests unitaires.</span><span class="sxs-lookup"><span data-stu-id="45df9-338">In the following tutorial you'll see how to implement the repository pattern to facilitate unit testing.</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="45df9-339">Next</span><span class="sxs-lookup"><span data-stu-id="45df9-339">Next</span></span>](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests.md)
