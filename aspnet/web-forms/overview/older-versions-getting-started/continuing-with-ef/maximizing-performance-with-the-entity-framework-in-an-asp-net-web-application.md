---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application
title: Optimisation des performances avec la Entity Framework 4,0 dans une application Web ASP.NET 4 | Microsoft Docs
author: tdykstra
description: Cette série de didacticiels s’appuie sur l’application Web Contoso University qui est créée par le Prise en main avec la série de didacticiels Entity Framework 4,0. ...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: 4e43455e-dfa1-42db-83cb-c987703f04b5
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 5630200a1ad1d30f6d89b38e15179f15b699fa9f
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78545961"
---
# <a name="maximizing-performance-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="ad4eb-104">Optimisation des performances avec la Entity Framework 4,0 dans une application Web ASP.NET 4</span><span class="sxs-lookup"><span data-stu-id="ad4eb-104">Maximizing Performance with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="ad4eb-105">par [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="ad4eb-106">Cette série de didacticiels s’appuie sur l’application Web Contoso University qui est créée par le [prise en main avec la](https://asp.net/entity-framework/tutorials#Getting%20Started) série de didacticiels Entity Framework 4,0.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="ad4eb-107">Si vous n’avez pas terminé les didacticiels précédents, comme point de départ pour ce didacticiel, vous pouvez [Télécharger l’application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) que vous auriez créée.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="ad4eb-108">Vous pouvez également [Télécharger l’application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) qui est créée par la série de didacticiels complète.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="ad4eb-109">Si vous avez des questions sur les didacticiels, vous pouvez les poster sur le [Forum de Entity Framework ASP.net](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="ad4eb-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="ad4eb-110">Dans le didacticiel précédent, vous avez vu comment gérer les conflits d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-110">In the previous tutorial, you saw how to handle concurrency conflicts.</span></span> <span data-ttu-id="ad4eb-111">Ce didacticiel présente les options permettant d’améliorer les performances d’une application Web ASP.NET qui utilise l’Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-111">This tutorial shows options for improving the performance of an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="ad4eb-112">Vous apprendrez plusieurs méthodes pour optimiser les performances ou pour diagnostiquer les problèmes de performances.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-112">You'll learn several methods for maximizing performance or for diagnosing performance problems.</span></span>

<span data-ttu-id="ad4eb-113">Les informations présentées dans les sections suivantes sont susceptibles d’être utiles dans un large éventail de scénarios :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-113">Information presented in the following sections is likely to be useful in a broad variety of scenarios:</span></span>

- <span data-ttu-id="ad4eb-114">Chargez efficacement les données associées.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-114">Efficiently load related data.</span></span>
- <span data-ttu-id="ad4eb-115">Gérer l’état d’affichage.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-115">Manage view state.</span></span>

<span data-ttu-id="ad4eb-116">Les informations présentées dans les sections suivantes peuvent être utiles si vous avez des requêtes individuelles qui présentent des problèmes de performances :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-116">Information presented in the following sections might be useful if you have individual queries that present performance problems:</span></span>

- <span data-ttu-id="ad4eb-117">Utilisez l’option de fusion `NoTracking`.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-117">Use the `NoTracking` merge option.</span></span>
- <span data-ttu-id="ad4eb-118">Précompilez des requêtes LINQ.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-118">Pre-compile LINQ queries.</span></span>
- <span data-ttu-id="ad4eb-119">Examinez les commandes de requête envoyées à la base de données.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-119">Examine query commands sent to the database.</span></span>

<span data-ttu-id="ad4eb-120">Les informations présentées dans la section suivante sont potentiellement utiles pour les applications qui ont des modèles de données extrêmement volumineux :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-120">Information presented in the following section is potentially useful for applications that have extremely large data models:</span></span>

- <span data-ttu-id="ad4eb-121">Prégénérez les vues.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-121">Pre-generate views.</span></span>

> [!NOTE]
> <span data-ttu-id="ad4eb-122">Les performances de l’application Web sont affectées par de nombreux facteurs, notamment la taille des données de demande et de réponse, la vitesse des requêtes de base de données, le nombre de demandes que le serveur peut mettre en file d’attente et la rapidité avec laquelle il peut les traiter, et même l’efficacité de tout les bibliothèques de scripts client que vous utilisez peut-être.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-122">Web application performance is affected by many factors, including things like the size of request and response data, the speed of database queries, how many requests the server can queue and how quickly it can service them, and even the efficiency of any client-script libraries you might be using.</span></span> <span data-ttu-id="ad4eb-123">Si les performances sont critiques dans votre application, ou si les tests ou l’expérience montrent que les performances de l’application ne sont pas satisfaisantes, vous devez suivre le protocole normal pour le réglage des performances.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-123">If performance is critical in your application, or if testing or experience shows that application performance isn't satisfactory, you should follow normal protocol for performance tuning.</span></span> <span data-ttu-id="ad4eb-124">Mesurez les cas où les goulots d’étranglement de performances se produisent, puis traitez les zones qui auront le plus grand impact sur les performances globales de l’application.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-124">Measure to determine where performance bottlenecks are occurring, and then address the areas that will have the greatest impact on overall application performance.</span></span>
> 
> <span data-ttu-id="ad4eb-125">Cette rubrique se concentre principalement sur la façon dont vous pouvez potentiellement améliorer les performances de la Entity Framework dans ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-125">This topic focuses mainly on ways in which you can potentially improve the performance specifically of the Entity Framework in ASP.NET.</span></span> <span data-ttu-id="ad4eb-126">Les suggestions ici sont utiles si vous déterminez que l’accès aux données est l’un des goulots d’étranglement de performances dans votre application.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-126">The suggestions here are useful if you determine that data access is one of the performance bottlenecks in your application.</span></span> <span data-ttu-id="ad4eb-127">Sauf mention contraire, les méthodes expliquées ici ne doivent pas être considérées comme &quot;meilleures pratiques&quot; en général. beaucoup d’entre elles sont appropriées uniquement dans des situations exceptionnelles ou pour résoudre des types spécifiques de goulots d’étranglement de performances.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-127">Except as noted, the methods explained here shouldn't be considered &quot;best practices&quot; in general — many of them are appropriate only in exceptional situations or to address very specific kinds of performance bottlenecks.</span></span>

<span data-ttu-id="ad4eb-128">Pour démarrer le didacticiel, démarrez Visual Studio et ouvrez l’application Web Contoso University avec laquelle vous travailliez dans le didacticiel précédent.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-128">To start the tutorial, start Visual Studio and open the Contoso University web application that you were working with in the previous tutorial.</span></span>

## <a name="efficiently-loading-related-data"></a><span data-ttu-id="ad4eb-129">Chargement efficace de données associées</span><span class="sxs-lookup"><span data-stu-id="ad4eb-129">Efficiently Loading Related Data</span></span>

<span data-ttu-id="ad4eb-130">La Entity Framework peut charger des données associées de plusieurs façons dans les propriétés de navigation d’une entité :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-130">There are several ways that the Entity Framework can load related data into the navigation properties of an entity:</span></span>

- <span data-ttu-id="ad4eb-131">*Chargement différé*.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-131">*Lazy loading*.</span></span> <span data-ttu-id="ad4eb-132">Quand l’entité est lue pour la première fois, les données associées ne sont pas récupérées.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-132">When the entity is first read, related data isn't retrieved.</span></span> <span data-ttu-id="ad4eb-133">Toutefois, la première fois que vous essayez d’accéder à une propriété de navigation, les données requises pour cette propriété de navigation sont récupérées automatiquement.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-133">However, the first time you attempt to access a navigation property, the data required for that navigation property is automatically retrieved.</span></span> <span data-ttu-id="ad4eb-134">Cela entraîne l’envoi de plusieurs requêtes à la base de données : une pour l’entité elle-même et une autre chaque fois que les données associées pour l’entité doivent être récupérées.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-134">This results in multiple queries sent to the database — one for the entity itself and one each time that related data for the entity must be retrieved.</span></span> 

    <span data-ttu-id="ad4eb-135">[![Image05](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-135">[![Image05](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="ad4eb-136">*Chargement hâtif*.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-136">*Eager loading*.</span></span> <span data-ttu-id="ad4eb-137">Quand l’entité est lue, ses données associées sont également récupérées.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-137">When the entity is read, related data is retrieved along with it.</span></span> <span data-ttu-id="ad4eb-138">Cela génère en général une requête de jointure unique qui récupère toutes les données nécessaires.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-138">This typically results in a single join query that retrieves all of the data that's needed.</span></span> <span data-ttu-id="ad4eb-139">Vous spécifiez le chargement hâtif à l’aide de la méthode `Include`, comme vous l’avez déjà vu dans ces didacticiels.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-139">You specify eager loading by using the `Include` method, as you've seen already in these tutorials.</span></span>

<span data-ttu-id="ad4eb-140">[![Image07](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-140">[![Image07](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

- <span data-ttu-id="ad4eb-141">*Chargement explicite*.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-141">*Explicit loading*.</span></span> <span data-ttu-id="ad4eb-142">Cela est similaire au chargement différé, à ceci près que vous récupérez explicitement les données associées dans le code ; elle ne se produit pas automatiquement lorsque vous accédez à une propriété de navigation.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-142">This is similar to lazy loading, except that you explicitly retrieve the related data in code; it doesn't happen automatically when you access a navigation property.</span></span> <span data-ttu-id="ad4eb-143">Vous chargez les données associées manuellement à l’aide de la méthode `Load` de la propriété de navigation pour les collections, ou vous utilisez la méthode `Load` de la propriété de référence pour les propriétés qui contiennent un seul objet.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-143">You load related data manually using the `Load` method of the navigation property for collections, or you use the `Load` method of the reference property for properties that hold a single object.</span></span> <span data-ttu-id="ad4eb-144">(Par exemple, vous appelez la méthode `PersonReference.Load` pour charger la propriété de navigation `Person` d’une entité `Department`.)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-144">(For example, you call the `PersonReference.Load` method to load the `Person` navigation property of a `Department` entity.)</span></span>

    <span data-ttu-id="ad4eb-145">[![Image06](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-145">[![Image06](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="ad4eb-146">Étant donné qu’ils ne récupèrent pas immédiatement les valeurs de propriété, le chargement différé et le chargement explicite sont également connus sous le nom de *chargement différé*.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-146">Because they don't immediately retrieve the property values, lazy loading and explicit loading are also both known as *deferred loading*.</span></span>

<span data-ttu-id="ad4eb-147">Le chargement différé est le comportement par défaut d’un contexte d’objet qui a été généré par le concepteur.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-147">Lazy loading is the default behavior for an object context that has been generated by the designer.</span></span> <span data-ttu-id="ad4eb-148">Si vous ouvrez le fichier *SchoolModel.Designer.cs* qui définit la classe de contexte de l’objet, vous trouverez trois méthodes de constructeur, chacune incluant l’instruction suivante :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-148">If you open the *SchoolModel.Designer.cs* file that defines the object context class, you'll find three constructor methods, and each of them includes the following statement:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="ad4eb-149">En général, si vous savez que vous avez besoin de données associées pour chaque entité Récupérée, le chargement hâtif offre les meilleures performances, car une seule requête envoyée à la base de données est généralement plus efficace que les requêtes distinctes pour chaque entité récupérée.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-149">In general, if you know you need related data for every entity retrieved, eager loading offers the best performance, because a single query sent to the database is typically more efficient than separate queries for each entity retrieved.</span></span> <span data-ttu-id="ad4eb-150">En revanche, si vous devez accéder aux propriétés de navigation d’une entité rarement ou uniquement pour un petit ensemble d’entités, le chargement différé ou le chargement explicite peut être plus efficace, car le chargement hâtif récupérerait plus de données que nécessaire.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-150">On the other hand, if you need to access an entity's navigation properties only infrequently or only for a small set of the entities, lazy loading or explicit loading may be more efficient, because eager loading would retrieve more data than you need.</span></span>

<span data-ttu-id="ad4eb-151">Dans une application Web, le chargement différé peut être relativement peu utile, car les actions de l’utilisateur qui affectent le besoin de données associées ont lieu dans le navigateur, qui n’a pas de connexion au contexte de l’objet qui a rendu la page.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-151">In a web application, lazy loading may be of relatively little value anyway, because user actions that affect the need for related data take place in the browser, which has no connection to the object context that rendered the page.</span></span> <span data-ttu-id="ad4eb-152">En revanche, lorsque vous liez un contrôle, vous connaissez généralement les données dont vous avez besoin, et il est généralement préférable de choisir un chargement hâtif ou un chargement différé en fonction de ce qui est approprié dans chaque scénario.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-152">On the other hand, when you databind a control, you typically know what data you need, and so it's generally best to choose eager loading or deferred loading based on what's appropriate in each scenario.</span></span>

<span data-ttu-id="ad4eb-153">En outre, un contrôle DataBound peut utiliser un objet d’entité après la suppression du contexte de l’objet.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-153">In addition, a databound control might use an entity object after the object context is disposed.</span></span> <span data-ttu-id="ad4eb-154">Dans ce cas, une tentative de chargement différé d’une propriété de navigation échoue.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-154">In that case, an attempt to lazy-load a navigation property would fail.</span></span> <span data-ttu-id="ad4eb-155">Le message d’erreur que vous recevez est clair : &quot;`The ObjectContext instance has been disposed and can no longer be used for operations that require a connection.`&quot;</span><span class="sxs-lookup"><span data-stu-id="ad4eb-155">The error message you receive is clear: &quot;`The ObjectContext instance has been disposed and can no longer be used for operations that require a connection.`&quot;</span></span>

<span data-ttu-id="ad4eb-156">Le contrôle `EntityDataSource` désactive le chargement différé par défaut.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-156">The `EntityDataSource` control disables lazy loading by default.</span></span> <span data-ttu-id="ad4eb-157">Pour le contrôle de `ObjectDataSource` que vous utilisez pour le didacticiel actuel (ou si vous accédez au contexte de l’objet à partir du code de la page), il existe plusieurs façons de désactiver le chargement différé par défaut.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-157">For the `ObjectDataSource` control that you're using for the current tutorial (or if you access the object context from page code), there are several ways you can make lazy loading disabled by default.</span></span> <span data-ttu-id="ad4eb-158">Vous pouvez la désactiver quand vous instanciez un contexte d’objet.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-158">You can disable it when you instantiate an object context.</span></span> <span data-ttu-id="ad4eb-159">Par exemple, vous pouvez ajouter la ligne suivante à la méthode de constructeur de la classe `SchoolRepository` :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-159">For example, you can add the following line to the constructor method of the `SchoolRepository` class:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="ad4eb-160">Pour l’application Contoso University, vous allez faire en sorte que le contexte de l’objet désactive automatiquement le chargement différé afin qu’il ne soit pas nécessaire de définir cette propriété chaque fois qu’un contexte est instancié.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-160">For the Contoso University application, you'll make the object context automatically disable lazy loading so that this property doesn't have to be set whenever a context is instantiated.</span></span>

<span data-ttu-id="ad4eb-161">Ouvrez le modèle de données *SchoolModel. edmx* , cliquez sur l’aire de conception, puis dans le volet Propriétés, affectez à la propriété **chargement différé activé** la valeur `False`.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-161">Open the *SchoolModel.edmx* data model, click the design surface, and then in the properties pane set the **Lazy Loading Enabled** property to `False`.</span></span> <span data-ttu-id="ad4eb-162">Enregistrez et fermez le modèle de données.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-162">Save and close the data model.</span></span>

<span data-ttu-id="ad4eb-163">[![Image04](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-163">[![Image04](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

## <a name="managing-view-state"></a><span data-ttu-id="ad4eb-164">Gestion de l’état d’affichage</span><span class="sxs-lookup"><span data-stu-id="ad4eb-164">Managing View State</span></span>

<span data-ttu-id="ad4eb-165">Pour fournir une fonctionnalité de mise à jour, une page Web ASP.NET doit stocker les valeurs de propriété d’origine d’une entité lors du rendu d’une page.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-165">In order to provide update functionality, an ASP.NET web page must store the original property values of an entity when a page is rendered.</span></span> <span data-ttu-id="ad4eb-166">Pendant le traitement de la publication (postback), le contrôle peut recréer l’état d’origine de l’entité et appeler la méthode `Attach` de l’entité avant d’appliquer les modifications et d’appeler la méthode `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-166">During postback processing the control can re-create the original state of the entity and call the entity's `Attach` method before applying changes and calling the `SaveChanges` method.</span></span> <span data-ttu-id="ad4eb-167">Par défaut, ASP.NET Web Forms contrôles de données utilisent l’état d’affichage pour stocker les valeurs d’origine.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-167">By default, ASP.NET Web Forms data controls use view state to store the original values.</span></span> <span data-ttu-id="ad4eb-168">Toutefois, l’état d’affichage peut affecter les performances, car il est stocké dans des champs masqués qui peuvent augmenter considérablement la taille de la page qui est envoyée vers et depuis le navigateur.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-168">However, view state can affect performance, because it's stored in hidden fields that can substantially increase the size of the page that's sent to and from the browser.</span></span>

<span data-ttu-id="ad4eb-169">Les techniques de gestion de l’état d’affichage, ou d’autres solutions telles que l’état de session, ne sont pas uniques à la Entity Framework. ce didacticiel n’aborde pas ce sujet en détail.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-169">Techniques for managing view state, or alternatives such as session state, aren't unique to the Entity Framework, so this tutorial doesn't go into this topic in detail.</span></span> <span data-ttu-id="ad4eb-170">Pour plus d’informations, consultez les liens à la fin du didacticiel.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-170">For more information see the links at the end of the tutorial.</span></span>

<span data-ttu-id="ad4eb-171">Toutefois, la version 4 de ASP.NET offre une nouvelle façon de travailler avec l’état d’affichage que chaque développeur ASP.NET d’Web Forms applications doit connaître : la propriété `ViewStateMode`.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-171">However, version 4 of ASP.NET provides a new way of working with view state that every ASP.NET developer of Web Forms applications should be aware of: the `ViewStateMode` property.</span></span> <span data-ttu-id="ad4eb-172">Cette nouvelle propriété peut être définie au niveau de la page ou du contrôle, et elle vous permet de désactiver par défaut l’état d’affichage d’une page et de l’activer uniquement pour les contrôles qui en ont besoin.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-172">This new property can be set at the page or control level, and it enables you to disable view state by default for a page and enable it only for controls that need it.</span></span>

<span data-ttu-id="ad4eb-173">Pour les applications dont les performances sont critiques, il est recommandé de toujours désactiver l’état d’affichage au niveau de la page et de l’activer uniquement pour les contrôles qui l’exigent.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-173">For applications where performance is critical, a good practice is to always disable view state at the page level and enable it only for controls that require it.</span></span> <span data-ttu-id="ad4eb-174">La taille de l’état d’affichage dans les pages de l’Université contoso n’aurait pas été sensiblement réduite par cette méthode, mais pour voir comment elle fonctionne, vous le ferez pour la page *enseignants. aspx* .</span><span class="sxs-lookup"><span data-stu-id="ad4eb-174">The size of view state in the Contoso University pages wouldn't be substantially decreased by this method, but to see how it works, you'll do it for the *Instructors.aspx* page.</span></span> <span data-ttu-id="ad4eb-175">Cette page contient de nombreux contrôles, y compris un contrôle `Label` dont l’état d’affichage est désactivé.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-175">That page contains many controls, including a `Label` control that has view state disabled.</span></span> <span data-ttu-id="ad4eb-176">Aucun des contrôles de cette page n’a réellement besoin d’avoir l’état d’affichage activé.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-176">None of the controls on this page actually need to have view state enabled.</span></span> <span data-ttu-id="ad4eb-177">(La propriété `DataKeyNames` du contrôle `GridView` spécifie l’État qui doit être maintenu entre les publications, mais ces valeurs sont conservées dans l’état du contrôle, ce qui n’est pas affecté par la propriété `ViewStateMode`.)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-177">(The `DataKeyNames` property of the `GridView` control specifies state that must be maintained between postbacks, but these values are kept in control state, which isn't affected by the `ViewStateMode` property.)</span></span>

<span data-ttu-id="ad4eb-178">La directive `Page` et le balisage de contrôle `Label` se comparent actuellement de l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-178">The `Page` directive and `Label` control markup currently resembles the following example:</span></span>

[!code-aspx[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="ad4eb-179">Effectuez les modifications suivantes :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-179">Make the following changes:</span></span>

- <span data-ttu-id="ad4eb-180">Ajoutez `ViewStateMode="Disabled"` à la directive `Page`.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-180">Add `ViewStateMode="Disabled"` to the `Page` directive.</span></span>
- <span data-ttu-id="ad4eb-181">Supprimez `ViewStateMode="Disabled"` du contrôle `Label`.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-181">Remove `ViewStateMode="Disabled"` from the `Label` control.</span></span>

<span data-ttu-id="ad4eb-182">Le balisage ressemble maintenant à l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-182">The markup now resembles the following example:</span></span>

[!code-aspx[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="ad4eb-183">L’état d’affichage est maintenant désactivé pour tous les contrôles.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-183">View state is now disabled for all controls.</span></span> <span data-ttu-id="ad4eb-184">Si, par la suite, vous ajoutez un contrôle qui n’a pas besoin d’utiliser l’état d’affichage, il vous suffit d’inclure l’attribut `ViewStateMode="Enabled"` pour ce contrôle.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-184">If you later add a control that does need to use view state, all you need to do is include the `ViewStateMode="Enabled"` attribute for that control.</span></span>

## <a name="using-the-notracking-merge-option"></a><span data-ttu-id="ad4eb-185">Utilisation de l’option de fusion NoTracking</span><span class="sxs-lookup"><span data-stu-id="ad4eb-185">Using The NoTracking Merge Option</span></span>

<span data-ttu-id="ad4eb-186">Lorsqu’un contexte d’objet récupère des lignes de base de données et crée des objets d’entité qui les représentent, par défaut, il effectue également le suivi de ces objets d’entité à l’aide de son gestionnaire d’état d’objet.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-186">When an object context retrieves database rows and creates entity objects that represent them, by default it also tracks those entity objects using its object state manager.</span></span> <span data-ttu-id="ad4eb-187">Ces données de suivi jouent le rôle de cache et sont utilisées lorsque vous mettez à jour une entité.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-187">This tracking data acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="ad4eb-188">Étant donné qu’une application Web possède généralement des instances de contexte d’objet éphémères, les requêtes retournent souvent des données qui n’ont pas besoin d’être suivies, car le contexte de l’objet qui les lit est supprimé avant d’être réutilisé ou mis à jour.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-188">Because a web application typically has short-lived object context instances, queries often return data that doesn't need to be tracked, because the object context that reads them will be disposed before any of the entities it reads are used again or updated.</span></span>

<span data-ttu-id="ad4eb-189">Dans la Entity Framework, vous pouvez spécifier si le contexte de l’objet effectue le suivi des objets d’entité en définissant une *option de fusion*.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-189">In the Entity Framework, you can specify whether the object context tracks entity objects by setting a *merge option*.</span></span> <span data-ttu-id="ad4eb-190">Vous pouvez définir l’option de fusion pour des requêtes individuelles ou pour des jeux d’entités.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-190">You can set the merge option for individual queries or for entity sets.</span></span> <span data-ttu-id="ad4eb-191">Si vous la définissez pour un jeu d’entités, cela signifie que vous définissez l’option de fusion par défaut pour toutes les requêtes créées pour ce jeu d’entités.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-191">If you set it for an entity set, that means that you're setting the default merge option for all queries that are created for that entity set.</span></span>

<span data-ttu-id="ad4eb-192">Pour l’application Contoso University, le suivi n’est pas nécessaire pour les jeux d’entités auxquels vous accédez à partir du référentiel. vous pouvez donc définir l’option de fusion sur `NoTracking` pour ces jeux d’entités lorsque vous instanciez le contexte de l’objet dans la classe de référentiel.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-192">For the Contoso University application, tracking isn't needed for any of the entity sets that you access from the repository, so you can set the merge option to `NoTracking` for those entity sets when you instantiate the object context in the repository class.</span></span> <span data-ttu-id="ad4eb-193">(Notez que dans ce didacticiel, la définition de l’option de fusion n’aura pas d’effet notable sur les performances de l’application.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-193">(Note that in this tutorial, setting the merge option won't have a noticeable effect on the application's performance.</span></span> <span data-ttu-id="ad4eb-194">L’option `NoTracking` est susceptible d’améliorer les performances observables uniquement dans certains scénarios de volume de données élevé.)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-194">The `NoTracking` option is likely to make an observable performance improvement only in certain high-data-volume scenarios.)</span></span>

<span data-ttu-id="ad4eb-195">Dans le dossier DAL, ouvrez le fichier *SchoolRepository.cs* et ajoutez une méthode de constructeur qui définit l’option de fusion pour les jeux d’entités auxquels le référentiel accède :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-195">In the DAL folder, open the *SchoolRepository.cs* file and add a constructor method that sets the merge option for the entity sets that the repository accesses:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

## <a name="pre-compiling-linq-queries"></a><span data-ttu-id="ad4eb-196">Précompilation de requêtes LINQ</span><span class="sxs-lookup"><span data-stu-id="ad4eb-196">Pre-Compiling LINQ Queries</span></span>

<span data-ttu-id="ad4eb-197">La première fois que l’Entity Framework exécute une requête Entity SQL dans la durée de vie d’une instance de `ObjectContext` donnée, la compilation de la requête prend un certain temps.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-197">The first time that the Entity Framework executes an Entity SQL query within the life of a given `ObjectContext` instance, it takes some time to compile the query.</span></span> <span data-ttu-id="ad4eb-198">Le résultat de la compilation est mis en cache, ce qui signifie que les exécutions ultérieures de la requête sont nettement plus rapides.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-198">The result of compilation is cached, which means that subsequent executions of the query are much quicker.</span></span> <span data-ttu-id="ad4eb-199">Les requêtes LINQ suivent un modèle similaire, à ceci près qu’une partie du travail nécessaire à la compilation de la requête est effectuée chaque fois que la requête est exécutée.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-199">LINQ queries follow a similar pattern, except that some of the work required to compile the query is done every time the query is executed.</span></span> <span data-ttu-id="ad4eb-200">En d’autres termes, pour les requêtes LINQ, par défaut, tous les résultats de la compilation ne sont pas tous mis en cache.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-200">In other words, for LINQ queries, by default not all of the results of compilation are cached.</span></span>

<span data-ttu-id="ad4eb-201">Si vous avez une requête LINQ que vous prévoyez d’exécuter à plusieurs reprises dans la vie d’un contexte d’objet, vous pouvez écrire du code qui entraîne la mise en cache de tous les résultats de la compilation lors de la première exécution de la requête LINQ.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-201">If you have a LINQ query that you expect to run repeatedly in the life of an object context, you can write code that causes all of the results of compilation to be cached the first time the LINQ query is run.</span></span>

<span data-ttu-id="ad4eb-202">À titre d’illustration, vous effectuerez cette opération pour deux méthodes `Get` dans la classe `SchoolRepository`, l’une d’entre elles ne prenant aucun paramètre (la méthode `GetInstructorNames`) et l’autre qui nécessite un paramètre (la méthode `GetDepartmentsByAdministrator`).</span><span class="sxs-lookup"><span data-stu-id="ad4eb-202">As an illustration, you'll do this for two `Get` methods in the `SchoolRepository` class, one of which doesn't take any parameters (the `GetInstructorNames` method), and one that does require a parameter (the `GetDepartmentsByAdministrator` method).</span></span> <span data-ttu-id="ad4eb-203">En réalité, ces méthodes ne doivent pas être compilées car elles ne sont pas des requêtes LINQ :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-203">These methods as they stand now actually don't need to be compiled because they aren't LINQ queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

<span data-ttu-id="ad4eb-204">Toutefois, pour pouvoir essayer des requêtes compilées, vous devez procéder comme si elles avaient été écrites en tant que requêtes LINQ suivantes :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-204">However, so that you can try out compiled queries, you'll proceed as if these had been written as the following LINQ queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="ad4eb-205">Vous pouvez modifier le code dans ces méthodes en fonction de ce qui est indiqué ci-dessus, puis exécuter l’application pour vérifier qu’elle fonctionne avant de continuer.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-205">You could change the code in these methods to what's shown above and run the application to verify that it works before continuing.</span></span> <span data-ttu-id="ad4eb-206">Toutefois, les instructions suivantes vous guident directement dans la création de versions précompilées.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-206">But the following instructions jump right into creating pre-compiled versions of them.</span></span>

<span data-ttu-id="ad4eb-207">Créez un fichier de classe dans le dossier *dal* , nommez-le *SchoolEntities.cs*et remplacez le code existant par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-207">Create a class file in the *DAL* folder, name it *SchoolEntities.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="ad4eb-208">Ce code crée une classe partielle qui étend la classe de contexte d’objet générée automatiquement.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-208">This code creates a partial class that extends the automatically generated object context class.</span></span> <span data-ttu-id="ad4eb-209">La classe partielle comprend deux requêtes LINQ compilées à l’aide de la méthode `Compile` de la classe `CompiledQuery`.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-209">The partial class includes two compiled LINQ queries using the `Compile` method of the `CompiledQuery` class.</span></span> <span data-ttu-id="ad4eb-210">Il crée également des méthodes que vous pouvez utiliser pour appeler les requêtes.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-210">It also creates methods that you can use to call the queries.</span></span> <span data-ttu-id="ad4eb-211">Enregistrez et fermez ce fichier.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-211">Save and close this file.</span></span>

<span data-ttu-id="ad4eb-212">Ensuite, dans *SchoolRepository.cs*, modifiez les méthodes `GetInstructorNames` et `GetDepartmentsByAdministrator` existantes dans la classe de référentiel afin qu’elles appellent les requêtes compilées :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-212">Next, in *SchoolRepository.cs*, change the existing `GetInstructorNames` and `GetDepartmentsByAdministrator` methods in the repository class so that they call the compiled queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

<span data-ttu-id="ad4eb-213">Exécutez la page *Departments. aspx* pour vérifier qu’elle fonctionne comme auparavant.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-213">Run the *Departments.aspx* page to verify that it works as it did before.</span></span> <span data-ttu-id="ad4eb-214">La méthode `GetInstructorNames` est appelée pour remplir la liste déroulante administrateur et la méthode `GetDepartmentsByAdministrator` est appelée lorsque vous cliquez sur **mettre à jour** afin de vérifier qu’aucun formateur n’est un administrateur de plusieurs départements.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-214">The `GetInstructorNames` method is called in order to populate the administrator drop-down list, and the `GetDepartmentsByAdministrator` method is called when you click **Update** in order to verify that no instructor is an administrator of more than one department.</span></span>

<span data-ttu-id="ad4eb-215">[![Image03](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-215">[![Image03](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

<span data-ttu-id="ad4eb-216">Vous avez des requêtes précompilées dans l’application Contoso University uniquement pour voir comment procéder, pas parce que cela permet d’améliorer considérablement les performances.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-216">You've pre-compiled queries in the Contoso University application only to see how to do it, not because it would measurably improve performance.</span></span> <span data-ttu-id="ad4eb-217">La précompilation de requêtes LINQ ajoute un niveau de complexité à votre code. Assurez-vous de le faire uniquement pour les requêtes qui représentent en fait des goulots d’étranglement de performances dans votre application.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-217">Pre-compiling LINQ queries does add a level of complexity to your code, so make sure you do it only for queries that actually represent performance bottlenecks in your application.</span></span>

## <a name="examining-queries-sent-to-the-database"></a><span data-ttu-id="ad4eb-218">Examen des requêtes envoyées à la base de données</span><span class="sxs-lookup"><span data-stu-id="ad4eb-218">Examining Queries Sent to the Database</span></span>

<span data-ttu-id="ad4eb-219">Lorsque vous examinez les problèmes de performances, il est parfois utile de connaître les commandes SQL exactes que l’Entity Framework envoie à la base de données.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-219">When you're investigating performance issues, sometimes it's helpful to know the exact SQL commands that the Entity Framework is sending to the database.</span></span> <span data-ttu-id="ad4eb-220">Si vous utilisez un objet `IQueryable`, vous pouvez utiliser la méthode `ToTraceString` pour ce faire.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-220">If you're working with an `IQueryable` object, one way to do this is to use the `ToTraceString` method.</span></span>

<span data-ttu-id="ad4eb-221">Dans *SchoolRepository.cs*, modifiez le code de la méthode `GetDepartmentsByName` pour qu’il corresponde à l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-221">In *SchoolRepository.cs*, change the code in the `GetDepartmentsByName` method to match the following example:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.cs)]

<span data-ttu-id="ad4eb-222">La variable `departments` doit être convertie en un type `ObjectQuery` uniquement parce que la méthode `Where` à la fin de la ligne précédente crée un objet `IQueryable` ; sans la méthode `Where`, le cast n’est pas nécessaire.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-222">The `departments` variable must be cast to an `ObjectQuery` type only because the `Where` method at the end of the preceding line creates an `IQueryable` object; without the `Where` method, the cast would not be necessary.</span></span>

<span data-ttu-id="ad4eb-223">Définissez un point d’arrêt sur la ligne de `return`, puis exécutez la page *Departments. aspx* dans le débogueur.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-223">Set a breakpoint on the `return` line, and then run the *Departments.aspx* page in the debugger.</span></span> <span data-ttu-id="ad4eb-224">Quand vous atteignez le point d’arrêt, examinez la variable `commandText` dans la fenêtre **variables locales** et utilisez le visualiseur de texte (la loupe dans la colonne **valeur** ) pour afficher sa valeur dans la fenêtre du **visualiseur de texte** .</span><span class="sxs-lookup"><span data-stu-id="ad4eb-224">When you hit the breakpoint, examine the `commandText` variable in the **Locals** window and use the text visualizer (the magnifying glass in the **Value** column) to display its value in the **Text Visualizer** window.</span></span> <span data-ttu-id="ad4eb-225">Vous pouvez voir l’intégralité de la commande SQL qui résulte de ce code :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-225">You can see the entire SQL command that results from this code:</span></span>

<span data-ttu-id="ad4eb-226">[![Image08](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-226">[![Image08](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="ad4eb-227">En guise d’alternative, la fonctionnalité IntelliTrace de Visual Studio Ultimate permet d’afficher les commandes SQL générées par le Entity Framework qui ne vous oblige pas à modifier votre code ou même à définir un point d’arrêt.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-227">As an alternative, the IntelliTrace feature in Visual Studio Ultimate provides a way to view SQL commands generated by the Entity Framework that doesn't require you to change your code or even set a breakpoint.</span></span>

> [!NOTE]
> <span data-ttu-id="ad4eb-228">Vous pouvez effectuer les procédures suivantes uniquement si vous avez Visual Studio Ultimate.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-228">You can perform the following procedures only if you have Visual Studio Ultimate.</span></span>

<span data-ttu-id="ad4eb-229">Restaurez le code d’origine dans la méthode `GetDepartmentsByName`, puis exécutez la page *Departments. aspx* dans le débogueur.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-229">Restore the original code in the `GetDepartmentsByName` method, and then run the *Departments.aspx* page in the debugger.</span></span>

<span data-ttu-id="ad4eb-230">Dans Visual Studio, sélectionnez le menu **Déboguer** , **IntelliTrace**, puis **événements IntelliTrace**.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-230">In Visual Studio, select the **Debug** menu, then **IntelliTrace**, and then **IntelliTrace Events**.</span></span>

<span data-ttu-id="ad4eb-231">[![Image11](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-231">[![Image11](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="ad4eb-232">Dans la fenêtre **IntelliTrace** , cliquez sur **arrêter tout**.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-232">In the **IntelliTrace** window, click **Break All**.</span></span>

<span data-ttu-id="ad4eb-233">[![Image12](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-233">[![Image12](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="ad4eb-234">La fenêtre **IntelliTrace** affiche une liste des événements récents :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-234">The **IntelliTrace** window displays a list of recent events:</span></span>

<span data-ttu-id="ad4eb-235">[![Image09](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-235">[![Image09](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="ad4eb-236">Cliquez sur la ligne **ADO.net** .</span><span class="sxs-lookup"><span data-stu-id="ad4eb-236">Click the **ADO.NET** line.</span></span> <span data-ttu-id="ad4eb-237">Il se développe pour afficher le texte de la commande :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-237">It expands to show you the command text:</span></span>

<span data-ttu-id="ad4eb-238">[![Image10](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-238">[![Image10](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="ad4eb-239">Vous pouvez copier l’intégralité de la chaîne de texte de la commande dans le presse-papiers à partir de la fenêtre **variables locales** .</span><span class="sxs-lookup"><span data-stu-id="ad4eb-239">You can copy the entire command text string to the clipboard from the **Locals** window.</span></span>

<span data-ttu-id="ad4eb-240">Supposons que vous travailliez avec une base de données contenant plus de tables, de relations et de colonnes que la base de données `School` simple.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-240">Suppose you were working with a database with more tables, relationships, and columns than the simple `School` database.</span></span> <span data-ttu-id="ad4eb-241">Vous pouvez constater qu’une requête qui rassemble toutes les informations dont vous avez besoin dans une seule instruction `Select` contenant plusieurs clauses `Join` devient trop complexe pour fonctionner efficacement.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-241">You might find that a query that gathers all the information you need in a single `Select` statement containing multiple `Join` clauses becomes too complex to work efficiently.</span></span> <span data-ttu-id="ad4eb-242">Dans ce cas, vous pouvez passer du chargement hâtif au chargement explicite pour simplifier la requête.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-242">In that case you can switch from eager loading to explicit loading to simplify the query.</span></span>

<span data-ttu-id="ad4eb-243">Par exemple, essayez de modifier le code dans la méthode `GetDepartmentsByName` dans *SchoolRepository.cs*.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-243">For example, try changing the code in the `GetDepartmentsByName` method in *SchoolRepository.cs*.</span></span> <span data-ttu-id="ad4eb-244">Dans cette méthode, vous avez une requête d’objet qui a `Include` méthodes pour les propriétés de navigation `Person` et `Courses`.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-244">Currently in that method you have an object query that has `Include` methods for the `Person` and `Courses` navigation properties.</span></span> <span data-ttu-id="ad4eb-245">Remplacez l’instruction `return` par un code qui effectue un chargement explicite, comme indiqué dans l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-245">Replace the `return` statement with code that performs explicit loading, as shown in the following example:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="ad4eb-246">Exécutez la page *Departments. aspx* dans le débogueur et vérifiez à nouveau la fenêtre **IntelliTrace** comme vous l’avez fait précédemment.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-246">Run the *Departments.aspx* page in the debugger and check the **IntelliTrace** window again as you did before.</span></span> <span data-ttu-id="ad4eb-247">Maintenant, lorsqu’il y avait une seule requête, vous voyez une longue séquence de ces requêtes.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-247">Now, where there was a single query before, you see a long sequence of them.</span></span>

<span data-ttu-id="ad4eb-248">[![Image13](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-248">[![Image13](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="ad4eb-249">Cliquez sur la première ligne **ADO.net** pour voir ce qui s’est passé à la requête complexe que vous avez vue précédemment.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-249">Click the first **ADO.NET** line to see what has happened to the complex query you viewed earlier.</span></span>

<span data-ttu-id="ad4eb-250">[![Image14](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-250">[![Image14](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

<span data-ttu-id="ad4eb-251">La requête de Departments est devenue une simple requête de `Select` sans clause `Join`, mais elle est suivie de requêtes distinctes qui récupèrent les cours connexes et un administrateur, à l’aide d’un ensemble de deux requêtes pour chaque service retourné par la requête d’origine.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-251">The query from Departments has become a simple `Select` query with no `Join` clause, but it's followed by separate queries that retrieve related courses and an administrator, using a set of two queries for each department returned by the original query.</span></span>

> [!NOTE]
> <span data-ttu-id="ad4eb-252">Si vous laissez le chargement différé activé, le modèle que vous voyez ici, avec la même requête répétée plusieurs fois, peut être dû à un chargement différé.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-252">If you leave lazy loading enabled, the pattern you see here, with the same query repeated many times, might result from lazy loading.</span></span> <span data-ttu-id="ad4eb-253">Un modèle que vous souhaitez généralement éviter est le chargement différé des données associées pour chaque ligne de la table primaire.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-253">A pattern that you typically want to avoid is lazy-loading related data for every row of the primary table.</span></span> <span data-ttu-id="ad4eb-254">À moins que vous ayez vérifié qu’une seule requête de jointure est trop complexe pour être efficace, vous pouvez généralement améliorer les performances dans de tels cas en modifiant la requête principale afin d’utiliser le chargement hâtif.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-254">Unless you've verified that a single join query is too complex to be efficient, you'd typically be able to improve performance in such cases by changing the primary query to use eager loading.</span></span>

## <a name="pre-generating-views"></a><span data-ttu-id="ad4eb-255">Prégénération de vues</span><span class="sxs-lookup"><span data-stu-id="ad4eb-255">Pre-Generating Views</span></span>

<span data-ttu-id="ad4eb-256">Quand un objet `ObjectContext` est créé pour la première fois dans un nouveau domaine d’application, le Entity Framework génère un ensemble de classes qu’il utilise pour accéder à la base de données.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-256">When an `ObjectContext` object is first created in a new application domain, the Entity Framework generates a set of classes that it uses to access the database.</span></span> <span data-ttu-id="ad4eb-257">Ces classes sont appelées *vues*et, si vous disposez d’un modèle de données très volumineux, la génération de ces vues peut retarder la réponse du site Web à la première demande d’une page après l’initialisation d’un nouveau domaine d’application.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-257">These classes are called *views*, and if you have a very large data model, generating these views can delay the web site's response to the first request for a page after a new application domain is initialized.</span></span> <span data-ttu-id="ad4eb-258">Vous pouvez réduire ce délai de première demande en créant les vues au moment de la compilation plutôt qu’au moment de l’exécution.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-258">You can reduce this first-request delay by creating the views at compile time rather than at run time.</span></span>

> [!NOTE]
> <span data-ttu-id="ad4eb-259">Si votre application n’a pas de modèle de données extrêmement volumineux, ou si elle a un modèle de données volumineux, mais que vous ne vous inquiétez pas d’un problème de performances qui affecte uniquement la première demande de page après le recyclage d’IIS, vous pouvez ignorer cette section.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-259">If your application doesn't have an extremely large data model, or if it does have a large data model but you aren't concerned about a performance problem that affects only the very first page request after IIS is recycled, you can skip this section.</span></span> <span data-ttu-id="ad4eb-260">La création d’une vue ne se produit pas chaque fois que vous instanciez un objet `ObjectContext`, car les vues sont mises en cache dans le domaine d’application.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-260">View creation doesn't happen every time you instantiate an `ObjectContext` object, because the views are cached in the application domain.</span></span> <span data-ttu-id="ad4eb-261">Par conséquent, à moins que vous ne recycliez fréquemment votre application dans IIS, très peu de demandes de page tireraient parti des vues prégénérées.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-261">Therefore, unless you're frequently recycling your application in IIS, very few page requests would benefit from pre-generated views.</span></span>

<span data-ttu-id="ad4eb-262">Vous pouvez prégénérer des vues à l’aide de l’outil en ligne de commande *EdmGen. exe* ou à l’aide d’un modèle *Text Template Transformation Toolkit* (T4).</span><span class="sxs-lookup"><span data-stu-id="ad4eb-262">You can pre-generate views using the *EdmGen.exe* command-line tool or by using a *Text Template Transformation Toolkit* (T4) template.</span></span> <span data-ttu-id="ad4eb-263">Dans ce didacticiel, vous allez utiliser un modèle T4.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-263">In this tutorial you'll use a T4 template.</span></span>

<span data-ttu-id="ad4eb-264">Dans le dossier *dal* , ajoutez un fichier à l’aide du modèle de **modèle de texte** (il se trouve sous le nœud **général** dans la liste **modèles installés** ), puis nommez-le *SchoolModel.views.TT*.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-264">In the *DAL* folder, add a file using the **Text Template** template (it's under the **General** node in the **Installed Templates** list), and name it *SchoolModel.Views.tt*.</span></span> <span data-ttu-id="ad4eb-265">Remplacez le code existant dans le fichier par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-265">Replace the existing code in the file with the following code:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

<span data-ttu-id="ad4eb-266">Ce code génère des vues pour un fichier *. edmx* situé dans le même dossier que le modèle et portant le même nom que le fichier de modèle.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-266">This code generates views for an *.edmx* file that's located in the same folder as the template and that has the same name as the template file.</span></span> <span data-ttu-id="ad4eb-267">Par exemple, si votre fichier de modèle est nommé *SchoolModel.views.TT*, il recherche un fichier de modèle de données nommé *SchoolModel. edmx*.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-267">For example, if your template file is named *SchoolModel.Views.tt*, it will look for a data model file named *SchoolModel.edmx*.</span></span>

<span data-ttu-id="ad4eb-268">Enregistrez le fichier, puis cliquez avec le bouton droit sur le fichier dans **Explorateur de solutions** et sélectionnez **exécuter un outil personnalisé**.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-268">Save the file, then right-click the file in **Solution Explorer** and select **Run Custom Tool**.</span></span>

<span data-ttu-id="ad4eb-269">[![Image02](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-269">[![Image02](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="ad4eb-270">Visual Studio génère un fichier de code qui crée les vues, nommées *SchoolModel.views.cs* en fonction du modèle.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-270">Visual Studio generates a code file that creates the views, which is named *SchoolModel.Views.cs* based on the template.</span></span> <span data-ttu-id="ad4eb-271">(Vous avez peut-être remarqué que le fichier de code est généré même avant de sélectionner **exécuter un outil personnalisé**, dès que vous enregistrez le fichier de modèle.)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-271">(You might have noticed that the code file is generated even before you select **Run Custom Tool**, as soon as you save the template file.)</span></span>

<span data-ttu-id="ad4eb-272">[![image01](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-272">[![Image01](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="ad4eb-273">Vous pouvez maintenant exécuter l’application et vérifier qu’elle fonctionne comme auparavant.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-273">You can now run the application and verify that it works as it did before.</span></span>

<span data-ttu-id="ad4eb-274">Pour plus d’informations sur les affichages prégénérés, consultez les ressources suivantes :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-274">For more information about pre-generated views, see the following resources:</span></span>

- <span data-ttu-id="ad4eb-275">[Comment : prégénérer des vues pour améliorer les performances des requêtes](https://msdn.microsoft.com/library/bb896240.aspx) sur le site Web MSDN.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-275">[How to: Pre-Generate Views to Improve Query Performance](https://msdn.microsoft.com/library/bb896240.aspx) on the MSDN web site.</span></span> <span data-ttu-id="ad4eb-276">Explique comment utiliser l’outil en ligne de commande `EdmGen.exe` pour prégénérer des vues.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-276">Explains how to use the `EdmGen.exe` command-line tool to pre-generate views.</span></span>
- <span data-ttu-id="ad4eb-277">[Isolation des performances avec les vues précompilées/prégénérées dans le Entity Framework 4](https://blogs.msdn.com/b/appfabriccat/archive/2010/08/06/isolating-performance-with-precompiled-pre-generated-views-in-the-entity-framework-4.aspx) du blog de l’équipe de conseil clientèle de Windows Server AppFabric.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-277">[Isolating Performance with Precompiled/Pre-generated Views in the Entity Framework 4](https://blogs.msdn.com/b/appfabriccat/archive/2010/08/06/isolating-performance-with-precompiled-pre-generated-views-in-the-entity-framework-4.aspx) on the Windows Server AppFabric Customer Advisory Team blog.</span></span>

<span data-ttu-id="ad4eb-278">Cela termine la présentation de l’amélioration des performances dans une application Web ASP.NET qui utilise le Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-278">This completes the introduction to improving performance in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="ad4eb-279">Pour plus d'informations, reportez-vous aux ressources suivantes :</span><span class="sxs-lookup"><span data-stu-id="ad4eb-279">For more information, see the following resources:</span></span>

- <span data-ttu-id="ad4eb-280">[Considérations sur les performances (Entity Framework)](https://msdn.microsoft.com/library/cc853327.aspx) sur le site Web MSDN.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-280">[Performance Considerations (Entity Framework)](https://msdn.microsoft.com/library/cc853327.aspx) on the MSDN web site.</span></span>
- <span data-ttu-id="ad4eb-281">[Publications relatives aux performances sur le blog de l’équipe Entity Framework](https://blogs.msdn.com/b/adonet/archive/tags/performance/).</span><span class="sxs-lookup"><span data-stu-id="ad4eb-281">[Performance-related posts on the Entity Framework Team blog](https://blogs.msdn.com/b/adonet/archive/tags/performance/).</span></span>
- <span data-ttu-id="ad4eb-282">[Options de fusion EF et requêtes compilées](https://blogs.msdn.com/b/dsimmons/archive/2010/01/12/ef-merge-options-and-compiled-queries.aspx).</span><span class="sxs-lookup"><span data-stu-id="ad4eb-282">[EF Merge Options and Compiled Queries](https://blogs.msdn.com/b/dsimmons/archive/2010/01/12/ef-merge-options-and-compiled-queries.aspx).</span></span> <span data-ttu-id="ad4eb-283">Billet de blog qui explique les comportements inattendus des requêtes compilées et des options de fusion, telles que les `NoTracking`.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-283">Blog post that explains unexpected behaviors of compiled queries and merge options such as `NoTracking`.</span></span> <span data-ttu-id="ad4eb-284">Si vous envisagez d’utiliser des requêtes compilées ou de manipuler des paramètres d’option de fusion dans votre application, lisez-les en premier.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-284">If you plan to use compiled queries or manipulate merge option settings in your application, read this first.</span></span>
- <span data-ttu-id="ad4eb-285">[Publications relatives à Entity Framework dans le blog de l’équipe de Conseil des clients de données et de modélisation](https://blogs.msdn.com/b/dmcat/archive/tags/entity+framework/).</span><span class="sxs-lookup"><span data-stu-id="ad4eb-285">[Entity Framework-related posts in the Data and Modeling Customer Advisory Team blog](https://blogs.msdn.com/b/dmcat/archive/tags/entity+framework/).</span></span> <span data-ttu-id="ad4eb-286">Comprend des publications sur les requêtes compilées et l’utilisation du profileur Visual Studio 2010 pour détecter les problèmes de performances.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-286">Includes posts on compiled queries and using the Visual Studio 2010 Profiler to discover performance issues.</span></span>
- <span data-ttu-id="ad4eb-287">[Entity Framework thread de forum avec des conseils sur l’amélioration des performances des requêtes très complexes](https://social.msdn.microsoft.com/Forums/adodotnetentityframework/thread/ffe8b2ab-c5b5-4331-8988-33a872d0b5f6).</span><span class="sxs-lookup"><span data-stu-id="ad4eb-287">[Entity Framework forum thread with advice on improving performance of highly complex queries](https://social.msdn.microsoft.com/Forums/adodotnetentityframework/thread/ffe8b2ab-c5b5-4331-8988-33a872d0b5f6).</span></span>
- <span data-ttu-id="ad4eb-288">[Recommandations relatives à la gestion d’état ASP.net](https://msdn.microsoft.com/library/z1hkazw7.aspx).</span><span class="sxs-lookup"><span data-stu-id="ad4eb-288">[ASP.NET State Management Recommendations](https://msdn.microsoft.com/library/z1hkazw7.aspx).</span></span>
- <span data-ttu-id="ad4eb-289">[Utilisation des Entity Framework et ObjectDataSource : la pagination personnalisée](http://geekswithblogs.net/Frez/articles/using-the-entity-framework-and-the-objectdatasource-custom-paging.aspx).</span><span class="sxs-lookup"><span data-stu-id="ad4eb-289">[Using the Entity Framework and the ObjectDataSource: Custom Paging](http://geekswithblogs.net/Frez/articles/using-the-entity-framework-and-the-objectdatasource-custom-paging.aspx).</span></span> <span data-ttu-id="ad4eb-290">Billet de blog qui s’appuie sur l’application ContosoUniversity créée dans ces didacticiels pour expliquer comment implémenter la pagination dans la page *Departments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="ad4eb-290">Blog post that builds on the ContosoUniversity application created in these tutorials to explain how to implement paging in the *Departments.aspx* page.</span></span>

<span data-ttu-id="ad4eb-291">Le didacticiel suivant passe en revue certaines des améliorations importantes apportées à la Entity Framework qui sont nouvelles dans la version 4.</span><span class="sxs-lookup"><span data-stu-id="ad4eb-291">The next tutorial reviews some of the important enhancements to the Entity Framework that are new in version 4.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="ad4eb-292">[Précédent](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application.md)
> [Suivant](what-s-new-in-the-entity-framework-4.md)</span><span class="sxs-lookup"><span data-stu-id="ad4eb-292">[Previous](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application.md)
[Next](what-s-new-in-the-entity-framework-4.md)</span></span>
