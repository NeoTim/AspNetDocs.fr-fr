---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: Gestion de l’accès concurrentiel avec la Entity Framework 4,0 dans une application Web ASP.NET 4 | Microsoft Docs
author: tdykstra
description: Cette série de didacticiels s’appuie sur l’application Web Contoso University qui est créée par le Prise en main avec la série de didacticiels Entity Framework 4,0. ...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 3df5f7d9c8fb22e1ea34fe16560bdb9a1309bb56
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78632586"
---
# <a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="e5e77-104">Gestion de l’accès concurrentiel avec la Entity Framework 4,0 dans une application Web ASP.NET 4</span><span class="sxs-lookup"><span data-stu-id="e5e77-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="e5e77-105">par [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="e5e77-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="e5e77-106">Cette série de didacticiels s’appuie sur l’application Web Contoso University qui est créée par le [prise en main avec la](https://asp.net/entity-framework/tutorials#Getting%20Started) série de didacticiels Entity Framework 4,0.</span><span class="sxs-lookup"><span data-stu-id="e5e77-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="e5e77-107">Si vous n’avez pas terminé les didacticiels précédents, comme point de départ pour ce didacticiel, vous pouvez [Télécharger l’application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) que vous auriez créée.</span><span class="sxs-lookup"><span data-stu-id="e5e77-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="e5e77-108">Vous pouvez également [Télécharger l’application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) qui est créée par la série de didacticiels complète.</span><span class="sxs-lookup"><span data-stu-id="e5e77-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="e5e77-109">Si vous avez des questions sur les didacticiels, vous pouvez les poster sur le [Forum de Entity Framework ASP.net](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="e5e77-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="e5e77-110">Dans le didacticiel précédent, vous avez appris à trier et filtrer les données à l’aide du contrôle `ObjectDataSource` et des Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="e5e77-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="e5e77-111">Ce didacticiel présente les options de gestion de l’accès concurrentiel dans une application Web ASP.NET qui utilise le Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="e5e77-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="e5e77-112">Vous allez créer une page Web dédiée à la mise à jour des attributions de bureaux des enseignants.</span><span class="sxs-lookup"><span data-stu-id="e5e77-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="e5e77-113">Vous allez gérer les problèmes d’accès concurrentiel dans cette page et dans la page services que vous avez créée précédemment.</span><span class="sxs-lookup"><span data-stu-id="e5e77-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="e5e77-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="e5e77-115">[![image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="e5e77-116">Conflits d’accès concurrentiel</span><span class="sxs-lookup"><span data-stu-id="e5e77-116">Concurrency Conflicts</span></span>

<span data-ttu-id="e5e77-117">Un conflit d’accès concurrentiel se produit lorsqu’un utilisateur modifie un enregistrement et qu’un autre utilisateur modifie le même enregistrement avant que la modification du premier utilisateur soit écrite dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="e5e77-118">Si vous ne configurez pas les Entity Framework pour détecter de tels conflits, la personne qui met à jour la base de données remplace le dernier remplacement des modifications de l’autre utilisateur.</span><span class="sxs-lookup"><span data-stu-id="e5e77-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="e5e77-119">Dans de nombreuses applications, ce risque est acceptable et vous n’avez pas besoin de configurer l’application pour gérer les éventuels conflits d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="e5e77-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="e5e77-120">(S’il n’y a que peu d’utilisateurs, ou peu de mises à jour, ou si n’est pas vraiment critique si certaines modifications sont remplacées, le coût de la programmation de l’accès concurrentiel peut être le même que celui de l’avantage.) Si vous n’avez pas besoin de vous soucier des conflits d’accès concurrentiel, vous pouvez ignorer ce didacticiel. les deux autres didacticiels de la série ne dépendent pas de ce que vous créez dans celui-ci.</span><span class="sxs-lookup"><span data-stu-id="e5e77-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="e5e77-121">Accès concurrentiel pessimiste (verrouillage)</span><span class="sxs-lookup"><span data-stu-id="e5e77-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="e5e77-122">Si votre application doit éviter la perte accidentelle de données dans des scénarios d’accès concurrentiel, une manière de le faire consiste à utiliser des verrous de base de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="e5e77-123">C’est ce que l’on appelle l' *accès concurrentiel pessimiste*.</span><span class="sxs-lookup"><span data-stu-id="e5e77-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="e5e77-124">Par exemple, avant de lire une ligne d’une base de données, vous demandez un verrou pour lecture seule ou pour accès avec mise à jour.</span><span class="sxs-lookup"><span data-stu-id="e5e77-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="e5e77-125">Si vous verrouillez une ligne pour accès avec mise à jour, aucun autre utilisateur n’est autorisé à verrouiller la ligne pour lecture seule ou pour accès avec mise à jour, car ils obtiendraient ainsi une copie de données qui sont en cours de modification.</span><span class="sxs-lookup"><span data-stu-id="e5e77-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="e5e77-126">Si vous verrouillez une ligne pour accès en lecture seule, d’autres utilisateurs peuvent également la verrouiller pour accès en lecture seule, mais pas pour accès avec mise à jour.</span><span class="sxs-lookup"><span data-stu-id="e5e77-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="e5e77-127">La gestion des verrous présente quelques inconvénients.</span><span class="sxs-lookup"><span data-stu-id="e5e77-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="e5e77-128">Elle peut être complexe à programmer.</span><span class="sxs-lookup"><span data-stu-id="e5e77-128">It can be complex to program.</span></span> <span data-ttu-id="e5e77-129">Elle nécessite des ressources de gestion de base de données importantes et peut entraîner des problèmes de performances au fur et à mesure que le nombre d’utilisateurs d’une application augmente (autrement dit, il n’est pas adapté).</span><span class="sxs-lookup"><span data-stu-id="e5e77-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="e5e77-130">Pour ces raisons, certains systèmes de gestion de base de données ne prennent pas en charge l’accès concurrentiel pessimiste.</span><span class="sxs-lookup"><span data-stu-id="e5e77-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="e5e77-131">Le Entity Framework ne fournit aucune prise en charge intégrée pour celui-ci, et ce didacticiel ne vous montre pas comment l’implémenter.</span><span class="sxs-lookup"><span data-stu-id="e5e77-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="e5e77-132">Accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="e5e77-132">Optimistic Concurrency</span></span>

<span data-ttu-id="e5e77-133">L’alternative à l’accès concurrentiel pessimiste est l' *accès concurrentiel optimiste*.</span><span class="sxs-lookup"><span data-stu-id="e5e77-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="e5e77-134">L’accès concurrentiel optimiste signifie autoriser la survenance des conflits d’accès concurrentiel, puis de réagir correctement quand ils surviennent.</span><span class="sxs-lookup"><span data-stu-id="e5e77-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="e5e77-135">Par exemple, John exécute la page *Department. aspx* , clique sur le lien **Edit** pour le département de l’historique et réduit le montant du **budget** de $1 000 000,00 à $125 000,00.</span><span class="sxs-lookup"><span data-stu-id="e5e77-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="e5e77-136">(John administre un service en concurrence et souhaite libérer de l’argent pour son propre service.)</span><span class="sxs-lookup"><span data-stu-id="e5e77-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="e5e77-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="e5e77-138">Pour que John clique sur **mettre à jour**, Jane exécute la même page, clique sur le lien **modifier** pour le département historique, puis remplace le champ **Date de début** 1/10/2011 par 1/1/1999.</span><span class="sxs-lookup"><span data-stu-id="e5e77-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="e5e77-139">(Jane administre le département de l’historique et veut lui apporter plus d’ancienneté.)</span><span class="sxs-lookup"><span data-stu-id="e5e77-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="e5e77-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="e5e77-141">John clique d’abord sur **Update** , puis Jane clique sur **Update**.</span><span class="sxs-lookup"><span data-stu-id="e5e77-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="e5e77-142">Le navigateur de Jane répertorie maintenant le montant du **budget** comme $1 000 000,00, mais cela est incorrect, car le montant a été modifié par John à $125 000,00.</span><span class="sxs-lookup"><span data-stu-id="e5e77-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="e5e77-143">Voici quelques-unes des actions que vous pouvez effectuer dans ce scénario :</span><span class="sxs-lookup"><span data-stu-id="e5e77-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="e5e77-144">Vous pouvez effectuer le suivi des propriétés modifiées par un utilisateur et mettre à jour seulement les colonnes correspondantes dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="e5e77-145">Dans l’exemple de scénario, aucune donnée ne serait perdue, car des propriétés différentes ont été mises à jour par chacun des deux utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="e5e77-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="e5e77-146">La prochaine fois qu’un utilisateur parcourt le département de l’historique, il verra 1/1/1999 et $125 000,00.</span><span class="sxs-lookup"><span data-stu-id="e5e77-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="e5e77-147">Il s’agit du comportement par défaut de la Entity Framework, qui peut réduire considérablement le nombre de conflits susceptibles de provoquer une perte de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="e5e77-148">Toutefois, ce comportement n’évite pas la perte de données si des modifications concurrentes sont apportées à la même propriété d’une entité.</span><span class="sxs-lookup"><span data-stu-id="e5e77-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="e5e77-149">En outre, ce comportement n’est pas toujours possible. Lorsque vous mappez des procédures stockées à un type d’entité, toutes les propriétés d’une entité sont mises à jour lorsque des modifications sont apportées à l’entité dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="e5e77-150">Vous pouvez laisser les modifications de Jane remplacer les modifications de John.</span><span class="sxs-lookup"><span data-stu-id="e5e77-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="e5e77-151">Lorsque Jane clique sur **Update**, le montant du **Budget** revient à $1 000 000,00.</span><span class="sxs-lookup"><span data-stu-id="e5e77-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="e5e77-152">Ceci s’appelle un scénario *Priorité au client* ou *Priorité au dernier entré* (Last in Wins).</span><span class="sxs-lookup"><span data-stu-id="e5e77-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="e5e77-153">(Les valeurs du client sont prioritaires par rapport à ce qui se trouve dans le magasin de données.)</span><span class="sxs-lookup"><span data-stu-id="e5e77-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="e5e77-154">Vous pouvez empêcher la mise à jour de la modification de Jane dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="e5e77-155">En règle générale, vous affichez un message d’erreur, affichez l’état actuel des données et autorisez-le à entrer à nouveau ses modifications s’il souhaite toujours les effectuer.</span><span class="sxs-lookup"><span data-stu-id="e5e77-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="e5e77-156">Vous pouvez poursuivre l’automatisation du processus en enregistrant son entrée et en lui donnant la possibilité de le réappliquer sans avoir à le réentrer.</span><span class="sxs-lookup"><span data-stu-id="e5e77-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="e5e77-157">Il s’agit alors d’un scénario *Priorité au magasin*.</span><span class="sxs-lookup"><span data-stu-id="e5e77-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="e5e77-158">(Les valeurs du magasin de données sont prioritaires par rapport à celles soumises par le client.)</span><span class="sxs-lookup"><span data-stu-id="e5e77-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="e5e77-159">Détection des conflits d’accès concurrentiel</span><span class="sxs-lookup"><span data-stu-id="e5e77-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="e5e77-160">Dans le Entity Framework, vous pouvez résoudre les conflits en gérant `OptimisticConcurrencyException` exceptions levées par l’Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="e5e77-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="e5e77-161">Pour savoir quand lever ces exceptions, Entity Framework doit être en mesure de détecter les conflits.</span><span class="sxs-lookup"><span data-stu-id="e5e77-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="e5e77-162">Par conséquent, vous devez configurer de façon appropriée la base de données et le modèle de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="e5e77-163">Voici quelques options pour l’activation de la détection des conflits :</span><span class="sxs-lookup"><span data-stu-id="e5e77-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="e5e77-164">Dans la base de données, incluez une colonne de table qui peut être utilisée pour déterminer quand une ligne a été modifiée.</span><span class="sxs-lookup"><span data-stu-id="e5e77-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="e5e77-165">Vous pouvez ensuite configurer la Entity Framework pour inclure cette colonne dans la clause `Where` des commandes `Update` ou `Delete` SQL.</span><span class="sxs-lookup"><span data-stu-id="e5e77-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="e5e77-166">C’est l’objectif de la colonne `Timestamp` dans la table `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="e5e77-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="e5e77-168">Le type de données de la colonne `Timestamp` est également appelé `Timestamp`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="e5e77-169">Toutefois, la colonne ne contient pas réellement une valeur de date ou d’heure.</span><span class="sxs-lookup"><span data-stu-id="e5e77-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="e5e77-170">Au lieu de cela, la valeur est un nombre séquentiel qui est incrémenté chaque fois que la ligne est mise à jour.</span><span class="sxs-lookup"><span data-stu-id="e5e77-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="e5e77-171">Dans une commande `Update` ou `Delete`, la clause `Where` contient la valeur `Timestamp` d’origine.</span><span class="sxs-lookup"><span data-stu-id="e5e77-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="e5e77-172">Si la ligne en cours de mise à jour a été modifiée par un autre utilisateur, la valeur de `Timestamp` est différente de la valeur d’origine, donc la clause `Where` ne retourne aucune ligne à mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="e5e77-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="e5e77-173">Lorsque le Entity Framework détecte qu’aucune ligne n’a été mise à jour par la commande `Update` ou `Delete` en cours (autrement dit, lorsque le nombre de lignes affectées est égal à zéro), il interprète cela comme un conflit d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="e5e77-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="e5e77-174">Configurez la Entity Framework pour inclure les valeurs d’origine de chaque colonne de la table dans la clause `Where` des commandes `Update` et `Delete`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="e5e77-175">Comme dans la première option, si quelque chose dans la ligne a changé depuis la première lecture de la ligne, la clause `Where` ne retourne pas de ligne à mettre à jour, que le Entity Framework interprète comme un conflit d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="e5e77-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="e5e77-176">Cette méthode est aussi efficace que l’utilisation d’un champ `Timestamp`, mais peut être inefficace.</span><span class="sxs-lookup"><span data-stu-id="e5e77-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="e5e77-177">Pour les tables de base de données qui contiennent de nombreuses colonnes, cela peut générer des clauses de `Where` très volumineuses et, dans une application Web, il peut être nécessaire de conserver de grandes quantités d’État.</span><span class="sxs-lookup"><span data-stu-id="e5e77-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="e5e77-178">La conservation d’un grand nombre d’États peut affecter les performances de l’application, car elle nécessite des ressources serveur (par exemple, un état de session) ou doit être incluse dans la page Web elle-même (par exemple, l’état d’affichage).</span><span class="sxs-lookup"><span data-stu-id="e5e77-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="e5e77-179">Dans ce didacticiel, vous allez ajouter la gestion des erreurs pour les conflits d’accès concurrentiel optimiste pour une entité qui n’a pas de propriété de suivi (l’entité `Department`) et pour une entité qui a une propriété de suivi (l’entité `OfficeAssignment`).</span><span class="sxs-lookup"><span data-stu-id="e5e77-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="e5e77-180">Gestion de l’accès concurrentiel optimiste sans propriété de suivi</span><span class="sxs-lookup"><span data-stu-id="e5e77-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="e5e77-181">Pour implémenter l’accès concurrentiel optimiste pour l’entité `Department`, qui n’a pas de propriété Tracking (`Timestamp`), vous allez effectuer les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="e5e77-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="e5e77-182">Modifiez le modèle de données pour activer le suivi d’accès concurrentiel pour les entités `Department`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="e5e77-183">Dans la classe `SchoolRepository`, gérez les exceptions d’accès concurrentiel dans la méthode `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="e5e77-184">Dans la page *Departments. aspx* , gérez les exceptions d’accès concurrentiel en affichant un message indiquant à l’utilisateur que les tentatives de modification ont échoué.</span><span class="sxs-lookup"><span data-stu-id="e5e77-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="e5e77-185">L’utilisateur peut alors voir les valeurs actuelles et réessayer les modifications si elles sont toujours nécessaires.</span><span class="sxs-lookup"><span data-stu-id="e5e77-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="e5e77-186">Activation du suivi des accès concurrentiels dans le modèle de données</span><span class="sxs-lookup"><span data-stu-id="e5e77-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="e5e77-187">Dans Visual Studio, ouvrez l’application Web Contoso University avec laquelle vous travailliez dans le didacticiel précédent de cette série.</span><span class="sxs-lookup"><span data-stu-id="e5e77-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="e5e77-188">Ouvrez *SchoolModel. edmx*et dans le concepteur de modèle de données, cliquez avec le bouton droit sur la propriété `Name` dans l’entité `Department`, puis cliquez sur **Propriétés**.</span><span class="sxs-lookup"><span data-stu-id="e5e77-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="e5e77-189">Dans la fenêtre **Propriétés** , affectez à la propriété `ConcurrencyMode` la valeur `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="e5e77-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="e5e77-191">Procédez de même pour les autres propriétés scalaires non-clé primaire (`Budget`, `StartDate`et `Administrator`). (Vous ne pouvez pas le faire pour les propriétés de navigation.) Cela spécifie que chaque fois que l’Entity Framework génère une `Update` ou `Delete` commande SQL pour mettre à jour l’entité `Department` dans la base de données, ces colonnes (avec les valeurs d’origine) doivent être incluses dans la clause `Where`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="e5e77-192">Si aucune ligne n’est trouvée lors de l’exécution de la commande `Update` ou `Delete`, le Entity Framework lèvera une exception d’accès concurrentiel optimiste.</span><span class="sxs-lookup"><span data-stu-id="e5e77-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="e5e77-193">Enregistrez et fermez le modèle de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="e5e77-194">Gestion des exceptions d’accès concurrentiel dans la couche DAL</span><span class="sxs-lookup"><span data-stu-id="e5e77-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="e5e77-195">Ouvrez *SchoolRepository.cs* et ajoutez l’instruction `using` suivante pour l’espace de noms `System.Data` :</span><span class="sxs-lookup"><span data-stu-id="e5e77-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="e5e77-196">Ajoutez la nouvelle méthode `SaveChanges` suivante, qui gère les exceptions d’accès concurrentiel optimiste :</span><span class="sxs-lookup"><span data-stu-id="e5e77-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="e5e77-197">Si une erreur d’accès concurrentiel se produit lorsque cette méthode est appelée, les valeurs de propriété de l’entité en mémoire sont remplacées par les valeurs actuellement présentes dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="e5e77-198">L’exception d’accès concurrentiel est levée de nouveau de sorte que la page Web puisse la gérer.</span><span class="sxs-lookup"><span data-stu-id="e5e77-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="e5e77-199">Dans les méthodes `DeleteDepartment` et `UpdateDepartment`, remplacez l’appel existant à `context.SaveChanges()` par un appel à `SaveChanges()` afin d’appeler la nouvelle méthode.</span><span class="sxs-lookup"><span data-stu-id="e5e77-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="e5e77-200">Gestion des exceptions d’accès concurrentiel dans la couche de présentation</span><span class="sxs-lookup"><span data-stu-id="e5e77-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="e5e77-201">Ouvrez *Departments. aspx* et ajoutez un attribut `OnDeleted="DepartmentsObjectDataSource_Deleted"` au contrôle `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="e5e77-202">La balise d’ouverture du contrôle ressemble maintenant à l’exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="e5e77-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="e5e77-203">Dans le contrôle `DepartmentsGridView`, spécifiez toutes les colonnes de table dans l’attribut `DataKeyNames`, comme indiqué dans l’exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="e5e77-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="e5e77-204">Notez que cela permet de créer des champs d’état d’affichage très volumineux, ce qui est l’une des raisons pour lesquelles l’utilisation d’un champ de suivi est généralement la meilleure façon de suivre les conflits d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="e5e77-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="e5e77-205">Ouvrez *Departments.aspx.cs* et ajoutez l’instruction `using` suivante pour l’espace de noms `System.Data` :</span><span class="sxs-lookup"><span data-stu-id="e5e77-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="e5e77-206">Ajoutez la nouvelle méthode suivante, que vous appelez à partir de la `Updated` du contrôle de source de données et `Deleted` gestionnaires d’événements pour gérer les exceptions d’accès concurrentiel :</span><span class="sxs-lookup"><span data-stu-id="e5e77-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="e5e77-207">Ce code vérifie le type d’exception et, s’il s’agit d’une exception d’accès concurrentiel, le code crée dynamiquement un contrôle `CustomValidator` qui, à son tour, affiche un message dans le contrôle `ValidationSummary`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="e5e77-208">Appelez la nouvelle méthode à partir du gestionnaire d’événements `Updated` que vous avez ajouté précédemment.</span><span class="sxs-lookup"><span data-stu-id="e5e77-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="e5e77-209">En outre, créez un gestionnaire d’événements de `Deleted` qui appelle la même méthode (mais ne fait rien d’autre) :</span><span class="sxs-lookup"><span data-stu-id="e5e77-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="e5e77-210">Test de l’accès concurrentiel optimiste dans la page services</span><span class="sxs-lookup"><span data-stu-id="e5e77-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="e5e77-211">Exécutez la page *Departments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="e5e77-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="e5e77-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="e5e77-213">Cliquez sur **modifier** dans une ligne et modifiez la valeur dans la colonne **budget** .</span><span class="sxs-lookup"><span data-stu-id="e5e77-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="e5e77-214">(N’oubliez pas que vous ne pouvez modifier que les enregistrements que vous avez créés pour ce didacticiel, car les enregistrements de base de données `School` existants contiennent des données non valides.</span><span class="sxs-lookup"><span data-stu-id="e5e77-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="e5e77-215">L’enregistrement du Département économie est un moyen sûr d’expérimenter.)</span><span class="sxs-lookup"><span data-stu-id="e5e77-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="e5e77-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="e5e77-217">Ouvrez une nouvelle fenêtre de navigateur et réexécutez la page (copiez l’URL de la zone d’adresse de la première fenêtre du navigateur vers la deuxième fenêtre du navigateur).</span><span class="sxs-lookup"><span data-stu-id="e5e77-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="e5e77-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="e5e77-219">Cliquez sur **modifier** sur la même ligne que vous avez modifiée précédemment et remplacez la valeur de **budget** par une valeur différente.</span><span class="sxs-lookup"><span data-stu-id="e5e77-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="e5e77-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="e5e77-221">Dans la deuxième fenêtre du navigateur, cliquez sur **mettre à jour**.</span><span class="sxs-lookup"><span data-stu-id="e5e77-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="e5e77-222">Le montant du **budget** est correctement modifié en cette nouvelle valeur.</span><span class="sxs-lookup"><span data-stu-id="e5e77-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="e5e77-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="e5e77-224">Dans la première fenêtre du navigateur, cliquez sur **mettre à jour**.</span><span class="sxs-lookup"><span data-stu-id="e5e77-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="e5e77-225">La mise à jour échoue.</span><span class="sxs-lookup"><span data-stu-id="e5e77-225">The update fails.</span></span> <span data-ttu-id="e5e77-226">Le montant du **budget** est réaffiché à l’aide de la valeur que vous avez définie dans la deuxième fenêtre de navigateur et un message d’erreur s’affiche.</span><span class="sxs-lookup"><span data-stu-id="e5e77-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="e5e77-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="e5e77-228">Gestion de l’accès concurrentiel optimiste à l’aide d’une propriété Tracking</span><span class="sxs-lookup"><span data-stu-id="e5e77-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="e5e77-229">Pour gérer l’accès concurrentiel optimiste pour une entité qui a une propriété de suivi, vous devez effectuer les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="e5e77-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="e5e77-230">Ajoutez des procédures stockées au modèle de données pour gérer les entités `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="e5e77-231">(Les propriétés de suivi et les procédures stockées n’ont pas besoin d’être utilisées ensemble ; elles sont simplement regroupées ici à titre d’illustration.)</span><span class="sxs-lookup"><span data-stu-id="e5e77-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="e5e77-232">Ajoutez des méthodes CRUD à la couche DAL et à la couche BLL pour `OfficeAssignment` entités, y compris du code pour gérer les exceptions d’accès concurrentiel optimiste dans la couche DAL.</span><span class="sxs-lookup"><span data-stu-id="e5e77-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="e5e77-233">Créer une page Web d’affectations de bureaux.</span><span class="sxs-lookup"><span data-stu-id="e5e77-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="e5e77-234">Test de l’accès concurrentiel optimiste dans la nouvelle page Web.</span><span class="sxs-lookup"><span data-stu-id="e5e77-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="e5e77-235">Ajout de procédures stockées OfficeAssignment au modèle de données</span><span class="sxs-lookup"><span data-stu-id="e5e77-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="e5e77-236">Ouvrez le fichier *SchoolModel. edmx* dans le générateur de modèles, cliquez avec le bouton droit sur l’aire de conception, puis cliquez sur **mettre à jour le modèle à partir de la base de données**.</span><span class="sxs-lookup"><span data-stu-id="e5e77-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="e5e77-237">Dans l’onglet **Ajouter** de la boîte **de dialogue choisir vos objets de base de données** , développez **procédures stockées** , puis sélectionnez les trois `OfficeAssignment` procédures stockées (voir la capture d’écran suivante), puis cliquez sur **Terminer**.</span><span class="sxs-lookup"><span data-stu-id="e5e77-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="e5e77-238">(Ces procédures stockées se trouvaient déjà dans la base de données lorsque vous l’avez téléchargée ou créée à l’aide d’un script.)</span><span class="sxs-lookup"><span data-stu-id="e5e77-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="e5e77-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="e5e77-240">Cliquez avec le bouton droit sur l’entité `OfficeAssignment`, puis sélectionnez **mappage de procédure stockée**.</span><span class="sxs-lookup"><span data-stu-id="e5e77-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="e5e77-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="e5e77-242">Définissez les fonctions **Insert**, **Update**et **Delete** pour utiliser leurs procédures stockées correspondantes.</span><span class="sxs-lookup"><span data-stu-id="e5e77-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="e5e77-243">Pour le paramètre `OrigTimestamp` de la fonction `Update`, affectez à la **propriété** la valeur `Timestamp` et sélectionnez l’option **utiliser la valeur d’origine** .</span><span class="sxs-lookup"><span data-stu-id="e5e77-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="e5e77-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="e5e77-245">Lorsque le Entity Framework appelle la procédure stockée `UpdateOfficeAssignment`, il passe la valeur d’origine de la colonne `Timestamp` dans le paramètre `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="e5e77-246">La procédure stockée utilise ce paramètre dans sa clause `Where` :</span><span class="sxs-lookup"><span data-stu-id="e5e77-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="e5e77-247">La procédure stockée sélectionne également la nouvelle valeur de la colonne `Timestamp` après la mise à jour afin que l’Entity Framework puisse conserver la synchronisation de l’entité `OfficeAssignment` en mémoire avec la ligne de base de données correspondante.</span><span class="sxs-lookup"><span data-stu-id="e5e77-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="e5e77-248">(Notez que la procédure stockée de suppression d’une affectation Office n’a pas de paramètre `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="e5e77-249">Pour cette raison, le Entity Framework ne peut pas vérifier qu’une entité est inchangée avant de la supprimer.)</span><span class="sxs-lookup"><span data-stu-id="e5e77-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="e5e77-250">Enregistrez et fermez le modèle de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="e5e77-251">Ajout de méthodes OfficeAssignment à la couche DAL</span><span class="sxs-lookup"><span data-stu-id="e5e77-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="e5e77-252">Ouvrez *ISchoolRepository.cs* et ajoutez les méthodes CRUD suivantes pour le jeu d’entités `OfficeAssignment` :</span><span class="sxs-lookup"><span data-stu-id="e5e77-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="e5e77-253">Ajoutez les nouvelles méthodes suivantes à *SchoolRepository.cs*.</span><span class="sxs-lookup"><span data-stu-id="e5e77-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="e5e77-254">Dans la méthode `UpdateOfficeAssignment`, vous appelez la méthode `SaveChanges` locale au lieu de `context.SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="e5e77-255">Dans le projet de test, ouvrez *MockSchoolRepository.cs* et ajoutez-y la collection `OfficeAssignment` suivante et les méthodes CRUD.</span><span class="sxs-lookup"><span data-stu-id="e5e77-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="e5e77-256">(Le référentiel factice doit implémenter l’interface du référentiel, sinon la solution ne sera pas compilée.)</span><span class="sxs-lookup"><span data-stu-id="e5e77-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="e5e77-257">Ajout de méthodes OfficeAssignment à la couche BLL</span><span class="sxs-lookup"><span data-stu-id="e5e77-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="e5e77-258">Dans le projet principal, ouvrez *SchoolBL.cs* et ajoutez-lui les méthodes CRUD suivantes pour le jeu d’entités `OfficeAssignment` :</span><span class="sxs-lookup"><span data-stu-id="e5e77-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="e5e77-259">Création d’une page Web OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="e5e77-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="e5e77-260">Créez une nouvelle page Web qui utilise la page maître *site. Master* et nommez-la *OfficeAssignments. aspx*.</span><span class="sxs-lookup"><span data-stu-id="e5e77-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="e5e77-261">Ajoutez le balisage suivant au contrôle `Content` nommé `Content2`:</span><span class="sxs-lookup"><span data-stu-id="e5e77-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="e5e77-262">Notez que dans l’attribut `DataKeyNames`, le balisage spécifie la propriété `Timestamp` ainsi que la clé d’enregistrement (`InstructorID`).</span><span class="sxs-lookup"><span data-stu-id="e5e77-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="e5e77-263">Si vous spécifiez des propriétés dans l’attribut `DataKeyNames`, le contrôle les enregistre dans l’état du contrôle (ce qui est semblable à l’état d’affichage) afin que les valeurs d’origine soient disponibles pendant le traitement de la publication (postback).</span><span class="sxs-lookup"><span data-stu-id="e5e77-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="e5e77-264">Si vous n’avez pas enregistré la valeur `Timestamp`, la Entity Framework ne l’aurait pas pour la clause `Where` de la commande SQL `Update`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="e5e77-265">Par conséquent, rien n’est trouvé à mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="e5e77-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="e5e77-266">Par conséquent, le Entity Framework lèvera une exception d’accès concurrentiel optimiste chaque fois qu’une entité `OfficeAssignment` est mise à jour.</span><span class="sxs-lookup"><span data-stu-id="e5e77-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="e5e77-267">Ouvrez *OfficeAssignments.aspx.cs* et ajoutez l’instruction `using` suivante pour la couche d’accès aux données :</span><span class="sxs-lookup"><span data-stu-id="e5e77-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="e5e77-268">Ajoutez la méthode `Page_Init` suivante, qui active les fonctionnalités de Dynamic Data.</span><span class="sxs-lookup"><span data-stu-id="e5e77-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="e5e77-269">Ajoutez également le gestionnaire suivant pour l’événement `Updated` du contrôle `ObjectDataSource` afin de vérifier les erreurs d’accès concurrentiel :</span><span class="sxs-lookup"><span data-stu-id="e5e77-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="e5e77-270">Test de l’accès concurrentiel optimiste dans la page OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="e5e77-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="e5e77-271">Exécutez la page *OfficeAssignments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="e5e77-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="e5e77-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="e5e77-273">Cliquez sur **modifier** dans une ligne et modifiez la valeur dans la colonne **emplacement** .</span><span class="sxs-lookup"><span data-stu-id="e5e77-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="e5e77-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="e5e77-275">Ouvrez une nouvelle fenêtre de navigateur et réexécutez la page (copiez l’URL de la première fenêtre du navigateur vers la deuxième fenêtre du navigateur).</span><span class="sxs-lookup"><span data-stu-id="e5e77-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="e5e77-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="e5e77-277">Cliquez sur **modifier** dans la ligne que vous avez modifiée précédemment et remplacez la valeur d' **emplacement** par une valeur différente.</span><span class="sxs-lookup"><span data-stu-id="e5e77-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="e5e77-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="e5e77-279">Dans la deuxième fenêtre du navigateur, cliquez sur **mettre à jour**.</span><span class="sxs-lookup"><span data-stu-id="e5e77-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="e5e77-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="e5e77-281">Basculez vers la première fenêtre de navigateur, puis cliquez sur **mettre à jour**.</span><span class="sxs-lookup"><span data-stu-id="e5e77-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="e5e77-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="e5e77-283">Vous voyez un message d’erreur et la valeur d' **emplacement** a été mise à jour pour afficher la valeur que vous avez remplacée par dans la deuxième fenêtre de navigateur.</span><span class="sxs-lookup"><span data-stu-id="e5e77-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="e5e77-284">Gestion de l’accès concurrentiel avec le contrôle EntityDataSource</span><span class="sxs-lookup"><span data-stu-id="e5e77-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="e5e77-285">Le contrôle `EntityDataSource` comprend une logique intégrée qui reconnaît les paramètres de concurrence dans le modèle de données et gère les opérations de mise à jour et de suppression en conséquence.</span><span class="sxs-lookup"><span data-stu-id="e5e77-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="e5e77-286">Toutefois, comme avec toutes les exceptions, vous devez gérer les exceptions de `OptimisticConcurrencyException` vous-même pour fournir un message d’erreur convivial.</span><span class="sxs-lookup"><span data-stu-id="e5e77-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="e5e77-287">Ensuite, vous allez configurer la page *courses. aspx* (qui utilise un contrôle `EntityDataSource`) pour autoriser les opérations de mise à jour et de suppression et afficher un message d’erreur si un conflit d’accès concurrentiel se produit.</span><span class="sxs-lookup"><span data-stu-id="e5e77-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="e5e77-288">L’entité `Course` n’a pas de colonne de suivi d’accès concurrentiel. vous allez donc utiliser la même méthode que celle que vous avez utilisée avec l’entité `Department` : suivre les valeurs de toutes les propriétés non-clés.</span><span class="sxs-lookup"><span data-stu-id="e5e77-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="e5e77-289">Ouvrez le fichier *SchoolModel. edmx* .</span><span class="sxs-lookup"><span data-stu-id="e5e77-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="e5e77-290">Pour les propriétés non-clés de l’entité `Course` (`Title`, `Credits`et `DepartmentID`), affectez à la propriété **mode d’accès concurrentiel** la valeur `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="e5e77-291">Ensuite, enregistrez et fermez le modèle de données.</span><span class="sxs-lookup"><span data-stu-id="e5e77-291">Then save and close the data model.</span></span>

<span data-ttu-id="e5e77-292">Ouvrez la page *courses. aspx* et apportez les modifications suivantes :</span><span class="sxs-lookup"><span data-stu-id="e5e77-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="e5e77-293">Dans le contrôle `CoursesEntityDataSource`, ajoutez des attributs `EnableUpdate="true"` et `EnableDelete="true"`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="e5e77-294">La balise d’ouverture pour ce contrôle ressemble maintenant à l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="e5e77-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="e5e77-295">Dans le contrôle `CoursesGridView`, remplacez la valeur de l’attribut `DataKeyNames` par `"CourseID,Title,Credits,DepartmentID"`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="e5e77-296">Ajoutez ensuite un élément `CommandField` à l’élément `Columns` qui affiche les boutons **modifier** et **supprimer** (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span><span class="sxs-lookup"><span data-stu-id="e5e77-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="e5e77-297">Le contrôle `GridView` ressemble maintenant à l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="e5e77-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="e5e77-298">Exécutez la page et créez une situation de conflit comme vous l’avez fait précédemment dans la page services.</span><span class="sxs-lookup"><span data-stu-id="e5e77-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="e5e77-299">Exécutez la page dans deux fenêtres de navigateur, cliquez sur **modifier** sur la même ligne dans chaque fenêtre et apportez une autre modification dans chacune d’elles.</span><span class="sxs-lookup"><span data-stu-id="e5e77-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="e5e77-300">Cliquez sur **mettre à jour** dans une fenêtre, puis cliquez sur **mettre à jour** dans l’autre fenêtre.</span><span class="sxs-lookup"><span data-stu-id="e5e77-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="e5e77-301">Lorsque vous cliquez sur **mettre à jour** la deuxième fois, vous voyez la page d’erreur qui résulte d’une exception d’accès concurrentiel non gérée.</span><span class="sxs-lookup"><span data-stu-id="e5e77-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="e5e77-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="e5e77-303">Vous gérez cette erreur de manière très similaire à la façon dont vous l’avez gérée pour le contrôle de `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="e5e77-304">Ouvrez la page *courses. aspx* et, dans le contrôle `CoursesEntityDataSource`, spécifiez des gestionnaires pour les événements `Deleted` et `Updated`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="e5e77-305">La balise d’ouverture du contrôle ressemble maintenant à l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="e5e77-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="e5e77-306">Avant le contrôle `CoursesGridView`, ajoutez le contrôle `ValidationSummary` suivant :</span><span class="sxs-lookup"><span data-stu-id="e5e77-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="e5e77-307">Dans *courses.aspx.cs*, ajoutez une instruction `using` pour l’espace de noms `System.Data`, ajoutez une méthode qui vérifie les exceptions d’accès concurrentiel et ajoutez des gestionnaires pour les gestionnaires `Updated` et `Deleted` du contrôle `EntityDataSource`.</span><span class="sxs-lookup"><span data-stu-id="e5e77-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="e5e77-308">Le code ressemble à ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="e5e77-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="e5e77-309">La seule différence entre ce code et ce que vous avez fait pour le contrôle de `ObjectDataSource` est que dans ce cas, l’exception d’accès concurrentiel est dans la propriété `Exception` de l’objet d’arguments d’événement plutôt que dans la propriété `InnerException` de cette exception.</span><span class="sxs-lookup"><span data-stu-id="e5e77-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="e5e77-310">Exécutez la page et réessayez de créer un conflit d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="e5e77-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="e5e77-311">Cette fois, un message d’erreur s’affiche :</span><span class="sxs-lookup"><span data-stu-id="e5e77-311">This time you see an error message:</span></span>

<span data-ttu-id="e5e77-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="e5e77-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="e5e77-313">Ceci termine l’introduction à la gestion des conflits d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="e5e77-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="e5e77-314">Le didacticiel suivant fournit des conseils sur la façon d’améliorer les performances dans une application Web qui utilise le Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="e5e77-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="e5e77-315">[Précédent](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
> [Suivant](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="e5e77-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
