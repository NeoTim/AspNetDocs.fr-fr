---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
title: Implémentation de l’accès concurrentiel optimiste avec SqlDataSource (c#) | Microsoft Docs
author: rick-anderson
description: Dans ce didacticiel, nous passez en revue les éléments essentiels de contrôle d’accès concurrentiel optimiste et puis Explorez comment l’implémenter à l’aide du contrôle SqlDataSource.
ms.author: riande
ms.date: 02/20/2007
ms.assetid: df999966-ac48-460e-b82b-4877a57d6ab9
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
msc.type: authoredcontent
ms.openlocfilehash: f2590e8e7712d719eb89403ef839f03066a93d2b
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/01/2019
ms.locfileid: "57036076"
---
<a name="implementing-optimistic-concurrency-with-the-sqldatasource-c"></a><span data-ttu-id="43aa6-103">Implémentation de l’accès concurrentiel optimiste avec SqlDataSource (C#)</span><span class="sxs-lookup"><span data-stu-id="43aa6-103">Implementing Optimistic Concurrency with the SqlDataSource (C#)</span></span>
====================
<span data-ttu-id="43aa6-104">par [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="43aa6-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="43aa6-105">[Télécharger l’exemple d’application](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) ou [télécharger le PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="43aa6-105">[Download Sample App](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) or [Download PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span></span>

> <span data-ttu-id="43aa6-106">Dans ce didacticiel, nous passez en revue les éléments essentiels de contrôle d’accès concurrentiel optimiste et puis Explorez comment l’implémenter à l’aide du contrôle SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="43aa6-106">In this tutorial we review the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource control.</span></span>


## <a name="introduction"></a><span data-ttu-id="43aa6-107">Introduction</span><span class="sxs-lookup"><span data-stu-id="43aa6-107">Introduction</span></span>

<span data-ttu-id="43aa6-108">Dans le didacticiel précédent, nous avons examiné comment ajouter l’insertion, de la mise à jour et de suppression des fonctionnalités au contrôle SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="43aa6-108">In the preceding tutorial we examined how to add inserting, updating, and deleting capabilities to the SqlDataSource control.</span></span> <span data-ttu-id="43aa6-109">En bref, pour fournir ces fonctionnalités nous avions besoin spécifier le correspondantes `INSERT`, `UPDATE`, ou `DELETE` instruction SQL dans le contrôle s `InsertCommand`, `UpdateCommand`, ou `DeleteCommand` propriétés, ainsi que le texte approprié paramètres dans le `InsertParameters`, `UpdateParameters`, et `DeleteParameters` collections.</span><span class="sxs-lookup"><span data-stu-id="43aa6-109">In short, to provide these features we needed to specify the corresponding `INSERT`, `UPDATE`, or `DELETE` SQL statement in the control s `InsertCommand`, `UpdateCommand`, or `DeleteCommand` properties, along with the appropriate parameters in the `InsertParameters`, `UpdateParameters`, and `DeleteParameters` collections.</span></span> <span data-ttu-id="43aa6-110">Bien que ces propriétés et les collections peuvent être spécifiées manuellement, le bouton Avancé de configurer la Source de données Assistant s offre un générer `INSERT`, `UPDATE`, et `DELETE` case à cocher des instructions qui crée automatiquement ces instructions basé sur le `SELECT` instruction.</span><span class="sxs-lookup"><span data-stu-id="43aa6-110">While these properties and collections can be specified manually, the Configure Data Source wizard s Advanced button offers a Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox that will auto-create these statements based on the `SELECT` statement.</span></span>

<span data-ttu-id="43aa6-111">En même temps que la génération `INSERT`, `UPDATE`, et `DELETE` instructions case à cocher, la boîte de dialogue Options de génération SQL avancées inclut une option de l’accès concurrentiel optimiste utiliser (voir Figure 1).</span><span class="sxs-lookup"><span data-stu-id="43aa6-111">Along with the Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox, the Advanced SQL Generation Options dialog box includes a Use optimistic concurrency option (see Figure 1).</span></span> <span data-ttu-id="43aa6-112">Lorsqu’elle est activée, le `WHERE` clauses dans le nom généré automatiquement `UPDATE` et `DELETE` instructions ont été modifiées pour effectuer uniquement la mise à jour ou de suppression si t ne données base de données sous-jacente été modifiée depuis l’utilisateur dernier chargée des données dans la grille.</span><span class="sxs-lookup"><span data-stu-id="43aa6-112">When checked, the `WHERE` clauses in the autogenerated `UPDATE` and `DELETE` statements are modified to only perform the update or delete if the underlying database data hasn t been modified since the user last loaded the data into the grid.</span></span>


![Vous pouvez ajouter la prise en charge de l’accès concurrentiel optimiste à partir de l’avancée boîte de dialogue Options de génération SQL](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.gif)

<span data-ttu-id="43aa6-114">**Figure 1**: Vous pouvez ajouter la prise en charge de l’accès concurrentiel optimiste à partir de l’avancée boîte de dialogue Options de génération SQL</span><span class="sxs-lookup"><span data-stu-id="43aa6-114">**Figure 1**: You Can Add Optimistic Concurrency Support from the Advanced SQL Generation Options Dialog Box</span></span>


<span data-ttu-id="43aa6-115">Dans le [implémentation de l’accès concurrentiel optimiste](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) didacticiel, nous avons examiné les principes fondamentaux du contrôle d’accès concurrentiel optimiste et comment l’ajouter à ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="43aa6-115">Back in the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial we examined the fundamentals of optimistic concurrency control and how to add it to the ObjectDataSource.</span></span> <span data-ttu-id="43aa6-116">Dans ce didacticiel nous retoucher sur l’essentiel de contrôle d’accès concurrentiel optimiste et puis Explorez comment l’implémenter à l’aide de SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="43aa6-116">In this tutorial we'll retouch on the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource.</span></span>

## <a name="a-recap-of-optimistic-concurrency"></a><span data-ttu-id="43aa6-117">Un récapitulatif de l’accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="43aa6-117">A Recap of Optimistic Concurrency</span></span>

<span data-ttu-id="43aa6-118">Pour les applications web qui permettent à plusieurs utilisateurs simultanés pour modifier ou supprimer les mêmes données, il existe un risque qu’un utilisateur peut remplacer accidentellement un autre modifie s.</span><span class="sxs-lookup"><span data-stu-id="43aa6-118">For web applications that allow multiple, simultaneous users to edit or delete the same data, there exists a possibility that one user may accidentally overwrite another s changes.</span></span> <span data-ttu-id="43aa6-119">Dans le [implémentation de l’accès concurrentiel optimiste](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) didacticiel que je fournis à l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="43aa6-119">In the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial I provided the following example:</span></span>

<span data-ttu-id="43aa6-120">Imaginez que deux utilisateurs, Jisun et Sam, ont été les deux accédant à une page dans une application qui a autorisé les visiteurs à mettre à jour et supprimer des produits à travers un contrôle GridView.</span><span class="sxs-lookup"><span data-stu-id="43aa6-120">Imagine that two users, Jisun and Sam, were both visiting a page in an application that allowed visitors to update and delete products through a GridView control.</span></span> <span data-ttu-id="43aa6-121">Cliquez sur le bouton Modifier pour Chai en même temps.</span><span class="sxs-lookup"><span data-stu-id="43aa6-121">Both click the Edit button for Chai around the same time.</span></span> <span data-ttu-id="43aa6-122">Jisun modifie le nom du produit à Chai thé et clique sur le bouton de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="43aa6-122">Jisun changes the product name to Chai Tea and clicks the Update button.</span></span> <span data-ttu-id="43aa6-123">Le résultat net est une `UPDATE` instruction est envoyée à la base de données définit *tous les* des champs modifiables produit s (même si Jisun mise à jour uniquement un champ, `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="43aa6-123">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product s updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="43aa6-124">À ce stade, la base de données a les valeurs Chai thé, la catégorie boissons, liquides exotiques fournisseur, et ainsi de suite de ce produit particulier.</span><span class="sxs-lookup"><span data-stu-id="43aa6-124">At this point in time, the database has the values Chai Tea, the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="43aa6-125">Toutefois, le contrôle GridView à l’écran de s Sam affiche toujours le nom du produit dans la ligne GridView modifiable en tant que Chai.</span><span class="sxs-lookup"><span data-stu-id="43aa6-125">However, the GridView on Sam s screen still shows the product name in the editable GridView row as Chai.</span></span> <span data-ttu-id="43aa6-126">Quelques secondes après que Jisun s modifications ont été validées, Sam met à jour de la catégorie à Condiments et clique sur mise à jour.</span><span class="sxs-lookup"><span data-stu-id="43aa6-126">A few seconds after Jisun s changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="43aa6-127">Il en résulte un `UPDATE` instruction envoyée à la base de données qui définit le nom du produit qui correspond à Chai, le `CategoryID` à l’ID de catégorie Condiments correspondant et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="43aa6-127">This results in an `UPDATE` statement sent to the database that sets the product name to Chai, the `CategoryID` to the corresponding Condiments category ID, and so on.</span></span> <span data-ttu-id="43aa6-128">Modifications de s Jisun au nom du produit ont été remplacées.</span><span class="sxs-lookup"><span data-stu-id="43aa6-128">Jisun s changes to the product name have been overwritten.</span></span>

<span data-ttu-id="43aa6-129">La figure 2 illustre cette interaction.</span><span class="sxs-lookup"><span data-stu-id="43aa6-129">Figure 2 illustrates this interaction.</span></span>


<span data-ttu-id="43aa6-130">[![Lorsque deux utilisateurs mettre à jour simultanément un enregistrement il s pour un utilisateur s les modifications potentielles pour remplacer les autres opérations de mappage](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="43aa6-130">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span></span>

<span data-ttu-id="43aa6-131">**Figure 2**: Lorsque deux utilisateurs simultanément mettre à jour un enregistrement il s potentiel pour un utilisateur s modifie à remplacer les autres opérations de mappage ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="43aa6-131">**Figure 2**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span></span>


<span data-ttu-id="43aa6-132">Pour éviter ce type de dépliage, une forme de [contrôle d’accès concurrentiel](http://en.wikipedia.org/wiki/Concurrency_control) doit être implémentée.</span><span class="sxs-lookup"><span data-stu-id="43aa6-132">To prevent this scenario from unfolding, a form of [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) must be implemented.</span></span> <span data-ttu-id="43aa6-133">[L’accès concurrentiel optimiste](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) l’objectif de ce didacticiel fonctionne sur l’hypothèse que bien que les conflits d’accès concurrentiel peut être ainsi, la grande majorité du temps ces conflits a gagné t surviennent.</span><span class="sxs-lookup"><span data-stu-id="43aa6-133">[Optimistic concurrency](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) the focus of this tutorial works on the assumption that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won t arise.</span></span> <span data-ttu-id="43aa6-134">Par conséquent, si un conflit se produit, contrôle d’accès concurrentiel optimiste informe simplement l’utilisateur enregistrer leur modifications impossible, car un autre utilisateur a modifié les mêmes données.</span><span class="sxs-lookup"><span data-stu-id="43aa6-134">Therefore, if a conflict does arise, optimistic concurrency control simply informs the user that their changes can t be saved because another user has modified the same data.</span></span>

> [!NOTE]
> <span data-ttu-id="43aa6-135">Pour les applications où il est supposé qu’il y aura plusieurs conflits d’accès concurrentiel ou si ces conflits sont inacceptables, puis d’accès concurrentiel pessimiste contrôle peut être utilisé à la place.</span><span class="sxs-lookup"><span data-stu-id="43aa6-135">For applications where it is assumed that there will be many concurrency conflicts or if such conflicts are not tolerable, then pessimistic concurrency control can be used instead.</span></span> <span data-ttu-id="43aa6-136">Faire référence à la [implémentation de l’accès concurrentiel optimiste](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) didacticiel pour une discussion plus détaillée sur le contrôle d’accès concurrentiel pessimiste.</span><span class="sxs-lookup"><span data-stu-id="43aa6-136">Refer back to the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial for a more thorough discussion on pessimistic concurrency control.</span></span>


<span data-ttu-id="43aa6-137">Contrôle d’accès concurrentiel optimiste fonctionne en veillant à ce que l’enregistrement en cours de mise à jour ou supprimé a les mêmes valeurs, comme c’était le cas au démarrage de la mise à jour ou la suppression des processus.</span><span class="sxs-lookup"><span data-stu-id="43aa6-137">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="43aa6-138">Par exemple, lorsque vous cliquez sur le bouton Modifier dans un GridView modifiable, les valeurs de l’enregistrement s sont lire à partir de la base de données et affichées dans les zones de texte et d’autres contrôles Web.</span><span class="sxs-lookup"><span data-stu-id="43aa6-138">For example, when clicking the Edit button in an editable GridView, the record s values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="43aa6-139">Ces valeurs d’origine sont enregistrés par le contrôle GridView.</span><span class="sxs-lookup"><span data-stu-id="43aa6-139">These original values are saved by the GridView.</span></span> <span data-ttu-id="43aa6-140">Versions ultérieures, une fois que l’utilisateur modifie son et clique sur le bouton de mise à jour, la `UPDATE` instruction utilisée doit prendre en compte les valeurs d’origine ainsi que les nouvelles valeurs et uniquement mettre à jour l’enregistrement de base de données sous-jacent si les valeurs d’origine que l’utilisateur a commencé à modifier sont identiques aux valeurs toujours dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="43aa6-140">Later, after the user makes her changes and clicks the Update button, the `UPDATE` statement used must take into account the original values plus the new values and only update the underlying database record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="43aa6-141">Figure 3 illustre cette séquence d’événements.</span><span class="sxs-lookup"><span data-stu-id="43aa6-141">Figure 3 depicts this sequence of events.</span></span>


<span data-ttu-id="43aa6-142">[![Pour la mise à jour ou la suppression réussisse, les valeurs d’origine doivent être égales pour les valeurs actuelles de la base de données](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="43aa6-142">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span></span>

<span data-ttu-id="43aa6-143">**Figure 3**: Pour la mise à jour ou de suppression pour réussir, le d’origine valeurs doit être égale aux valeurs de base de données ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="43aa6-143">**Figure 3**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span></span>


<span data-ttu-id="43aa6-144">Il existe différentes approches d’implémentation de l’accès concurrentiel optimiste (consultez [Peter A. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp) s [logique de la mise à jour d’accès concurrentiel Optmistic](http://www.eggheadcafe.com/articles/20050719.asp) pour un bref aperçu présentant un nombre d’options).</span><span class="sxs-lookup"><span data-stu-id="43aa6-144">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp) s [Optmistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="43aa6-145">La technique utilisée par SqlDataSource (ainsi que par le typés ADO.NET utilisé dans notre couche d’accès aux données) renforce la `WHERE` clause pour inclure une comparaison de toutes les valeurs d’origine.</span><span class="sxs-lookup"><span data-stu-id="43aa6-145">The technique used by the SqlDataSource (as well as by the ADO.NET Typed DataSets used in our Data Access Layer) augments the `WHERE` clause to include a comparison of all of the original values.</span></span> <span data-ttu-id="43aa6-146">Ce qui suit `UPDATE` instruction, par exemple, des mises à jour le nom et le prix d’un produit uniquement si les valeurs actuelles de la base de données sont égales aux valeurs qui ont été récupérées à l’origine lors de la mise à jour l’enregistrement dans le contrôle GridView.</span><span class="sxs-lookup"><span data-stu-id="43aa6-146">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="43aa6-147">Le `@ProductName` et `@UnitPrice` paramètres contiennent les nouvelles valeurs entrées par l’utilisateur, tandis que `@original_ProductName` et `@original_UnitPrice` contiennent les valeurs qui ont été chargées à l’origine dans le contrôle GridView lorsque l’utilisateur a cliqué sur le bouton Modifier :</span><span class="sxs-lookup"><span data-stu-id="43aa6-147">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample1.sql)]

<span data-ttu-id="43aa6-148">Comme nous le verrons dans ce didacticiel, il est aussi simple que la vérification d’une case à cocher de l’activation du contrôle d’accès concurrentiel optimiste avec SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="43aa6-148">As we'll see in this tutorial, enabling optimistic concurrency control with the SqlDataSource is as simple as checking a checkbox.</span></span>

## <a name="step-1-creating-a-sqldatasource-that-supports-optimistic-concurrency"></a><span data-ttu-id="43aa6-149">Étape 1 : Création d’un SqlDataSource prenant en charge l’accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="43aa6-149">Step 1: Creating a SqlDataSource that Supports Optimistic Concurrency</span></span>

<span data-ttu-id="43aa6-150">Commencez par ouvrir le `OptimisticConcurrency.aspx` page à partir de la `SqlDataSource` dossier.</span><span class="sxs-lookup"><span data-stu-id="43aa6-150">Start by opening the `OptimisticConcurrency.aspx` page from the `SqlDataSource` folder.</span></span> <span data-ttu-id="43aa6-151">Faites glisser un contrôle SqlDataSource à partir de la boîte à outils vers le concepteur, les paramètres de son `ID` propriété `ProductsDataSourceWithOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="43aa6-151">Drag a SqlDataSource control from the Toolbox onto the Designer, settings its `ID` property to `ProductsDataSourceWithOptimisticConcurrency`.</span></span> <span data-ttu-id="43aa6-152">Ensuite, cliquez sur le lien configurer la Source de données à partir de la balise active de contrôle s.</span><span class="sxs-lookup"><span data-stu-id="43aa6-152">Next, click on the Configure Data Source link from the control s smart tag.</span></span> <span data-ttu-id="43aa6-153">Dans le premier écran dans l’Assistant, choisissez de travailler avec le `NORTHWINDConnectionString` et cliquez sur Suivant.</span><span class="sxs-lookup"><span data-stu-id="43aa6-153">From the first screen in the wizard, choose to work with the `NORTHWINDConnectionString` and click Next.</span></span>


<span data-ttu-id="43aa6-154">[![Choisissez de travailler avec le NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="43aa6-154">[![Choose to Work with the NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span></span>

<span data-ttu-id="43aa6-155">**Figure 4**: Choisissez de travailler avec les `NORTHWINDConnectionString` ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="43aa6-155">**Figure 4**: Choose to Work with the `NORTHWINDConnectionString` ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span></span>


<span data-ttu-id="43aa6-156">Pour cet exemple, nous ajouterons un GridView qui permet aux utilisateurs de modifier le `Products` table.</span><span class="sxs-lookup"><span data-stu-id="43aa6-156">For this example we'll be adding a GridView that enables users to edit the `Products` table.</span></span> <span data-ttu-id="43aa6-157">Par conséquent, à partir de la configuration de l’écran de l’instruction Select, choisissez le `Products` table dans la liste déroulante et sélectionnez le `ProductID`, `ProductName`, `UnitPrice`, et `Discontinued` colonnes, comme illustré à la Figure 5.</span><span class="sxs-lookup"><span data-stu-id="43aa6-157">Therefore, from the Configure the Select Statement screen, choose the `Products` table from the drop-down list and select the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` columns, as shown in Figure 5.</span></span>


<span data-ttu-id="43aa6-158">[![À partir de la Table Products, retourner le ProductID, ProductName, UnitPrice et les colonnes supprimées](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="43aa6-158">[![From the Products Table, Return the ProductID, ProductName, UnitPrice, and Discontinued Columns](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span></span>

<span data-ttu-id="43aa6-159">**Figure 5**: À partir de la `Products` Table, retournez le `ProductID`, `ProductName`, `UnitPrice`, et `Discontinued` colonnes ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="43aa6-159">**Figure 5**: From the `Products` Table, Return the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` Columns ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span></span>


<span data-ttu-id="43aa6-160">Après avoir sélectionné les colonnes, cliquez sur le bouton Avancé pour afficher la boîte de dialogue Options de génération SQL avancées.</span><span class="sxs-lookup"><span data-stu-id="43aa6-160">After picking the columns, click the Advanced button to bring up the Advanced SQL Generation Options dialog box.</span></span> <span data-ttu-id="43aa6-161">Vérifiez la générer `INSERT`, `UPDATE`, et `DELETE` instructions et utilisez les cases à cocher de l’accès concurrentiel optimiste, puis cliquez sur OK (voir Figure 1 pour une capture d’écran).</span><span class="sxs-lookup"><span data-stu-id="43aa6-161">Check the Generate `INSERT`, `UPDATE`, and `DELETE` statements and Use optimistic concurrency checkboxes and click OK (refer back to Figure 1 for a screenshot).</span></span> <span data-ttu-id="43aa6-162">Terminez l’Assistant en cliquant sur Suivant, puis sur Terminer.</span><span class="sxs-lookup"><span data-stu-id="43aa6-162">Complete the wizard by clicking Next, then Finish.</span></span>

<span data-ttu-id="43aa6-163">À l’issue de l’Assistant Configurer la Source de données, prenez un moment pour examiner les résultats `DeleteCommand` et `UpdateCommand` propriétés et le `DeleteParameters` et `UpdateParameters` collections.</span><span class="sxs-lookup"><span data-stu-id="43aa6-163">After completing the Configure Data Source wizard, take a moment to examine the resulting `DeleteCommand` and `UpdateCommand` properties and the `DeleteParameters` and `UpdateParameters` collections.</span></span> <span data-ttu-id="43aa6-164">Pour ce faire, le plus simple consiste à cliquer sur l’onglet Source dans l’angle inférieur gauche pour afficher la syntaxe déclarative s de page.</span><span class="sxs-lookup"><span data-stu-id="43aa6-164">The easiest way to do this is to click on the Source tab in the lower left corner to see the page s declarative syntax.</span></span> <span data-ttu-id="43aa6-165">Vous y trouverez un `UpdateCommand` valeur :</span><span class="sxs-lookup"><span data-stu-id="43aa6-165">There you will find an `UpdateCommand` value of:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample2.sql)]

<span data-ttu-id="43aa6-166">Avec sept paramètres dans le `UpdateParameters` collection :</span><span class="sxs-lookup"><span data-stu-id="43aa6-166">With seven parameters in the `UpdateParameters` collection:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample3.aspx)]

<span data-ttu-id="43aa6-167">De même, le `DeleteCommand` propriété et `DeleteParameters` collection doit ressembler à ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="43aa6-167">Similarly, the `DeleteCommand` property and `DeleteParameters` collection should look like the following:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample4.sql)]


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample5.aspx)]

<span data-ttu-id="43aa6-168">En plus de l’augmentation de la `WHERE` clauses de la `UpdateCommand` et `DeleteCommand` propriétés (et ajoutant les paramètres supplémentaires pour les collections de paramètres respectifs), en sélectionnant l’utilisation optimiste option d’accès concurrentiel s’ajuste à deux autres propriétés :</span><span class="sxs-lookup"><span data-stu-id="43aa6-168">In addition to augmenting the `WHERE` clauses of the `UpdateCommand` and `DeleteCommand` properties (and adding the additional parameters to the respective parameter collections), selecting the Use optimistic concurrency option adjusts two other properties:</span></span>

- <span data-ttu-id="43aa6-169">Modifications du [ `ConflictDetection` propriété](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) à partir de `OverwriteChanges` (la valeur par défaut) pour `CompareAllValues`</span><span class="sxs-lookup"><span data-stu-id="43aa6-169">Changes the [`ConflictDetection` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) from `OverwriteChanges` (the default) to `CompareAllValues`</span></span>
- <span data-ttu-id="43aa6-170">Modifications du [ `OldValuesParameterFormatString` propriété](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) de {0} (la valeur par défaut) vers l’original\_ {0} .</span><span class="sxs-lookup"><span data-stu-id="43aa6-170">Changes the [`OldValuesParameterFormatString` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) from {0} (the default) to original\_{0} .</span></span>

<span data-ttu-id="43aa6-171">Lorsque les données de contrôle Web appelant les opérations de mappage SqlDataSource `Update()` ou `Delete()` (méthode), il passe les valeurs d’origine.</span><span class="sxs-lookup"><span data-stu-id="43aa6-171">When the data Web control invokes the SqlDataSource s `Update()` or `Delete()` method, it passes in the original values.</span></span> <span data-ttu-id="43aa6-172">Si les opérations de mappage SqlDataSource `ConflictDetection` propriété est définie sur `CompareAllValues`, ces valeurs d’origine sont ajoutés à la commande.</span><span class="sxs-lookup"><span data-stu-id="43aa6-172">If the SqlDataSource s `ConflictDetection` property is set to `CompareAllValues`, these original values are added to the command.</span></span> <span data-ttu-id="43aa6-173">Le `OldValuesParameterFormatString` propriété fournit le modèle d’affectation de noms utilisé pour ces paramètres de valeur d’origine.</span><span class="sxs-lookup"><span data-stu-id="43aa6-173">The `OldValuesParameterFormatString` property provides the naming pattern used for these original value parameters.</span></span> <span data-ttu-id="43aa6-174">L’Assistant Configurer la Source de données utilise d’origine\_ {0} et noms de chaque paramètre d’origine dans le `UpdateCommand` et `DeleteCommand` propriétés et `UpdateParameters` et `DeleteParameters` collections en conséquence.</span><span class="sxs-lookup"><span data-stu-id="43aa6-174">The Configure Data Source wizard uses original\_{0} and names each original parameter in the `UpdateCommand` and `DeleteCommand` properties and `UpdateParameters` and `DeleteParameters` collections accordingly.</span></span>

> [!NOTE]
> <span data-ttu-id="43aa6-175">Étant donné que nous n’utilisez ne pas les opérations de mappage contrôle SqlDataSource insertion de fonctionnalités, n’hésitez pas à supprimer le `InsertCommand` propriété et sa `InsertParameters` collection.</span><span class="sxs-lookup"><span data-stu-id="43aa6-175">Since we re not using the SqlDataSource control s inserting capabilities, feel free to remove the `InsertCommand` property and its `InsertParameters` collection.</span></span>


## <a name="correctly-handlingnullvalues"></a><span data-ttu-id="43aa6-176">Gérer correctement`NULL`valeurs</span><span class="sxs-lookup"><span data-stu-id="43aa6-176">Correctly Handling`NULL`Values</span></span>

<span data-ttu-id="43aa6-177">Malheureusement, l’augmentée `UPDATE` et `DELETE` généré automatiquement les instructions par l’Assistant Configurer la Source de données lors de l’utilisation de l’accès concurrentiel optimiste faire *pas* fonctionnent avec les enregistrements qui contiennent `NULL` valeurs.</span><span class="sxs-lookup"><span data-stu-id="43aa6-177">Unfortunately, the augmented `UPDATE` and `DELETE` statements autogenerated by the Configure Data Source wizard when using optimistic concurrency do *not* work with records that contain `NULL` values.</span></span> <span data-ttu-id="43aa6-178">Pour comprendre pourquoi, envisagez de notre s SqlDataSource `UpdateCommand`:</span><span class="sxs-lookup"><span data-stu-id="43aa6-178">To see why, consider our SqlDataSource s `UpdateCommand`:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample6.sql)]

<span data-ttu-id="43aa6-179">Le `UnitPrice` colonne dans le `Products` table peut avoir `NULL` valeurs.</span><span class="sxs-lookup"><span data-stu-id="43aa6-179">The `UnitPrice` column in the `Products` table can have `NULL` values.</span></span> <span data-ttu-id="43aa6-180">Si un enregistrement particulier a un `NULL` valeur `UnitPrice`, le `WHERE` partie de la clause `[UnitPrice] = @original_UnitPrice` sera *toujours* ont la valeur False, car `NULL = NULL` retourne toujours False.</span><span class="sxs-lookup"><span data-stu-id="43aa6-180">If a particular record has a `NULL` value for `UnitPrice`, the `WHERE` clause portion `[UnitPrice] = @original_UnitPrice` will *always* evaluate to False because `NULL = NULL` always returns False.</span></span> <span data-ttu-id="43aa6-181">Par conséquent, les enregistrements qui contiennent `NULL` valeurs ne peut pas être modifiés ou supprimés, comme le `UPDATE` et `DELETE` instructions `WHERE` clauses a gagné t retournent toutes les lignes pour mettre à jour ou supprimer.</span><span class="sxs-lookup"><span data-stu-id="43aa6-181">Therefore, records that contain `NULL` values cannot be edited or deleted, as the `UPDATE` and `DELETE` statements `WHERE` clauses won t return any rows to update or delete.</span></span>

> [!NOTE]
> <span data-ttu-id="43aa6-182">Ce bogue a été signalé initialement à Microsoft en juin 2004 dans [SqlDataSource génère des instructions SQL inexactes](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) et disponible doit être résolu dans la prochaine version d’ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="43aa6-182">This bug was first reported to Microsoft in June of 2004 in [SqlDataSource Generates Incorrect SQL Statements](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) and is reportedly scheduled to be fixed in the next version of ASP.NET.</span></span>


<span data-ttu-id="43aa6-183">Pour résoudre ce problème, nous devons mettre à jour manuellement la `WHERE` clauses à la fois dans le `UpdateCommand` et `DeleteCommand` propriétés pour **tous les** colonnes pouvant avoir `NULL` valeurs.</span><span class="sxs-lookup"><span data-stu-id="43aa6-183">To fix this, we have to manually update the `WHERE` clauses in both the `UpdateCommand` and `DeleteCommand` properties for **all** columns that can have `NULL` values.</span></span> <span data-ttu-id="43aa6-184">En général, modifier `[ColumnName] = @original_ColumnName` à :</span><span class="sxs-lookup"><span data-stu-id="43aa6-184">In general, change `[ColumnName] = @original_ColumnName` to:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample7.sql)]

<span data-ttu-id="43aa6-185">Cette modification peut être effectuée directement via le balisage déclaratif, via les options UpdateQuery ou DeleteQuery à partir de la fenêtre Propriétés, ou via la mise à jour et supprimer des onglets dans la spécifiez une instruction SQL personnalisée ou une option de procédure stockée dans les données de configuration Assistant source.</span><span class="sxs-lookup"><span data-stu-id="43aa6-185">This modification can be made directly through the declarative markup, via the UpdateQuery or DeleteQuery options from the Properties window, or through the UPDATE and DELETE tabs in the Specify a custom SQL statement or stored procedure option in the Configure Data Source wizard.</span></span> <span data-ttu-id="43aa6-186">Là encore, cette modification doit être effectuée pour *chaque* colonne dans le `UpdateCommand` et `DeleteCommand` s `WHERE` clause pouvant contenir `NULL` valeurs.</span><span class="sxs-lookup"><span data-stu-id="43aa6-186">Again, this modification must be made for *every* column in the `UpdateCommand` and `DeleteCommand` s `WHERE` clause that can contain `NULL` values.</span></span>

<span data-ttu-id="43aa6-187">Cette application à notre exemple donne le résultat suivant modifié `UpdateCommand` et `DeleteCommand` valeurs :</span><span class="sxs-lookup"><span data-stu-id="43aa6-187">Applying this to our example results in the following modified `UpdateCommand` and `DeleteCommand` values:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample8.sql)]

## <a name="step-2-adding-a-gridview-with-edit-and-delete-options"></a><span data-ttu-id="43aa6-188">Étape 2 : Ajout d’un GridView avec modifier et les Options de suppression</span><span class="sxs-lookup"><span data-stu-id="43aa6-188">Step 2: Adding a GridView with Edit and Delete Options</span></span>

<span data-ttu-id="43aa6-189">Avec SqlDataSource configuré pour prendre en charge l’accès concurrentiel optimiste, il reste qu’à ajouter un contrôle Web de données à la page qui utilise ce contrôle d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="43aa6-189">With the SqlDataSource configured to support optimistic concurrency, all that remains is to add a data Web control to the page that utilizes this concurrency control.</span></span> <span data-ttu-id="43aa6-190">Pour ce didacticiel, permettent d’ajouter un GridView qui fournit à la fois modifier et supprimer des fonctionnalités s.</span><span class="sxs-lookup"><span data-stu-id="43aa6-190">For this tutorial, let s add a GridView that provides both edit and delete functionality.</span></span> <span data-ttu-id="43aa6-191">Pour ce faire, faites glisser un GridView à partir de la boîte à outils vers le concepteur et le jeu de son `ID` à `Products`.</span><span class="sxs-lookup"><span data-stu-id="43aa6-191">To accomplish this, drag a GridView from the Toolbox onto the Designer and set its `ID` to `Products`.</span></span> <span data-ttu-id="43aa6-192">À partir de la balise active de s GridView, liez-le à le `ProductsDataSourceWithOptimisticConcurrency` contrôle SqlDataSource ajouté à l’étape 1.</span><span class="sxs-lookup"><span data-stu-id="43aa6-192">From the GridView s smart tag, bind it to the `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource control added in Step 1.</span></span> <span data-ttu-id="43aa6-193">Enfin, vérifiez les options Activer la modification et activer la suppression à partir de la balise active.</span><span class="sxs-lookup"><span data-stu-id="43aa6-193">Finally, check the Enable Editing and Enable Deleting options from the smart tag.</span></span>


<span data-ttu-id="43aa6-194">[![Lier le contrôle GridView à SqlDataSource et activer la modification et suppression](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="43aa6-194">[![Bind the GridView to the SqlDataSource and Enable Editing and Deleting](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span></span>

<span data-ttu-id="43aa6-195">**Figure 6**: Lier le contrôle GridView à SqlDataSource et d’activer la modification et de suppression ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="43aa6-195">**Figure 6**: Bind the GridView to the SqlDataSource and Enable Editing and Deleting ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span></span>


<span data-ttu-id="43aa6-196">Après avoir ajouté le contrôle GridView, configurer son apparence en supprimant le `ProductID` BoundField, modification de la `ProductName` BoundField s `HeaderText` propriété produit, et de la mise à jour le `UnitPrice` BoundField afin que son `HeaderText` propriété est Il vous suffit de prix.</span><span class="sxs-lookup"><span data-stu-id="43aa6-196">After adding the GridView, configure its appearance by removing the `ProductID` BoundField, changing the `ProductName` BoundField s `HeaderText` property to Product, and updating the `UnitPrice` BoundField so that its `HeaderText` property is simply Price.</span></span> <span data-ttu-id="43aa6-197">Dans l’idéal, nous d améliorer l’interface de modification pour inclure un contrôle RequiredFieldValidator pour le `ProductName` valeur et un CompareValidator pour les `UnitPrice` valeur (pour vous assurer qu’il s une valeur numérique au format correct).</span><span class="sxs-lookup"><span data-stu-id="43aa6-197">Ideally, we d enhance the editing interface to include a RequiredFieldValidator for the `ProductName` value and a CompareValidator for the `UnitPrice` value (to ensure it s a properly formatted numeric value).</span></span> <span data-ttu-id="43aa6-198">Reportez-vous à la [personnalisation de l’Interface de Modification de données](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) décrivant la plus approfondi de personnalisation de la s GridView modification d’interface.</span><span class="sxs-lookup"><span data-stu-id="43aa6-198">Refer to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial for a more in-depth look at customizing the GridView s editing interface.</span></span>

> [!NOTE]
> <span data-ttu-id="43aa6-199">Le contrôle GridView état d’affichage s doit être activée dans la mesure où les valeurs d’origine passés à partir de la GridView à SqlDataSource sont stockées dans l’affichage état.</span><span class="sxs-lookup"><span data-stu-id="43aa6-199">The GridView s view state must be enabled since the original values passed from the GridView to the SqlDataSource are stored in view state.</span></span>


<span data-ttu-id="43aa6-200">Après avoir apporté ces modifications au GridView, le balisage déclaratif GridView et SqlDataSource doit ressembler à ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="43aa6-200">After making these modifications to the GridView, the GridView and SqlDataSource declarative markup should look similar to the following:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample9.aspx)]

<span data-ttu-id="43aa6-201">Pour afficher le contrôle d’accès concurrentiel optimiste en action, ouvrez deux fenêtres de navigateur et charger le `OptimisticConcurrency.aspx` page dans les deux.</span><span class="sxs-lookup"><span data-stu-id="43aa6-201">To see the optimistic concurrency control in action, open two browser windows and load the `OptimisticConcurrency.aspx` page in both.</span></span> <span data-ttu-id="43aa6-202">Cliquez sur les boutons de modification pour le premier produit dans les deux navigateurs.</span><span class="sxs-lookup"><span data-stu-id="43aa6-202">Click on the Edit buttons for the first product in both browsers.</span></span> <span data-ttu-id="43aa6-203">Dans un navigateur, modifiez le nom de produit et cliquez sur la mise à jour.</span><span class="sxs-lookup"><span data-stu-id="43aa6-203">In one browser, change the product name and click Update.</span></span> <span data-ttu-id="43aa6-204">Le navigateur sera publication (postback) et le contrôle GridView renverra au mode édition préalable, montrant le nouveau nom de produit pour l’enregistrement de modification uniquement.</span><span class="sxs-lookup"><span data-stu-id="43aa6-204">The browser will postback and the GridView will return to its pre-editing mode, showing the new product name for the record just edited.</span></span>

<span data-ttu-id="43aa6-205">Dans la deuxième fenêtre de navigateur, modifier le prix (mais laisser le nom du produit en tant que sa valeur d’origine) et cliquez sur la mise à jour.</span><span class="sxs-lookup"><span data-stu-id="43aa6-205">In the second browser window, change the price (but leave the product name as its original value) and click Update.</span></span> <span data-ttu-id="43aa6-206">Lors de la publication, la grille retourne au mode édition préalable, mais la modification du prix n’est pas enregistrée.</span><span class="sxs-lookup"><span data-stu-id="43aa6-206">On postback, the grid returns to its pre-editing mode, but the change to the price is not recorded.</span></span> <span data-ttu-id="43aa6-207">Le second navigateur montre la même valeur que le premier le nouveau nom de produit avec l’ancien prix.</span><span class="sxs-lookup"><span data-stu-id="43aa6-207">The second browser shows the same value as the first one the new product name with the old price.</span></span> <span data-ttu-id="43aa6-208">Les modifications apportées dans la deuxième fenêtre de navigateur ont été perdues.</span><span class="sxs-lookup"><span data-stu-id="43aa6-208">The changes made in the second browser window were lost.</span></span> <span data-ttu-id="43aa6-209">En outre, les modifications ont été perdues au lieu de cela en mode silencieux, en ne raison d’aucune exception ou un message indiquant qu’une violation d’accès concurrentiel s’est produite.</span><span class="sxs-lookup"><span data-stu-id="43aa6-209">Moreover, the changes were lost rather quietly, as there was no exception or message indicating that a concurrency violation just occurred.</span></span>


<span data-ttu-id="43aa6-210">[![Les modifications dans la deuxième fenêtre de navigateur ont été perdues en mode silencieux](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="43aa6-210">[![The Changes in the Second Browser Window Were Silently Lost](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span></span>

<span data-ttu-id="43aa6-211">**Figure 7**: Les modifications dans le deuxième navigateur fenêtre ont été en mode silencieux perdus ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="43aa6-211">**Figure 7**: The Changes in the Second Browser Window Were Silently Lost ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span></span>


<span data-ttu-id="43aa6-212">La raison pourquoi les modifications de navigateur s deuxième n’ont pas étées était car le `UPDATE` instruction s `WHERE` clause éliminé tous les enregistrements et par conséquent n’a affecté aucune ligne.</span><span class="sxs-lookup"><span data-stu-id="43aa6-212">The reason why the second browser s changes were not committed was because the `UPDATE` statement s `WHERE` clause filtered out all records and therefore did not affect any rows.</span></span> <span data-ttu-id="43aa6-213">S permettent d’examiner le `UPDATE` instruction à nouveau :</span><span class="sxs-lookup"><span data-stu-id="43aa6-213">Let s look at the `UPDATE` statement again:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample10.sql)]

<span data-ttu-id="43aa6-214">Lorsque la deuxième fenêtre de navigateur met à jour l’enregistrement, le nom de produit d’origine spécifié dans le `WHERE` clause n t correspondance inscrire avec le nom de produit existant (dans la mesure où il a été modifiée par le premier navigateur).</span><span class="sxs-lookup"><span data-stu-id="43aa6-214">When the second browser window updates the record, the original product name specified in the `WHERE` clause doesn t match up with the existing product name (since it was changed by the first browser).</span></span> <span data-ttu-id="43aa6-215">Par conséquent, l’instruction `[ProductName] = @original_ProductName` retourne False et le `UPDATE` n’affecte pas d’enregistrement.</span><span class="sxs-lookup"><span data-stu-id="43aa6-215">Therefore, the statement `[ProductName] = @original_ProductName` returns False, and the `UPDATE` does not affect any records.</span></span>

> [!NOTE]
> <span data-ttu-id="43aa6-216">Fonctionnement de Delete de la même manière.</span><span class="sxs-lookup"><span data-stu-id="43aa6-216">Delete works in the same manner.</span></span> <span data-ttu-id="43aa6-217">Avec deux fenêtres du navigateur ouvertes, commencez par modification d’un produit donné avec un et puis d’enregistrer ses modifications.</span><span class="sxs-lookup"><span data-stu-id="43aa6-217">With two browser windows open, start by editing a given product with one, and then saving its changes.</span></span> <span data-ttu-id="43aa6-218">Après avoir enregistré les modifications dans le navigateur, cliquez sur le bouton Supprimer pour le même produit dans l’autre.</span><span class="sxs-lookup"><span data-stu-id="43aa6-218">After saving the changes in the one browser, click the Delete button for the same product in the other.</span></span> <span data-ttu-id="43aa6-219">Étant donné que le don de valeurs d’origine t correspondre dans le `DELETE` instruction s `WHERE` clause, la suppression échoue en mode silencieux.</span><span class="sxs-lookup"><span data-stu-id="43aa6-219">Since the original values don t match up in the `DELETE` statement s `WHERE` clause, the delete silently fails.</span></span>


<span data-ttu-id="43aa6-220">L’utilisateur final s du point de vue dans la deuxième fenêtre de navigateur, après avoir cliqué sur le bouton de mise à jour la grille retourne au mode d’édition préalable, mais leurs modifications ont été perdues.</span><span class="sxs-lookup"><span data-stu-id="43aa6-220">From the end user s perspective in the second browser window, after clicking the Update button the grid returns to the pre-editing mode, but their changes were lost.</span></span> <span data-ttu-id="43aa6-221">Toutefois, cet emplacement s aucun retour visuel respecter leur t ne savais pas de modifications.</span><span class="sxs-lookup"><span data-stu-id="43aa6-221">However, there s no visual feedback that their changes didn t stick.</span></span> <span data-ttu-id="43aa6-222">Dans l’idéal, si un utilisateur s modifications sont perdues une violation d’accès concurrentiel, nous d notifier ces derniers et, peut-être, maintenir la grille en mode édition.</span><span class="sxs-lookup"><span data-stu-id="43aa6-222">Ideally, if a user s changes are lost to a concurrency violation, we d notify them and, perhaps, keep the grid in edit mode.</span></span> <span data-ttu-id="43aa6-223">Permettent de voir comment cela s.</span><span class="sxs-lookup"><span data-stu-id="43aa6-223">Let s look at how to accomplish this.</span></span>

## <a name="step-3-determining-when-a-concurrency-violation-has-occurred"></a><span data-ttu-id="43aa6-224">Étape 3 : Déterminer quand une Violation d’accès concurrentiel s’est produite</span><span class="sxs-lookup"><span data-stu-id="43aa6-224">Step 3: Determining When a Concurrency Violation Has Occurred</span></span>

<span data-ttu-id="43aa6-225">Dans la mesure où une violation d’accès concurrentiel rejette les modifications a été, il serait intéressant avertir l’utilisateur lorsqu’une violation d’accès concurrentiel s’est produite.</span><span class="sxs-lookup"><span data-stu-id="43aa6-225">Since a concurrency violation rejects the changes one has made, it would be nice to alert the user when a concurrency violation has occurred.</span></span> <span data-ttu-id="43aa6-226">Pour avertir l’utilisateur, s permettent d’ajouter un contrôle Web Label en haut de la page nommée `ConcurrencyViolationMessage` dont `Text` propriété affiche le message suivant : Vous avez tenté de mettre à jour ou supprimer un enregistrement qui a été mises à jour simultanément par un autre utilisateur.</span><span class="sxs-lookup"><span data-stu-id="43aa6-226">To alert the user, let s add a Label Web control to the top of the page named `ConcurrencyViolationMessage` whose `Text` property displays the following message: You have attempted to update or delete a record that was simultaneously updated by another user.</span></span> <span data-ttu-id="43aa6-227">Passez en revue les modifications des autres utilisateurs puis rétablir votre mise à jour ou supprimer.</span><span class="sxs-lookup"><span data-stu-id="43aa6-227">Please review the other user's changes and then redo your update or delete.</span></span> <span data-ttu-id="43aa6-228">Définir le contrôle d’étiquette s `CssClass` propriété à avertissement, qui est une classe CSS définie dans `Styles.css` qui affiche le texte dans une police rouge, italique, gras et grande.</span><span class="sxs-lookup"><span data-stu-id="43aa6-228">Set the Label control s `CssClass` property to Warning, which is a CSS class defined in `Styles.css` that displays text in a red, italic, bold, and large font.</span></span> <span data-ttu-id="43aa6-229">Enfin, définissez l’étiquette s `Visible` et `EnableViewState` propriétés à `false`.</span><span class="sxs-lookup"><span data-stu-id="43aa6-229">Finally, set the Label s `Visible` and `EnableViewState` properties to `false`.</span></span> <span data-ttu-id="43aa6-230">Cela permet de masquer l’étiquette à l’exception uniquement ces publications où nous définissons explicitement son `Visible` propriété `true`.</span><span class="sxs-lookup"><span data-stu-id="43aa6-230">This will hide the Label except for only those postbacks where we explicitly set its `Visible` property to `true`.</span></span>


<span data-ttu-id="43aa6-231">[![Ajouter un contrôle étiquette à la Page pour afficher l’avertissement](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="43aa6-231">[![Add a Label Control to the Page to Display the Warning](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span></span>

<span data-ttu-id="43aa6-232">**Figure 8**: Ajouter un contrôle étiquette à la Page pour afficher l’avertissement ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="43aa6-232">**Figure 8**: Add a Label Control to the Page to Display the Warning ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span></span>


<span data-ttu-id="43aa6-233">Lorsque vous effectuez une mise à jour ou suppression, les opérations de mappage GridView `RowUpdated` et `RowDeleted` gestionnaires d’événements se déclenchent après que son contrôle de source de données a effectué la mise à jour demandée ou la suppression.</span><span class="sxs-lookup"><span data-stu-id="43aa6-233">When performing an update or delete, the GridView s `RowUpdated` and `RowDeleted` event handlers fire after its data source control has performed the requested update or delete.</span></span> <span data-ttu-id="43aa6-234">Nous pouvons déterminer combien de lignes ont été affectés par l’opération à partir de ces gestionnaires d’événements.</span><span class="sxs-lookup"><span data-stu-id="43aa6-234">We can determine how many rows were affected by the operation from these event handlers.</span></span> <span data-ttu-id="43aa6-235">Si aucune ligne ont été affectés, nous souhaitons afficher la `ConcurrencyViolationMessage` étiquette.</span><span class="sxs-lookup"><span data-stu-id="43aa6-235">If zero rows were affected, we want to display the `ConcurrencyViolationMessage` Label.</span></span>

<span data-ttu-id="43aa6-236">Créer un gestionnaire d’événements pour les deux le `RowUpdated` et `RowDeleted` événements et ajoutez le code suivant :</span><span class="sxs-lookup"><span data-stu-id="43aa6-236">Create an event handler for both the `RowUpdated` and `RowDeleted` events and add the following code:</span></span>


[!code-csharp[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample11.cs)]

<span data-ttu-id="43aa6-237">Dans les deux gestionnaires d’événements, nous vérifions le `e.AffectedRows` propriété et, si elle est égale à 0, définissez la `ConcurrencyViolationMessage` étiquette s `Visible` propriété `true`.</span><span class="sxs-lookup"><span data-stu-id="43aa6-237">In both event handlers we check the `e.AffectedRows` property and, if it equals 0, set the `ConcurrencyViolationMessage` Label s `Visible` property to `true`.</span></span> <span data-ttu-id="43aa6-238">Dans le `RowUpdated` Gestionnaire d’événements, nous indiquons également le contrôle GridView à rester en mode édition en définissant le `KeepInEditMode` true à la propriété.</span><span class="sxs-lookup"><span data-stu-id="43aa6-238">In the `RowUpdated` event handler, we also instruct the GridView to stay in edit mode by setting the `KeepInEditMode` property to true.</span></span> <span data-ttu-id="43aa6-239">Ce faisant, nous avons besoin relier les données à la grille afin que les autres données de l’utilisateur se sont chargées dans l’interface de modification.</span><span class="sxs-lookup"><span data-stu-id="43aa6-239">In doing so, we need to rebind the data to the grid so that the other user s data is loaded into the editing interface.</span></span> <span data-ttu-id="43aa6-240">Cela est accompli en appelant le s GridView `DataBind()` (méthode).</span><span class="sxs-lookup"><span data-stu-id="43aa6-240">This is accomplished by calling the GridView s `DataBind()` method.</span></span>

<span data-ttu-id="43aa6-241">Comme le montre la Figure 9, ces deux gestionnaires d’événements, un message très sensible s’affiche chaque fois qu’une violation d’accès concurrentiel se produit.</span><span class="sxs-lookup"><span data-stu-id="43aa6-241">As Figure 9 shows, with these two event handlers, a very noticeable message is displayed whenever a concurrency violation occurs.</span></span>


<span data-ttu-id="43aa6-242">[![Un Message s’affiche en cas d’une Violation d’accès concurrentiel](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="43aa6-242">[![A Message is Displayed in the Face of a Concurrency Violation](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span></span>

<span data-ttu-id="43aa6-243">**Figure 9**: Un Message s’affiche en cas d’une Violation d’accès concurrentiel ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="43aa6-243">**Figure 9**: A Message is Displayed in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span></span>


## <a name="summary"></a><span data-ttu-id="43aa6-244">Récapitulatif</span><span class="sxs-lookup"><span data-stu-id="43aa6-244">Summary</span></span>

<span data-ttu-id="43aa6-245">Lors de la création d’une application web où de multiples utilisateurs peuvent modifier les mêmes données, il est important de tenir compte des options de contrôle d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="43aa6-245">When creating a web application where multiple, concurrent users may be editing the same data, it is important to consider concurrency control options.</span></span> <span data-ttu-id="43aa6-246">Par défaut, les données d’ASP.NET que contrôles Web et les contrôles de source de données n’utilisent pas de n’importe quel contrôle d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="43aa6-246">By default, the ASP.NET data Web controls and data source controls do not employ any concurrency control.</span></span> <span data-ttu-id="43aa6-247">Comme nous l’avons vu dans ce didacticiel, l’implémentation de contrôle d’accès concurrentiel optimiste avec SqlDataSource est relativement simple et rapide.</span><span class="sxs-lookup"><span data-stu-id="43aa6-247">As we saw in this tutorial, implementing optimistic concurrency control with the SqlDataSource is relatively quick and easy.</span></span> <span data-ttu-id="43aa6-248">SqlDataSource gère la plupart du gros du travail pour votre ajout augmentée `WHERE` clauses pour le nom généré automatiquement `UPDATE` et `DELETE` , mais les instructions sont quelques subtilités dans Gestion des `NULL` valeur des colonnes, comme indiqué dans le Gérer correctement `NULL` section de valeurs.</span><span class="sxs-lookup"><span data-stu-id="43aa6-248">The SqlDataSource handles most of the legwork for your adding augmented `WHERE` clauses to the autogenerated `UPDATE` and `DELETE` statements but there are a few subtleties in handling `NULL` value columns, as discussed in the Correctly Handling `NULL` Values section.</span></span>

<span data-ttu-id="43aa6-249">Ce didacticiel conclut notre examen de SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="43aa6-249">This tutorial concludes our examination of the SqlDataSource.</span></span> <span data-ttu-id="43aa6-250">Nos didacticiels restants retournera à l’utilisation des données à l’aide de l’ObjectDataSource et l’architecture à plusieurs niveaux.</span><span class="sxs-lookup"><span data-stu-id="43aa6-250">Our remaining tutorials will return to working with data using the ObjectDataSource and tiered architecture.</span></span>

<span data-ttu-id="43aa6-251">Bonne programmation !</span><span class="sxs-lookup"><span data-stu-id="43aa6-251">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="43aa6-252">À propos de l’auteur</span><span class="sxs-lookup"><span data-stu-id="43aa6-252">About the Author</span></span>

<span data-ttu-id="43aa6-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), auteur de sept les livres sur ASP/ASP.NET et fondateur de [4GuysFromRolla.com](http://www.4guysfromrolla.com), travaille avec les technologies Web Microsoft depuis 1998.</span><span class="sxs-lookup"><span data-stu-id="43aa6-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="43aa6-254">Scott fonctionne comme un consultant indépendant, formateur et writer.</span><span class="sxs-lookup"><span data-stu-id="43aa6-254">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="43aa6-255">Son dernier ouvrage est [*SAM animer vous-même ASP.NET 2.0 des dernières 24 heures*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="43aa6-255">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="43aa6-256">Il peut être contacté à [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="43aa6-256">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="43aa6-257">ou via son blog, qui se trouve à [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="43aa6-257">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="43aa6-258">[Précédent](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
> [Suivant](querying-data-with-the-sqldatasource-control-vb.md)</span><span class="sxs-lookup"><span data-stu-id="43aa6-258">[Previous](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
[Next](querying-data-with-the-sqldatasource-control-vb.md)</span></span>
