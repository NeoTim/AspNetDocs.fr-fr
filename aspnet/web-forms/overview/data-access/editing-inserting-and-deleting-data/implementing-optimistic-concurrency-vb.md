---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb
title: Implémentation de l’accès concurrentiel optimiste (VB) | Microsoft Docs
author: rick-anderson
description: Pour une application Web qui permet à plusieurs utilisateurs de modifier des données, il existe un risque que deux utilisateurs modifient les mêmes données en même temps. Dans ce...
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 2646968c-2826-4418-b1d0-62610ed177e3
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb
msc.type: authoredcontent
ms.openlocfilehash: 28c39fe2a290cc3a5b093fdd09de341630606137
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78607911"
---
# <a name="implementing-optimistic-concurrency-vb"></a><span data-ttu-id="f0368-104">Implémentation de l’accès concurrentiel optimiste (VB)</span><span class="sxs-lookup"><span data-stu-id="f0368-104">Implementing Optimistic Concurrency (VB)</span></span>

<span data-ttu-id="f0368-105">par [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="f0368-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="f0368-106">[Télécharger l’exemple d’application](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_VB.exe) ou [Télécharger le PDF](implementing-optimistic-concurrency-vb/_static/datatutorial21vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="f0368-106">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_VB.exe) or [Download PDF](implementing-optimistic-concurrency-vb/_static/datatutorial21vb1.pdf)</span></span>

> <span data-ttu-id="f0368-107">Pour une application Web qui permet à plusieurs utilisateurs de modifier des données, il existe un risque que deux utilisateurs modifient les mêmes données en même temps.</span><span class="sxs-lookup"><span data-stu-id="f0368-107">For a web application that allows multiple users to edit data, there is the risk that two users may be editing the same data at the same time.</span></span> <span data-ttu-id="f0368-108">Dans ce didacticiel, nous allons implémenter le contrôle d’accès concurrentiel optimiste pour gérer ce risque.</span><span class="sxs-lookup"><span data-stu-id="f0368-108">In this tutorial we'll implement optimistic concurrency control to handle this risk.</span></span>

## <a name="introduction"></a><span data-ttu-id="f0368-109">Introduction</span><span class="sxs-lookup"><span data-stu-id="f0368-109">Introduction</span></span>

<span data-ttu-id="f0368-110">Pour les applications Web qui permettent uniquement aux utilisateurs d’afficher des données, ou pour ceux qui n’incluent qu’un seul utilisateur qui peut modifier des données, il n’y a aucune menace que deux utilisateurs simultanés remplacent accidentellement les modifications d’une autre.</span><span class="sxs-lookup"><span data-stu-id="f0368-110">For web applications that only allow users to view data, or for those that include only a single user who can modify data, there's no threat of two concurrent users accidentally overwriting one another's changes.</span></span> <span data-ttu-id="f0368-111">Toutefois, pour les applications Web qui permettent à plusieurs utilisateurs de mettre à jour ou de supprimer des données, il est possible que les modifications d’un utilisateur soient en conflit avec les autres utilisateurs simultanés.</span><span class="sxs-lookup"><span data-stu-id="f0368-111">For web applications that allow multiple users to update or delete data, however, there's the potential for one user's modifications to clash with another concurrent user's.</span></span> <span data-ttu-id="f0368-112">Sans aucune stratégie d’accès concurrentiel en place, lorsque deux utilisateurs modifient simultanément un seul enregistrement, l’utilisateur qui valide les modifications en dernier remplace les modifications apportées par le premier.</span><span class="sxs-lookup"><span data-stu-id="f0368-112">Without any concurrency policy in place, when two users are simultaneously editing a single record, the user who commits her changes last will override the changes made by the first.</span></span>

<span data-ttu-id="f0368-113">Par exemple, imaginez que deux utilisateurs, Jisun et Sam, visitaient une page de notre application qui permettait aux visiteurs de mettre à jour et de supprimer les produits via un contrôle GridView.</span><span class="sxs-lookup"><span data-stu-id="f0368-113">For example, imagine that two users, Jisun and Sam, were both visiting a page in our application that allowed visitors to update and delete the products through a GridView control.</span></span> <span data-ttu-id="f0368-114">Les deux cliquez sur le bouton modifier dans le GridView en même temps.</span><span class="sxs-lookup"><span data-stu-id="f0368-114">Both click the Edit button in the GridView around the same time.</span></span> <span data-ttu-id="f0368-115">Jisun remplace le nom de produit par « Chai thé », puis clique sur le bouton mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="f0368-115">Jisun changes the product name to "Chai Tea" and clicks the Update button.</span></span> <span data-ttu-id="f0368-116">Le résultat net est une instruction `UPDATE` qui est envoyée à la base de données, qui définit *tous* les champs modifiables du produit (même si Jisun a mis à jour un seul champ, `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="f0368-116">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product's updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="f0368-117">À ce stade, la base de données a les valeurs « Chai thé », les boissons de catégorie, les fournisseurs exotiques, etc. pour ce produit particulier.</span><span class="sxs-lookup"><span data-stu-id="f0368-117">At this point in time, the database has the values "Chai Tea," the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="f0368-118">Toutefois, le contrôle GridView sur l’écran du Sam affiche toujours le nom du produit dans la ligne de GridView modifiable en tant que « Chai ».</span><span class="sxs-lookup"><span data-stu-id="f0368-118">However, the GridView on Sam's screen still shows the product name in the editable GridView row as "Chai".</span></span> <span data-ttu-id="f0368-119">Quelques secondes après la validation des modifications de Jisun, Sam met à jour la catégorie en condiments et clique sur mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="f0368-119">A few seconds after Jisun's changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="f0368-120">Il en résulte une instruction `UPDATE` envoyée à la base de données qui définit le nom du produit sur « Chai », le `CategoryID` à l’ID de catégorie de boissons correspondant, et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="f0368-120">This results in an `UPDATE` statement sent to the database that sets the product name to "Chai," the `CategoryID` to the corresponding Beverages category ID, and so on.</span></span> <span data-ttu-id="f0368-121">Les modifications apportées au nom du produit par Jisun ont été remplacées.</span><span class="sxs-lookup"><span data-stu-id="f0368-121">Jisun's changes to the product name have been overwritten.</span></span> <span data-ttu-id="f0368-122">La figure 1 représente graphiquement cette série d’événements.</span><span class="sxs-lookup"><span data-stu-id="f0368-122">Figure 1 graphically depicts this series of events.</span></span>

<span data-ttu-id="f0368-123">[![lorsque deux utilisateurs mettent à jour simultanément un enregistrement, il est possible que les modifications d’un utilisateur remplacent les autres](implementing-optimistic-concurrency-vb/_static/image2.png)](implementing-optimistic-concurrency-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-123">[![When Two Users Simultaneously Update a Record There s Potential for One User 's Changes to Overwrite the Other 's](implementing-optimistic-concurrency-vb/_static/image2.png)](implementing-optimistic-concurrency-vb/_static/image1.png)</span></span>

<span data-ttu-id="f0368-124">**Figure 1**: lorsque deux utilisateurs mettent à jour simultanément un enregistrement, il est possible que les modifications d’un utilisateur remplacent les autres ([cliquez pour afficher l’image en plein écran](implementing-optimistic-concurrency-vb/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-124">**Figure 1**: When Two Users Simultaneously Update a Record There s Potential for One User 's Changes to Overwrite the Other 's ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image3.png))</span></span>

<span data-ttu-id="f0368-125">De même, lorsque deux utilisateurs visitent une page, un utilisateur peut être au milieu de la mise à jour d’un enregistrement lorsqu’il est supprimé par un autre utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f0368-125">Similarly, when two users are visiting a page, one user might be in the midst of updating a record when it is deleted by another user.</span></span> <span data-ttu-id="f0368-126">Ou bien, entre le moment où un utilisateur charge une page et le moment où il clique sur le bouton supprimer, un autre utilisateur a peut-être modifié le contenu de cet enregistrement.</span><span class="sxs-lookup"><span data-stu-id="f0368-126">Or, between when a user loads a page and when they click the Delete button, another user may have modified the contents of that record.</span></span>

<span data-ttu-id="f0368-127">Trois stratégies de [contrôle d’accès concurrentiel](http://en.wikipedia.org/wiki/Concurrency_control) sont disponibles :</span><span class="sxs-lookup"><span data-stu-id="f0368-127">There are three [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) strategies available:</span></span>

- <span data-ttu-id="f0368-128">**Ne rien faire** : si des utilisateurs simultanés modifient le même enregistrement, laissez la dernière validation Win (comportement par défaut)</span><span class="sxs-lookup"><span data-stu-id="f0368-128">**Do Nothing** -if concurrent users are modifying the same record, let the last commit win (the default behavior)</span></span>
- <span data-ttu-id="f0368-129">[**Accès concurrentiel optimiste**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) : Partez du principe qu’il peut y avoir des conflits d’accès concurrentiel à chaque instant, puis, la grande majorité du temps, ces conflits ne se produiront pas. par conséquent, en cas de conflit, informez simplement l’utilisateur que les modifications apportées ne peuvent pas être enregistrées, car un autre utilisateur a modifié les mêmes données</span><span class="sxs-lookup"><span data-stu-id="f0368-129">[**Optimistic Concurrency**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) - assume that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise; therefore, if a conflict does arise, simply inform the user that their changes can't be saved because another user has modified the same data</span></span>
- <span data-ttu-id="f0368-130">**Accès concurrentiel pessimiste** : Supposons que les conflits d’accès concurrentiel sont courants et que les utilisateurs ne tolèrent pas que leurs modifications n’ont pas été enregistrées en raison de l’activité simultanée d’un autre utilisateur. par conséquent, lorsqu’un utilisateur commence à mettre à jour un enregistrement, le verrouille, empêchant ainsi les autres utilisateurs de modifier ou de supprimer cet enregistrement jusqu’à ce que l’utilisateur valide ses modifications.</span><span class="sxs-lookup"><span data-stu-id="f0368-130">**Pessimistic Concurrency** - assume that concurrency conflicts are commonplace and that users won't tolerate being told their changes weren't saved due to another user's concurrent activity; therefore, when one user starts updating a record, lock it, thereby preventing any other users from editing or deleting that record until the user commits their modifications</span></span>

<span data-ttu-id="f0368-131">Tous nos didacticiels, jusqu’à présent, ont utilisé la stratégie de résolution de concurrence par défaut, à savoir, nous avons laissé le dernier succès à l’écriture.</span><span class="sxs-lookup"><span data-stu-id="f0368-131">All of our tutorials thus far have used the default concurrency resolution strategy - namely, we've let the last write win.</span></span> <span data-ttu-id="f0368-132">Dans ce didacticiel, nous allons examiner comment implémenter le contrôle d’accès concurrentiel optimiste.</span><span class="sxs-lookup"><span data-stu-id="f0368-132">In this tutorial we'll examine how to implement optimistic concurrency control.</span></span>

> [!NOTE]
> <span data-ttu-id="f0368-133">Nous n’examinerons pas les exemples d’accès concurrentiel pessimiste dans cette série de didacticiels.</span><span class="sxs-lookup"><span data-stu-id="f0368-133">We won't look at pessimistic concurrency examples in this tutorial series.</span></span> <span data-ttu-id="f0368-134">L’accès concurrentiel pessimiste est rarement utilisé, car ces verrous, s’ils ne sont pas correctement libérés, peuvent empêcher d’autres utilisateurs de mettre à jour les données.</span><span class="sxs-lookup"><span data-stu-id="f0368-134">Pessimistic concurrency is rarely used because such locks, if not properly relinquished, can prevent other users from updating data.</span></span> <span data-ttu-id="f0368-135">Par exemple, si un utilisateur verrouille un enregistrement pour le modifier, puis laisse le jour avant de le déverrouiller, aucun autre utilisateur ne pourra mettre à jour cet enregistrement jusqu’à ce que l’utilisateur d’origine retourne et termine sa mise à jour.</span><span class="sxs-lookup"><span data-stu-id="f0368-135">For example, if a user locks a record for editing and then leaves for the day before unlocking it, no other user will be able to update that record until the original user returns and completes his update.</span></span> <span data-ttu-id="f0368-136">Par conséquent, dans les situations où l’accès concurrentiel pessimiste est utilisé, il y a généralement un délai d’expiration qui, s’il est atteint, annule le verrou.</span><span class="sxs-lookup"><span data-stu-id="f0368-136">Therefore, in situations where pessimistic concurrency is used, there's typically a timeout that, if reached, cancels the lock.</span></span> <span data-ttu-id="f0368-137">Les sites Web de vente de tickets, qui verrouillent un emplacement particulier pour une période brève pendant que l’utilisateur termine le processus de commande, est un exemple de contrôle d’accès concurrentiel pessimiste.</span><span class="sxs-lookup"><span data-stu-id="f0368-137">Ticket sales websites, which lock a particular seating location for short period while the user completes the order process, is an example of pessimistic concurrency control.</span></span>

## <a name="step-1-looking-at-how-optimistic-concurrency-is-implemented"></a><span data-ttu-id="f0368-138">Étape 1 : examen de l’implémentation de l’accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="f0368-138">Step 1: Looking at How Optimistic Concurrency is Implemented</span></span>

<span data-ttu-id="f0368-139">Le contrôle d’accès concurrentiel optimiste fonctionne en s’assurant que l’enregistrement en cours de mise à jour ou de suppression a les mêmes valeurs que lors du démarrage de la mise à jour ou de la suppression.</span><span class="sxs-lookup"><span data-stu-id="f0368-139">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="f0368-140">Par exemple, quand vous cliquez sur le bouton modifier dans un GridView modifiable, les valeurs de l’enregistrement sont lues à partir de la base de données et affichées dans des zones de texte et d’autres contrôles Web.</span><span class="sxs-lookup"><span data-stu-id="f0368-140">For example, when clicking the Edit button in an editable GridView, the record's values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="f0368-141">Ces valeurs d’origine sont enregistrées par le contrôle GridView.</span><span class="sxs-lookup"><span data-stu-id="f0368-141">These original values are saved by the GridView.</span></span> <span data-ttu-id="f0368-142">Plus tard, une fois que l’utilisateur a effectué ses modifications et cliqué sur le bouton mettre à jour, les valeurs d’origine plus les nouvelles valeurs sont envoyées à la couche de logique métier, puis vers la couche d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="f0368-142">Later, after the user makes her changes and clicks the Update button, the original values plus the new values are sent to the Business Logic Layer, and then down to the Data Access Layer.</span></span> <span data-ttu-id="f0368-143">La couche d’accès aux données doit émettre une instruction SQL qui met à jour l’enregistrement uniquement si les valeurs d’origine que l’utilisateur a commencé à modifier sont identiques aux valeurs figurant toujours dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="f0368-143">The Data Access Layer must issue a SQL statement that will only update the record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="f0368-144">La figure 2 illustre cette séquence d’événements.</span><span class="sxs-lookup"><span data-stu-id="f0368-144">Figure 2 depicts this sequence of events.</span></span>

<span data-ttu-id="f0368-145">[![pour que la mise à jour ou la suppression aboutisse, les valeurs d’origine doivent être égales aux valeurs de la base de données actuelle](implementing-optimistic-concurrency-vb/_static/image5.png)](implementing-optimistic-concurrency-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-145">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-vb/_static/image5.png)](implementing-optimistic-concurrency-vb/_static/image4.png)</span></span>

<span data-ttu-id="f0368-146">**Figure 2**: pour que la mise à jour ou la suppression aboutisse, les valeurs d’origine doivent être égales aux valeurs de la base de données actuelle ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-146">**Figure 2**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image6.png))</span></span>

<span data-ttu-id="f0368-147">Il existe différentes approches pour implémenter l’accès concurrentiel optimiste (consultez la logique de [mise à jour de la concurrence optimiste](http://www.eggheadcafe.com/articles/20050719.asp) de [Peter A. Bromberg](http://peterbromberg.net/)pour obtenir un bref aperçu d’un certain nombre d’options).</span><span class="sxs-lookup"><span data-stu-id="f0368-147">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://peterbromberg.net/)'s [Optimistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="f0368-148">Le DataSet typé ADO.NET fournit une implémentation qui peut être configurée uniquement à l’aide du cycle d’une case à cocher.</span><span class="sxs-lookup"><span data-stu-id="f0368-148">The ADO.NET Typed DataSet provides one implementation that can be configured with just the tick of a checkbox.</span></span> <span data-ttu-id="f0368-149">L’activation de l’accès concurrentiel optimiste pour un TableAdapter dans le DataSet typé augmente les instructions `UPDATE` et `DELETE` du TableAdapter pour inclure une comparaison de toutes les valeurs d’origine dans la clause `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="f0368-149">Enabling optimistic concurrency for a TableAdapter in the Typed DataSet augments the TableAdapter's `UPDATE` and `DELETE` statements to include a comparison of all of the original values in the `WHERE` clause.</span></span> <span data-ttu-id="f0368-150">Par exemple, l’instruction `UPDATE` suivante met à jour le nom et le prix d’un produit uniquement si les valeurs de la base de données actuelle sont égales aux valeurs récupérées à l’origine lors de la mise à jour de l’enregistrement dans le GridView.</span><span class="sxs-lookup"><span data-stu-id="f0368-150">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="f0368-151">Les paramètres `@ProductName` et `@UnitPrice` contiennent les nouvelles valeurs entrées par l’utilisateur, tandis que `@original_ProductName` et `@original_UnitPrice` contiennent les valeurs qui ont été chargées à l’origine dans le contrôle GridView lors d’un clic sur le bouton modifier :</span><span class="sxs-lookup"><span data-stu-id="f0368-151">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample1.sql)]

> [!NOTE]
> <span data-ttu-id="f0368-152">Cette instruction `UPDATE` a été simplifiée pour des raisons de lisibilité.</span><span class="sxs-lookup"><span data-stu-id="f0368-152">This `UPDATE` statement has been simplified for readability.</span></span> <span data-ttu-id="f0368-153">Dans la pratique, la vérification `UnitPrice` dans la clause `WHERE` est plus complexe, car `UnitPrice` peut contenir `NULL` s et vérifier si `NULL = NULL` retourne toujours la valeur false (à la place, vous devez utiliser `IS NULL`).</span><span class="sxs-lookup"><span data-stu-id="f0368-153">In practice, the `UnitPrice` check in the `WHERE` clause would be more involved since `UnitPrice` can contain `NULL` s and checking if `NULL = NULL` always returns False (instead you must use `IS NULL`).</span></span>

<span data-ttu-id="f0368-154">Outre l’utilisation d’une instruction `UPDATE` sous-jacente différente, la configuration d’un TableAdapter pour utiliser l’accès concurrentiel optimiste modifie également la signature de ses méthodes directes de base de données.</span><span class="sxs-lookup"><span data-stu-id="f0368-154">In addition to using a different underlying `UPDATE` statement, configuring a TableAdapter to use optimistic concurrency also modifies the signature of its DB direct methods.</span></span> <span data-ttu-id="f0368-155">Rappelez-vous de notre premier didacticiel, [*création d’une couche d’accès aux données*](../introduction/creating-a-data-access-layer-cs.md), que les méthodes de base de données directes étaient celles qui acceptent une liste de valeurs scalaires comme paramètres d’entrée (plutôt qu’une instance DataRow ou DataTable fortement typée).</span><span class="sxs-lookup"><span data-stu-id="f0368-155">Recall from our first tutorial, [*Creating a Data Access Layer*](../introduction/creating-a-data-access-layer-cs.md), that DB direct methods were those that accepts a list of scalar values as input parameters (rather than a strongly-typed DataRow or DataTable instance).</span></span> <span data-ttu-id="f0368-156">Lors de l’utilisation de l’accès concurrentiel optimiste, les méthodes DB direct `Update()` et `Delete()` incluent également des paramètres d’entrée pour les valeurs d’origine.</span><span class="sxs-lookup"><span data-stu-id="f0368-156">When using optimistic concurrency, the DB direct `Update()` and `Delete()` methods include input parameters for the original values as well.</span></span> <span data-ttu-id="f0368-157">En outre, le code de la couche BLL pour l’utilisation du modèle de mise à jour par lot (les surcharges de méthode `Update()` qui acceptent des DataRow et des DataTables plutôt que des valeurs scalaires) doit également être modifié.</span><span class="sxs-lookup"><span data-stu-id="f0368-157">Moreover, the code in the BLL for using the batch update pattern (the `Update()` method overloads that accept DataRows and DataTables rather than scalar values) must be changed as well.</span></span>

<span data-ttu-id="f0368-158">Au lieu d’étendre les TableAdapters de la couche DAL existante pour utiliser l’accès concurrentiel optimiste (ce qui nécessiterait la modification de la couche BLL pour s’adapter à), créons à la place un nouveau DataSet typé nommé `NorthwindOptimisticConcurrency`, auquel nous ajouterons un TableAdapter `Products` qui utilise l’accès concurrentiel optimiste.</span><span class="sxs-lookup"><span data-stu-id="f0368-158">Rather than extend our existing DAL's TableAdapters to use optimistic concurrency (which would necessitate changing the BLL to accommodate), let's instead create a new Typed DataSet named `NorthwindOptimisticConcurrency`, to which we'll add a `Products` TableAdapter that uses optimistic concurrency.</span></span> <span data-ttu-id="f0368-159">Après cela, nous allons créer une classe de couche de logique métier `ProductsOptimisticConcurrencyBLL` qui présente les modifications appropriées pour prendre en charge la couche DAL d’accès concurrentiel optimiste.</span><span class="sxs-lookup"><span data-stu-id="f0368-159">Following that, we'll create a `ProductsOptimisticConcurrencyBLL` Business Logic Layer class that has the appropriate modifications to support the optimistic concurrency DAL.</span></span> <span data-ttu-id="f0368-160">Une fois cette opération posée, nous sommes prêts à créer la page ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f0368-160">Once this groundwork has been laid, we'll be ready to create the ASP.NET page.</span></span>

## <a name="step-2-creating-a-data-access-layer-that-supports-optimistic-concurrency"></a><span data-ttu-id="f0368-161">Étape 2 : création d’une couche d’accès aux données qui prend en charge l’accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="f0368-161">Step 2: Creating a Data Access Layer That Supports Optimistic Concurrency</span></span>

<span data-ttu-id="f0368-162">Pour créer un nouveau DataSet typé, cliquez avec le bouton droit sur le dossier `DAL` dans le dossier `App_Code` et ajoutez un nouveau jeu de données nommé `NorthwindOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="f0368-162">To create a new Typed DataSet, right-click on the `DAL` folder within the `App_Code` folder and add a new DataSet named `NorthwindOptimisticConcurrency`.</span></span> <span data-ttu-id="f0368-163">Comme nous l’avons vu dans le premier didacticiel, cette opération ajoute un nouveau TableAdapter au DataSet typé, en lançant automatiquement l’Assistant Configuration de TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="f0368-163">As we saw in the first tutorial, doing so will add a new TableAdapter to the Typed DataSet, automatically launching the TableAdapter Configuration Wizard.</span></span> <span data-ttu-id="f0368-164">Dans le premier écran, nous sommes invités à spécifier la base de données à laquelle se connecter : Connectez-vous à la même base de données Northwind à l’aide du paramètre `NORTHWNDConnectionString` de `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f0368-164">In the first screen, we're prompted to specify the database to connect to - connect to the same Northwind database using the `NORTHWNDConnectionString` setting from `Web.config`.</span></span>

<span data-ttu-id="f0368-165">[![se connecter à la même base de données Northwind](implementing-optimistic-concurrency-vb/_static/image8.png)](implementing-optimistic-concurrency-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-165">[![Connect to the Same Northwind Database](implementing-optimistic-concurrency-vb/_static/image8.png)](implementing-optimistic-concurrency-vb/_static/image7.png)</span></span>

<span data-ttu-id="f0368-166">**Figure 3**: se connecter à la même base de données Northwind ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-166">**Figure 3**: Connect to the Same Northwind Database ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image9.png))</span></span>

<span data-ttu-id="f0368-167">Ensuite, nous sommes invités à interroger les données : par le biais d’une instruction SQL ad hoc, d’une nouvelle procédure stockée ou d’une procédure stockée existante.</span><span class="sxs-lookup"><span data-stu-id="f0368-167">Next, we are prompted as to how to query the data: through an ad-hoc SQL statement, a new stored procedure, or an existing stored procedure.</span></span> <span data-ttu-id="f0368-168">Étant donné que nous avons utilisé des requêtes SQL ad hoc dans notre couche DAL d’origine, utilisez cette option ici également.</span><span class="sxs-lookup"><span data-stu-id="f0368-168">Since we used ad-hoc SQL queries in our original DAL, use this option here as well.</span></span>

<span data-ttu-id="f0368-169">[![spécifier les données à récupérer à l’aide d’une instruction SQL ad hoc](implementing-optimistic-concurrency-vb/_static/image11.png)](implementing-optimistic-concurrency-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-169">[![Specify the Data to Retrieve Using an Ad-Hoc SQL Statement](implementing-optimistic-concurrency-vb/_static/image11.png)](implementing-optimistic-concurrency-vb/_static/image10.png)</span></span>

<span data-ttu-id="f0368-170">**Figure 4**: spécifier les données à récupérer à l’aide d’une instruction SQL ad hoc ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-170">**Figure 4**: Specify the Data to Retrieve Using an Ad-Hoc SQL Statement ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image12.png))</span></span>

<span data-ttu-id="f0368-171">Dans l’écran suivant, entrez la requête SQL à utiliser pour récupérer les informations sur le produit.</span><span class="sxs-lookup"><span data-stu-id="f0368-171">On the following screen, enter the SQL query to use to retrieve the product information.</span></span> <span data-ttu-id="f0368-172">Nous allons utiliser exactement la même requête SQL que celle utilisée pour le `Products` TableAdapter à partir de notre couche DAL d’origine, qui renvoie toutes les colonnes de `Product`, ainsi que les noms des fournisseurs et des catégories du produit :</span><span class="sxs-lookup"><span data-stu-id="f0368-172">Let's use the exact same SQL query used for the `Products` TableAdapter from our original DAL, which returns all of the `Product` columns along with the product's supplier and category names:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample2.sql)]

<span data-ttu-id="f0368-173">[![utiliser la même requête SQL à partir du TableAdapter Products dans la couche DAL d’origine](implementing-optimistic-concurrency-vb/_static/image14.png)](implementing-optimistic-concurrency-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-173">[![Use the Same SQL Query from the Products TableAdapter in the Original DAL](implementing-optimistic-concurrency-vb/_static/image14.png)](implementing-optimistic-concurrency-vb/_static/image13.png)</span></span>

<span data-ttu-id="f0368-174">**Figure 5**: utiliser la même requête SQL à partir du `Products` TableAdapter dans la couche DAL d’origine ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-174">**Figure 5**: Use the Same SQL Query from the `Products` TableAdapter in the Original DAL ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image15.png))</span></span>

<span data-ttu-id="f0368-175">Avant de passer à l’écran suivant, cliquez sur le bouton Options avancées.</span><span class="sxs-lookup"><span data-stu-id="f0368-175">Before moving onto the next screen, click the Advanced Options button.</span></span> <span data-ttu-id="f0368-176">Pour que ce TableAdapter utilise le contrôle d’accès concurrentiel optimiste, activez simplement la case à cocher « utiliser l’accès concurrentiel optimiste ».</span><span class="sxs-lookup"><span data-stu-id="f0368-176">To have this TableAdapter employ optimistic concurrency control, simply check the "Use optimistic concurrency" checkbox.</span></span>

<span data-ttu-id="f0368-177">[![activer le contrôle d’accès concurrentiel optimiste en activant la case à cocher &quot;utiliser l’accès concurrentiel optimiste&quot;](implementing-optimistic-concurrency-vb/_static/image17.png)](implementing-optimistic-concurrency-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-177">[![Enable Optimistic Concurrency Control by Checking the &quot;Use optimistic concurrency&quot; CheckBox](implementing-optimistic-concurrency-vb/_static/image17.png)](implementing-optimistic-concurrency-vb/_static/image16.png)</span></span>

<span data-ttu-id="f0368-178">**Figure 6**: activer le contrôle d’accès concurrentiel optimiste en cochant la case « utiliser l’accès concurrentiel optimiste » ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-178">**Figure 6**: Enable Optimistic Concurrency Control by Checking the "Use optimistic concurrency" CheckBox ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image18.png))</span></span>

<span data-ttu-id="f0368-179">Enfin, indiquez que le TableAdapter doit utiliser les modèles d’accès aux données qui remplissent un DataTable et retournent un DataTable ; Indiquez également que les méthodes directes de la base de</span><span class="sxs-lookup"><span data-stu-id="f0368-179">Lastly, indicate that the TableAdapter should use the data access patterns that both fill a DataTable and return a DataTable; also indicate that the DB direct methods should be created.</span></span> <span data-ttu-id="f0368-180">Modifiez le nom de la méthode pour retourner un modèle de DataTable de GetData en GetProducts, afin de refléter les conventions d’affectation de noms que nous avons utilisées dans notre couche d’origine.</span><span class="sxs-lookup"><span data-stu-id="f0368-180">Change the method name for the Return a DataTable pattern from GetData to GetProducts, so as to mirror the naming conventions we used in our original DAL.</span></span>

<span data-ttu-id="f0368-181">[![que le TableAdapter utilise tous les modèles d’accès aux données](implementing-optimistic-concurrency-vb/_static/image20.png)](implementing-optimistic-concurrency-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-181">[![Have the TableAdapter Utilize All Data Access Patterns](implementing-optimistic-concurrency-vb/_static/image20.png)](implementing-optimistic-concurrency-vb/_static/image19.png)</span></span>

<span data-ttu-id="f0368-182">**Figure 7**: faire en sorte que le TableAdapter utilise tous les modèles d’accès aux données ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-182">**Figure 7**: Have the TableAdapter Utilize All Data Access Patterns ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image21.png))</span></span>

<span data-ttu-id="f0368-183">Une fois l’exécution de l’Assistant terminée, le concepteur de DataSet inclura un `Products` et un DataTable fortement typés.</span><span class="sxs-lookup"><span data-stu-id="f0368-183">After completing the wizard, the DataSet Designer will include a strongly-typed `Products` DataTable and TableAdapter.</span></span> <span data-ttu-id="f0368-184">Prenez un moment pour renommer le DataTable de `Products` en `ProductsOptimisticConcurrency`, ce que vous pouvez faire en cliquant avec le bouton droit sur la barre de titre du DataTable et en choisissant renommer dans le menu contextuel.</span><span class="sxs-lookup"><span data-stu-id="f0368-184">Take a moment to rename the DataTable from `Products` to `ProductsOptimisticConcurrency`, which you can do by right-clicking on the DataTable's title bar and choosing Rename from the context menu.</span></span>

<span data-ttu-id="f0368-185">[![un DataTable et un TableAdapter ont été ajoutés au DataSet typé](implementing-optimistic-concurrency-vb/_static/image23.png)](implementing-optimistic-concurrency-vb/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-185">[![A DataTable and TableAdapter Have Been Added to the Typed DataSet](implementing-optimistic-concurrency-vb/_static/image23.png)](implementing-optimistic-concurrency-vb/_static/image22.png)</span></span>

<span data-ttu-id="f0368-186">**Figure 8**: un DataTable et un TableAdapter ont été ajoutés au DataSet typé ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-186">**Figure 8**: A DataTable and TableAdapter Have Been Added to the Typed DataSet ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image24.png))</span></span>

<span data-ttu-id="f0368-187">Pour voir les différences entre les requêtes `UPDATE` et `DELETE` entre le TableAdapter `ProductsOptimisticConcurrency` (qui utilise l’accès concurrentiel optimiste) et le TableAdapter Products (qui n’est pas), cliquez sur le TableAdapter et accédez au Fenêtre Propriétés.</span><span class="sxs-lookup"><span data-stu-id="f0368-187">To see the differences between the `UPDATE` and `DELETE` queries between the `ProductsOptimisticConcurrency` TableAdapter (which uses optimistic concurrency) and the Products TableAdapter (which doesn't), click on the TableAdapter and go to the Properties window.</span></span> <span data-ttu-id="f0368-188">Dans les propriétés `DeleteCommand` et `UpdateCommand` ' `CommandText` sous-propriétés, vous pouvez voir la syntaxe SQL réelle qui est envoyée à la base de données lors de l’appel des méthodes Update ou DELETE liées à la couche DAL.</span><span class="sxs-lookup"><span data-stu-id="f0368-188">In the `DeleteCommand` and `UpdateCommand` properties' `CommandText` subproperties you can see the actual SQL syntax that is sent to the database when the DAL's update or delete-related methods are invoked.</span></span> <span data-ttu-id="f0368-189">Pour le `ProductsOptimisticConcurrency` TableAdapter, l’instruction `DELETE` utilisée est :</span><span class="sxs-lookup"><span data-stu-id="f0368-189">For the `ProductsOptimisticConcurrency` TableAdapter the `DELETE` statement used is:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample3.sql)]

<span data-ttu-id="f0368-190">Tandis que l’instruction `DELETE` pour le TableAdapter de produit dans notre couche DAL d’origine est la plus simple :</span><span class="sxs-lookup"><span data-stu-id="f0368-190">Whereas the `DELETE` statement for the Product TableAdapter in our original DAL is the much simpler:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample4.sql)]

<span data-ttu-id="f0368-191">Comme vous pouvez le voir, la clause `WHERE` dans l’instruction `DELETE` pour le TableAdapter qui utilise l’accès concurrentiel optimiste comprend une comparaison entre chaque valeur de colonne existante de la table `Product` et les valeurs d’origine au moment du dernier remplissage de GridView (ou DetailsView ou FormView).</span><span class="sxs-lookup"><span data-stu-id="f0368-191">As you can see, the `WHERE` clause in the `DELETE` statement for the TableAdapter that uses optimistic concurrency includes a comparison between each of the `Product` table's existing column values and the original values at the time the GridView (or DetailsView or FormView) was last populated.</span></span> <span data-ttu-id="f0368-192">Étant donné que tous les champs autres que `ProductID`, `ProductName`et `Discontinued` peuvent avoir des valeurs `NULL`, des paramètres et des vérifications supplémentaires sont inclus pour comparer correctement les valeurs de `NULL` dans la clause `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="f0368-192">Since all fields other than `ProductID`, `ProductName`, and `Discontinued` can have `NULL` values, additional parameters and checks are included to correctly compare `NULL` values in the `WHERE` clause.</span></span>

<span data-ttu-id="f0368-193">Nous n’ajoutons pas de DataTables supplémentaires au jeu de données d’accès concurrentiel optimiste pour ce didacticiel, car notre page ASP.NET fournit uniquement des informations sur les produits de mise à jour et de suppression.</span><span class="sxs-lookup"><span data-stu-id="f0368-193">We won't be adding any additional DataTables to the optimistic concurrency-enabled DataSet for this tutorial, as our ASP.NET page will only provide updating and deleting product information.</span></span> <span data-ttu-id="f0368-194">Toutefois, nous devons toujours ajouter la méthode `GetProductByProductID(productID)` au TableAdapter `ProductsOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="f0368-194">However, we do still need to add the `GetProductByProductID(productID)` method to the `ProductsOptimisticConcurrency` TableAdapter.</span></span>

<span data-ttu-id="f0368-195">Pour ce faire, cliquez avec le bouton droit sur la barre de titre du TableAdapter (la zone située juste au-dessus du `Fill` et `GetProducts` noms de méthode), puis choisissez Ajouter une requête dans le menu contextuel.</span><span class="sxs-lookup"><span data-stu-id="f0368-195">To accomplish this, right-click on the TableAdapter's title bar (the area right above the `Fill` and `GetProducts` method names) and choose Add Query from the context menu.</span></span> <span data-ttu-id="f0368-196">Cette opération lance l’Assistant Configuration de requêtes TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="f0368-196">This will launch the TableAdapter Query Configuration Wizard.</span></span> <span data-ttu-id="f0368-197">Comme pour la configuration initiale de votre TableAdapter, choisissez de créer la méthode `GetProductByProductID(productID)` à l’aide d’une instruction SQL ad hoc (voir figure 4).</span><span class="sxs-lookup"><span data-stu-id="f0368-197">As with our TableAdapter's initial configuration, opt to create the `GetProductByProductID(productID)` method using an ad-hoc SQL statement (see Figure 4).</span></span> <span data-ttu-id="f0368-198">Étant donné que la méthode `GetProductByProductID(productID)` retourne des informations sur un produit particulier, indiquez que cette requête est un `SELECT` type de requête qui retourne des lignes.</span><span class="sxs-lookup"><span data-stu-id="f0368-198">Since the `GetProductByProductID(productID)` method returns information about a particular product, indicate that this query is a `SELECT` query type that returns rows.</span></span>

<span data-ttu-id="f0368-199">[![marquer le type de requête en tant que &quot;SELECT qui retourne des lignes&quot;](implementing-optimistic-concurrency-vb/_static/image26.png)](implementing-optimistic-concurrency-vb/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-199">[![Mark the Query Type as a &quot;SELECT which returns rows&quot;](implementing-optimistic-concurrency-vb/_static/image26.png)](implementing-optimistic-concurrency-vb/_static/image25.png)</span></span>

<span data-ttu-id="f0368-200">**Figure 9**: marquer le type de requête en tant que «`SELECT` qui retourne des lignes » ([Cliquer pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image27.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-200">**Figure 9**: Mark the Query Type as a "`SELECT` which returns rows" ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image27.png))</span></span>

<span data-ttu-id="f0368-201">Dans l’écran suivant, nous sommes invités à entrer la requête SQL à utiliser, avec la requête par défaut du TableAdapter préchargée.</span><span class="sxs-lookup"><span data-stu-id="f0368-201">On the next screen we're prompted for the SQL query to use, with the TableAdapter's default query pre-loaded.</span></span> <span data-ttu-id="f0368-202">Augmentez la requête existante pour inclure la clause `WHERE ProductID = @ProductID`, comme illustré à la figure 10.</span><span class="sxs-lookup"><span data-stu-id="f0368-202">Augment the existing query to include the clause `WHERE ProductID = @ProductID`, as shown in Figure 10.</span></span>

<span data-ttu-id="f0368-203">[![ajouter une clause WHERE à la requête préchargée pour retourner un enregistrement Product spécifique](implementing-optimistic-concurrency-vb/_static/image29.png)](implementing-optimistic-concurrency-vb/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-203">[![Add a WHERE Clause to the Pre-Loaded Query to Return a Specific Product Record](implementing-optimistic-concurrency-vb/_static/image29.png)](implementing-optimistic-concurrency-vb/_static/image28.png)</span></span>

<span data-ttu-id="f0368-204">**Figure 10**: ajouter une clause `WHERE` à la requête préchargée pour retourner un enregistrement de produit spécifique ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image30.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-204">**Figure 10**: Add a `WHERE` Clause to the Pre-Loaded Query to Return a Specific Product Record ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image30.png))</span></span>

<span data-ttu-id="f0368-205">Enfin, modifiez les noms des méthodes générées pour `FillByProductID` et `GetProductByProductID`.</span><span class="sxs-lookup"><span data-stu-id="f0368-205">Finally, change the generated method names to `FillByProductID` and `GetProductByProductID`.</span></span>

<span data-ttu-id="f0368-206">[![renommez les méthodes FillByProductID et GetProductByProductID](implementing-optimistic-concurrency-vb/_static/image32.png)](implementing-optimistic-concurrency-vb/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-206">[![Rename the Methods to FillByProductID and GetProductByProductID](implementing-optimistic-concurrency-vb/_static/image32.png)](implementing-optimistic-concurrency-vb/_static/image31.png)</span></span>

<span data-ttu-id="f0368-207">**Figure 11**: renommer les méthodes pour `FillByProductID` et `GetProductByProductID` ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image33.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-207">**Figure 11**: Rename the Methods to `FillByProductID` and `GetProductByProductID` ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image33.png))</span></span>

<span data-ttu-id="f0368-208">À l’issue de l’exécution de cet Assistant, le TableAdapter contient maintenant deux méthodes pour récupérer des données : `GetProducts()`, qui retourne *tous les* produits ; et `GetProductByProductID(productID)`, qui retourne le produit spécifié.</span><span class="sxs-lookup"><span data-stu-id="f0368-208">With this wizard complete, the TableAdapter now contains two methods for retrieving data: `GetProducts()`, which returns *all* products; and `GetProductByProductID(productID)`, which returns the specified product.</span></span>

## <a name="step-3-creating-a-business-logic-layer-for-the-optimistic-concurrency-enabled-dal"></a><span data-ttu-id="f0368-209">Étape 3 : création d’une couche de logique métier pour la couche DAL avec accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="f0368-209">Step 3: Creating a Business Logic Layer for the Optimistic Concurrency-Enabled DAL</span></span>

<span data-ttu-id="f0368-210">Notre classe de `ProductsBLL` existante contient des exemples d’utilisation des modèles de mise à jour par lot et de base de base de donnés.</span><span class="sxs-lookup"><span data-stu-id="f0368-210">Our existing `ProductsBLL` class has examples of using both the batch update and DB direct patterns.</span></span> <span data-ttu-id="f0368-211">La méthode `AddProduct` et les surcharges de `UpdateProduct` utilisent le modèle de mise à jour par lot, en passant une instance de `ProductRow` à la méthode de mise à jour du TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="f0368-211">The `AddProduct` method and `UpdateProduct` overloads both use the batch update pattern, passing in a `ProductRow` instance to the TableAdapter's Update method.</span></span> <span data-ttu-id="f0368-212">La méthode `DeleteProduct`, en revanche, utilise le modèle de base de base de type direct, en appelant la méthode `Delete(productID)` du TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="f0368-212">The `DeleteProduct` method, on the other hand, uses the DB direct pattern, calling the TableAdapter's `Delete(productID)` method.</span></span>

<span data-ttu-id="f0368-213">Avec la nouvelle `ProductsOptimisticConcurrency` TableAdapter, les méthodes de base de base de base de source nécessitent désormais que les valeurs d’origine soient également transmises.</span><span class="sxs-lookup"><span data-stu-id="f0368-213">With the new `ProductsOptimisticConcurrency` TableAdapter, the DB direct methods now require that the original values also be passed in.</span></span> <span data-ttu-id="f0368-214">Par exemple, la méthode `Delete` attend maintenant dix paramètres d’entrée : le `ProductID`d’origine, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`et `Discontinued`.</span><span class="sxs-lookup"><span data-stu-id="f0368-214">For example, the `Delete` method now expects ten input parameters: the original `ProductID`, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`, and `Discontinued`.</span></span> <span data-ttu-id="f0368-215">Elle utilise ces valeurs de paramètres d’entrée supplémentaires dans `WHERE` clause de l’instruction `DELETE` envoyée à la base de données, en supprimant uniquement l’enregistrement spécifié si les valeurs actuelles de la base de données sont mappées à celles d’origine.</span><span class="sxs-lookup"><span data-stu-id="f0368-215">It uses these additional input parameters' values in `WHERE` clause of the `DELETE` statement sent to the database, only deleting the specified record if the database's current values map up to the original ones.</span></span>

<span data-ttu-id="f0368-216">Alors que la signature de méthode pour la méthode de `Update` du TableAdapter utilisée dans le modèle de mise à jour par lot n’a pas changé, le code nécessaire pour enregistrer les valeurs d’origine et nouvelles.</span><span class="sxs-lookup"><span data-stu-id="f0368-216">While the method signature for the TableAdapter's `Update` method used in the batch update pattern hasn't changed, the code needed to record the original and new values has.</span></span> <span data-ttu-id="f0368-217">Par conséquent, au lieu de tenter d’utiliser la couche DAL avec accès concurrentiel optimiste avec notre classe de `ProductsBLL` existante, nous allons créer une nouvelle classe de couche de logique métier pour travailler avec notre nouvelle couche DAL.</span><span class="sxs-lookup"><span data-stu-id="f0368-217">Therefore, rather than attempt to use the optimistic concurrency-enabled DAL with our existing `ProductsBLL` class, let's create a new Business Logic Layer class for working with our new DAL.</span></span>

<span data-ttu-id="f0368-218">Ajoutez une classe nommée `ProductsOptimisticConcurrencyBLL` au dossier `BLL` dans le dossier `App_Code`.</span><span class="sxs-lookup"><span data-stu-id="f0368-218">Add a class named `ProductsOptimisticConcurrencyBLL` to the `BLL` folder within the `App_Code` folder.</span></span>

![Ajoutez la classe ProductsOptimisticConcurrencyBLL au dossier BLL](implementing-optimistic-concurrency-vb/_static/image34.png)

<span data-ttu-id="f0368-220">**Figure 12**: ajouter la classe `ProductsOptimisticConcurrencyBLL` au dossier BLL</span><span class="sxs-lookup"><span data-stu-id="f0368-220">**Figure 12**: Add the `ProductsOptimisticConcurrencyBLL` Class to the BLL Folder</span></span>

<span data-ttu-id="f0368-221">Ensuite, ajoutez le code suivant à la classe `ProductsOptimisticConcurrencyBLL` :</span><span class="sxs-lookup"><span data-stu-id="f0368-221">Next, add the following code to the `ProductsOptimisticConcurrencyBLL` class:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample5.vb)]

<span data-ttu-id="f0368-222">Notez l’instruction using `NorthwindOptimisticConcurrencyTableAdapters` au-dessus du début de la déclaration de classe.</span><span class="sxs-lookup"><span data-stu-id="f0368-222">Note the using `NorthwindOptimisticConcurrencyTableAdapters` statement above the start of the class declaration.</span></span> <span data-ttu-id="f0368-223">L’espace de noms `NorthwindOptimisticConcurrencyTableAdapters` contient la classe `ProductsOptimisticConcurrencyTableAdapter`, qui fournit les méthodes de la couche DAL.</span><span class="sxs-lookup"><span data-stu-id="f0368-223">The `NorthwindOptimisticConcurrencyTableAdapters` namespace contains the `ProductsOptimisticConcurrencyTableAdapter` class, which provides the DAL's methods.</span></span> <span data-ttu-id="f0368-224">En outre, avant la déclaration de classe, vous trouverez l’attribut `System.ComponentModel.DataObject`, qui indique à Visual Studio d’inclure cette classe dans la liste déroulante de l’Assistant ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="f0368-224">Also before the class declaration you'll find the `System.ComponentModel.DataObject` attribute, which instructs Visual Studio to include this class in the ObjectDataSource wizard's drop-down list.</span></span>

<span data-ttu-id="f0368-225">La propriété `Adapter` de `ProductsOptimisticConcurrencyBLL`fournit un accès rapide à une instance de la classe `ProductsOptimisticConcurrencyTableAdapter` et suit le modèle utilisé dans nos classes BLL d’origine (`ProductsBLL`, `CategoriesBLL`, etc.).</span><span class="sxs-lookup"><span data-stu-id="f0368-225">The `ProductsOptimisticConcurrencyBLL`'s `Adapter` property provides quick access to an instance of the `ProductsOptimisticConcurrencyTableAdapter` class, and follows the pattern used in our original BLL classes (`ProductsBLL`, `CategoriesBLL`, and so on).</span></span> <span data-ttu-id="f0368-226">Enfin, la méthode `GetProducts()` appelle simplement la méthode `GetProducts()` de la couche DAL et retourne un objet `ProductsOptimisticConcurrencyDataTable` rempli avec une instance `ProductsOptimisticConcurrencyRow` pour chaque enregistrement de produit dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="f0368-226">Finally, the `GetProducts()` method simply calls down into the DAL's `GetProducts()` method and returns a `ProductsOptimisticConcurrencyDataTable` object populated with a `ProductsOptimisticConcurrencyRow` instance for each product record in the database.</span></span>

## <a name="deleting-a-product-using-the-db-direct-pattern-with-optimistic-concurrency"></a><span data-ttu-id="f0368-227">Suppression d’un produit à l’aide du modèle de base de données direct avec accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="f0368-227">Deleting a Product Using the DB Direct Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="f0368-228">Lorsque vous utilisez le modèle de base de données direct sur une couche DAL qui utilise l’accès concurrentiel optimiste, les méthodes doivent être passées aux valeurs nouvelles et d’origine.</span><span class="sxs-lookup"><span data-stu-id="f0368-228">When using the DB direct pattern against a DAL that uses optimistic concurrency, the methods must be passed the new and original values.</span></span> <span data-ttu-id="f0368-229">Pour la suppression, il n’y a aucune nouvelle valeur, donc seules les valeurs d’origine doivent être passées.</span><span class="sxs-lookup"><span data-stu-id="f0368-229">For deleting, there are no new values, so only the original values need be passed in.</span></span> <span data-ttu-id="f0368-230">Dans notre couche BLL, ensuite, nous devons accepter tous les paramètres d’origine comme paramètres d’entrée.</span><span class="sxs-lookup"><span data-stu-id="f0368-230">In our BLL, then, we must accept all of the original parameters as input parameters.</span></span> <span data-ttu-id="f0368-231">Supposons que la méthode `DeleteProduct` dans la classe `ProductsOptimisticConcurrencyBLL` utilise la méthode DB direct.</span><span class="sxs-lookup"><span data-stu-id="f0368-231">Let's have the `DeleteProduct` method in the `ProductsOptimisticConcurrencyBLL` class use the DB direct method.</span></span> <span data-ttu-id="f0368-232">Cela signifie que cette méthode doit prendre les dix champs de données de produit comme paramètres d’entrée et les transmettre à la couche DAL, comme illustré dans le code suivant :</span><span class="sxs-lookup"><span data-stu-id="f0368-232">This means that this method needs to take in all ten product data fields as input parameters, and pass these to the DAL, as shown in the following code:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample6.vb)]

<span data-ttu-id="f0368-233">Si les valeurs d’origine (les valeurs qui ont été chargées dans le contrôle GridView (ou DetailsView ou FormView)) diffèrent des valeurs de la base de données lorsque l’utilisateur clique sur le bouton supprimer, la clause `WHERE` ne correspond à aucun enregistrement de base de données et aucun enregistrement n’est affecté.</span><span class="sxs-lookup"><span data-stu-id="f0368-233">If the original values - those values that were last loaded into the GridView (or DetailsView or FormView) - differ from the values in the database when the user clicks the Delete button the `WHERE` clause won't match up with any database record and no records will be affected.</span></span> <span data-ttu-id="f0368-234">Par conséquent, la méthode `Delete` du TableAdapter retourne `0` et la méthode `DeleteProduct` de la couche BLL retourne `false`.</span><span class="sxs-lookup"><span data-stu-id="f0368-234">Hence, the TableAdapter's `Delete` method will return `0` and the BLL's `DeleteProduct` method will return `false`.</span></span>

## <a name="updating-a-product-using-the-batch-update-pattern-with-optimistic-concurrency"></a><span data-ttu-id="f0368-235">Mise à jour d’un produit à l’aide du modèle de mise à jour par lot avec accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="f0368-235">Updating a Product Using the Batch Update Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="f0368-236">Comme indiqué précédemment, la méthode `Update` du TableAdapter pour le modèle de mise à jour par lot a la même signature de méthode que l’accès concurrentiel optimiste soit utilisé ou non.</span><span class="sxs-lookup"><span data-stu-id="f0368-236">As noted earlier, the TableAdapter's `Update` method for the batch update pattern has the same method signature regardless of whether or not optimistic concurrency is employed.</span></span> <span data-ttu-id="f0368-237">À savoir, la méthode `Update` attend un DataRow, un tableau de DataRows, un DataTable ou un DataSet typé.</span><span class="sxs-lookup"><span data-stu-id="f0368-237">Namely, the `Update` method expects a DataRow, an array of DataRows, a DataTable, or a Typed DataSet.</span></span> <span data-ttu-id="f0368-238">Il n’existe pas de paramètres d’entrée supplémentaires pour spécifier les valeurs d’origine.</span><span class="sxs-lookup"><span data-stu-id="f0368-238">There are no additional input parameters for specifying the original values.</span></span> <span data-ttu-id="f0368-239">Cela est possible car le DataTable effectue le suivi des valeurs d’origine et modifiées pour ses DataRow (s).</span><span class="sxs-lookup"><span data-stu-id="f0368-239">This is possible because the DataTable keeps track of the original and modified values for its DataRow(s).</span></span> <span data-ttu-id="f0368-240">Lorsque la couche DAL émet son instruction `UPDATE`, les paramètres `@original_ColumnName` sont remplis avec les valeurs d’origine du DataRow, tandis que les paramètres `@ColumnName` sont remplis avec les valeurs modifiées du DataRow.</span><span class="sxs-lookup"><span data-stu-id="f0368-240">When the DAL issues its `UPDATE` statement, the `@original_ColumnName` parameters are populated with the DataRow's original values, whereas the `@ColumnName` parameters are populated with the DataRow's modified values.</span></span>

<span data-ttu-id="f0368-241">Dans la classe `ProductsBLL` (qui utilise notre couche DAL d’accès concurrentiel d’origine non optimiste), lorsque vous utilisez le modèle de mise à jour par lot pour mettre à jour les informations sur le produit, notre code exécute la séquence d’événements suivante :</span><span class="sxs-lookup"><span data-stu-id="f0368-241">In the `ProductsBLL` class (which uses our original, non-optimistic concurrency DAL), when using the batch update pattern to update product information our code performs the following sequence of events:</span></span>

1. <span data-ttu-id="f0368-242">Lire les informations sur le produit de la base de données actuelle dans une instance de `ProductRow` à l’aide de la méthode `GetProductByProductID(productID)` du TableAdapter</span><span class="sxs-lookup"><span data-stu-id="f0368-242">Read the current database product information into a `ProductRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="f0368-243">Assignez les nouvelles valeurs à l’instance de `ProductRow` à partir de l’étape 1</span><span class="sxs-lookup"><span data-stu-id="f0368-243">Assign the new values to the `ProductRow` instance from Step 1</span></span>
3. <span data-ttu-id="f0368-244">Appelez la méthode `Update` du TableAdapter, en passant l’instance `ProductRow`</span><span class="sxs-lookup"><span data-stu-id="f0368-244">Call the TableAdapter's `Update` method, passing in the `ProductRow` instance</span></span>

<span data-ttu-id="f0368-245">Cette séquence d’étapes, cependant, ne prend pas en charge l’accès concurrentiel optimiste car le `ProductRow` rempli à l’étape 1 est renseigné directement à partir de la base de données, ce qui signifie que les valeurs d’origine utilisées par le DataRow sont celles qui existent actuellement dans la base de données, et non celles qui étaient liées au GridView au début du processus de modification.</span><span class="sxs-lookup"><span data-stu-id="f0368-245">This sequence of steps, however, won't correctly support optimistic concurrency because the `ProductRow` populated in Step 1 is populated directly from the database, meaning that the original values used by the DataRow are those that currently exist in the database, and not those that were bound to the GridView at the start of the editing process.</span></span> <span data-ttu-id="f0368-246">Au lieu de cela, lors de l’utilisation d’une couche DAL avec accès concurrentiel optimiste, nous devons modifier les surcharges de méthode `UpdateProduct` pour utiliser les étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="f0368-246">Instead, when using an optimistic concurrency-enabled DAL, we need to alter the `UpdateProduct` method overloads to use the following steps:</span></span>

1. <span data-ttu-id="f0368-247">Lire les informations sur le produit de la base de données actuelle dans une instance de `ProductsOptimisticConcurrencyRow` à l’aide de la méthode `GetProductByProductID(productID)` du TableAdapter</span><span class="sxs-lookup"><span data-stu-id="f0368-247">Read the current database product information into a `ProductsOptimisticConcurrencyRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="f0368-248">Assignez les valeurs *d’origine* à l’instance de `ProductsOptimisticConcurrencyRow` à partir de l’étape 1</span><span class="sxs-lookup"><span data-stu-id="f0368-248">Assign the *original* values to the `ProductsOptimisticConcurrencyRow` instance from Step 1</span></span>
3. <span data-ttu-id="f0368-249">Appelez la méthode `AcceptChanges()` de l’instance `ProductsOptimisticConcurrencyRow`, qui indique à DataRow que ses valeurs actuelles sont les « d’origine ».</span><span class="sxs-lookup"><span data-stu-id="f0368-249">Call the `ProductsOptimisticConcurrencyRow` instance's `AcceptChanges()` method, which instructs the DataRow that its current values are the "original" ones</span></span>
4. <span data-ttu-id="f0368-250">Assigner les *nouvelles* valeurs à l’instance `ProductsOptimisticConcurrencyRow`</span><span class="sxs-lookup"><span data-stu-id="f0368-250">Assign the *new* values to the `ProductsOptimisticConcurrencyRow` instance</span></span>
5. <span data-ttu-id="f0368-251">Appelez la méthode `Update` du TableAdapter, en passant l’instance `ProductsOptimisticConcurrencyRow`</span><span class="sxs-lookup"><span data-stu-id="f0368-251">Call the TableAdapter's `Update` method, passing in the `ProductsOptimisticConcurrencyRow` instance</span></span>

<span data-ttu-id="f0368-252">L’étape 1 lit toutes les valeurs de la base de données actuelle pour l’enregistrement du produit spécifié.</span><span class="sxs-lookup"><span data-stu-id="f0368-252">Step 1 reads in all of the current database values for the specified product record.</span></span> <span data-ttu-id="f0368-253">Cette étape est superflue dans la surcharge `UpdateProduct` qui met à jour *toutes* les colonnes de produit (puisque ces valeurs sont remplacées à l’étape 2), mais est essentielle pour ces surcharges où seul un sous-ensemble des valeurs de colonne est transmis en tant que paramètres d’entrée.</span><span class="sxs-lookup"><span data-stu-id="f0368-253">This step is superfluous in the `UpdateProduct` overload that updates *all* of the product columns (as these values are overwritten in Step 2), but is essential for those overloads where only a subset of the column values are passed in as input parameters.</span></span> <span data-ttu-id="f0368-254">Une fois que les valeurs d’origine ont été assignées à l’instance `ProductsOptimisticConcurrencyRow`, la méthode `AcceptChanges()` est appelée, ce qui marque les valeurs DataRow actuelles comme valeurs d’origine à utiliser dans les paramètres de `@original_ColumnName` de l’instruction `UPDATE`.</span><span class="sxs-lookup"><span data-stu-id="f0368-254">Once the original values have been assigned to the `ProductsOptimisticConcurrencyRow` instance, the `AcceptChanges()` method is called, which marks the current DataRow values as the original values to be used in the `@original_ColumnName` parameters in the `UPDATE` statement.</span></span> <span data-ttu-id="f0368-255">Ensuite, les nouvelles valeurs de paramètre sont assignées au `ProductsOptimisticConcurrencyRow` et, enfin, la méthode `Update` est appelée, passant le DataRow.</span><span class="sxs-lookup"><span data-stu-id="f0368-255">Next, the new parameter values are assigned to the `ProductsOptimisticConcurrencyRow` and, finally, the `Update` method is invoked, passing in the DataRow.</span></span>

<span data-ttu-id="f0368-256">Le code suivant illustre la surcharge `UpdateProduct` qui accepte tous les champs de données de produit comme paramètres d’entrée.</span><span class="sxs-lookup"><span data-stu-id="f0368-256">The following code shows the `UpdateProduct` overload that accepts all product data fields as input parameters.</span></span> <span data-ttu-id="f0368-257">Bien que cela ne soit pas illustré ici, la classe `ProductsOptimisticConcurrencyBLL` incluse dans le téléchargement de ce didacticiel contient également une surcharge `UpdateProduct` qui accepte uniquement le nom et le prix du produit en tant que paramètres d’entrée.</span><span class="sxs-lookup"><span data-stu-id="f0368-257">While not shown here, the `ProductsOptimisticConcurrencyBLL` class included in the download for this tutorial also contains an `UpdateProduct` overload that accepts just the product's name and price as input parameters.</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample7.vb)]

## <a name="step-4-passing-the-original-and-new-values-from-the-aspnet-page-to-the-bll-methods"></a><span data-ttu-id="f0368-258">Étape 4 : passage des valeurs d’origine et nouvelles à partir de la page ASP.NET aux méthodes BLL</span><span class="sxs-lookup"><span data-stu-id="f0368-258">Step 4: Passing the Original and New Values From the ASP.NET Page to the BLL Methods</span></span>

<span data-ttu-id="f0368-259">Une fois la couche DAL et la couche BLL terminées, il ne reste plus qu’à créer une page ASP.NET qui peut utiliser la logique d’accès concurrentiel optimiste intégrée au système.</span><span class="sxs-lookup"><span data-stu-id="f0368-259">With the DAL and BLL complete, all that remains is to create an ASP.NET page that can utilize the optimistic concurrency logic built in to the system.</span></span> <span data-ttu-id="f0368-260">Plus précisément, le contrôle Web de données (GridView, DetailsView ou FormView) doit mémoriser ses valeurs d’origine et ObjectDataSource doit passer les deux ensembles de valeurs à la couche de logique métier.</span><span class="sxs-lookup"><span data-stu-id="f0368-260">Specifically, the data Web control (the GridView, DetailsView, or FormView) must remember its original values and the ObjectDataSource must pass both sets of values to the Business Logic Layer.</span></span> <span data-ttu-id="f0368-261">En outre, la page ASP.NET doit être configurée pour gérer correctement les violations d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="f0368-261">Furthermore, the ASP.NET page must be configured to gracefully handle concurrency violations.</span></span>

<span data-ttu-id="f0368-262">Commencez par ouvrir la page `OptimisticConcurrency.aspx` dans le dossier `EditInsertDelete` et ajoutez un GridView au concepteur, en affectant à sa propriété `ID` la valeur `ProductsGrid`.</span><span class="sxs-lookup"><span data-stu-id="f0368-262">Start by opening the `OptimisticConcurrency.aspx` page in the `EditInsertDelete` folder and adding a GridView to the Designer, setting its `ID` property to `ProductsGrid`.</span></span> <span data-ttu-id="f0368-263">À partir de la balise active de GridView, choisissez de créer un nouvel ObjectDataSource nommé `ProductsOptimisticConcurrencyDataSource`.</span><span class="sxs-lookup"><span data-stu-id="f0368-263">From the GridView's smart tag, opt to create a new ObjectDataSource named `ProductsOptimisticConcurrencyDataSource`.</span></span> <span data-ttu-id="f0368-264">Comme nous voulons que cet ObjectDataSource utilise la couche DAL qui prend en charge l’accès concurrentiel optimiste, configurez-le pour qu’il utilise l’objet `ProductsOptimisticConcurrencyBLL`.</span><span class="sxs-lookup"><span data-stu-id="f0368-264">Since we want this ObjectDataSource to use the DAL that supports optimistic concurrency, configure it to use the `ProductsOptimisticConcurrencyBLL` object.</span></span>

<span data-ttu-id="f0368-265">[![que ObjectDataSource utilise l’objet ProductsOptimisticConcurrencyBLL](implementing-optimistic-concurrency-vb/_static/image36.png)](implementing-optimistic-concurrency-vb/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-265">[![Have the ObjectDataSource Use the ProductsOptimisticConcurrencyBLL Object](implementing-optimistic-concurrency-vb/_static/image36.png)](implementing-optimistic-concurrency-vb/_static/image35.png)</span></span>

<span data-ttu-id="f0368-266">**Figure 13**: demander à ObjectDataSource d’utiliser l’objet `ProductsOptimisticConcurrencyBLL` ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image37.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-266">**Figure 13**: Have the ObjectDataSource Use the `ProductsOptimisticConcurrencyBLL` Object ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image37.png))</span></span>

<span data-ttu-id="f0368-267">Choisissez les méthodes `GetProducts`, `UpdateProduct`et `DeleteProduct` dans les listes déroulantes de l’Assistant.</span><span class="sxs-lookup"><span data-stu-id="f0368-267">Choose the `GetProducts`, `UpdateProduct`, and `DeleteProduct` methods from drop-down lists in the wizard.</span></span> <span data-ttu-id="f0368-268">Pour la méthode UpdateProduct, utilisez la surcharge qui accepte tous les champs de données du produit.</span><span class="sxs-lookup"><span data-stu-id="f0368-268">For the UpdateProduct method, use the overload that accepts all of the product's data fields.</span></span>

## <a name="configuring-the-objectdatasource-controls-properties"></a><span data-ttu-id="f0368-269">Configuration des propriétés du contrôle ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="f0368-269">Configuring the ObjectDataSource Control's Properties</span></span>

<span data-ttu-id="f0368-270">Une fois l’exécution de l’Assistant terminée, le balisage déclaratif de ObjectDataSource doit ressembler à ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="f0368-270">After completing the wizard, the ObjectDataSource's declarative markup should look like the following:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample8.aspx)]

<span data-ttu-id="f0368-271">Comme vous pouvez le voir, la collection `DeleteParameters` contient une instance `Parameter` pour chacun des dix paramètres d’entrée de la méthode `DeleteProduct` de la classe `ProductsOptimisticConcurrencyBLL`.</span><span class="sxs-lookup"><span data-stu-id="f0368-271">As you can see, the `DeleteParameters` collection contains a `Parameter` instance for each of the ten input parameters in the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method.</span></span> <span data-ttu-id="f0368-272">De même, la collection `UpdateParameters` contient une instance `Parameter` pour chacun des paramètres d’entrée dans `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="f0368-272">Likewise, the `UpdateParameters` collection contains a `Parameter` instance for each of the input parameters in `UpdateProduct`.</span></span>

<span data-ttu-id="f0368-273">Pour les didacticiels précédents qui impliquaient la modification des données, nous supprimons la propriété ObjectDataSource `OldValuesParameterFormatString` à ce stade, car cette propriété indique que la méthode BLL attend que les anciennes valeurs (ou d’origine) soient passées, ainsi que les nouvelles valeurs.</span><span class="sxs-lookup"><span data-stu-id="f0368-273">For those previous tutorials that involved data modification, we'd remove the ObjectDataSource's `OldValuesParameterFormatString` property at this point, since this property indicates that the BLL method expects the old (or original) values to be passed in as well as the new values.</span></span> <span data-ttu-id="f0368-274">En outre, cette valeur de propriété indique les noms des paramètres d’entrée pour les valeurs d’origine.</span><span class="sxs-lookup"><span data-stu-id="f0368-274">Furthermore, this property value indicates the input parameter names for the original values.</span></span> <span data-ttu-id="f0368-275">Étant donné que nous transmettons les valeurs d’origine dans la couche BLL, ne supprimez *pas* cette propriété.</span><span class="sxs-lookup"><span data-stu-id="f0368-275">Since we are passing in the original values into the BLL, do *not* remove this property.</span></span>

> [!NOTE]
> <span data-ttu-id="f0368-276">La valeur de la propriété `OldValuesParameterFormatString` doit correspondre aux noms de paramètres d’entrée dans la couche BLL qui attendent les valeurs d’origine.</span><span class="sxs-lookup"><span data-stu-id="f0368-276">The value of the `OldValuesParameterFormatString` property must map to the input parameter names in the BLL that expect the original values.</span></span> <span data-ttu-id="f0368-277">Étant donné que nous avons nommé ces paramètres `original_productName`, `original_supplierID`, etc., vous pouvez conserver la valeur de la propriété `OldValuesParameterFormatString` en tant que `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="f0368-277">Since we named these parameters `original_productName`, `original_supplierID`, and so on, you can leave the `OldValuesParameterFormatString` property value as `original_{0}`.</span></span> <span data-ttu-id="f0368-278">Toutefois, si les paramètres d’entrée de la méthode BLL comportent des noms comme `old_productName`, `old_supplierID`, etc., vous devez mettre à jour la propriété `OldValuesParameterFormatString` pour `old_{0}`.</span><span class="sxs-lookup"><span data-stu-id="f0368-278">If, however, the BLL methods' input parameters had names like `old_productName`, `old_supplierID`, and so on, you'd need to update the `OldValuesParameterFormatString` property to `old_{0}`.</span></span>

<span data-ttu-id="f0368-279">Il existe un paramètre de propriété final qui doit être défini pour que ObjectDataSource passe correctement les valeurs d’origine aux méthodes BLL.</span><span class="sxs-lookup"><span data-stu-id="f0368-279">There's one final property setting that needs to be made in order for the ObjectDataSource to correctly pass the original values to the BLL methods.</span></span> <span data-ttu-id="f0368-280">ObjectDataSource a une [propriété ConflictDetection](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) qui peut être assignée à [l’une des deux valeurs](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx)suivantes :</span><span class="sxs-lookup"><span data-stu-id="f0368-280">The ObjectDataSource has a [ConflictDetection property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) that can be assigned to [one of two values](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span></span>

- <span data-ttu-id="f0368-281">`OverwriteChanges`-la valeur par défaut ; n’envoie pas les valeurs d’origine aux paramètres d’entrée d’origine des méthodes BLL</span><span class="sxs-lookup"><span data-stu-id="f0368-281">`OverwriteChanges` - the default value; does not send the original values to the BLL methods' original input parameters</span></span>
- <span data-ttu-id="f0368-282">`CompareAllValues`-envoie les valeurs d’origine aux méthodes BLL ; Choisissez cette option lors de l’utilisation de l’accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="f0368-282">`CompareAllValues` - does send the original values to the BLL methods; choose this option when using optimistic concurrency</span></span>

<span data-ttu-id="f0368-283">Prenez un moment pour définir la propriété `ConflictDetection` sur `CompareAllValues`.</span><span class="sxs-lookup"><span data-stu-id="f0368-283">Take a moment to set the `ConflictDetection` property to `CompareAllValues`.</span></span>

## <a name="configuring-the-gridviews-properties-and-fields"></a><span data-ttu-id="f0368-284">Configuration des propriétés et des champs de GridView</span><span class="sxs-lookup"><span data-stu-id="f0368-284">Configuring the GridView's Properties and Fields</span></span>

<span data-ttu-id="f0368-285">Avec les propriétés ObjectDataSource correctement configurées, nous allons nous pencher sur la configuration du contrôle GridView.</span><span class="sxs-lookup"><span data-stu-id="f0368-285">With the ObjectDataSource's properties properly configured, let's turn our attention to setting up the GridView.</span></span> <span data-ttu-id="f0368-286">Tout d’abord, puisque nous voulons que le GridView prenne en charge la modification et la suppression, activez les cases à cocher Activer la modification et activer la suppression à partir de la balise active de GridView.</span><span class="sxs-lookup"><span data-stu-id="f0368-286">First, since we want the GridView to support editing and deleting, click the Enable Editing and Enable Deleting checkboxes from the GridView's smart tag.</span></span> <span data-ttu-id="f0368-287">Cette opération ajoute un CommandField dont les `ShowEditButton` et `ShowDeleteButton` ont tous les deux la valeur `true`.</span><span class="sxs-lookup"><span data-stu-id="f0368-287">This will add a CommandField whose `ShowEditButton` and `ShowDeleteButton` are both set to `true`.</span></span>

<span data-ttu-id="f0368-288">Lorsqu’il est lié au `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, le GridView contient un champ pour chacun des champs de données du produit.</span><span class="sxs-lookup"><span data-stu-id="f0368-288">When bound to the `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, the GridView contains a field for each of the product's data fields.</span></span> <span data-ttu-id="f0368-289">Bien qu’un tel GridView puisse être modifié, l’expérience utilisateur est tout à fait acceptable.</span><span class="sxs-lookup"><span data-stu-id="f0368-289">While such a GridView can be edited, the user experience is anything but acceptable.</span></span> <span data-ttu-id="f0368-290">Le `CategoryID` et `SupplierID` BoundFields s’affichent sous forme de zones de texte, ce qui oblige l’utilisateur à entrer la catégorie et le fournisseur appropriés comme numéros d’identification.</span><span class="sxs-lookup"><span data-stu-id="f0368-290">The `CategoryID` and `SupplierID` BoundFields will render as TextBoxes, requiring the user to enter the appropriate category and supplier as ID numbers.</span></span> <span data-ttu-id="f0368-291">Il n’y aura aucune mise en forme pour les champs numériques et aucun contrôle de validation pour vous assurer que le nom du produit a été fourni et que le prix unitaire, les unités en stock, les unités sur la commande et les valeurs de niveau de réorganisation sont des valeurs numériques correctes et sont supérieures ou égales à zéro.</span><span class="sxs-lookup"><span data-stu-id="f0368-291">There will be no formatting for the numeric fields and no validation controls to ensure that the product's name has been supplied and that the unit price, units in stock, units on order, and reorder level values are both proper numeric values and are greater than or equal to zero.</span></span>

<span data-ttu-id="f0368-292">Comme nous l’avons vu dans l’article *Ajout de contrôles de validation aux interfaces de modification et d’insertion* et personnalisation des didacticiels de l' *interface de modification des données* , vous pouvez personnaliser l’interface utilisateur en remplaçant BoundFields par TemplateFields.</span><span class="sxs-lookup"><span data-stu-id="f0368-292">As we discussed in the *Adding Validation Controls to the Editing and Inserting Interfaces* and *Customizing the Data Modification Interface* tutorials, the user interface can be customized by replacing the BoundFields with TemplateFields.</span></span> <span data-ttu-id="f0368-293">J’ai modifié ce GridView et son interface de modification des manières suivantes :</span><span class="sxs-lookup"><span data-stu-id="f0368-293">I've modified this GridView and its editing interface in the following ways:</span></span>

- <span data-ttu-id="f0368-294">Suppression des `ProductID`, `SupplierName`et `CategoryName` BoundFields</span><span class="sxs-lookup"><span data-stu-id="f0368-294">Removed the `ProductID`, `SupplierName`, and `CategoryName` BoundFields</span></span>
- <span data-ttu-id="f0368-295">Converti le `ProductName` BoundField en TemplateField et ajouté un contrôle RequiredFieldValidation.</span><span class="sxs-lookup"><span data-stu-id="f0368-295">Converted the `ProductName` BoundField to a TemplateField and added a RequiredFieldValidation control.</span></span>
- <span data-ttu-id="f0368-296">Converti le `CategoryID` et `SupplierID` BoundFields en TemplateFields, et ajusté l’interface de modification pour utiliser DropDownList plutôt que des zones de texte.</span><span class="sxs-lookup"><span data-stu-id="f0368-296">Converted the `CategoryID` and `SupplierID` BoundFields to TemplateFields, and adjusted the editing interface to use DropDownLists rather than TextBoxes.</span></span> <span data-ttu-id="f0368-297">Dans ces TemplateFields' `ItemTemplates`, les champs de données `CategoryName` et `SupplierName` sont affichés.</span><span class="sxs-lookup"><span data-stu-id="f0368-297">In these TemplateFields' `ItemTemplates`, the `CategoryName` and `SupplierName` data fields are displayed.</span></span>
- <span data-ttu-id="f0368-298">Conversion du `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`et `ReorderLevel` BoundFields en TemplateFields et ajout de contrôles CompareValidator.</span><span class="sxs-lookup"><span data-stu-id="f0368-298">Converted the `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, and `ReorderLevel` BoundFields to TemplateFields and added CompareValidator controls.</span></span>

<span data-ttu-id="f0368-299">Étant donné que nous avons déjà examiné comment accomplir ces tâches dans les didacticiels précédents, je vais simplement répertorier la syntaxe déclarative finale ici et quitter l’implémentation en tant que pratique.</span><span class="sxs-lookup"><span data-stu-id="f0368-299">Since we've already examined how to accomplish these tasks in previous tutorials, I'll just list the final declarative syntax here and leave the implementation as practice.</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample9.aspx)]

<span data-ttu-id="f0368-300">Nous sommes très proches de l’utilisation d’un exemple complet.</span><span class="sxs-lookup"><span data-stu-id="f0368-300">We're very close to having a fully-working example.</span></span> <span data-ttu-id="f0368-301">Toutefois, il existe quelques subtilités qui vont se produire et provoquer des problèmes.</span><span class="sxs-lookup"><span data-stu-id="f0368-301">However, there are a few subtleties that will creep up and cause us problems.</span></span> <span data-ttu-id="f0368-302">En outre, nous avons encore besoin d’une interface qui avertit l’utilisateur lorsqu’une violation d’accès concurrentiel s’est produite.</span><span class="sxs-lookup"><span data-stu-id="f0368-302">Additionally, we still need some interface that alerts the user when a concurrency violation has occurred.</span></span>

> [!NOTE]
> <span data-ttu-id="f0368-303">Pour qu’un contrôle Web de données transmette correctement les valeurs d’origine à l’ObjectDataSource (qui est ensuite transmis à la couche BLL), il est vital que la propriété `EnableViewState` de GridView soit définie sur `true` (valeur par défaut).</span><span class="sxs-lookup"><span data-stu-id="f0368-303">In order for a data Web control to correctly pass the original values to the ObjectDataSource (which are then passed to the BLL), it's vital that the GridView's `EnableViewState` property is set to `true` (the default).</span></span> <span data-ttu-id="f0368-304">Si vous désactivez l’état d’affichage, les valeurs d’origine sont perdues lors de la publication.</span><span class="sxs-lookup"><span data-stu-id="f0368-304">If you disable view state, the original values are lost on postback.</span></span>

## <a name="passing-the-correct-original-values-to-the-objectdatasource"></a><span data-ttu-id="f0368-305">Passage des valeurs d’origine correctes à ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="f0368-305">Passing the Correct Original Values to the ObjectDataSource</span></span>

<span data-ttu-id="f0368-306">Il existe quelques problèmes liés à la façon dont le GridView a été configuré.</span><span class="sxs-lookup"><span data-stu-id="f0368-306">There are a couple of problems with the way the GridView has been configured.</span></span> <span data-ttu-id="f0368-307">Si la propriété de `ConflictDetection` ObjectDataSource est définie sur `CompareAllValues` (comme c’est le cas de la nôtre), lorsque les méthodes `Update()` ou `Delete()` de l’ObjectDataSource sont appelées par le GridView (ou DetailsView ou FormView), l’ObjectDataSource tente de copier les valeurs d’origine de GridView dans ses instances de `Parameter` appropriées.</span><span class="sxs-lookup"><span data-stu-id="f0368-307">If the ObjectDataSource's `ConflictDetection` property is set to `CompareAllValues` (as is ours), when the ObjectDataSource's `Update()` or `Delete()` methods are invoked by the GridView (or DetailsView or FormView), the ObjectDataSource attempts to copy the GridView's original values into its appropriate `Parameter` instances.</span></span> <span data-ttu-id="f0368-308">Reportez-vous à la figure 2 pour obtenir une représentation graphique de ce processus.</span><span class="sxs-lookup"><span data-stu-id="f0368-308">Refer back to Figure 2 for a graphical representation of this process.</span></span>

<span data-ttu-id="f0368-309">Plus précisément, les valeurs d’origine du contrôle GridView sont affectées aux valeurs dans les instructions de liaison de données bidirectionnelle chaque fois que les données sont liées au GridView.</span><span class="sxs-lookup"><span data-stu-id="f0368-309">Specifically, the GridView's original values are assigned the values in the two-way databinding statements each time the data is bound to the GridView.</span></span> <span data-ttu-id="f0368-310">Par conséquent, il est essentiel que les valeurs d’origine requises soient capturées par le biais de la liaison de liaison bidirectionnelle et qu’elles soient fournies dans un format convertible.</span><span class="sxs-lookup"><span data-stu-id="f0368-310">Therefore, it's essential that the required original values all are captured via two-way databinding and that they are provided in a convertible format.</span></span>

<span data-ttu-id="f0368-311">Pour comprendre pourquoi cela est important, prenez un moment pour visiter notre page dans un navigateur.</span><span class="sxs-lookup"><span data-stu-id="f0368-311">To see why this is important, take a moment to visit our page in a browser.</span></span> <span data-ttu-id="f0368-312">Comme prévu, le contrôle GridView répertorie chaque produit avec un bouton modifier et supprimer dans la colonne la plus à gauche.</span><span class="sxs-lookup"><span data-stu-id="f0368-312">As expected, the GridView lists each product with an Edit and Delete button in the leftmost column.</span></span>

<span data-ttu-id="f0368-313">[![les produits sont répertoriés dans un GridView](implementing-optimistic-concurrency-vb/_static/image39.png)](implementing-optimistic-concurrency-vb/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-313">[![The Products are Listed in a GridView](implementing-optimistic-concurrency-vb/_static/image39.png)](implementing-optimistic-concurrency-vb/_static/image38.png)</span></span>

<span data-ttu-id="f0368-314">**Figure 14**: les produits sont répertoriés dans un GridView ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image40.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-314">**Figure 14**: The Products are Listed in a GridView ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image40.png))</span></span>

<span data-ttu-id="f0368-315">Si vous cliquez sur le bouton Supprimer pour un produit, une `FormatException` est levée.</span><span class="sxs-lookup"><span data-stu-id="f0368-315">If you click the Delete button for any product, a `FormatException` is thrown.</span></span>

<span data-ttu-id="f0368-316">[![tentant de supprimer des résultats de produit dans un FormatException](implementing-optimistic-concurrency-vb/_static/image42.png)](implementing-optimistic-concurrency-vb/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-316">[![Attempting to Delete Any Product Results in a FormatException](implementing-optimistic-concurrency-vb/_static/image42.png)](implementing-optimistic-concurrency-vb/_static/image41.png)</span></span>

<span data-ttu-id="f0368-317">**Figure 15**: tentative de suppression des résultats d’un produit dans un `FormatException` ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image43.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-317">**Figure 15**: Attempting to Delete Any Product Results in a `FormatException` ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image43.png))</span></span>

<span data-ttu-id="f0368-318">La `FormatException` est déclenchée lorsque ObjectDataSource tente de lire la valeur de `UnitPrice` d’origine.</span><span class="sxs-lookup"><span data-stu-id="f0368-318">The `FormatException` is raised when the ObjectDataSource attempts to read in the original `UnitPrice` value.</span></span> <span data-ttu-id="f0368-319">Étant donné que la `ItemTemplate` a la `UnitPrice` mise en forme en tant que devise (`<%# Bind("UnitPrice", "{0:C}") %>`), elle inclut un symbole monétaire, comme $19,95.</span><span class="sxs-lookup"><span data-stu-id="f0368-319">Since the `ItemTemplate` has the `UnitPrice` formatted as a currency (`<%# Bind("UnitPrice", "{0:C}") %>`), it includes a currency symbol, like $19.95.</span></span> <span data-ttu-id="f0368-320">Le `FormatException` se produit lorsque ObjectDataSource tente de convertir cette chaîne en `decimal`.</span><span class="sxs-lookup"><span data-stu-id="f0368-320">The `FormatException` occurs as the ObjectDataSource attempts to convert this string into a `decimal`.</span></span> <span data-ttu-id="f0368-321">Pour contourner ce problème, nous disposons d’un certain nombre d’options :</span><span class="sxs-lookup"><span data-stu-id="f0368-321">To circumvent this problem, we have a number of options:</span></span>

- <span data-ttu-id="f0368-322">Supprimez la mise en forme monétaire de la `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="f0368-322">Remove the currency formatting from the `ItemTemplate`.</span></span> <span data-ttu-id="f0368-323">Autrement dit, au lieu d’utiliser `<%# Bind("UnitPrice", "{0:C}") %>`, utilisez simplement `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="f0368-323">That is, instead of using `<%# Bind("UnitPrice", "{0:C}") %>`, simply use `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="f0368-324">L’inconvénient est que le prix n’est plus formaté.</span><span class="sxs-lookup"><span data-stu-id="f0368-324">The downside of this is that the price is no longer formatted.</span></span>
- <span data-ttu-id="f0368-325">Affichez la `UnitPrice` mise en forme en tant que devise dans le `ItemTemplate`, mais utilisez le mot clé `Eval` pour effectuer cette opération.</span><span class="sxs-lookup"><span data-stu-id="f0368-325">Display the `UnitPrice` formatted as a currency in the `ItemTemplate`, but use the `Eval` keyword to accomplish this.</span></span> <span data-ttu-id="f0368-326">Rappelez-vous que `Eval` effectue une liaison de liaison unidirectionnelle.</span><span class="sxs-lookup"><span data-stu-id="f0368-326">Recall that `Eval` performs one-way databinding.</span></span> <span data-ttu-id="f0368-327">Nous devons toujours fournir la valeur `UnitPrice` pour les valeurs d’origine. nous avons donc toujours besoin d’une instruction de liaison de liaison bidirectionnelle dans le `ItemTemplate`, mais cela peut être placé dans un contrôle Web étiquette dont la propriété `Visible` est définie sur `false`.</span><span class="sxs-lookup"><span data-stu-id="f0368-327">We still need to provide the `UnitPrice` value for the original values, so we'll still need a two-way databinding statement in the `ItemTemplate`, but this can be placed in a Label Web control whose `Visible` property is set to `false`.</span></span> <span data-ttu-id="f0368-328">Nous pourrions utiliser le balisage suivant dans le ItemTemplate :</span><span class="sxs-lookup"><span data-stu-id="f0368-328">We could use the following markup in the ItemTemplate:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample10.aspx)]

- <span data-ttu-id="f0368-329">Supprimez la mise en forme monétaire de la `ItemTemplate`à l’aide de `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="f0368-329">Remove the currency formatting from the `ItemTemplate`, using `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="f0368-330">Dans le gestionnaire d’événements `RowDataBound` du GridView, accédez par programmation au contrôle Web Label dans lequel la valeur `UnitPrice` est affichée et définissez sa propriété `Text` sur la version mise en forme.</span><span class="sxs-lookup"><span data-stu-id="f0368-330">In the GridView's `RowDataBound` event handler, programmatically access the Label Web control within which the `UnitPrice` value is displayed and set its `Text` property to the formatted version.</span></span>
- <span data-ttu-id="f0368-331">Laissez le `UnitPrice` mis en forme en tant que devise.</span><span class="sxs-lookup"><span data-stu-id="f0368-331">Leave the `UnitPrice` formatted as a currency.</span></span> <span data-ttu-id="f0368-332">Dans le gestionnaire d’événements `RowDeleting` du GridView, remplacez la valeur de `UnitPrice` d’origine existante ($19,95) par une valeur décimale réelle à l’aide de `Decimal.Parse`.</span><span class="sxs-lookup"><span data-stu-id="f0368-332">In the GridView's `RowDeleting` event handler, replace the existing original `UnitPrice` value ($19.95) with an actual decimal value using `Decimal.Parse`.</span></span> <span data-ttu-id="f0368-333">Nous avons vu comment accomplir une opération similaire dans le gestionnaire d’événements `RowUpdating` dans la [*gestion des exceptions de niveau BLL et dal dans un didacticiel de Page ASP.net*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="f0368-333">We saw how to accomplish something similar in the `RowUpdating` event handler in the [*Handling BLL- and DAL-Level Exceptions in an ASP.NET Page*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial.</span></span>

<span data-ttu-id="f0368-334">Pour mon exemple, j’ai choisi de passer à la deuxième approche, en ajoutant un contrôle Web d’étiquette masqué dont la propriété `Text` est bidirectionnelle liée à la valeur de `UnitPrice` non mise en forme.</span><span class="sxs-lookup"><span data-stu-id="f0368-334">For my example I chose to go with the second approach, adding a hidden Label Web control whose `Text` property is two-way data bound to the unformatted `UnitPrice` value.</span></span>

<span data-ttu-id="f0368-335">Après avoir résolu ce problème, essayez de cliquer à nouveau sur le bouton Supprimer pour tous les produits.</span><span class="sxs-lookup"><span data-stu-id="f0368-335">After solving this problem, try clicking the Delete button for any product again.</span></span> <span data-ttu-id="f0368-336">Cette fois, vous obtiendrez un `InvalidOperationException` lorsque ObjectDataSource tente d’appeler la méthode de `UpdateProduct` de la couche BLL.</span><span class="sxs-lookup"><span data-stu-id="f0368-336">This time you'll get an `InvalidOperationException` when the ObjectDataSource attempts to invoke the BLL's `UpdateProduct` method.</span></span>

<span data-ttu-id="f0368-337">[![ObjectDataSource ne peut pas trouver de méthode avec les paramètres d’entrée qu’il souhaite envoyer](implementing-optimistic-concurrency-vb/_static/image45.png)](implementing-optimistic-concurrency-vb/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-337">[![The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send](implementing-optimistic-concurrency-vb/_static/image45.png)](implementing-optimistic-concurrency-vb/_static/image44.png)</span></span>

<span data-ttu-id="f0368-338">**Figure 16**: ObjectDataSource ne peut pas trouver de méthode avec les paramètres d’entrée qu’il souhaite envoyer ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image46.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-338">**Figure 16**: The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image46.png))</span></span>

<span data-ttu-id="f0368-339">En examinant le message de l’exception, il est clair que ObjectDataSource souhaite appeler une méthode BLL `DeleteProduct` qui comprend `original_CategoryName` et `original_SupplierName` paramètres d’entrée.</span><span class="sxs-lookup"><span data-stu-id="f0368-339">Looking at the exception's message, it's clear that the ObjectDataSource wants to invoke a BLL `DeleteProduct` method that includes `original_CategoryName` and `original_SupplierName` input parameters.</span></span> <span data-ttu-id="f0368-340">Cela est dû au fait que les `ItemTemplate` s pour les `CategoryID` et les `SupplierID` TemplateFields contiennent actuellement des instructions de liaison bidirectionnelle avec les champs de données `CategoryName` et `SupplierName`.</span><span class="sxs-lookup"><span data-stu-id="f0368-340">This is because the `ItemTemplate` s for the `CategoryID` and `SupplierID` TemplateFields currently contain two-way Bind statements with the `CategoryName` and `SupplierName` data fields.</span></span> <span data-ttu-id="f0368-341">Au lieu de cela, nous devons inclure des instructions `Bind` avec les champs de données `CategoryID` et `SupplierID`.</span><span class="sxs-lookup"><span data-stu-id="f0368-341">Instead, we need to include `Bind` statements with the `CategoryID` and `SupplierID` data fields.</span></span> <span data-ttu-id="f0368-342">Pour ce faire, remplacez les instructions de liaison existantes par `Eval` instructions, puis ajoutez des contrôles d’étiquette masquée dont les propriétés de `Text` sont liées aux champs de données `CategoryID` et `SupplierID` à l’aide de la liaison de données bidirectionnelle, comme indiqué ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="f0368-342">To accomplish this, replace the existing Bind statements with `Eval` statements, and then add hidden Label controls whose `Text` properties are bound to the `CategoryID` and `SupplierID` data fields using two-way databinding, as shown below:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample11.aspx)]

<span data-ttu-id="f0368-343">Avec ces modifications, nous sommes maintenant en mesure de supprimer et de modifier correctement les informations du produit.</span><span class="sxs-lookup"><span data-stu-id="f0368-343">With these changes, we are now able to successfully delete and edit product information!</span></span> <span data-ttu-id="f0368-344">À l’étape 5, nous verrons comment vérifier que des violations d’accès concurrentiel sont détectées.</span><span class="sxs-lookup"><span data-stu-id="f0368-344">In Step 5 we'll look at how to verify that concurrency violations are being detected.</span></span> <span data-ttu-id="f0368-345">Mais pour le moment, prenez quelques minutes pour essayer de mettre à jour et de supprimer quelques enregistrements pour vous assurer que la mise à jour et la suppression d’un seul utilisateur fonctionne comme prévu.</span><span class="sxs-lookup"><span data-stu-id="f0368-345">But for now, take a few minutes to try updating and deleting a few records to ensure that updating and deleting for a single user works as expected.</span></span>

## <a name="step-5-testing-the-optimistic-concurrency-support"></a><span data-ttu-id="f0368-346">Étape 5 : test de la prise en charge de l’accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="f0368-346">Step 5: Testing the Optimistic Concurrency Support</span></span>

<span data-ttu-id="f0368-347">Pour vérifier que les violations d’accès concurrentiel sont détectées (au lieu de provoquer le remplacement aveugle des données), nous devons ouvrir deux fenêtres de navigateur sur cette page.</span><span class="sxs-lookup"><span data-stu-id="f0368-347">In order to verify that concurrency violations are being detected (rather than resulting in data being blindly overwritten), we need to open two browser windows to this page.</span></span> <span data-ttu-id="f0368-348">Dans les deux instances du navigateur, cliquez sur le bouton modifier pour Chai.</span><span class="sxs-lookup"><span data-stu-id="f0368-348">In both browser instances, click on the Edit button for Chai.</span></span> <span data-ttu-id="f0368-349">Ensuite, dans un seul des navigateurs, remplacez le nom par « Chai thé », puis cliquez sur mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="f0368-349">Then, in just one of the browsers, change the name to "Chai Tea" and click Update.</span></span> <span data-ttu-id="f0368-350">La mise à jour doit s’effectuer correctement et retourner le GridView à son état antérieur à la modification, avec « Chai thé » comme nouveau nom de produit.</span><span class="sxs-lookup"><span data-stu-id="f0368-350">The update should succeed and return the GridView to its pre-editing state, with "Chai Tea" as the new product name.</span></span>

<span data-ttu-id="f0368-351">Toutefois, dans l’autre instance de la fenêtre du navigateur, la zone de texte Product Name affiche toujours « Chai ».</span><span class="sxs-lookup"><span data-stu-id="f0368-351">In the other browser window instance, however, the product name TextBox still shows "Chai".</span></span> <span data-ttu-id="f0368-352">Dans cette deuxième fenêtre de navigateur, mettez à jour le `UnitPrice` sur `25.00`.</span><span class="sxs-lookup"><span data-stu-id="f0368-352">In this second browser window, update the `UnitPrice` to `25.00`.</span></span> <span data-ttu-id="f0368-353">Sans prise en charge de l’accès concurrentiel optimiste, le fait de cliquer sur mettre à jour dans la deuxième instance du navigateur permet de rétablir le nom du produit sur « Chai », remplaçant ainsi les modifications apportées par la première instance du navigateur.</span><span class="sxs-lookup"><span data-stu-id="f0368-353">Without optimistic concurrency support, clicking update in the second browser instance would change the product name back to "Chai", thereby overwriting the changes made by the first browser instance.</span></span> <span data-ttu-id="f0368-354">Avec l’accès concurrentiel optimiste utilisé, toutefois, si vous cliquez sur le bouton mettre à jour dans la deuxième instance du navigateur, un [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx)est obtenu.</span><span class="sxs-lookup"><span data-stu-id="f0368-354">With optimistic concurrency employed, however, clicking the Update button in the second browser instance results in a [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span></span>

<span data-ttu-id="f0368-355">[![lorsqu’une violation d’accès concurrentiel est détectée, un DBConcurrencyException est levé](implementing-optimistic-concurrency-vb/_static/image48.png)](implementing-optimistic-concurrency-vb/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-355">[![When a Concurrency Violation is Detected, a DBConcurrencyException is Thrown](implementing-optimistic-concurrency-vb/_static/image48.png)](implementing-optimistic-concurrency-vb/_static/image47.png)</span></span>

<span data-ttu-id="f0368-356">**Figure 17**: quand une violation d’accès concurrentiel est détectée, une `DBConcurrencyException` est levée ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image49.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-356">**Figure 17**: When a Concurrency Violation is Detected, a `DBConcurrencyException` is Thrown ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image49.png))</span></span>

<span data-ttu-id="f0368-357">La `DBConcurrencyException` est levée uniquement lorsque le modèle de mise à jour par lot de la couche DAL est utilisé.</span><span class="sxs-lookup"><span data-stu-id="f0368-357">The `DBConcurrencyException` is only thrown when the DAL's batch update pattern is utilized.</span></span> <span data-ttu-id="f0368-358">Le modèle DB direct ne lève pas d’exception, il indique simplement qu’aucune ligne n’a été affectée.</span><span class="sxs-lookup"><span data-stu-id="f0368-358">The DB direct pattern does not raise an exception, it merely indicates that no rows were affected.</span></span> <span data-ttu-id="f0368-359">Pour illustrer cela, renvoyez le contrôle GridView des instances de navigateur à leur état antérieur à la modification.</span><span class="sxs-lookup"><span data-stu-id="f0368-359">To illustrate this, return both browser instances' GridView to their pre-editing state.</span></span> <span data-ttu-id="f0368-360">Ensuite, dans la première instance du navigateur, cliquez sur le bouton modifier et remplacez le nom du produit « Chai thé » par « Chai », puis cliquez sur mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="f0368-360">Next, in the first browser instance, click the Edit button and change the product name from "Chai Tea" back to "Chai" and click Update.</span></span> <span data-ttu-id="f0368-361">Dans la deuxième fenêtre du navigateur, cliquez sur le bouton Supprimer pour Chai.</span><span class="sxs-lookup"><span data-stu-id="f0368-361">In the second browser window, click the Delete button for Chai.</span></span>

<span data-ttu-id="f0368-362">Lorsque vous cliquez sur supprimer, la page est republiée, le GridView appelle la méthode d' `Delete()` ObjectDataSource et l’ObjectDataSource appelle la méthode de `DeleteProduct` de la classe `ProductsOptimisticConcurrencyBLL`, en passant les valeurs d’origine.</span><span class="sxs-lookup"><span data-stu-id="f0368-362">Upon clicking Delete, the page posts back, the GridView invokes the ObjectDataSource's `Delete()` method, and the ObjectDataSource calls down into the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method, passing along the original values.</span></span> <span data-ttu-id="f0368-363">La valeur de `ProductName` d’origine pour la deuxième instance de navigateur est « Chai Tea », qui ne correspond pas à la valeur de `ProductName` actuelle dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="f0368-363">The original `ProductName` value for the second browser instance is "Chai Tea", which doesn't match up with the current `ProductName` value in the database.</span></span> <span data-ttu-id="f0368-364">Par conséquent, l’instruction `DELETE` envoyée à la base de données n’affecte aucune ligne, car il n’y a pas d’enregistrement dans la base de données satisfait par la clause `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="f0368-364">Therefore the `DELETE` statement issued to the database affects zero rows since there's no record in the database that the `WHERE` clause satisfies.</span></span> <span data-ttu-id="f0368-365">La méthode `DeleteProduct` retourne `false` et les données de l’ObjectDataSource sont reliées au GridView.</span><span class="sxs-lookup"><span data-stu-id="f0368-365">The `DeleteProduct` method returns `false` and the ObjectDataSource's data is rebound to the GridView.</span></span>

<span data-ttu-id="f0368-366">Du point de vue de l’utilisateur final, le fait de cliquer sur le bouton Supprimer pour le thé chai dans la deuxième fenêtre du navigateur a entraîné le clignotement de l’écran et, à la sortie, le produit est toujours là, bien qu’il soit maintenant listé comme « Chai » (le nom du produit est modifié par le premier navigateur instance).</span><span class="sxs-lookup"><span data-stu-id="f0368-366">From the end user's perspective, clicking on the Delete button for Chai Tea in the second browser window caused the screen to flash and, upon coming back, the product is still there, although now it's listed as "Chai" (the product name change made by the first browser instance).</span></span> <span data-ttu-id="f0368-367">Si l’utilisateur clique à nouveau sur le bouton supprimer, la suppression est effectuée, car la valeur de `ProductName` d’origine du GridView (« Chai ») correspond maintenant à la valeur de la base de données.</span><span class="sxs-lookup"><span data-stu-id="f0368-367">If the user clicks the Delete button again, the Delete will succeed, as the GridView's original `ProductName` value ("Chai") now matches up with the value in the database.</span></span>

<span data-ttu-id="f0368-368">Dans ces deux cas, l’expérience utilisateur est loin d’être idéale.</span><span class="sxs-lookup"><span data-stu-id="f0368-368">In both of these cases, the user experience is far from ideal.</span></span> <span data-ttu-id="f0368-369">Nous ne voulons pas montrer clairement à l’utilisateur les détails de la `DBConcurrencyException` exception lors de l’utilisation du modèle de mise à jour par lot.</span><span class="sxs-lookup"><span data-stu-id="f0368-369">We clearly don't want to show the user the nitty-gritty details of the `DBConcurrencyException` exception when using the batch update pattern.</span></span> <span data-ttu-id="f0368-370">Le comportement lors de l’utilisation du modèle de base de base de type direct est quelque peu confus lorsque la commande des utilisateurs a échoué, mais il n’existait aucune indication précise de pourquoi.</span><span class="sxs-lookup"><span data-stu-id="f0368-370">And the behavior when using the DB direct pattern is somewhat confusing as the users command failed, but there was no precise indication of why.</span></span>

<span data-ttu-id="f0368-371">Pour résoudre ces deux problèmes, nous pouvons créer des contrôles Label Web sur la page qui fournissent une explication de la raison de l’échec d’une mise à jour ou d’une suppression.</span><span class="sxs-lookup"><span data-stu-id="f0368-371">To remedy these two issues, we can create Label Web controls on the page that provide an explanation to why an update or delete failed.</span></span> <span data-ttu-id="f0368-372">Pour le modèle de mise à jour par lot, nous pouvons déterminer si une `DBConcurrencyException` exception s’est produite dans le gestionnaire d’événements de la publication du contrôle GridView, en affichant l’étiquette d’avertissement si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="f0368-372">For the batch update pattern, we can determine whether or not a `DBConcurrencyException` exception occurred in the GridView's post-level event handler, displaying the warning label as needed.</span></span> <span data-ttu-id="f0368-373">Pour la méthode DB direct, nous pouvons examiner la valeur de retour de la méthode BLL (qui est `true` si une ligne a été affectée, `false` dans le cas contraire) et afficher un message d’information en fonction des besoins.</span><span class="sxs-lookup"><span data-stu-id="f0368-373">For the DB direct method, we can examine the return value of the BLL method (which is `true` if one row was affected, `false` otherwise) and display an informational message as needed.</span></span>

## <a name="step-6-adding-informational-messages-and-displaying-them-in-the-face-of-a-concurrency-violation"></a><span data-ttu-id="f0368-374">Étape 6 : ajouter des messages d’information et les afficher en cas de violation de l’accès concurrentiel</span><span class="sxs-lookup"><span data-stu-id="f0368-374">Step 6: Adding Informational Messages and Displaying Them in the Face of a Concurrency Violation</span></span>

<span data-ttu-id="f0368-375">En cas de violation de l’accès concurrentiel, le comportement présenté varie selon que la mise à jour par lot ou le modèle de base de données de la couche DAL a été utilisé.</span><span class="sxs-lookup"><span data-stu-id="f0368-375">When a concurrency violation occurs, the behavior exhibited depends on whether the DAL's batch update or DB direct pattern was used.</span></span> <span data-ttu-id="f0368-376">Notre didacticiel utilise les deux modèles, le modèle de mise à jour par lot étant utilisé pour la mise à jour et le modèle de base de type direct utilisé pour la suppression.</span><span class="sxs-lookup"><span data-stu-id="f0368-376">Our tutorial uses both patterns, with the batch update pattern being used for updating and the DB direct pattern used for deleting.</span></span> <span data-ttu-id="f0368-377">Pour commencer, nous allons ajouter deux contrôles Label Web à notre page qui expliquent qu’une violation d’accès concurrentiel s’est produite lors de la tentative de suppression ou de mise à jour des données.</span><span class="sxs-lookup"><span data-stu-id="f0368-377">To get started, let's add two Label Web controls to our page that explain that a concurrency violation occurred when attempting to delete or update data.</span></span> <span data-ttu-id="f0368-378">Définissez les propriétés `Visible` et `EnableViewState` du contrôle Label sur `false`; Cela entraîne le masquage de ces pages à chaque visite de page, à l’exception des visites de page dans lesquelles leur `Visible` propriété est définie par programmation sur `true`.</span><span class="sxs-lookup"><span data-stu-id="f0368-378">Set the Label control's `Visible` and `EnableViewState` properties to `false`; this will cause them to be hidden on each page visit except for those particular page visits where their `Visible` property is programmatically set to `true`.</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample12.aspx)]

<span data-ttu-id="f0368-379">En plus de définir leurs propriétés `Visible`, `EnabledViewState`et `Text`, j’ai également défini la propriété `CssClass` sur `Warning`, ce qui entraîne l’affichage de l’étiquette dans une police large, rouge, italique et gras.</span><span class="sxs-lookup"><span data-stu-id="f0368-379">In addition to setting their `Visible`, `EnabledViewState`, and `Text` properties, I've also set the `CssClass` property to `Warning`, which causes the Label's to be displayed in a large, red, italic, bold font.</span></span> <span data-ttu-id="f0368-380">Cette classe de `Warning` CSS a été définie et ajoutée à styles. CSS dans le didacticiel *examen des événements associés à l’insertion, à la mise à jour et à la suppression* .</span><span class="sxs-lookup"><span data-stu-id="f0368-380">This CSS `Warning` class was defined and added to Styles.css back in the *Examining the Events Associated with Inserting, Updating, and Deleting* tutorial.</span></span>

<span data-ttu-id="f0368-381">Après avoir ajouté ces étiquettes, le concepteur dans Visual Studio doit ressembler à la figure 18.</span><span class="sxs-lookup"><span data-stu-id="f0368-381">After adding these Labels, the Designer in Visual Studio should look similar to Figure 18.</span></span>

<span data-ttu-id="f0368-382">[![deux contrôles Label ont été ajoutés à la page](implementing-optimistic-concurrency-vb/_static/image51.png)](implementing-optimistic-concurrency-vb/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-382">[![Two Label Controls Have Been Added to the Page](implementing-optimistic-concurrency-vb/_static/image51.png)](implementing-optimistic-concurrency-vb/_static/image50.png)</span></span>

<span data-ttu-id="f0368-383">**Figure 18**: deux contrôles Label ont été ajoutés à la page ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image52.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-383">**Figure 18**: Two Label Controls Have Been Added to the Page ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image52.png))</span></span>

<span data-ttu-id="f0368-384">Avec ces contrôles Web d’étiquette en place, nous sommes prêts à examiner comment déterminer quand une violation d’accès concurrentiel s’est produite. à ce stade, la propriété `Visible` de l’étiquette appropriée peut être définie sur `true`, ce qui affiche le message d’information.</span><span class="sxs-lookup"><span data-stu-id="f0368-384">With these Label Web controls in place, we're ready to examine how to determine when a concurrency violation has occurred, at which point the appropriate Label's `Visible` property can be set to `true`, displaying the informational message.</span></span>

## <a name="handling-concurrency-violations-when-updating"></a><span data-ttu-id="f0368-385">Gestion des violations d’accès concurrentiel lors de la mise à jour</span><span class="sxs-lookup"><span data-stu-id="f0368-385">Handling Concurrency Violations When Updating</span></span>

<span data-ttu-id="f0368-386">Voyons tout d’abord comment gérer les violations d’accès concurrentiel lors de l’utilisation du modèle de mise à jour par lot.</span><span class="sxs-lookup"><span data-stu-id="f0368-386">Let's first look at how to handle concurrency violations when using the batch update pattern.</span></span> <span data-ttu-id="f0368-387">Étant donné que ces violations avec le modèle de mise à jour par lot entraînent la levée d’une exception `DBConcurrencyException`, nous devons ajouter du code à notre page ASP.NET pour déterminer si une exception `DBConcurrencyException` s’est produite pendant le processus de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="f0368-387">Since such violations with the batch update pattern cause a `DBConcurrencyException` exception to be thrown, we need to add code to our ASP.NET page to determine whether a `DBConcurrencyException` exception occurred during the update process.</span></span> <span data-ttu-id="f0368-388">Dans ce cas, nous devons afficher un message à l’utilisateur expliquant que les modifications n’ont pas été enregistrées, car un autre utilisateur a modifié les mêmes données entre le moment où il a commencé à modifier l’enregistrement et le moment où il a cliqué sur le bouton mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="f0368-388">If so, we should display a message to the user explaining that their changes were not saved because another user had modified the same data between when they started editing the record and when they clicked the Update button.</span></span>

<span data-ttu-id="f0368-389">Comme nous l’avons vu dans la *gestion des exceptions de niveau BLL et dal dans un didacticiel de Page ASP.net* , de telles exceptions peuvent être détectées et supprimées dans les gestionnaires d’événements de l’événement de publication du contrôle Web des données.</span><span class="sxs-lookup"><span data-stu-id="f0368-389">As we saw in the *Handling BLL- and DAL-Level Exceptions in an ASP.NET Page* tutorial, such exceptions can be detected and suppressed in the data Web control's post-level event handlers.</span></span> <span data-ttu-id="f0368-390">Par conséquent, nous devons créer un gestionnaire d’événements pour l’événement `RowUpdated` de GridView qui vérifie si une exception `DBConcurrencyException` a été levée.</span><span class="sxs-lookup"><span data-stu-id="f0368-390">Therefore, we need to create an event handler for the GridView's `RowUpdated` event that checks if a `DBConcurrencyException` exception has been thrown.</span></span> <span data-ttu-id="f0368-391">Ce gestionnaire d’événements reçoit une référence à toute exception levée pendant le processus de mise à jour, comme indiqué dans le code du gestionnaire d’événements ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="f0368-391">This event handler is passed a reference to any exception that was raised during the updating process, as shown in the event handler code below:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample13.vb)]

<span data-ttu-id="f0368-392">Face à une exception `DBConcurrencyException`, ce gestionnaire d’événements affiche le contrôle d’étiquette `UpdateConflictMessage` et indique que l’exception a été gérée.</span><span class="sxs-lookup"><span data-stu-id="f0368-392">In the face of a `DBConcurrencyException` exception, this event handler displays the `UpdateConflictMessage` Label control and indicates that the exception has been handled.</span></span> <span data-ttu-id="f0368-393">Avec ce code en place, lorsqu’une violation d’accès concurrentiel se produit lors de la mise à jour d’un enregistrement, les modifications de l’utilisateur sont perdues, car elles auraient remplacé les modifications d’un autre utilisateur en même temps.</span><span class="sxs-lookup"><span data-stu-id="f0368-393">With this code in place, when a concurrency violation occurs when updating a record, the user's changes are lost, since they would have overwritten another user's modifications at the same time.</span></span> <span data-ttu-id="f0368-394">En particulier, le GridView est retourné à son état antérieur à la modification et lié aux données de la base de données actuelle.</span><span class="sxs-lookup"><span data-stu-id="f0368-394">In particular, the GridView is returned to its pre-editing state and bound to the current database data.</span></span> <span data-ttu-id="f0368-395">Cette opération met à jour la ligne GridView avec les modifications de l’autre utilisateur, qui n’étaient pas visibles auparavant.</span><span class="sxs-lookup"><span data-stu-id="f0368-395">This will update the GridView row with the other user's changes, which were previously not visible.</span></span> <span data-ttu-id="f0368-396">En outre, le contrôle d’étiquette `UpdateConflictMessage` explique à l’utilisateur ce qui s’est produit.</span><span class="sxs-lookup"><span data-stu-id="f0368-396">Additionally, the `UpdateConflictMessage` Label control will explain to the user what just happened.</span></span> <span data-ttu-id="f0368-397">Cette séquence d’événements est détaillée dans la figure 19.</span><span class="sxs-lookup"><span data-stu-id="f0368-397">This sequence of events is detailed in Figure 19.</span></span>

<span data-ttu-id="f0368-398">[![les mises à jour des utilisateurs sont perdues en cas de violation de l’accès concurrentiel](implementing-optimistic-concurrency-vb/_static/image54.png)](implementing-optimistic-concurrency-vb/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-398">[![A User s Updates are Lost in the Face of a Concurrency Violation](implementing-optimistic-concurrency-vb/_static/image54.png)](implementing-optimistic-concurrency-vb/_static/image53.png)</span></span>

<span data-ttu-id="f0368-399">**Figure 19**: les mises à jour des utilisateurs sont perdues en cas de violation d’accès concurrentiel ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image55.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-399">**Figure 19**: A User s Updates are Lost in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image55.png))</span></span>

> [!NOTE]
> <span data-ttu-id="f0368-400">Au lieu de renvoyer le contrôle GridView à l’état antérieur à la modification, nous pourrions conserver le GridView dans son état de modification en affectant à la propriété `KeepInEditMode` de l’objet `GridViewUpdatedEventArgs` passé la valeur true.</span><span class="sxs-lookup"><span data-stu-id="f0368-400">Alternatively, rather than returning the GridView to the pre-editing state, we could leave the GridView in its editing state by setting the `KeepInEditMode` property of the passed-in `GridViewUpdatedEventArgs` object to true.</span></span> <span data-ttu-id="f0368-401">Toutefois, si vous adoptez cette approche, veillez à relier les données au contrôle GridView (en appelant sa méthode `DataBind()`) afin que les valeurs de l’autre utilisateur soient chargées dans l’interface de modification.</span><span class="sxs-lookup"><span data-stu-id="f0368-401">If you take this approach, however, be certain to rebind the data to the GridView (by invoking its `DataBind()` method) so that the other user's values are loaded into the editing interface.</span></span> <span data-ttu-id="f0368-402">Le code disponible en téléchargement dans ce didacticiel contient ces deux lignes de code dans le `RowUpdated` gestionnaire d’événements commenté ; supprimez simplement les marques de commentaire de ces lignes de code pour que le contrôle GridView reste en mode édition après une violation d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="f0368-402">The code available for download with this tutorial has these two lines of code in the `RowUpdated` event handler commented out; simply uncomment these lines of code to have the GridView remain in edit mode after a concurrency violation.</span></span>

## <a name="responding-to-concurrency-violations-when-deleting"></a><span data-ttu-id="f0368-403">Réponse aux violations d’accès concurrentiel lors de la suppression</span><span class="sxs-lookup"><span data-stu-id="f0368-403">Responding to Concurrency Violations When Deleting</span></span>

<span data-ttu-id="f0368-404">Avec le modèle de base de données direct, aucune exception n’est levée en cas de violation d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="f0368-404">With the DB direct pattern, there is no exception raised in the face of a concurrency violation.</span></span> <span data-ttu-id="f0368-405">Au lieu de cela, l’instruction de base de données n’affecte simplement aucun enregistrement, car la clause WHERE ne correspond à aucun enregistrement.</span><span class="sxs-lookup"><span data-stu-id="f0368-405">Instead, the database statement simply affects no records, as the WHERE clause does not match with any record.</span></span> <span data-ttu-id="f0368-406">Toutes les méthodes de modification des données créées dans la couche BLL ont été conçues de telle sorte qu’elles retournent une valeur booléenne indiquant si elles ont été affectées avec précision un enregistrement.</span><span class="sxs-lookup"><span data-stu-id="f0368-406">All of the data modification methods created in the BLL have been designed such that they return a Boolean value indicating whether or not they affected precisely one record.</span></span> <span data-ttu-id="f0368-407">Par conséquent, pour déterminer si une violation d’accès concurrentiel s’est produite lors de la suppression d’un enregistrement, nous pouvons examiner la valeur de retour de la méthode `DeleteProduct` de la couche BLL.</span><span class="sxs-lookup"><span data-stu-id="f0368-407">Therefore, to determine if a concurrency violation occurred when deleting a record, we can examine the return value of the BLL's `DeleteProduct` method.</span></span>

<span data-ttu-id="f0368-408">La valeur de retour d’une méthode BLL peut être examinée dans les gestionnaires d’événements de démarrage de l’ObjectDataSource via la propriété `ReturnValue` de l’objet `ObjectDataSourceStatusEventArgs` passé dans le gestionnaire d’événements.</span><span class="sxs-lookup"><span data-stu-id="f0368-408">The return value for a BLL method can be examined in the ObjectDataSource's post-level event handlers through the `ReturnValue` property of the `ObjectDataSourceStatusEventArgs` object passed into the event handler.</span></span> <span data-ttu-id="f0368-409">Étant donné que nous nous intéressons à déterminer la valeur de retour de la méthode `DeleteProduct`, nous devons créer un gestionnaire d’événements pour l’événement de `Deleted` de l’ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="f0368-409">Since we are interested in determining the return value from the `DeleteProduct` method, we need to create an event handler for the ObjectDataSource's `Deleted` event.</span></span> <span data-ttu-id="f0368-410">La propriété `ReturnValue` est de type `object` et peut être `null` si une exception a été levée et si la méthode a été interrompue avant de pouvoir retourner une valeur.</span><span class="sxs-lookup"><span data-stu-id="f0368-410">The `ReturnValue` property is of type `object` and can be `null` if an exception was raised and the method was interrupted before it could return a value.</span></span> <span data-ttu-id="f0368-411">Par conséquent, nous devons tout d’abord vous assurer que la propriété `ReturnValue` n’est pas `null` et qu’il s’agit d’une valeur booléenne.</span><span class="sxs-lookup"><span data-stu-id="f0368-411">Therefore, we should first ensure that the `ReturnValue` property is not `null` and is a Boolean value.</span></span> <span data-ttu-id="f0368-412">En supposant que cette vérification réussit, nous affichons le contrôle d’étiquette `DeleteConflictMessage` si le `ReturnValue` est `false`.</span><span class="sxs-lookup"><span data-stu-id="f0368-412">Assuming this check passes, we show the `DeleteConflictMessage` Label control if the `ReturnValue` is `false`.</span></span> <span data-ttu-id="f0368-413">Pour ce faire, vous pouvez utiliser le code suivant :</span><span class="sxs-lookup"><span data-stu-id="f0368-413">This can be accomplished by using the following code:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample14.vb)]

<span data-ttu-id="f0368-414">Face à une violation d’accès concurrentiel, la demande de suppression de l’utilisateur est annulée.</span><span class="sxs-lookup"><span data-stu-id="f0368-414">In the face of a concurrency violation, the user's delete request is canceled.</span></span> <span data-ttu-id="f0368-415">Le GridView est actualisé et présente les modifications qui se sont produites pour cet enregistrement entre le moment où l’utilisateur a chargé la page et le moment où il a cliqué sur le bouton supprimer.</span><span class="sxs-lookup"><span data-stu-id="f0368-415">The GridView is refreshed, showing the changes that occurred for that record between the time the user loaded the page and when he clicked the Delete button.</span></span> <span data-ttu-id="f0368-416">Quand une violation de ce type est dépassée, le `DeleteConflictMessage` étiquette est indiqué, expliquant ce qui vient de se passer (voir figure 20).</span><span class="sxs-lookup"><span data-stu-id="f0368-416">When such a violation transpires, the `DeleteConflictMessage` Label is shown, explaining what just happened (see Figure 20).</span></span>

<span data-ttu-id="f0368-417">[![la suppression d’un utilisateur est annulée en cas de violation d’accès concurrentiel](implementing-optimistic-concurrency-vb/_static/image57.png)](implementing-optimistic-concurrency-vb/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="f0368-417">[![A User s Delete is Canceled in the Face of a Concurrency Violation](implementing-optimistic-concurrency-vb/_static/image57.png)](implementing-optimistic-concurrency-vb/_static/image56.png)</span></span>

<span data-ttu-id="f0368-418">**Figure 20**: une suppression de l’utilisateur est annulée en cas de violation d’accès concurrentiel ([cliquez pour afficher l’image en taille réelle](implementing-optimistic-concurrency-vb/_static/image58.png))</span><span class="sxs-lookup"><span data-stu-id="f0368-418">**Figure 20**: A User s Delete is Canceled in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image58.png))</span></span>

## <a name="summary"></a><span data-ttu-id="f0368-419">Récapitulatif</span><span class="sxs-lookup"><span data-stu-id="f0368-419">Summary</span></span>

<span data-ttu-id="f0368-420">Les opportunités de violation de l’accès concurrentiel existent dans toutes les applications qui permettent à plusieurs utilisateurs simultanés de mettre à jour ou de supprimer des données.</span><span class="sxs-lookup"><span data-stu-id="f0368-420">Opportunities for concurrency violations exist in every application that allows multiple, concurrent users to update or delete data.</span></span> <span data-ttu-id="f0368-421">Si de telles violations ne sont pas comptabilisées, lorsque deux utilisateurs mettent à jour simultanément les mêmes données qui se trouvent dans la dernière écriture « WINS », le remplacement des modifications apportées par l’autre utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f0368-421">If such violations are not accounted for, when two users simultaneously update the same data whoever gets in the last write "wins," overwriting the other user's changes changes.</span></span> <span data-ttu-id="f0368-422">Les développeurs peuvent également implémenter un contrôle d’accès concurrentiel optimiste ou pessimiste.</span><span class="sxs-lookup"><span data-stu-id="f0368-422">Alternatively, developers can implement either optimistic or pessimistic concurrency control.</span></span> <span data-ttu-id="f0368-423">Le contrôle de l’accès concurrentiel optimiste suppose que les violations d’accès concurrentiel ne sont pas fréquentes et n’autorisent simplement pas une commande Update ou DELETE qui constituerait une violation d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="f0368-423">Optimistic concurrency control assumes that concurrency violations are infrequent and simply disallows an update or delete command that would constitute a concurrency violation.</span></span> <span data-ttu-id="f0368-424">Le contrôle d’accès concurrentiel pessimiste suppose que les violations d’accès concurrentiel sont fréquentes et qu’il suffit de rejeter la commande de mise à jour ou de suppression d’un utilisateur n’est pas acceptable.</span><span class="sxs-lookup"><span data-stu-id="f0368-424">Pessimistic concurrency control assumes that concurrency violations are frequent and simply rejecting one user's update or delete command is not acceptable.</span></span> <span data-ttu-id="f0368-425">Avec le contrôle d’accès concurrentiel pessimiste, la mise à jour d’un enregistrement implique son verrouillage, ce qui empêche les autres utilisateurs de modifier ou de supprimer l’enregistrement pendant qu’il est verrouillé.</span><span class="sxs-lookup"><span data-stu-id="f0368-425">With pessimistic concurrency control, updating a record involves locking it, thereby preventing any other users from modifying or deleting the record while it is locked.</span></span>

<span data-ttu-id="f0368-426">Le DataSet typé dans .NET fournit des fonctionnalités pour prendre en charge le contrôle d’accès concurrentiel optimiste.</span><span class="sxs-lookup"><span data-stu-id="f0368-426">The Typed DataSet in .NET provides functionality for supporting optimistic concurrency control.</span></span> <span data-ttu-id="f0368-427">En particulier, les instructions `UPDATE` et `DELETE` émises dans la base de données incluent toutes les colonnes de la table, garantissant ainsi que la mise à jour ou la suppression se produira uniquement si les données actuelles de l’enregistrement correspondent aux données d’origine de l’utilisateur lors de l’exécution de la mise à jour ou de la suppression.</span><span class="sxs-lookup"><span data-stu-id="f0368-427">In particular, the `UPDATE` and `DELETE` statements issued to the database include all of the table's columns, thereby ensuring that the update or delete will only occur if the record's current data matches with the original data the user had when performing their update or delete.</span></span> <span data-ttu-id="f0368-428">Une fois la couche DAL configurée pour prendre en charge l’accès concurrentiel optimiste, les méthodes BLL doivent être mises à jour.</span><span class="sxs-lookup"><span data-stu-id="f0368-428">Once the DAL has been configured to support optimistic concurrency, the BLL methods need to be updated.</span></span> <span data-ttu-id="f0368-429">En outre, la page ASP.NET qui appelle la couche BLL doit être configurée de sorte que l’ObjectDataSource récupère les valeurs d’origine à partir de son contrôle Web de données et les transmet dans la couche BLL.</span><span class="sxs-lookup"><span data-stu-id="f0368-429">Additionally, the ASP.NET page that calls down into the BLL must be configured such that the ObjectDataSource retrieves the original values from its data Web control and passes them down into the BLL.</span></span>

<span data-ttu-id="f0368-430">Comme nous l’avons vu dans ce didacticiel, l’implémentation du contrôle d’accès concurrentiel optimiste dans une application Web ASP.NET implique la mise à jour de la couche DAL et de la couche BLL et l’ajout de la prise en charge dans la page ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f0368-430">As we saw in this tutorial, implementing optimistic concurrency control in an ASP.NET web application involves updating the DAL and BLL and adding support in the ASP.NET page.</span></span> <span data-ttu-id="f0368-431">Le fait que ce travail ajouté soit un investissement judicieux de votre temps et de vos efforts dépend de votre application.</span><span class="sxs-lookup"><span data-stu-id="f0368-431">Whether or not this added work is a wise investment of your time and effort depends on your application.</span></span> <span data-ttu-id="f0368-432">Si vous avez rarement des utilisateurs simultanés qui mettent à jour des données ou si les données qu’ils mettent à jour diffèrent les unes des autres, le contrôle d’accès concurrentiel n’est pas un problème clé.</span><span class="sxs-lookup"><span data-stu-id="f0368-432">If you infrequently have concurrent users updating data, or the data they are updating is different from one another, then concurrency control is not a key issue.</span></span> <span data-ttu-id="f0368-433">Toutefois, si vous avez régulièrement plusieurs utilisateurs sur votre site qui utilisent les mêmes données, le contrôle d’accès concurrentiel peut contribuer à empêcher les mises à jour ou les suppressions d’un utilisateur de remplacer involontairement un autre.</span><span class="sxs-lookup"><span data-stu-id="f0368-433">If, however, you routinely have multiple users on your site working with the same data, concurrency control can help prevent one user's updates or deletes from unwittingly overwriting another's.</span></span>

<span data-ttu-id="f0368-434">Bonne programmation !</span><span class="sxs-lookup"><span data-stu-id="f0368-434">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="f0368-435">À propos de l’auteur</span><span class="sxs-lookup"><span data-stu-id="f0368-435">About the Author</span></span>

<span data-ttu-id="f0368-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), auteur de sept livres ASP/ASP. net et fondateur de [4GuysFromRolla.com](http://www.4guysfromrolla.com), travaille avec des technologies Web Microsoft depuis 1998.</span><span class="sxs-lookup"><span data-stu-id="f0368-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="f0368-437">Scott travaille en tant que consultant, formateur et auteur indépendant.</span><span class="sxs-lookup"><span data-stu-id="f0368-437">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="f0368-438">Son dernier livre est [*Sams vous apprend vous-même ASP.NET 2,0 en 24 heures*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="f0368-438">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="f0368-439">Il peut être contacté à [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="f0368-439">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="f0368-440">ou via son blog, qui se trouve sur [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="f0368-440">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="f0368-441">[Précédent](customizing-the-data-modification-interface-vb.md)
> [Suivant](adding-client-side-confirmation-when-deleting-vb.md)</span><span class="sxs-lookup"><span data-stu-id="f0368-441">[Previous](customizing-the-data-modification-interface-vb.md)
[Next](adding-client-side-confirmation-when-deleting-vb.md)</span></span>
