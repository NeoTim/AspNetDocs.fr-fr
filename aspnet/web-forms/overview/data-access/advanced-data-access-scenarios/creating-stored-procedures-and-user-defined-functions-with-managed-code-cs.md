---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/creating-stored-procedures-and-user-defined-functions-with-managed-code-cs
title: Création de procédures stockées et de fonctions définies par l’utilisateur avec du code managé (C#) | Microsoft Docs
author: rick-anderson
description: Microsoft SQL Server 2005 s’intègre au Common Language Runtime .NET pour permettre aux développeurs de créer des objets de base de données par le biais de code managé. Ce didacticiel...
ms.author: riande
ms.date: 08/03/2007
ms.assetid: 213eea41-1ab4-4371-8b24-1a1a66c515de
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/creating-stored-procedures-and-user-defined-functions-with-managed-code-cs
msc.type: authoredcontent
ms.openlocfilehash: c1882d019d9dfde2dc4f960cae65aa8268c97a51
ms.sourcegitcommit: 4e6d586faadbe4d9ef27122f86335ec9385134af
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/28/2020
ms.locfileid: "89045297"
---
# <a name="creating-stored-procedures-and-user-defined-functions-with-managed-code-c"></a><span data-ttu-id="2c259-104">Création de procédures stockées et de fonctions définies par l’utilisateur avec du code managé (C#)</span><span class="sxs-lookup"><span data-stu-id="2c259-104">Creating Stored Procedures and User-Defined Functions with Managed Code (C#)</span></span>

<span data-ttu-id="2c259-105">par [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="2c259-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="2c259-106">[Télécharger le code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_75_CS.zip) ou [Télécharger le PDF](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/datatutorial75cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="2c259-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_75_CS.zip) or [Download PDF](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/datatutorial75cs1.pdf)</span></span>

> <span data-ttu-id="2c259-107">Microsoft SQL Server 2005 s’intègre au Common Language Runtime .NET pour permettre aux développeurs de créer des objets de base de données par le biais de code managé.</span><span class="sxs-lookup"><span data-stu-id="2c259-107">Microsoft SQL Server 2005 integrates with the .NET Common Language Runtime to allow developers to create database objects through managed code.</span></span> <span data-ttu-id="2c259-108">Ce didacticiel montre comment créer des procédures stockées gérées et des fonctions définies par l’utilisateur gérées avec votre Visual Basic ou votre code C#.</span><span class="sxs-lookup"><span data-stu-id="2c259-108">This tutorial shows how to create managed stored procedures and managed user-defined functions with your Visual Basic or C# code.</span></span> <span data-ttu-id="2c259-109">Nous voyons également comment ces éditions de Visual Studio vous permettent de déboguer des objets de base de données managés.</span><span class="sxs-lookup"><span data-stu-id="2c259-109">We also see how these editions of Visual Studio allow you to debug such managed database objects.</span></span>

## <a name="introduction"></a><span data-ttu-id="2c259-110">Introduction</span><span class="sxs-lookup"><span data-stu-id="2c259-110">Introduction</span></span>

<span data-ttu-id="2c259-111">Les bases de données telles que Microsoft s SQL Server 2005 utilisent l' [instruction Transact-langage SQL (T-SQL)](http://en.wikipedia.org/wiki/Transact-SQL) pour l’insertion, la modification et l’extraction de données.</span><span class="sxs-lookup"><span data-stu-id="2c259-111">Databases like Microsoft s SQL Server 2005 use the [Transact-Structured Query Language (T-SQL)](http://en.wikipedia.org/wiki/Transact-SQL) for inserting, modifying, and retrieving data.</span></span> <span data-ttu-id="2c259-112">La plupart des systèmes de base de données incluent des constructions pour le regroupement d’une série d’instructions SQL qui peuvent ensuite être exécutées comme une seule unité réutilisable.</span><span class="sxs-lookup"><span data-stu-id="2c259-112">Most database systems include constructs for grouping a series of SQL statements that can then be executed as a single, reusable unit.</span></span> <span data-ttu-id="2c259-113">Les procédures stockées en sont un exemple.</span><span class="sxs-lookup"><span data-stu-id="2c259-113">Stored procedures are one example.</span></span> <span data-ttu-id="2c259-114">Une autre est une *fonction définie par l’utilisateur*(UDF), une construction que nous examinerons plus en détail à l’étape 9.</span><span class="sxs-lookup"><span data-stu-id="2c259-114">Another is *User-Defined Functions*(UDFs), a construct that we will examine in greater detail in Step 9.</span></span>

<span data-ttu-id="2c259-115">À son cœur, SQL est conçu pour utiliser des ensembles de données.</span><span class="sxs-lookup"><span data-stu-id="2c259-115">At its core, SQL is designed for working with sets of data.</span></span> <span data-ttu-id="2c259-116">Les `SELECT` `UPDATE` instructions, et `DELETE` s’appliquent de manière intrinsèque à tous les enregistrements de la table correspondante et sont limitées uniquement par leurs `WHERE` clauses.</span><span class="sxs-lookup"><span data-stu-id="2c259-116">The `SELECT`, `UPDATE`, and `DELETE` statements inherently apply to all records in the corresponding table and are only limited by their `WHERE` clauses.</span></span> <span data-ttu-id="2c259-117">Pourtant, il existe de nombreuses fonctionnalités de langage conçues pour travailler avec un seul enregistrement à la fois et pour manipuler les données scalaires.</span><span class="sxs-lookup"><span data-stu-id="2c259-117">Yet there are many language features designed for working with one record at a time and for manipulating scalar data.</span></span> <span data-ttu-id="2c259-118">[ `CURSOR` autorise l'](http://www.sqlteam.com/item.asp?ItemID=553) exécution d’un ensemble d’enregistrements en boucle l’un après l’autre.</span><span class="sxs-lookup"><span data-stu-id="2c259-118">[`CURSOR` s](http://www.sqlteam.com/item.asp?ItemID=553) allow for a set of records to be looped through one at a time.</span></span> <span data-ttu-id="2c259-119">Les fonctions de manipulation de chaînes telles que `LEFT` , `CHARINDEX` et `PATINDEX` fonctionnent avec des données scalaires.</span><span class="sxs-lookup"><span data-stu-id="2c259-119">String manipulation functions like `LEFT`, `CHARINDEX`, and `PATINDEX` work with scalar data.</span></span> <span data-ttu-id="2c259-120">SQL comprend également des instructions de workflow de contrôle telles que `IF` et `WHILE` .</span><span class="sxs-lookup"><span data-stu-id="2c259-120">SQL also includes control flow statements like `IF` and `WHILE`.</span></span>

<span data-ttu-id="2c259-121">Avant Microsoft SQL Server 2005, les procédures stockées et les fonctions définies par l’utilisateur pouvaient uniquement être définies en tant que collection d’instructions T-SQL.</span><span class="sxs-lookup"><span data-stu-id="2c259-121">Prior to Microsoft SQL Server 2005, stored procedures and UDFs could only be defined as a collection of T-SQL statements.</span></span> <span data-ttu-id="2c259-122">SQL Server 2005, toutefois, a été conçu pour permettre l’intégration au [Common Language Runtime (CLR)](https://msdn.microsoft.com/netframework/aa497266.aspx), qui est le runtime utilisé par tous les assemblys .net.</span><span class="sxs-lookup"><span data-stu-id="2c259-122">SQL Server 2005, however, was designed to provide integration with the [Common Language Runtime (CLR)](https://msdn.microsoft.com/netframework/aa497266.aspx), which is the runtime used by all .NET assemblies.</span></span> <span data-ttu-id="2c259-123">Par conséquent, les procédures stockées et les fonctions définies par l’utilisateur dans une base de données SQL Server 2005 peuvent être créées à l’aide de code managé.</span><span class="sxs-lookup"><span data-stu-id="2c259-123">Consequently, the stored procedures and UDFs in a SQL Server 2005 database can be created using managed code.</span></span> <span data-ttu-id="2c259-124">Autrement dit, vous pouvez créer une procédure stockée ou une fonction définie par l’opération dans une classe C#.</span><span class="sxs-lookup"><span data-stu-id="2c259-124">That is, you can create a stored procedure or UDF as a method in a C# class.</span></span> <span data-ttu-id="2c259-125">Cela permet à ces procédures stockées et fonctions définies par l’utilisateur d’utiliser les fonctionnalités de la .NET Framework et de vos propres classes personnalisées.</span><span class="sxs-lookup"><span data-stu-id="2c259-125">This enables these stored procedures and UDFs to utilize functionality in the .NET Framework and from your own custom classes.</span></span>

<span data-ttu-id="2c259-126">Dans ce didacticiel, nous allons examiner comment créer des procédures stockées gérées et des fonctions définies par l’utilisateur et comment les intégrer dans la base de données Northwind.</span><span class="sxs-lookup"><span data-stu-id="2c259-126">In this tutorial we will examine how to create managed stored procedures and User-Defined Functions and how to integrate them into our Northwind database.</span></span> <span data-ttu-id="2c259-127">Commençons !</span><span class="sxs-lookup"><span data-stu-id="2c259-127">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="2c259-128">Les objets de base de données managés présentent des avantages par rapport à leurs équivalents SQL.</span><span class="sxs-lookup"><span data-stu-id="2c259-128">Managed database objects offer some advantages over their SQL counterparts.</span></span> <span data-ttu-id="2c259-129">La richesse et la connaissance du langage, ainsi que la possibilité de réutiliser le code et la logique existants, sont les principaux avantages.</span><span class="sxs-lookup"><span data-stu-id="2c259-129">Language richness and familiarity and the ability to reuse existing code and logic are the main advantages.</span></span> <span data-ttu-id="2c259-130">Toutefois, les objets de base de données managés sont susceptibles d’être moins efficaces quand vous utilisez des jeux de données qui n’impliquent pas une logique procédurale.</span><span class="sxs-lookup"><span data-stu-id="2c259-130">But managed database objects are likely to be less efficient when working with sets of data that do not involve much procedural logic.</span></span> <span data-ttu-id="2c259-131">Pour une discussion plus approfondie sur les avantages de l’utilisation du code managé par rapport à T-SQL, Découvrez les [avantages de l’utilisation du code managé pour créer des objets de base de données](https://msdn.microsoft.com/library/k2e1fb36(VS.80).aspx).</span><span class="sxs-lookup"><span data-stu-id="2c259-131">For a more thorough discussion on the advantages of using managed code versus T-SQL, check out the [Advantages of Using Managed Code to Create Database Objects](https://msdn.microsoft.com/library/k2e1fb36(VS.80).aspx).</span></span>

## <a name="step-1-moving-the-northwind-database-out-ofapp_data"></a><span data-ttu-id="2c259-132">Étape 1 : déplacement de la base de données Northwind de`App_Data`</span><span class="sxs-lookup"><span data-stu-id="2c259-132">Step 1: Moving the Northwind Database Out of`App_Data`</span></span>

<span data-ttu-id="2c259-133">Tous nos didacticiels, jusqu’à présent, ont utilisé un fichier de base de données Microsoft SQL Server 2005 Express Edition dans le dossier de l’application Web `App_Data` .</span><span class="sxs-lookup"><span data-stu-id="2c259-133">All of our tutorials thus far have used a Microsoft SQL Server 2005 Express Edition database file in the web application s `App_Data` folder.</span></span> <span data-ttu-id="2c259-134">En simplifiant la distribution et l’exécution de ces didacticiels dans la base de données, `App_Data` tous les fichiers étaient situés dans un répertoire et aucune étape de configuration supplémentaire n’est nécessaire pour tester le didacticiel.</span><span class="sxs-lookup"><span data-stu-id="2c259-134">Placing the database in `App_Data` simplified distributing and running these tutorials as all of the files were located within one directory and required no additional configuration steps to test the tutorial.</span></span>

<span data-ttu-id="2c259-135">Toutefois, pour ce didacticiel, nous allons déplacer la base de données Northwind de `App_Data` et l’inscrire explicitement auprès de l’instance de base de données SQL Server 2005 Express Edition.</span><span class="sxs-lookup"><span data-stu-id="2c259-135">For this tutorial, however, let s move the Northwind database out of `App_Data` and explicitly register it with the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="2c259-136">Bien que nous puissions effectuer les étapes de ce didacticiel avec la base de données dans le `App_Data` dossier, un certain nombre d’étapes sont considérablement plus simples en inscrivant explicitement la base de données auprès de l’instance de base de données SQL Server 2005 Express Edition.</span><span class="sxs-lookup"><span data-stu-id="2c259-136">While we can perform the steps for this tutorial with the database in the `App_Data` folder, a number of the steps are made much simpler by explicitly registering the database with the SQL Server 2005 Express Edition database instance.</span></span>

<span data-ttu-id="2c259-137">Le téléchargement de ce didacticiel contient les deux fichiers de base de données, `NORTHWND.MDF` et `NORTHWND_log.LDF` placés dans un dossier nommé `DataFiles` .</span><span class="sxs-lookup"><span data-stu-id="2c259-137">The download for this tutorial has the two database files - `NORTHWND.MDF` and `NORTHWND_log.LDF` - placed in a folder named `DataFiles`.</span></span> <span data-ttu-id="2c259-138">Si vous suivez votre propre implémentation des didacticiels, fermez Visual Studio et déplacez les `NORTHWND.MDF` `NORTHWND_log.LDF` fichiers et du dossier du site Web `App_Data` vers un dossier en dehors du site Web.</span><span class="sxs-lookup"><span data-stu-id="2c259-138">If you are following along with your own implementation of the tutorials, close Visual Studio and move the `NORTHWND.MDF` and `NORTHWND_log.LDF` files from the website s `App_Data` folder to a folder outside of the website.</span></span> <span data-ttu-id="2c259-139">Une fois que les fichiers de base de données ont été déplacés vers un autre dossier, nous devons inscrire la base de données Northwind auprès de l’instance de base de données SQL Server 2005 Express Edition.</span><span class="sxs-lookup"><span data-stu-id="2c259-139">Once the database files have been moved to another folder we need to register the Northwind database with the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="2c259-140">Pour ce faire, vous pouvez utiliser SQL Server Management Studio.</span><span class="sxs-lookup"><span data-stu-id="2c259-140">This can be done from SQL Server Management Studio.</span></span> <span data-ttu-id="2c259-141">Si vous disposez d’une édition non Express de SQL Server 2005 installée sur votre ordinateur, vous avez probablement déjà installé Management Studio.</span><span class="sxs-lookup"><span data-stu-id="2c259-141">If you have a non-Express Edition of SQL Server 2005 installed on your computer then you likely already have Management Studio installed.</span></span> <span data-ttu-id="2c259-142">Si vous n’avez SQL Server 2005 Express Edition sur votre ordinateur, prenez un moment pour télécharger et installer [Microsoft SQL Server Management Studio Express](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span><span class="sxs-lookup"><span data-stu-id="2c259-142">If you only have SQL Server 2005 Express Edition on your computer then take a moment to download and install [Microsoft SQL Server Management Studio Express](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span></span>

<span data-ttu-id="2c259-143">Lancez SQL Server Management Studio.</span><span class="sxs-lookup"><span data-stu-id="2c259-143">Launch SQL Server Management Studio.</span></span> <span data-ttu-id="2c259-144">Comme le montre la figure 1, Management Studio commence par demander le serveur auquel se connecter.</span><span class="sxs-lookup"><span data-stu-id="2c259-144">As Figure 1 shows, Management Studio starts by asking what server to connect to.</span></span> <span data-ttu-id="2c259-145">Entrez localhost\SQLExpress pour le nom du serveur, choisissez authentification Windows dans la liste déroulante authentification, puis cliquez sur se connecter.</span><span class="sxs-lookup"><span data-stu-id="2c259-145">Enter localhost\SQLExpress for the server name, choose Windows Authentication in the Authentication drop-down list, and click Connect.</span></span>

![Se connecter à l’instance de base de données appropriée](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image1.png)

<span data-ttu-id="2c259-147">**Figure 1**: connexion à l’instance de base de données appropriée</span><span class="sxs-lookup"><span data-stu-id="2c259-147">**Figure 1**: Connect to the Appropriate Database Instance</span></span>

<span data-ttu-id="2c259-148">Une fois connecté, la fenêtre Explorateur d’objets affiche des informations sur l’instance de base de données SQL Server 2005 Express Edition, notamment ses bases de données, les informations de sécurité, les options de gestion, etc.</span><span class="sxs-lookup"><span data-stu-id="2c259-148">Once you ve connected, the Object Explorer window will list information about the SQL Server 2005 Express Edition database instance, including its databases, security information, management options, and so forth.</span></span>

<span data-ttu-id="2c259-149">Nous devons attacher la base de données Northwind dans le `DataFiles` dossier (ou à l’endroit où vous l’avez éventuellement déplacée) dans l’instance de base de données SQL Server 2005 Express Edition.</span><span class="sxs-lookup"><span data-stu-id="2c259-149">We need to attach the Northwind database in the `DataFiles` folder (or wherever you may have moved it) to the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="2c259-150">Cliquez avec le bouton droit sur le dossier bases de données et choisissez l’option attacher dans le menu contextuel.</span><span class="sxs-lookup"><span data-stu-id="2c259-150">Right-click on the Databases folder and choose the Attach option from the context menu.</span></span> <span data-ttu-id="2c259-151">La boîte de dialogue attacher des bases de données s’affiche.</span><span class="sxs-lookup"><span data-stu-id="2c259-151">This will bring up the Attach Databases dialog box.</span></span> <span data-ttu-id="2c259-152">Cliquez sur le bouton Ajouter, explorez le fichier approprié `NORTHWND.MDF` , puis cliquez sur OK.</span><span class="sxs-lookup"><span data-stu-id="2c259-152">Click the Add button, drill down to the appropriate `NORTHWND.MDF` file, and click OK.</span></span> <span data-ttu-id="2c259-153">À ce stade, votre écran doit ressembler à la figure 2.</span><span class="sxs-lookup"><span data-stu-id="2c259-153">At this point your screen should look similar to Figure 2.</span></span>

<span data-ttu-id="2c259-154">[![Se connecter à l’instance de base de données appropriée](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image3.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image2.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-154">[![Connect to the Appropriate Database Instance](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image3.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image2.png)</span></span>

<span data-ttu-id="2c259-155">**Figure 2**: connexion à l’instance de base de données appropriée ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-155">**Figure 2**: Connect to the Appropriate Database Instance ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image4.png))</span></span>

> [!NOTE]
> <span data-ttu-id="2c259-156">Lors de la connexion à l’instance de SQL Server 2005 Express Edition via Management Studio la boîte de dialogue attacher des bases de données ne vous permet pas d’accéder aux répertoires des profils utilisateur, tels que mes documents.</span><span class="sxs-lookup"><span data-stu-id="2c259-156">When connecting to the SQL Server 2005 Express Edition instance through Management Studio the Attach Databases dialog box does not allow you to drill down into user profile directories, such as My Documents.</span></span> <span data-ttu-id="2c259-157">Par conséquent, veillez à placer `NORTHWND.MDF` les `NORTHWND_log.LDF` fichiers et dans un répertoire de profil non-utilisateur.</span><span class="sxs-lookup"><span data-stu-id="2c259-157">Therefore, make sure to place the `NORTHWND.MDF` and `NORTHWND_log.LDF` files in a non-user profile directory.</span></span>

<span data-ttu-id="2c259-158">Cliquez sur le bouton OK pour attacher la base de données.</span><span class="sxs-lookup"><span data-stu-id="2c259-158">Click the OK button to attach the database.</span></span> <span data-ttu-id="2c259-159">La boîte de dialogue attacher des bases de données se ferme et l’Explorateur d’objets doit à présent répertorier la base de données qui vient d’être attachée.</span><span class="sxs-lookup"><span data-stu-id="2c259-159">The Attach Databases dialog box will close and the Object Explorer should now list the just-attached database.</span></span> <span data-ttu-id="2c259-160">Il est probable que la base de données Northwind ait un nom tel que `9FE54661B32FDD967F51D71D0D5145CC_LINE ARTICLES\DATATUTORIALS\VOLUME 3\CSHARP\73\ASPNET_DATA_TUTORIAL_75_CS\APP_DATA\NORTHWND.MDF` .</span><span class="sxs-lookup"><span data-stu-id="2c259-160">Chances are the Northwind database has a name like `9FE54661B32FDD967F51D71D0D5145CC_LINE ARTICLES\DATATUTORIALS\VOLUME 3\CSHARP\73\ASPNET_DATA_TUTORIAL_75_CS\APP_DATA\NORTHWND.MDF`.</span></span> <span data-ttu-id="2c259-161">Renommez la base de données en Northwind en cliquant avec le bouton droit sur la base de données et en choisissant renommer.</span><span class="sxs-lookup"><span data-stu-id="2c259-161">Rename the database to Northwind by right-clicking on the database and choosing Rename.</span></span>

![Renommez la base de données en Northwind](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image5.png)

<span data-ttu-id="2c259-163">**Figure 3**: renommer la base de données en Northwind</span><span class="sxs-lookup"><span data-stu-id="2c259-163">**Figure 3**: Rename the Database to Northwind</span></span>

## <a name="step-2-creating-a-new-solution-and-sql-server-project-in-visual-studio"></a><span data-ttu-id="2c259-164">Étape 2 : création d’une solution et d’SQL Server projet dans Visual Studio</span><span class="sxs-lookup"><span data-stu-id="2c259-164">Step 2: Creating a New Solution and SQL Server Project in Visual Studio</span></span>

<span data-ttu-id="2c259-165">Pour créer des procédures stockées ou des fonctions définies par l’utilisateur dans SQL Server 2005, nous allons écrire la procédure stockée et la logique UDF en tant que code C# dans une classe.</span><span class="sxs-lookup"><span data-stu-id="2c259-165">To create managed stored procedures or UDFs in SQL Server 2005 we will write the stored procedure and UDF logic as C# code in a class.</span></span> <span data-ttu-id="2c259-166">Une fois que le code a été écrit, nous devons compiler cette classe dans un assembly (un `.dll` fichier), inscrire l’assembly auprès de la base de données SQL Server, puis créer une procédure stockée ou un objet UDF dans la base de données qui pointe vers la méthode correspondante dans l’assembly.</span><span class="sxs-lookup"><span data-stu-id="2c259-166">Once the code has been written, we will need to compile this class into an assembly (a `.dll` file), register the assembly with the SQL Server database, and then create a stored procedure or UDF object in the database that points to the corresponding method in the assembly.</span></span> <span data-ttu-id="2c259-167">Ces étapes peuvent toutes être effectuées manuellement.</span><span class="sxs-lookup"><span data-stu-id="2c259-167">These steps can all be performed manually.</span></span> <span data-ttu-id="2c259-168">Nous pouvons créer le code dans n’importe quel éditeur de texte, le compiler à partir de la ligne de commande à l’aide du compilateur C# ( [`csc.exe`](https://msdn.microsoft.com/library/ms379563(vs.80).aspx) ), l’inscrire auprès de la base de données à l’aide de la [`CREATE ASSEMBLY`](https://msdn.microsoft.com/library/ms189524.aspx) commande ou de Management Studio, et ajouter la procédure stockée ou l’objet UDF par le biais de moyens similaires.</span><span class="sxs-lookup"><span data-stu-id="2c259-168">We can create the code in any text editor, compile it from the command line using the C# compiler ([`csc.exe`](https://msdn.microsoft.com/library/ms379563(vs.80).aspx)), register it with the database using the [`CREATE ASSEMBLY`](https://msdn.microsoft.com/library/ms189524.aspx) command or from Management Studio, and add the stored procedure or UDF object through similar means.</span></span> <span data-ttu-id="2c259-169">Heureusement, les versions Professional et Team Systems de Visual Studio incluent un type de projet SQL Server qui automatise ces tâches.</span><span class="sxs-lookup"><span data-stu-id="2c259-169">Fortunately, the Professional and Team Systems versions of Visual Studio include a SQL Server Project type that automates these tasks.</span></span> <span data-ttu-id="2c259-170">Dans ce didacticiel, nous allons utiliser le type de projet SQL Server pour créer une procédure stockée managée et une fonction définie par l’opération.</span><span class="sxs-lookup"><span data-stu-id="2c259-170">In this tutorial we will walk through using the SQL Server Project type to create a managed stored procedure and UDF.</span></span>

> [!NOTE]
> <span data-ttu-id="2c259-171">Si vous utilisez Visual Web Developer ou l’édition standard de Visual Studio, vous devrez utiliser l’approche manuelle à la place.</span><span class="sxs-lookup"><span data-stu-id="2c259-171">If you are using Visual Web Developer or the Standard edition of Visual Studio, then you will have to use the manual approach instead.</span></span> <span data-ttu-id="2c259-172">L’étape 13 fournit des instructions détaillées pour exécuter ces étapes manuellement.</span><span class="sxs-lookup"><span data-stu-id="2c259-172">Step 13 provides detailed instructions for performing these steps manually.</span></span> <span data-ttu-id="2c259-173">Je vous encourage à lire les étapes 2 à 12 avant de lire l’étape 13, car ces étapes incluent des instructions de configuration SQL Server importantes qui doivent être appliquées, quelle que soit la version de Visual Studio que vous utilisez.</span><span class="sxs-lookup"><span data-stu-id="2c259-173">I encourage you to read Steps 2 through 12 before reading Step 13 since these steps include important SQL Server configuration instructions that must be applied regardless of what version of Visual Studio you are using.</span></span>

<span data-ttu-id="2c259-174">Commencez par ouvrir Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="2c259-174">Start by opening Visual Studio.</span></span> <span data-ttu-id="2c259-175">Dans le menu fichier, choisissez nouveau projet pour afficher la boîte de dialogue Nouveau projet (voir figure 4).</span><span class="sxs-lookup"><span data-stu-id="2c259-175">From the File menu, choose New Project to display the New Project dialog box (see Figure 4).</span></span> <span data-ttu-id="2c259-176">Explorez le type de projet de base de données, puis, à partir des modèles figurant sur la droite, choisissez de créer un projet de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="2c259-176">Drill down to the Database project type and then, from the Templates listed on the right, choose to create a new SQL Server Project.</span></span> <span data-ttu-id="2c259-177">J’ai choisi de nommer ce projet `ManagedDatabaseConstructs` et de le placer dans une solution nommée `Tutorial75` .</span><span class="sxs-lookup"><span data-stu-id="2c259-177">I have chosen to name this project `ManagedDatabaseConstructs` and placed it within a Solution named `Tutorial75`.</span></span>

<span data-ttu-id="2c259-178">[![Créer un projet de SQL Server](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image7.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image6.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-178">[![Create a New SQL Server Project](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image7.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image6.png)</span></span>

<span data-ttu-id="2c259-179">**Figure 4**: créer un projet de SQL Server ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-179">**Figure 4**: Create a New SQL Server Project ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image8.png))</span></span>

<span data-ttu-id="2c259-180">Cliquez sur le bouton OK dans la boîte de dialogue Nouveau projet pour créer la solution et SQL Server projet.</span><span class="sxs-lookup"><span data-stu-id="2c259-180">Click the OK button in the New Project dialog box to create the Solution and SQL Server Project.</span></span>

<span data-ttu-id="2c259-181">Un projet de SQL Server est lié à une base de données particulière.</span><span class="sxs-lookup"><span data-stu-id="2c259-181">A SQL Server Project is tied to a particular database.</span></span> <span data-ttu-id="2c259-182">Par conséquent, après la création du projet de SQL Server, nous avons immédiatement demandé de spécifier ces informations.</span><span class="sxs-lookup"><span data-stu-id="2c259-182">Consequently, after creating the new SQL Server Project we are immediately asked to specify this information.</span></span> <span data-ttu-id="2c259-183">La figure 5 montre la boîte de dialogue nouvelle référence de base de données qui a été remplie pour pointer vers la base de données Northwind que nous avons inscrite dans l’instance de base de données SQL Server 2005 Express Edition à l’étape 1.</span><span class="sxs-lookup"><span data-stu-id="2c259-183">Figure 5 shows the New Database Reference dialog box that has been filled out to point to the Northwind database we registered in the SQL Server 2005 Express Edition database instance back in Step 1.</span></span>

![Associer le projet SQL Server à la base de données Northwind](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image9.png)

<span data-ttu-id="2c259-185">**Figure 5**: associer le projet SQL Server à la base de données Northwind</span><span class="sxs-lookup"><span data-stu-id="2c259-185">**Figure 5**: Associate the SQL Server Project with the Northwind Database</span></span>

<span data-ttu-id="2c259-186">Afin de déboguer les procédures stockées managées et les fonctions définies par l’utilisateur créées dans ce projet, nous devons activer la prise en charge du débogage SQL/CLR pour la connexion.</span><span class="sxs-lookup"><span data-stu-id="2c259-186">In order to debug the managed stored procedures and UDFs we will create within this project, we need to enable SQL/CLR debugging support for the connection.</span></span> <span data-ttu-id="2c259-187">Lorsque vous associez un projet de SQL Server à une nouvelle base de données (comme nous l’avons fait dans la figure 5), Visual Studio nous demande si vous souhaitez activer le débogage SQL/CLR sur la connexion (voir la figure 6).</span><span class="sxs-lookup"><span data-stu-id="2c259-187">Whenever associating a SQL Server Project with a new database (as we did in Figure 5), Visual Studio asks us if we want to enable SQL/CLR debugging on the connection (see Figure 6).</span></span> <span data-ttu-id="2c259-188">Cliquez sur Oui.</span><span class="sxs-lookup"><span data-stu-id="2c259-188">Click Yes.</span></span>

![Activer le débogage SQL/CLR](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image10.png)

<span data-ttu-id="2c259-190">**Figure 6**: activer le débogage SQL/CLR</span><span class="sxs-lookup"><span data-stu-id="2c259-190">**Figure 6**: Enable SQL/CLR Debugging</span></span>

<span data-ttu-id="2c259-191">À ce stade, le nouveau projet de SQL Server a été ajouté à la solution.</span><span class="sxs-lookup"><span data-stu-id="2c259-191">At this point the new SQL Server Project has been added to the Solution.</span></span> <span data-ttu-id="2c259-192">Il contient un dossier nommé `Test Scripts` avec un fichier nommé `Test.sql` , qui est utilisé pour déboguer les objets de base de données managés créés dans le projet.</span><span class="sxs-lookup"><span data-stu-id="2c259-192">It contains a folder named `Test Scripts` with a file named `Test.sql`, which is used for debugging the managed database objects created in the project.</span></span> <span data-ttu-id="2c259-193">Nous allons examiner le débogage à l’étape 12.</span><span class="sxs-lookup"><span data-stu-id="2c259-193">We will look at debugging in Step 12.</span></span>

<span data-ttu-id="2c259-194">Nous pouvons maintenant ajouter de nouvelles procédures stockées gérées et des fonctions définies par l’utilisateur à ce projet. Toutefois, avant de commencer, vous incluez d’abord notre application Web existante dans la solution.</span><span class="sxs-lookup"><span data-stu-id="2c259-194">We can now add new managed stored procedures and UDFs to this project, but before we do let s first include our existing web application in the Solution.</span></span> <span data-ttu-id="2c259-195">Dans le menu fichier, sélectionnez l’option Ajouter et choisissez site Web existant.</span><span class="sxs-lookup"><span data-stu-id="2c259-195">From the File menu select the Add option and choose Existing Web Site.</span></span> <span data-ttu-id="2c259-196">Accédez au dossier du site Web approprié, puis cliquez sur OK.</span><span class="sxs-lookup"><span data-stu-id="2c259-196">Browse to the appropriate website folder and click OK.</span></span> <span data-ttu-id="2c259-197">Comme le montre la figure 7, cette opération met à jour la solution pour inclure deux projets : le site Web et le `ManagedDatabaseConstructs` projet SQL Server.</span><span class="sxs-lookup"><span data-stu-id="2c259-197">As Figure 7 shows, this will update the Solution to include two projects: the website and the `ManagedDatabaseConstructs` SQL Server Project.</span></span>

![Le Explorateur de solutions comprend maintenant deux projets](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image11.png)

<span data-ttu-id="2c259-199">**Figure 7**: le Explorateur de solutions contient maintenant deux projets</span><span class="sxs-lookup"><span data-stu-id="2c259-199">**Figure 7**: The Solution Explorer Now Includes Two Projects</span></span>

<span data-ttu-id="2c259-200">La `NORTHWNDConnectionString` valeur dans `Web.config` référence actuellement le `NORTHWND.MDF` fichier dans le `App_Data` dossier.</span><span class="sxs-lookup"><span data-stu-id="2c259-200">The `NORTHWNDConnectionString` value in `Web.config` currently references the `NORTHWND.MDF` file in the `App_Data` folder.</span></span> <span data-ttu-id="2c259-201">Étant donné que nous avons supprimé cette base de données de `App_Data` et l’avez inscrite de manière explicite dans l’instance de base de données SQL Server 2005 Express Edition, nous devons mettre à jour la valeur en conséquence `NORTHWNDConnectionString` .</span><span class="sxs-lookup"><span data-stu-id="2c259-201">Since we removed this database from `App_Data` and explicitly registered it in the SQL Server 2005 Express Edition database instance, we need to correspondingly update the `NORTHWNDConnectionString` value.</span></span> <span data-ttu-id="2c259-202">Ouvrez le `Web.config` fichier sur le site Web et modifiez la `NORTHWNDConnectionString` valeur afin que la chaîne de connexion Lise : `Data Source=localhost\SQLExpress;Initial Catalog=Northwind;Integrated Security=True` .</span><span class="sxs-lookup"><span data-stu-id="2c259-202">Open the `Web.config` file in the website and change the `NORTHWNDConnectionString` value so that the connection string reads: `Data Source=localhost\SQLExpress;Initial Catalog=Northwind;Integrated Security=True`.</span></span> <span data-ttu-id="2c259-203">Après cette modification, votre `<connectionStrings>` section dans `Web.config` devrait ressembler à ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="2c259-203">After this change, your `<connectionStrings>` section in `Web.config` should look similar to the following:</span></span>

[!code-xml[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample1.xml)]

> [!NOTE]
> <span data-ttu-id="2c259-204">Comme indiqué dans le [didacticiel précédent](debugging-stored-procedures-cs.md), lors du débogage d’un objet SQL Server à partir d’une application cliente, telle qu’un site Web ASP.net, nous devons désactiver le regroupement de connexions.</span><span class="sxs-lookup"><span data-stu-id="2c259-204">As discussed in the [preceding tutorial](debugging-stored-procedures-cs.md), when debugging a SQL Server object from a client application, such as an ASP.NET website, we need to disable connection pooling.</span></span> <span data-ttu-id="2c259-205">La chaîne de connexion présentée ci-dessus désactive le regroupement de connexions ( `Pooling=false` ).</span><span class="sxs-lookup"><span data-stu-id="2c259-205">The connection string shown above disables connection pooling ( `Pooling=false` ).</span></span> <span data-ttu-id="2c259-206">Si vous n’envisagez pas de déboguer les procédures stockées managées et les fonctions définies par l’utilisateur sur le site Web ASP.NET, activez le regroupement de connexions.</span><span class="sxs-lookup"><span data-stu-id="2c259-206">If you do not plan on debugging the managed stored procedures and UDFs from the ASP.NET website, enable connection pooling.</span></span>

## <a name="step-3-creating-a-managed-stored-procedure"></a><span data-ttu-id="2c259-207">Étape 3 : création d’une procédure stockée managée</span><span class="sxs-lookup"><span data-stu-id="2c259-207">Step 3: Creating a Managed Stored Procedure</span></span>

<span data-ttu-id="2c259-208">Pour ajouter une procédure stockée managée à la base de données Northwind, vous devez d’abord créer la procédure stockée en tant que méthode dans le projet SQL Server.</span><span class="sxs-lookup"><span data-stu-id="2c259-208">To add a managed stored procedure to the Northwind database we first need to create the stored procedure as a method in the SQL Server Project.</span></span> <span data-ttu-id="2c259-209">Dans le Explorateur de solutions, cliquez avec le bouton droit sur le `ManagedDatabaseConstructs` nom du projet et choisissez d’ajouter un nouvel élément.</span><span class="sxs-lookup"><span data-stu-id="2c259-209">From the Solution Explorer, right-click on the `ManagedDatabaseConstructs` project name and choose to add a new item.</span></span> <span data-ttu-id="2c259-210">La boîte de dialogue Ajouter un nouvel élément s’affiche et répertorie les types d’objets de base de données managés qui peuvent être ajoutés au projet.</span><span class="sxs-lookup"><span data-stu-id="2c259-210">This will display the Add New Item dialog box, which lists the types of managed database objects that can be added to the project.</span></span> <span data-ttu-id="2c259-211">Comme le montre la figure 8, cela comprend les procédures stockées et les fonctions définies par l’utilisateur, entre autres.</span><span class="sxs-lookup"><span data-stu-id="2c259-211">As Figure 8 shows, this includes stored procedures and User-Defined Functions, among others.</span></span>

<span data-ttu-id="2c259-212">Commençons par ajouter une procédure stockée qui retourne simplement tous les produits qui ont été abandonnés.</span><span class="sxs-lookup"><span data-stu-id="2c259-212">Let s start by adding a stored procedure that simply returns all of the products that have been discontinued.</span></span> <span data-ttu-id="2c259-213">Nommez le nouveau fichier de procédure stockée `GetDiscontinuedProducts.cs` .</span><span class="sxs-lookup"><span data-stu-id="2c259-213">Name the new stored procedure file `GetDiscontinuedProducts.cs`.</span></span>

<span data-ttu-id="2c259-214">[![Ajouter une nouvelle procédure stockée nommée GetDiscontinuedProducts.cs](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image13.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image12.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-214">[![Add a New Stored Procedure Named GetDiscontinuedProducts.cs](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image13.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image12.png)</span></span>

<span data-ttu-id="2c259-215">**Figure 8**: ajouter une nouvelle procédure stockée nommée `GetDiscontinuedProducts.cs` ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-215">**Figure 8**: Add a New Stored Procedure Named `GetDiscontinuedProducts.cs` ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image14.png))</span></span>

<span data-ttu-id="2c259-216">Cela créera un nouveau fichier de classe C# avec le contenu suivant :</span><span class="sxs-lookup"><span data-stu-id="2c259-216">This will create a new C# class file with the following content:</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample2.cs)]

<span data-ttu-id="2c259-217">Notez que la procédure stockée est implémentée en tant que `static` méthode dans un `partial` fichier de classe nommé `StoredProcedures` .</span><span class="sxs-lookup"><span data-stu-id="2c259-217">Note that the stored procedure is implemented as a `static` method within a `partial` class file named `StoredProcedures`.</span></span> <span data-ttu-id="2c259-218">En outre, la `GetDiscontinuedProducts` méthode est décorée avec `SqlProcedure attribute` , qui marque la méthode comme une procédure stockée.</span><span class="sxs-lookup"><span data-stu-id="2c259-218">Moreover, the `GetDiscontinuedProducts` method is decorated with the `SqlProcedure attribute`, which marks the method as a stored procedure.</span></span>

<span data-ttu-id="2c259-219">Le code suivant crée un `SqlCommand` objet et définit son `CommandText` sur une `SELECT` requête qui retourne toutes les colonnes de la `Products` table pour les produits dont le `Discontinued` champ est égal à 1.</span><span class="sxs-lookup"><span data-stu-id="2c259-219">The following code creates a `SqlCommand` object and sets its `CommandText` to a `SELECT` query that returns all of the columns from the `Products` table for products whose `Discontinued` field equals 1.</span></span> <span data-ttu-id="2c259-220">Il exécute ensuite la commande et renvoie les résultats à l’application cliente.</span><span class="sxs-lookup"><span data-stu-id="2c259-220">It then executes the command and sends the results back to the client application.</span></span> <span data-ttu-id="2c259-221">Ajoutez ce code à la `GetDiscontinuedProducts` méthode.</span><span class="sxs-lookup"><span data-stu-id="2c259-221">Add this code to the `GetDiscontinuedProducts` method.</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample3.cs)]

<span data-ttu-id="2c259-222">Tous les objets de base de données managés ont accès à un [ `SqlContext` objet](https://msdn.microsoft.com/library/ms131108.aspx) qui représente le contexte de l’appelant.</span><span class="sxs-lookup"><span data-stu-id="2c259-222">All managed database objects have access to a [`SqlContext` object](https://msdn.microsoft.com/library/ms131108.aspx) that represents the context of the caller.</span></span> <span data-ttu-id="2c259-223">Le `SqlContext` fournit l’accès à un [ `SqlPipe` objet](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.aspx) par le biais de sa [ `Pipe` propriété](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlcontext.pipe.aspx).</span><span class="sxs-lookup"><span data-stu-id="2c259-223">The `SqlContext` provides access to a [`SqlPipe` object](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.aspx) via its [`Pipe` property](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlcontext.pipe.aspx).</span></span> <span data-ttu-id="2c259-224">Cet `SqlPipe` objet est utilisé pour ferry des informations entre la base de données SQL Server et l’application appelante.</span><span class="sxs-lookup"><span data-stu-id="2c259-224">This `SqlPipe` object is used to ferry information between the SQL Server database and the calling application.</span></span> <span data-ttu-id="2c259-225">Comme son nom l’indique, la [ `ExecuteAndSend` méthode](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.executeandsend.aspx) exécute un `SqlCommand` objet passé et renvoie les résultats à l’application cliente.</span><span class="sxs-lookup"><span data-stu-id="2c259-225">As its name implies, the [`ExecuteAndSend` method](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.executeandsend.aspx) executes a passed-in `SqlCommand` object and sends the results back to the client application.</span></span>

> [!NOTE]
> <span data-ttu-id="2c259-226">Les objets de base de données managés conviennent mieux aux procédures stockées et aux fonctions définies par l’utilisateur qui utilisent la logique procédurale plutôt que la logique basée sur un jeu.</span><span class="sxs-lookup"><span data-stu-id="2c259-226">Managed database objects are best suited for stored procedures and UDFs that use procedural logic rather than set-based logic.</span></span> <span data-ttu-id="2c259-227">La logique procédurale implique l’utilisation de jeux de données ligne par ligne ou l’utilisation de données scalaires.</span><span class="sxs-lookup"><span data-stu-id="2c259-227">Procedural logic involves working with sets of data on a row-by-row basis or working with scalar data.</span></span> <span data-ttu-id="2c259-228">`GetDiscontinuedProducts`Toutefois, la méthode que nous venons de créer n’implique aucune logique procédurale.</span><span class="sxs-lookup"><span data-stu-id="2c259-228">The `GetDiscontinuedProducts` method we just created, however, involves no procedural logic.</span></span> <span data-ttu-id="2c259-229">Par conséquent, il serait idéalement implémenté comme une procédure stockée T-SQL.</span><span class="sxs-lookup"><span data-stu-id="2c259-229">Therefore, it would ideally be implemented as a T-SQL stored procedure.</span></span> <span data-ttu-id="2c259-230">Elle est implémentée comme une procédure stockée managée pour illustrer les étapes nécessaires à la création et au déploiement de procédures stockées managées.</span><span class="sxs-lookup"><span data-stu-id="2c259-230">It is implemented as a managed stored procedure to demonstrate the steps necessary for creating and deploying managed stored procedures.</span></span>

## <a name="step-4-deploying-the-managed-stored-procedure"></a><span data-ttu-id="2c259-231">Étape 4 : déploiement de la procédure stockée managée</span><span class="sxs-lookup"><span data-stu-id="2c259-231">Step 4: Deploying the Managed Stored Procedure</span></span>

<span data-ttu-id="2c259-232">Une fois ce code terminé, nous sommes prêts à le déployer dans la base de données Northwind.</span><span class="sxs-lookup"><span data-stu-id="2c259-232">With this code complete, we are ready to deploy it to the Northwind database.</span></span> <span data-ttu-id="2c259-233">Le déploiement d’une SQL Server projet compile le code dans un assembly, inscrit l’assembly auprès de la base de données et crée les objets correspondants dans la base de données, en les liant aux méthodes appropriées dans l’assembly.</span><span class="sxs-lookup"><span data-stu-id="2c259-233">Deploying a SQL Server Project compiles the code into an assembly, registers the assembly with the database, and creates the corresponding objects in the database, linking them to the appropriate methods in the assembly.</span></span> <span data-ttu-id="2c259-234">L’ensemble exact de tâches effectuées par l’option de déploiement est plus précisément orthographié à l’étape 13.</span><span class="sxs-lookup"><span data-stu-id="2c259-234">The exact set of tasks performed by the Deploy option is more precisely spelled out in Step 13.</span></span> <span data-ttu-id="2c259-235">Cliquez avec le bouton droit sur le `ManagedDatabaseConstructs` nom du projet dans la Explorateur de solutions et choisissez l’option déployer.</span><span class="sxs-lookup"><span data-stu-id="2c259-235">Right-click on the `ManagedDatabaseConstructs` project name in the Solution Explorer and choose the Deploy option.</span></span> <span data-ttu-id="2c259-236">Toutefois, le déploiement échoue avec l’erreur suivante : syntaxe incorrecte à côté de « EXTERNAL ».</span><span class="sxs-lookup"><span data-stu-id="2c259-236">However, deployment fails with the following error: Incorrect syntax near 'EXTERNAL'.</span></span> <span data-ttu-id="2c259-237">Vous devrez peut-être affecter au niveau de compatibilité de la base de données actuelle une valeur plus élevée pour activer cette fonctionnalité.</span><span class="sxs-lookup"><span data-stu-id="2c259-237">You may need to set the compatibility level of the current database to a higher value to enable this feature.</span></span> <span data-ttu-id="2c259-238">Consultez l’aide de la procédure stockée `sp_dbcmptlevel` .</span><span class="sxs-lookup"><span data-stu-id="2c259-238">See help for the stored procedure `sp_dbcmptlevel`.</span></span>

<span data-ttu-id="2c259-239">Ce message d’erreur se produit lorsque vous tentez d’inscrire l’assembly auprès de la base de données Northwind.</span><span class="sxs-lookup"><span data-stu-id="2c259-239">This error message occurs when attempting to register the assembly with the Northwind database.</span></span> <span data-ttu-id="2c259-240">Pour pouvoir inscrire un assembly avec une base de données SQL Server 2005, le niveau de compatibilité de la base de données doit être défini sur 90.</span><span class="sxs-lookup"><span data-stu-id="2c259-240">In order to register an assembly with a SQL Server 2005 database, the database s compatibility level must be set to 90.</span></span> <span data-ttu-id="2c259-241">Par défaut, les nouvelles bases de données SQL Server 2005 ont un niveau de compatibilité de 90.</span><span class="sxs-lookup"><span data-stu-id="2c259-241">By default, new SQL Server 2005 databases have a compatibility level of 90.</span></span> <span data-ttu-id="2c259-242">Toutefois, les bases de données créées à l’aide de Microsoft SQL Server 2000 ont un niveau de compatibilité par défaut de 80.</span><span class="sxs-lookup"><span data-stu-id="2c259-242">However, databases created using Microsoft SQL Server 2000 have a default compatibility level of 80.</span></span> <span data-ttu-id="2c259-243">Étant donné que la base de données Northwind était initialement une base de données Microsoft SQL Server 2000, son niveau de compatibilité est actuellement défini sur 80 et doit donc être augmenté à 90 pour pouvoir inscrire des objets de base de données gérés.</span><span class="sxs-lookup"><span data-stu-id="2c259-243">Since the Northwind database was initially a Microsoft SQL Server 2000 database, its compatibility level is currently set to 80 and therefore needs to be increased to 90 in order to register managed database objects.</span></span>

<span data-ttu-id="2c259-244">Pour mettre à jour le niveau de compatibilité de la base de données, ouvrez une nouvelle fenêtre de requête dans Management Studio et entrez :</span><span class="sxs-lookup"><span data-stu-id="2c259-244">To update the database s compatibility level, open a New Query window in Management Studio and enter:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample4.sql)]

<span data-ttu-id="2c259-245">Cliquez sur l’icône exécuter dans la barre d’outils pour exécuter la requête ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="2c259-245">Click the Execute icon in the Toolbar to run the above query.</span></span>

<span data-ttu-id="2c259-246">[![Mettre à jour le niveau de compatibilité de la base de données Northwind](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image16.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-246">[![Update the Northwind Database s Compatibility Level](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image16.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image15.png)</span></span>

<span data-ttu-id="2c259-247">**Figure 9**: mettre à jour le niveau de compatibilité des bases de données Northwind ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image17.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-247">**Figure 9**: Update the Northwind Database s Compatibility Level ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image17.png))</span></span>

<span data-ttu-id="2c259-248">Après avoir mis à jour le niveau de compatibilité, Redéployez le projet SQL Server.</span><span class="sxs-lookup"><span data-stu-id="2c259-248">After updating the compatibility level, redeploy the SQL Server Project.</span></span> <span data-ttu-id="2c259-249">Cette fois-ci, le déploiement doit se terminer sans erreur.</span><span class="sxs-lookup"><span data-stu-id="2c259-249">This time the deployment should complete without error.</span></span>

<span data-ttu-id="2c259-250">Revenez à SQL Server Management Studio, cliquez avec le bouton droit sur la base de données Northwind dans l’Explorateur d’objets, puis choisissez actualiser.</span><span class="sxs-lookup"><span data-stu-id="2c259-250">Return to SQL Server Management Studio, right-click on the Northwind database in the Object Explorer, and choose Refresh.</span></span> <span data-ttu-id="2c259-251">Ensuite, explorez le dossier programmabilité, puis développez le dossier Assemblies.</span><span class="sxs-lookup"><span data-stu-id="2c259-251">Next, drill down into the Programmability folder and then expand the Assemblies folder.</span></span> <span data-ttu-id="2c259-252">Comme le montre la figure 10, la base de données Northwind comprend désormais l’assembly généré par le `ManagedDatabaseConstructs` projet.</span><span class="sxs-lookup"><span data-stu-id="2c259-252">As Figure 10 shows, the Northwind database now includes the assembly generated by the `ManagedDatabaseConstructs` project.</span></span>

![L’assembly ManagedDatabaseConstructs est maintenant inscrit auprès de la base de données Northwind](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image18.png)

<span data-ttu-id="2c259-254">**Figure 10**: l' `ManagedDatabaseConstructs` assembly est maintenant inscrit auprès de la base de données Northwind</span><span class="sxs-lookup"><span data-stu-id="2c259-254">**Figure 10**: The `ManagedDatabaseConstructs` Assembly is Now Registered with the Northwind Database</span></span>

<span data-ttu-id="2c259-255">Développez également le dossier procédures stockées.</span><span class="sxs-lookup"><span data-stu-id="2c259-255">Also expand the Stored Procedures folder.</span></span> <span data-ttu-id="2c259-256">Vous verrez une procédure stockée nommée `GetDiscontinuedProducts` .</span><span class="sxs-lookup"><span data-stu-id="2c259-256">There you will see a stored procedure named `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="2c259-257">Cette procédure stockée a été créée par le processus de déploiement et pointe vers la `GetDiscontinuedProducts` méthode dans l' `ManagedDatabaseConstructs` assembly.</span><span class="sxs-lookup"><span data-stu-id="2c259-257">This stored procedure was created by the deployment process and points to the `GetDiscontinuedProducts` method in the `ManagedDatabaseConstructs` assembly.</span></span> <span data-ttu-id="2c259-258">Lorsque la `GetDiscontinuedProducts` procédure stockée est exécutée, elle exécute à son tour la `GetDiscontinuedProducts` méthode.</span><span class="sxs-lookup"><span data-stu-id="2c259-258">When the `GetDiscontinuedProducts` stored procedure is executed, it, in turn, executes the `GetDiscontinuedProducts` method.</span></span> <span data-ttu-id="2c259-259">Étant donné qu’il s’agit d’une procédure stockée managée, elle ne peut pas être modifiée via Management Studio (par conséquent, l’icône de verrou en regard du nom de la procédure stockée).</span><span class="sxs-lookup"><span data-stu-id="2c259-259">Since this is a managed stored procedure it cannot be edited through Management Studio (hence the lock icon next to the stored procedure name).</span></span>

![La procédure stockée GetDiscontinuedProducts est indiquée dans le dossier procédures stockées.](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image19.png)

<span data-ttu-id="2c259-261">**Figure 11**: la `GetDiscontinuedProducts` procédure stockée est indiquée dans le dossier procédures stockées</span><span class="sxs-lookup"><span data-stu-id="2c259-261">**Figure 11**: The `GetDiscontinuedProducts` Stored Procedure is Listed in the Stored Procedures Folder</span></span>

<span data-ttu-id="2c259-262">Il reste encore un obstacle à surmonter avant de pouvoir appeler la procédure stockée gérée : la base de données est configurée pour empêcher l’exécution du code managé.</span><span class="sxs-lookup"><span data-stu-id="2c259-262">There is still one more hurdle we have to overcome before we can call the managed stored procedure: the database is configured to prevent execution of managed code.</span></span> <span data-ttu-id="2c259-263">Vérifiez cela en ouvrant une nouvelle fenêtre de requête et en exécutant la `GetDiscontinuedProducts` procédure stockée.</span><span class="sxs-lookup"><span data-stu-id="2c259-263">Verify this by opening a new query window and executing the `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="2c259-264">Vous recevrez le message d’erreur suivant : l’exécution du code utilisateur dans le .NET Framework est désactivée.</span><span class="sxs-lookup"><span data-stu-id="2c259-264">You will receive the following error message: Execution of user code in the .NET Framework is disabled.</span></span> <span data-ttu-id="2c259-265">Activez l’option de configuration clr enabled.</span><span class="sxs-lookup"><span data-stu-id="2c259-265">Enable 'clr enabled configuration option.</span></span>

<span data-ttu-id="2c259-266">Pour examiner les informations de configuration de la base de données Northwind, entrez et exécutez la commande `exec sp_configure` dans la fenêtre de requête.</span><span class="sxs-lookup"><span data-stu-id="2c259-266">To examine the Northwind database s configuration information, enter and execute the command `exec sp_configure` in the query window.</span></span> <span data-ttu-id="2c259-267">Cela indique que le paramètre CLR Enabled a actuellement la valeur 0.</span><span class="sxs-lookup"><span data-stu-id="2c259-267">This shows that the clr enabled setting is currently set to 0.</span></span>

<span data-ttu-id="2c259-268">[![Le paramètre CLR activé a actuellement la valeur 0](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image21.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image20.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-268">[![The clr enabled Setting is Currently Set to 0](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image21.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image20.png)</span></span>

<span data-ttu-id="2c259-269">**Figure 12**: le paramètre CLR activé est actuellement défini sur 0 ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image22.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-269">**Figure 12**: The clr enabled Setting is Currently Set to 0 ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image22.png))</span></span>

<span data-ttu-id="2c259-270">Notez que chaque paramètre de configuration de la figure 12 est associé à quatre valeurs : les valeurs minimale et maximale, ainsi que les valeurs de configuration et d’exécution.</span><span class="sxs-lookup"><span data-stu-id="2c259-270">Note that each configuration setting in Figure 12 has four values listed with it: the minimum and maximum values and the config and run values.</span></span> <span data-ttu-id="2c259-271">Pour mettre à jour la valeur de configuration du paramètre CLR activé, exécutez la commande suivante :</span><span class="sxs-lookup"><span data-stu-id="2c259-271">To update the config value for the clr enabled setting, execute the following command:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample5.sql)]

<span data-ttu-id="2c259-272">Si vous réexécutez le, `exec sp_configure` vous verrez que l’instruction ci-dessus a mis à jour la valeur de configuration du paramètre CLR activé sur 1, mais que la valeur d’exécution est toujours définie sur 0.</span><span class="sxs-lookup"><span data-stu-id="2c259-272">If you re-run the `exec sp_configure` you will see that the above statement updated the clr enabled setting s config value to 1, but that the run value is still set to 0.</span></span> <span data-ttu-id="2c259-273">Pour que cette modification de configuration prenne effet, nous devons exécuter la [ `RECONFIGURE` commande](https://msdn.microsoft.com/library/ms176069.aspx), qui définira la valeur d’exécution sur la valeur de configuration actuelle.</span><span class="sxs-lookup"><span data-stu-id="2c259-273">For this configuration change to take affect we need to execute the [`RECONFIGURE` command](https://msdn.microsoft.com/library/ms176069.aspx), which will set the run value to the current config value.</span></span> <span data-ttu-id="2c259-274">Entrez simplement `RECONFIGURE` dans la fenêtre de requête et cliquez sur l’icône exécuter dans la barre d’outils.</span><span class="sxs-lookup"><span data-stu-id="2c259-274">Simply enter `RECONFIGURE` in the query window and click the Execute icon in the Toolbar.</span></span> <span data-ttu-id="2c259-275">Si vous exécutez `exec sp_configure` maintenant, vous devriez voir la valeur 1 pour les paramètres CLR activés configuration et exécuter.</span><span class="sxs-lookup"><span data-stu-id="2c259-275">If you run `exec sp_configure` now you should see a value of 1 for the clr enabled setting s config and run values.</span></span>

<span data-ttu-id="2c259-276">Une fois la configuration CLR activée terminée, nous sommes prêts à exécuter la `GetDiscontinuedProducts` procédure stockée managée.</span><span class="sxs-lookup"><span data-stu-id="2c259-276">With the clr enabled configuration complete, we are ready to run the managed `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="2c259-277">Dans la fenêtre de requête, entrez et exécutez la commande `exec` `GetDiscontinuedProducts` .</span><span class="sxs-lookup"><span data-stu-id="2c259-277">In the query window enter and execute the command `exec` `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="2c259-278">L’appel de la procédure stockée provoque l’exécution du code managé correspondant dans la `GetDiscontinuedProducts` méthode.</span><span class="sxs-lookup"><span data-stu-id="2c259-278">Invoking the stored procedure causes the corresponding managed code in the `GetDiscontinuedProducts` method to execute.</span></span> <span data-ttu-id="2c259-279">Ce code émet une `SELECT` requête pour retourner tous les produits qui sont abandonnés et retourne ces données à l’application appelante, qui est SQL Server Management Studio dans cette instance.</span><span class="sxs-lookup"><span data-stu-id="2c259-279">This code issues a `SELECT` query to return all products that are discontinued and returns this data to the calling application, which is SQL Server Management Studio in this instance.</span></span> <span data-ttu-id="2c259-280">Management Studio reçoit ces résultats et les affiche dans la fenêtre résultats.</span><span class="sxs-lookup"><span data-stu-id="2c259-280">Management Studio receives these results and displays them in the Results window.</span></span>

<span data-ttu-id="2c259-281">[![La procédure stockée GetDiscontinuedProducts retourne tous les produits abandonnés](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image24.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-281">[![The GetDiscontinuedProducts Stored Procedure Returns All Discontinued Products](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image24.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image23.png)</span></span>

<span data-ttu-id="2c259-282">**Figure 13**: la `GetDiscontinuedProducts` procédure stockée retourne tous les produits abandonnés ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image25.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-282">**Figure 13**: The `GetDiscontinuedProducts` Stored Procedure Returns All Discontinued Products ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image25.png))</span></span>

## <a name="step-5-creating-managed-stored-procedures-that-accept-input-parameters"></a><span data-ttu-id="2c259-283">Étape 5 : création de procédures stockées managées acceptant les paramètres d’entrée</span><span class="sxs-lookup"><span data-stu-id="2c259-283">Step 5: Creating Managed Stored Procedures that Accept Input Parameters</span></span>

<span data-ttu-id="2c259-284">La plupart des requêtes et procédures stockées que nous avons créées dans ces didacticiels ont utilisé des *paramètres*.</span><span class="sxs-lookup"><span data-stu-id="2c259-284">Many of the queries and stored procedures we have created throughout these tutorials have used *parameters*.</span></span> <span data-ttu-id="2c259-285">Par exemple, dans le didacticiel [création de nouvelles procédures stockées pour les TableAdapters de DataSet typés](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) , nous avons créé une procédure stockée nommée `GetProductsByCategoryID` qui acceptait un paramètre d’entrée nommé `@CategoryID` .</span><span class="sxs-lookup"><span data-stu-id="2c259-285">For example, in the [Creating New Stored Procedures for the Typed DataSet s TableAdapters](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) tutorial we created a stored procedure named `GetProductsByCategoryID` that accepted an input parameter named `@CategoryID`.</span></span> <span data-ttu-id="2c259-286">La procédure stockée retournait alors tous les produits dont le `CategoryID` champ correspondait à la valeur du `@CategoryID` paramètre fourni.</span><span class="sxs-lookup"><span data-stu-id="2c259-286">The stored procedure then returned all products whose `CategoryID` field matched the value of the supplied `@CategoryID` parameter.</span></span>

<span data-ttu-id="2c259-287">Pour créer une procédure stockée managée qui accepte les paramètres d’entrée, il vous suffit de spécifier ces paramètres dans la définition de la méthode s.</span><span class="sxs-lookup"><span data-stu-id="2c259-287">To create a managed stored procedure that accepts input parameters, simply specify those parameters in the method s definition.</span></span> <span data-ttu-id="2c259-288">Pour illustrer cela, ajoutez une autre procédure stockée managée au `ManagedDatabaseConstructs` projet nommé `GetProductsWithPriceLessThan` .</span><span class="sxs-lookup"><span data-stu-id="2c259-288">To illustrate this, let s add another managed stored procedure to the `ManagedDatabaseConstructs` project named `GetProductsWithPriceLessThan`.</span></span> <span data-ttu-id="2c259-289">Cette procédure stockée managée accepte un paramètre d’entrée qui spécifie un prix et retourne tous les produits dont `UnitPrice` le champ est inférieur à la valeur du paramètre s.</span><span class="sxs-lookup"><span data-stu-id="2c259-289">This managed stored procedure will accept an input parameter specifying a price and will return all products whose `UnitPrice` field is less than the parameter s value.</span></span>

<span data-ttu-id="2c259-290">Pour ajouter une nouvelle procédure stockée au projet, cliquez avec le bouton droit sur le `ManagedDatabaseConstructs` nom du projet et choisissez d’ajouter une nouvelle procédure stockée.</span><span class="sxs-lookup"><span data-stu-id="2c259-290">To add a new stored procedure to the project, right-click on the `ManagedDatabaseConstructs` project name and choose to add a new stored procedure.</span></span> <span data-ttu-id="2c259-291">Nommez le fichier `GetProductsWithPriceLessThan.cs`.</span><span class="sxs-lookup"><span data-stu-id="2c259-291">Name the file `GetProductsWithPriceLessThan.cs`.</span></span> <span data-ttu-id="2c259-292">Comme nous l’avons vu à l’étape 3, cette opération crée un nouveau fichier de classe C# avec une méthode nommée `GetProductsWithPriceLessThan` placée dans la `partial` classe `StoredProcedures` .</span><span class="sxs-lookup"><span data-stu-id="2c259-292">As we saw in Step 3, this will create a new C# class file with a method named `GetProductsWithPriceLessThan` placed within the `partial` class `StoredProcedures`.</span></span>

<span data-ttu-id="2c259-293">Mettez à jour la définition de la `GetProductsWithPriceLessThan` méthode pour qu’elle accepte un [`SqlMoney`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.aspx) paramètre d’entrée nommé `price` et écrivez le code à exécuter et renvoyez les résultats de la requête :</span><span class="sxs-lookup"><span data-stu-id="2c259-293">Update the `GetProductsWithPriceLessThan` method s definition so that it accepts a [`SqlMoney`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.aspx) input parameter named `price` and write the code to execute and return the query results:</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample6.cs)]

<span data-ttu-id="2c259-294">La `GetProductsWithPriceLessThan` définition et le code de la méthode ressemblent étroitement à la définition et au code de la `GetDiscontinuedProducts` méthode créée à l’étape 3.</span><span class="sxs-lookup"><span data-stu-id="2c259-294">The `GetProductsWithPriceLessThan` method s definition and code closely resembles the definition and code of the `GetDiscontinuedProducts` method created in Step 3.</span></span> <span data-ttu-id="2c259-295">Les seules différences sont que la `GetProductsWithPriceLessThan` méthode accepte comme paramètre d’entrée ( `price` ), que la `SqlCommand` requête s comprend un paramètre ( `@MaxPrice` ) et qu’un paramètre est ajouté à la `SqlCommand` `Parameters` collection s et que la valeur de la variable leur est assignée `price` .</span><span class="sxs-lookup"><span data-stu-id="2c259-295">The only differences are that the `GetProductsWithPriceLessThan` method accepts as input parameter (`price`), the `SqlCommand` s query includes a parameter (`@MaxPrice`), and a parameter is added to the `SqlCommand` s `Parameters` collection is and assigned the value of the `price` variable.</span></span>

<span data-ttu-id="2c259-296">Après avoir ajouté ce code, Redéployez le projet SQL Server.</span><span class="sxs-lookup"><span data-stu-id="2c259-296">After adding this code, redeploy the SQL Server Project.</span></span> <span data-ttu-id="2c259-297">Ensuite, revenez à SQL Server Management Studio et actualisez le dossier procédures stockées.</span><span class="sxs-lookup"><span data-stu-id="2c259-297">Next, return to SQL Server Management Studio and Refresh the Stored Procedures folder.</span></span> <span data-ttu-id="2c259-298">Vous devez voir une nouvelle entrée, `GetProductsWithPriceLessThan` .</span><span class="sxs-lookup"><span data-stu-id="2c259-298">You should see a new entry, `GetProductsWithPriceLessThan`.</span></span> <span data-ttu-id="2c259-299">Dans une fenêtre de requête, entrez et exécutez la commande `exec GetProductsWithPriceLessThan 25` , qui répertorie tous les produits inférieurs à $25, comme illustré dans la figure 14.</span><span class="sxs-lookup"><span data-stu-id="2c259-299">From a query window, enter and execute the command `exec GetProductsWithPriceLessThan 25`, which will list all products less than $25, as Figure 14 shows.</span></span>

<span data-ttu-id="2c259-300">[![Les produits situés sous $25 sont affichés](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image27.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image26.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-300">[![Products Under $25 are Displayed](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image27.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image26.png)</span></span>

<span data-ttu-id="2c259-301">**Figure 14**: affichage des produits sous $25 ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image28.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-301">**Figure 14**: Products Under $25 are Displayed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image28.png))</span></span>

## <a name="step-6-calling-the-managed-stored-procedure-from-the-data-access-layer"></a><span data-ttu-id="2c259-302">Étape 6 : appel de la procédure stockée managée à partir de la couche d’accès aux données</span><span class="sxs-lookup"><span data-stu-id="2c259-302">Step 6: Calling the Managed Stored Procedure from the Data Access Layer</span></span>

<span data-ttu-id="2c259-303">À ce stade, nous avons ajouté le `GetDiscontinuedProducts` et les `GetProductsWithPriceLessThan` procédures stockées managées au `ManagedDatabaseConstructs` projet et vous les avez inscrits auprès de la base de données Northwind SQL Server.</span><span class="sxs-lookup"><span data-stu-id="2c259-303">At this point we have added the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures to the `ManagedDatabaseConstructs` project and have registered them with the Northwind SQL Server database.</span></span> <span data-ttu-id="2c259-304">Nous avons également appelé ces procédures stockées managées à partir de SQL Server Management Studio (voir les figures 13 et 14).</span><span class="sxs-lookup"><span data-stu-id="2c259-304">We also invoked these managed stored procedures from SQL Server Management Studio (see Figure s 13 and 14).</span></span> <span data-ttu-id="2c259-305">Toutefois, pour que notre application ASP.NET utilise ces procédures stockées managées, nous devons les ajouter aux couches de logique métier et d’accès aux données dans l’architecture.</span><span class="sxs-lookup"><span data-stu-id="2c259-305">In order for our ASP.NET application to use these managed stored procedures, however, we need to add them to the Data Access and Business Logic Layers in the architecture.</span></span> <span data-ttu-id="2c259-306">Dans cette étape, nous allons ajouter deux nouvelles méthodes au `ProductsTableAdapter` dans le `NorthwindWithSprocs` DataSet typé, qui a été initialement créé dans le didacticiel [création de nouvelles procédures stockées pour les TableAdapters de DataSet typé](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="2c259-306">In this step we will add two new methods to the `ProductsTableAdapter` in the `NorthwindWithSprocs` Typed DataSet, which was initially created in the [Creating New Stored Procedures for the Typed DataSet s TableAdapters](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) tutorial.</span></span> <span data-ttu-id="2c259-307">À l’étape 7, nous ajouterons les méthodes correspondantes à la couche BLL.</span><span class="sxs-lookup"><span data-stu-id="2c259-307">In Step 7 we will add corresponding methods to the BLL.</span></span>

<span data-ttu-id="2c259-308">Ouvrez le `NorthwindWithSprocs` DataSet typé dans Visual Studio et commencez par ajouter une nouvelle méthode au `ProductsTableAdapter` nommé `GetDiscontinuedProducts` .</span><span class="sxs-lookup"><span data-stu-id="2c259-308">Open the `NorthwindWithSprocs` Typed DataSet in Visual Studio and start by adding a new method to the `ProductsTableAdapter` named `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="2c259-309">Pour ajouter une nouvelle méthode à un TableAdapter, cliquez avec le bouton droit sur le nom du TableAdapter dans le concepteur, puis choisissez l’option Ajouter une requête dans le menu contextuel.</span><span class="sxs-lookup"><span data-stu-id="2c259-309">To add a new method to a TableAdapter, right-click on the TableAdapter s name in the Designer and choose the Add Query option from the context menu.</span></span>

> [!NOTE]
> <span data-ttu-id="2c259-310">Étant donné que nous avons déplacé la base de données Northwind du `App_Data` dossier vers l’instance de base de données SQL Server 2005 Express Edition, il est impératif que la chaîne de connexion correspondante dans Web.config soit mise à jour pour refléter cette modification.</span><span class="sxs-lookup"><span data-stu-id="2c259-310">Since we moved the Northwind database from the `App_Data` folder to the SQL Server 2005 Express Edition database instance, it is imperative that the corresponding connection string in Web.config be updated to reflect this change.</span></span> <span data-ttu-id="2c259-311">À l’étape 2, nous avons abordé la mise à jour `NORTHWNDConnectionString` de la valeur dans `Web.config` .</span><span class="sxs-lookup"><span data-stu-id="2c259-311">In Step 2 we discussed updating the `NORTHWNDConnectionString` value in `Web.config`.</span></span> <span data-ttu-id="2c259-312">Si vous avez oublié d’effectuer cette mise à jour, vous verrez le message d’erreur Échec de l’ajout de la requête.</span><span class="sxs-lookup"><span data-stu-id="2c259-312">If you forgot to make this update, then you will see the error message Failed to add query.</span></span> <span data-ttu-id="2c259-313">Connexion `NORTHWNDConnectionString` pour l’objet introuvable `Web.config` dans une boîte de dialogue lors de la tentative d’ajout d’une nouvelle méthode au TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="2c259-313">Unable to find connection `NORTHWNDConnectionString` for object `Web.config` in a dialog box when attempting to add a new method to the TableAdapter.</span></span> <span data-ttu-id="2c259-314">Pour résoudre cette erreur, cliquez sur OK, puis accédez à `Web.config` et mettez à jour la `NORTHWNDConnectionString` valeur comme indiqué à l’étape 2.</span><span class="sxs-lookup"><span data-stu-id="2c259-314">To resolve this error, click OK and then go to `Web.config` and update the `NORTHWNDConnectionString` value as discussed in Step 2.</span></span> <span data-ttu-id="2c259-315">Essayez ensuite d’ajouter à nouveau la méthode au TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="2c259-315">Then try re-adding the method to the TableAdapter.</span></span> <span data-ttu-id="2c259-316">Cette fois-ci, elle doit fonctionner sans erreur.</span><span class="sxs-lookup"><span data-stu-id="2c259-316">This time it should work without error.</span></span>

<span data-ttu-id="2c259-317">L’ajout d’une nouvelle méthode lance l’Assistant Configuration de requêtes TableAdapter, que nous avons utilisé plusieurs fois dans les didacticiels précédents.</span><span class="sxs-lookup"><span data-stu-id="2c259-317">Adding a new method launches the TableAdapter Query Configuration wizard, which we have used many times in past tutorials.</span></span> <span data-ttu-id="2c259-318">La première étape nous invite à spécifier comment le TableAdapter doit accéder à la base de données : par le biais d’une instruction SQL ad hoc ou via une procédure stockée nouvelle ou existante.</span><span class="sxs-lookup"><span data-stu-id="2c259-318">The first step asks us to specify how the TableAdapter should access the database: through an ad-hoc SQL statement or via a new or existing stored procedure.</span></span> <span data-ttu-id="2c259-319">Étant donné que nous avons déjà créé et enregistré la `GetDiscontinuedProducts` procédure stockée gérée avec la base de données, choisissez l’option utiliser une procédure stockée existante et appuyez sur suivant.</span><span class="sxs-lookup"><span data-stu-id="2c259-319">Since we have already created and registered the `GetDiscontinuedProducts` managed stored procedure with the database, choose the Use existing stored procedure option and hit Next.</span></span>

<span data-ttu-id="2c259-320">[![Choisir l’option utiliser une procédure stockée existante](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image30.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-320">[![Choose the Use existing stored procedure Option](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image30.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image29.png)</span></span>

<span data-ttu-id="2c259-321">**Figure 15**: sélectionner l’option utiliser une procédure stockée existante ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image31.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-321">**Figure 15**: Choose the Use existing stored procedure Option ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image31.png))</span></span>

<span data-ttu-id="2c259-322">L’écran suivant nous invite à entrer la procédure stockée que la méthode appellera.</span><span class="sxs-lookup"><span data-stu-id="2c259-322">The next screen prompts us for the stored procedure the method will invoke.</span></span> <span data-ttu-id="2c259-323">Choisissez la `GetDiscontinuedProducts` procédure stockée gérée dans la liste déroulante et appuyez sur suivant.</span><span class="sxs-lookup"><span data-stu-id="2c259-323">Choose the `GetDiscontinuedProducts` managed stored procedure from the drop-down list and hit Next.</span></span>

<span data-ttu-id="2c259-324">[![Sélectionner la procédure stockée managée GetDiscontinuedProducts](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image33.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image32.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-324">[![Select the GetDiscontinuedProducts Managed Stored Procedure](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image33.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image32.png)</span></span>

<span data-ttu-id="2c259-325">**Figure 16**: sélectionner la `GetDiscontinuedProducts` procédure stockée gérée ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image34.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-325">**Figure 16**: Select the `GetDiscontinuedProducts` Managed Stored Procedure ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image34.png))</span></span>

<span data-ttu-id="2c259-326">Nous sommes ensuite invités à spécifier si la procédure stockée retourne des lignes, une seule valeur ou rien.</span><span class="sxs-lookup"><span data-stu-id="2c259-326">We are then asked to specify whether the stored procedure returns rows, a single value, or nothing.</span></span> <span data-ttu-id="2c259-327">Étant donné que `GetDiscontinuedProducts` retourne le jeu de lignes de produits abandonnées, choisissez la première option (données tabulaires), puis cliquez sur suivant.</span><span class="sxs-lookup"><span data-stu-id="2c259-327">Since `GetDiscontinuedProducts` returns the set of discontinued product rows, choose the first option ( Tabular data ) and click Next.</span></span>

<span data-ttu-id="2c259-328">[![Sélectionnez l’option données tabulaires.](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image36.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-328">[![Select the Tabular Data Option](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image36.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image35.png)</span></span>

<span data-ttu-id="2c259-329">**Figure 17**: sélectionner l’option données tabulaires ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image37.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-329">**Figure 17**: Select the Tabular Data Option ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image37.png))</span></span>

<span data-ttu-id="2c259-330">L’écran final de l’Assistant nous permet de spécifier les modèles d’accès aux données utilisés et les noms des méthodes qui en résultent.</span><span class="sxs-lookup"><span data-stu-id="2c259-330">The final wizard screen allows us to specify the data access patterns used and the names of the resulting methods.</span></span> <span data-ttu-id="2c259-331">Laissez les cases cochées et nommez les méthodes `FillByDiscontinued` et `GetDiscontinuedProducts` .</span><span class="sxs-lookup"><span data-stu-id="2c259-331">Leave both checkboxes checked and name the methods `FillByDiscontinued` and `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="2c259-332">Cliquez sur Terminer pour terminer l'Assistant.</span><span class="sxs-lookup"><span data-stu-id="2c259-332">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="2c259-333">[![Nommez les méthodes FillByDiscontinued et GetDiscontinuedProducts](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image39.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-333">[![Name the Methods FillByDiscontinued and GetDiscontinuedProducts](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image39.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image38.png)</span></span>

<span data-ttu-id="2c259-334">**Figure 18**: nommer les méthodes `FillByDiscontinued` et `GetDiscontinuedProducts` ([Cliquer pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image40.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-334">**Figure 18**: Name the Methods `FillByDiscontinued` and `GetDiscontinuedProducts` ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image40.png))</span></span>

<span data-ttu-id="2c259-335">Répétez ces étapes pour créer des méthodes nommées `FillByPriceLessThan` et `GetProductsWithPriceLessThan` dans `ProductsTableAdapter` pour la `GetProductsWithPriceLessThan` procédure stockée managée.</span><span class="sxs-lookup"><span data-stu-id="2c259-335">Repeat these steps to create methods named `FillByPriceLessThan` and `GetProductsWithPriceLessThan` in the `ProductsTableAdapter` for the `GetProductsWithPriceLessThan` managed stored procedure.</span></span>

<span data-ttu-id="2c259-336">La figure 19 illustre une capture d’écran du concepteur de DataSet après l’ajout des méthodes au `ProductsTableAdapter` pour les `GetDiscontinuedProducts` `GetProductsWithPriceLessThan` procédures stockées managées et.</span><span class="sxs-lookup"><span data-stu-id="2c259-336">Figure 19 shows a screenshot of the DataSet Designer after adding the methods to the `ProductsTableAdapter` for the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures.</span></span>

<span data-ttu-id="2c259-337">[![ProductsTableAdapter comprend les nouvelles méthodes ajoutées à cette étape.](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image42.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-337">[![The ProductsTableAdapter Includes the New Methods Added in this Step](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image42.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image41.png)</span></span>

<span data-ttu-id="2c259-338">**Figure 19**: `ProductsTableAdapter` contient les nouvelles méthodes ajoutées à cette étape ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image43.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-338">**Figure 19**: The `ProductsTableAdapter` Includes the New Methods Added in this Step ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image43.png))</span></span>

## <a name="step-7-adding-corresponding-methods-to-the-business-logic-layer"></a><span data-ttu-id="2c259-339">Étape 7 : ajout de méthodes correspondantes à la couche de logique métier</span><span class="sxs-lookup"><span data-stu-id="2c259-339">Step 7: Adding Corresponding Methods to the Business Logic Layer</span></span>

<span data-ttu-id="2c259-340">Maintenant que nous avons mis à jour la couche d’accès aux données pour inclure des méthodes permettant d’appeler les procédures stockées managées ajoutées aux étapes 4 et 5, nous devons ajouter les méthodes correspondantes à la couche de logique métier.</span><span class="sxs-lookup"><span data-stu-id="2c259-340">Now that we have updated the Data Access Layer to include methods for calling the managed stored procedures added in Steps 4 and 5, we need to add corresponding methods to the Business Logic Layer.</span></span> <span data-ttu-id="2c259-341">Ajoutez les deux méthodes suivantes à la `ProductsBLLWithSprocs` classe :</span><span class="sxs-lookup"><span data-stu-id="2c259-341">Add the following two methods to the `ProductsBLLWithSprocs` class:</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample7.cs)]

<span data-ttu-id="2c259-342">Les deux méthodes appellent simplement la méthode DAL correspondante et retournent l' `ProductsDataTable` instance.</span><span class="sxs-lookup"><span data-stu-id="2c259-342">Both methods simply call the corresponding DAL method and return the `ProductsDataTable` instance.</span></span> <span data-ttu-id="2c259-343">Le `DataObjectMethodAttribute` balisage au-dessus de chaque méthode entraîne l’inclusion de ces méthodes dans la liste déroulante de l’onglet sélectionner de l’Assistant Configuration de la source de données ObjectDataSource s.</span><span class="sxs-lookup"><span data-stu-id="2c259-343">The `DataObjectMethodAttribute` markup above each method causes these methods to be included in the drop-down list in the SELECT tab of the ObjectDataSource s Configure Data Source wizard.</span></span>

## <a name="step-8-invoking-the-managed-stored-procedures-from-the-presentation-layer"></a><span data-ttu-id="2c259-344">Étape 8 : appel des procédures stockées managées à partir de la couche de présentation</span><span class="sxs-lookup"><span data-stu-id="2c259-344">Step 8: Invoking the Managed Stored Procedures from the Presentation Layer</span></span>

<span data-ttu-id="2c259-345">Avec la logique métier et les couches d’accès aux données augmentées pour inclure la prise en charge de l’appel de `GetDiscontinuedProducts` et des `GetProductsWithPriceLessThan` procédures stockées managées, nous pouvons maintenant afficher les résultats de ces procédures stockées dans une page ASP.net.</span><span class="sxs-lookup"><span data-stu-id="2c259-345">With the Business Logic and Data Access Layers augmented to include support for calling the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures, we can now display these stored procedures results through an ASP.NET page.</span></span>

<span data-ttu-id="2c259-346">Ouvrez la `ManagedFunctionsAndSprocs.aspx` page dans le `AdvancedDAL` dossier et, à partir de la boîte à outils, faites glisser un contrôle GridView sur le concepteur.</span><span class="sxs-lookup"><span data-stu-id="2c259-346">Open the `ManagedFunctionsAndSprocs.aspx` page in the `AdvancedDAL` folder and, from the Toolbox, drag a GridView onto the Designer.</span></span> <span data-ttu-id="2c259-347">Définissez la propriété GridView s `ID` sur `DiscontinuedProducts` et, à partir de sa balise active, liez-la à un nouvel ObjectDataSource nommé `DiscontinuedProductsDataSource` .</span><span class="sxs-lookup"><span data-stu-id="2c259-347">Set the GridView s `ID` property to `DiscontinuedProducts` and, from its smart tag, bind it to a new ObjectDataSource named `DiscontinuedProductsDataSource`.</span></span> <span data-ttu-id="2c259-348">Configurez le ObjectDataSource pour extraire ses données de la méthode de la `ProductsBLLWithSprocs` classe s `GetDiscontinuedProducts` .</span><span class="sxs-lookup"><span data-stu-id="2c259-348">Configure the ObjectDataSource to pull its data from the `ProductsBLLWithSprocs` class s `GetDiscontinuedProducts` method.</span></span>

<span data-ttu-id="2c259-349">[![Configurer ObjectDataSource pour utiliser la classe ProductsBLLWithSprocs](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image45.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-349">[![Configure the ObjectDataSource to Use the ProductsBLLWithSprocs Class](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image45.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image44.png)</span></span>

<span data-ttu-id="2c259-350">**Figure 20**: configurer ObjectDataSource pour utiliser la `ProductsBLLWithSprocs` classe ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image46.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-350">**Figure 20**: Configure the ObjectDataSource to Use the `ProductsBLLWithSprocs` Class ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image46.png))</span></span>

<span data-ttu-id="2c259-351">[![Choisissez la méthode GetDiscontinuedProducts dans la liste déroulante de l’onglet sélectionner.](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image48.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-351">[![Choose the GetDiscontinuedProducts Method from the Drop-Down List in the SELECT Tab](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image48.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image47.png)</span></span>

<span data-ttu-id="2c259-352">**Figure 21**: choisir la `GetDiscontinuedProducts` méthode dans la liste déroulante de l’onglet sélectionner ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image49.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-352">**Figure 21**: Choose the `GetDiscontinuedProducts` Method from the Drop-Down List in the SELECT Tab ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image49.png))</span></span>

<span data-ttu-id="2c259-353">Étant donné que cette grille sera utilisée pour afficher uniquement des informations sur les produits, définissez les listes déroulantes dans les onglets mettre à jour, insérer et supprimer sur (aucun), puis cliquez sur Terminer.</span><span class="sxs-lookup"><span data-stu-id="2c259-353">Since this grid will be used to just display product information, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and then click Finish.</span></span>

<span data-ttu-id="2c259-354">À la fin de l’Assistant, Visual Studio ajoute automatiquement un BoundField ou un CheckBoxField pour chaque champ de données dans le `ProductsDataTable` .</span><span class="sxs-lookup"><span data-stu-id="2c259-354">Upon completing the wizard, Visual Studio will automatically add a BoundField or CheckBoxField for each data field in the `ProductsDataTable`.</span></span> <span data-ttu-id="2c259-355">Prenez un moment pour supprimer tous ces champs à l’exception de `ProductName` et `Discontinued` , à ce stade, vos balises déclaratives GridView et ObjectDataSource doivent ressembler à ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="2c259-355">Take a moment to remove all of these fields except for `ProductName` and `Discontinued`, at which point your GridView and ObjectDataSource s declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample8.aspx)]

<span data-ttu-id="2c259-356">Prenez un moment pour afficher cette page par le biais d’un navigateur.</span><span class="sxs-lookup"><span data-stu-id="2c259-356">Take a moment to view this page through a browser.</span></span> <span data-ttu-id="2c259-357">Lorsque la page est visitée, ObjectDataSource appelle la `ProductsBLLWithSprocs` méthode de la classe s `GetDiscontinuedProducts` .</span><span class="sxs-lookup"><span data-stu-id="2c259-357">When the page is visited, the ObjectDataSource calls the `ProductsBLLWithSprocs` class s `GetDiscontinuedProducts` method.</span></span> <span data-ttu-id="2c259-358">Comme nous l’avons vu à l’étape 7, cette méthode appelle la `ProductsDataTable` méthode s de classe dal `GetDiscontinuedProducts` , qui appelle la `GetDiscontinuedProducts` procédure stockée.</span><span class="sxs-lookup"><span data-stu-id="2c259-358">As we saw in Step 7, this method calls down to the DAL s `ProductsDataTable` class s `GetDiscontinuedProducts` method, which invokes the `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="2c259-359">Cette procédure stockée est une procédure stockée gérée qui exécute le code que nous avons créé à l’étape 3, retournant les produits abandonnés.</span><span class="sxs-lookup"><span data-stu-id="2c259-359">This stored procedure is a managed stored procedure and executes the code we created in Step 3, returning the discontinued products.</span></span>

<span data-ttu-id="2c259-360">Les résultats retournés par la procédure stockée managée sont regroupés dans un `ProductsDataTable` par la couche DAL, puis retournés à la couche BLL, qui les retourne à la couche de présentation où ils sont liés au GridView et affichés.</span><span class="sxs-lookup"><span data-stu-id="2c259-360">The results returned by the managed stored procedure are packaged up into a `ProductsDataTable` by the DAL and then returned to the BLL, which then returns them to the Presentation Layer where they are bound to the GridView and displayed.</span></span> <span data-ttu-id="2c259-361">Comme prévu, la grille répertorie les produits qui ont été abandonnés.</span><span class="sxs-lookup"><span data-stu-id="2c259-361">As expected, the grid lists those products that have been discontinued.</span></span>

<span data-ttu-id="2c259-362">[![Les produits abandonnés sont répertoriés](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image51.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-362">[![The Discontinued Products are Listed](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image51.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image50.png)</span></span>

<span data-ttu-id="2c259-363">**Figure 22**: les produits abandonnés sont répertoriés ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image52.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-363">**Figure 22**: The Discontinued Products are Listed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image52.png))</span></span>

<span data-ttu-id="2c259-364">Pour une meilleure pratique, ajoutez une zone de texte et un autre GridView à la page.</span><span class="sxs-lookup"><span data-stu-id="2c259-364">For further practice, add a TextBox and another GridView to the page.</span></span> <span data-ttu-id="2c259-365">Faire en sorte que ce GridView affiche les produits inférieurs à la quantité entrée dans la zone de texte en appelant la méthode de la `ProductsBLLWithSprocs` classe s `GetProductsWithPriceLessThan` .</span><span class="sxs-lookup"><span data-stu-id="2c259-365">Have this GridView display the products less than the amount entered into the TextBox by calling the `ProductsBLLWithSprocs` class s `GetProductsWithPriceLessThan` method.</span></span>

## <a name="step-9-creating-and-calling-t-sql-udfs"></a><span data-ttu-id="2c259-366">Étape 9 : création et appel des fonctions définies par l’utilisateur T-SQL</span><span class="sxs-lookup"><span data-stu-id="2c259-366">Step 9: Creating and Calling T-SQL UDFs</span></span>

<span data-ttu-id="2c259-367">Les fonctions définies par l’utilisateur, ou UDF, sont des objets de base de données qui reproduisent fidèlement la sémantique des fonctions dans les langages de programmation.</span><span class="sxs-lookup"><span data-stu-id="2c259-367">User-Defined Functions, or UDFs, are database objects the closely mimic the semantics of functions in programming languages.</span></span> <span data-ttu-id="2c259-368">À l’instar d’une fonction en C#, les fonctions définies par l’utilisateur peuvent inclure un nombre variable de paramètres d’entrée et retourner une valeur d’un type particulier.</span><span class="sxs-lookup"><span data-stu-id="2c259-368">Like a function in C#, UDFs can include a variable number of input parameters and return a value of a particular type.</span></span> <span data-ttu-id="2c259-369">Une fonction définie par l’attaquant peut retourner des données scalaires (une chaîne, un entier, etc.) ou des données tabulaires.</span><span class="sxs-lookup"><span data-stu-id="2c259-369">A UDF can return either scalar data - a string, an integer, and so forth - or tabular data.</span></span> <span data-ttu-id="2c259-370">Voyons rapidement les deux types de fonctions définies par l’utilisateur, à partir d’une FDU qui retourne un type de données scalaire.</span><span class="sxs-lookup"><span data-stu-id="2c259-370">Let s take a quick look at both types of UDFs, starting with a UDF that returns a scalar data type.</span></span>

<span data-ttu-id="2c259-371">La FDU suivante calcule la valeur estimée de l’inventaire pour un produit particulier.</span><span class="sxs-lookup"><span data-stu-id="2c259-371">The following UDF calculates the estimated value of the inventory for a particular product.</span></span> <span data-ttu-id="2c259-372">Pour ce faire, il utilise trois paramètres d’entrée ( `UnitPrice` les `UnitsInStock` valeurs, et `Discontinued` pour un produit particulier) et retourne une valeur de type `money` .</span><span class="sxs-lookup"><span data-stu-id="2c259-372">It does so by taking in three input parameters - the `UnitPrice`, `UnitsInStock`, and `Discontinued` values for a particular product - and returns a value of type `money`.</span></span> <span data-ttu-id="2c259-373">Il calcule la valeur estimée de l’inventaire en multipliant le `UnitPrice` par `UnitsInStock` .</span><span class="sxs-lookup"><span data-stu-id="2c259-373">It computes the estimated value of the inventory by multiplying the `UnitPrice` by the `UnitsInStock`.</span></span> <span data-ttu-id="2c259-374">Pour les éléments abandonnés, cette valeur est divisée par deux.</span><span class="sxs-lookup"><span data-stu-id="2c259-374">For discontinued items, this value is halved.</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample9.sql)]

<span data-ttu-id="2c259-375">Une fois cette FDU ajoutée à la base de données, elle peut être trouvée via Management Studio en développant le dossier programmabilité, les fonctions, puis les fonctions scalaires.</span><span class="sxs-lookup"><span data-stu-id="2c259-375">Once this UDF has been added to the database, it can be found through Management Studio by expanding the Programmability folder, then Functions, and then Scalar-value Functions.</span></span> <span data-ttu-id="2c259-376">Il peut être utilisé dans une requête telle que celle-ci `SELECT` :</span><span class="sxs-lookup"><span data-stu-id="2c259-376">It can be used in a `SELECT` query like so:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample10.sql)]

<span data-ttu-id="2c259-377">J’ai ajouté la `udf_ComputeInventoryValue` FDU à la base de données Northwind. La figure 23 illustre la sortie de la requête ci-dessus lorsqu’elle est `SELECT` consultée par Management Studio.</span><span class="sxs-lookup"><span data-stu-id="2c259-377">I have added the `udf_ComputeInventoryValue` UDF to the Northwind database; Figure 23 shows the output of the above `SELECT` query when viewed through Management Studio.</span></span> <span data-ttu-id="2c259-378">Notez également que la FDU est listée sous le dossier scalaire-value Functions dans l’Explorateur d’objets.</span><span class="sxs-lookup"><span data-stu-id="2c259-378">Also note that the UDF is listed under the Scalar-value Functions folder in the Object Explorer.</span></span>

<span data-ttu-id="2c259-379">[![Chaque valeur d’inventaire des produits est indiquée](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image54.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-379">[![Each Product s Inventory Values is Listed](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image54.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image53.png)</span></span>

<span data-ttu-id="2c259-380">**Figure 23**: les valeurs d’inventaire de chaque produit sont listées ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image55.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-380">**Figure 23**: Each Product s Inventory Values is Listed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image55.png))</span></span>

<span data-ttu-id="2c259-381">Les fonctions définies par l’utilisateur peuvent également retourner des données tabulaires.</span><span class="sxs-lookup"><span data-stu-id="2c259-381">UDFs can also return tabular data.</span></span> <span data-ttu-id="2c259-382">Par exemple, nous pouvons créer une fonction UDF qui retourne des produits appartenant à une catégorie particulière :</span><span class="sxs-lookup"><span data-stu-id="2c259-382">For example, we can create a UDF that returns products that belong to a particular category:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample11.sql)]

<span data-ttu-id="2c259-383">La fonction `udf_GetProductsByCategoryID` UDF accepte un `@CategoryID` paramètre d’entrée et retourne les résultats de la `SELECT` requête spécifiée.</span><span class="sxs-lookup"><span data-stu-id="2c259-383">The `udf_GetProductsByCategoryID` UDF accepts a `@CategoryID` input parameter and returns the results of the specified `SELECT` query.</span></span> <span data-ttu-id="2c259-384">Une fois créé, cette FDU peut être référencée dans la `FROM` clause (ou `JOIN` ) d’une `SELECT` requête.</span><span class="sxs-lookup"><span data-stu-id="2c259-384">Once created, this UDF can be referenced in the `FROM` (or `JOIN`) clause of a `SELECT` query.</span></span> <span data-ttu-id="2c259-385">L’exemple suivant retourne les `ProductID` valeurs, `ProductName` et `CategoryID` pour chacune des boissons.</span><span class="sxs-lookup"><span data-stu-id="2c259-385">The following example would return the `ProductID`, `ProductName`, and `CategoryID` values for each of the beverages.</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample12.sql)]

<span data-ttu-id="2c259-386">J’ai ajouté la `udf_GetProductsByCategoryID` FDU à la base de données Northwind. La figure 24 illustre la sortie de la requête ci-dessus lorsqu’elle est `SELECT` consultée par Management Studio.</span><span class="sxs-lookup"><span data-stu-id="2c259-386">I have added the `udf_GetProductsByCategoryID` UDF to the Northwind database; Figure 24 shows the output of the above `SELECT` query when viewed through Management Studio.</span></span> <span data-ttu-id="2c259-387">Les fonctions définies par l’utilisateur qui retournent des données tabulaires se trouvent dans le dossier de l’Explorateur d’objets.</span><span class="sxs-lookup"><span data-stu-id="2c259-387">UDFs that return tabular data can be found in the Object Explorer s Table-value Functions folder.</span></span>

<span data-ttu-id="2c259-388">[![ProductID, ProductName et CategoryID sont répertoriés pour chaque boisson](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image57.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-388">[![The ProductID, ProductName, and CategoryID are Listed for Each Beverage](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image57.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image56.png)</span></span>

<span data-ttu-id="2c259-389">**Figure 24**: les `ProductID` , `ProductName` et `CategoryID` sont répertoriés pour chaque boisson ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image58.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-389">**Figure 24**: The `ProductID`, `ProductName`, and `CategoryID` are Listed for Each Beverage ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image58.png))</span></span>

> [!NOTE]
> <span data-ttu-id="2c259-390">Pour plus d’informations sur la création et l’utilisation des [fonctions définies par l’utilisateur, consultez Introduction aux fonctions définies par l’utilisateur](http://www.sqlteam.com/item.asp?ItemID=1955).</span><span class="sxs-lookup"><span data-stu-id="2c259-390">For more information on creating and using UDFs, check out [Intro to User-Defined Functions](http://www.sqlteam.com/item.asp?ItemID=1955).</span></span> <span data-ttu-id="2c259-391">Découvrez également les [avantages et les inconvénients des fonctions définies par l’utilisateur](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1).</span><span class="sxs-lookup"><span data-stu-id="2c259-391">Also check out [Advantages and Drawbacks of User-Defined Functions](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1).</span></span>

## <a name="step-10-creating-a-managed-udf"></a><span data-ttu-id="2c259-392">Étape 10 : création d’une FDU managée</span><span class="sxs-lookup"><span data-stu-id="2c259-392">Step 10: Creating a Managed UDF</span></span>

<span data-ttu-id="2c259-393">Les `udf_ComputeInventoryValue` fonctions définies par l’utilisateur et les `udf_GetProductsByCategoryID` UDF créées dans les exemples ci-dessus sont des objets de base de données T-SQL.</span><span class="sxs-lookup"><span data-stu-id="2c259-393">The `udf_ComputeInventoryValue` and `udf_GetProductsByCategoryID` UDFs created in the above examples are T-SQL database objects.</span></span> <span data-ttu-id="2c259-394">SQL Server 2005 prend également en charge les fonctions définies par l’utilisateur managées, qui peuvent être ajoutées au `ManagedDatabaseConstructs` projet comme les procédures stockées managées des étapes 3 et 5.</span><span class="sxs-lookup"><span data-stu-id="2c259-394">SQL Server 2005 also supports managed UDFs, which can be added to the `ManagedDatabaseConstructs` project just like the managed stored procedures from Steps 3 and 5.</span></span> <span data-ttu-id="2c259-395">Pour cette étape, nous allons implémenter la fonction `udf_ComputeInventoryValue` définie par l’application dans du code managé.</span><span class="sxs-lookup"><span data-stu-id="2c259-395">For this step, let s implement the `udf_ComputeInventoryValue` UDF in managed code.</span></span>

<span data-ttu-id="2c259-396">Pour ajouter une FDU managée au `ManagedDatabaseConstructs` projet, cliquez avec le bouton droit sur le nom du projet dans Explorateur de solutions et choisissez d’ajouter un nouvel élément.</span><span class="sxs-lookup"><span data-stu-id="2c259-396">To add a managed UDF to the `ManagedDatabaseConstructs` project, right-click on the project name in Solution Explorer and choose to Add a New Item.</span></span> <span data-ttu-id="2c259-397">Sélectionnez le modèle défini par l’utilisateur dans la boîte de dialogue Ajouter un nouvel élément et nommez le nouveau fichier UDF `udf_ComputeInventoryValue_Managed.cs` .</span><span class="sxs-lookup"><span data-stu-id="2c259-397">Select the User-Defined Template from the Add New Item dialog box and name the new UDF file `udf_ComputeInventoryValue_Managed.cs`.</span></span>

<span data-ttu-id="2c259-398">[![Ajouter une nouvelle FDU managée au projet ManagedDatabaseConstructs](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image60.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image59.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-398">[![Add a New Managed UDF to the ManagedDatabaseConstructs Project](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image60.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image59.png)</span></span>

<span data-ttu-id="2c259-399">**Figure 25**: ajouter une nouvelle FDU managée au `ManagedDatabaseConstructs` projet ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image61.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-399">**Figure 25**: Add a New Managed UDF to the `ManagedDatabaseConstructs` Project ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image61.png))</span></span>

<span data-ttu-id="2c259-400">Le modèle de fonction définie par l’utilisateur crée une `partial` classe nommée `UserDefinedFunctions` avec une méthode dont le nom est le même que le nom du fichier de classe s ( `udf_ComputeInventoryValue_Managed` , dans cette instance).</span><span class="sxs-lookup"><span data-stu-id="2c259-400">The User-Defined Function template creates a `partial` class named `UserDefinedFunctions` with a method whose name is the same as the class file s name (`udf_ComputeInventoryValue_Managed`, in this instance).</span></span> <span data-ttu-id="2c259-401">Cette méthode est décorée à l’aide de l' [ `SqlFunction` attribut](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlfunctionattribute.aspx), qui marque la méthode comme une fonction UDF managée.</span><span class="sxs-lookup"><span data-stu-id="2c259-401">This method is decorated using the [`SqlFunction` attribute](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlfunctionattribute.aspx), which flags the method as a managed UDF.</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample13.cs)]

<span data-ttu-id="2c259-402">La `udf_ComputeInventoryValue` méthode retourne actuellement un [ `SqlString` objet](https://msdn.microsoft.com/library/system.data.sqltypes.sqlstring.aspx) et n’accepte aucun paramètre d’entrée.</span><span class="sxs-lookup"><span data-stu-id="2c259-402">The `udf_ComputeInventoryValue` method currently returns a [`SqlString` object](https://msdn.microsoft.com/library/system.data.sqltypes.sqlstring.aspx) and does not accept any input parameters.</span></span> <span data-ttu-id="2c259-403">Nous devons mettre à jour la définition de la méthode afin qu’elle accepte trois paramètres d’entrée : `UnitPrice` , `UnitsInStock` et `Discontinued` -et retourne un `SqlMoney` objet.</span><span class="sxs-lookup"><span data-stu-id="2c259-403">We need to update the method definition so that it accepts three input parameters - `UnitPrice`, `UnitsInStock`, and `Discontinued` - and returns a `SqlMoney` object.</span></span> <span data-ttu-id="2c259-404">La logique de calcul de la valeur d’inventaire est identique à celle de la FDU T-SQL `udf_ComputeInventoryValue` .</span><span class="sxs-lookup"><span data-stu-id="2c259-404">The logic for calculating the inventory value is identical to that in the T-SQL `udf_ComputeInventoryValue` UDF.</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample14.cs)]

<span data-ttu-id="2c259-405">Notez que les paramètres d’entrée de la méthode UDF sont de leurs types SQL correspondants : `SqlMoney` pour le `UnitPrice` champ, [`SqlInt16`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlint16.aspx) pour `UnitsInStock` et [`SqlBoolean`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlboolean.aspx) pour `Discontinued` .</span><span class="sxs-lookup"><span data-stu-id="2c259-405">Note that the UDF method s input parameters are of their corresponding SQL types: `SqlMoney` for the `UnitPrice` field, [`SqlInt16`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlint16.aspx) for `UnitsInStock`, and [`SqlBoolean`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlboolean.aspx) for `Discontinued`.</span></span> <span data-ttu-id="2c259-406">Ces types de données reflètent les types définis dans la `Products` table : la `UnitPrice` colonne est de type `money` , la `UnitsInStock` colonne de type `smallint` et la `Discontinued` colonne de type `bit` .</span><span class="sxs-lookup"><span data-stu-id="2c259-406">These data types reflect the types defined in the `Products` table: the `UnitPrice` column is of type `money`, the `UnitsInStock` column of type `smallint`, and the `Discontinued` column of type `bit`.</span></span>

<span data-ttu-id="2c259-407">Le code commence par créer une `SqlMoney` instance nommée `inventoryValue` qui est assignée à la valeur 0.</span><span class="sxs-lookup"><span data-stu-id="2c259-407">The code starts by creating a `SqlMoney` instance named `inventoryValue` that is assigned a value of 0.</span></span> <span data-ttu-id="2c259-408">La `Products` table autorise les valeurs de base de données `NULL` dans les `UnitsInPrice` `UnitsInStock` colonnes et.</span><span class="sxs-lookup"><span data-stu-id="2c259-408">The `Products` table allows for database `NULL` values in the `UnitsInPrice` and `UnitsInStock` columns.</span></span> <span data-ttu-id="2c259-409">Par conséquent, nous devons d’abord vérifier si ces valeurs contiennent des `NULL` s, que nous faisons par le biais de la `SqlMoney` [ `IsNull` propriété](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.isnull.aspx)Object s.</span><span class="sxs-lookup"><span data-stu-id="2c259-409">Therefore, we need to first check to see if these values contain `NULL` s, which we do through the `SqlMoney` object s [`IsNull` property](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.isnull.aspx).</span></span> <span data-ttu-id="2c259-410">Si et contiennent tous deux des `UnitPrice` `UnitsInStock` valeurs non- `NULL` , nous calculons le `inventoryValue` pour qu’il soit le produit des deux.</span><span class="sxs-lookup"><span data-stu-id="2c259-410">If both `UnitPrice` and `UnitsInStock` contain non-`NULL` values, then we compute the `inventoryValue` to be the product of the two.</span></span> <span data-ttu-id="2c259-411">Ensuite, si `Discontinued` a la valeur true, nous allons diviser la valeur.</span><span class="sxs-lookup"><span data-stu-id="2c259-411">Then, if `Discontinued` is true, then we halve the value.</span></span>

> [!NOTE]
> <span data-ttu-id="2c259-412">L' `SqlMoney` objet autorise la `SqlMoney` multiplication de deux instances ensemble.</span><span class="sxs-lookup"><span data-stu-id="2c259-412">The `SqlMoney` object only allows two `SqlMoney` instances to be multiplied together.</span></span> <span data-ttu-id="2c259-413">Elle n’autorise pas la `SqlMoney` multiplication d’une instance par un nombre à virgule flottante littéral.</span><span class="sxs-lookup"><span data-stu-id="2c259-413">It does not allow a `SqlMoney` instance to be multiplied by a literal floating-point number.</span></span> <span data-ttu-id="2c259-414">Par conséquent, `inventoryValue` nous la multiplions par une nouvelle `SqlMoney` instance qui a la valeur 0,5.</span><span class="sxs-lookup"><span data-stu-id="2c259-414">Therefore, to halve `inventoryValue` we multiply it by a new `SqlMoney` instance that has the value 0.5.</span></span>

## <a name="step-11-deploying-the-managed-udf"></a><span data-ttu-id="2c259-415">Étape 11 : déploiement de la FDU managée</span><span class="sxs-lookup"><span data-stu-id="2c259-415">Step 11: Deploying the Managed UDF</span></span>

<span data-ttu-id="2c259-416">Maintenant que la fonction UDF managée a été créée, nous sommes prêts à la déployer dans la base de données Northwind.</span><span class="sxs-lookup"><span data-stu-id="2c259-416">Now that the managed UDF has been created, we are ready to deploy it to the Northwind database.</span></span> <span data-ttu-id="2c259-417">Comme nous l’avons vu à l’étape 4, les objets gérés d’un SQL Server projet sont déployés en cliquant avec le bouton droit sur le nom du projet dans la Explorateur de solutions et en choisissant l’option déployer dans le menu contextuel.</span><span class="sxs-lookup"><span data-stu-id="2c259-417">As we saw in Step 4, the managed objects in a SQL Server Project are deployed by right-clicking on the project name in the Solution Explorer and choosing the Deploy option from the context menu.</span></span>

<span data-ttu-id="2c259-418">Une fois que vous avez déployé le projet, revenez à SQL Server Management Studio et actualisez le dossier des fonctions à valeurs scalaires.</span><span class="sxs-lookup"><span data-stu-id="2c259-418">Once you have deployed the project, return to SQL Server Management Studio and refresh the Scalar-valued Functions folder.</span></span> <span data-ttu-id="2c259-419">Vous devez maintenant voir deux entrées :</span><span class="sxs-lookup"><span data-stu-id="2c259-419">You should now see two entries:</span></span>

- <span data-ttu-id="2c259-420">`dbo.udf_ComputeInventoryValue` -le fichier UDF T-SQL créé à l’étape 9, et</span><span class="sxs-lookup"><span data-stu-id="2c259-420">`dbo.udf_ComputeInventoryValue` - the T-SQL UDF created in Step 9, and</span></span>
- <span data-ttu-id="2c259-421">`dbo.udf ComputeInventoryValue_Managed` -la FDU managée créée à l’étape 10 qui vient d’être déployée.</span><span class="sxs-lookup"><span data-stu-id="2c259-421">`dbo.udf ComputeInventoryValue_Managed` - the managed UDF created in Step 10 that was just deployed.</span></span>

<span data-ttu-id="2c259-422">Pour tester cette FDU managée, exécutez la requête suivante à partir de Management Studio :</span><span class="sxs-lookup"><span data-stu-id="2c259-422">To test this managed UDF, execute the following query from within Management Studio:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample15.sql)]

<span data-ttu-id="2c259-423">Cette commande utilise la fonction `udf ComputeInventoryValue_Managed` UDF managée au lieu de la fonction définie par l’exception T-SQL `udf_ComputeInventoryValue` , mais la sortie est la même.</span><span class="sxs-lookup"><span data-stu-id="2c259-423">This command uses the managed `udf ComputeInventoryValue_Managed` UDF instead of the T-SQL `udf_ComputeInventoryValue` UDF, but the output is the same.</span></span> <span data-ttu-id="2c259-424">Reportez-vous à la figure 23 pour afficher une capture d’écran de la sortie UDF s.</span><span class="sxs-lookup"><span data-stu-id="2c259-424">Refer back to Figure 23 to see a screenshot of the UDF s output.</span></span>

## <a name="step-12-debugging-the-managed-database-objects"></a><span data-ttu-id="2c259-425">Étape 12 : débogage des objets de base de données managés</span><span class="sxs-lookup"><span data-stu-id="2c259-425">Step 12: Debugging the Managed Database Objects</span></span>

<span data-ttu-id="2c259-426">Dans le didacticiel [débogage des procédures stockées](debugging-stored-procedures-cs.md) , nous avons abordé les trois options de débogage SQL Server par le biais de Visual Studio : débogage de base de données direct, débogage d’application et débogage à partir d’un projet SQL Server.</span><span class="sxs-lookup"><span data-stu-id="2c259-426">In the [Debugging Stored Procedures](debugging-stored-procedures-cs.md) tutorial we discussed the three options for debugging SQL Server through Visual Studio: Direct Database Debugging, Application Debugging, and Debugging from a SQL Server Project.</span></span> <span data-ttu-id="2c259-427">Les objets de base de données managés ne peuvent pas être débogués via le débogage de base de données direct, mais peuvent être débogués à partir d’une application cliente et directement à partir du projet SQL Server.</span><span class="sxs-lookup"><span data-stu-id="2c259-427">Managed database objects cannot be debugged via Direct Database Debugging, but can be debugged from a client application and directly from the SQL Server Project.</span></span> <span data-ttu-id="2c259-428">Toutefois, pour que le débogage fonctionne, la base de données SQL Server 2005 doit autoriser le débogage SQL/CLR.</span><span class="sxs-lookup"><span data-stu-id="2c259-428">In order for debugging to work, however, the SQL Server 2005 database must allow SQL/CLR debugging.</span></span> <span data-ttu-id="2c259-429">Rappelez-vous que lorsque nous avons créé le `ManagedDatabaseConstructs` projet, Visual Studio nous a demandé si nous voulions activer le débogage SQL/CLR (voir la figure 6 à l’étape 2).</span><span class="sxs-lookup"><span data-stu-id="2c259-429">Recall that when we first created the `ManagedDatabaseConstructs` project Visual Studio asked us whether we wanted to enable SQL/CLR debugging (see Figure 6 in Step 2).</span></span> <span data-ttu-id="2c259-430">Ce paramètre peut être modifié en cliquant avec le bouton droit sur la base de données à partir de la fenêtre Explorateur de serveurs.</span><span class="sxs-lookup"><span data-stu-id="2c259-430">This setting can be modified by right-clicking on the database from the Server Explorer window.</span></span>

![Vérifier que la base de données autorise le débogage SQL/CLR](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image62.png)

<span data-ttu-id="2c259-432">**Figure 26**: vérifier que la base de données autorise le débogage SQL/CLR</span><span class="sxs-lookup"><span data-stu-id="2c259-432">**Figure 26**: Ensure that the Database Allows SQL/CLR Debugging</span></span>

<span data-ttu-id="2c259-433">Imaginez que nous voulions déboguer la `GetProductsWithPriceLessThan` procédure stockée managée.</span><span class="sxs-lookup"><span data-stu-id="2c259-433">Imagine that we wanted to debug the `GetProductsWithPriceLessThan` managed stored procedure.</span></span> <span data-ttu-id="2c259-434">Nous commençons par définir un point d’arrêt dans le code de la `GetProductsWithPriceLessThan` méthode.</span><span class="sxs-lookup"><span data-stu-id="2c259-434">We would start by setting a breakpoint within the code of the `GetProductsWithPriceLessThan` method.</span></span>

<span data-ttu-id="2c259-435">[![Définir un point d’arrêt dans la méthode GetProductsWithPriceLessThan](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image64.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image63.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-435">[![Set a Breakpoint in the GetProductsWithPriceLessThan Method](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image64.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image63.png)</span></span>

<span data-ttu-id="2c259-436">**Figure 27**: définir un point d’arrêt dans la `GetProductsWithPriceLessThan` méthode ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image65.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-436">**Figure 27**: Set a Breakpoint in the `GetProductsWithPriceLessThan` Method ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image65.png))</span></span>

<span data-ttu-id="2c259-437">Commençons par examiner le débogage des objets de base de données managés à partir du projet SQL Server.</span><span class="sxs-lookup"><span data-stu-id="2c259-437">Let s first look at debugging the managed database objects from the SQL Server Project.</span></span> <span data-ttu-id="2c259-438">Dans la mesure où notre solution comprend deux projets : le `ManagedDatabaseConstructs` projet SQL Server et notre site Web, afin de déboguer à partir du projet SQL Server, nous devons indiquer à Visual Studio de lancer le `ManagedDatabaseConstructs` projet SQL Server lorsque nous commençons le débogage.</span><span class="sxs-lookup"><span data-stu-id="2c259-438">Since our Solution includes two projects - the `ManagedDatabaseConstructs` SQL Server Project along with our website - in order to debug from the SQL Server Project we need to instruct Visual Studio to launch the `ManagedDatabaseConstructs` SQL Server Project when we start debugging.</span></span> <span data-ttu-id="2c259-439">Dans Explorateur de solutions, cliquez avec le bouton droit sur le `ManagedDatabaseConstructs` projet et choisissez l’option définir comme projet de démarrage dans le menu contextuel.</span><span class="sxs-lookup"><span data-stu-id="2c259-439">Right-click the `ManagedDatabaseConstructs` project in Solution Explorer and choose the Set as StartUp Project option from the context menu.</span></span>

<span data-ttu-id="2c259-440">Lorsque le `ManagedDatabaseConstructs` projet est lancé à partir du débogueur, il exécute les instructions SQL dans le `Test.sql` fichier, qui se trouve dans le `Test Scripts` dossier.</span><span class="sxs-lookup"><span data-stu-id="2c259-440">When the `ManagedDatabaseConstructs` project is launched from the debugger it executes the SQL statements in the `Test.sql` file, which is located in the `Test Scripts` folder.</span></span> <span data-ttu-id="2c259-441">Par exemple, pour tester la `GetProductsWithPriceLessThan` procédure stockée managée, remplacez le `Test.sql` contenu du fichier existant par l’instruction suivante, qui appelle la `GetProductsWithPriceLessThan` procédure stockée managée en passant la `@CategoryID` valeur 14,95 :</span><span class="sxs-lookup"><span data-stu-id="2c259-441">For example, to test the `GetProductsWithPriceLessThan` managed stored procedure, replace the existing `Test.sql` file content with the following statement, which invokes the `GetProductsWithPriceLessThan` managed stored procedure passing in the `@CategoryID` value of 14.95:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample16.sql)]

<span data-ttu-id="2c259-442">Une fois que vous avez entré le script ci-dessus dans `Test.sql` , commencez le débogage en accédant au menu Déboguer et en choisissant Démarrer le débogage ou en appuyant sur F5 ou en cliquant sur l’icône de lecture verte dans la barre d’outils.</span><span class="sxs-lookup"><span data-stu-id="2c259-442">Once you ve entered the above script into `Test.sql`, start debugging by going to the Debug menu and choosing Start Debugging or by hitting F5 or the green play icon in the Toolbar.</span></span> <span data-ttu-id="2c259-443">Cela génère les projets dans la solution, déploie les objets de base de données managés dans la base de données Northwind, puis exécute le `Test.sql` script.</span><span class="sxs-lookup"><span data-stu-id="2c259-443">This will build the projects within the Solution, deploy the managed database objects to the Northwind database, and then execute the `Test.sql` script.</span></span> <span data-ttu-id="2c259-444">À ce stade, le point d’arrêt est atteint et nous pouvons parcourir la `GetProductsWithPriceLessThan` méthode, examiner les valeurs des paramètres d’entrée, et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="2c259-444">At this point, the breakpoint will be hit and we can step through the `GetProductsWithPriceLessThan` method, examine the values of the input parameters, and so on.</span></span>

<span data-ttu-id="2c259-445">[![Le point d’arrêt dans la méthode GetProductsWithPriceLessThan a été atteint](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image67.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image66.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-445">[![The Breakpoint in the GetProductsWithPriceLessThan Method Was Hit](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image67.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image66.png)</span></span>

<span data-ttu-id="2c259-446">**Figure 28**: le point d’arrêt dans la `GetProductsWithPriceLessThan` méthode a été atteint ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image68.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-446">**Figure 28**: The Breakpoint in the `GetProductsWithPriceLessThan` Method Was Hit ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image68.png))</span></span>

<span data-ttu-id="2c259-447">Pour qu’un objet SQL Database soit débogué par le biais d’une application cliente, il est impératif que la base de données soit configurée pour prendre en charge le débogage d’application.</span><span class="sxs-lookup"><span data-stu-id="2c259-447">In order for a SQL database object to be debugged through a client application, it is imperative that the database be configured to support application debugging.</span></span> <span data-ttu-id="2c259-448">Dans Explorateur de serveurs, cliquez avec le bouton droit sur la base de données et assurez-vous que l’option débogage de l’application est cochée.</span><span class="sxs-lookup"><span data-stu-id="2c259-448">Right-click on the database in Server Explorer and ensure that the Application Debugging option is checked.</span></span> <span data-ttu-id="2c259-449">En outre, nous devons configurer l’application ASP.NET pour qu’elle s’intègre au débogueur SQL et désactiver le regroupement de connexions.</span><span class="sxs-lookup"><span data-stu-id="2c259-449">Furthermore, we need to configure the ASP.NET application to integrate with the SQL Debugger and to disable connection pooling.</span></span> <span data-ttu-id="2c259-450">Ces étapes ont été abordées en détail à l’étape 2 du didacticiel [débogage des procédures stockées](debugging-stored-procedures-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="2c259-450">These steps were discussed in detail in Step 2 of the [Debugging Stored Procedures](debugging-stored-procedures-cs.md) tutorial.</span></span>

<span data-ttu-id="2c259-451">Une fois que vous avez configuré l’application et la base de données ASP.NET, définissez le site Web ASP.NET comme projet de démarrage et démarrez le débogage.</span><span class="sxs-lookup"><span data-stu-id="2c259-451">Once you have configured the ASP.NET application and database, set the ASP.NET website as the startup project and start debugging.</span></span> <span data-ttu-id="2c259-452">Si vous visitez une page qui appelle l’un des objets managés qui a un point d’arrêt, l’application s’arrêtera et le contrôle sera basculé vers le débogueur, où vous pouvez parcourir le code, comme illustré dans la figure 28.</span><span class="sxs-lookup"><span data-stu-id="2c259-452">If you visit a page that calls one of the managed objects that has a breakpoint, the application will halt and control will be turned over to the debugger, where you can step through the code as shown in Figure 28.</span></span>

## <a name="step-13-manually-compiling-and-deploying-managed-database-objects"></a><span data-ttu-id="2c259-453">Étape 13 : compilation et déploiement manuels des objets de base de données managés</span><span class="sxs-lookup"><span data-stu-id="2c259-453">Step 13: Manually Compiling and Deploying Managed Database Objects</span></span>

<span data-ttu-id="2c259-454">Les projets SQL Server facilitent la création, la compilation et le déploiement d’objets de base de données managés.</span><span class="sxs-lookup"><span data-stu-id="2c259-454">SQL Server Projects make it easy to create, compile, and deploy managed database objects.</span></span> <span data-ttu-id="2c259-455">Malheureusement, les projets SQL Server ne sont disponibles que dans les éditions Professional et Team Systems de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="2c259-455">Unfortunately, SQL Server Projects are only available in the Professional and Team Systems editions of Visual Studio.</span></span> <span data-ttu-id="2c259-456">Si vous utilisez Visual Web Developer ou l’édition standard de Visual Studio et souhaitez utiliser des objets de base de données managés, vous devez les créer et les déployer manuellement.</span><span class="sxs-lookup"><span data-stu-id="2c259-456">If you are using Visual Web Developer or the Standard Edition of Visual Studio and want to use managed database objects, you will need to manually create and deploy them.</span></span> <span data-ttu-id="2c259-457">Cela implique quatre étapes :</span><span class="sxs-lookup"><span data-stu-id="2c259-457">This involves four steps:</span></span>

1. <span data-ttu-id="2c259-458">Créez un fichier qui contient le code source de l’objet de base de données managé,</span><span class="sxs-lookup"><span data-stu-id="2c259-458">Create a file that contains the source code for the managed database object,</span></span>
2. <span data-ttu-id="2c259-459">Compilez l’objet dans un assembly,</span><span class="sxs-lookup"><span data-stu-id="2c259-459">Compile the object into an assembly,</span></span>
3. <span data-ttu-id="2c259-460">Enregistrez l’assembly avec la base de données SQL Server 2005 et</span><span class="sxs-lookup"><span data-stu-id="2c259-460">Register the assembly with the SQL Server 2005 database, and</span></span>
4. <span data-ttu-id="2c259-461">Créez un objet de base de données dans SQL Server qui pointe vers la méthode appropriée dans l’assembly.</span><span class="sxs-lookup"><span data-stu-id="2c259-461">Create a database object in SQL Server that points to the appropriate method in the assembly.</span></span>

<span data-ttu-id="2c259-462">Pour illustrer ces tâches, créons une nouvelle procédure stockée managée qui retourne les produits dont `UnitPrice` la valeur est supérieure à une valeur spécifiée.</span><span class="sxs-lookup"><span data-stu-id="2c259-462">To illustrate these tasks, let s create a new managed stored procedure that returns those products whose `UnitPrice` is greater than a specified value.</span></span> <span data-ttu-id="2c259-463">Créez un fichier sur votre ordinateur nommé `GetProductsWithPriceGreaterThan.cs` et entrez le code suivant dans le fichier (vous pouvez utiliser Visual Studio, le bloc-notes ou n’importe quel éditeur de texte pour y parvenir) :</span><span class="sxs-lookup"><span data-stu-id="2c259-463">Create a new file on your computer named `GetProductsWithPriceGreaterThan.cs` and enter the following code into the file (you can use Visual Studio, Notepad, or any text editor to accomplish this):</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample17.cs)]

<span data-ttu-id="2c259-464">Ce code est quasiment identique à celui de la `GetProductsWithPriceLessThan` méthode créée à l’étape 5.</span><span class="sxs-lookup"><span data-stu-id="2c259-464">This code is nearly identical to that of the `GetProductsWithPriceLessThan` method created in Step 5.</span></span> <span data-ttu-id="2c259-465">Les seules différences sont les noms des méthodes, la `WHERE` clause et le nom du paramètre utilisé dans la requête.</span><span class="sxs-lookup"><span data-stu-id="2c259-465">The only differences are the method names, the `WHERE` clause, and the parameter name used in the query.</span></span> <span data-ttu-id="2c259-466">De retour dans la `GetProductsWithPriceLessThan` méthode, la `WHERE` clause Read : `WHERE UnitPrice < @MaxPrice` .</span><span class="sxs-lookup"><span data-stu-id="2c259-466">Back in the `GetProductsWithPriceLessThan` method, the `WHERE` clause read: `WHERE UnitPrice < @MaxPrice`.</span></span> <span data-ttu-id="2c259-467">Ici, dans `GetProductsWithPriceGreaterThan` , nous utilisons : `WHERE UnitPrice > @MinPrice` .</span><span class="sxs-lookup"><span data-stu-id="2c259-467">Here, in `GetProductsWithPriceGreaterThan`, we use: `WHERE UnitPrice > @MinPrice` .</span></span>

<span data-ttu-id="2c259-468">Nous devons maintenant compiler cette classe dans un assembly.</span><span class="sxs-lookup"><span data-stu-id="2c259-468">We now need to compile this class into an assembly.</span></span> <span data-ttu-id="2c259-469">À partir de la ligne de commande, accédez au répertoire où vous avez enregistré le `GetProductsWithPriceGreaterThan.cs` fichier et utilisez le compilateur C# ( `csc.exe` ) pour compiler le fichier de classe dans un assembly :</span><span class="sxs-lookup"><span data-stu-id="2c259-469">From the command line, navigate to the directory where you saved the `GetProductsWithPriceGreaterThan.cs` file and use the C# compiler (`csc.exe`) to compile the class file into an assembly:</span></span>

[!code-console[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample18.cmd)]

<span data-ttu-id="2c259-470">Si le dossier contenant `csc.exe` dans ne se trouve pas dans le système `PATH` , vous devez référencer entièrement son chemin d’accès, `%WINDOWS%\Microsoft.NET\Framework\version\` , comme suit :</span><span class="sxs-lookup"><span data-stu-id="2c259-470">If the folder containing `csc.exe` in not in the system s `PATH`, you will have to fully reference its path, `%WINDOWS%\Microsoft.NET\Framework\version\`, like so:</span></span>

[!code-console[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample19.cmd)]

<span data-ttu-id="2c259-471">[![Compiler GetProductsWithPriceGreaterThan.cs dans un assembly](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image70.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image69.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-471">[![Compile GetProductsWithPriceGreaterThan.cs Into an Assembly](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image70.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image69.png)</span></span>

<span data-ttu-id="2c259-472">**Figure 29**: compiler `GetProductsWithPriceGreaterThan.cs` dans un assembly ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image71.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-472">**Figure 29**: Compile `GetProductsWithPriceGreaterThan.cs` Into an Assembly ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image71.png))</span></span>

<span data-ttu-id="2c259-473">L' `/t` indicateur spécifie que le fichier de classe C# doit être compilé dans une dll (plutôt que dans un exécutable).</span><span class="sxs-lookup"><span data-stu-id="2c259-473">The `/t` flag specifies that the C# class file should be compiled into a DLL (rather than an executable).</span></span> <span data-ttu-id="2c259-474">L' `/out` indicateur spécifie le nom de l’assembly résultant.</span><span class="sxs-lookup"><span data-stu-id="2c259-474">The `/out` flag specifies the name of the resulting assembly.</span></span>

> [!NOTE]
> <span data-ttu-id="2c259-475">Au lieu de compiler le `GetProductsWithPriceGreaterThan.cs` fichier de classe à partir de la ligne de commande, vous pouvez utiliser [Visual C# Express Edition](https://msdn.microsoft.com/vstudio/express/visualcsharp/) ou créer un projet de bibliothèque de classes distinct dans Visual Studio Standard Edition.</span><span class="sxs-lookup"><span data-stu-id="2c259-475">Rather than compiling the `GetProductsWithPriceGreaterThan.cs` class file from the command line you could alternatively use [Visual C# Express Edition](https://msdn.microsoft.com/vstudio/express/visualcsharp/) or create a separate Class Library project in Visual Studio Standard Edition.</span></span> <span data-ttu-id="2c259-476">S Ren Jacob Lauritsen a fourni un tel projet Visual C# Express Edition avec le code de la `GetProductsWithPriceGreaterThan` procédure stockée et les deux procédures stockées managées et UDF créées aux étapes 3, 5 et 10.</span><span class="sxs-lookup"><span data-stu-id="2c259-476">S ren Jacob Lauritsen has kindly provided such a Visual C# Express Edition project with code for the `GetProductsWithPriceGreaterThan` stored procedure and the two managed stored procedures and UDF created in Steps 3, 5, and 10.</span></span> <span data-ttu-id="2c259-477">Le projet s Ren s comprend également les commandes T-SQL nécessaires pour ajouter les objets de base de données correspondants.</span><span class="sxs-lookup"><span data-stu-id="2c259-477">S ren s project also includes the T-SQL commands needed to add the corresponding database objects.</span></span>

<span data-ttu-id="2c259-478">Une fois le code compilé dans un assembly, nous sommes prêts à inscrire l’assembly dans la base de données SQL Server 2005.</span><span class="sxs-lookup"><span data-stu-id="2c259-478">With the code compiled into an assembly, we are ready to register the assembly within the SQL Server 2005 database.</span></span> <span data-ttu-id="2c259-479">Cela peut être effectué via T-SQL, à l’aide de la commande `CREATE ASSEMBLY` ou par le biais de SQL Server Management Studio.</span><span class="sxs-lookup"><span data-stu-id="2c259-479">This can be performed through T-SQL, using the command `CREATE ASSEMBLY`, or through SQL Server Management Studio.</span></span> <span data-ttu-id="2c259-480">Nous allons nous concentrer sur l’utilisation de Management Studio.</span><span class="sxs-lookup"><span data-stu-id="2c259-480">Let s focus on using Management Studio.</span></span>

<span data-ttu-id="2c259-481">Dans Management Studio, développez le dossier programmabilité dans la base de données Northwind.</span><span class="sxs-lookup"><span data-stu-id="2c259-481">From Management Studio, expand the Programmability folder in the Northwind database.</span></span> <span data-ttu-id="2c259-482">L’un de ses sous-dossiers est Assemblies.</span><span class="sxs-lookup"><span data-stu-id="2c259-482">One of its subfolder is Assemblies.</span></span> <span data-ttu-id="2c259-483">Pour ajouter manuellement un nouvel assembly à la base de données, cliquez avec le bouton droit sur le dossier assemblys, puis choisissez nouvel assembly dans le menu contextuel.</span><span class="sxs-lookup"><span data-stu-id="2c259-483">To manually add a new Assembly to the database, right-click on the Assemblies folder and choose New Assembly from the context menu.</span></span> <span data-ttu-id="2c259-484">La boîte de dialogue nouvel assembly s’affiche (voir figure 30).</span><span class="sxs-lookup"><span data-stu-id="2c259-484">This displays the New Assembly dialog box (see Figure 30).</span></span> <span data-ttu-id="2c259-485">Cliquez sur le bouton Parcourir, sélectionnez l' `ManuallyCreatedDBObjects.dll` assembly que nous venons de compiler, puis cliquez sur OK pour ajouter l’assembly à la base de données.</span><span class="sxs-lookup"><span data-stu-id="2c259-485">Click on the Browse button, select the `ManuallyCreatedDBObjects.dll` assembly we just compiled, and then click OK to add the Assembly to the database.</span></span> <span data-ttu-id="2c259-486">Vous ne devriez pas voir l' `ManuallyCreatedDBObjects.dll` assembly dans l’Explorateur d’objets.</span><span class="sxs-lookup"><span data-stu-id="2c259-486">You should not see the `ManuallyCreatedDBObjects.dll` assembly in the Object Explorer.</span></span>

<span data-ttu-id="2c259-487">[![Ajouter l’assembly ManuallyCreatedDBObjects.dll à la base de données](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image73.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image72.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-487">[![Add the ManuallyCreatedDBObjects.dll Assembly to the Database](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image73.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image72.png)</span></span>

<span data-ttu-id="2c259-488">**Figure 30**: ajouter l' `ManuallyCreatedDBObjects.dll` assembly à la base de données ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image74.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-488">**Figure 30**: Add the `ManuallyCreatedDBObjects.dll` Assembly to the Database ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image74.png))</span></span>

![Le ManuallyCreatedDBObjects.dll est listé dans l’Explorateur d’objets.](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image75.png)

<span data-ttu-id="2c259-490">**Figure 31**: le `ManuallyCreatedDBObjects.dll` est listé dans l’Explorateur d’objets</span><span class="sxs-lookup"><span data-stu-id="2c259-490">**Figure 31**: The `ManuallyCreatedDBObjects.dll` is Listed in the Object Explorer</span></span>

<span data-ttu-id="2c259-491">Pendant que nous avons ajouté l’assembly à la base de données Northwind, nous n’avons pas encore associé une procédure stockée à la `GetProductsWithPriceGreaterThan` méthode dans l’assembly.</span><span class="sxs-lookup"><span data-stu-id="2c259-491">While we have added the assembly to the Northwind database, we have yet to associate a stored procedure with the `GetProductsWithPriceGreaterThan` method in the assembly.</span></span> <span data-ttu-id="2c259-492">Pour ce faire, ouvrez une nouvelle fenêtre de requête et exécutez le script suivant :</span><span class="sxs-lookup"><span data-stu-id="2c259-492">To accomplish this, open a new query window and execute the following script:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample20.sql)]

<span data-ttu-id="2c259-493">Cela crée une procédure stockée dans la base de données Northwind nommée `GetProductsWithPriceGreaterThan` et l’associe à la méthode managée `GetProductsWithPriceGreaterThan` (qui se trouve dans la classe `StoredProcedures` , qui se trouve dans l’assembly `ManuallyCreatedDBObjects` ).</span><span class="sxs-lookup"><span data-stu-id="2c259-493">This creates a new stored procedure in the Northwind database named `GetProductsWithPriceGreaterThan` and associates it with the managed method `GetProductsWithPriceGreaterThan` (which is in the class `StoredProcedures`, which is in the assembly `ManuallyCreatedDBObjects`).</span></span>

<span data-ttu-id="2c259-494">Après l’exécution du script ci-dessus, actualisez le dossier procédures stockées dans l’Explorateur d’objets.</span><span class="sxs-lookup"><span data-stu-id="2c259-494">After executing the above script, refresh the Stored Procedures folder in the Object Explorer.</span></span> <span data-ttu-id="2c259-495">Vous devez voir une nouvelle entrée de procédure stockée, avec `GetProductsWithPriceGreaterThan` une icône de verrou en regard de celle-ci.</span><span class="sxs-lookup"><span data-stu-id="2c259-495">You should see a new stored procedure entry - `GetProductsWithPriceGreaterThan` - which has a lock icon next to it.</span></span> <span data-ttu-id="2c259-496">Pour tester cette procédure stockée, entrez et exécutez le script suivant dans la fenêtre de requête :</span><span class="sxs-lookup"><span data-stu-id="2c259-496">To test this stored procedure, enter and execute the following script in the query window:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample21.sql)]

<span data-ttu-id="2c259-497">Comme le montre la figure 32, la commande ci-dessus affiche des informations sur les produits dont la `UnitPrice` valeur est supérieure à $24,95.</span><span class="sxs-lookup"><span data-stu-id="2c259-497">As Figure 32 shows, the above command displays information for those products with a `UnitPrice` greater than $24.95.</span></span>

<span data-ttu-id="2c259-498">[![Le ManuallyCreatedDBObjects.dll est listé dans l’Explorateur d’objets.](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image77.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image76.png)</span><span class="sxs-lookup"><span data-stu-id="2c259-498">[![The ManuallyCreatedDBObjects.dll is Listed in the Object Explorer](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image77.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image76.png)</span></span>

<span data-ttu-id="2c259-499">**Figure 32**: le `ManuallyCreatedDBObjects.dll` est listé dans l’Explorateur d’objets ([cliquez pour afficher l’image en taille réelle](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image78.png))</span><span class="sxs-lookup"><span data-stu-id="2c259-499">**Figure 32**: The `ManuallyCreatedDBObjects.dll` is Listed in the Object Explorer ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image78.png))</span></span>

## <a name="summary"></a><span data-ttu-id="2c259-500">Résumé</span><span class="sxs-lookup"><span data-stu-id="2c259-500">Summary</span></span>

<span data-ttu-id="2c259-501">Microsoft SQL Server 2005 fournit une intégration avec le Common Language Runtime (CLR), qui permet de créer des objets de base de données à l’aide de code managé.</span><span class="sxs-lookup"><span data-stu-id="2c259-501">Microsoft SQL Server 2005 provides integration with the Common Language Runtime (CLR), which allows database objects to be created using managed code.</span></span> <span data-ttu-id="2c259-502">Auparavant, ces objets de base de données pouvaient uniquement être créés à l’aide de T-SQL, mais nous pouvons maintenant créer ces objets à l’aide de langages de programmation .NET tels que C#.</span><span class="sxs-lookup"><span data-stu-id="2c259-502">Previously, these database objects could only be created using T-SQL, but now we can create these objects using .NET programming languages like C#.</span></span> <span data-ttu-id="2c259-503">Dans ce didacticiel, nous avons créé deux procédures stockées managées et une fonction définie par l’utilisateur gérée.</span><span class="sxs-lookup"><span data-stu-id="2c259-503">In this tutorial we created two managed stored procedures and a managed User-Defined Function.</span></span>

<span data-ttu-id="2c259-504">Le type de projet SQL Server Visual Studio facilite la création, la compilation et le déploiement d’objets de base de données managés.</span><span class="sxs-lookup"><span data-stu-id="2c259-504">Visual Studio s SQL Server Project type facilitates creating, compiling, and deploying managed database objects.</span></span> <span data-ttu-id="2c259-505">En outre, il offre une prise en charge riche du débogage.</span><span class="sxs-lookup"><span data-stu-id="2c259-505">Moreover, it offers rich debugging support.</span></span> <span data-ttu-id="2c259-506">Toutefois, SQL Server types de projets ne sont disponibles que dans les éditions Professional et Team Systems de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="2c259-506">However, SQL Server Project types are only available in the Professional and Team Systems editions of Visual Studio.</span></span> <span data-ttu-id="2c259-507">Pour ceux qui utilisent Visual Web Developer ou l’édition standard de Visual Studio, les étapes de création, de compilation et de déploiement doivent être effectuées manuellement, comme nous l’avons vu à l’étape 13.</span><span class="sxs-lookup"><span data-stu-id="2c259-507">For those using Visual Web Developer or the Standard Edition of Visual Studio, the creation, compilation, and deployment steps must be performed manually, as we saw in Step 13.</span></span>

<span data-ttu-id="2c259-508">Bonne programmation !</span><span class="sxs-lookup"><span data-stu-id="2c259-508">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="2c259-509">En savoir plus</span><span class="sxs-lookup"><span data-stu-id="2c259-509">Further Reading</span></span>

<span data-ttu-id="2c259-510">Pour plus d’informations sur les sujets abordés dans ce didacticiel, reportez-vous aux ressources suivantes :</span><span class="sxs-lookup"><span data-stu-id="2c259-510">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="2c259-511">Avantages et inconvénients des fonctions définies par l’utilisateur</span><span class="sxs-lookup"><span data-stu-id="2c259-511">Advantages and Drawbacks of User-Defined Functions</span></span>](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1)
- [<span data-ttu-id="2c259-512">Création d’objets SQL Server 2005 dans du code managé</span><span class="sxs-lookup"><span data-stu-id="2c259-512">Creating SQL Server 2005 Objects in Managed Code</span></span>](https://channel9.msdn.com/Showpost.aspx?postid=142413)
- [<span data-ttu-id="2c259-513">Création de déclencheurs à l’aide de code managé dans SQL Server 2005</span><span class="sxs-lookup"><span data-stu-id="2c259-513">Creating Triggers Using Managed Code in SQL Server 2005</span></span>](http://www.15seconds.com/issue/041006.htm)
- <span data-ttu-id="2c259-514">[Comment : créer et exécuter une procédure stockée SQL Server CLR](https://msdn.microsoft.com/library/5czye81z(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2c259-514">[How To: Create and Run a CLR SQL Server Stored Procedure](https://msdn.microsoft.com/library/5czye81z(VS.80).aspx)</span></span>
- <span data-ttu-id="2c259-515">[Comment : créer et exécuter une fonction CLR SQL Server définie par l’utilisateur](https://msdn.microsoft.com/library/w2kae45k(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2c259-515">[How To: Create and Run a CLR SQL Server User-Defined Function](https://msdn.microsoft.com/library/w2kae45k(VS.80).aspx)</span></span>
- <span data-ttu-id="2c259-516">[Comment : modifier le `Test.sql` script pour exécuter des objets SQL](https://msdn.microsoft.com/library/ms233682(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2c259-516">[How To: Edit the `Test.sql` Script to Run SQL Objects](https://msdn.microsoft.com/library/ms233682(VS.80).aspx)</span></span>
- [<span data-ttu-id="2c259-517">Présentation des fonctions définies par l’utilisateur</span><span class="sxs-lookup"><span data-stu-id="2c259-517">Intro to User Defined Functions</span></span>](http://www.sqlteam.com/item.asp?ItemID=1955)
- [<span data-ttu-id="2c259-518">Code managé et SQL Server 2005 (vidéo)</span><span class="sxs-lookup"><span data-stu-id="2c259-518">Managed Code and SQL Server 2005 (Video)</span></span>](https://channel9.msdn.com/Showpost.aspx?postid=142413)
- <span data-ttu-id="2c259-519">[Référence Transact-SQL](https://msdn.microsoft.com/library/aa299742(SQL.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2c259-519">[Transact-SQL Reference](https://msdn.microsoft.com/library/aa299742(SQL.80).aspx)</span></span>
- <span data-ttu-id="2c259-520">[Procédure pas à pas : création d’une procédure stockée dans du code managé](https://msdn.microsoft.com/library/zxsa8hkf(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2c259-520">[Walkthrough: Creating a Stored Procedure in Managed Code](https://msdn.microsoft.com/library/zxsa8hkf(VS.80).aspx)</span></span>

## <a name="about-the-author"></a><span data-ttu-id="2c259-521">À propos de l’auteur</span><span class="sxs-lookup"><span data-stu-id="2c259-521">About the Author</span></span>

<span data-ttu-id="2c259-522">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), auteur de sept livres ASP/ASP. net et fondateur de [4GuysFromRolla.com](http://www.4guysfromrolla.com), travaille avec des technologies Web Microsoft depuis 1998.</span><span class="sxs-lookup"><span data-stu-id="2c259-522">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="2c259-523">Scott travaille en tant que consultant, formateur et auteur indépendant.</span><span class="sxs-lookup"><span data-stu-id="2c259-523">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="2c259-524">Son dernier livre est [*Sams vous apprend vous-même ASP.NET 2,0 en 24 heures*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="2c259-524">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="2c259-525">Il peut être contacté à l’adresse [ mitchell@4GuysFromRolla.com .](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="2c259-525">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="2c259-526">ou via son blog, qui se trouve à l’adresse [http://ScottOnWriting.NET](http://ScottOnWriting.NET) .</span><span class="sxs-lookup"><span data-stu-id="2c259-526">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="2c259-527">Remerciements à</span><span class="sxs-lookup"><span data-stu-id="2c259-527">Special Thanks To</span></span>

<span data-ttu-id="2c259-528">Cette série de didacticiels a été examinée par de nombreux réviseurs utiles.</span><span class="sxs-lookup"><span data-stu-id="2c259-528">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="2c259-529">Le réviseur de leads pour ce didacticiel était S Ren Jacob Lauritsen.</span><span class="sxs-lookup"><span data-stu-id="2c259-529">Lead reviewer for this tutorial was S ren Jacob Lauritsen.</span></span> <span data-ttu-id="2c259-530">En plus d’examiner cet article, S Ren a également créé le projet Visual C# Express Edition inclus dans cet article pour la compilation manuelle des objets de base de données managés.</span><span class="sxs-lookup"><span data-stu-id="2c259-530">In addition to reviewing this article, S ren also created the Visual C# Express Edition project included in this article s download for manually compiling the managed database objects.</span></span> <span data-ttu-id="2c259-531">Vous souhaitez revoir mes prochains articles MSDN ?</span><span class="sxs-lookup"><span data-stu-id="2c259-531">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="2c259-532">Dans ce cas, déposez-moi une ligne à l’adresse [ mitchell@4GuysFromRolla.com .](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="2c259-532">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="2c259-533">[Précédent](debugging-stored-procedures-cs.md) 
>  [Suivant](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-vb.md)</span><span class="sxs-lookup"><span data-stu-id="2c259-533">[Previous](debugging-stored-procedures-cs.md)
[Next](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-vb.md)</span></span>
