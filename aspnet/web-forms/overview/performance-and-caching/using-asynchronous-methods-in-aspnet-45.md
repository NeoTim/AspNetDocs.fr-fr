---
uid: web-forms/overview/performance-and-caching/using-asynchronous-methods-in-aspnet-45
title: Utilisation de méthodes asynchrones dans ASP.NET 4,5 | Microsoft Docs
author: Rick-Anderson
description: Ce didacticiel vous apprend les bases de la création d’une application ASP.NET Web Forms asynchrone à l’aide d’Visual Studio Express 2012 pour le Web, ce qui est une opération gratuite...
ms.author: riande
ms.date: 01/02/2019
ms.assetid: a585c9a2-7c8e-478b-9706-90f3739c50d1
msc.legacyurl: /web-forms/overview/performance-and-caching/using-asynchronous-methods-in-aspnet-45
msc.type: authoredcontent
ms.openlocfilehash: 7abc3d7acc60d7d868958f2a313bc408f96c95a4
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78625194"
---
# <a name="using-asynchronous-methods-in-aspnet-45"></a><span data-ttu-id="c022c-103">Utilisation de méthodes asynchrones dans ASP.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="c022c-103">Using Asynchronous Methods in ASP.NET 4.5</span></span>

<span data-ttu-id="c022c-104">par [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="c022c-104">by [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

> <span data-ttu-id="c022c-105">Ce didacticiel vous apprend les bases de la création d’une application ASP.NET Web Forms asynchrone à l’aide de [Visual Studio Express 2012 pour le Web](https://www.microsoft.com/visualstudio/11), qui est une version gratuite de Microsoft Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="c022c-105">This tutorial will teach you the basics of building an asynchronous ASP.NET Web Forms application using [Visual Studio Express 2012 for Web](https://www.microsoft.com/visualstudio/11), which is a free version of Microsoft Visual Studio.</span></span> <span data-ttu-id="c022c-106">Vous pouvez également utiliser [Visual Studio 2012](https://www.microsoft.com/visualstudio/11).</span><span class="sxs-lookup"><span data-stu-id="c022c-106">You can also use [Visual Studio 2012](https://www.microsoft.com/visualstudio/11).</span></span> <span data-ttu-id="c022c-107">Les sections suivantes sont incluses dans ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="c022c-107">The following sections are included in this tutorial.</span></span>
> 
> - [<span data-ttu-id="c022c-108">Mode de traitement des demandes par le pool de threads</span><span class="sxs-lookup"><span data-stu-id="c022c-108">How Requests Are Processed by the Thread Pool</span></span>](#HowRequestsProcessedByTP)
> - [<span data-ttu-id="c022c-109">Choix de méthodes synchrones ou asynchrones</span><span class="sxs-lookup"><span data-stu-id="c022c-109">Choosing Synchronous or Asynchronous Methods</span></span>](#ChoosingSyncVasync)
> - [<span data-ttu-id="c022c-110">L’exemple d’application</span><span class="sxs-lookup"><span data-stu-id="c022c-110">The Sample Application</span></span>](#SampleApp)
> - [<span data-ttu-id="c022c-111">Page synchrone gizmos</span><span class="sxs-lookup"><span data-stu-id="c022c-111">The Gizmos Synchronous Page</span></span>](#GizmosSynch)
> - [<span data-ttu-id="c022c-112">Création d’une page gizmos asynchrone</span><span class="sxs-lookup"><span data-stu-id="c022c-112">Creating an Asynchronous Gizmos Page</span></span>](#CreatingAsynchGizmos)
> - [<span data-ttu-id="c022c-113">Exécution de plusieurs opérations en parallèle</span><span class="sxs-lookup"><span data-stu-id="c022c-113">Performing Multiple Operations in Parallel</span></span>](#Parallel)
> - [<span data-ttu-id="c022c-114">Utilisation d’un jeton d’annulation</span><span class="sxs-lookup"><span data-stu-id="c022c-114">Using a Cancellation Token</span></span>](#CancelToken)
> - [<span data-ttu-id="c022c-115">Configuration du serveur pour les appels de service Web avec concurrence élevée/latence élevée</span><span class="sxs-lookup"><span data-stu-id="c022c-115">Server Configuration for High Concurrency/High Latency Web Service Calls</span></span>](#ServerConfig)
> 
> <span data-ttu-id="c022c-116">Un exemple complet est fourni pour ce didacticiel à l’adresse suivante :</span><span class="sxs-lookup"><span data-stu-id="c022c-116">A complete sample is provided for this tutorial at</span></span>  
> <span data-ttu-id="c022c-117">[https://github.com/RickAndMSFT/Async-ASP.NET/](https://github.com/RickAndMSFT/Async-ASP.NET/) sur le site [GitHub](https://github.com/) .</span><span class="sxs-lookup"><span data-stu-id="c022c-117">[https://github.com/RickAndMSFT/Async-ASP.NET/](https://github.com/RickAndMSFT/Async-ASP.NET/) on the [GitHub](https://github.com/) site.</span></span>

<span data-ttu-id="c022c-118">Les pages Web ASP.NET 4,5 en combinaison [.net 4,5](https://msdn.microsoft.com/library/w0x726c2(VS.110).aspx) vous permettent d’inscrire des méthodes asynchrones qui retournent un objet de type [Task](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx).</span><span class="sxs-lookup"><span data-stu-id="c022c-118">ASP.NET 4.5 Web Pages in combination [.NET 4.5](https://msdn.microsoft.com/library/w0x726c2(VS.110).aspx) enables you to register asynchronous methods that return an object of type [Task](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx).</span></span> <span data-ttu-id="c022c-119">Le .NET Framework 4 a introduit un concept de programmation asynchrone appelé [tâche](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) et ASP.net 4,5 prend en charge la [tâche](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx).</span><span class="sxs-lookup"><span data-stu-id="c022c-119">The .NET Framework 4 introduced an asynchronous programming concept referred to as a [Task](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) and ASP.NET 4.5 supports [Task](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx).</span></span> <span data-ttu-id="c022c-120">Les tâches sont représentées par le type de **tâche** et les types associés dans l’espace de noms [System. Threading. Tasks](https://msdn.microsoft.com/library/system.threading.tasks.aspx) .</span><span class="sxs-lookup"><span data-stu-id="c022c-120">Tasks are represented by the **Task** type and related types in the [System.Threading.Tasks](https://msdn.microsoft.com/library/system.threading.tasks.aspx) namespace.</span></span> <span data-ttu-id="c022c-121">La .NET Framework 4,5 s’appuie sur cette prise en charge asynchrone avec les mots clés [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) et [Async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) qui rendent l’utilisation des objets de [tâche](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) bien moins complexe que les approches asynchrones précédentes.</span><span class="sxs-lookup"><span data-stu-id="c022c-121">The .NET Framework 4.5 builds on this asynchronous support with the [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) and [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) keywords that make working with [Task](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) objects much less complex than previous asynchronous approaches.</span></span> <span data-ttu-id="c022c-122">Le mot clé [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) est un raccourci de syntaxe pour indiquer qu’un morceau de code doit attendre de façon asynchrone un autre morceau de code.</span><span class="sxs-lookup"><span data-stu-id="c022c-122">The [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) keyword is syntactical shorthand for indicating that a piece of code should asynchronously wait on some other piece of code.</span></span> <span data-ttu-id="c022c-123">Le mot clé [Async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) représente un indicateur que vous pouvez utiliser pour marquer des méthodes en tant que méthodes asynchrones basées sur des tâches.</span><span class="sxs-lookup"><span data-stu-id="c022c-123">The [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) keyword represents a hint that you can use to mark methods as task-based asynchronous methods.</span></span> <span data-ttu-id="c022c-124">La combinaison d' **await**, **Async**et de l’objet de **tâche** facilite grandement l’écriture de code asynchrone dans .net 4,5.</span><span class="sxs-lookup"><span data-stu-id="c022c-124">The combination of **await**, **async**, and the **Task** object makes it much easier for you to write asynchronous code in .NET 4.5.</span></span> <span data-ttu-id="c022c-125">Le nouveau modèle pour les méthodes asynchrones est appelé *modèle asynchrone basé sur les tâches* (**Tap**).</span><span class="sxs-lookup"><span data-stu-id="c022c-125">The new model for asynchronous methods is called the *Task-based Asynchronous Pattern* (**TAP**).</span></span> <span data-ttu-id="c022c-126">Ce didacticiel part du principe que vous êtes familiarisé avec les programmations asynchrones à l’aide des mots clés [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) et [Async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) et de l’espace de noms de [tâche](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) .</span><span class="sxs-lookup"><span data-stu-id="c022c-126">This tutorial assumes you have some familiarity with asynchronous programing using [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) and [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) keywords and the [Task](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) namespace.</span></span>

<span data-ttu-id="c022c-127">Pour plus d’informations sur l’utilisation des mots clés [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) et [Async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) et l’espace de noms de [tâche](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) , consultez les références suivantes.</span><span class="sxs-lookup"><span data-stu-id="c022c-127">For more information on the using [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) and [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) keywords and the [Task](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) namespace, see the following references.</span></span>

- [<span data-ttu-id="c022c-128">Livre blanc : asynchronie dans .NET</span><span class="sxs-lookup"><span data-stu-id="c022c-128">Whitepaper: Asynchrony in .NET</span></span>](https://go.microsoft.com/fwlink/?LinkId=204844)
- [<span data-ttu-id="c022c-129">FAQ Async/await</span><span class="sxs-lookup"><span data-stu-id="c022c-129">Async/Await FAQ</span></span>](https://blogs.msdn.com/b/pfxteam/archive/2012/04/12/10293335.aspx)
- [<span data-ttu-id="c022c-130">Programmation asynchrone Visual Studio</span><span class="sxs-lookup"><span data-stu-id="c022c-130">Visual Studio Asynchronous Programming</span></span>](https://msdn.microsoft.com/vstudio/gg316360)

## <a id="HowRequestsProcessedByTP"></a><span data-ttu-id="c022c-131">Mode de traitement des demandes par le pool de threads</span><span class="sxs-lookup"><span data-stu-id="c022c-131">How Requests Are Processed by the Thread Pool</span></span>

<span data-ttu-id="c022c-132">Sur le serveur Web, le .NET Framework gère un pool de threads utilisés pour traiter les demandes ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="c022c-132">On the web server, the .NET Framework maintains a pool of threads that are used to service ASP.NET requests.</span></span> <span data-ttu-id="c022c-133">À l'arrivée d'une requête, un thread du pool est distribué pour la traiter.</span><span class="sxs-lookup"><span data-stu-id="c022c-133">When a request arrives, a thread from the pool is dispatched to process that request.</span></span> <span data-ttu-id="c022c-134">Si la demande est traitée de façon synchrone, le thread qui traite la demande est occupé pendant le traitement de la demande et ce thread ne peut pas traiter une autre demande.</span><span class="sxs-lookup"><span data-stu-id="c022c-134">If the request is processed synchronously, the thread that processes the request is busy while the request is being processed, and that thread cannot service another request.</span></span>   
  
<span data-ttu-id="c022c-135">Cela peut ne pas être un problème, car le pool de threads peut être rendu suffisamment grand pour accueillir de nombreux threads occupés.</span><span class="sxs-lookup"><span data-stu-id="c022c-135">This might not be a problem, because the thread pool can be made large enough to accommodate many busy threads.</span></span> <span data-ttu-id="c022c-136">Toutefois, le nombre de threads dans le pool de threads est limité (la valeur maximale par défaut pour .NET 4,5 est 5 000).</span><span class="sxs-lookup"><span data-stu-id="c022c-136">However, the number of threads in the thread pool is limited (the default maximum for .NET 4.5 is 5,000).</span></span> <span data-ttu-id="c022c-137">Dans les applications de grande taille avec un haut niveau de concurrence des requêtes à long terme, tous les threads disponibles peuvent être occupés.</span><span class="sxs-lookup"><span data-stu-id="c022c-137">In large applications with high concurrency of long-running requests, all available threads might be busy.</span></span> <span data-ttu-id="c022c-138">Cet état est appelé privation de thread.</span><span class="sxs-lookup"><span data-stu-id="c022c-138">This condition is known as thread starvation.</span></span> <span data-ttu-id="c022c-139">Lorsque cette condition est atteinte, le serveur Web met en file d’attente les demandes.</span><span class="sxs-lookup"><span data-stu-id="c022c-139">When this condition is reached, the web server queues requests.</span></span> <span data-ttu-id="c022c-140">Si la file d’attente de demandes est pleine, le serveur Web rejette les demandes avec un état HTTP 503 (serveur encombré).</span><span class="sxs-lookup"><span data-stu-id="c022c-140">If the request queue becomes full, the web server rejects requests with an HTTP 503 status (Server Too Busy).</span></span> <span data-ttu-id="c022c-141">Le pool de threads CLR présente des limitations sur les nouvelles injections de thread.</span><span class="sxs-lookup"><span data-stu-id="c022c-141">The CLR thread pool has limitations on new thread injections.</span></span> <span data-ttu-id="c022c-142">Si la concurrence est éclatée (autrement dit, votre site Web peut obtenir soudainement un grand nombre de requêtes) et que tous les threads de requête disponibles sont occupés en raison des appels du backend avec une latence élevée, le taux d’injection de threads limité peut rendre votre application plus difficile à résoudre.</span><span class="sxs-lookup"><span data-stu-id="c022c-142">If concurrency is bursty (that is, your web site can suddenly get a large number of requests) and all available request threads are busy because of backend calls with high latency, the limited thread injection rate can make your application respond very poorly.</span></span> <span data-ttu-id="c022c-143">En outre, chaque nouveau thread ajouté au pool de threads a une charge mémoire (par exemple, 1 Mo de mémoire de pile).</span><span class="sxs-lookup"><span data-stu-id="c022c-143">Additionally, each new thread added to the thread pool has overhead (such as 1 MB of stack memory).</span></span> <span data-ttu-id="c022c-144">Une application Web utilisant des méthodes synchrones pour traiter les appels à latence élevée où le pool de threads atteint le nombre maximal de 5 000 threads par défaut de .NET 4,5 consomme environ 5 Go de mémoire par rapport à une application capable de traiter les mêmes demandes à l’aide de les méthodes asynchrones et uniquement les threads 50.</span><span class="sxs-lookup"><span data-stu-id="c022c-144">A web application using synchronous methods to service high latency calls where the thread pool grows to the .NET 4.5 default maximum of 5, 000 threads would consume approximately 5 GB more memory than an application able the service the same requests using asynchronous methods and only 50 threads.</span></span> <span data-ttu-id="c022c-145">Lorsque vous effectuez un travail asynchrone, vous n’utilisez pas toujours un thread.</span><span class="sxs-lookup"><span data-stu-id="c022c-145">When you're doing asynchronous work, you're not always using a thread.</span></span> <span data-ttu-id="c022c-146">Par exemple, lorsque vous effectuez une demande de service Web asynchrone, ASP.NET n’utilise aucun thread entre l’appel de méthode **Async** et l' **expression await**.</span><span class="sxs-lookup"><span data-stu-id="c022c-146">For example, when you make an asynchronous web service request, ASP.NET will not be using any threads between the **async** method call and the **await**.</span></span> <span data-ttu-id="c022c-147">L’utilisation du pool de threads pour traiter les demandes avec une latence élevée peut entraîner un grand encombrement mémoire et une mauvaise utilisation du matériel serveur.</span><span class="sxs-lookup"><span data-stu-id="c022c-147">Using the thread pool to service requests with high latency can lead to a large memory footprint and poor utilization of the server hardware.</span></span>

## <a name="processing-asynchronous-requests"></a><span data-ttu-id="c022c-148">Traitement des requêtes asynchrones</span><span class="sxs-lookup"><span data-stu-id="c022c-148">Processing Asynchronous Requests</span></span>

<span data-ttu-id="c022c-149">Dans les applications Web qui voient un grand nombre de demandes simultanées au démarrage ou qui ont une charge élevée (où l’accès concurrentiel augmente soudainement), le fait d’effectuer des appels de service Web asynchrones augmente la réactivité de votre application.</span><span class="sxs-lookup"><span data-stu-id="c022c-149">In web applications that see a large number of concurrent requests at start-up or has a bursty load (where concurrency increases suddenly), making web service calls asynchronous will increase the responsiveness of your application.</span></span> <span data-ttu-id="c022c-150">Une requête asynchrone demande la même durée de traitement qu'une requête synchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-150">An asynchronous request takes the same amount of time to process as a synchronous request.</span></span> <span data-ttu-id="c022c-151">Par exemple, si une demande effectue un appel de service Web qui nécessite deux secondes, la demande prend deux secondes, qu’elle soit exécutée de façon synchrone ou asynchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-151">For example, if a request makes a web service call that requires two seconds to complete, the request takes two seconds whether it is performed synchronously or asynchronously.</span></span> <span data-ttu-id="c022c-152">Toutefois, lors d’un appel asynchrone, un thread ne peut pas répondre à d’autres requêtes pendant qu’il attend la fin de la première requête.</span><span class="sxs-lookup"><span data-stu-id="c022c-152">However, during an asynchronous call, a thread is not blocked from responding to other requests while it waits for the first request to complete.</span></span> <span data-ttu-id="c022c-153">Par conséquent, les requêtes asynchrones empêchent la mise en file d’attente des demandes et la croissance du pool de threads lorsqu’il existe de nombreuses demandes simultanées qui appellent des opérations de longue durée</span><span class="sxs-lookup"><span data-stu-id="c022c-153">Therefore, asynchronous requests prevent request queuing and thread pool growth when there are many concurrent requests that invoke long-running operations.</span></span>

## <a id="ChoosingSyncVasync"></a><span data-ttu-id="c022c-154">Choix de méthodes synchrones ou asynchrones</span><span class="sxs-lookup"><span data-stu-id="c022c-154">Choosing Synchronous or Asynchronous Methods</span></span>

<span data-ttu-id="c022c-155">Cette section répertorie les instructions relatives à l’utilisation des méthodes synchrones ou asynchrones.</span><span class="sxs-lookup"><span data-stu-id="c022c-155">This section lists guidelines for when to use synchronous or asynchronous Methods.</span></span> <span data-ttu-id="c022c-156">Il s’agit simplement de recommandations. Examinez chaque application individuellement pour déterminer si les méthodes asynchrones permettent d’obtenir des performances optimales.</span><span class="sxs-lookup"><span data-stu-id="c022c-156">These are just guidelines; examine each application individually to determine whether asynchronous methods help with performance.</span></span>

<span data-ttu-id="c022c-157">En général, utilisez des méthodes synchrones pour les conditions suivantes :</span><span class="sxs-lookup"><span data-stu-id="c022c-157">In general, use synchronous methods for the following conditions:</span></span>

- <span data-ttu-id="c022c-158">Les opérations sont simples ou à durée d'exécution courte.</span><span class="sxs-lookup"><span data-stu-id="c022c-158">The operations are simple or short-running.</span></span>
- <span data-ttu-id="c022c-159">La simplicité est plus importante que l'efficacité.</span><span class="sxs-lookup"><span data-stu-id="c022c-159">Simplicity is more important than efficiency.</span></span>
- <span data-ttu-id="c022c-160">Les opérations sont essentiellement des opérations UC, et non des opérations qui impliquent une surcharge du disque ou du réseau.</span><span class="sxs-lookup"><span data-stu-id="c022c-160">The operations are primarily CPU operations instead of operations that involve extensive disk or network overhead.</span></span> <span data-ttu-id="c022c-161">L’utilisation de méthodes asynchrones sur les opérations liées à l’UC n’offre aucun avantage et aboutit à une plus grande surcharge.</span><span class="sxs-lookup"><span data-stu-id="c022c-161">Using asynchronous methods on CPU-bound operations provides no benefits and results in more overhead.</span></span>

<span data-ttu-id="c022c-162">En général, utilisez des méthodes asynchrones pour les conditions suivantes :</span><span class="sxs-lookup"><span data-stu-id="c022c-162">In general, use asynchronous methods for the following conditions:</span></span>

- <span data-ttu-id="c022c-163">Vous appelez des services qui peuvent être utilisés par le biais de méthodes asynchrones, et vous utilisez .NET 4,5 ou une version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="c022c-163">You're calling services that can be consumed through asynchronous methods, and you're using .NET 4.5 or higher.</span></span>
- <span data-ttu-id="c022c-164">Les opérations utilisent le réseau ou les E/S de manière intensive et non le processeur.</span><span class="sxs-lookup"><span data-stu-id="c022c-164">The operations are network-bound or I/O-bound instead of CPU-bound.</span></span>
- <span data-ttu-id="c022c-165">Le parallélisme est plus important que la simplicité du code.</span><span class="sxs-lookup"><span data-stu-id="c022c-165">Parallelism is more important than simplicity of code.</span></span>
- <span data-ttu-id="c022c-166">Vous souhaitez fournir un mécanisme qui permet aux utilisateurs d'annuler une requête à durée d'exécution longue.</span><span class="sxs-lookup"><span data-stu-id="c022c-166">You want to provide a mechanism that lets users cancel a long-running request.</span></span>
- <span data-ttu-id="c022c-167">Lorsque l’avantage du changement de threads compense le coût du changement de contexte.</span><span class="sxs-lookup"><span data-stu-id="c022c-167">When the benefit of switching threads outweighs the cost of the context switch.</span></span> <span data-ttu-id="c022c-168">En général, vous devez faire en sorte qu’une méthode soit asynchrone si la méthode synchrone bloque le thread de demande ASP.NET en l’absence de travail.</span><span class="sxs-lookup"><span data-stu-id="c022c-168">In general, you should make a method asynchronous if the synchronous method blocks the ASP.NET request thread while doing no work.</span></span> <span data-ttu-id="c022c-169">En effectuant l’appel de manière asynchrone, le thread de demande ASP.NET n’est pas bloqué pendant qu’il attend la fin de la demande de service Web.</span><span class="sxs-lookup"><span data-stu-id="c022c-169">By making the call asynchronous, the ASP.NET request thread is not blocked doing no work while it waits for the web service request to complete.</span></span>
- <span data-ttu-id="c022c-170">Les tests montrent que les opérations bloquantes représentent un goulot d’étranglement dans les performances de site et qu’IIS peut traiter davantage de demandes en utilisant des méthodes asynchrones pour ces appels bloquant.</span><span class="sxs-lookup"><span data-stu-id="c022c-170">Testing shows that the blocking operations are a bottleneck in site performance and that IIS can service more requests by using asynchronous methods for these blocking calls.</span></span>

  <span data-ttu-id="c022c-171">L’exemple téléchargeable montre comment utiliser efficacement des méthodes asynchrones.</span><span class="sxs-lookup"><span data-stu-id="c022c-171">The downloadable sample shows how to use asynchronous methods effectively.</span></span> <span data-ttu-id="c022c-172">L’exemple fourni a été conçu pour fournir une démonstration simple de la programmation asynchrone dans ASP.NET 4,5.</span><span class="sxs-lookup"><span data-stu-id="c022c-172">The sample provided was designed to provide a simple demonstration of asynchronous programming in ASP.NET 4.5.</span></span> <span data-ttu-id="c022c-173">L’exemple n’est pas destiné à être une architecture de référence pour la programmation asynchrone dans ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="c022c-173">The sample is not intended to be a reference architecture for asynchronous programming in ASP.NET.</span></span> <span data-ttu-id="c022c-174">L’exemple de programme appelle [API Web ASP.net](../../../web-api/index.md) méthodes qui à son tour appellent [Task. Delay](https://msdn.microsoft.com/library/hh139096(VS.110).aspx) pour simuler des appels de service Web à long terme.</span><span class="sxs-lookup"><span data-stu-id="c022c-174">The sample program calls [ASP.NET Web API](../../../web-api/index.md) methods which in turn call [Task.Delay](https://msdn.microsoft.com/library/hh139096(VS.110).aspx) to simulate long-running web service calls.</span></span> <span data-ttu-id="c022c-175">La plupart des applications de production n’illustreront pas ces avantages évidents à utiliser des méthodes asynchrones.</span><span class="sxs-lookup"><span data-stu-id="c022c-175">Most production applications will not show such obvious benefits to using asynchronous Methods.</span></span>   
  
<span data-ttu-id="c022c-176">Certaines applications requièrent que toutes les méthodes soient asynchrones.</span><span class="sxs-lookup"><span data-stu-id="c022c-176">Few applications require all methods to be asynchronous.</span></span> <span data-ttu-id="c022c-177">Souvent, la conversion de quelques méthodes synchrones en méthodes asynchrones offre une meilleure augmentation de l’efficacité pour la quantité de travail requise.</span><span class="sxs-lookup"><span data-stu-id="c022c-177">Often, converting a few synchronous methods to asynchronous methods provides the best efficiency increase for the amount of work required.</span></span>

## <a id="SampleApp"></a><span data-ttu-id="c022c-178">L’exemple d’application</span><span class="sxs-lookup"><span data-stu-id="c022c-178">The Sample Application</span></span>

<span data-ttu-id="c022c-179">Vous pouvez télécharger l’exemple d’application à partir de [https://github.com/RickAndMSFT/Async-ASP.NET](https://github.com/RickAndMSFT/Async-ASP.NET) sur le site [GitHub](https://github.com/) .</span><span class="sxs-lookup"><span data-stu-id="c022c-179">You can download the sample application from [https://github.com/RickAndMSFT/Async-ASP.NET](https://github.com/RickAndMSFT/Async-ASP.NET) on the [GitHub](https://github.com/) site.</span></span> <span data-ttu-id="c022c-180">Le référentiel se compose de trois projets :</span><span class="sxs-lookup"><span data-stu-id="c022c-180">The repository consists of three projects:</span></span>

- <span data-ttu-id="c022c-181">*WebAppAsync*: le projet ASP.NET Web Forms qui utilise le service **WEBAPIPWG** de l’API Web.</span><span class="sxs-lookup"><span data-stu-id="c022c-181">*WebAppAsync*: The ASP.NET Web Forms project that consumes the Web API **WebAPIpwg** service.</span></span> <span data-ttu-id="c022c-182">La majeure partie du code de ce didacticiel provient de ce projet.</span><span class="sxs-lookup"><span data-stu-id="c022c-182">Most of the code for this tutorial is from the this project.</span></span>
- <span data-ttu-id="c022c-183">*WebAPIpgw*: projet d’API Web ASP.NET MVC 4 qui implémente les contrôleurs de `Products, Gizmos and Widgets`.</span><span class="sxs-lookup"><span data-stu-id="c022c-183">*WebAPIpgw*: The ASP.NET MVC 4 Web API project that implements the `Products, Gizmos and Widgets` controllers.</span></span> <span data-ttu-id="c022c-184">Il fournit les données pour le projet *WebAppAsync* et le projet *Mvc4Async* .</span><span class="sxs-lookup"><span data-stu-id="c022c-184">It provides the data for the *WebAppAsync* project and the *Mvc4Async* project.</span></span>
- <span data-ttu-id="c022c-185">*Mvc4Async*: projet ASP.NET MVC 4 qui contient le code utilisé dans un autre didacticiel.</span><span class="sxs-lookup"><span data-stu-id="c022c-185">*Mvc4Async*: The ASP.NET MVC 4 project that contains the code used in another tutorial.</span></span> <span data-ttu-id="c022c-186">Il effectue des appels d’API Web au service **WebAPIpwg** .</span><span class="sxs-lookup"><span data-stu-id="c022c-186">It makes Web API calls to the **WebAPIpwg** service.</span></span>

## <a id="GizmosSynch"></a><span data-ttu-id="c022c-187">Page synchrone gizmos</span><span class="sxs-lookup"><span data-stu-id="c022c-187">The Gizmos Synchronous Page</span></span>

 <span data-ttu-id="c022c-188">Le code suivant montre l' `Page_Load` méthode synchrone utilisée pour afficher une liste de gizmos.</span><span class="sxs-lookup"><span data-stu-id="c022c-188">The following code shows the `Page_Load` synchronous method that is used to display a list of gizmos.</span></span> <span data-ttu-id="c022c-189">(Pour cet article, un gizmo est un appareil mécanique fictif.)</span><span class="sxs-lookup"><span data-stu-id="c022c-189">(For this article, a gizmo is a fictional mechanical device.)</span></span> 

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-45/samples/sample1.cs)]

<span data-ttu-id="c022c-190">Le code suivant illustre la méthode `GetGizmos` du service gizmo.</span><span class="sxs-lookup"><span data-stu-id="c022c-190">The following code shows the `GetGizmos` method of the gizmo service.</span></span>

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-45/samples/sample2.cs)]

<span data-ttu-id="c022c-191">La méthode `GizmoService GetGizmos` passe un URI à un service HTTP API Web ASP.NET qui retourne une liste de données gizmos.</span><span class="sxs-lookup"><span data-stu-id="c022c-191">The `GizmoService GetGizmos` method passes a URI to an ASP.NET Web API HTTP service which returns a list of gizmos data.</span></span> <span data-ttu-id="c022c-192">Le projet *WebAPIpgw* contient l’implémentation de l’API Web `gizmos, widget` et `product` contrôleurs.</span><span class="sxs-lookup"><span data-stu-id="c022c-192">The *WebAPIpgw* project contains the implementation of the Web API `gizmos, widget` and `product` controllers.</span></span>  
<span data-ttu-id="c022c-193">L’illustration suivante montre la page gizmos de l’exemple de projet.</span><span class="sxs-lookup"><span data-stu-id="c022c-193">The following image shows the gizmos page from the sample project.</span></span>

![Gizmos](using-asynchronous-methods-in-aspnet-45/_static/image1.png)

## <a id="CreatingAsynchGizmos"></a><span data-ttu-id="c022c-195">Création d’une page gizmos asynchrone</span><span class="sxs-lookup"><span data-stu-id="c022c-195">Creating an Asynchronous Gizmos Page</span></span>

<span data-ttu-id="c022c-196">L’exemple utilise les nouveaux mots clés [Async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) et [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) (disponibles dans .net 4,5 et Visual Studio 2012) pour permettre au compilateur de gérer les transformations compliquées nécessaires à la programmation asynchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-196">The sample uses the new [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) and [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) keywords (available in .NET 4.5 and Visual Studio 2012) to let the compiler be responsible for maintaining the complicated transformations necessary for asynchronous programming.</span></span> <span data-ttu-id="c022c-197">Le compilateur vous permet d’écrire du code C#à l’aide des constructions de flux de contrôle synchrones de et le compilateur applique automatiquement les transformations nécessaires pour utiliser les rappels afin d’éviter les threads de blocage.</span><span class="sxs-lookup"><span data-stu-id="c022c-197">The compiler lets you write code using the C#'s synchronous control flow constructs and the compiler automatically applies the transformations necessary to use callbacks in order to avoid blocking threads.</span></span>

<span data-ttu-id="c022c-198">Les pages asynchrones ASP.NET doivent inclure la directive [page](https://msdn.microsoft.com/library/ydy4x04a.aspx) avec l’attribut `Async` défini sur « true ».</span><span class="sxs-lookup"><span data-stu-id="c022c-198">ASP.NET asynchronous pages must include the [Page](https://msdn.microsoft.com/library/ydy4x04a.aspx) directive with the `Async` attribute set to "true".</span></span> <span data-ttu-id="c022c-199">Le code suivant montre la directive [page](https://msdn.microsoft.com/library/ydy4x04a.aspx) avec l’attribut `Async` défini sur « true » pour la page *GizmosAsync. aspx* .</span><span class="sxs-lookup"><span data-stu-id="c022c-199">The following code shows the [Page](https://msdn.microsoft.com/library/ydy4x04a.aspx) directive with the `Async` attribute set to "true" for the *GizmosAsync.aspx* page.</span></span>

[!code-aspx[Main](using-asynchronous-methods-in-aspnet-45/samples/sample3.aspx?highlight=1)]

<span data-ttu-id="c022c-200">Le code suivant montre les `Gizmos` méthode synchrone `Page_Load` et `GizmosAsync` page asynchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-200">The following code shows the `Gizmos` synchronous `Page_Load` method and the `GizmosAsync` asynchronous page.</span></span> <span data-ttu-id="c022c-201">Si votre navigateur prend en charge l' [élément de&gt; de &lt;HTML 5](http://www.w3.org/wiki/HTML/Elements/mark), vous verrez les modifications apportées à `GizmosAsync` en surbrillance en jaune.</span><span class="sxs-lookup"><span data-stu-id="c022c-201">If your browser supports the [HTML 5 &lt;mark&gt; element](http://www.w3.org/wiki/HTML/Elements/mark), you'll see the changes in `GizmosAsync` in yellow highlight.</span></span>

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-45/samples/sample4.cs)]

<span data-ttu-id="c022c-202">La version asynchrone :</span><span class="sxs-lookup"><span data-stu-id="c022c-202">The asynchronous version:</span></span>

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-45/samples/sample5.cs?highlight=3,6-7,9,11)]

 <span data-ttu-id="c022c-203">Les modifications suivantes ont été appliquées pour permettre la `GizmosAsync` page asynchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-203">The following changes were applied to allow the `GizmosAsync` page be asynchronous.</span></span>

- <span data-ttu-id="c022c-204">L’attribut `Async` de la directive [page](https://msdn.microsoft.com/library/ydy4x04a.aspx) doit avoir la valeur « true ».</span><span class="sxs-lookup"><span data-stu-id="c022c-204">The [Page](https://msdn.microsoft.com/library/ydy4x04a.aspx) directive must have the `Async` attribute set to "true".</span></span>
- <span data-ttu-id="c022c-205">La méthode `RegisterAsyncTask` est utilisée pour inscrire une tâche asynchrone contenant le code qui s’exécute de façon asynchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-205">The `RegisterAsyncTask` method is used to register an asynchronous task containing the code which runs asynchronously.</span></span>
- <span data-ttu-id="c022c-206">La nouvelle méthode `GetGizmosSvcAsync` est marquée avec le mot clé [Async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) , qui indique au compilateur de générer des rappels pour les parties du corps et de créer automatiquement une `Task` retournée.</span><span class="sxs-lookup"><span data-stu-id="c022c-206">The new `GetGizmosSvcAsync` method is marked with the [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) keyword, which tells the compiler to generate callbacks for parts of the body and to automatically create a `Task` that is returned.</span></span>
- <span data-ttu-id="c022c-207">&quot;&quot; Async a été ajouté au nom de la méthode asynchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-207">&quot;Async&quot; was appended to the asynchronous method name.</span></span> <span data-ttu-id="c022c-208">L’ajout de « Async » n’est pas obligatoire, mais il s’agit de la Convention lors de l’écriture de méthodes asynchrones.</span><span class="sxs-lookup"><span data-stu-id="c022c-208">Appending "Async" is not required but is the convention when writing asynchronous methods.</span></span>
- <span data-ttu-id="c022c-209">Le type de retour de la nouvelle méthode `GetGizmosSvcAsync` est `Task`.</span><span class="sxs-lookup"><span data-stu-id="c022c-209">The return type of the new `GetGizmosSvcAsync` method is `Task`.</span></span> <span data-ttu-id="c022c-210">Le type de retour de `Task` représente un travail en cours et fournit aux appelants de la méthode un handle par le biais duquel attendre l’achèvement de l’opération asynchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-210">The return type of `Task` represents ongoing work and provides callers of the method with a handle through which to wait for the asynchronous operation's completion.</span></span>
- <span data-ttu-id="c022c-211">Le mot clé [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) a été appliqué à l’appel de service Web.</span><span class="sxs-lookup"><span data-stu-id="c022c-211">The [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) keyword was applied to the web service call.</span></span>
- <span data-ttu-id="c022c-212">L’API de service Web asynchrone a été appelée (`GetGizmosAsync`).</span><span class="sxs-lookup"><span data-stu-id="c022c-212">The asynchronous web service API was called (`GetGizmosAsync`).</span></span>

<span data-ttu-id="c022c-213">Dans le corps de la méthode `GetGizmosSvcAsync` une autre méthode asynchrone, `GetGizmosAsync` est appelée.</span><span class="sxs-lookup"><span data-stu-id="c022c-213">Inside of the `GetGizmosSvcAsync` method body another asynchronous method, `GetGizmosAsync` is called.</span></span> <span data-ttu-id="c022c-214">`GetGizmosAsync` retourne immédiatement un `Task<List<Gizmo>>` qui finit par se terminer lorsque les données sont disponibles.</span><span class="sxs-lookup"><span data-stu-id="c022c-214">`GetGizmosAsync` immediately returns a `Task<List<Gizmo>>` that will eventually complete when the data is available.</span></span> <span data-ttu-id="c022c-215">Étant donné que vous ne souhaitez rien faire d’autre tant que vous n’avez pas les données Gizmo, le code attend la tâche (à l’aide du mot clé **await** ).</span><span class="sxs-lookup"><span data-stu-id="c022c-215">Because you don't want to do anything else until you have the gizmo data, the code awaits the task (using the **await** keyword).</span></span> <span data-ttu-id="c022c-216">Vous pouvez utiliser le mot clé **await** uniquement dans les méthodes annotées avec le mot clé **Async** .</span><span class="sxs-lookup"><span data-stu-id="c022c-216">You can use the **await** keyword only in methods annotated with the **async** keyword.</span></span>

<span data-ttu-id="c022c-217">Le mot clé **await** ne bloque pas le thread tant que la tâche n’est pas terminée.</span><span class="sxs-lookup"><span data-stu-id="c022c-217">The **await** keyword does not block the thread until the task is complete.</span></span> <span data-ttu-id="c022c-218">Il inscrit le reste de la méthode en tant que rappel sur la tâche et retourne immédiatement.</span><span class="sxs-lookup"><span data-stu-id="c022c-218">It signs up the rest of the method as a callback on the task, and immediately returns.</span></span> <span data-ttu-id="c022c-219">Lorsque la tâche attendue finit par se terminer, elle appelle ce rappel et, par conséquent, reprend l’exécution de la méthode juste là où elle s’était arrêtée.</span><span class="sxs-lookup"><span data-stu-id="c022c-219">When the awaited task eventually completes, it will invoke that callback and thus resume the execution of the method right where it left off.</span></span> <span data-ttu-id="c022c-220">Pour plus d’informations sur l’utilisation des mots clés [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) et [Async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) et de l’espace de noms de [tâche](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) , consultez [références Async](https://docs.microsoft.com/dotnet/csharp/language-reference/keywords/async).</span><span class="sxs-lookup"><span data-stu-id="c022c-220">For more information on using the [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) and [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) keywords and the [Task](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) namespace, see the [async references](https://docs.microsoft.com/dotnet/csharp/language-reference/keywords/async).</span></span>

<span data-ttu-id="c022c-221">Le code suivant représente les méthodes `GetGizmos` et `GetGizmosAsync`.</span><span class="sxs-lookup"><span data-stu-id="c022c-221">The following code shows the `GetGizmos` and `GetGizmosAsync` methods.</span></span>

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-45/samples/sample6.cs)]

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-45/samples/sample7.cs?highlight=1,4-8)]

 <span data-ttu-id="c022c-222">Les modifications asynchrones sont similaires à celles apportées aux **GizmosAsync** ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="c022c-222">The asynchronous changes are similar to those made to the **GizmosAsync** above.</span></span> 

- <span data-ttu-id="c022c-223">La signature de la méthode a été annotée avec le mot clé [Async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) , le type de retour a été remplacé par `Task<List<Gizmo>>`et *Async* a été ajouté au nom de la méthode.</span><span class="sxs-lookup"><span data-stu-id="c022c-223">The method signature was annotated with the [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) keyword, the return type was changed to `Task<List<Gizmo>>`, and *Async* was appended to the method name.</span></span>
- <span data-ttu-id="c022c-224">La classe « [httpclient](https://msdn.microsoft.com/library/system.net.http.httpclient(VS.110).aspx) » asynchrone est utilisée à la place de la classe synchrone [WebClient](https://msdn.microsoft.com/library/system.net.webclient.aspx) .</span><span class="sxs-lookup"><span data-stu-id="c022c-224">The asynchronous [HttpClient](https://msdn.microsoft.com/library/system.net.http.httpclient(VS.110).aspx) class is used instead of the synchronous [WebClient](https://msdn.microsoft.com/library/system.net.webclient.aspx) class.</span></span>
- <span data-ttu-id="c022c-225">Le mot clé [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) a été appliqué à la méthode asynchrone [httpclient](https://msdn.microsoft.com/library/system.net.http.httpclient(VS.110).aspx)[GetAsync](https://msdn.microsoft.com/library/hh158944(VS.110).aspx) .</span><span class="sxs-lookup"><span data-stu-id="c022c-225">The [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) keyword was applied to the [HttpClient](https://msdn.microsoft.com/library/system.net.http.httpclient(VS.110).aspx)[GetAsync](https://msdn.microsoft.com/library/hh158944(VS.110).aspx) asynchronous method.</span></span>

<span data-ttu-id="c022c-226">L’illustration suivante montre la vue Gizmo asynchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-226">The following image shows the asynchronous gizmo view.</span></span>

![async](using-asynchronous-methods-in-aspnet-45/_static/image2.png)

<span data-ttu-id="c022c-228">La présentation des navigateurs des données gizmos est identique à la vue créée par l’appel synchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-228">The browsers presentation of the gizmos data is identical to the view created by the synchronous call.</span></span> <span data-ttu-id="c022c-229">La seule différence est que la version asynchrone peut être plus performante sous des charges lourdes.</span><span class="sxs-lookup"><span data-stu-id="c022c-229">The only difference is the asynchronous version may be more performant under heavy loads.</span></span>

## <a name="registerasynctask-notes"></a><span data-ttu-id="c022c-230">RegisterAsyncTask notes</span><span class="sxs-lookup"><span data-stu-id="c022c-230">RegisterAsyncTask Notes</span></span>

<span data-ttu-id="c022c-231">Les méthodes raccordées à `RegisterAsyncTask` s’exécutent immédiatement après le [prérendu](https://msdn.microsoft.com/library/ms178472.aspx).</span><span class="sxs-lookup"><span data-stu-id="c022c-231">Methods hooked up with `RegisterAsyncTask` will run immediately after [PreRender](https://msdn.microsoft.com/library/ms178472.aspx).</span></span> <span data-ttu-id="c022c-232">Vous pouvez également utiliser des événements de page void Async directement, comme indiqué dans le code suivant :</span><span class="sxs-lookup"><span data-stu-id="c022c-232">You can also use async void page events directly, as shown in the following code:</span></span>

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-45/samples/sample8.cs)]

<span data-ttu-id="c022c-233">L’inconvénient des événements void Async est que les développeurs n’ont plus le contrôle total sur le moment où les événements s’exécutent.</span><span class="sxs-lookup"><span data-stu-id="c022c-233">The downside to async void events is that developers no longer has full control over when events execute.</span></span> <span data-ttu-id="c022c-234">Par exemple, si un. aspx et un. Le maître définit `Page_Load` événements et l’un d’eux, ou les deux, sont asynchrones, l’ordre d’exécution ne peut pas être garanti.</span><span class="sxs-lookup"><span data-stu-id="c022c-234">For example, if both an .aspx and a .Master define `Page_Load` events and one or both of them are asynchronous, the order of execution can't be guaranteed.</span></span> <span data-ttu-id="c022c-235">Le même ordre de indeterminiate pour les gestionnaires d’événements non (tels que `async void Button_Click`) s’applique.</span><span class="sxs-lookup"><span data-stu-id="c022c-235">The same indeterminiate order for non event handlers (such as `async void Button_Click` ) applies.</span></span> <span data-ttu-id="c022c-236">Pour la plupart des développeurs, cela devrait être acceptable, mais ceux qui requièrent un contrôle total sur l’ordre d’exécution doivent uniquement utiliser des API comme `RegisterAsyncTask` qui consomment des méthodes qui retournent un objet de tâche.</span><span class="sxs-lookup"><span data-stu-id="c022c-236">For most developers this should be acceptable, but those who require full control over the order of execution should only use APIs like `RegisterAsyncTask` that consume methods which return a Task object.</span></span>

## <a id="Parallel"></a><span data-ttu-id="c022c-237">Exécution de plusieurs opérations en parallèle</span><span class="sxs-lookup"><span data-stu-id="c022c-237">Performing Multiple Operations in Parallel</span></span>

<span data-ttu-id="c022c-238">Les méthodes asynchrones présentent un avantage significatif par rapport aux méthodes synchrones lorsqu’une action doit effectuer plusieurs opérations indépendantes.</span><span class="sxs-lookup"><span data-stu-id="c022c-238">Asynchronous Methods have a significant advantage over synchronous methods when an action must perform several independent operations.</span></span> <span data-ttu-id="c022c-239">Dans l’exemple fourni, la page synchrone *PWG. aspx*(pour Products, widgets et gizmos) affiche les résultats de trois appels de service Web pour obtenir la liste des produits, des widgets et de gizmos.</span><span class="sxs-lookup"><span data-stu-id="c022c-239">In the sample provided, the synchronous page *PWG.aspx*(for Products, Widgets and Gizmos) displays the results of three web service calls to get a list of products, widgets, and gizmos.</span></span> <span data-ttu-id="c022c-240">Le projet [API Web ASP.net](../../../web-api/index.md) qui fournit ces services utilise [Task. Delay](https://msdn.microsoft.com/library/hh139096(VS.110).aspx) pour simuler la latence ou des appels réseau lents.</span><span class="sxs-lookup"><span data-stu-id="c022c-240">The [ASP.NET Web API](../../../web-api/index.md) project that provides these services uses [Task.Delay](https://msdn.microsoft.com/library/hh139096(VS.110).aspx) to simulate latency or slow network calls.</span></span> <span data-ttu-id="c022c-241">Lorsque le délai est défini sur 500 millisecondes, la page *PWGasync. aspx* asynchrone prend un peu plus de 500 millisecondes pour s’exécuter, tandis que la version de `PWG` synchrone prend plus de 1 500 millisecondes.</span><span class="sxs-lookup"><span data-stu-id="c022c-241">When the delay is set to 500 milliseconds, the asynchronous *PWGasync.aspx* page takes a little over 500 milliseconds to complete while the synchronous `PWG` version takes over 1,500 milliseconds.</span></span> <span data-ttu-id="c022c-242">La page *PWG. aspx* synchrone est présentée dans le code suivant.</span><span class="sxs-lookup"><span data-stu-id="c022c-242">The synchronous *PWG.aspx* page is shown in the following code.</span></span>

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-45/samples/sample9.cs)]

<span data-ttu-id="c022c-243">La `PWGasync` asynchrone du code-behind est illustrée ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="c022c-243">The asynchronous `PWGasync` code behind is shown below.</span></span>

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-45/samples/sample10.cs?highlight=5,11,21)]

<span data-ttu-id="c022c-244">L’illustration suivante montre la vue retournée à partir de la page asynchrone *PWGasync. aspx* .</span><span class="sxs-lookup"><span data-stu-id="c022c-244">The following image shows the view returned from the asynchronous *PWGasync.aspx* page.</span></span>

![](using-asynchronous-methods-in-aspnet-45/_static/image3.png)

## <a id="CancelToken"></a><span data-ttu-id="c022c-245">Utilisation d’un jeton d’annulation</span><span class="sxs-lookup"><span data-stu-id="c022c-245">Using a Cancellation Token</span></span>

<span data-ttu-id="c022c-246">Les méthodes asynchrones qui retournent `Task`peuvent être annulées, c’est-à-dire qu’elles prennent un paramètre [CancellationToken](https://msdn.microsoft.com/library/system.threading.cancellationtoken(VS.110).aspx) quand l’une d’elles est fournie avec l’attribut `AsyncTimeout` de la directive de [page](https://msdn.microsoft.com/library/ydy4x04a.aspx) .</span><span class="sxs-lookup"><span data-stu-id="c022c-246">Asynchronous Methods returning `Task`are cancelable, that is they take a [CancellationToken](https://msdn.microsoft.com/library/system.threading.cancellationtoken(VS.110).aspx) parameter when one is provided with the `AsyncTimeout` attribute of the [Page](https://msdn.microsoft.com/library/ydy4x04a.aspx) directive.</span></span> <span data-ttu-id="c022c-247">Le code suivant affiche la page *GizmosCancelAsync. aspx* avec un délai d’expiration de seconde.</span><span class="sxs-lookup"><span data-stu-id="c022c-247">The following code shows the *GizmosCancelAsync.aspx* page with a timeout of on second.</span></span>

[!code-aspx[Main](using-asynchronous-methods-in-aspnet-45/samples/sample11.aspx?highlight=1)]

<span data-ttu-id="c022c-248">Le code suivant montre le fichier *GizmosCancelAsync.aspx.cs* .</span><span class="sxs-lookup"><span data-stu-id="c022c-248">The following code shows the *GizmosCancelAsync.aspx.cs* file.</span></span>

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-45/samples/sample12.cs?highlight=6,9)]

<span data-ttu-id="c022c-249">Dans l’exemple d’application fourni, la sélection du lien *GizmosCancelAsync* appelle la page *GizmosCancelAsync. aspx* et montre l’annulation (par expiration) de l’appel asynchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-249">In the sample application provided, selecting the *GizmosCancelAsync* link calls the *GizmosCancelAsync.aspx* page and demonstrates the cancellation (by timing out) of the asynchronous call.</span></span> <span data-ttu-id="c022c-250">Étant donné que le délai est compris dans une plage aléatoire, vous devrez peut-être actualiser la page plusieurs fois pour obtenir le message d’erreur de délai d’attente.</span><span class="sxs-lookup"><span data-stu-id="c022c-250">Because the delay time is within a random range, you might need to refresh the page a couple times to get the time out error message.</span></span>

## <a id="ServerConfig"></a><span data-ttu-id="c022c-251">Configuration du serveur pour les appels de service Web avec concurrence élevée/latence élevée</span><span class="sxs-lookup"><span data-stu-id="c022c-251">Server Configuration for High Concurrency/High Latency Web Service Calls</span></span>

<span data-ttu-id="c022c-252">Pour tirer parti des avantages d’une application Web asynchrone, vous devrez peut-être apporter des modifications à la configuration du serveur par défaut.</span><span class="sxs-lookup"><span data-stu-id="c022c-252">To realize the benefits of an asynchronous web application, you might need to make some changes to the default server configuration.</span></span> <span data-ttu-id="c022c-253">Gardez à l’esprit les points suivants lors de la configuration et du test de stress de votre application Web asynchrone.</span><span class="sxs-lookup"><span data-stu-id="c022c-253">Keep the following in mind when configuring and stress testing your asynchronous web application.</span></span>

- <span data-ttu-id="c022c-254">Windows 7, Windows Vista, Windows 8 et tous les systèmes d’exploitation clients Windows ont un maximum de 10 demandes simultanées.</span><span class="sxs-lookup"><span data-stu-id="c022c-254">Windows 7, Windows Vista, Window 8, and all Windows client operating systems have a maximum of 10 concurrent requests.</span></span> <span data-ttu-id="c022c-255">Vous aurez besoin d’un système d’exploitation Windows Server pour voir les avantages des méthodes asynchrones sous une charge élevée.</span><span class="sxs-lookup"><span data-stu-id="c022c-255">You'll need a Windows Server operating system to see the benefits of asynchronous methods under high load.</span></span>
- <span data-ttu-id="c022c-256">Inscrivez .NET 4,5 avec IIS à partir d’une invite de commandes avec élévation de privilèges à l’aide de la commande suivante :</span><span class="sxs-lookup"><span data-stu-id="c022c-256">Register .NET 4.5 with IIS from an elevated command prompt using the following command:</span></span>  
  <span data-ttu-id="c022c-257">%windir%\Microsoft.NET\Framework64 \v4.0.30319\aspnet\_regiis-i</span><span class="sxs-lookup"><span data-stu-id="c022c-257">%windir%\Microsoft.NET\Framework64 \v4.0.30319\aspnet\_regiis -i</span></span>  
  <span data-ttu-id="c022c-258">Consultez [ASP.NET IIS Registration Tool (Aspnet\_regiis. exe)](https://msdn.microsoft.com/library/k6h9cz8h.aspx)</span><span class="sxs-lookup"><span data-stu-id="c022c-258">See    [ASP.NET IIS Registration Tool (Aspnet\_regiis.exe)](https://msdn.microsoft.com/library/k6h9cz8h.aspx)</span></span>
- <span data-ttu-id="c022c-259">Vous devrez peut-être augmenter la limite de file d’attente [http. sys](https://www.iis.net/learn/get-started/introduction-to-iis/introduction-to-iis-architecture) de la valeur par défaut 1 000 à 5 000.</span><span class="sxs-lookup"><span data-stu-id="c022c-259">You might need to increase the [HTTP.sys](https://www.iis.net/learn/get-started/introduction-to-iis/introduction-to-iis-architecture) queue limit from the default value of 1,000 to 5,000.</span></span> <span data-ttu-id="c022c-260">Si le paramètre est trop bas, vous pouvez voir que [http. sys](https://www.iis.net/learn/get-started/introduction-to-iis/introduction-to-iis-architecture) rejette les demandes avec un état HTTP 503.</span><span class="sxs-lookup"><span data-stu-id="c022c-260">If the setting is too low, you may see [HTTP.sys](https://www.iis.net/learn/get-started/introduction-to-iis/introduction-to-iis-architecture) reject requests with a HTTP 503 status.</span></span> <span data-ttu-id="c022c-261">Pour modifier la limite de file d’attente HTTP. sys :</span><span class="sxs-lookup"><span data-stu-id="c022c-261">To change the HTTP.sys queue limit:</span></span>

    - <span data-ttu-id="c022c-262">Ouvrez le gestionnaire des services Internet et accédez au volet pools d’applications.</span><span class="sxs-lookup"><span data-stu-id="c022c-262">Open IIS manager and navigate to the Application Pools pane.</span></span>
    - <span data-ttu-id="c022c-263">Cliquez avec le bouton droit sur le pool d’applications cible et sélectionnez **Paramètres avancés**.</span><span class="sxs-lookup"><span data-stu-id="c022c-263">Right click on the target application pool and select **Advanced Settings**.</span></span>  
        <span data-ttu-id="c022c-264">![](using-asynchronous-methods-in-aspnet-45/_static/image4.png) avancé</span><span class="sxs-lookup"><span data-stu-id="c022c-264">![advanced](using-asynchronous-methods-in-aspnet-45/_static/image4.png)</span></span>
    - <span data-ttu-id="c022c-265">Dans la boîte de dialogue **Paramètres avancés** , changez la longueur de la *file d’attente* de 1 000 à 5 000.</span><span class="sxs-lookup"><span data-stu-id="c022c-265">In the **Advanced Settings** dialog box, change *Queue Length* from 1,000 to 5,000.</span></span>  
        <span data-ttu-id="c022c-266">longueur de la file d’attente ![](using-asynchronous-methods-in-aspnet-45/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="c022c-266">![Queue length](using-asynchronous-methods-in-aspnet-45/_static/image5.png)</span></span>  
  
  <span data-ttu-id="c022c-267">Remarque dans les images ci-dessus, le .NET Framework est listé comme v 4.0, même si le pool d’applications utilise .NET 4,5.</span><span class="sxs-lookup"><span data-stu-id="c022c-267">Note in the images above, the .NET framework is listed as v4.0, even though the application pool is using .NET 4.5.</span></span> <span data-ttu-id="c022c-268">Pour comprendre cette différence, consultez les rubriques suivantes :</span><span class="sxs-lookup"><span data-stu-id="c022c-268">To understand this discrepancy, see the following:</span></span>

- [<span data-ttu-id="c022c-269">Contrôle de version .NET et multi-ciblage-.NET 4,5 est une mise à niveau sur place vers .NET 4,0</span><span class="sxs-lookup"><span data-stu-id="c022c-269">.NET Versioning and Multi-Targeting - .NET 4.5 is an in-place upgrade to .NET 4.0</span></span>](http://www.hanselman.com/blog/NETVersioningAndMultiTargetingNET45IsAnInplaceUpgradeToNET40.aspx)
- [<span data-ttu-id="c022c-270">Comment définir une application IIS ou un pool d’applications pour utiliser ASP.NET 3,5 au lieu de 2,0</span><span class="sxs-lookup"><span data-stu-id="c022c-270">How to set an IIS Application or AppPool to use ASP.NET 3.5 rather than 2.0</span></span>](http://www.hanselman.com/blog/HowToSetAnIISApplicationOrAppPoolToUseASPNET35RatherThan20.aspx)
- <span data-ttu-id="c022c-271">[Versions et dépendances de .NET Framework](https://msdn.microsoft.com/library/bb822049(VS.110).aspx)</span><span class="sxs-lookup"><span data-stu-id="c022c-271">[.NET Framework Versions and Dependencies](https://msdn.microsoft.com/library/bb822049(VS.110).aspx)</span></span>

- <span data-ttu-id="c022c-272">Si votre application utilise des services Web ou System.NET pour communiquer avec un serveur principal via HTTP, vous devrez peut-être augmenter l’élément [connectionManagement/MaxConnection](https://msdn.microsoft.com/library/fb6y0fyc(VS.110).aspx) .</span><span class="sxs-lookup"><span data-stu-id="c022c-272">If your application is using web services or System.NET to communicate with a backend over HTTP you may need to increase the [connectionManagement/maxconnection](https://msdn.microsoft.com/library/fb6y0fyc(VS.110).aspx) element.</span></span> <span data-ttu-id="c022c-273">Pour les applications ASP.NET, cela est limité par la fonctionnalité de configuration automatique à 12 fois le nombre de processeurs.</span><span class="sxs-lookup"><span data-stu-id="c022c-273">For ASP.NET applications, this is limited by the autoConfig feature to 12 times the number of CPUs.</span></span> <span data-ttu-id="c022c-274">Cela signifie que sur un Quad-proc, vous pouvez avoir au maximum 12 \* 4 = 48 connexions simultanées à un point de terminaison IP.</span><span class="sxs-lookup"><span data-stu-id="c022c-274">That means that on a quad-proc, you can have at most 12 \* 4 = 48 concurrent connections to an IP end point.</span></span> <span data-ttu-id="c022c-275">Étant donné que cela est lié à la [configuration automatique](https://msdn.microsoft.com/library/7w2sway1(VS.110).aspx), le moyen le plus simple d’augmenter `maxconnection` dans une application ASP.net consiste à définir [System .net. ServicePointManager. DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit(VS.110).aspx) par programmation dans la méthode from `Application_Start` dans le fichier *global. asax* .</span><span class="sxs-lookup"><span data-stu-id="c022c-275">Because this is tied to [autoConfig](https://msdn.microsoft.com/library/7w2sway1(VS.110).aspx), the easiest way to increase `maxconnection` in an ASP.NET application is to set [System.Net.ServicePointManager.DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit(VS.110).aspx) programmatically in the from `Application_Start` method in the *global.asax* file.</span></span> <span data-ttu-id="c022c-276">Consultez l’exemple de téléchargement pour obtenir un exemple.</span><span class="sxs-lookup"><span data-stu-id="c022c-276">See the sample download for an example.</span></span>
- <span data-ttu-id="c022c-277">Dans .NET 4,5, la valeur par défaut 5000 pour [MaxConcurrentRequestsPerCPU](https://blogs.msdn.com/tmarq/archive/2007/07/21/asp-net-thread-usage-on-iis-7-0-and-6-0.aspx) doit être correcte.</span><span class="sxs-lookup"><span data-stu-id="c022c-277">In .NET 4.5, the default of 5000 for [MaxConcurrentRequestsPerCPU](https://blogs.msdn.com/tmarq/archive/2007/07/21/asp-net-thread-usage-on-iis-7-0-and-6-0.aspx) should be fine.</span></span>

## <a name="contributors"></a><span data-ttu-id="c022c-278">Contributors</span><span class="sxs-lookup"><span data-stu-id="c022c-278">Contributors</span></span>

- [<span data-ttu-id="c022c-279">Broderick de prélèvement</span><span class="sxs-lookup"><span data-stu-id="c022c-279">Levi Broderick</span></span>](http://stackoverflow.com/users/59641/levi)
- [<span data-ttu-id="c022c-280">Tom Dykstra</span><span class="sxs-lookup"><span data-stu-id="c022c-280">Tom Dykstra</span></span>](http://www.bing.com/search?q=site%3Aasp.net+%22Tom+Dykstra%22+-forums.asp.net&amp;qs=n&amp;form=QBRE&amp;pq=site%3Aasp.net+%22tom+dykstra%22+-forums.asp.net&amp;sc=8-42&amp;sp=-1&amp;sk=)
- [<span data-ttu-id="c022c-281">Brad Wilson</span><span class="sxs-lookup"><span data-stu-id="c022c-281">Brad Wilson</span></span>](http://bradwilson.typepad.com/)
- [<span data-ttu-id="c022c-282">HongMei GE</span><span class="sxs-lookup"><span data-stu-id="c022c-282">HongMei Ge</span></span>](https://blogs.msdn.com/b/hongmeig/)
