---
uid: mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application
title: Implémentation du référentiel et des modèles d’unité de travail dans une application ASP.NET MVC (9 sur 10) | Microsoft Docs
author: tdykstra
description: L’exemple d’application Web Contoso University montre comment créer des applications ASP.NET MVC 4 à l’aide de la Entity Framework 5 Code First et Visual Studio...
ms.author: riande
ms.date: 07/30/2013
ms.assetid: 44761193-04ba-4990-9f90-145d3c10a716
msc.legacyurl: /mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 18de9b125ee5d10795b9ce1a366918dadf4fc4e3
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 11/28/2019
ms.locfileid: "74595245"
---
# <a name="implementing-the-repository-and-unit-of-work-patterns-in-an-aspnet-mvc-application-9-of-10"></a><span data-ttu-id="d2f25-103">Implémentation du référentiel et des modèles d’unité de travail dans une application ASP.NET MVC (9 sur 10)</span><span class="sxs-lookup"><span data-stu-id="d2f25-103">Implementing the Repository and Unit of Work Patterns in an ASP.NET MVC Application (9 of 10)</span></span>

<span data-ttu-id="d2f25-104">par [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="d2f25-104">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

[<span data-ttu-id="d2f25-105">Télécharger le projet terminé</span><span class="sxs-lookup"><span data-stu-id="d2f25-105">Download Completed Project</span></span>](https://code.msdn.microsoft.com/Getting-Started-with-dd0e2ed8)

> <span data-ttu-id="d2f25-106">L’exemple d’application Web Contoso University montre comment créer des applications ASP.NET MVC 4 à l’aide de la Entity Framework 5 Code First et de Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="d2f25-106">The Contoso University sample web application demonstrates how to create ASP.NET MVC 4 applications using the Entity Framework 5 Code First and Visual Studio 2012.</span></span> <span data-ttu-id="d2f25-107">Pour obtenir des informations sur la série de didacticiels, consultez [le premier didacticiel de la série](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span><span class="sxs-lookup"><span data-stu-id="d2f25-107">For information about the tutorial series, see [the first tutorial in the series](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span> <span data-ttu-id="d2f25-108">Vous pouvez démarrer la série de didacticiels depuis le début ou [Télécharger un projet de démarrage pour ce chapitre](building-the-ef5-mvc4-chapter-downloads.md) et démarrer ici.</span><span class="sxs-lookup"><span data-stu-id="d2f25-108">You can start the tutorial series from the beginning or [download a starter project for this chapter](building-the-ef5-mvc4-chapter-downloads.md) and start here.</span></span>
> 
> > [!NOTE] 
> > 
> > <span data-ttu-id="d2f25-109">Si vous rencontrez un problème que vous ne pouvez pas résoudre, [Téléchargez le chapitre terminé](building-the-ef5-mvc4-chapter-downloads.md) et essayez de reproduire le problème.</span><span class="sxs-lookup"><span data-stu-id="d2f25-109">If you run into a problem you can't resolve, [download the completed chapter](building-the-ef5-mvc4-chapter-downloads.md) and try to reproduce your problem.</span></span> <span data-ttu-id="d2f25-110">Vous pouvez généralement trouver la solution au problème en comparant votre code au code terminé.</span><span class="sxs-lookup"><span data-stu-id="d2f25-110">You can generally find the solution to the problem by comparing your code to the completed code.</span></span> <span data-ttu-id="d2f25-111">Pour obtenir des erreurs courantes et comment les résoudre, consultez [Erreurs et solutions de contournement.](advanced-entity-framework-scenarios-for-an-mvc-web-application.md#errors)</span><span class="sxs-lookup"><span data-stu-id="d2f25-111">For some common errors and how to solve them, see [Errors and Workarounds.](advanced-entity-framework-scenarios-for-an-mvc-web-application.md#errors)</span></span>

<span data-ttu-id="d2f25-112">Dans le didacticiel précédent, vous avez utilisé l’héritage pour réduire le code redondant dans les classes d’entité `Student` et `Instructor`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-112">In the previous tutorial you used inheritance to reduce redundant code in the `Student` and `Instructor` entity classes.</span></span> <span data-ttu-id="d2f25-113">Dans ce didacticiel, vous allez découvrir des façons d’utiliser le référentiel et les modèles d’unité de travail pour les opérations CRUD.</span><span class="sxs-lookup"><span data-stu-id="d2f25-113">In this tutorial you'll see some ways to use the repository and unit of work patterns for CRUD operations.</span></span> <span data-ttu-id="d2f25-114">Comme dans le didacticiel précédent, vous allez modifier le mode de fonctionnement de votre code avec les pages que vous avez déjà créées au lieu de créer des pages.</span><span class="sxs-lookup"><span data-stu-id="d2f25-114">As in the previous tutorial, in this one you'll change the way your code works with pages you already created rather than creating new pages.</span></span>

## <a name="the-repository-and-unit-of-work-patterns"></a><span data-ttu-id="d2f25-115">Le référentiel et les modèles d’unité de travail</span><span class="sxs-lookup"><span data-stu-id="d2f25-115">The Repository and Unit of Work Patterns</span></span>

<span data-ttu-id="d2f25-116">Le référentiel et les modèles d’unité de travail sont conçus pour créer une couche d’abstraction entre la couche d’accès aux données et la couche de logique métier d’une application.</span><span class="sxs-lookup"><span data-stu-id="d2f25-116">The repository and unit of work patterns are intended to create an abstraction layer between the data access layer and the business logic layer of an application.</span></span> <span data-ttu-id="d2f25-117">L’implémentation de ces modèles peut favoriser l’isolation de votre application face à des modifications dans le magasin de données et peut faciliter le test unitaire automatisé ou le développement piloté par les tests (TDD).</span><span class="sxs-lookup"><span data-stu-id="d2f25-117">Implementing these patterns can help insulate your application from changes in the data store and can facilitate automated unit testing or test-driven development (TDD).</span></span>

<span data-ttu-id="d2f25-118">Dans ce didacticiel, vous allez implémenter une classe de référentiel pour chaque type d’entité.</span><span class="sxs-lookup"><span data-stu-id="d2f25-118">In this tutorial you'll implement a repository class for each entity type.</span></span> <span data-ttu-id="d2f25-119">Pour le type d’entité `Student`, vous allez créer une interface de référentiel et une classe de référentiel.</span><span class="sxs-lookup"><span data-stu-id="d2f25-119">For the `Student` entity type you'll create a repository interface and a repository class.</span></span> <span data-ttu-id="d2f25-120">Lorsque vous instanciez le référentiel dans votre contrôleur, vous utilisez l’interface afin que le contrôleur accepte une référence à n’importe quel objet qui implémente l’interface de référentiel.</span><span class="sxs-lookup"><span data-stu-id="d2f25-120">When you instantiate the repository in your controller, you'll use the interface so that the controller will accept a reference to any object that implements the repository interface.</span></span> <span data-ttu-id="d2f25-121">Lorsque le contrôleur s’exécute sous un serveur Web, il reçoit un référentiel qui fonctionne avec le Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d2f25-121">When the controller runs under a web server, it receives a repository that works with the Entity Framework.</span></span> <span data-ttu-id="d2f25-122">Lorsque le contrôleur s’exécute sous une classe de test unitaire, il reçoit un référentiel qui fonctionne avec les données stockées d’une manière que vous pouvez facilement manipuler à des fins de test, telles qu’une collection en mémoire.</span><span class="sxs-lookup"><span data-stu-id="d2f25-122">When the controller runs under a unit test class, it receives a repository that works with data stored in a way that you can easily manipulate for testing, such as an in-memory collection.</span></span>

<span data-ttu-id="d2f25-123">Plus loin dans ce didacticiel, vous utiliserez plusieurs référentiels et une classe d’unité de travail pour les `Course` et les types d’entités `Department` dans le contrôleur de `Course`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-123">Later in the tutorial you'll use multiple repositories and a unit of work class for the `Course` and `Department` entity types in the `Course` controller.</span></span> <span data-ttu-id="d2f25-124">La classe Unit of Work coordonne le travail de plusieurs dépôts en créant une classe de contexte de base de données unique partagée par toutes.</span><span class="sxs-lookup"><span data-stu-id="d2f25-124">The unit of work class coordinates the work of multiple repositories by creating a single database context class shared by all of them.</span></span> <span data-ttu-id="d2f25-125">Si vous souhaitez être en mesure d’effectuer des tests unitaires automatisés, vous devez créer et utiliser des interfaces pour ces classes de la même façon que pour le référentiel `Student`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-125">If you wanted to be able to perform automated unit testing, you'd create and use interfaces for these classes in the same way you did for the `Student` repository.</span></span> <span data-ttu-id="d2f25-126">Toutefois, pour simplifier le didacticiel, vous allez créer et utiliser ces classes sans interfaces.</span><span class="sxs-lookup"><span data-stu-id="d2f25-126">However, to keep the tutorial simple, you'll create and use these classes without interfaces.</span></span>

<span data-ttu-id="d2f25-127">L’illustration suivante montre une façon de conceptualiser les relations entre le contrôleur et les classes de contexte par rapport à l’utilisation du modèle de référentiel ou d’unité de travail du tout.</span><span class="sxs-lookup"><span data-stu-id="d2f25-127">The following illustration shows one way to conceptualize the relationships between the controller and context classes compared to not using the repository or unit of work pattern at all.</span></span>

![Repository_pattern_diagram](https://asp.net/media/2578149/Windows-Live-Writer_8c4963ba1fa3_CE3B_Repository_pattern_diagram_1df790d3-bdf2-4c11-9098-946ddd9cd884.png)

<span data-ttu-id="d2f25-129">Vous ne créerez pas de tests unitaires dans cette série de didacticiels.</span><span class="sxs-lookup"><span data-stu-id="d2f25-129">You won't create unit tests in this tutorial series.</span></span> <span data-ttu-id="d2f25-130">Pour une introduction au TDD avec une application MVC qui utilise le modèle de référentiel, consultez [procédure pas à pas : utilisation de TDD avec ASP.NET MVC](https://msdn.microsoft.com/library/ff847525.aspx).</span><span class="sxs-lookup"><span data-stu-id="d2f25-130">For an introduction to TDD with an MVC application that uses the repository pattern, see [Walkthrough: Using TDD with ASP.NET MVC](https://msdn.microsoft.com/library/ff847525.aspx).</span></span> <span data-ttu-id="d2f25-131">Pour plus d’informations sur le modèle de référentiel, consultez les ressources suivantes :</span><span class="sxs-lookup"><span data-stu-id="d2f25-131">For more information about the repository pattern, see the following resources:</span></span>

- <span data-ttu-id="d2f25-132">[Le modèle de référentiel](https://msdn.microsoft.com/library/ff649690.aspx) sur MSDN.</span><span class="sxs-lookup"><span data-stu-id="d2f25-132">[The Repository Pattern](https://msdn.microsoft.com/library/ff649690.aspx) on MSDN.</span></span>
- <span data-ttu-id="d2f25-133">[Utilisation du référentiel et des modèles d’unité de travail avec Entity Framework 4,0](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) sur le blog de l’équipe Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d2f25-133">[Using Repository and Unit of Work patterns with Entity Framework 4.0](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) on the Entity Framework team blog.</span></span>
- <span data-ttu-id="d2f25-134">Le blog de la série de publications [Agile Entity Framework 4](http://thedatafarm.com/blog/data-access/agile-entity-framework-4-repository-part-1-model-and-poco-classes/) sur Julie Lerman.</span><span class="sxs-lookup"><span data-stu-id="d2f25-134">[Agile Entity Framework 4 Repository](http://thedatafarm.com/blog/data-access/agile-entity-framework-4-repository-part-1-model-and-poco-classes/) series of posts on Julie Lerman's blog.</span></span>
- <span data-ttu-id="d2f25-135">[Création du compte en un clin d’œil sur l’application HTML5/jQuery](https://weblogs.asp.net/dwahlin/archive/2011/08/15/building-the-account-at-a-glance-html5-jquery-application.aspx) sur le blog de Dan Wahlin.</span><span class="sxs-lookup"><span data-stu-id="d2f25-135">[Building the Account at a Glance HTML5/jQuery Application](https://weblogs.asp.net/dwahlin/archive/2011/08/15/building-the-account-at-a-glance-html5-jquery-application.aspx) on Dan Wahlin's blog.</span></span>

> [!NOTE]
> <span data-ttu-id="d2f25-136">Il existe de nombreuses façons d’implémenter le référentiel et les modèles d’unité de travail.</span><span class="sxs-lookup"><span data-stu-id="d2f25-136">There are many ways to implement the repository and unit of work patterns.</span></span> <span data-ttu-id="d2f25-137">Vous pouvez utiliser des classes de référentiel avec ou sans classe d’unité de travail.</span><span class="sxs-lookup"><span data-stu-id="d2f25-137">You can use repository classes with or without a unit of work class.</span></span> <span data-ttu-id="d2f25-138">Vous pouvez implémenter un référentiel unique pour tous les types d’entité, ou un pour chaque type.</span><span class="sxs-lookup"><span data-stu-id="d2f25-138">You can implement a single repository for all entity types, or one for each type.</span></span> <span data-ttu-id="d2f25-139">Si vous implémentez un pour chaque type, vous pouvez utiliser des classes distinctes, une classe de base générique et des classes dérivées, ou une classe de base abstraite et des classes dérivées.</span><span class="sxs-lookup"><span data-stu-id="d2f25-139">If you implement one for each type, you can use separate classes, a generic base class and derived classes, or an abstract base class and derived classes.</span></span> <span data-ttu-id="d2f25-140">Vous pouvez inclure la logique métier dans votre référentiel ou la limiter à la logique d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="d2f25-140">You can include business logic in your repository or restrict it to data access logic.</span></span> <span data-ttu-id="d2f25-141">Vous pouvez également créer une couche d’abstraction dans votre classe de contexte de base de données en utilisant des interfaces [IDbSet](https://msdn.microsoft.com/library/gg679233(v=vs.103).aspx) à la place de types [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) pour vos jeux d’entités.</span><span class="sxs-lookup"><span data-stu-id="d2f25-141">You can also build an abstraction layer into your database context class by using [IDbSet](https://msdn.microsoft.com/library/gg679233(v=vs.103).aspx) interfaces there instead of [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) types for your entity sets.</span></span> <span data-ttu-id="d2f25-142">L’approche de l’implémentation d’une couche d’abstraction présentée dans ce didacticiel est une option que vous devez prendre en compte, et non une recommandation pour tous les scénarios et environnements.</span><span class="sxs-lookup"><span data-stu-id="d2f25-142">The approach to implementing an abstraction layer shown in this tutorial is one option for you to consider, not a recommendation for all scenarios and environments.</span></span>

## <a name="creating-the-student-repository-class"></a><span data-ttu-id="d2f25-143">Création de la classe de référentiel Student</span><span class="sxs-lookup"><span data-stu-id="d2f25-143">Creating the Student Repository Class</span></span>

<span data-ttu-id="d2f25-144">Dans le dossier *dal* , créez un fichier de classe nommé *IStudentRepository.cs* et remplacez le code existant par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="d2f25-144">In the *DAL* folder, create a class file named *IStudentRepository.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample1.cs)]

<span data-ttu-id="d2f25-145">Ce code déclare un ensemble standard de méthodes CRUD, y compris deux méthodes de lecture (une qui retourne toutes les entités `Student`) et une autre qui trouve une seule entité `Student` par ID.</span><span class="sxs-lookup"><span data-stu-id="d2f25-145">This code declares a typical set of CRUD methods, including two read methods — one that returns all `Student` entities, and one that finds a single `Student` entity by ID.</span></span>

<span data-ttu-id="d2f25-146">Dans le dossier *dal* , créez un fichier de classe nommé *StudentRepository.cs* .</span><span class="sxs-lookup"><span data-stu-id="d2f25-146">In the *DAL* folder, create a class file named *StudentRepository.cs* file.</span></span> <span data-ttu-id="d2f25-147">Remplacez le code existant par le code suivant, qui implémente l’interface `IStudentRepository` :</span><span class="sxs-lookup"><span data-stu-id="d2f25-147">Replace the existing code with the following code, which implements the `IStudentRepository` interface:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample2.cs)]

<span data-ttu-id="d2f25-148">Le contexte de base de données est défini dans une variable de classe et le constructeur s’attend à ce que l’objet appelant passe dans une instance du contexte :</span><span class="sxs-lookup"><span data-stu-id="d2f25-148">The database context is defined in a class variable, and the constructor expects the calling object to pass in an instance of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample3.cs)]

<span data-ttu-id="d2f25-149">Vous pouvez instancier un nouveau contexte dans le référentiel, mais si vous avez utilisé plusieurs référentiels dans un contrôleur, chacun finit par un contexte distinct.</span><span class="sxs-lookup"><span data-stu-id="d2f25-149">You could instantiate a new context in the repository, but then if you used multiple repositories in one controller, each would end up with a separate context.</span></span> <span data-ttu-id="d2f25-150">Plus tard, vous utiliserez plusieurs référentiels dans le contrôleur `Course`, et vous verrez comment une classe d’unité de travail peut garantir que tous les dépôts utilisent le même contexte.</span><span class="sxs-lookup"><span data-stu-id="d2f25-150">Later you'll use multiple repositories in the `Course` controller, and you'll see how a unit of work class can ensure that all repositories use the same context.</span></span>

<span data-ttu-id="d2f25-151">Le référentiel implémente [IDisposable](https://msdn.microsoft.com/library/system.idisposable.aspx) et supprime le contexte de base de données tel que vous l’avez vu précédemment dans le contrôleur, et ses méthodes CRUD effectuent des appels au contexte de la base de données de la même façon que vous l’avez vu précédemment.</span><span class="sxs-lookup"><span data-stu-id="d2f25-151">The repository implements [IDisposable](https://msdn.microsoft.com/library/system.idisposable.aspx) and disposes the database context as you saw earlier in the controller, and its CRUD methods make calls to the database context in the same way that you saw earlier.</span></span>

## <a name="change-the-student-controller-to-use-the-repository"></a><span data-ttu-id="d2f25-152">Changer le contrôleur d’étudiant pour utiliser le référentiel</span><span class="sxs-lookup"><span data-stu-id="d2f25-152">Change the Student Controller to Use the Repository</span></span>

<span data-ttu-id="d2f25-153">Dans *StudentController.cs*, remplacez le code actuellement dans la classe par le code suivant.</span><span class="sxs-lookup"><span data-stu-id="d2f25-153">In *StudentController.cs*, replace the code currently in the class with the following code.</span></span> <span data-ttu-id="d2f25-154">Les modifications sont mises en surbrillance.</span><span class="sxs-lookup"><span data-stu-id="d2f25-154">The changes are highlighted.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample4.cs?highlight=13-18,44,75,77,102-103,120,137-138,159,172-174,186)]

<span data-ttu-id="d2f25-155">Le contrôleur déclare maintenant une variable de classe pour un objet qui implémente l’interface `IStudentRepository` au lieu de la classe de contexte :</span><span class="sxs-lookup"><span data-stu-id="d2f25-155">The controller now declares a class variable for an object that implements the `IStudentRepository` interface instead of the context class:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample5.cs)]

<span data-ttu-id="d2f25-156">Le constructeur par défaut (sans paramètre) crée une nouvelle instance de contexte et un constructeur facultatif permet à l’appelant de passer une instance de contexte.</span><span class="sxs-lookup"><span data-stu-id="d2f25-156">The default (parameterless) constructor creates a new context instance, and an optional constructor allows the caller to pass in a context instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample6.cs)]

<span data-ttu-id="d2f25-157">(Si vous utilisiez l' *injection de dépendances*, ou di, vous n’auriez pas besoin du constructeur par défaut, car le logiciel di s’assure que l’objet de référentiel correct serait toujours fourni.)</span><span class="sxs-lookup"><span data-stu-id="d2f25-157">(If you were using *dependency injection*, or DI, you wouldn't need the default constructor because the DI software would ensure that the correct repository object would always be provided.)</span></span>

<span data-ttu-id="d2f25-158">Dans les méthodes CRUD, le référentiel est maintenant appelé à la place du contexte :</span><span class="sxs-lookup"><span data-stu-id="d2f25-158">In the CRUD methods, the repository is now called instead of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample7.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample8.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample9.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample10.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample11.cs)]

<span data-ttu-id="d2f25-159">La méthode `Dispose` supprime maintenant le référentiel au lieu du contexte :</span><span class="sxs-lookup"><span data-stu-id="d2f25-159">And the `Dispose` method now disposes the repository instead of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample12.cs)]

<span data-ttu-id="d2f25-160">Exécutez le site et cliquez sur l’onglet **students** .</span><span class="sxs-lookup"><span data-stu-id="d2f25-160">Run the site and click the **Students** tab.</span></span>

![Students_Index_page](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image1.png)

<span data-ttu-id="d2f25-162">La page s’affiche et fonctionne de la même manière qu’avant la modification du code pour utiliser le référentiel, et les autres pages Student fonctionnent également de la même façon.</span><span class="sxs-lookup"><span data-stu-id="d2f25-162">The page looks and works the same as it did before you changed the code to use the repository, and the other Student pages also work the same.</span></span> <span data-ttu-id="d2f25-163">Toutefois, il existe une différence importante dans la façon dont la méthode `Index` du contrôleur effectue le filtrage et le tri.</span><span class="sxs-lookup"><span data-stu-id="d2f25-163">However, there's an important difference in the way the `Index` method of the controller does filtering and ordering.</span></span> <span data-ttu-id="d2f25-164">La version d’origine de cette méthode contenait le code suivant :</span><span class="sxs-lookup"><span data-stu-id="d2f25-164">The original version of this method contained the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample13.cs?highlight=1)]

<span data-ttu-id="d2f25-165">La méthode `Index` mise à jour contient le code suivant :</span><span class="sxs-lookup"><span data-stu-id="d2f25-165">The updated `Index` method contains the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample14.cs?highlight=1)]

<span data-ttu-id="d2f25-166">Seul le code en surbrillance a été modifié.</span><span class="sxs-lookup"><span data-stu-id="d2f25-166">Only the highlighted code has changed.</span></span>

<span data-ttu-id="d2f25-167">Dans la version d’origine du code, `students` est tapé comme un objet `IQueryable`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-167">In the original version of the code, `students` is typed as an `IQueryable` object.</span></span> <span data-ttu-id="d2f25-168">La requête n’est pas envoyée à la base de données tant qu’elle n’est pas convertie en collection à l’aide d’une méthode telle que `ToList`, ce qui ne se produit pas tant que la vue index n’accède pas au modèle Student.</span><span class="sxs-lookup"><span data-stu-id="d2f25-168">The query isn't sent to the database until it's converted into a collection using a method such as `ToList`, which doesn't occur until the Index view accesses the student model.</span></span> <span data-ttu-id="d2f25-169">La méthode `Where` dans le code d’origine ci-dessus devient une clause `WHERE` dans la requête SQL qui est envoyée à la base de données.</span><span class="sxs-lookup"><span data-stu-id="d2f25-169">The `Where` method in the original code above becomes a `WHERE` clause in the SQL query that is sent to the database.</span></span> <span data-ttu-id="d2f25-170">Cela signifie que seules les entités sélectionnées sont retournées par la base de données.</span><span class="sxs-lookup"><span data-stu-id="d2f25-170">That in turn means that only the selected entities are returned by the database.</span></span> <span data-ttu-id="d2f25-171">Toutefois, suite à la modification de `context.Students` en `studentRepository.GetStudents()`, la variable `students` après cette instruction est une collection `IEnumerable` qui comprend tous les étudiants dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="d2f25-171">However, as a result of changing `context.Students` to `studentRepository.GetStudents()`, the `students` variable after this statement is an `IEnumerable` collection that includes all students in the database.</span></span> <span data-ttu-id="d2f25-172">Le résultat final de l’application de la méthode `Where` est le même, mais à présent le travail est effectué en mémoire sur le serveur Web et non pas par la base de données.</span><span class="sxs-lookup"><span data-stu-id="d2f25-172">The end result of applying the `Where` method is the same, but now the work is done in memory on the web server and not by the database.</span></span> <span data-ttu-id="d2f25-173">Pour les requêtes qui retournent de gros volumes de données, cela peut s’avérer inefficace.</span><span class="sxs-lookup"><span data-stu-id="d2f25-173">For queries that return large volumes of data, this can be inefficient.</span></span>

> [!TIP]
> 
> <span data-ttu-id="d2f25-174">**IQueryable et IEnumerable**</span><span class="sxs-lookup"><span data-stu-id="d2f25-174">**IQueryable vs. IEnumerable**</span></span>
> 
> <span data-ttu-id="d2f25-175">Une fois que vous avez implémenté le référentiel comme indiqué ici, même si vous entrez un nom dans la zone de **recherche** , la requête envoyée à SQL Server retourne toutes les lignes de l’étudiant, car il n’inclut pas vos critères de recherche :</span><span class="sxs-lookup"><span data-stu-id="d2f25-175">After you implement the repository as shown here, even if you enter something in the **Search** box the query sent to SQL Server returns all Student rows because it doesn't include your search criteria:</span></span>
> 
> ![](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image2.png)
> 
> [!code-sql[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample15.sql)]
> 
> <span data-ttu-id="d2f25-176">Cette requête retourne toutes les données de l’étudiant, car le référentiel a exécuté la requête sans connaître les critères de recherche.</span><span class="sxs-lookup"><span data-stu-id="d2f25-176">This query returns all of the student data because the repository executed the query without knowing about the search criteria.</span></span> <span data-ttu-id="d2f25-177">Le processus de tri, d’application des critères de recherche et de sélection d’un sous-ensemble de données pour la pagination (avec seulement 3 lignes dans ce cas) est effectué en mémoire ultérieurement lorsque la méthode `ToPagedList` est appelée sur la collection `IEnumerable`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-177">The process of sorting, applying search criteria, and selecting a subset of the data for paging (showing only 3 rows in this case) is done in memory later when the `ToPagedList` method is called on the `IEnumerable` collection.</span></span>
> 
> <span data-ttu-id="d2f25-178">Dans la version précédente du code (avant d’implémenter le référentiel), la requête n’est pas envoyée à la base de données tant que vous n’avez pas appliqué les critères de recherche, lorsque `ToPagedList` est appelé sur l’objet `IQueryable`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-178">In the previous version of the code (before you implemented the repository), the query is not sent to the database until after you apply the search criteria, when `ToPagedList` is called on the `IQueryable` object.</span></span>
> 
> ![](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image3.png)
> 
> <span data-ttu-id="d2f25-179">Lorsque ToPagedList est appelé sur un objet `IQueryable`, la requête envoyée à SQL Server spécifie la chaîne de recherche et, par conséquent, seules les lignes qui répondent aux critères de recherche sont retournées, et aucun filtrage ne doit être effectué en mémoire.</span><span class="sxs-lookup"><span data-stu-id="d2f25-179">When ToPagedList is called on an `IQueryable` object, the query sent to SQL Server specifies the search string, and as a result only rows that meet the search criteria are returned, and no filtering needs to be done in memory.</span></span>
> 
> [!code-sql[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample16.sql)]
> 
> <span data-ttu-id="d2f25-180">(Le didacticiel suivant explique comment examiner les requêtes envoyées à SQL Server.)</span><span class="sxs-lookup"><span data-stu-id="d2f25-180">(The following tutorial explains how to examine queries sent to SQL Server.)</span></span>

<span data-ttu-id="d2f25-181">La section suivante montre comment implémenter des méthodes de référentiel qui vous permettent de spécifier que ce travail doit être effectué par la base de données.</span><span class="sxs-lookup"><span data-stu-id="d2f25-181">The following section shows how to implement repository methods that enable you to specify that this work should be done by the database.</span></span>

<span data-ttu-id="d2f25-182">Vous avez maintenant créé une couche d’abstraction entre le contrôleur et le contexte de base de données Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d2f25-182">You've now created an abstraction layer between the controller and the Entity Framework database context.</span></span> <span data-ttu-id="d2f25-183">Si vous envisagez d’effectuer des tests unitaires automatisés avec cette application, vous pouvez créer une autre classe de référentiel dans un projet de test unitaire qui implémente `IStudentRepository` *.*</span><span class="sxs-lookup"><span data-stu-id="d2f25-183">If you were going to perform automated unit testing with this application, you could create an alternative repository class in a unit test project that implements `IStudentRepository`*.*</span></span> <span data-ttu-id="d2f25-184">Au lieu d’appeler le contexte pour lire et écrire des données, cette classe de référentiel fictive peut manipuler des collections en mémoire afin de tester les fonctions du contrôleur.</span><span class="sxs-lookup"><span data-stu-id="d2f25-184">Instead of calling the context to read and write data, this mock repository class could manipulate in-memory collections in order to test controller functions.</span></span>

## <a name="implement-a-generic-repository-and-a-unit-of-work-class"></a><span data-ttu-id="d2f25-185">Implémenter un référentiel générique et une classe d’unité de travail</span><span class="sxs-lookup"><span data-stu-id="d2f25-185">Implement a Generic Repository and a Unit of Work Class</span></span>

<span data-ttu-id="d2f25-186">La création d’une classe de référentiel pour chaque type d’entité peut entraîner une grande quantité de code redondant et peut entraîner des mises à jour partielles.</span><span class="sxs-lookup"><span data-stu-id="d2f25-186">Creating a repository class for each entity type could result in a lot of redundant code, and it could result in partial updates.</span></span> <span data-ttu-id="d2f25-187">Par exemple, supposons que vous devez mettre à jour deux types d’entité différents dans le cadre de la même transaction.</span><span class="sxs-lookup"><span data-stu-id="d2f25-187">For example, suppose you have to update two different entity types as part of the same transaction.</span></span> <span data-ttu-id="d2f25-188">Si chacune utilise une instance de contexte de base de données distincte, l’une peut réussir et l’autre peut échouer.</span><span class="sxs-lookup"><span data-stu-id="d2f25-188">If each uses a separate database context instance, one might succeed and the other might fail.</span></span> <span data-ttu-id="d2f25-189">L’une des façons de réduire le code redondant consiste à utiliser un référentiel générique et une façon de s’assurer que tous les dépôts utilisent le même contexte de base de données (et, par conséquent, la coordination de toutes les mises à jour) consiste à utiliser une classe d’unité de travail.</span><span class="sxs-lookup"><span data-stu-id="d2f25-189">One way to minimize redundant code is to use a generic repository, and one way to ensure that all repositories use the same database context (and thus coordinate all updates) is to use a unit of work class.</span></span>

<span data-ttu-id="d2f25-190">Dans cette section du didacticiel, vous allez créer une classe `GenericRepository` et une classe `UnitOfWork`, et les utiliser dans le contrôleur `Course` pour accéder à la `Department` et aux jeux d’entités `Course`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-190">In this section of the tutorial, you'll create a `GenericRepository` class and a `UnitOfWork` class, and use them in the `Course` controller to access both the `Department` and the `Course` entity sets.</span></span> <span data-ttu-id="d2f25-191">Comme expliqué précédemment, pour simplifier cette partie du didacticiel, vous ne créez pas d’interfaces pour ces classes.</span><span class="sxs-lookup"><span data-stu-id="d2f25-191">As explained earlier, to keep this part of the tutorial simple, you aren't creating interfaces for these classes.</span></span> <span data-ttu-id="d2f25-192">Toutefois, si vous deviez les utiliser pour faciliter le TDD, vous les implémentez généralement à l’aide d’interfaces de la même façon que vous l’avez fait pour le référentiel de `Student`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-192">But if you were going to use them to facilitate TDD, you'd typically implement them with interfaces the same way you did the `Student` repository.</span></span>

### <a name="create-a-generic-repository"></a><span data-ttu-id="d2f25-193">Créer un dépôt générique</span><span class="sxs-lookup"><span data-stu-id="d2f25-193">Create a Generic Repository</span></span>

<span data-ttu-id="d2f25-194">Dans le dossier *dal* , créez *GenericRepository.cs* et remplacez le code existant par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="d2f25-194">In the *DAL* folder, create *GenericRepository.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample17.cs)]

<span data-ttu-id="d2f25-195">Les variables de classe sont déclarées pour le contexte de base de données et pour le jeu d’entités pour lequel le dépôt est instancié :</span><span class="sxs-lookup"><span data-stu-id="d2f25-195">Class variables are declared for the database context and for the entity set that the repository is instantiated for:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample18.cs)]

<span data-ttu-id="d2f25-196">Le constructeur accepte une instance de contexte de base de données et initialise la variable de jeu d’entités :</span><span class="sxs-lookup"><span data-stu-id="d2f25-196">The constructor accepts a database context instance and initializes the entity set variable:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample19.cs)]

<span data-ttu-id="d2f25-197">La méthode `Get` utilise des expressions lambda pour permettre au code appelant de spécifier une condition de filtre et une colonne pour trier les résultats par, et un paramètre de chaîne permet à l’appelant de fournir une liste délimitée par des virgules des propriétés de navigation pour le chargement hâtif :</span><span class="sxs-lookup"><span data-stu-id="d2f25-197">The `Get` method uses lambda expressions to allow the calling code to specify a filter condition and a column to order the results by, and a string parameter lets the caller provide a comma-delimited list of navigation properties for eager loading:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample20.cs)]

<span data-ttu-id="d2f25-198">Le `Expression<Func<TEntity, bool>> filter` de code signifie que l’appelant fournira une expression lambda basée sur le type de `TEntity`, et cette expression renverra une valeur booléenne.</span><span class="sxs-lookup"><span data-stu-id="d2f25-198">The code `Expression<Func<TEntity, bool>> filter` means the caller will provide a lambda expression based on the `TEntity` type, and this expression will return a Boolean value.</span></span> <span data-ttu-id="d2f25-199">Par exemple, si le référentiel est instancié pour le type d’entité `Student`, le code de la méthode d’appel peut spécifier `student => student.LastName == "Smith`&quot; pour le paramètre `filter`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-199">For example, if the repository is instantiated for the `Student` entity type, the code in the calling method might specify `student => student.LastName == "Smith`&quot; for the `filter` parameter.</span></span>

<span data-ttu-id="d2f25-200">Le code `Func<IQueryable<TEntity>, IOrderedQueryable<TEntity>> orderBy` signifie également que l’appelant fournira une expression lambda.</span><span class="sxs-lookup"><span data-stu-id="d2f25-200">The code `Func<IQueryable<TEntity>, IOrderedQueryable<TEntity>> orderBy` also means the caller will provide a lambda expression.</span></span> <span data-ttu-id="d2f25-201">Mais dans ce cas, l’entrée de l’expression est un objet `IQueryable` pour le type `TEntity`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-201">But in this case, the input to the expression is an `IQueryable` object for the `TEntity` type.</span></span> <span data-ttu-id="d2f25-202">L’expression retourne une version triée de cet objet `IQueryable`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-202">The expression will return an ordered version of that `IQueryable` object.</span></span> <span data-ttu-id="d2f25-203">Par exemple, si le référentiel est instancié pour le type d’entité `Student`, le code dans la méthode d’appel peut spécifier `q => q.OrderBy(s => s.LastName)` pour le paramètre `orderBy`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-203">For example, if the repository is instantiated for the `Student` entity type, the code in the calling method might specify `q => q.OrderBy(s => s.LastName)` for the `orderBy` parameter.</span></span>

<span data-ttu-id="d2f25-204">Le code de la méthode `Get` crée un objet `IQueryable`, puis applique l’expression de filtre, le cas échéant :</span><span class="sxs-lookup"><span data-stu-id="d2f25-204">The code in the `Get` method creates an `IQueryable` object and then applies the filter expression if there is one:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample21.cs)]

<span data-ttu-id="d2f25-205">Elle applique ensuite les expressions de chargement hâtif après l’analyse de la liste délimitée par des virgules :</span><span class="sxs-lookup"><span data-stu-id="d2f25-205">Next it applies the eager-loading expressions after parsing the comma-delimited list:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample22.cs)]

<span data-ttu-id="d2f25-206">Enfin, il applique l’expression `orderBy` s’il en existe un et retourne les résultats ; dans le cas contraire, elle retourne les résultats de la requête non triée :</span><span class="sxs-lookup"><span data-stu-id="d2f25-206">Finally, it applies the `orderBy` expression if there is one and returns the results; otherwise it returns the results from the unordered query:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample23.cs)]

<span data-ttu-id="d2f25-207">Quand vous appelez la méthode `Get`, vous pouvez effectuer un filtrage et un tri sur la collection `IEnumerable` retournée par la méthode au lieu de fournir des paramètres pour ces fonctions.</span><span class="sxs-lookup"><span data-stu-id="d2f25-207">When you call the `Get` method, you could do filtering and sorting on the `IEnumerable` collection returned by the method instead of providing parameters for these functions.</span></span> <span data-ttu-id="d2f25-208">Toutefois, le travail de tri et de filtrage est ensuite effectué en mémoire sur le serveur Web.</span><span class="sxs-lookup"><span data-stu-id="d2f25-208">But the sorting and filtering work would then be done in memory on the web server.</span></span> <span data-ttu-id="d2f25-209">En utilisant ces paramètres, vous vous assurez que le travail est effectué par la base de données plutôt que par le serveur Web.</span><span class="sxs-lookup"><span data-stu-id="d2f25-209">By using these parameters, you ensure that the work is done by the database rather than the web server.</span></span> <span data-ttu-id="d2f25-210">Une alternative consiste à créer des classes dérivées pour des types d’entités spécifiques et à ajouter des méthodes `Get` spécialisées, telles que `GetStudentsInNameOrder` ou `GetStudentsByName`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-210">An alternative is to create derived classes for specific entity types and add specialized `Get` methods, such as `GetStudentsInNameOrder` or `GetStudentsByName`.</span></span> <span data-ttu-id="d2f25-211">Toutefois, dans une application complexe, cela peut entraîner un grand nombre de classes dérivées de ce type et de méthodes spécialisées, qui peuvent être plus de travail à gérer.</span><span class="sxs-lookup"><span data-stu-id="d2f25-211">However, in a complex application, this can result in a large number of such derived classes and specialized methods, which could be more work to maintain.</span></span>

<span data-ttu-id="d2f25-212">Le code des méthodes `GetByID`, `Insert`et `Update` est semblable à celui que vous avez vu dans le référentiel non générique.</span><span class="sxs-lookup"><span data-stu-id="d2f25-212">The code in the `GetByID`, `Insert`, and `Update` methods is similar to what you saw in the non-generic repository.</span></span> <span data-ttu-id="d2f25-213">(Vous ne fournissez pas de paramètre de chargement hâtif dans la signature `GetByID`, car vous ne pouvez pas effectuer de chargement hâtif avec la méthode `Find`.)</span><span class="sxs-lookup"><span data-stu-id="d2f25-213">(You aren't providing an eager loading parameter in the `GetByID` signature, because you can't do eager loading with the `Find` method.)</span></span>

<span data-ttu-id="d2f25-214">Deux surcharges sont fournies pour la méthode `Delete` :</span><span class="sxs-lookup"><span data-stu-id="d2f25-214">Two overloads are provided for the `Delete` method:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample24.cs)]

<span data-ttu-id="d2f25-215">L’une d’entre elles vous permet de transmettre uniquement l’ID de l’entité à supprimer, et l’autre prend une instance d’entité.</span><span class="sxs-lookup"><span data-stu-id="d2f25-215">One of these lets you pass in just the ID of the entity to be deleted, and one takes an entity instance.</span></span> <span data-ttu-id="d2f25-216">Comme vous l’avez vu dans le didacticiel sur la [gestion](../../getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) de la concurrence, vous avez besoin d’une méthode `Delete` qui prend une instance d’entité incluant la valeur d’origine d’une propriété de suivi.</span><span class="sxs-lookup"><span data-stu-id="d2f25-216">As you saw in the [Handling Concurrency](../../getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial, for concurrency handling you need a `Delete` method that takes an entity instance that includes the original value of a tracking property.</span></span>

<span data-ttu-id="d2f25-217">Ce dépôt générique gère les exigences de la CRUD classique.</span><span class="sxs-lookup"><span data-stu-id="d2f25-217">This generic repository will handle typical CRUD requirements.</span></span> <span data-ttu-id="d2f25-218">Quand un type d’entité particulier a des exigences spéciales, telles que le filtrage ou le classement plus complexe, vous pouvez créer une classe dérivée qui a des méthodes supplémentaires pour ce type.</span><span class="sxs-lookup"><span data-stu-id="d2f25-218">When a particular entity type has special requirements, such as more complex filtering or ordering, you can create a derived class that has additional methods for that type.</span></span>

## <a name="creating-the-unit-of-work-class"></a><span data-ttu-id="d2f25-219">Création de la classe Unit of Work</span><span class="sxs-lookup"><span data-stu-id="d2f25-219">Creating the Unit of Work Class</span></span>

<span data-ttu-id="d2f25-220">La classe Unit of Work sert à un objectif : pour s’assurer que lorsque vous utilisez plusieurs référentiels, ils partagent un contexte de base de données unique.</span><span class="sxs-lookup"><span data-stu-id="d2f25-220">The unit of work class serves one purpose: to make sure that when you use multiple repositories, they share a single database context.</span></span> <span data-ttu-id="d2f25-221">Ainsi, quand une unité de travail est terminée, vous pouvez appeler la méthode `SaveChanges` sur cette instance du contexte et être certain que toutes les modifications associées seront coordonnées.</span><span class="sxs-lookup"><span data-stu-id="d2f25-221">That way, when a unit of work is complete you can call the `SaveChanges` method on that instance of the context and be assured that all related changes will be coordinated.</span></span> <span data-ttu-id="d2f25-222">Tout ce dont a besoin la classe est une méthode `Save` et une propriété pour chaque référentiel.</span><span class="sxs-lookup"><span data-stu-id="d2f25-222">All that the class needs is a `Save` method and a property for each repository.</span></span> <span data-ttu-id="d2f25-223">Chaque propriété de référentiel retourne une instance de référentiel qui a été instanciée à l’aide de la même instance de contexte de base de données que les autres instances de référentiel.</span><span class="sxs-lookup"><span data-stu-id="d2f25-223">Each repository property returns a repository instance that has been instantiated using the same database context instance as the other repository instances.</span></span>

<span data-ttu-id="d2f25-224">Dans le dossier *dal* , créez un fichier de classe nommé *UnitOfWork.cs* et remplacez le code du modèle par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="d2f25-224">In the *DAL* folder, create a class file named *UnitOfWork.cs* and replace the template code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample25.cs)]

<span data-ttu-id="d2f25-225">Le code crée des variables de classe pour le contexte de base de données et chaque référentiel.</span><span class="sxs-lookup"><span data-stu-id="d2f25-225">The code creates class variables for the database context and each repository.</span></span> <span data-ttu-id="d2f25-226">Pour la variable `context`, un nouveau contexte est instancié :</span><span class="sxs-lookup"><span data-stu-id="d2f25-226">For the `context` variable, a new context is instantiated:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample26.cs)]

<span data-ttu-id="d2f25-227">Chaque propriété de référentiel vérifie si le référentiel existe déjà.</span><span class="sxs-lookup"><span data-stu-id="d2f25-227">Each repository property checks whether the repository already exists.</span></span> <span data-ttu-id="d2f25-228">Si ce n’est pas le cas, il instancie le référentiel, en passant l’instance de contexte.</span><span class="sxs-lookup"><span data-stu-id="d2f25-228">If not, it instantiates the repository, passing in the context instance.</span></span> <span data-ttu-id="d2f25-229">Par conséquent, tous les référentiels partagent la même instance de contexte.</span><span class="sxs-lookup"><span data-stu-id="d2f25-229">As a result, all repositories share the same context instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample27.cs)]

<span data-ttu-id="d2f25-230">La méthode `Save` appelle `SaveChanges` sur le contexte de base de données.</span><span class="sxs-lookup"><span data-stu-id="d2f25-230">The `Save` method calls `SaveChanges` on the database context.</span></span>

<span data-ttu-id="d2f25-231">Comme toute classe qui instancie un contexte de base de données dans une variable de classe, la classe `UnitOfWork` implémente `IDisposable` et supprime le contexte.</span><span class="sxs-lookup"><span data-stu-id="d2f25-231">Like any class that instantiates a database context in a class variable, the `UnitOfWork` class implements `IDisposable` and disposes the context.</span></span>

### <a name="changing-the-course-controller-to-use-the-unitofwork-class-and-repositories"></a><span data-ttu-id="d2f25-232">Modification du contrôleur de cours pour utiliser la classe UnitOfWork et les référentiels</span><span class="sxs-lookup"><span data-stu-id="d2f25-232">Changing the Course Controller to use the UnitOfWork Class and Repositories</span></span>

<span data-ttu-id="d2f25-233">Remplacez le code que vous avez actuellement dans *CourseController.cs* par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="d2f25-233">Replace the code you currently have in *CourseController.cs* with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample28.cs?highlight=15,20,22,31,54-55,70,85-86,101-102,122-124,130)]

<span data-ttu-id="d2f25-234">Ce code ajoute une variable de classe pour la classe `UnitOfWork`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-234">This code adds a class variable for the `UnitOfWork` class.</span></span> <span data-ttu-id="d2f25-235">(Si vous utilisiez des interfaces ici, vous n’auriez pas initialisé la variable ici. au lieu de cela, vous devez implémenter un modèle de deux constructeurs comme vous l’avez fait pour le référentiel `Student`.)</span><span class="sxs-lookup"><span data-stu-id="d2f25-235">(If you were using interfaces here, you wouldn't initialize the variable here; instead, you'd implement a pattern of two constructors just as you did for the `Student` repository.)</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample29.cs)]

<span data-ttu-id="d2f25-236">Dans le reste de la classe, toutes les références au contexte de base de données sont remplacées par des références au référentiel approprié, à l’aide des propriétés de `UnitOfWork` pour accéder au référentiel.</span><span class="sxs-lookup"><span data-stu-id="d2f25-236">In the rest of the class, all references to the database context are replaced by references to the appropriate repository, using `UnitOfWork` properties to access the repository.</span></span> <span data-ttu-id="d2f25-237">La méthode `Dispose` supprime l’instance `UnitOfWork`.</span><span class="sxs-lookup"><span data-stu-id="d2f25-237">The `Dispose` method disposes the `UnitOfWork` instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample30.cs)]

<span data-ttu-id="d2f25-238">Exécutez le site et cliquez sur l’onglet **courses** .</span><span class="sxs-lookup"><span data-stu-id="d2f25-238">Run the site and click the **Courses** tab.</span></span>

![Courses_Index_page](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image4.png)

<span data-ttu-id="d2f25-240">La page s’affiche et fonctionne comme avant vos modifications, et les autres pages de cours fonctionnent également de la même façon.</span><span class="sxs-lookup"><span data-stu-id="d2f25-240">The page looks and works the same as it did before your changes, and the other Course pages also work the same.</span></span>

## <a name="summary"></a><span data-ttu-id="d2f25-241">Récapitulatif</span><span class="sxs-lookup"><span data-stu-id="d2f25-241">Summary</span></span>

<span data-ttu-id="d2f25-242">Vous avez maintenant implémenté les modèles de référentiel et d’unité de travail.</span><span class="sxs-lookup"><span data-stu-id="d2f25-242">You have now implemented both the repository and unit of work patterns.</span></span> <span data-ttu-id="d2f25-243">Vous avez utilisé des expressions lambda comme paramètres de méthode dans le référentiel générique.</span><span class="sxs-lookup"><span data-stu-id="d2f25-243">You have used lambda expressions as method parameters in the generic repository.</span></span> <span data-ttu-id="d2f25-244">Pour plus d’informations sur l’utilisation de ces expressions avec un objet `IQueryable`, consultez [IQueryable (t) interface (System. Linq)](https://msdn.microsoft.com/library/bb351562.aspx) dans MSDN Library.</span><span class="sxs-lookup"><span data-stu-id="d2f25-244">For more information about how to use these expressions with an `IQueryable` object, see [IQueryable(T) Interface (System.Linq)](https://msdn.microsoft.com/library/bb351562.aspx) in the MSDN Library.</span></span> <span data-ttu-id="d2f25-245">Dans le didacticiel suivant, vous apprendrez à gérer certains scénarios avancés.</span><span class="sxs-lookup"><span data-stu-id="d2f25-245">In the next tutorial you'll learn how to handle some advanced scenarios.</span></span>

<span data-ttu-id="d2f25-246">Vous trouverez des liens vers d’autres ressources de Entity Framework dans le [plan de contenu d’accès aux données ASP.net](../../../../whitepapers/aspnet-data-access-content-map.md).</span><span class="sxs-lookup"><span data-stu-id="d2f25-246">Links to other Entity Framework resources can be found in the [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="d2f25-247">[Précédent](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application.md)
> [Suivant](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="d2f25-247">[Previous](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application.md)
[Next](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)</span></span>
