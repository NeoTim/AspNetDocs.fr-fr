---
uid: web-api/overview/error-handling/web-api-global-error-handling
title: Global Gestion des erreurs dans ASP.NET Web API 2 - ASP.NET 4.x
author: davidmatson
description: Une vue d’ensemble globale de gestion d’erreurs dans ASP.NET Web API 2 pour ASP.NET 4.x.
ms.author: riande
ms.date: 02/03/2014
ms.custom: seoapril2019
ms.assetid: bffd7863-f63b-4b23-a13c-372b5492e9fb
msc.legacyurl: /web-api/overview/error-handling/web-api-global-error-handling
msc.type: authoredcontent
ms.openlocfilehash: 7d9f4fb9909671d7c4c8ee2aa9285b0186c4b125
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/17/2019
ms.locfileid: "59414372"
---
# <a name="global-error-handling-in-aspnet-web-api-2"></a><span data-ttu-id="d7707-103">Global Gestion des erreurs dans ASP.NET Web API 2</span><span class="sxs-lookup"><span data-stu-id="d7707-103">Global Error Handling in ASP.NET Web API 2</span></span>

<span data-ttu-id="d7707-104">par [David Matson](https://github.com/davidmatson), [Rick Anderson]((https://twitter.com/RickAndMSFT))</span><span class="sxs-lookup"><span data-stu-id="d7707-104">by [David Matson](https://github.com/davidmatson), [Rick Anderson]((https://twitter.com/RickAndMSFT))</span></span>

<span data-ttu-id="d7707-105">Cette rubrique fournit une vue d’ensemble globale de gestion d’erreurs dans ASP.NET Web API 2 pour ASP.NET 4.x.</span><span class="sxs-lookup"><span data-stu-id="d7707-105">This topic provides an overview of global error handling in ASP.NET Web API 2 for ASP.NET 4.x.</span></span> <span data-ttu-id="d7707-106">Aujourd'hui il n’existe aucun moyen facile dans l’API Web pour vous connecter ou gérer les erreurs dans le monde entier.</span><span class="sxs-lookup"><span data-stu-id="d7707-106">Today there's no easy way in Web API to log or handle errors globally.</span></span> <span data-ttu-id="d7707-107">Certaines exceptions non gérées peuvent être traitées via [filtres d’exception](exception-handling.md), mais il existe un nombre de cas qui ne peut pas gérer les filtres d’exception.</span><span class="sxs-lookup"><span data-stu-id="d7707-107">Some unhandled exceptions can be processed via [exception filters](exception-handling.md), but there are a number of cases that exception filters can't handle.</span></span> <span data-ttu-id="d7707-108">Exemple :</span><span class="sxs-lookup"><span data-stu-id="d7707-108">For example:</span></span>

1. <span data-ttu-id="d7707-109">Exceptions levées à partir des constructeurs de contrôleur.</span><span class="sxs-lookup"><span data-stu-id="d7707-109">Exceptions thrown from controller constructors.</span></span>
2. <span data-ttu-id="d7707-110">Exceptions levées à partir des gestionnaires de messages.</span><span class="sxs-lookup"><span data-stu-id="d7707-110">Exceptions thrown from message handlers.</span></span>
3. <span data-ttu-id="d7707-111">Exceptions levées pendant le routage.</span><span class="sxs-lookup"><span data-stu-id="d7707-111">Exceptions thrown during routing.</span></span>
4. <span data-ttu-id="d7707-112">Exceptions levées pendant la sérialisation du contenu de réponse.</span><span class="sxs-lookup"><span data-stu-id="d7707-112">Exceptions thrown during response content serialization .</span></span>

<span data-ttu-id="d7707-113">Nous voulons fournir un moyen simple et cohérent pour vous connecter et gérer (éventuellement) ces exceptions.</span><span class="sxs-lookup"><span data-stu-id="d7707-113">We want to provide a simple, consistent way to log and handle (where possible) these exceptions.</span></span> 

<span data-ttu-id="d7707-114">Il existe deux cas principaux pour la gestion des exceptions, le cas où nous sommes en mesure d’envoyer une réponse d’erreur et le cas où tout ce que nous pouvons faire est l’exception de journal.</span><span class="sxs-lookup"><span data-stu-id="d7707-114">There are two major cases for handling exceptions, the case where we are able to send an error response and the case where all we can do is log the exception.</span></span> <span data-ttu-id="d7707-115">Par exemple pour ce dernier cas, lorsqu’une exception est levée au milieu de diffusion en continu de contenu de la réponse ; Dans ce cas il est trop tard pour envoyer un nouveau message de réponse dans la mesure où le code d’état, des en-têtes et contenu partiel sont déjà passées sur le câble, donc nous simplement abandonner la connexion.</span><span class="sxs-lookup"><span data-stu-id="d7707-115">An example for the latter case is when an exception is thrown in the middle of streaming response content; in that case it is too late to send a new response message since the status code, headers, and partial content have already gone across the wire, so we simply abort the connection.</span></span> <span data-ttu-id="d7707-116">Même si l’exception ne peut pas être gérée pour produire un nouveau message de réponse, nous avons toujours prendre en charge la journalisation de l’exception.</span><span class="sxs-lookup"><span data-stu-id="d7707-116">Even though the exception can't be handled to produce a new response message, we still support logging the exception.</span></span> <span data-ttu-id="d7707-117">Dans les cas où nous pouvons détecter une erreur, nous pouvons renvoyer une réponse d’erreur approprié comme indiqué dans le code suivant :</span><span class="sxs-lookup"><span data-stu-id="d7707-117">In cases where we can detect an error, we can return an appropriate error response as shown in the following:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample1.cs?highlight=6)]

### <a name="existing-options"></a><span data-ttu-id="d7707-118">Options existantes</span><span class="sxs-lookup"><span data-stu-id="d7707-118">Existing Options</span></span>

<span data-ttu-id="d7707-119">En plus de [filtres d’exception](exception-handling.md), [gestionnaires de messages](../advanced/http-message-handlers.md) peut être utilisé aujourd'hui pour observer toutes les réponses de niveau 500, mais agissant sur ces réponses est difficile, car ils ne disposent pas de contexte sur l’erreur d’origine.</span><span class="sxs-lookup"><span data-stu-id="d7707-119">In addition to [exception filters](exception-handling.md), [message handlers](../advanced/http-message-handlers.md) can be used today to observe all 500-level responses, but acting on those responses is difficult, as they lack context about the original error.</span></span> <span data-ttu-id="d7707-120">Gestionnaires de messages présentent également certaines des mêmes restrictions que les filtres d’exception concernant les cas elles peuvent traiter. Tandis que l’API Web dispose d’une infrastructure de traçage qui capture les conditions d’erreur l’infrastructure de suivi est destiné à des fins de diagnostics et n'est pas conçu ou adapté à l’exécution dans les environnements de production.</span><span class="sxs-lookup"><span data-stu-id="d7707-120">Message handlers also have some of the same limitations as exception filters regarding the cases they can handle.While Web API does have tracing infrastructure that captures error conditions the tracing infrastructure is for diagnostics purposes and is not designed or suited for running in production environments.</span></span> <span data-ttu-id="d7707-121">Global Gestion des exceptions et journalisation doivent être des services qui peuvent s’exécuter lors de la production et être branchés de solutions de surveillance existantes (par exemple, [ELMAH](https://code.google.com/p/elmah/) ).</span><span class="sxs-lookup"><span data-stu-id="d7707-121">Global exception handling and logging should be services that can run during production and be plugged into existing monitoring solutions (for example, [ELMAH](https://code.google.com/p/elmah/) ).</span></span>

### <a name="solution-overview"></a><span data-ttu-id="d7707-122">Présentation de la solution</span><span class="sxs-lookup"><span data-stu-id="d7707-122">Solution Overview</span></span>

 <span data-ttu-id="d7707-123">Nous fournissons deux nouveaux services remplaçable par l’utilisateur, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) et IExceptionHandler, pour vous connecter et gérer les exceptions non gérées.</span><span class="sxs-lookup"><span data-stu-id="d7707-123">We provide two new user-replaceable services, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) and IExceptionHandler, to log and handle unhandled exceptions.</span></span> <span data-ttu-id="d7707-124">Les services sont très similaires, avec deux principales différences :</span><span class="sxs-lookup"><span data-stu-id="d7707-124">The services are very similar, with two main differences:</span></span>

1. <span data-ttu-id="d7707-125">Nous prenons en charge l’inscription de plusieurs journaux d’exception, mais uniquement un seul gestionnaire d’exceptions.</span><span class="sxs-lookup"><span data-stu-id="d7707-125">We support registering multiple exception loggers but only a single exception handler.</span></span>
2. <span data-ttu-id="d7707-126">Enregistreurs d’événements exception toujours appelées, même si nous sommes sur le point d’abandonner la connexion.</span><span class="sxs-lookup"><span data-stu-id="d7707-126">Exception loggers always get called, even if we're about to abort the connection.</span></span> <span data-ttu-id="d7707-127">Gestionnaires d’exceptions appelés uniquement lorsque nous sommes toujours en mesure de choisir le message de réponse à envoyer.</span><span class="sxs-lookup"><span data-stu-id="d7707-127">Exception handlers only get called when we're still able to choose which response message to send.</span></span>

<span data-ttu-id="d7707-128">Les deux services fournissent un accès à un contexte d’exception contenant des informations pertinentes à partir du point où l’exception a été détectée, en particulier le [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), le [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), la levée d’exception et la source de l’exception (voir détails ci-dessous).</span><span class="sxs-lookup"><span data-stu-id="d7707-128">Both services provide access to an exception context containing relevant information from the point where the exception was detected, particularly the [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), the [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), the thrown exception and the exception source (details below).</span></span>

### <a name="design-principles"></a><span data-ttu-id="d7707-129">Principes de conception</span><span class="sxs-lookup"><span data-stu-id="d7707-129">Design Principles</span></span>

1. <span data-ttu-id="d7707-130">**Aucune modification avec rupture** , car cette fonctionnalité est ajoutée dans une version mineure, une contrainte importante ayant un impact sur la solution est qu’il y avoir aucune modification avec rupture, soit vers le type de contrat ou un comportement.</span><span class="sxs-lookup"><span data-stu-id="d7707-130">**No breaking changes** Because this functionality is being added in a minor release, one important constraint impacting the solution is that there be no breaking changes, either to type contracts or to behavior.</span></span> <span data-ttu-id="d7707-131">Cette contrainte écarté un nettoyage que nous souhaitons vous l’avez fait en termes de blocs catch existants activation des exceptions dans les 500 réponses.</span><span class="sxs-lookup"><span data-stu-id="d7707-131">This constraint ruled out some cleanup we would like to have done in terms of existing catch blocks turning exceptions into 500 responses.</span></span> <span data-ttu-id="d7707-132">Ce nettoyage supplémentaire est quelque chose que nous pourrions prendre en compte pour une version majeure à venir.</span><span class="sxs-lookup"><span data-stu-id="d7707-132">This additional cleanup is something we might consider for a subsequent major release.</span></span> <span data-ttu-id="d7707-133">Si cela est important de vous votez sur à l’adresse [uservoice d’API Web ASP.NET](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span><span class="sxs-lookup"><span data-stu-id="d7707-133">If this is important to you please vote on it at [ASP.NET Web API user voice](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span></span>
2. <span data-ttu-id="d7707-134">**Maintenir la cohérence avec l’API Web construit** pipeline de filtres de l’API Web est un excellent moyen pour gérer les problèmes transversaux grâce à la flexibilité de l’application de la logique dans une étendue spécifique à l’action globale ou contrôleur spécifique.</span><span class="sxs-lookup"><span data-stu-id="d7707-134">**Maintaining consistency with Web API constructs** Web API's filter pipeline is a great way to handle cross-cutting concerns with the flexibility of applying the logic at an action-specific, controller-specific or global scope.</span></span> <span data-ttu-id="d7707-135">Filtres, notamment les filtres d’exception, ont toujours les contextes d’action et le contrôleur, même lorsque les inscrit au niveau global.</span><span class="sxs-lookup"><span data-stu-id="d7707-135">Filters, including exception filters, always have action and controller contexts, even when registered at the global scope.</span></span> <span data-ttu-id="d7707-136">Que le contrat est judicieux pour les filtres, mais cela signifie que les filtres d’exception, celles qui sont encore dans le monde entier avec étendue, ne sont pas adapté à certains cas, tels que les exceptions à partir des gestionnaires de messages, des exceptions où aucun contexte d’action ou contrôleur existe.</span><span class="sxs-lookup"><span data-stu-id="d7707-136">That contract makes sense for filters, but it means that exception filters, even globally scoped ones, aren't a good fit for some exception handling cases, such as exceptions from message handlers, where no action or controller context exists.</span></span> <span data-ttu-id="d7707-137">Si vous souhaitez utiliser l’étendue flexible offerte par les filtres pour la gestion des exceptions, nous avons besoin de filtres d’exception.</span><span class="sxs-lookup"><span data-stu-id="d7707-137">If we want to use the flexible scoping afforded by filters for exception handling, we still need exception filters.</span></span> <span data-ttu-id="d7707-138">Mais si nous avons besoin gérer les exceptions en dehors d’un contexte de contrôleur, nous devons également une construction distincte pour gérer les erreurs complet mondial (quelque chose sans les contraintes de contexte de contrôleur contexte et action).</span><span class="sxs-lookup"><span data-stu-id="d7707-138">But if we need to handle exception outside of a controller context, we also need a separate construct for full global error handling (something without the controller context and action context constraints).</span></span>

### <a name="when-to-use"></a><span data-ttu-id="d7707-139">Quand utiliser</span><span class="sxs-lookup"><span data-stu-id="d7707-139">When to Use</span></span>

- <span data-ttu-id="d7707-140">Enregistreurs d’événements exception sont la solution de voir tous les exception non gérée détectée par l’API Web.</span><span class="sxs-lookup"><span data-stu-id="d7707-140">Exception loggers are the solution to seeing all unhandled exception caught by Web API.</span></span>
- <span data-ttu-id="d7707-141">Gestionnaires d’exceptions sont la solution de personnalisation de toutes les réponses possibles aux exceptions non gérées, interceptées par l’API Web.</span><span class="sxs-lookup"><span data-stu-id="d7707-141">Exception handlers are the solution for customizing all possible responses to unhandled exceptions caught by Web API.</span></span>
- <span data-ttu-id="d7707-142">Filtres d’exception sont la solution la plus simple pour traiter les exceptions non prises en charge de sous-ensemble liées à une action spécifique ou un contrôleur.</span><span class="sxs-lookup"><span data-stu-id="d7707-142">Exception filters are the easiest solution for processing the subset unhandled exceptions related to a specific action or controller.</span></span>

### <a name="service-details"></a><span data-ttu-id="d7707-143">Détails du service</span><span class="sxs-lookup"><span data-stu-id="d7707-143">Service Details</span></span>

 <span data-ttu-id="d7707-144">Les interfaces de service Enregistreur d’événements et le Gestionnaire d’exception sont les méthodes async simple en prenant les contextes respectifs :</span><span class="sxs-lookup"><span data-stu-id="d7707-144">The exception logger and handler service interfaces are simple async methods taking the respective contexts:</span></span> 

[!code-csharp[Main](web-api-global-error-handling/samples/sample2.cs)]

 <span data-ttu-id="d7707-145">Nous fournissons également des classes de base pour ces deux interfaces.</span><span class="sxs-lookup"><span data-stu-id="d7707-145">We also provide base classes for both of these interfaces.</span></span> <span data-ttu-id="d7707-146">Substitution des méthodes core (synchrone ou asynchrone) est tout ce qui est nécessaire pour vous connecter ou gérer l’architecture recommandée à la fois.</span><span class="sxs-lookup"><span data-stu-id="d7707-146">Overriding the core (sync or async) methods is all that is required to log or handle at the recommended times.</span></span> <span data-ttu-id="d7707-147">Pour la journalisation, la `ExceptionLogger` classe de base garantit que la méthode de journalisation principal est uniquement appelée une fois pour chaque exception (même si plus tard, il propage davantage la pile des appels et est interceptée à nouveau).</span><span class="sxs-lookup"><span data-stu-id="d7707-147">For logging, the `ExceptionLogger` base class will ensure that the core logging method is only called once for each exception (even if it later propagates further up the call stack and is caught again).</span></span> <span data-ttu-id="d7707-148">Le `ExceptionHandler` classe de base appellera le cœur de méthode de gestion uniquement pour les exceptions en haut de la pile des appels, en ignorant hérité imbriquée des blocs catch.</span><span class="sxs-lookup"><span data-stu-id="d7707-148">The `ExceptionHandler` base class will call the core handling method only for exceptions at the top of the call stack, ignoring legacy nested catch blocks.</span></span> <span data-ttu-id="d7707-149">(Versions simplifiées de ces classes de base sont dans l’annexe ci-dessous). Les deux `IExceptionLogger` et `IExceptionHandler` recevoir des informations sur l’exception via un `ExceptionContext`.</span><span class="sxs-lookup"><span data-stu-id="d7707-149">(Simplified versions of these base classes are in the appendix below.) Both `IExceptionLogger` and `IExceptionHandler` receive information about the exception via an `ExceptionContext`.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample3.cs)]

<span data-ttu-id="d7707-150">Lorsque l’infrastructure appelle un enregistreur d’exceptions ou un gestionnaire d’exceptions, il fournira toujours une `Exception` et un `Request`.</span><span class="sxs-lookup"><span data-stu-id="d7707-150">When the framework calls an exception logger or an exception handler, it will always provide an `Exception` and a `Request`.</span></span> <span data-ttu-id="d7707-151">À l’exception des tests unitaires, il fournira également toujours un `RequestContext`.</span><span class="sxs-lookup"><span data-stu-id="d7707-151">Except for unit testing, it will also always provide a `RequestContext`.</span></span> <span data-ttu-id="d7707-152">Il fournira rarement un `ControllerContext` et `ActionContext` (uniquement lorsque vous appelez à partir du bloc catch pour les filtres d’exception).</span><span class="sxs-lookup"><span data-stu-id="d7707-152">It will rarely provide a `ControllerContext` and `ActionContext` (only when calling from the catch block for exception filters).</span></span> <span data-ttu-id="d7707-153">Il fournira très rarement un `Response`(uniquement dans certains cas IIS lorsque, au milieu d’essayer d’écrire la réponse).</span><span class="sxs-lookup"><span data-stu-id="d7707-153">It will very rarely provide a `Response`(only in certain IIS cases when in the middle of trying to write the response).</span></span> <span data-ttu-id="d7707-154">Étant donné que certaines de ces propriétés peuvent être `null` il incombe au consommateur de vérifier les `null` avant d’accéder aux membres de la classe d’exception.`CatchBlock`</span><span class="sxs-lookup"><span data-stu-id="d7707-154">Note that because some of these properties may be `null` it is up to the consumer to check for `null` before accessing members of the exception class.`CatchBlock`</span></span> <span data-ttu-id="d7707-155">est une chaîne indiquant le bloc catch vu l’exception.</span><span class="sxs-lookup"><span data-stu-id="d7707-155">is a string indicating which catch block saw the exception.</span></span> <span data-ttu-id="d7707-156">Les chaînes de bloc catch sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="d7707-156">The catch block strings are as follows:</span></span>

- <span data-ttu-id="d7707-157">Ftpserver (méthode SendAsync)</span><span class="sxs-lookup"><span data-stu-id="d7707-157">HttpServer (SendAsync method)</span></span>
- <span data-ttu-id="d7707-158">HttpControllerDispatcher (méthode SendAsync)</span><span class="sxs-lookup"><span data-stu-id="d7707-158">HttpControllerDispatcher (SendAsync method)</span></span>
- <span data-ttu-id="d7707-159">HttpBatchHandler (méthode SendAsync)</span><span class="sxs-lookup"><span data-stu-id="d7707-159">HttpBatchHandler (SendAsync method)</span></span>
- <span data-ttu-id="d7707-160">IExceptionFilter (traitement du ApiController du pipeline de filtres d’exception dans ExecuteAsync)</span><span class="sxs-lookup"><span data-stu-id="d7707-160">IExceptionFilter (ApiController's processing of the exception filter pipeline in ExecuteAsync)</span></span>
- <span data-ttu-id="d7707-161">Hôte OWIN :</span><span class="sxs-lookup"><span data-stu-id="d7707-161">OWIN host:</span></span>

    - <span data-ttu-id="d7707-162">HttpMessageHandlerAdapter.BufferResponseContentAsync (pour la mise en mémoire tampon de sortie)</span><span class="sxs-lookup"><span data-stu-id="d7707-162">HttpMessageHandlerAdapter.BufferResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="d7707-163">HttpMessageHandlerAdapter.CopyResponseContentAsync (pour la diffusion en continu de sortie)</span><span class="sxs-lookup"><span data-stu-id="d7707-163">HttpMessageHandlerAdapter.CopyResponseContentAsync (for streaming output)</span></span>
- <span data-ttu-id="d7707-164">Hôte Web :</span><span class="sxs-lookup"><span data-stu-id="d7707-164">Web host:</span></span>

    - <span data-ttu-id="d7707-165">HttpControllerHandler.WriteBufferedResponseContentAsync (pour la mise en mémoire tampon de sortie)</span><span class="sxs-lookup"><span data-stu-id="d7707-165">HttpControllerHandler.WriteBufferedResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="d7707-166">HttpControllerHandler.WriteStreamedResponseContentAsync (pour la diffusion en continu de sortie)</span><span class="sxs-lookup"><span data-stu-id="d7707-166">HttpControllerHandler.WriteStreamedResponseContentAsync (for streaming output)</span></span>
    - <span data-ttu-id="d7707-167">HttpControllerHandler.WriteErrorResponseContentAsync (pour les échecs de récupération d’erreur en mode de mise en mémoire tampon de sortie)</span><span class="sxs-lookup"><span data-stu-id="d7707-167">HttpControllerHandler.WriteErrorResponseContentAsync (for failures in error recovery under buffered output mode)</span></span>

<span data-ttu-id="d7707-168">La liste de chaînes de bloc catch est également disponible via les propriétés statiques en lecture seule.</span><span class="sxs-lookup"><span data-stu-id="d7707-168">The list of catch block strings is also available via static readonly properties.</span></span> <span data-ttu-id="d7707-169">(La chaîne de bloc catch core se trouvent sur le ExceptionCatchBlocks statique ; le reste s’affichent sur une classe statique chaque pour OWIN et web hôte).`IsTopLevelCatchBlock`</span><span class="sxs-lookup"><span data-stu-id="d7707-169">(The core catch block string are on the static ExceptionCatchBlocks; the remainder appear on one static class each for OWIN and web host).`IsTopLevelCatchBlock`</span></span> <span data-ttu-id="d7707-170">est utile pour suivre le modèle recommandé de gestion des exceptions uniquement en haut de la pile des appels.</span><span class="sxs-lookup"><span data-stu-id="d7707-170">is helpful for following the recommended pattern of handling exceptions only at the top of the call stack.</span></span> <span data-ttu-id="d7707-171">Au lieu de transformer les exceptions dans les 500 réponses où que vous soyez qu'un bloc catch imbriqué se produit, un gestionnaire d’exceptions peut laisser des exceptions propager jusqu'à ce qu’ils sont sur le point d’être vu par l’hôte.</span><span class="sxs-lookup"><span data-stu-id="d7707-171">Rather than turning exceptions into 500 responses anywhere a nested catch block occurs, an exception handler can let exceptions propagate until they are about to be seen by the host.</span></span>

<span data-ttu-id="d7707-172">Outre le `ExceptionContext`, un enregistreur d’événements Obtient une information plus par le biais de la version complète `ExceptionLoggerContext`:</span><span class="sxs-lookup"><span data-stu-id="d7707-172">In addition to the `ExceptionContext`, a logger gets one more piece of information via the full `ExceptionLoggerContext`:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample4.cs)]

<span data-ttu-id="d7707-173">La deuxième propriété, `CanBeHandled`, permet un enregistreur d’événements identifier une exception qui ne peut pas être gérée.</span><span class="sxs-lookup"><span data-stu-id="d7707-173">The second property, `CanBeHandled`, allows a logger to identify an exception that cannot be handled.</span></span> <span data-ttu-id="d7707-174">Lorsque la connexion est sur le point d’être abandonnée et aucun nouveau message de réponse ne peut être envoyé, les enregistreurs d’événements seront appelés mais le gestionnaire sera ***pas*** être appelée, et les enregistreurs d’événements peuvent identifier ce scénario à partir de cette propriété.</span><span class="sxs-lookup"><span data-stu-id="d7707-174">When the connection is about to be aborted and no new response message can be sent, the loggers will be called but the handler will ***not*** be called, and the loggers can identify this scenario from this property.</span></span>

<span data-ttu-id="d7707-175">Dans plus de la `ExceptionContext`, un gestionnaire obtient une seule propriété supplémentaire, elle peut donner à la version complète `ExceptionHandlerContext` pour gérer l’exception :</span><span class="sxs-lookup"><span data-stu-id="d7707-175">In additional to the `ExceptionContext`, a handler gets one more property it can set on the full `ExceptionHandlerContext` to handle the exception:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample5.cs)]

<span data-ttu-id="d7707-176">Un gestionnaire d’exceptions indique qu’il a géré une exception en définissant le `Result` propriété à un résultat d’action (par exemple, un [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [ StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx), ou un résultat personnalisé).</span><span class="sxs-lookup"><span data-stu-id="d7707-176">An exception handler indicates that it has handled an exception by setting the `Result` property to an action result (for example, an [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx), or a custom result).</span></span> <span data-ttu-id="d7707-177">Si le `Result` propriété a la valeur null, l’exception n’est pas gérée et l’exception d’origine est levée à nouveau.</span><span class="sxs-lookup"><span data-stu-id="d7707-177">If the `Result` property is null, the exception is unhandled and the original exception will be re-thrown.</span></span>

<span data-ttu-id="d7707-178">Pour les exceptions en haut de la pile des appels, nous avons une étape supplémentaire pour garantir que la réponse est appropriée pour les appelants de l’API.</span><span class="sxs-lookup"><span data-stu-id="d7707-178">For exceptions at the top of the call stack, we took an extra step to ensure the response is appropriate for API callers.</span></span> <span data-ttu-id="d7707-179">Si l’exception se propage jusqu'à l’ordinateur hôte, l’appelant verriez l’écran jaune de la mort ou un autre hôte fourni de réponse qui est généralement au format HTML et ne sont généralement pas une réponse d’erreur API appropriée.</span><span class="sxs-lookup"><span data-stu-id="d7707-179">If the exception propagates up to the host, the caller would see the yellow screen of death or some other host provided response which is typically HTML and not usually an appropriate API error response.</span></span> <span data-ttu-id="d7707-180">Dans ce cas, le démarrage du résultat non null, et uniquement si un gestionnaire d’exceptions personnalisé la définit explicitement retour au `null` (non gérées) est l’exception se propager à l’hôte.</span><span class="sxs-lookup"><span data-stu-id="d7707-180">In these cases, the Result starts out non-null, and only if a custom exception handler explicitly sets it back to `null` (unhandled) will the exception propagate to the host.</span></span> <span data-ttu-id="d7707-181">Paramètre `Result` à `null` dans ce cas peut être utile pour deux scénarios :</span><span class="sxs-lookup"><span data-stu-id="d7707-181">Setting `Result` to `null` in such cases can be useful for two scenarios:</span></span>

1. <span data-ttu-id="d7707-182">OWIN hébergé API Web avec les exceptions personnalisées d’intergiciel (middleware) inscrit avant/extérieur API Web.</span><span class="sxs-lookup"><span data-stu-id="d7707-182">OWIN hosted Web API with custom exception handling middleware registered before/outside Web API.</span></span>
2. <span data-ttu-id="d7707-183">Débogage via un navigateur local, où l’écran jaune de la mort est en fait une réponse utile pour une exception non gérée.</span><span class="sxs-lookup"><span data-stu-id="d7707-183">Local debugging via a browser, where the yellow screen of death is actually a helpful response for an unhandled exception.</span></span>

<span data-ttu-id="d7707-184">Pour les gestionnaires d’exceptions et les enregistreurs d’événements exception, nous ne le faites pas quoi que ce soit pour récupérer si l’enregistreur d’événements ou le gestionnaire lui-même lève une exception.</span><span class="sxs-lookup"><span data-stu-id="d7707-184">For both exception loggers and exception handlers, we don't do anything to recover if the logger or handler itself throws an exception.</span></span> <span data-ttu-id="d7707-185">(Autres que de laisser l’exception se propager, laisser des commentaires en bas de cette page si vous avez une meilleure approche.) Le contrat pour les enregistreurs d’événements exception et gestionnaires est qu’ils ne devraient pas laisser exceptions propager jusqu'à leurs appelants ; Sinon, l’exception juste propageront, souvent à l’hôte, ce qui entraîne une erreur HTML (par exemple, le code ASP. Écran jaune de NET) envoyées au client (qui n’est généralement pas l’option recommandée pour les appelants d’API qui attendent JSON ou XML).</span><span class="sxs-lookup"><span data-stu-id="d7707-185">(Other than letting the exception propagate, leave feedback at the bottom of this page if you have a better approach.) The contract for exception loggers and handlers is that they should not let exceptions propagate up to their callers; otherwise, the exception will just propagate, often all the way to the host resulting in an HTML error (like the ASP.NET's yellow screen) being sent back to the client (which usually isn't the preferred option for API callers that expect JSON or XML).</span></span>

## <a name="examples"></a><span data-ttu-id="d7707-186">Exemples</span><span class="sxs-lookup"><span data-stu-id="d7707-186">Examples</span></span>

### <a name="tracing-exception-logger"></a><span data-ttu-id="d7707-187">Enregistreur d’exceptions de suivi</span><span class="sxs-lookup"><span data-stu-id="d7707-187">Tracing Exception Logger</span></span>

<span data-ttu-id="d7707-188">L’enregistreur d’événements exception ci-dessous envoyer des données d’exception à des sources de Trace configurés (y compris la fenêtre de sortie de débogage dans Visual Studio).</span><span class="sxs-lookup"><span data-stu-id="d7707-188">The exception logger below send exception data to configured Trace sources (including the Debug output window in Visual Studio).</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample6.cs)]

### <a name="custom-error-message-exception-handler"></a><span data-ttu-id="d7707-189">Gestionnaire d’exceptions Message erreur personnalisée</span><span class="sxs-lookup"><span data-stu-id="d7707-189">Custom Error Message Exception Handler</span></span>

<span data-ttu-id="d7707-190">Les éléments suivants ci-dessous génère une réponse d’erreur personnalisée aux clients, notamment une adresse de messagerie pour contacter le support.</span><span class="sxs-lookup"><span data-stu-id="d7707-190">The following below produces a custom error response to clients, including an email address for contacting support.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample7.cs)]

## <a name="registering-exception-filters"></a><span data-ttu-id="d7707-191">L’inscription des filtres d’Exception</span><span class="sxs-lookup"><span data-stu-id="d7707-191">Registering Exception Filters</span></span>

<span data-ttu-id="d7707-192">Si vous utilisez le modèle de projet « Application Web ASP.NET MVC 4 » pour créer votre projet, placez votre code de configuration d’API Web à l’intérieur de la `WebApiConfig` de classe, dans le *application/_démarrer* dossier :</span><span class="sxs-lookup"><span data-stu-id="d7707-192">If you use the "ASP.NET MVC 4 Web Application" project template to create your project, put your Web API configuration code inside the `WebApiConfig` class, in the *App/_Start* folder:</span></span>

[!code-csharp[Main](exception-handling/samples/sample7.cs?highlight=5)]

## <a name="appendix-base-class-details"></a><span data-ttu-id="d7707-193">Annexe : Détails de classe de base</span><span class="sxs-lookup"><span data-stu-id="d7707-193">Appendix: Base Class Details</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample8.cs)]
