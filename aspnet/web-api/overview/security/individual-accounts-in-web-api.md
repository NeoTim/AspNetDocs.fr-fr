---
uid: web-api/overview/security/individual-accounts-in-web-api
title: Sécuriser une API Web avec des comptes individuels et une connexion locale dans API Web ASP.NET 2,2 | Microsoft Docs
author: MikeWasson
description: Cette rubrique montre comment sécuriser une API Web à l’aide de OAuth2 pour l’authentification auprès d’une base de données d’appartenance. Versions logicielles utilisées dans le didacticiel Visual Studio 201...
ms.author: riande
ms.date: 10/15/2014
ms.assetid: 92c84846-f0ea-4b5e-94b6-5004874eb060
msc.legacyurl: /web-api/overview/security/individual-accounts-in-web-api
msc.type: authoredcontent
ms.openlocfilehash: 7492c4aa4c2a0a8aeed64c3462bda8fc51f35a6b
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78555194"
---
# <a name="secure-a-web-api-with-individual-accounts-and-local-login-in-aspnet-web-api-22"></a><span data-ttu-id="d37bb-104">Sécuriser une API Web avec des comptes individuels et une connexion locale dans API Web ASP.NET 2,2</span><span class="sxs-lookup"><span data-stu-id="d37bb-104">Secure a Web API with Individual Accounts and Local Login in ASP.NET Web API 2.2</span></span>

<span data-ttu-id="d37bb-105">par [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="d37bb-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

[<span data-ttu-id="d37bb-106">Télécharger l’exemple d’application</span><span class="sxs-lookup"><span data-stu-id="d37bb-106">Download Sample App</span></span>](https://github.com/MikeWasson/LocalAccountsApp)

> <span data-ttu-id="d37bb-107">Cette rubrique montre comment sécuriser une API Web à l’aide de OAuth2 pour l’authentification auprès d’une base de données d’appartenance.</span><span class="sxs-lookup"><span data-stu-id="d37bb-107">This topic shows how to secure a web API using OAuth2 to authenticate against a membership database.</span></span>
> 
> ## <a name="software-versions-used-in-the-tutorial"></a><span data-ttu-id="d37bb-108">Versions logicielles utilisées dans le didacticiel</span><span class="sxs-lookup"><span data-stu-id="d37bb-108">Software versions used in the tutorial</span></span>
> 
> 
> - [<span data-ttu-id="d37bb-109">Visual Studio 2013 Update 3</span><span class="sxs-lookup"><span data-stu-id="d37bb-109">Visual Studio 2013 Update 3</span></span>](https://www.microsoft.com/visualstudio/eng/2013-downloads)
> - [<span data-ttu-id="d37bb-110">API Web 2,2</span><span class="sxs-lookup"><span data-stu-id="d37bb-110">Web API 2.2</span></span>](../releases/whats-new-in-aspnet-web-api-22.md)
> - [<span data-ttu-id="d37bb-111">ASP.NET Identity 2,1</span><span class="sxs-lookup"><span data-stu-id="d37bb-111">ASP.NET Identity 2.1</span></span>](../../../identity/index.md)

<span data-ttu-id="d37bb-112">Dans Visual Studio 2013, le modèle de projet d’API Web vous donne trois options pour l’authentification :</span><span class="sxs-lookup"><span data-stu-id="d37bb-112">In Visual Studio 2013, the Web API project template gives you three options for authentication:</span></span>

- <span data-ttu-id="d37bb-113">**Comptes individuels.**</span><span class="sxs-lookup"><span data-stu-id="d37bb-113">**Individual accounts.**</span></span> <span data-ttu-id="d37bb-114">L’application utilise une base de données d’appartenance.</span><span class="sxs-lookup"><span data-stu-id="d37bb-114">The app uses a membership database.</span></span>
- <span data-ttu-id="d37bb-115">**Comptes organisationnels.**</span><span class="sxs-lookup"><span data-stu-id="d37bb-115">**Organizational accounts.**</span></span> <span data-ttu-id="d37bb-116">Les utilisateurs se connectent avec leur Azure Active Directory, Office 365 ou des informations d’identification Active Directory locales.</span><span class="sxs-lookup"><span data-stu-id="d37bb-116">Users sign in with their Azure Active Directory, Office 365, or on-premise Active Directory credentials.</span></span>
- <span data-ttu-id="d37bb-117">**Authentification Windows.**</span><span class="sxs-lookup"><span data-stu-id="d37bb-117">**Windows authentication.**</span></span> <span data-ttu-id="d37bb-118">Cette option est destinée aux applications intranet et utilise le module IIS d’authentification Windows.</span><span class="sxs-lookup"><span data-stu-id="d37bb-118">This option is intended for Intranet applications, and uses the Windows Authentication IIS module.</span></span>

<span data-ttu-id="d37bb-119">Pour plus d’informations sur ces options, consultez [création de projets Web ASP.net dans Visual Studio 2013](../../../visual-studio/overview/2013/creating-web-projects-in-visual-studio.md#auth).</span><span class="sxs-lookup"><span data-stu-id="d37bb-119">For more details about these options, see [Creating ASP.NET Web Projects in Visual Studio 2013](../../../visual-studio/overview/2013/creating-web-projects-in-visual-studio.md#auth).</span></span>

<span data-ttu-id="d37bb-120">Les comptes individuels offrent deux moyens de se connecter à un utilisateur :</span><span class="sxs-lookup"><span data-stu-id="d37bb-120">Individual accounts provide two ways for a user to log in:</span></span>

- <span data-ttu-id="d37bb-121">**Connexion locale**.</span><span class="sxs-lookup"><span data-stu-id="d37bb-121">**Local login**.</span></span> <span data-ttu-id="d37bb-122">L’utilisateur s’inscrit sur le site, en entrant un nom d’utilisateur et un mot de passe.</span><span class="sxs-lookup"><span data-stu-id="d37bb-122">The user registers at the site, entering a username and password.</span></span> <span data-ttu-id="d37bb-123">L’application stocke le hachage de mot de passe dans la base de données d’appartenance.</span><span class="sxs-lookup"><span data-stu-id="d37bb-123">The app stores the password hash in the membership database.</span></span> <span data-ttu-id="d37bb-124">Lorsque l’utilisateur se connecte, le système de ASP.NET Identity vérifie le mot de passe.</span><span class="sxs-lookup"><span data-stu-id="d37bb-124">When the user logs in, the ASP.NET Identity system verifies the password.</span></span>
- <span data-ttu-id="d37bb-125">**Connexion sociale**.</span><span class="sxs-lookup"><span data-stu-id="d37bb-125">**Social login**.</span></span> <span data-ttu-id="d37bb-126">L’utilisateur se connecte avec un service externe, tel que Facebook, Microsoft ou Google.</span><span class="sxs-lookup"><span data-stu-id="d37bb-126">The user signs in with an external service, such as Facebook, Microsoft, or Google.</span></span> <span data-ttu-id="d37bb-127">L’application crée toujours une entrée pour l’utilisateur dans la base de données d’appartenance, mais ne stocke pas les informations d’identification.</span><span class="sxs-lookup"><span data-stu-id="d37bb-127">The app still creates an entry for the user in the membership database, but does not store any credentials.</span></span> <span data-ttu-id="d37bb-128">L’utilisateur s’authentifie en se connectant au service externe.</span><span class="sxs-lookup"><span data-stu-id="d37bb-128">The user authenticates by signing into the external service.</span></span>

<span data-ttu-id="d37bb-129">Cet article examine le scénario de connexion locale.</span><span class="sxs-lookup"><span data-stu-id="d37bb-129">This article looks at the local login scenario.</span></span> <span data-ttu-id="d37bb-130">Pour les connexions locales et sociales, l’API Web utilise OAuth2 pour authentifier les demandes.</span><span class="sxs-lookup"><span data-stu-id="d37bb-130">For both local and social login, Web API uses OAuth2 to authenticate requests.</span></span> <span data-ttu-id="d37bb-131">Toutefois, les flux d’informations d’identification sont différents pour les connexions locales et sociales.</span><span class="sxs-lookup"><span data-stu-id="d37bb-131">However, the credential flows are different for local and social login.</span></span>

<span data-ttu-id="d37bb-132">Dans cet article, je démontrerai une application simple qui permet à l’utilisateur de se connecter et d’envoyer des appels AJAX authentifiés à une API Web.</span><span class="sxs-lookup"><span data-stu-id="d37bb-132">In this article, I'll demonstrate a simple app that lets the user log in and send authenticated AJAX calls to a web API.</span></span> <span data-ttu-id="d37bb-133">Vous pouvez télécharger l’exemple de code [ici](https://github.com/MikeWasson/LocalAccountsApp).</span><span class="sxs-lookup"><span data-stu-id="d37bb-133">You can download the sample code [here](https://github.com/MikeWasson/LocalAccountsApp).</span></span> <span data-ttu-id="d37bb-134">Le fichier Lisez-moi explique comment créer l’exemple à partir de zéro dans Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="d37bb-134">The readme describes how to create the sample from scratch in Visual Studio.</span></span>

[![](individual-accounts-in-web-api/_static/image2.png)](individual-accounts-in-web-api/_static/image1.png)

<span data-ttu-id="d37bb-135">L’exemple d’application utilise Knockout. js pour la liaison de données et jQuery pour l’envoi de demandes AJAX.</span><span class="sxs-lookup"><span data-stu-id="d37bb-135">The sample app uses Knockout.js for data-binding and jQuery for sending AJAX requests.</span></span> <span data-ttu-id="d37bb-136">Je me concentrerai sur les appels AJAX. vous n’avez donc pas besoin de connaître Knockout. js pour cet article.</span><span class="sxs-lookup"><span data-stu-id="d37bb-136">I'll be focusing on the AJAX calls, so you don't need to know Knockout.js for this article.</span></span>

<span data-ttu-id="d37bb-137">En cours de route, je décrirai les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="d37bb-137">Along the way, I'll describe:</span></span>

- <span data-ttu-id="d37bb-138">Ce que fait l’application côté client.</span><span class="sxs-lookup"><span data-stu-id="d37bb-138">What the app is doing on the client side.</span></span>
- <span data-ttu-id="d37bb-139">Ce qui se passe sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-139">What's happening on the server.</span></span>
- <span data-ttu-id="d37bb-140">Le trafic HTTP en milieu.</span><span class="sxs-lookup"><span data-stu-id="d37bb-140">The HTTP traffic in the middle.</span></span>

<span data-ttu-id="d37bb-141">Tout d’abord, nous devons définir une terminologie OAuth2.</span><span class="sxs-lookup"><span data-stu-id="d37bb-141">First, we need to define some OAuth2 terminology.</span></span>

- <span data-ttu-id="d37bb-142">*Ressource*.</span><span class="sxs-lookup"><span data-stu-id="d37bb-142">*Resource*.</span></span> <span data-ttu-id="d37bb-143">Certains éléments de données qui peuvent être protégés.</span><span class="sxs-lookup"><span data-stu-id="d37bb-143">Some piece of data that can be protected.</span></span>
- <span data-ttu-id="d37bb-144">*Serveur de ressources*.</span><span class="sxs-lookup"><span data-stu-id="d37bb-144">*Resource server*.</span></span> <span data-ttu-id="d37bb-145">Serveur qui héberge la ressource.</span><span class="sxs-lookup"><span data-stu-id="d37bb-145">The server that hosts the resource.</span></span>
- <span data-ttu-id="d37bb-146">*Propriétaire*de la ressource.</span><span class="sxs-lookup"><span data-stu-id="d37bb-146">*Resource owner*.</span></span> <span data-ttu-id="d37bb-147">Entité qui peut accorder l’autorisation d’accéder à une ressource.</span><span class="sxs-lookup"><span data-stu-id="d37bb-147">The entity that can grant permission to access a resource.</span></span> <span data-ttu-id="d37bb-148">(Généralement l’utilisateur.)</span><span class="sxs-lookup"><span data-stu-id="d37bb-148">(Typically the user.)</span></span>
- <span data-ttu-id="d37bb-149">*Client*: application qui souhaite accéder à la ressource.</span><span class="sxs-lookup"><span data-stu-id="d37bb-149">*Client*: The app that wants access to the resource.</span></span> <span data-ttu-id="d37bb-150">Dans cet article, le client est un navigateur Web.</span><span class="sxs-lookup"><span data-stu-id="d37bb-150">In this article, the client is a web browser.</span></span>
- <span data-ttu-id="d37bb-151">*Jeton d’accès*.</span><span class="sxs-lookup"><span data-stu-id="d37bb-151">*Access token*.</span></span> <span data-ttu-id="d37bb-152">Jeton qui accorde l’accès à une ressource.</span><span class="sxs-lookup"><span data-stu-id="d37bb-152">A token that grants access to a resource.</span></span>
- <span data-ttu-id="d37bb-153">*Jeton du porteur*.</span><span class="sxs-lookup"><span data-stu-id="d37bb-153">*Bearer token*.</span></span> <span data-ttu-id="d37bb-154">Type particulier de jeton d’accès, avec la propriété que tout le monde peut utiliser.</span><span class="sxs-lookup"><span data-stu-id="d37bb-154">A particular type of access token, with the property that anyone can use the token.</span></span> <span data-ttu-id="d37bb-155">En d’autres termes, un client n’a pas besoin d’une clé de chiffrement ou d’un autre secret pour utiliser un jeton de porteur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-155">In other words, a client doesn't need a cryptographic key or other secret to use a bearer token.</span></span> <span data-ttu-id="d37bb-156">Pour cette raison, les jetons du porteur doivent uniquement être utilisés sur un HTTPs et doivent avoir des délais d’expiration relativement courts.</span><span class="sxs-lookup"><span data-stu-id="d37bb-156">For that reason, bearer tokens should only be used over a HTTPS, and should have relatively short expiration times.</span></span>
- <span data-ttu-id="d37bb-157">*Serveur d’autorisation*.</span><span class="sxs-lookup"><span data-stu-id="d37bb-157">*Authorization server*.</span></span> <span data-ttu-id="d37bb-158">Serveur qui fournit des jetons d’accès.</span><span class="sxs-lookup"><span data-stu-id="d37bb-158">A server that gives out access tokens.</span></span>

<span data-ttu-id="d37bb-159">Une application peut agir à la fois comme serveur d’autorisation et serveur de ressources.</span><span class="sxs-lookup"><span data-stu-id="d37bb-159">An application can act as both authorization server and resource server.</span></span> <span data-ttu-id="d37bb-160">Le modèle de projet d’API Web suit ce modèle.</span><span class="sxs-lookup"><span data-stu-id="d37bb-160">The Web API project template follows this pattern.</span></span>

## <a name="local-login-credential-flow"></a><span data-ttu-id="d37bb-161">Workflow des informations d’identification de connexion locales</span><span class="sxs-lookup"><span data-stu-id="d37bb-161">Local Login Credential Flow</span></span>

<span data-ttu-id="d37bb-162">Pour la connexion locale, l’API Web utilise le [Workflow de propriétaire](http://oauthlib.readthedocs.org/en/latest/oauth2/grants/password.html) de la ressource défini dans OAuth2.</span><span class="sxs-lookup"><span data-stu-id="d37bb-162">For local login, Web API uses the [resource owner password flow](http://oauthlib.readthedocs.org/en/latest/oauth2/grants/password.html) defined in OAuth2.</span></span>

1. <span data-ttu-id="d37bb-163">L’utilisateur entre un nom et un mot de passe dans le client.</span><span class="sxs-lookup"><span data-stu-id="d37bb-163">The user enters a name and password into the client.</span></span>
2. <span data-ttu-id="d37bb-164">Le client envoie ces informations d’identification au serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="d37bb-164">The client sends these credentials to the authorization server.</span></span>
3. <span data-ttu-id="d37bb-165">Le serveur d’autorisation authentifie les informations d’identification et retourne un jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="d37bb-165">The authorization server authenticates the credentials and returns an access token.</span></span>
4. <span data-ttu-id="d37bb-166">Pour accéder à une ressource protégée, le client comprend le jeton d’accès dans l’en-tête d’autorisation de la requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="d37bb-166">To access a protected resource, the client includes the access token in the Authorization header of the HTTP request.</span></span>

![](individual-accounts-in-web-api/_static/image3.png)

<span data-ttu-id="d37bb-167">Lorsque vous sélectionnez **des comptes individuels** dans le modèle de projet d’API Web, le projet comprend un serveur d’autorisation qui valide les informations d’identification de l’utilisateur et émet des jetons.</span><span class="sxs-lookup"><span data-stu-id="d37bb-167">When you select **Individual accounts** in the Web API project template, the project includes an authorization server that validates user credentials and issues tokens.</span></span> <span data-ttu-id="d37bb-168">Le diagramme suivant montre le même Workflow d’informations d’identification en termes de composants d’API Web.</span><span class="sxs-lookup"><span data-stu-id="d37bb-168">The following diagram shows the same credential flow in terms of Web API components.</span></span>

![](individual-accounts-in-web-api/_static/image4.png)

<span data-ttu-id="d37bb-169">Dans ce scénario, les contrôleurs d’API Web agissent en tant que serveurs de ressources.</span><span class="sxs-lookup"><span data-stu-id="d37bb-169">In this scenario, Web API controllers act as resource servers.</span></span> <span data-ttu-id="d37bb-170">Un filtre d’authentification valide les jetons d’accès et l’attribut **[Authorize]** est utilisé pour protéger une ressource.</span><span class="sxs-lookup"><span data-stu-id="d37bb-170">An authentication filter validates access tokens, and the **[Authorize]** attribute is used to protect a resource.</span></span> <span data-ttu-id="d37bb-171">Lorsqu’un contrôleur ou une action possède l’attribut **[Authorize]** , toutes les demandes adressées à ce contrôleur ou cette action doivent être authentifiées.</span><span class="sxs-lookup"><span data-stu-id="d37bb-171">When a controller or action has the **[Authorize]** attribute, all requests to that controller or action must be authenticated.</span></span> <span data-ttu-id="d37bb-172">Dans le cas contraire, l’autorisation est refusée et l’API Web renvoie une erreur 401 (non autorisée).</span><span class="sxs-lookup"><span data-stu-id="d37bb-172">Otherwise, authorization is denied, and Web API returns a 401 (Unauthorized) error.</span></span>

<span data-ttu-id="d37bb-173">Le serveur d’autorisation et le filtre d’authentification appellent tous les deux un composant [middleware OWIN](../../../aspnet/overview/owin-and-katana/an-overview-of-project-katana.md) qui gère les détails de OAuth2.</span><span class="sxs-lookup"><span data-stu-id="d37bb-173">The authorization server and the authentication filter both call into an [OWIN middleware](../../../aspnet/overview/owin-and-katana/an-overview-of-project-katana.md) component that handles the details of OAuth2.</span></span> <span data-ttu-id="d37bb-174">Je décrirai la conception plus en détail plus loin dans ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="d37bb-174">I'll describe the design in more detail later in this tutorial.</span></span>

## <a name="sending-an-unauthorized-request"></a><span data-ttu-id="d37bb-175">Envoi d’une demande non autorisée</span><span class="sxs-lookup"><span data-stu-id="d37bb-175">Sending an Unauthorized Request</span></span>

<span data-ttu-id="d37bb-176">Pour commencer, exécutez l’application et cliquez sur le bouton **appeler l’API** .</span><span class="sxs-lookup"><span data-stu-id="d37bb-176">To get started, run the app and click the **Call API** button.</span></span> <span data-ttu-id="d37bb-177">Une fois la demande terminée, un message d’erreur doit s’afficher dans la zone de **résultats** .</span><span class="sxs-lookup"><span data-stu-id="d37bb-177">When the request completes, you should see an error message in the **Result** box.</span></span> <span data-ttu-id="d37bb-178">Cela est dû au fait que la demande ne contient pas de jeton d’accès, donc la demande n’est pas autorisée.</span><span class="sxs-lookup"><span data-stu-id="d37bb-178">That's because the request does not contain an access token, so the request is unauthorized.</span></span>

[![](individual-accounts-in-web-api/_static/image6.png)](individual-accounts-in-web-api/_static/image5.png)

<span data-ttu-id="d37bb-179">Le bouton **appeler l’API** envoie une requête Ajax à ~/API/Values, qui appelle une action de contrôleur d’API Web.</span><span class="sxs-lookup"><span data-stu-id="d37bb-179">The **Call API** button sends an AJAX request to ~/api/values, which invokes a Web API controller action.</span></span> <span data-ttu-id="d37bb-180">Voici la section du code JavaScript qui envoie la requête AJAX.</span><span class="sxs-lookup"><span data-stu-id="d37bb-180">Here is the section of JavaScript code that sends the AJAX request.</span></span> <span data-ttu-id="d37bb-181">Dans l’exemple d’application, tout le code de l’application JavaScript se trouve dans le fichier Scripts\app.js.</span><span class="sxs-lookup"><span data-stu-id="d37bb-181">In the sample app, all of the JavaScript app code is located in the Scripts\app.js file.</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample1.js)]

<span data-ttu-id="d37bb-182">Tant que l’utilisateur ne se connecte pas, il n’y a aucun jeton de porteur et, par conséquent, aucun en-tête d’autorisation dans la demande.</span><span class="sxs-lookup"><span data-stu-id="d37bb-182">Until the user logs in, there is no bearer token, and therefore no Authorization header in the request.</span></span> <span data-ttu-id="d37bb-183">La requête retourne alors une erreur 401.</span><span class="sxs-lookup"><span data-stu-id="d37bb-183">This causes the request to return a 401 error.</span></span>

<span data-ttu-id="d37bb-184">Voici la requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="d37bb-184">Here is the HTTP request.</span></span> <span data-ttu-id="d37bb-185">(J’ai utilisé [Fiddler](http://www.telerik.com/fiddler) pour capturer le trafic http.)</span><span class="sxs-lookup"><span data-stu-id="d37bb-185">(I used [Fiddler](http://www.telerik.com/fiddler) to capture the HTTP traffic.)</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample2.cmd)]

<span data-ttu-id="d37bb-186">Réponse HTTP :</span><span class="sxs-lookup"><span data-stu-id="d37bb-186">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample3.cmd?highlight=1,4)]

<span data-ttu-id="d37bb-187">Notez que la réponse comprend un en-tête WWW-Authenticate avec la stimulation définie sur Bearer.</span><span class="sxs-lookup"><span data-stu-id="d37bb-187">Notice that the response includes a Www-Authenticate header with the challenge set to Bearer.</span></span> <span data-ttu-id="d37bb-188">Cela indique que le serveur attend un jeton de porteur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-188">That indicates the server expects a bearer token.</span></span>

## <a name="register-a-user"></a><span data-ttu-id="d37bb-189">Inscrire un utilisateur</span><span class="sxs-lookup"><span data-stu-id="d37bb-189">Register a User</span></span>

<span data-ttu-id="d37bb-190">Dans la section **Register** de l’application, entrez un e-mail et un mot de passe, puis cliquez sur le bouton **Register** .</span><span class="sxs-lookup"><span data-stu-id="d37bb-190">In the **Register** section of the app, enter an email and password, and click the **Register** button.</span></span>

<span data-ttu-id="d37bb-191">Vous n’avez pas besoin d’utiliser une adresse de messagerie valide pour cet exemple, mais une application réelle confirmerait l’adresse.</span><span class="sxs-lookup"><span data-stu-id="d37bb-191">You don't need to use a valid email address for this sample, but a real app would confirm the address.</span></span> <span data-ttu-id="d37bb-192">(Pour plus d’informations [, consultez créer une application web ASP.NET MVC 5 sécurisée avec connexion, confirmation par e-mail et réinitialisation du mot de passe](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).) Pour le mot de passe, utilisez un nom tel que « Password1 ! », avec une lettre majuscule, une lettre minuscule, un chiffre et un caractère non alphanumérique.</span><span class="sxs-lookup"><span data-stu-id="d37bb-192">(See [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).) For the password, use something like "Password1!", with an upper case letter, lower case letter, number, and non-alpha-numeric character.</span></span> <span data-ttu-id="d37bb-193">Pour simplifier l’application, j’ai quitté la validation côté client. par conséquent, en cas de problème avec le format du mot de passe, vous obtenez une erreur 400 (demande incorrecte).</span><span class="sxs-lookup"><span data-stu-id="d37bb-193">To keep the app simple, I left out client-side validation, so if there is a problem with the password format, you'll get a 400 (Bad Request) error.</span></span>

[![](individual-accounts-in-web-api/_static/image8.png)](individual-accounts-in-web-api/_static/image7.png)

<span data-ttu-id="d37bb-194">Le bouton **Register** envoie une demande de publication à ~/API/Account/Register/.</span><span class="sxs-lookup"><span data-stu-id="d37bb-194">The **Register** button sends a POST request to ~/api/Account/Register/.</span></span> <span data-ttu-id="d37bb-195">Le corps de la demande est un objet JSON qui contient le nom et le mot de passe.</span><span class="sxs-lookup"><span data-stu-id="d37bb-195">The request body is a JSON object that holds the name and password.</span></span> <span data-ttu-id="d37bb-196">Voici le code JavaScript qui envoie la requête :</span><span class="sxs-lookup"><span data-stu-id="d37bb-196">Here is the JavaScript code that sends the request:</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample4.js)]

<span data-ttu-id="d37bb-197">Requête HTTP :</span><span class="sxs-lookup"><span data-stu-id="d37bb-197">HTTP request:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample5.cmd?highlight=5,10)]

<span data-ttu-id="d37bb-198">Réponse HTTP :</span><span class="sxs-lookup"><span data-stu-id="d37bb-198">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample6.cmd)]

<span data-ttu-id="d37bb-199">Cette requête est gérée par la classe `AccountController`.</span><span class="sxs-lookup"><span data-stu-id="d37bb-199">This request is handled by the `AccountController` class.</span></span> <span data-ttu-id="d37bb-200">En interne, `AccountController` utilise ASP.NET Identity pour gérer la base de données d’appartenance.</span><span class="sxs-lookup"><span data-stu-id="d37bb-200">Internally, `AccountController` uses ASP.NET Identity to manage the membership database.</span></span>

<span data-ttu-id="d37bb-201">Si vous exécutez l’application localement à partir de Visual Studio, les comptes d’utilisateur sont stockés dans la base de données locale, dans la table AspNetUsers.</span><span class="sxs-lookup"><span data-stu-id="d37bb-201">If you run the app locally from Visual Studio, user accounts are stored in LocalDB, in the AspNetUsers table.</span></span> <span data-ttu-id="d37bb-202">Pour afficher les tables dans Visual Studio, cliquez sur le menu **affichage** , sélectionnez **Explorateur de serveurs**, puis **connexions de données**.</span><span class="sxs-lookup"><span data-stu-id="d37bb-202">To view the tables in Visual Studio, click the **View** menu, select **Server Explorer**, then expand **Data Connections**.</span></span>

![](individual-accounts-in-web-api/_static/image9.png)

## <a name="get-an-access-token"></a><span data-ttu-id="d37bb-203">Recevoir un jeton d’accès</span><span class="sxs-lookup"><span data-stu-id="d37bb-203">Get an Access Token</span></span>

<span data-ttu-id="d37bb-204">Jusqu’à présent, nous n’avons pas effectué d’OAuth, mais nous allons maintenant voir le serveur d’autorisation OAuth en action, lorsque nous demanderons un jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="d37bb-204">So far we have not done any OAuth, but now we'll see the OAuth authorization server in action, when we request an access token.</span></span> <span data-ttu-id="d37bb-205">Dans la zone de **connexion** de l’exemple d’application, entrez l’adresse de messagerie et le mot de passe, puis cliquez sur **se connecter**.</span><span class="sxs-lookup"><span data-stu-id="d37bb-205">In the **Log In** area of the sample app, enter the email and password and click **Log In**.</span></span>

[![](individual-accounts-in-web-api/_static/image11.png)](individual-accounts-in-web-api/_static/image10.png)

<span data-ttu-id="d37bb-206">Le bouton **se connecter** envoie une demande au point de terminaison de jeton.</span><span class="sxs-lookup"><span data-stu-id="d37bb-206">The **Log In** button sends a request to the token endpoint.</span></span> <span data-ttu-id="d37bb-207">Le corps de la demande contient les données de formulaire suivantes, codées URL :</span><span class="sxs-lookup"><span data-stu-id="d37bb-207">The body of the request contains the following form-url-encoded data:</span></span>

- <span data-ttu-id="d37bb-208">Grant\_type : "password"</span><span class="sxs-lookup"><span data-stu-id="d37bb-208">grant\_type: "password"</span></span>
- <span data-ttu-id="d37bb-209">nom d’utilisateur : &lt;l’adresse de messagerie de l’utilisateur&gt;</span><span class="sxs-lookup"><span data-stu-id="d37bb-209">username: &lt;the user's email&gt;</span></span>
- <span data-ttu-id="d37bb-210">mot de passe : &lt;mot de passe&gt;</span><span class="sxs-lookup"><span data-stu-id="d37bb-210">password: &lt;password&gt;</span></span>

<span data-ttu-id="d37bb-211">Voici le code JavaScript qui envoie la requête AJAX :</span><span class="sxs-lookup"><span data-stu-id="d37bb-211">Here is the JavaScript code that sends the AJAX request:</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample7.js?highlight=14)]

<span data-ttu-id="d37bb-212">Si la demande est réussie, le serveur d’autorisation retourne un jeton d’accès dans le corps de la réponse.</span><span class="sxs-lookup"><span data-stu-id="d37bb-212">If the request succeeds, the authorization server returns an access token in the response body.</span></span> <span data-ttu-id="d37bb-213">Notez que nous stockons le jeton dans le stockage de session, afin de l’utiliser ultérieurement lors de l’envoi de requêtes à l’API.</span><span class="sxs-lookup"><span data-stu-id="d37bb-213">Notice that we store the token in session storage, to use later when sending requests to the API.</span></span> <span data-ttu-id="d37bb-214">Contrairement à certaines formes d’authentification (telles que l’authentification basée sur les cookies), le navigateur n’inclut pas automatiquement le jeton d’accès dans les demandes suivantes.</span><span class="sxs-lookup"><span data-stu-id="d37bb-214">Unlike some forms of authentication (such as cookie-based authentication), the browser will not automatically include the access token in subsequent requests.</span></span> <span data-ttu-id="d37bb-215">L’application doit le faire explicitement.</span><span class="sxs-lookup"><span data-stu-id="d37bb-215">The application must do so explicitly.</span></span> <span data-ttu-id="d37bb-216">C’est une bonne chose, car elle limite les [vulnérabilités de CSRF](preventing-cross-site-request-forgery-csrf-attacks.md).</span><span class="sxs-lookup"><span data-stu-id="d37bb-216">That's a good thing, because it limits [CSRF vulnerabilities](preventing-cross-site-request-forgery-csrf-attacks.md).</span></span>

<span data-ttu-id="d37bb-217">Requête HTTP :</span><span class="sxs-lookup"><span data-stu-id="d37bb-217">HTTP request:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample8.cmd?highlight=5,10)]

<span data-ttu-id="d37bb-218">Vous pouvez voir que la demande contient les informations d’identification de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-218">You can see that the request contains the user's credentials.</span></span> <span data-ttu-id="d37bb-219">Vous *devez* utiliser le protocole HTTPS pour assurer la sécurité de la couche de transport.</span><span class="sxs-lookup"><span data-stu-id="d37bb-219">You *must* use HTTPS to provide transport layer security.</span></span>

<span data-ttu-id="d37bb-220">Réponse HTTP :</span><span class="sxs-lookup"><span data-stu-id="d37bb-220">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample9.cmd?highlight=8)]

<span data-ttu-id="d37bb-221">Pour une meilleure lisibilité, j’ai mis en retrait le JSON et tronqué le jeton d’accès, ce qui est très long.</span><span class="sxs-lookup"><span data-stu-id="d37bb-221">For readability, I indented the JSON and truncated the access token, which is a quite long.</span></span>

<span data-ttu-id="d37bb-222">Les propriétés `access_token`, `token_type`et `expires_in` sont définies par la spécification OAuth2. Les autres propriétés (`userName`, `.issued`et `.expires`) sont fournies à titre d’information uniquement.</span><span class="sxs-lookup"><span data-stu-id="d37bb-222">The `access_token`, `token_type`, and `expires_in` properties are defined by the OAuth2 spec. The other properties (`userName`, `.issued`, and `.expires`) are just for informational purposes.</span></span> <span data-ttu-id="d37bb-223">Vous pouvez trouver le code qui ajoute ces propriétés supplémentaires dans la méthode `TokenEndpoint`, dans le fichier/Providers/ApplicationOAuthProvider.cs.</span><span class="sxs-lookup"><span data-stu-id="d37bb-223">You can find the code that adds those additional properties in the `TokenEndpoint` method, in the /Providers/ApplicationOAuthProvider.cs file.</span></span>

## <a name="send-an-authenticated-request"></a><span data-ttu-id="d37bb-224">Envoyer une demande authentifiée</span><span class="sxs-lookup"><span data-stu-id="d37bb-224">Send an Authenticated Request</span></span>

<span data-ttu-id="d37bb-225">Maintenant que nous avons un jeton de porteur, nous pouvons effectuer une demande authentifiée auprès de l’API.</span><span class="sxs-lookup"><span data-stu-id="d37bb-225">Now that we have a bearer token, we can make an authenticated request to the API.</span></span> <span data-ttu-id="d37bb-226">Pour ce faire, définissez l’en-tête d’autorisation dans la demande.</span><span class="sxs-lookup"><span data-stu-id="d37bb-226">This is done by setting the Authorization header in the request.</span></span> <span data-ttu-id="d37bb-227">Cliquez à nouveau sur le bouton **appeler l’API** pour le voir.</span><span class="sxs-lookup"><span data-stu-id="d37bb-227">Click the **Call API** button again to see this.</span></span>

[![](individual-accounts-in-web-api/_static/image13.png)](individual-accounts-in-web-api/_static/image12.png)

<span data-ttu-id="d37bb-228">Requête HTTP :</span><span class="sxs-lookup"><span data-stu-id="d37bb-228">HTTP request:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample10.cmd?highlight=5)]

<span data-ttu-id="d37bb-229">Réponse HTTP :</span><span class="sxs-lookup"><span data-stu-id="d37bb-229">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample11.cmd)]

## <a name="log-out"></a><span data-ttu-id="d37bb-230">Se déconnecter</span><span class="sxs-lookup"><span data-stu-id="d37bb-230">Log Out</span></span>

<span data-ttu-id="d37bb-231">Étant donné que le navigateur ne met pas en cache les informations d’identification ou le jeton d’accès, la déconnexion consiste simplement à oublier le jeton, en le supprimant du stockage de session :</span><span class="sxs-lookup"><span data-stu-id="d37bb-231">Because the browser does not cache the credentials or the access token, logging out is simply a matter of "forgetting" the token, by removing it from session storage:</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample12.js)]

## <a name="understanding-the-individual-accounts-project-template"></a><span data-ttu-id="d37bb-232">Fonctionnement du modèle de projet comptes individuels</span><span class="sxs-lookup"><span data-stu-id="d37bb-232">Understanding the Individual Accounts Project Template</span></span>

<span data-ttu-id="d37bb-233">Lorsque vous sélectionnez **des comptes individuels** dans le modèle de projet d’Application Web ASP.net, le projet comprend les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="d37bb-233">When you select **Individual Accounts** in the ASP.NET Web Application project template, the project includes:</span></span>

- <span data-ttu-id="d37bb-234">Un serveur d’autorisation OAuth2.</span><span class="sxs-lookup"><span data-stu-id="d37bb-234">An OAuth2 authorization server.</span></span>
- <span data-ttu-id="d37bb-235">Point de terminaison d’API Web pour la gestion des comptes d’utilisateur</span><span class="sxs-lookup"><span data-stu-id="d37bb-235">A Web API endpoint for managing user accounts</span></span>
- <span data-ttu-id="d37bb-236">Modèle EF pour le stockage des comptes d’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-236">An EF model for storing user accounts.</span></span>

<span data-ttu-id="d37bb-237">Voici les principales classes d’application qui implémentent ces fonctionnalités :</span><span class="sxs-lookup"><span data-stu-id="d37bb-237">Here are the main application classes that implement these features:</span></span>

- <span data-ttu-id="d37bb-238">`AccountController`.</span><span class="sxs-lookup"><span data-stu-id="d37bb-238">`AccountController`.</span></span> <span data-ttu-id="d37bb-239">Fournit un point de terminaison d’API Web pour la gestion des comptes d’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-239">Provides a Web API endpoint for managing user accounts.</span></span> <span data-ttu-id="d37bb-240">Le `Register` action est le seul que nous avons utilisé dans ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="d37bb-240">The `Register` action is the only one that we used in this tutorial.</span></span> <span data-ttu-id="d37bb-241">D’autres méthodes de la classe prennent en charge la réinitialisation de mot de passe, les connexions sociales et d’autres fonctionnalités.</span><span class="sxs-lookup"><span data-stu-id="d37bb-241">Other methods on the class support password reset, social logins, and other functionality.</span></span>
- <span data-ttu-id="d37bb-242">`ApplicationUser`, défini dans/Models/IdentityModels.cs.</span><span class="sxs-lookup"><span data-stu-id="d37bb-242">`ApplicationUser`, defined in /Models/IdentityModels.cs.</span></span> <span data-ttu-id="d37bb-243">Cette classe est le modèle EF pour les comptes d’utilisateur dans la base de données d’appartenance.</span><span class="sxs-lookup"><span data-stu-id="d37bb-243">This class is the EF model for user accounts in the membership database.</span></span>
- <span data-ttu-id="d37bb-244">`ApplicationUserManager`, défini dans/App\_Start/IdentityConfig. cs cette classe dérive de [usermanager](https://msdn.microsoft.com/library/dn613290.aspx) et effectue des opérations sur les comptes d’utilisateur, telles que la création d’un utilisateur, la vérification des mots de passe, etc., et conserve automatiquement les modifications apportées à la base de données.</span><span class="sxs-lookup"><span data-stu-id="d37bb-244">`ApplicationUserManager`, defined in /App\_Start/IdentityConfig.cs This class derives from [UserManager](https://msdn.microsoft.com/library/dn613290.aspx) and performs operations on user accounts, such as creating a new user, verifying passwords, and so forth, and automatically persists changes to the database.</span></span>
- <span data-ttu-id="d37bb-245">`ApplicationOAuthProvider`.</span><span class="sxs-lookup"><span data-stu-id="d37bb-245">`ApplicationOAuthProvider`.</span></span> <span data-ttu-id="d37bb-246">Cet objet se connecte à l’intergiciel (middleware) OWIN et traite les événements déclenchés par l’intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="d37bb-246">This object plugs into the OWIN middleware, and processes events raised by the middleware.</span></span> <span data-ttu-id="d37bb-247">Il dérive de [OAuthAuthorizationServerProvider](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserverprovider.aspx).</span><span class="sxs-lookup"><span data-stu-id="d37bb-247">It derives from [OAuthAuthorizationServerProvider](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserverprovider.aspx).</span></span>

![](individual-accounts-in-web-api/_static/image14.png)

### <a name="configuring-the-authorization-server"></a><span data-ttu-id="d37bb-248">Configuration du serveur d’autorisation</span><span class="sxs-lookup"><span data-stu-id="d37bb-248">Configuring the Authorization Server</span></span>

<span data-ttu-id="d37bb-249">Dans StartupAuth.cs, le code suivant configure le serveur d’autorisation OAuth2.</span><span class="sxs-lookup"><span data-stu-id="d37bb-249">In StartupAuth.cs, the following code configures the OAuth2 authorization server.</span></span>

[!code-csharp[Main](individual-accounts-in-web-api/samples/sample13.cs)]

<span data-ttu-id="d37bb-250">La propriété `TokenEndpointPath` est le chemin d’accès à l’URL du point de terminaison du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="d37bb-250">The `TokenEndpointPath` property is the URL path to the authorization server endpoint.</span></span> <span data-ttu-id="d37bb-251">Il s’agit de l’URL utilisée par l’application pour recevoir les jetons du porteur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-251">That's the URL that app uses to get the bearer tokens.</span></span>

<span data-ttu-id="d37bb-252">La propriété `Provider` spécifie un fournisseur qui se connecte à l’intergiciel (middleware) OWIN et traite les événements déclenchés par l’intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="d37bb-252">The `Provider` property specifies a provider that plugs into the OWIN middleware, and processes events raised by the middleware.</span></span>

<span data-ttu-id="d37bb-253">Voici le processus de base lorsque l’application souhaite obtenir un jeton :</span><span class="sxs-lookup"><span data-stu-id="d37bb-253">Here is the basic flow when the app wants to get a token:</span></span>

1. <span data-ttu-id="d37bb-254">Pour obtenir un jeton d’accès, l’application envoie une requête à ~/token.</span><span class="sxs-lookup"><span data-stu-id="d37bb-254">To get an access token, the app sends a request to ~/Token.</span></span>
2. <span data-ttu-id="d37bb-255">L’intergiciel (middleware) OAuth appelle `GrantResourceOwnerCredentials` sur le fournisseur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-255">The OAuth middleware calls `GrantResourceOwnerCredentials` on the provider.</span></span>
3. <span data-ttu-id="d37bb-256">Le fournisseur appelle la `ApplicationUserManager` pour valider les informations d’identification et créer une identité basée sur les revendications.</span><span class="sxs-lookup"><span data-stu-id="d37bb-256">The provider calls the `ApplicationUserManager` to validate the credentials and create a claims identity.</span></span>
4. <span data-ttu-id="d37bb-257">En cas de tentative, le fournisseur crée un ticket d’authentification, qui est utilisé pour générer le jeton.</span><span class="sxs-lookup"><span data-stu-id="d37bb-257">If that succeeds, the provider creates an authentication ticket, which is used to generate the token.</span></span>

[![](individual-accounts-in-web-api/_static/image16.png)](individual-accounts-in-web-api/_static/image15.png)

<span data-ttu-id="d37bb-258">L’intergiciel (middleware) OAuth ne sait rien sur les comptes d’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-258">The OAuth middleware doesn't know anything about the user accounts.</span></span> <span data-ttu-id="d37bb-259">Le fournisseur communique entre l’intergiciel et l’ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="d37bb-259">The provider communicates between the middleware and ASP.NET Identity.</span></span> <span data-ttu-id="d37bb-260">Pour plus d’informations sur l’implémentation du serveur d’autorisation, consultez [serveur d’autorisation OAuth 2,0 OWIN](../../../aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server.md).</span><span class="sxs-lookup"><span data-stu-id="d37bb-260">For more information about implementing the authorization server, see [OWIN OAuth 2.0 Authorization Server](../../../aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server.md).</span></span>

### <a name="configuring-web-api-to-use-bearer-tokens"></a><span data-ttu-id="d37bb-261">Configuration de l’API Web pour utiliser des jetons de porteur</span><span class="sxs-lookup"><span data-stu-id="d37bb-261">Configuring Web API to use Bearer Tokens</span></span>

<span data-ttu-id="d37bb-262">Dans la méthode `WebApiConfig.Register`, le code suivant configure l’authentification pour le pipeline de l’API Web :</span><span class="sxs-lookup"><span data-stu-id="d37bb-262">In the `WebApiConfig.Register` method, the following code sets up authentication for the Web API pipeline:</span></span>

[!code-csharp[Main](individual-accounts-in-web-api/samples/sample14.cs)]

<span data-ttu-id="d37bb-263">La classe **HostAuthenticationFilter** active l’authentification à l’aide de jetons de porteur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-263">The **HostAuthenticationFilter** class enables authentication using bearer tokens.</span></span>

<span data-ttu-id="d37bb-264">La méthode **SuppressDefaultHostAuthentication** indique à l’API Web d’ignorer toute authentification qui se produit avant que la demande n’atteigne le pipeline d’API Web, par le biais d’IIS ou de l’intergiciel (middleware) OWIN.</span><span class="sxs-lookup"><span data-stu-id="d37bb-264">The **SuppressDefaultHostAuthentication** method tells Web API to ignore any authentication that happens before the request reaches the Web API pipeline, either by IIS or by OWIN middleware.</span></span> <span data-ttu-id="d37bb-265">De cette façon, nous pouvons limiter l’API Web pour qu’elle n’effectue l’authentification qu’à l’aide des jetons du porteur.</span><span class="sxs-lookup"><span data-stu-id="d37bb-265">That way, we can restrict Web API to authenticate only using bearer tokens.</span></span>

> [!NOTE]
> <span data-ttu-id="d37bb-266">En particulier, la partie MVC de votre application peut utiliser l’authentification par formulaire, qui stocke les informations d’identification dans un cookie.</span><span class="sxs-lookup"><span data-stu-id="d37bb-266">In particular, the MVC portion of your app might use forms authentication, which stores credentials in a cookie.</span></span> <span data-ttu-id="d37bb-267">L’authentification basée sur les cookies requiert l’utilisation de jetons anti-contrefaçon pour empêcher les attaques CSRF.</span><span class="sxs-lookup"><span data-stu-id="d37bb-267">Cookie-based authentication requires the use of anti-forgery tokens, to prevent CSRF attacks.</span></span> <span data-ttu-id="d37bb-268">Il s’agit d’un problème pour les API Web, car il n’existe aucun moyen pratique pour l’API Web d’envoyer le jeton anti-contrefaçon au client.</span><span class="sxs-lookup"><span data-stu-id="d37bb-268">That's a problem for web APIs, because there is no convenient way for the web API to send the anti-forgery token to the client.</span></span> <span data-ttu-id="d37bb-269">(Pour plus d’informations sur ce problème, consultez [prévention des attaques CSRF dans l’API Web](preventing-cross-site-request-forgery-csrf-attacks.md).) L’appel de **SuppressDefaultHostAuthentication** garantit que l’API Web n’est pas vulnérable aux attaques CSRF à partir des informations d’identification stockées dans les cookies.</span><span class="sxs-lookup"><span data-stu-id="d37bb-269">(For more background on this issue, see [Preventing CSRF Attacks in Web API](preventing-cross-site-request-forgery-csrf-attacks.md).) Calling **SuppressDefaultHostAuthentication** ensures that Web API is not vulnerable to CSRF attacks from credentials stored in cookies.</span></span>

<span data-ttu-id="d37bb-270">Lorsque le client demande une ressource protégée, voici ce qui se produit dans le pipeline de l’API Web :</span><span class="sxs-lookup"><span data-stu-id="d37bb-270">When the client requests a protected resource, here is what happens in the Web API pipeline:</span></span>

1. <span data-ttu-id="d37bb-271">Le filtre **HostAuthentication** appelle l’intergiciel (middleware) OAuth pour valider le jeton.</span><span class="sxs-lookup"><span data-stu-id="d37bb-271">The **HostAuthentication** filter calls the OAuth middleware to validate the token.</span></span>
2. <span data-ttu-id="d37bb-272">L’intergiciel convertit le jeton en une identité basée sur les revendications.</span><span class="sxs-lookup"><span data-stu-id="d37bb-272">The middleware converts the token into a claims identity.</span></span>
3. <span data-ttu-id="d37bb-273">À ce stade, la demande est *authentifiée* , mais elle n’est pas *autorisée*.</span><span class="sxs-lookup"><span data-stu-id="d37bb-273">At this point, the request is *authenticated* but not *authorized*.</span></span>
4. <span data-ttu-id="d37bb-274">Le filtre d’autorisation examine l’identité des revendications.</span><span class="sxs-lookup"><span data-stu-id="d37bb-274">The authorization filter examines the claims identity.</span></span> <span data-ttu-id="d37bb-275">Si les revendications autorisent l’utilisateur pour cette ressource, la demande est autorisée.</span><span class="sxs-lookup"><span data-stu-id="d37bb-275">If the claims authorize the user for that resource, the request is authorized.</span></span> <span data-ttu-id="d37bb-276">Par défaut, l’attribut **[Authorize]** autorise toutes les demandes authentifiées.</span><span class="sxs-lookup"><span data-stu-id="d37bb-276">By default, the **[Authorize]** attribute will authorize any request that is authenticated.</span></span> <span data-ttu-id="d37bb-277">Toutefois, vous pouvez autoriser par rôle ou par d’autres revendications.</span><span class="sxs-lookup"><span data-stu-id="d37bb-277">However, you can authorize by role or by other claims.</span></span> <span data-ttu-id="d37bb-278">Pour plus d’informations, consultez [authentification et autorisation dans l’API Web](authentication-and-authorization-in-aspnet-web-api.md).</span><span class="sxs-lookup"><span data-stu-id="d37bb-278">For more information, see [Authentication and Authorization in Web API](authentication-and-authorization-in-aspnet-web-api.md).</span></span>
5. <span data-ttu-id="d37bb-279">Si les étapes précédentes réussissent, le contrôleur retourne la ressource protégée.</span><span class="sxs-lookup"><span data-stu-id="d37bb-279">If the previous steps are successful, the controller returns the protected resource.</span></span> <span data-ttu-id="d37bb-280">Dans le cas contraire, le client reçoit une erreur 401 (non autorisée).</span><span class="sxs-lookup"><span data-stu-id="d37bb-280">Otherwise, the client receives a 401 (Unauthorized) error.</span></span>

[![](individual-accounts-in-web-api/_static/image18.png)](individual-accounts-in-web-api/_static/image17.png)

## <a name="additional-resources"></a><span data-ttu-id="d37bb-281">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="d37bb-281">Additional Resources</span></span>

- [<span data-ttu-id="d37bb-282">ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="d37bb-282">ASP.NET Identity</span></span>](../../../identity/index.md)
- <span data-ttu-id="d37bb-283">[Comprendre les fonctionnalités de sécurité dans le modèle Spa pour VS2013 RC](https://blogs.msdn.com/b/webdev/archive/2013/09/20/understanding-security-features-in-spa-template.aspx).</span><span class="sxs-lookup"><span data-stu-id="d37bb-283">[Understanding Security Features in the SPA Template for VS2013 RC](https://blogs.msdn.com/b/webdev/archive/2013/09/20/understanding-security-features-in-spa-template.aspx).</span></span> <span data-ttu-id="d37bb-284">Billet de blog MSDN de Hongye Sun.</span><span class="sxs-lookup"><span data-stu-id="d37bb-284">MSDN blog post by Hongye Sun.</span></span>
- <span data-ttu-id="d37bb-285">[Discroisement du modèle de comptes individuels de l’API Web-partie 2 : comptes locaux](http://leastprivilege.com/2013/11/26/dissecting-the-web-api-individual-accounts-templatepart-2-local-accounts/).</span><span class="sxs-lookup"><span data-stu-id="d37bb-285">[Dissecting the Web API Individual Accounts Template–Part 2: Local Accounts](http://leastprivilege.com/2013/11/26/dissecting-the-web-api-individual-accounts-templatepart-2-local-accounts/).</span></span> <span data-ttu-id="d37bb-286">Billet de blog de Dominick Baier.</span><span class="sxs-lookup"><span data-stu-id="d37bb-286">Blog post by Dominick Baier.</span></span>
- <span data-ttu-id="d37bb-287">[Authentification de l’hôte et API Web avec OWIN](http://brockallen.com/2013/10/27/host-authentication-and-web-api-with-owin-and-active-vs-passive-authentication-middleware/).</span><span class="sxs-lookup"><span data-stu-id="d37bb-287">[Host authentication and Web API with OWIN](http://brockallen.com/2013/10/27/host-authentication-and-web-api-with-owin-and-active-vs-passive-authentication-middleware/).</span></span> <span data-ttu-id="d37bb-288">Une bonne explication des `SuppressDefaultHostAuthentication` et des `HostAuthenticationFilter` par Brock Allen.</span><span class="sxs-lookup"><span data-stu-id="d37bb-288">A good explanation of `SuppressDefaultHostAuthentication` and `HostAuthenticationFilter` by Brock Allen.</span></span>
- <span data-ttu-id="d37bb-289">[Personnalisation des informations de profil dans ASP.net Identity dans les modèles VS 2013](https://blogs.msdn.com/b/webdev/archive/2013/10/16/customizing-profile-information-in-asp-net-identity-in-vs-2013-templates.aspx).</span><span class="sxs-lookup"><span data-stu-id="d37bb-289">[Customizing profile information in ASP.NET Identity in VS 2013 templates](https://blogs.msdn.com/b/webdev/archive/2013/10/16/customizing-profile-information-in-asp-net-identity-in-vs-2013-templates.aspx).</span></span> <span data-ttu-id="d37bb-290">Billet de blog MSDN de Pranav Rastogi.</span><span class="sxs-lookup"><span data-stu-id="d37bb-290">MSDN blog post by Pranav Rastogi.</span></span>
- <span data-ttu-id="d37bb-291">[Gestion de la durée de vie des demandes pour la classe usermanager dans ASP.net Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="d37bb-291">[Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span> <span data-ttu-id="d37bb-292">Billet de blog MSDN de Suhas Joshi, avec une bonne explication de la classe `UserManager`.</span><span class="sxs-lookup"><span data-stu-id="d37bb-292">MSDN blog post by Suhas Joshi, with a good explanation of the `UserManager` class.</span></span>
