---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: Prévention des attaques par falsification de requête intersites (CSRF) dans ASP.NET MVC
author: MikeWasson
description: Décrit l’attaque de falsification de requête intersites (CSRF) et comment implémenter des mesures anti-CSRF dans ASP.NET Web MVC.
ms.author: riande
ms.date: 12/12/2012
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 5fb0f8bcc9e587ba4fbbf2b857d3bf7adcaafb94
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78555117"
---
# <a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-mvc-application"></a><span data-ttu-id="3ab6c-103">Prévention des attaques par falsification de requête intersites (CSRF) dans l’application ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="3ab6c-103">Preventing Cross-Site Request Forgery (CSRF) Attacks in ASP.NET MVC Application</span></span>

<span data-ttu-id="3ab6c-104">par [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="3ab6c-104">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

<span data-ttu-id="3ab6c-105">La falsification de requête intersites (CSRF) est une attaque dans laquelle un site malveillant envoie une demande à un site vulnérable dans lequel l’utilisateur est actuellement connecté.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-105">Cross-Site Request Forgery (CSRF) is an attack where a malicious site sends a request to a vulnerable site where the user is currently logged in</span></span>

<span data-ttu-id="3ab6c-106">Voici un exemple d’attaque CSRF :</span><span class="sxs-lookup"><span data-stu-id="3ab6c-106">Here is an example of a CSRF attack:</span></span>

1. <span data-ttu-id="3ab6c-107">Un utilisateur se connecte à `www.example.com` à l’aide de l’authentification par formulaire.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-107">A user logs into `www.example.com` using forms authentication.</span></span>
2. <span data-ttu-id="3ab6c-108">Le serveur authentifie l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-108">The server authenticates the user.</span></span> <span data-ttu-id="3ab6c-109">La réponse du serveur comprend un cookie d’authentification.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-109">The response from the server includes an authentication cookie.</span></span>
3. <span data-ttu-id="3ab6c-110">Sans déconnexion, l’utilisateur visite un site Web malveillant.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-110">Without logging out, the user visits a malicious web site.</span></span> <span data-ttu-id="3ab6c-111">Ce site malveillant contient le formulaire HTML suivant :</span><span class="sxs-lookup"><span data-stu-id="3ab6c-111">This malicious site contains the following HTML form:</span></span> 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    <span data-ttu-id="3ab6c-112">Notez que l’action de formulaire publie sur le site vulnérable, et non sur le site malveillant.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-112">Notice that the form action posts to the vulnerable site, not to the malicious site.</span></span> <span data-ttu-id="3ab6c-113">Il s’agit de la partie « inter-sites » de CSRF.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-113">This is the "cross-site" part of CSRF.</span></span>
4. <span data-ttu-id="3ab6c-114">L’utilisateur clique sur le bouton Envoyer.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-114">The user clicks the submit button.</span></span> <span data-ttu-id="3ab6c-115">Le navigateur comprend le cookie d’authentification avec la demande.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-115">The browser includes the authentication cookie with the request.</span></span>
5. <span data-ttu-id="3ab6c-116">La demande s’exécute sur le serveur avec le contexte d’authentification de l’utilisateur et peut faire tout ce qu’un utilisateur authentifié est autorisé à faire.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-116">The request runs on the server with the user's authentication context, and can do anything that an authenticated user is allowed to do.</span></span>

<span data-ttu-id="3ab6c-117">Bien que cet exemple exige que l’utilisateur clique sur le bouton de formulaire, la page malveillante peut tout aussi facilement exécuter un script qui envoie le formulaire automatiquement.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-117">Although this example requires the user to click the form button, the malicious page could just as easily run a script that submits the form automatically.</span></span> <span data-ttu-id="3ab6c-118">En outre, l’utilisation de SSL n’empêche pas une attaque CSRF, car le site malveillant peut envoyer une requête « https:// ».</span><span class="sxs-lookup"><span data-stu-id="3ab6c-118">Moreover, using SSL does not prevent a CSRF attack, because the malicious site can send an "https://" request.</span></span>

<span data-ttu-id="3ab6c-119">En général, les attaques CSRF sont possibles sur les sites Web qui utilisent des cookies pour l’authentification, car les navigateurs envoient tous les cookies pertinents au site Web de destination.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-119">Typically, CSRF attacks are possible against web sites that use cookies for authentication, because browsers send all relevant cookies to the destination web site.</span></span> <span data-ttu-id="3ab6c-120">Toutefois, les attaques CSRF ne sont pas limitées à l’exploitation des cookies.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-120">However, CSRF attacks are not limited to exploiting cookies.</span></span> <span data-ttu-id="3ab6c-121">Par exemple, l’authentification de base et Digest est également vulnérable.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-121">For example, Basic and Digest authentication are also vulnerable.</span></span> <span data-ttu-id="3ab6c-122">Une fois qu’un utilisateur se connecte avec l’authentification de base ou Digest.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-122">After a user logs in with Basic or Digest authentication.</span></span> <span data-ttu-id="3ab6c-123">le navigateur envoie automatiquement les informations d’identification jusqu’à la fin de la session.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-123">the browser automatically sends the credentials until the session ends.</span></span>

## <a name="anti-forgery-tokens"></a><span data-ttu-id="3ab6c-124">Jetons anti-contrefaçon</span><span class="sxs-lookup"><span data-stu-id="3ab6c-124">Anti-Forgery Tokens</span></span>

<span data-ttu-id="3ab6c-125">Pour prévenir les attaques CSRF, ASP.NET MVC utilise des jetons anti-contrefaçon, également appelés *jetons de vérification de demande*.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-125">To help prevent CSRF attacks, ASP.NET MVC uses anti-forgery tokens, also called *request verification tokens*.</span></span>

1. <span data-ttu-id="3ab6c-126">Le client demande une page HTML qui contient un formulaire.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-126">The client requests an HTML page that contains a form.</span></span>
2. <span data-ttu-id="3ab6c-127">Le serveur comprend deux jetons dans la réponse.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-127">The server includes two tokens in the response.</span></span> <span data-ttu-id="3ab6c-128">Un jeton est envoyé sous la forme d’un cookie.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-128">One token is sent as a cookie.</span></span> <span data-ttu-id="3ab6c-129">L’autre est placée dans un champ de formulaire masqué.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-129">The other is placed in a hidden form field.</span></span> <span data-ttu-id="3ab6c-130">Les jetons sont générés de manière aléatoire afin qu’un adversaire ne puisse pas deviner les valeurs.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-130">The tokens are generated randomly so that an adversary cannot guess the values.</span></span>
3. <span data-ttu-id="3ab6c-131">Lorsque le client envoie le formulaire, il doit renvoyer les deux jetons au serveur.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-131">When the client submits the form, it must send both tokens back to the server.</span></span> <span data-ttu-id="3ab6c-132">Le client envoie le jeton de cookie en tant que cookie et envoie le jeton de formulaire à l’intérieur des données de formulaire.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-132">The client sends the cookie token as a cookie, and it sends the form token inside the form data.</span></span> <span data-ttu-id="3ab6c-133">(Un client navigateur effectue automatiquement cette modification lorsque l’utilisateur envoie le formulaire.)</span><span class="sxs-lookup"><span data-stu-id="3ab6c-133">(A browser client automatically does this when the user submits the form.)</span></span>
4. <span data-ttu-id="3ab6c-134">Si une demande n’inclut pas les deux jetons, le serveur rejette la demande.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-134">If a request does not include both tokens, the server disallows the request.</span></span>

<span data-ttu-id="3ab6c-135">Voici un exemple de formulaire HTML avec un jeton de formulaire masqué :</span><span class="sxs-lookup"><span data-stu-id="3ab6c-135">Here is an example of an HTML form with a hidden form token:</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

<span data-ttu-id="3ab6c-136">Les jetons anti-contrefaçon fonctionnent parce que la page malveillante ne peut pas lire les jetons de l’utilisateur, en raison des stratégies de même origine.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-136">Anti-forgery tokens work because the malicious page cannot read the user's tokens, due to same-origin policies.</span></span> <span data-ttu-id="3ab6c-137">([Les stratégies de même origine](http://www.w3.org/Security/wiki/Same_Origin_Policy) empêchent les documents hébergés sur deux sites différents d’accéder au contenu de chacun d’eux.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-137">([Same-origin policies](http://www.w3.org/Security/wiki/Same_Origin_Policy) prevent documents hosted on two different sites from accessing each other's content.</span></span> <span data-ttu-id="3ab6c-138">Ainsi, dans l’exemple précédent, la page malveillante peut envoyer des demandes à example.com, mais elle ne peut pas lire la réponse.)</span><span class="sxs-lookup"><span data-stu-id="3ab6c-138">So in the earlier example, the malicious page can send requests to example.com, but it cannot read the response.)</span></span>

<span data-ttu-id="3ab6c-139">Pour empêcher les attaques CSRF, utilisez des jetons anti-contrefaçon avec n’importe quel protocole d’authentification où le navigateur envoie les informations d’identification en mode silencieux une fois que l’utilisateur se connecte.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-139">To prevent CSRF attacks, use anti-forgery tokens with any authentication protocol where the browser silently sends credentials after the user logs in.</span></span> <span data-ttu-id="3ab6c-140">Cela comprend des protocoles d’authentification par cookie, tels que l’authentification par formulaires, ainsi que des protocoles tels que l’authentification de base et Digest.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-140">This includes cookie-based authentication protocols, such as forms authentication, as well as protocols such as Basic and Digest authentication.</span></span>

<span data-ttu-id="3ab6c-141">Vous devez exiger des jetons anti-contrefaçon pour toute méthode non sécurisée (publication, placement, suppression).</span><span class="sxs-lookup"><span data-stu-id="3ab6c-141">You should require anti-forgery tokens for any nonsafe methods (POST, PUT, DELETE).</span></span> <span data-ttu-id="3ab6c-142">En outre, assurez-vous que les méthodes sécurisées (obtenir, en-tête) n’ont pas d’effets secondaires.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-142">Also, make sure that safe methods (GET, HEAD) do not have any side effects.</span></span> <span data-ttu-id="3ab6c-143">De plus, si vous activez la prise en charge inter-domaines, telle que CORS ou JSONP, les méthodes sécurisées telles que sont potentiellement vulnérables aux attaques CSRF, ce qui permet à l’attaquant de lire des données potentiellement sensibles.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-143">Moreover, if you enable cross-domain support, such as CORS or JSONP, then even safe methods like GET are potentially vulnerable to CSRF attacks, allowing the attacker to read potentially sensitive data.</span></span>

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a><span data-ttu-id="3ab6c-144">Jetons anti-contrefaçon dans ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="3ab6c-144">Anti-Forgery Tokens in ASP.NET MVC</span></span>

<span data-ttu-id="3ab6c-145">Pour ajouter les jetons anti-contrefaçon à une page Razor, utilisez la méthode d’assistance **HtmlHelper. AntiForgeryToken** :</span><span class="sxs-lookup"><span data-stu-id="3ab6c-145">To add the anti-forgery tokens to a Razor page, use the **HtmlHelper.AntiForgeryToken** helper method:</span></span>

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

<span data-ttu-id="3ab6c-146">Cette méthode ajoute le champ de formulaire masqué et définit également le jeton de cookie.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-146">This method adds the hidden form field and also sets the cookie token.</span></span>

## <a name="anti-csrf-and-ajax"></a><span data-ttu-id="3ab6c-147">Anti-CSRF et AJAX</span><span class="sxs-lookup"><span data-stu-id="3ab6c-147">Anti-CSRF and AJAX</span></span>

<span data-ttu-id="3ab6c-148">le jeton de formulaire peut se révéler problématique pour les requêtes AJAX, car une requête AJAX risque d’envoyer des données JSON, et non des données de formulaire HTML.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-148">The form token can be a problem for AJAX requests, because an AJAX request might send JSON data, not HTML form data.</span></span> <span data-ttu-id="3ab6c-149">L’une des solutions consiste à envoyer les jetons dans un en-tête HTTP personnalisé.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-149">One solution is to send the tokens in a custom HTTP header.</span></span> <span data-ttu-id="3ab6c-150">Le code ci-après utilise la syntaxe Razor pour générer les jetons, puis ajoute les jetons à une demande AJAX.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-150">The following code uses Razor syntax to generate the tokens, and then adds the tokens to an AJAX request.</span></span> <span data-ttu-id="3ab6c-151">Les jetons sont générés sur le serveur en appelant anti- **contrefaçon. GetTokens**.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-151">The tokens are generated at the server by calling **AntiForgery.GetTokens**.</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

<span data-ttu-id="3ab6c-152">Lorsque vous traitez la demande, extrayez les jetons de l’en-tête de la demande.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-152">When you process the request, extract the tokens from the request header.</span></span> <span data-ttu-id="3ab6c-153">Appelez ensuite la méthode anti- **contrefaçon. Validate** pour valider les jetons.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-153">Then call the **AntiForgery.Validate** method to validate the tokens.</span></span> <span data-ttu-id="3ab6c-154">La méthode **Validate** lève une exception si les jetons ne sont pas valides.</span><span class="sxs-lookup"><span data-stu-id="3ab6c-154">The **Validate** method throws an exception if the tokens are not valid.</span></span>

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]
