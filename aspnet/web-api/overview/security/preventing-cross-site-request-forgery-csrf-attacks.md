---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: Prévention des attaques de falsification (CSRF) de requête intersites dans ASP.NET MVC
author: MikeWasson
description: Décrit l’attaque de falsification de requête intersites et comment implémenter les mesures anti-CSRF dans ASP.NET Web MVC.
ms.author: riande
ms.date: 12/12/2012
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 5fb0f8bcc9e587ba4fbbf2b857d3bf7adcaafb94
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/09/2019
ms.locfileid: "59392025"
---
# <a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-mvc-application"></a><span data-ttu-id="a0577-103">Prévention des attaques par falsification de Cross-Site Request dans une Application ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="a0577-103">Preventing Cross-Site Request Forgery (CSRF) Attacks in ASP.NET MVC Application</span></span>

<span data-ttu-id="a0577-104">par [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="a0577-104">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

<span data-ttu-id="a0577-105">Falsification de demande intersites (CSRF) est une attaque dans laquelle un site malveillant envoie une demande à un site vulnérable auquel l’utilisateur est actuellement connecté dans</span><span class="sxs-lookup"><span data-stu-id="a0577-105">Cross-Site Request Forgery (CSRF) is an attack where a malicious site sends a request to a vulnerable site where the user is currently logged in</span></span>

<span data-ttu-id="a0577-106">Voici un exemple d’une attaque CSRF :</span><span class="sxs-lookup"><span data-stu-id="a0577-106">Here is an example of a CSRF attack:</span></span>

1. <span data-ttu-id="a0577-107">Un utilisateur se connecte à `www.example.com` à l’aide de l’authentification par formulaire.</span><span class="sxs-lookup"><span data-stu-id="a0577-107">A user logs into `www.example.com` using forms authentication.</span></span>
2. <span data-ttu-id="a0577-108">Le serveur authentifie l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="a0577-108">The server authenticates the user.</span></span> <span data-ttu-id="a0577-109">La réponse du serveur inclut un cookie d’authentification.</span><span class="sxs-lookup"><span data-stu-id="a0577-109">The response from the server includes an authentication cookie.</span></span>
3. <span data-ttu-id="a0577-110">Sans la déconnexion, l’utilisateur visite un site web malveillant.</span><span class="sxs-lookup"><span data-stu-id="a0577-110">Without logging out, the user visits a malicious web site.</span></span> <span data-ttu-id="a0577-111">Ce site malveillant contient le formulaire HTML suivant :</span><span class="sxs-lookup"><span data-stu-id="a0577-111">This malicious site contains the following HTML form:</span></span> 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    <span data-ttu-id="a0577-112">Notez que l’action de formulaire valide vers le site vulnérable, pas pour le site malveillant.</span><span class="sxs-lookup"><span data-stu-id="a0577-112">Notice that the form action posts to the vulnerable site, not to the malicious site.</span></span> <span data-ttu-id="a0577-113">Il s’agit de la partie « cross-site » de falsification de requête Intersites.</span><span class="sxs-lookup"><span data-stu-id="a0577-113">This is the "cross-site" part of CSRF.</span></span>
4. <span data-ttu-id="a0577-114">L’utilisateur clique sur le bouton Envoyer.</span><span class="sxs-lookup"><span data-stu-id="a0577-114">The user clicks the submit button.</span></span> <span data-ttu-id="a0577-115">Le navigateur inclut le cookie d’authentification avec la demande.</span><span class="sxs-lookup"><span data-stu-id="a0577-115">The browser includes the authentication cookie with the request.</span></span>
5. <span data-ttu-id="a0577-116">La demande s’exécute sur le serveur avec le contexte de l’utilisateur d’authentification et peut faire tout ce qu’un utilisateur authentifié est autorisé à faire.</span><span class="sxs-lookup"><span data-stu-id="a0577-116">The request runs on the server with the user's authentication context, and can do anything that an authenticated user is allowed to do.</span></span>

<span data-ttu-id="a0577-117">Bien que cet exemple nécessite l’utilisateur clique sur le bouton du formulaire, la page malveillante pourrait aussi facilement exécuter un script qui envoie le formulaire automatiquement.</span><span class="sxs-lookup"><span data-stu-id="a0577-117">Although this example requires the user to click the form button, the malicious page could just as easily run a script that submits the form automatically.</span></span> <span data-ttu-id="a0577-118">En outre, à l’aide de SSL n’empêche pas une attaque CSRF, car le site malveillant peut envoyer une demande de « https:// ».</span><span class="sxs-lookup"><span data-stu-id="a0577-118">Moreover, using SSL does not prevent a CSRF attack, because the malicious site can send an "https://" request.</span></span>

<span data-ttu-id="a0577-119">En règle générale, les attaques CSRF sont possibles contre les sites web qui utilisent des cookies pour l’authentification, étant donné que les navigateurs envoient tous les cookies utiles pour le site de destination.</span><span class="sxs-lookup"><span data-stu-id="a0577-119">Typically, CSRF attacks are possible against web sites that use cookies for authentication, because browsers send all relevant cookies to the destination web site.</span></span> <span data-ttu-id="a0577-120">Toutefois, les attaques CSRF ne sont pas limités à exploiter les cookies.</span><span class="sxs-lookup"><span data-stu-id="a0577-120">However, CSRF attacks are not limited to exploiting cookies.</span></span> <span data-ttu-id="a0577-121">Par exemple, l’authentification de base et Digest sont également vulnérables.</span><span class="sxs-lookup"><span data-stu-id="a0577-121">For example, Basic and Digest authentication are also vulnerable.</span></span> <span data-ttu-id="a0577-122">Après un utilisateur se connecte avec l’authentification de base ou Digest.</span><span class="sxs-lookup"><span data-stu-id="a0577-122">After a user logs in with Basic or Digest authentication.</span></span> <span data-ttu-id="a0577-123">le navigateur envoie automatiquement les informations d’identification jusqu'à ce que la session se termine.</span><span class="sxs-lookup"><span data-stu-id="a0577-123">the browser automatically sends the credentials until the session ends.</span></span>

## <a name="anti-forgery-tokens"></a><span data-ttu-id="a0577-124">Les jetons anti-contrefaçon</span><span class="sxs-lookup"><span data-stu-id="a0577-124">Anti-Forgery Tokens</span></span>

<span data-ttu-id="a0577-125">Pour aider à empêcher les attaques CSRF, ASP.NET MVC utilise des jetons anti-contrefaçon, également appelés *demander des jetons de vérification*.</span><span class="sxs-lookup"><span data-stu-id="a0577-125">To help prevent CSRF attacks, ASP.NET MVC uses anti-forgery tokens, also called *request verification tokens*.</span></span>

1. <span data-ttu-id="a0577-126">Le client demande une page HTML qui contienne un formulaire.</span><span class="sxs-lookup"><span data-stu-id="a0577-126">The client requests an HTML page that contains a form.</span></span>
2. <span data-ttu-id="a0577-127">Le serveur inclut deux jetons dans la réponse.</span><span class="sxs-lookup"><span data-stu-id="a0577-127">The server includes two tokens in the response.</span></span> <span data-ttu-id="a0577-128">Un jeton est envoyé en tant que cookie.</span><span class="sxs-lookup"><span data-stu-id="a0577-128">One token is sent as a cookie.</span></span> <span data-ttu-id="a0577-129">L’autre est placée dans un champ de formulaire masqué.</span><span class="sxs-lookup"><span data-stu-id="a0577-129">The other is placed in a hidden form field.</span></span> <span data-ttu-id="a0577-130">Les jetons sont générés au hasard, pour un adversaire ne peuvent pas deviner les valeurs.</span><span class="sxs-lookup"><span data-stu-id="a0577-130">The tokens are generated randomly so that an adversary cannot guess the values.</span></span>
3. <span data-ttu-id="a0577-131">Lorsque le client envoie le formulaire, il doit envoyer les deux jetons sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="a0577-131">When the client submits the form, it must send both tokens back to the server.</span></span> <span data-ttu-id="a0577-132">Le client envoie le jeton de cookie en tant que cookie, et il envoie le jeton de formulaire dans les données du formulaire.</span><span class="sxs-lookup"><span data-stu-id="a0577-132">The client sends the cookie token as a cookie, and it sends the form token inside the form data.</span></span> <span data-ttu-id="a0577-133">(Un client de navigateur fait automatiquement lorsque l’utilisateur envoie le formulaire.)</span><span class="sxs-lookup"><span data-stu-id="a0577-133">(A browser client automatically does this when the user submits the form.)</span></span>
4. <span data-ttu-id="a0577-134">Si une demande n’inclut pas les deux jetons, le serveur n’autorise pas la demande.</span><span class="sxs-lookup"><span data-stu-id="a0577-134">If a request does not include both tokens, the server disallows the request.</span></span>

<span data-ttu-id="a0577-135">Voici un exemple d’un formulaire HTML avec un jeton de formulaire masqué :</span><span class="sxs-lookup"><span data-stu-id="a0577-135">Here is an example of an HTML form with a hidden form token:</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

<span data-ttu-id="a0577-136">Les jetons anti-contrefaçon fonctionnent, car la page malveillante ne peut pas lire des jetons de l’utilisateur, en raison des stratégies de même origine.</span><span class="sxs-lookup"><span data-stu-id="a0577-136">Anti-forgery tokens work because the malicious page cannot read the user's tokens, due to same-origin policies.</span></span> <span data-ttu-id="a0577-137">([Des stratégies de même origine](http://www.w3.org/Security/wiki/Same_Origin_Policy) empêcher les documents hébergés sur deux sites différents d’accéder au contenu de l’autre.</span><span class="sxs-lookup"><span data-stu-id="a0577-137">([Same-origin policies](http://www.w3.org/Security/wiki/Same_Origin_Policy) prevent documents hosted on two different sites from accessing each other's content.</span></span> <span data-ttu-id="a0577-138">Par conséquent, dans l’exemple précédent, la page malveillante peut envoyer des demandes à exemple.com, mais il ne peut pas lire la réponse.)</span><span class="sxs-lookup"><span data-stu-id="a0577-138">So in the earlier example, the malicious page can send requests to example.com, but it cannot read the response.)</span></span>

<span data-ttu-id="a0577-139">Pour empêcher les attaques CSRF, utilisez des jetons anti-contrefaçon avec n’importe quel protocole d’authentification où le navigateur en mode silencieux envoie des informations d’identification une fois que l’utilisateur se connecte.</span><span class="sxs-lookup"><span data-stu-id="a0577-139">To prevent CSRF attacks, use anti-forgery tokens with any authentication protocol where the browser silently sends credentials after the user logs in.</span></span> <span data-ttu-id="a0577-140">Cela inclut les protocoles d’authentification basée sur les cookies, telles que l’authentification par formulaire, mais aussi protocoles, tels que l’authentification de base et Digest.</span><span class="sxs-lookup"><span data-stu-id="a0577-140">This includes cookie-based authentication protocols, such as forms authentication, as well as protocols such as Basic and Digest authentication.</span></span>

<span data-ttu-id="a0577-141">Vous devez exiger des jetons anti-contrefaçon pour toutes les méthodes nonsafe (POST, PUT, DELETE).</span><span class="sxs-lookup"><span data-stu-id="a0577-141">You should require anti-forgery tokens for any nonsafe methods (POST, PUT, DELETE).</span></span> <span data-ttu-id="a0577-142">En outre, assurez-vous que les méthodes sans échec (GET, HEAD) n’ont pas de tous les effets.</span><span class="sxs-lookup"><span data-stu-id="a0577-142">Also, make sure that safe methods (GET, HEAD) do not have any side effects.</span></span> <span data-ttu-id="a0577-143">En outre, si vous activez la prise en charge des domaines, tels que CORS ou JSONP, même sans échec méthodes telles que GET sont potentiellement vulnérables aux attaques CSRF, l’attaquant de lire des données potentiellement sensibles.</span><span class="sxs-lookup"><span data-stu-id="a0577-143">Moreover, if you enable cross-domain support, such as CORS or JSONP, then even safe methods like GET are potentially vulnerable to CSRF attacks, allowing the attacker to read potentially sensitive data.</span></span>

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a><span data-ttu-id="a0577-144">Les jetons anti-contrefaçon dans ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="a0577-144">Anti-Forgery Tokens in ASP.NET MVC</span></span>

<span data-ttu-id="a0577-145">Pour ajouter les jetons anti-contrefaçon à une page Razor, utilisez le **HtmlHelper.AntiForgeryToken** méthode d’assistance :</span><span class="sxs-lookup"><span data-stu-id="a0577-145">To add the anti-forgery tokens to a Razor page, use the **HtmlHelper.AntiForgeryToken** helper method:</span></span>

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

<span data-ttu-id="a0577-146">Cette méthode ajoute le champ de formulaire masqué et définit également le jeton de cookie.</span><span class="sxs-lookup"><span data-stu-id="a0577-146">This method adds the hidden form field and also sets the cookie token.</span></span>

## <a name="anti-csrf-and-ajax"></a><span data-ttu-id="a0577-147">Anti-CSRF et AJAX</span><span class="sxs-lookup"><span data-stu-id="a0577-147">Anti-CSRF and AJAX</span></span>

<span data-ttu-id="a0577-148">Le jeton de formulaire peut être un problème pour les demandes AJAX, car une requête AJAX peut envoyer des données JSON, pas les données de formulaire HTML.</span><span class="sxs-lookup"><span data-stu-id="a0577-148">The form token can be a problem for AJAX requests, because an AJAX request might send JSON data, not HTML form data.</span></span> <span data-ttu-id="a0577-149">Une solution consiste à envoyer les jetons dans un en-tête HTTP personnalisé.</span><span class="sxs-lookup"><span data-stu-id="a0577-149">One solution is to send the tokens in a custom HTTP header.</span></span> <span data-ttu-id="a0577-150">Le code suivant utilise la syntaxe Razor pour générer les jetons, puis ajoute les jetons à une demande AJAX.</span><span class="sxs-lookup"><span data-stu-id="a0577-150">The following code uses Razor syntax to generate the tokens, and then adds the tokens to an AJAX request.</span></span> <span data-ttu-id="a0577-151">Les jetons sont générés au niveau du serveur en appelant **AntiForgery.GetTokens**.</span><span class="sxs-lookup"><span data-stu-id="a0577-151">The tokens are generated at the server by calling **AntiForgery.GetTokens**.</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

<span data-ttu-id="a0577-152">Lorsque vous traitez la demande, extrayez les jetons à partir de l’en-tête de demande.</span><span class="sxs-lookup"><span data-stu-id="a0577-152">When you process the request, extract the tokens from the request header.</span></span> <span data-ttu-id="a0577-153">Appelez ensuite la **AntiForgery.Validate** méthode pour valider les jetons.</span><span class="sxs-lookup"><span data-stu-id="a0577-153">Then call the **AntiForgery.Validate** method to validate the tokens.</span></span> <span data-ttu-id="a0577-154">Le **Validate** méthode lève une exception si les jetons ne sont pas valides.</span><span class="sxs-lookup"><span data-stu-id="a0577-154">The **Validate** method throws an exception if the tokens are not valid.</span></span>

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]
