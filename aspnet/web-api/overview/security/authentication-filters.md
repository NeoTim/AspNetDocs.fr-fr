---
uid: web-api/overview/security/authentication-filters
title: Filtres d’authentification dans API Web ASP.NET 2 | Microsoft Docs
author: MikeWasson
description: Un filtre d’authentification est un composant qui authentifie une requête HTTP. L’API Web 2 et MVC 5 prennent tous deux en charge les filtres d’authentification, mais elles diffèrent légèrement...
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 2ef9e62a6c634237e920b6d7aba2127b835f959d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78555887"
---
# <a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="c74d1-104">Filtres d’authentification dans API Web ASP.NET 2</span><span class="sxs-lookup"><span data-stu-id="c74d1-104">Authentication Filters in ASP.NET Web API 2</span></span>

<span data-ttu-id="c74d1-105">par [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="c74d1-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="c74d1-106">Un filtre d’authentification est un composant qui authentifie une requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="c74d1-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="c74d1-107">L’API Web 2 et MVC 5 prennent tous deux en charge les filtres d’authentification, mais elles diffèrent légèrement, principalement dans les conventions de nommage de l’interface de filtre.</span><span class="sxs-lookup"><span data-stu-id="c74d1-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="c74d1-108">Cette rubrique décrit les filtres d’authentification de l’API Web.</span><span class="sxs-lookup"><span data-stu-id="c74d1-108">This topic describes Web API authentication filters.</span></span>

<span data-ttu-id="c74d1-109">Les filtres d’authentification vous permettent de définir un schéma d’authentification pour des contrôleurs ou des actions individuels.</span><span class="sxs-lookup"><span data-stu-id="c74d1-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="c74d1-110">De cette façon, votre application peut prendre en charge différents mécanismes d’authentification pour différentes ressources HTTP.</span><span class="sxs-lookup"><span data-stu-id="c74d1-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="c74d1-111">Dans cet article, je vais vous montrer le code de l’exemple [d’authentification de base](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sur [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span><span class="sxs-lookup"><span data-stu-id="c74d1-111">In this article, I'll show code from the [Basic Authentication](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample on [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span></span> <span data-ttu-id="c74d1-112">L’exemple montre un filtre d’authentification qui implémente le schéma d’authentification d’accès de base HTTP (RFC 2617).</span><span class="sxs-lookup"><span data-stu-id="c74d1-112">The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="c74d1-113">Le filtre est implémenté dans une classe nommée `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="c74d1-113">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="c74d1-114">Je n’affiche pas l’intégralité du code de l’exemple, mais uniquement les parties qui illustrent comment écrire un filtre d’authentification.</span><span class="sxs-lookup"><span data-stu-id="c74d1-114">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="c74d1-115">Définition d’un filtre d’authentification</span><span class="sxs-lookup"><span data-stu-id="c74d1-115">Setting an Authentication Filter</span></span>

<span data-ttu-id="c74d1-116">Comme d’autres filtres, les filtres d’authentification peuvent être appliqués par contrôleur, par action ou globalement à tous les contrôleurs d’API Web.</span><span class="sxs-lookup"><span data-stu-id="c74d1-116">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="c74d1-117">Pour appliquer un filtre d’authentification à un contrôleur, Décorez la classe de contrôleur avec l’attribut de filtre.</span><span class="sxs-lookup"><span data-stu-id="c74d1-117">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="c74d1-118">Le code suivant définit le filtre `[IdentityBasicAuthentication]` sur une classe de contrôleur, ce qui active l’authentification de base pour toutes les actions du contrôleur.</span><span class="sxs-lookup"><span data-stu-id="c74d1-118">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="c74d1-119">Pour appliquer le filtre à une action, décorez l’action avec le filtre.</span><span class="sxs-lookup"><span data-stu-id="c74d1-119">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="c74d1-120">Le code suivant définit le filtre `[IdentityBasicAuthentication]` sur la méthode `Post` du contrôleur.</span><span class="sxs-lookup"><span data-stu-id="c74d1-120">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="c74d1-121">Pour appliquer le filtre à tous les contrôleurs d’API Web, ajoutez-le à **GlobalConfiguration. filters**.</span><span class="sxs-lookup"><span data-stu-id="c74d1-121">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="c74d1-122">Implémentation d’un filtre d’authentification d’API Web</span><span class="sxs-lookup"><span data-stu-id="c74d1-122">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="c74d1-123">Dans l’API Web, les filtres d’authentification implémentent l’interface [System. Web. http. filters. IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) .</span><span class="sxs-lookup"><span data-stu-id="c74d1-123">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="c74d1-124">Ils doivent également hériter de **System. Attribute**, afin d’être appliqués comme attributs.</span><span class="sxs-lookup"><span data-stu-id="c74d1-124">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="c74d1-125">L’interface **IAuthenticationFilter** a deux méthodes :</span><span class="sxs-lookup"><span data-stu-id="c74d1-125">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="c74d1-126">**AuthenticateAsync** authentifie la demande en validant les informations d’identification dans la demande, le cas échéant.</span><span class="sxs-lookup"><span data-stu-id="c74d1-126">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="c74d1-127">**ChallengeAsync** ajoute une stimulation d’authentification à la réponse http, si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="c74d1-127">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="c74d1-128">Ces méthodes correspondent au workflow d’authentification défini dans [rfc 2612](http://tools.ietf.org/html/rfc2616) et [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="c74d1-128">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="c74d1-129">Le client envoie les informations d’identification dans l’en-tête Authorization.</span><span class="sxs-lookup"><span data-stu-id="c74d1-129">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="c74d1-130">Cela se produit généralement après que le client a reçu une réponse 401 (non autorisée) du serveur.</span><span class="sxs-lookup"><span data-stu-id="c74d1-130">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="c74d1-131">Toutefois, un client peut envoyer des informations d’identification avec n’importe quelle demande, et non juste après avoir obtenu un 401.</span><span class="sxs-lookup"><span data-stu-id="c74d1-131">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="c74d1-132">Si le serveur n’accepte pas les informations d’identification, il renvoie une réponse 401 (non autorisée).</span><span class="sxs-lookup"><span data-stu-id="c74d1-132">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="c74d1-133">La réponse inclut un en-tête WWW-Authenticate qui contient un ou plusieurs défis.</span><span class="sxs-lookup"><span data-stu-id="c74d1-133">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="c74d1-134">Chaque défi spécifie un schéma d’authentification reconnu par le serveur.</span><span class="sxs-lookup"><span data-stu-id="c74d1-134">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="c74d1-135">Le serveur peut également retourner 401 à partir d’une demande anonyme.</span><span class="sxs-lookup"><span data-stu-id="c74d1-135">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="c74d1-136">En fait, il s’agit généralement de la façon dont le processus d’authentification est initié :</span><span class="sxs-lookup"><span data-stu-id="c74d1-136">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="c74d1-137">Le client envoie une demande anonyme.</span><span class="sxs-lookup"><span data-stu-id="c74d1-137">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="c74d1-138">Le serveur renvoie 401.</span><span class="sxs-lookup"><span data-stu-id="c74d1-138">The server returns 401.</span></span>
3. <span data-ttu-id="c74d1-139">Les clients renvoient la demande avec les informations d’identification.</span><span class="sxs-lookup"><span data-stu-id="c74d1-139">The clients resends the request with credentials.</span></span>

<span data-ttu-id="c74d1-140">Ce Flow comprend les étapes *d’authentification* et *d’autorisation* .</span><span class="sxs-lookup"><span data-stu-id="c74d1-140">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="c74d1-141">L’authentification prouve l’identité du client.</span><span class="sxs-lookup"><span data-stu-id="c74d1-141">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="c74d1-142">L’autorisation détermine si le client peut accéder à une ressource particulière.</span><span class="sxs-lookup"><span data-stu-id="c74d1-142">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="c74d1-143">Dans l’API Web, les filtres d’authentification gèrent l’authentification, mais pas l’autorisation.</span><span class="sxs-lookup"><span data-stu-id="c74d1-143">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="c74d1-144">L’autorisation doit être effectuée par un filtre d’autorisation ou à l’intérieur de l’action du contrôleur.</span><span class="sxs-lookup"><span data-stu-id="c74d1-144">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="c74d1-145">Voici le Flow dans le pipeline de l’API Web 2 :</span><span class="sxs-lookup"><span data-stu-id="c74d1-145">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="c74d1-146">Avant d’appeler une action, l’API Web crée une liste des filtres d’authentification pour cette action.</span><span class="sxs-lookup"><span data-stu-id="c74d1-146">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="c74d1-147">Cela comprend les filtres avec l’étendue de l’action, l’étendue du contrôleur et l’étendue globale.</span><span class="sxs-lookup"><span data-stu-id="c74d1-147">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="c74d1-148">L’API Web appelle **AuthenticateAsync** sur chaque filtre de la liste.</span><span class="sxs-lookup"><span data-stu-id="c74d1-148">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="c74d1-149">Chaque filtre peut valider les informations d’identification dans la demande.</span><span class="sxs-lookup"><span data-stu-id="c74d1-149">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="c74d1-150">Si un filtre valide correctement les informations d’identification, le filtre crée un **IPrincipal** et l’attache à la demande.</span><span class="sxs-lookup"><span data-stu-id="c74d1-150">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="c74d1-151">Un filtre peut également déclencher une erreur à ce stade.</span><span class="sxs-lookup"><span data-stu-id="c74d1-151">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="c74d1-152">Si c’est le cas, le reste du pipeline ne s’exécute pas.</span><span class="sxs-lookup"><span data-stu-id="c74d1-152">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="c74d1-153">En supposant qu’il n’y ait aucune erreur, la demande passe par le reste du pipeline.</span><span class="sxs-lookup"><span data-stu-id="c74d1-153">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="c74d1-154">Enfin, l’API Web appelle la méthode **ChallengeAsync** de chaque filtre d’authentification.</span><span class="sxs-lookup"><span data-stu-id="c74d1-154">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="c74d1-155">Les filtres utilisent cette méthode pour ajouter une stimulation à la réponse, si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="c74d1-155">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="c74d1-156">En général (mais pas toujours) qui se produit en réponse à une erreur 401.</span><span class="sxs-lookup"><span data-stu-id="c74d1-156">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="c74d1-157">Les diagrammes suivants présentent deux cas possibles.</span><span class="sxs-lookup"><span data-stu-id="c74d1-157">The following diagrams show two possible cases.</span></span> <span data-ttu-id="c74d1-158">Dans le premier, le filtre d’authentification authentifie correctement la demande, un filtre d’autorisation autorise la demande et l’action du contrôleur retourne 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="c74d1-158">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="c74d1-159">Dans le deuxième exemple, le filtre d’authentification authentifie la demande, mais le filtre d’autorisation renvoie 401 (non autorisé).</span><span class="sxs-lookup"><span data-stu-id="c74d1-159">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="c74d1-160">Dans ce cas, l’action du contrôleur n’est pas appelée.</span><span class="sxs-lookup"><span data-stu-id="c74d1-160">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="c74d1-161">Le filtre d’authentification ajoute un en-tête WWW-Authenticate à la réponse.</span><span class="sxs-lookup"><span data-stu-id="c74d1-161">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="c74d1-162">D’autres combinaisons sont possibles&mdash;par exemple, si l’action du contrôleur autorise les demandes anonymes, vous pouvez avoir un filtre d’authentification mais aucune autorisation.</span><span class="sxs-lookup"><span data-stu-id="c74d1-162">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="c74d1-163">Implémentation de la méthode AuthenticateAsync</span><span class="sxs-lookup"><span data-stu-id="c74d1-163">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="c74d1-164">La méthode **AuthenticateAsync** essaie d’authentifier la demande.</span><span class="sxs-lookup"><span data-stu-id="c74d1-164">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="c74d1-165">Voici la signature de méthode :</span><span class="sxs-lookup"><span data-stu-id="c74d1-165">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="c74d1-166">La méthode **AuthenticateAsync** doit effectuer l’une des opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="c74d1-166">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="c74d1-167">Rien (aucune opération).</span><span class="sxs-lookup"><span data-stu-id="c74d1-167">Nothing (no-op).</span></span>
2. <span data-ttu-id="c74d1-168">Créez un **IPrincipal** et définissez-le sur la demande.</span><span class="sxs-lookup"><span data-stu-id="c74d1-168">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="c74d1-169">Définissez un résultat d’erreur.</span><span class="sxs-lookup"><span data-stu-id="c74d1-169">Set an error result.</span></span>

<span data-ttu-id="c74d1-170">Option (1) signifie que la demande n’a pas d’informations d’identification compréhensibles par le filtre.</span><span class="sxs-lookup"><span data-stu-id="c74d1-170">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="c74d1-171">Option (2) signifie que le filtre a correctement authentifié la demande.</span><span class="sxs-lookup"><span data-stu-id="c74d1-171">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="c74d1-172">Option (3) signifie que la demande contient des informations d’identification non valides (comme le mot de passe incorrect), ce qui déclenche une réponse d’erreur.</span><span class="sxs-lookup"><span data-stu-id="c74d1-172">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="c74d1-173">Voici un aperçu général de l’implémentation de **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="c74d1-173">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="c74d1-174">Recherchez les informations d’identification dans la demande.</span><span class="sxs-lookup"><span data-stu-id="c74d1-174">Look for credentials in the request.</span></span>
2. <span data-ttu-id="c74d1-175">S’il n’y a aucune information d’identification, ne rien faire et retourner (pas d’opération).</span><span class="sxs-lookup"><span data-stu-id="c74d1-175">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="c74d1-176">S’il existe des informations d’identification, mais que le filtre ne reconnaît pas le schéma d’authentification, ne rien faire et retourner (pas d’opération).</span><span class="sxs-lookup"><span data-stu-id="c74d1-176">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="c74d1-177">Un autre filtre dans le pipeline peut comprendre le schéma.</span><span class="sxs-lookup"><span data-stu-id="c74d1-177">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="c74d1-178">S’il existe des informations d’identification que le filtre comprend, essayez de les authentifier.</span><span class="sxs-lookup"><span data-stu-id="c74d1-178">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="c74d1-179">Si les informations d’identification sont incorrectes, retournez 401 en définissant `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="c74d1-179">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="c74d1-180">Si les informations d’identification sont valides, créez un **IPrincipal** et définissez `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="c74d1-180">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="c74d1-181">Le code suivant illustre la méthode **AuthenticateAsync** de l’exemple [d’authentification de base](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) .</span><span class="sxs-lookup"><span data-stu-id="c74d1-181">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample.</span></span> <span data-ttu-id="c74d1-182">Les commentaires indiquent chaque étape.</span><span class="sxs-lookup"><span data-stu-id="c74d1-182">The comments indicate each step.</span></span> <span data-ttu-id="c74d1-183">Le code illustre plusieurs types d’erreurs : un en-tête d’autorisation sans informations d’identification, des informations d’identification incorrectes et un nom d’utilisateur/mot de passe incorrect.</span><span class="sxs-lookup"><span data-stu-id="c74d1-183">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="c74d1-184">Définition d’un résultat d’erreur</span><span class="sxs-lookup"><span data-stu-id="c74d1-184">Setting an Error Result</span></span>

<span data-ttu-id="c74d1-185">Si les informations d’identification ne sont pas valides, le filtre doit définir `context.ErrorResult` sur un **IHttpActionResult** qui crée une réponse d’erreur.</span><span class="sxs-lookup"><span data-stu-id="c74d1-185">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="c74d1-186">Pour plus d’informations sur **IHttpActionResult**, consultez [résultats des actions dans l’API Web 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="c74d1-186">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="c74d1-187">L’exemple d’authentification de base comprend une classe `AuthenticationFailureResult` qui convient à cet effet.</span><span class="sxs-lookup"><span data-stu-id="c74d1-187">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="c74d1-188">Implémentation de ChallengeAsync</span><span class="sxs-lookup"><span data-stu-id="c74d1-188">Implementing ChallengeAsync</span></span>

<span data-ttu-id="c74d1-189">L’objectif de la méthode **ChallengeAsync** consiste à ajouter des défis d’authentification à la réponse, si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="c74d1-189">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="c74d1-190">Voici la signature de méthode :</span><span class="sxs-lookup"><span data-stu-id="c74d1-190">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="c74d1-191">La méthode est appelée sur chaque filtre d’authentification dans le pipeline de requête.</span><span class="sxs-lookup"><span data-stu-id="c74d1-191">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="c74d1-192">Il est important de comprendre que **ChallengeAsync** est appelé *avant* la création de la réponse http, voire avant l’exécution de l’action du contrôleur.</span><span class="sxs-lookup"><span data-stu-id="c74d1-192">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="c74d1-193">Quand **ChallengeAsync** est appelé, `context.Result` contient un **IHttpActionResult**, qui est utilisé ultérieurement pour créer la réponse http.</span><span class="sxs-lookup"><span data-stu-id="c74d1-193">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="c74d1-194">Ainsi, quand **ChallengeAsync** est appelé, vous ne connaissez pas encore la réponse http.</span><span class="sxs-lookup"><span data-stu-id="c74d1-194">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="c74d1-195">La méthode **ChallengeAsync** doit remplacer la valeur d’origine de `context.Result` par un nouveau **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="c74d1-195">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="c74d1-196">Ce **IHttpActionResult** doit encapsuler le `context.Result`d’origine.</span><span class="sxs-lookup"><span data-stu-id="c74d1-196">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="c74d1-197">Je vais appeler le *résultat interne* **IHttpActionResult** et le nouveau **IHttpActionResult** le *résultat externe*.</span><span class="sxs-lookup"><span data-stu-id="c74d1-197">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="c74d1-198">Le résultat externe doit effectuer les opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="c74d1-198">The outer result must do the following:</span></span>

1. <span data-ttu-id="c74d1-199">Appelez le résultat interne pour créer la réponse HTTP.</span><span class="sxs-lookup"><span data-stu-id="c74d1-199">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="c74d1-200">Examinez la réponse.</span><span class="sxs-lookup"><span data-stu-id="c74d1-200">Examine the response.</span></span>
3. <span data-ttu-id="c74d1-201">Ajoutez une demande d’authentification à la réponse, si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="c74d1-201">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="c74d1-202">L’exemple suivant est tiré de l’exemple d’authentification de base.</span><span class="sxs-lookup"><span data-stu-id="c74d1-202">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="c74d1-203">Il définit un **IHttpActionResult** pour le résultat externe.</span><span class="sxs-lookup"><span data-stu-id="c74d1-203">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="c74d1-204">La propriété `InnerResult` contient le **IHttpActionResult**interne.</span><span class="sxs-lookup"><span data-stu-id="c74d1-204">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="c74d1-205">La propriété `Challenge` représente un en-tête www-Authentication.</span><span class="sxs-lookup"><span data-stu-id="c74d1-205">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="c74d1-206">Notez que **ExecuteAsync** appelle d’abord `InnerResult.ExecuteAsync` pour créer la réponse http, puis ajoute le défi si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="c74d1-206">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="c74d1-207">Vérifiez le code de réponse avant d’ajouter la stimulation.</span><span class="sxs-lookup"><span data-stu-id="c74d1-207">Check the response code before adding the challenge.</span></span> <span data-ttu-id="c74d1-208">La plupart des schémas d’authentification ajoutent uniquement un défi si la réponse est 401, comme illustré ici.</span><span class="sxs-lookup"><span data-stu-id="c74d1-208">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="c74d1-209">Toutefois, certains schémas d’authentification ajoutent un défi à une réponse de réussite.</span><span class="sxs-lookup"><span data-stu-id="c74d1-209">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="c74d1-210">Par exemple, consultez [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="c74d1-210">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="c74d1-211">Étant donné la classe `AddChallengeOnUnauthorizedResult`, le code réel dans **ChallengeAsync** est simple.</span><span class="sxs-lookup"><span data-stu-id="c74d1-211">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="c74d1-212">Il vous suffit de créer le résultat et de l’attacher à `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="c74d1-212">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="c74d1-213">Remarque : l’exemple d’authentification de base soustrait cette logique un peu, en le plaçant dans une méthode d’extension.</span><span class="sxs-lookup"><span data-stu-id="c74d1-213">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="c74d1-214">Combinaison de filtres d’authentification avec l’authentification au niveau de l’hôte</span><span class="sxs-lookup"><span data-stu-id="c74d1-214">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="c74d1-215">« Authentification au niveau de l’hôte » est l’authentification effectuée par l’hôte (par exemple, IIS), avant que la demande n’atteigne l’infrastructure de l’API Web.</span><span class="sxs-lookup"><span data-stu-id="c74d1-215">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="c74d1-216">Souvent, vous souhaiterez peut-être activer l’authentification au niveau de l’hôte pour le reste de votre application, mais la désactiver pour vos contrôleurs d’API Web.</span><span class="sxs-lookup"><span data-stu-id="c74d1-216">Often, you may want to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="c74d1-217">Par exemple, un scénario classique consiste à activer l’authentification par formulaire au niveau de l’hôte, mais à utiliser l’authentification basée sur les jetons pour l’API Web.</span><span class="sxs-lookup"><span data-stu-id="c74d1-217">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="c74d1-218">Pour désactiver l’authentification au niveau de l’hôte dans le pipeline de l’API Web, appelez `config.SuppressHostPrincipal()` dans votre configuration.</span><span class="sxs-lookup"><span data-stu-id="c74d1-218">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="c74d1-219">Cela amène l’API Web à supprimer l’interface **IPrincipal** de toute demande qui entre dans le pipeline de l’API Web.</span><span class="sxs-lookup"><span data-stu-id="c74d1-219">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="c74d1-220">En fait, il &quot;annule l’authentification&quot; la demande.</span><span class="sxs-lookup"><span data-stu-id="c74d1-220">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="c74d1-221">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="c74d1-221">Additional Resources</span></span>

<span data-ttu-id="c74d1-222">[API Web ASP.net les filtres de sécurité](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span><span class="sxs-lookup"><span data-stu-id="c74d1-222">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
