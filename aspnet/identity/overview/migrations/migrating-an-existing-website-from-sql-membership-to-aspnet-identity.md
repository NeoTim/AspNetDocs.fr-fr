---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: Migration d’un site Web existant de l’appartenance SQL à ASP.NET Identity-ASP.NET 4. x
author: Rick-Anderson
description: Ce didacticiel décrit les étapes de migration d’une application Web existante avec les données d’utilisateur et de rôle créées à l’aide de l’appartenance SQL au nouvel ASP.NET Identity...
ms.author: riande
ms.date: 12/19/2014
ms.custom: seoapril2019
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 633229cc4311d151121bf6a91b9fa8aeecca1197
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78583726"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a><span data-ttu-id="b9067-103">Migration d’un site web existant de l’appartenance SQL vers ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="b9067-103">Migrating an Existing Website from SQL Membership to ASP.NET Identity</span></span>

<span data-ttu-id="b9067-104">par [Rick Anderson](https://twitter.com/RickAndMSFT), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="b9067-104">by [Rick Anderson](https://twitter.com/RickAndMSFT), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="b9067-105">Ce didacticiel décrit les étapes de migration d’une application Web existante avec les données d’utilisateur et de rôle créées à l’aide de l’appartenance SQL au nouveau système de ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="b9067-105">This tutorial illustrates the steps to migrate an existing web application with user and role data created using SQL Membership to the new ASP.NET Identity system.</span></span> <span data-ttu-id="b9067-106">Cette approche implique de remplacer le schéma de base de données existant par celui qui est requis par le ASP.NET Identity et de se connecter aux anciennes/nouvelles classes.</span><span class="sxs-lookup"><span data-stu-id="b9067-106">This approach involves changing the existing database schema to the one needed by the ASP.NET Identity and hook in the old/new classes to it.</span></span> <span data-ttu-id="b9067-107">Après l’adoption de cette approche, une fois votre base de données migrée, les futures mises à jour de l’identité seront gérées sans effort.</span><span class="sxs-lookup"><span data-stu-id="b9067-107">After you adopt this approach, once your database is migrated, future updates to Identity will be handled effortlessly.</span></span>

<span data-ttu-id="b9067-108">Pour ce didacticiel, nous allons utiliser un modèle d’application Web (Web Forms) créé à l’aide de Visual Studio 2010 pour créer des données d’utilisateur et de rôle.</span><span class="sxs-lookup"><span data-stu-id="b9067-108">For this tutorial, we will take a web application template (Web Forms) created using Visual Studio 2010 to create user and role data.</span></span> <span data-ttu-id="b9067-109">Nous utiliserons ensuite des scripts SQL pour migrer la base de données existante vers les tables nécessaires au système d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-109">We will then use SQL scripts to migrate the existing database to tables needed by the Identity system.</span></span> <span data-ttu-id="b9067-110">Ensuite, nous allons installer les packages NuGet nécessaires et ajouter de nouvelles pages de gestion des comptes qui utilisent le système d’identité pour la gestion des appartenances.</span><span class="sxs-lookup"><span data-stu-id="b9067-110">Next we'll install the necessary NuGet packages and add new account management pages which use the Identity system for membership management.</span></span> <span data-ttu-id="b9067-111">En guise de test de migration, les utilisateurs créés à l’aide de l’appartenance SQL doivent pouvoir se connecter et de nouveaux utilisateurs doivent être en mesure de s’inscrire.</span><span class="sxs-lookup"><span data-stu-id="b9067-111">As a test of migration, users created using SQL membership should be able to log in and new users should be able to register.</span></span> <span data-ttu-id="b9067-112">Vous trouverez l’exemple complet [ici](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span><span class="sxs-lookup"><span data-stu-id="b9067-112">You can find the complete sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span></span> <span data-ttu-id="b9067-113">Voir aussi [migration de l’appartenance à ASP.net vers ASP.net Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span><span class="sxs-lookup"><span data-stu-id="b9067-113">See also [Migrating from ASP.NET Membership to ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span></span>

## <a name="getting-started"></a><span data-ttu-id="b9067-114">Prise en main</span><span class="sxs-lookup"><span data-stu-id="b9067-114">Getting started</span></span>

### <a name="creating-an-application-with-sql-membership"></a><span data-ttu-id="b9067-115">Création d’une application avec l’appartenance SQL</span><span class="sxs-lookup"><span data-stu-id="b9067-115">Creating an application with SQL Membership</span></span>

1. <span data-ttu-id="b9067-116">Nous devons commencer par une application existante qui utilise l’appartenance SQL et des données d’utilisateur et de rôle.</span><span class="sxs-lookup"><span data-stu-id="b9067-116">We need to start with an existing application that uses SQL membership and has user and role data.</span></span> <span data-ttu-id="b9067-117">Dans le cadre de cet article, nous allons créer une application Web dans Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="b9067-117">For the purpose of this article, let's create a web application in Visual Studio 2010.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="b9067-118">À l’aide de l’outil de configuration de ASP.NET, créez 2 utilisateurs : **oldAdminUser** et **oldUser.**</span><span class="sxs-lookup"><span data-stu-id="b9067-118">Using the ASP.NET Configuration tool, create 2 users: **oldAdminUser** and **oldUser.**</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. <span data-ttu-id="b9067-119">Créez un rôle nommé admin et ajoutez « oldAdminUser » en tant qu’utilisateur dans ce rôle.</span><span class="sxs-lookup"><span data-stu-id="b9067-119">Create a role named Admin and add 'oldAdminUser' as a user in that role.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. <span data-ttu-id="b9067-120">Créez une section admin du site avec un default. aspx.</span><span class="sxs-lookup"><span data-stu-id="b9067-120">Create an Admin section of the site with a Default.aspx.</span></span> <span data-ttu-id="b9067-121">Définissez la balise d’autorisation dans le fichier Web. config pour activer l’accès uniquement aux utilisateurs dans les rôles d’administrateur.</span><span class="sxs-lookup"><span data-stu-id="b9067-121">Set the authorization tag in the web.config file to enable access only to users in Admin roles.</span></span> <span data-ttu-id="b9067-122">Vous trouverez plus d’informations ici [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="b9067-122">More information can be found here [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. <span data-ttu-id="b9067-123">Affichez la base de données dans Explorateur de serveurs pour comprendre les tables créées par le système d’appartenance SQL.</span><span class="sxs-lookup"><span data-stu-id="b9067-123">View the database in Server Explorer to understand the tables created by the SQL membership system.</span></span> <span data-ttu-id="b9067-124">Les données de connexion de l’utilisateur sont stockées dans les tables ASPNET\_Users et ASPNET\_Membership, tandis que les données de rôle sont stockées dans la table de rôles\_Aspnet.</span><span class="sxs-lookup"><span data-stu-id="b9067-124">The user login data is stored in the aspnet\_Users and aspnet\_Membership tables, while role data is stored in the aspnet\_Roles table.</span></span> <span data-ttu-id="b9067-125">Informations sur les utilisateurs dans lesquels les rôles sont stockés dans la table ASPNET\_UsersInRoles.</span><span class="sxs-lookup"><span data-stu-id="b9067-125">Information about which users are in which roles is stored in the aspnet\_UsersInRoles table.</span></span> <span data-ttu-id="b9067-126">Pour la gestion des appartenances de base, il suffit de porter les informations des tables ci-dessus dans le système de ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="b9067-126">For basic membership management it is sufficient to port the information in the above tables to the ASP.NET Identity system.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a><span data-ttu-id="b9067-127">Migration vers Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="b9067-127">Migrating to Visual Studio 2013</span></span>

1. <span data-ttu-id="b9067-128">Installez Visual Studio Express 2013 pour Web ou Visual Studio 2013 avec les [dernières mises à jour](https://www.microsoft.com/download/details.aspx?id=44921).</span><span class="sxs-lookup"><span data-stu-id="b9067-128">Install Visual Studio Express 2013 for Web or Visual Studio 2013 along with the [latest updates](https://www.microsoft.com/download/details.aspx?id=44921).</span></span>
2. <span data-ttu-id="b9067-129">Ouvrez le projet ci-dessus dans votre version installée de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b9067-129">Open the above project in your installed version of Visual Studio.</span></span> <span data-ttu-id="b9067-130">Si SQL Server Express n’est pas installé sur l’ordinateur, une invite s’affiche lorsque vous ouvrez le projet, car la chaîne de connexion utilise SQL Express.</span><span class="sxs-lookup"><span data-stu-id="b9067-130">If SQL Server Express is not installed on the machine, a prompt is displayed when you open the project, since the connection string uses SQL Express.</span></span> <span data-ttu-id="b9067-131">Vous pouvez choisir d’installer SQL Express ou de contourner la chaîne de connexion à la base de données locale.</span><span class="sxs-lookup"><span data-stu-id="b9067-131">You can either choose to install SQL Express or as work around change the connection string to LocalDb.</span></span> <span data-ttu-id="b9067-132">Pour cet article, nous allons le remplacer par la base de données locale.</span><span class="sxs-lookup"><span data-stu-id="b9067-132">For this article we'll change it to LocalDb.</span></span>
3. <span data-ttu-id="b9067-133">Ouvrez le fichier Web. config et modifiez la chaîne de connexion à partir de. SQLExpress vers (base de données locale) v 11.0.</span><span class="sxs-lookup"><span data-stu-id="b9067-133">Open web.config and change the connection string from .SQLExpress to (LocalDb)v11.0.</span></span> <span data-ttu-id="b9067-134">Supprimez « user instance = true » de la chaîne de connexion.</span><span class="sxs-lookup"><span data-stu-id="b9067-134">Remove 'User Instance=true' from the connection string.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. <span data-ttu-id="b9067-135">Ouvrez Explorateur de serveurs et vérifiez que le schéma et les données de la table peuvent être observés.</span><span class="sxs-lookup"><span data-stu-id="b9067-135">Open Server Explorer and verify that the table schema and data can be observed.</span></span>
5. <span data-ttu-id="b9067-136">Le système ASP.NET Identity fonctionne avec la version 4,5 ou une version ultérieure du Framework.</span><span class="sxs-lookup"><span data-stu-id="b9067-136">The ASP.NET Identity system works with version 4.5 or higher of the framework.</span></span> <span data-ttu-id="b9067-137">Reciblez l’application sur 4,5 ou une version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="b9067-137">Retarget the application to 4.5 or higher.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    <span data-ttu-id="b9067-138">Générez le projet pour vérifier qu’il n’y a pas d’erreurs.</span><span class="sxs-lookup"><span data-stu-id="b9067-138">Build the project to verify that there are no errors.</span></span>

### <a name="installing-the-nuget-packages"></a><span data-ttu-id="b9067-139">Installation des packages NuGet</span><span class="sxs-lookup"><span data-stu-id="b9067-139">Installing the Nuget packages</span></span>

1. <span data-ttu-id="b9067-140">Dans Explorateur de solutions, cliquez avec le bouton droit sur le projet &gt; **gérer les packages NuGet**.</span><span class="sxs-lookup"><span data-stu-id="b9067-140">In Solution Explorer, right-click the project &gt; **Manage NuGet Packages**.</span></span> <span data-ttu-id="b9067-141">Dans la zone de recherche, entrez « Asp.net Identity ».</span><span class="sxs-lookup"><span data-stu-id="b9067-141">In the search box, enter "Asp.net Identity".</span></span> <span data-ttu-id="b9067-142">Sélectionnez le package dans la liste des résultats, puis cliquez sur installer.</span><span class="sxs-lookup"><span data-stu-id="b9067-142">Select the package in the list of results and click install.</span></span> <span data-ttu-id="b9067-143">Acceptez le contrat de licence en cliquant sur le bouton « J’accepte ».</span><span class="sxs-lookup"><span data-stu-id="b9067-143">Accept the license agreement by clicking on "I Accept" button.</span></span> <span data-ttu-id="b9067-144">Notez que ce package installe les packages de dépendances : EntityFramework et Microsoft ASP.NET principal d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-144">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span> <span data-ttu-id="b9067-145">Installez de la même façon les packages suivants (ignorez les 4 derniers packages OWIN si vous ne souhaitez pas activer la connexion OAuth) :</span><span class="sxs-lookup"><span data-stu-id="b9067-145">Similarly install the following packages (skip the last 4 OWIN packages if you don't want to enable OAuth log-in):</span></span>

   - <span data-ttu-id="b9067-146">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="b9067-146">Microsoft.AspNet.Identity.Owin</span></span>
   - <span data-ttu-id="b9067-147">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="b9067-147">Microsoft.Owin.Host.SystemWeb</span></span>
   - <span data-ttu-id="b9067-148">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="b9067-148">Microsoft.Owin.Security.Facebook</span></span>
   - <span data-ttu-id="b9067-149">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="b9067-149">Microsoft.Owin.Security.Google</span></span>
   - <span data-ttu-id="b9067-150">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="b9067-150">Microsoft.Owin.Security.MicrosoftAccount</span></span>
   - <span data-ttu-id="b9067-151">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="b9067-151">Microsoft.Owin.Security.Twitter</span></span>

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a><span data-ttu-id="b9067-152">Migrer la base de données vers le nouveau système d’identité</span><span class="sxs-lookup"><span data-stu-id="b9067-152">Migrate database to the new Identity system</span></span>

<span data-ttu-id="b9067-153">L’étape suivante consiste à migrer la base de données existante vers un schéma requis par le système ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="b9067-153">The next step is to migrate the existing database to a schema required by the ASP.NET Identity system.</span></span> <span data-ttu-id="b9067-154">Pour ce faire, nous exécutons un script SQL qui comporte un ensemble de commandes permettant de créer des tables et de migrer les informations utilisateur existantes vers les nouvelles tables.</span><span class="sxs-lookup"><span data-stu-id="b9067-154">To achieve this we run a SQL script which has a set of commands to create new tables and migrate existing user information to the new tables.</span></span> <span data-ttu-id="b9067-155">Le fichier de script se trouve [ici](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span><span class="sxs-lookup"><span data-stu-id="b9067-155">The script file can be found [here](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span></span>

<span data-ttu-id="b9067-156">Ce fichier de script est spécifique à cet exemple.</span><span class="sxs-lookup"><span data-stu-id="b9067-156">This script file is specific to this sample.</span></span> <span data-ttu-id="b9067-157">Si le schéma des tables créées à l’aide de l’appartenance SQL est personnalisé ou modifié, les scripts doivent être modifiés en conséquence.</span><span class="sxs-lookup"><span data-stu-id="b9067-157">If the schema for the tables created using SQL membership is customized or modified the scripts need to be changed accordingly.</span></span>

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a><span data-ttu-id="b9067-158">Comment générer le script SQL pour la migration de schéma</span><span class="sxs-lookup"><span data-stu-id="b9067-158">How to generate the SQL script for schema migration</span></span>

<span data-ttu-id="b9067-159">Pour que les classes ASP.NET Identity soient prêtes à l’emploi avec les données des utilisateurs existants, nous devons migrer le schéma de base de données vers celui requis par ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="b9067-159">For ASP.NET Identity classes to work out of the box with the data of existing users, we need to migrate the database schema to the one needed by ASP.NET Identity.</span></span> <span data-ttu-id="b9067-160">Pour ce faire, vous pouvez ajouter de nouvelles tables et copier les informations existantes dans ces tables.</span><span class="sxs-lookup"><span data-stu-id="b9067-160">We can do this by adding new tables and copying the existing information to those tables.</span></span> <span data-ttu-id="b9067-161">Par défaut ASP.NET Identity utilise EntityFramework pour mapper les classes de modèle d’identité à la base de données pour stocker/récupérer des informations.</span><span class="sxs-lookup"><span data-stu-id="b9067-161">By default ASP.NET Identity uses EntityFramework to map the Identity model classes back to the database to store/retrieve information.</span></span> <span data-ttu-id="b9067-162">Ces classes de modèle implémentent les interfaces d’identité principales qui définissent les objets utilisateur et rôle.</span><span class="sxs-lookup"><span data-stu-id="b9067-162">These model classes implement the core Identity interfaces defining user and role objects.</span></span> <span data-ttu-id="b9067-163">Les tables et les colonnes de la base de données sont basées sur ces classes de modèle.</span><span class="sxs-lookup"><span data-stu-id="b9067-163">The tables and the columns in the database are based on these model classes.</span></span> <span data-ttu-id="b9067-164">Les classes de modèle EntityFramework dans Identity v 2.1.0 et leurs propriétés sont définies ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="b9067-164">The EntityFramework model classes in Identity v2.1.0 and their properties are as defined below</span></span>

| <span data-ttu-id="b9067-165">**IdentityUser**</span><span class="sxs-lookup"><span data-stu-id="b9067-165">**IdentityUser**</span></span> | <span data-ttu-id="b9067-166">**Type**</span><span class="sxs-lookup"><span data-stu-id="b9067-166">**Type**</span></span> | <span data-ttu-id="b9067-167">**IdentityRole**</span><span class="sxs-lookup"><span data-stu-id="b9067-167">**IdentityRole**</span></span> | <span data-ttu-id="b9067-168">**IdentityUserRole**</span><span class="sxs-lookup"><span data-stu-id="b9067-168">**IdentityUserRole**</span></span> | <span data-ttu-id="b9067-169">**IdentityUserLogin**</span><span class="sxs-lookup"><span data-stu-id="b9067-169">**IdentityUserLogin**</span></span> | <span data-ttu-id="b9067-170">**IdentityUserClaim**</span><span class="sxs-lookup"><span data-stu-id="b9067-170">**IdentityUserClaim**</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="b9067-171">Id</span><span class="sxs-lookup"><span data-stu-id="b9067-171">Id</span></span> | <span data-ttu-id="b9067-172">chaîne</span><span class="sxs-lookup"><span data-stu-id="b9067-172">string</span></span> | <span data-ttu-id="b9067-173">Id</span><span class="sxs-lookup"><span data-stu-id="b9067-173">Id</span></span> | <span data-ttu-id="b9067-174">RoleId</span><span class="sxs-lookup"><span data-stu-id="b9067-174">RoleId</span></span> | <span data-ttu-id="b9067-175">ProviderKey</span><span class="sxs-lookup"><span data-stu-id="b9067-175">ProviderKey</span></span> | <span data-ttu-id="b9067-176">Id</span><span class="sxs-lookup"><span data-stu-id="b9067-176">Id</span></span> |
| <span data-ttu-id="b9067-177">Utilisateur</span><span class="sxs-lookup"><span data-stu-id="b9067-177">Username</span></span> | <span data-ttu-id="b9067-178">chaîne</span><span class="sxs-lookup"><span data-stu-id="b9067-178">string</span></span> | <span data-ttu-id="b9067-179">Nom</span><span class="sxs-lookup"><span data-stu-id="b9067-179">Name</span></span> | <span data-ttu-id="b9067-180">UserId</span><span class="sxs-lookup"><span data-stu-id="b9067-180">UserId</span></span> | <span data-ttu-id="b9067-181">UserId</span><span class="sxs-lookup"><span data-stu-id="b9067-181">UserId</span></span> | <span data-ttu-id="b9067-182">ClaimType</span><span class="sxs-lookup"><span data-stu-id="b9067-182">ClaimType</span></span> |
| <span data-ttu-id="b9067-183">PasswordHash</span><span class="sxs-lookup"><span data-stu-id="b9067-183">PasswordHash</span></span> | <span data-ttu-id="b9067-184">chaîne</span><span class="sxs-lookup"><span data-stu-id="b9067-184">string</span></span> |  |  | <span data-ttu-id="b9067-185">LoginProvider</span><span class="sxs-lookup"><span data-stu-id="b9067-185">LoginProvider</span></span> | <span data-ttu-id="b9067-186">ClaimValue</span><span class="sxs-lookup"><span data-stu-id="b9067-186">ClaimValue</span></span> |
| <span data-ttu-id="b9067-187">SecurityStamp</span><span class="sxs-lookup"><span data-stu-id="b9067-187">SecurityStamp</span></span> | <span data-ttu-id="b9067-188">chaîne</span><span class="sxs-lookup"><span data-stu-id="b9067-188">string</span></span> |  |  |  | <span data-ttu-id="b9067-189">ID de\_de l’utilisateur</span><span class="sxs-lookup"><span data-stu-id="b9067-189">User\_Id</span></span> |
| <span data-ttu-id="b9067-190">Messagerie</span><span class="sxs-lookup"><span data-stu-id="b9067-190">Email</span></span> | <span data-ttu-id="b9067-191">chaîne</span><span class="sxs-lookup"><span data-stu-id="b9067-191">string</span></span> |  |  |  |  |
| <span data-ttu-id="b9067-192">EmailConfirmed</span><span class="sxs-lookup"><span data-stu-id="b9067-192">EmailConfirmed</span></span> | <span data-ttu-id="b9067-193">bool</span><span class="sxs-lookup"><span data-stu-id="b9067-193">bool</span></span> |  |  |  |  |
| <span data-ttu-id="b9067-194">PhoneNumber</span><span class="sxs-lookup"><span data-stu-id="b9067-194">PhoneNumber</span></span> | <span data-ttu-id="b9067-195">chaîne</span><span class="sxs-lookup"><span data-stu-id="b9067-195">string</span></span> |  |  |  |  |
| <span data-ttu-id="b9067-196">PhoneNumberConfirmed</span><span class="sxs-lookup"><span data-stu-id="b9067-196">PhoneNumberConfirmed</span></span> | <span data-ttu-id="b9067-197">bool</span><span class="sxs-lookup"><span data-stu-id="b9067-197">bool</span></span> |  |  |  |  |
| <span data-ttu-id="b9067-198">LockoutEnabled</span><span class="sxs-lookup"><span data-stu-id="b9067-198">LockoutEnabled</span></span> | <span data-ttu-id="b9067-199">bool</span><span class="sxs-lookup"><span data-stu-id="b9067-199">bool</span></span> |  |  |  |  |
| <span data-ttu-id="b9067-200">LockoutEndDate</span><span class="sxs-lookup"><span data-stu-id="b9067-200">LockoutEndDate</span></span> | <span data-ttu-id="b9067-201">DateTime</span><span class="sxs-lookup"><span data-stu-id="b9067-201">DateTime</span></span> |  |  |  |  |
| <span data-ttu-id="b9067-202">AccessFailedCount</span><span class="sxs-lookup"><span data-stu-id="b9067-202">AccessFailedCount</span></span> | <span data-ttu-id="b9067-203">int</span><span class="sxs-lookup"><span data-stu-id="b9067-203">int</span></span> |  |  |  |  |

<span data-ttu-id="b9067-204">Nous devons disposer de tables pour chacun de ces modèles avec des colonnes correspondant aux propriétés.</span><span class="sxs-lookup"><span data-stu-id="b9067-204">We need to have tables for each of these models with columns corresponding to the properties.</span></span> <span data-ttu-id="b9067-205">Le mappage entre les classes et les tables est défini dans la méthode `OnModelCreating` de l' `IdentityDBContext`.</span><span class="sxs-lookup"><span data-stu-id="b9067-205">The mapping between classes and tables is defined in the `OnModelCreating` method of the `IdentityDBContext`.</span></span> <span data-ttu-id="b9067-206">C’est ce que l’on appelle la méthode de la configuration de l’API Fluent. vous trouverez [ici](https://msdn.microsoft.com/data/jj591617.aspx)des informations supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="b9067-206">This is known as the fluent API method of configuration and more information can be found [here](https://msdn.microsoft.com/data/jj591617.aspx).</span></span> <span data-ttu-id="b9067-207">La configuration des classes est indiquée ci-dessous</span><span class="sxs-lookup"><span data-stu-id="b9067-207">The configuration for the classes is as mentioned below</span></span>

| <span data-ttu-id="b9067-208">**Classe**</span><span class="sxs-lookup"><span data-stu-id="b9067-208">**Class**</span></span> | <span data-ttu-id="b9067-209">**Table**</span><span class="sxs-lookup"><span data-stu-id="b9067-209">**Table**</span></span> | <span data-ttu-id="b9067-210">**Clé primaire**</span><span class="sxs-lookup"><span data-stu-id="b9067-210">**Primary key**</span></span> | <span data-ttu-id="b9067-211">**Clé étrangère**</span><span class="sxs-lookup"><span data-stu-id="b9067-211">**Foreign key**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="b9067-212">IdentityUser</span><span class="sxs-lookup"><span data-stu-id="b9067-212">IdentityUser</span></span> | <span data-ttu-id="b9067-213">AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="b9067-213">AspnetUsers</span></span> | <span data-ttu-id="b9067-214">Id</span><span class="sxs-lookup"><span data-stu-id="b9067-214">Id</span></span> |  |
| <span data-ttu-id="b9067-215">IdentityRole</span><span class="sxs-lookup"><span data-stu-id="b9067-215">IdentityRole</span></span> | <span data-ttu-id="b9067-216">AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="b9067-216">AspnetRoles</span></span> | <span data-ttu-id="b9067-217">Id</span><span class="sxs-lookup"><span data-stu-id="b9067-217">Id</span></span> |  |
| <span data-ttu-id="b9067-218">IdentityUserRole</span><span class="sxs-lookup"><span data-stu-id="b9067-218">IdentityUserRole</span></span> | <span data-ttu-id="b9067-219">AspnetUserRole</span><span class="sxs-lookup"><span data-stu-id="b9067-219">AspnetUserRole</span></span> | <span data-ttu-id="b9067-220">UserId + RoleId</span><span class="sxs-lookup"><span data-stu-id="b9067-220">UserId + RoleId</span></span> | <span data-ttu-id="b9067-221">ID d'\_utilisateur-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="b9067-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span></span> |
| <span data-ttu-id="b9067-222">IdentityUserLogin</span><span class="sxs-lookup"><span data-stu-id="b9067-222">IdentityUserLogin</span></span> | <span data-ttu-id="b9067-223">AspnetUserLogins</span><span class="sxs-lookup"><span data-stu-id="b9067-223">AspnetUserLogins</span></span> | <span data-ttu-id="b9067-224">ProviderKey+UserId + LoginProvider</span><span class="sxs-lookup"><span data-stu-id="b9067-224">ProviderKey+UserId + LoginProvider</span></span> | <span data-ttu-id="b9067-225">AspnetUsers UserId-&gt;</span><span class="sxs-lookup"><span data-stu-id="b9067-225">UserId-&gt;AspnetUsers</span></span> |
| <span data-ttu-id="b9067-226">IdentityUserClaim</span><span class="sxs-lookup"><span data-stu-id="b9067-226">IdentityUserClaim</span></span> | <span data-ttu-id="b9067-227">AspnetUserClaims</span><span class="sxs-lookup"><span data-stu-id="b9067-227">AspnetUserClaims</span></span> | <span data-ttu-id="b9067-228">Id</span><span class="sxs-lookup"><span data-stu-id="b9067-228">Id</span></span> | <span data-ttu-id="b9067-229">ID d'\_utilisateur-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="b9067-229">User\_Id-&gt;AspnetUsers</span></span> |

<span data-ttu-id="b9067-230">Ces informations nous permettent de créer des instructions SQL pour créer des tables.</span><span class="sxs-lookup"><span data-stu-id="b9067-230">With this information we can create SQL statements to create new tables.</span></span> <span data-ttu-id="b9067-231">Nous pouvons soit écrire chaque instruction individuellement, soit générer le script entier à l’aide des commandes PowerShell EntityFramework que nous pouvons ensuite modifier en fonction des besoins.</span><span class="sxs-lookup"><span data-stu-id="b9067-231">We can either write each statement individually or generate the entire script using EntityFramework PowerShell commands which we can then edit as required.</span></span> <span data-ttu-id="b9067-232">Pour ce faire, dans VS, ouvrez la **console du gestionnaire de package** à partir du menu **affichage** ou **Outils** .</span><span class="sxs-lookup"><span data-stu-id="b9067-232">To do this, in VS open the **Package Manager Console** from the **View** or **Tools** menu</span></span>

- <span data-ttu-id="b9067-233">Exécutez la commande « Activer-migrations » pour activer les migrations EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="b9067-233">Run command "Enable-Migrations" to enable EntityFramework migrations.</span></span>
- <span data-ttu-id="b9067-234">Exécutez la commande « Add-migration initial » qui crée le code d’installation initial pour créer la C#base de données dans/VB.</span><span class="sxs-lookup"><span data-stu-id="b9067-234">Run command "Add-migration initial" which creates the initial setup code to create the database in C#/VB.</span></span>
- <span data-ttu-id="b9067-235">La dernière étape consiste à exécuter la commande « Update-Database – script » qui génère le script SQL basé sur les classes de modèle.</span><span class="sxs-lookup"><span data-stu-id="b9067-235">The final step is to run "Update-Database –Script" command that generates the SQL script based on the model classes.</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

<span data-ttu-id="b9067-236">Ce script de génération de base de données peut être utilisé comme un début où nous allons apporter des modifications supplémentaires pour ajouter de nouvelles colonnes et copier des données.</span><span class="sxs-lookup"><span data-stu-id="b9067-236">This database generation script can be used as a start where we'll be making additional changes to add new columns and copy data.</span></span> <span data-ttu-id="b9067-237">L’avantage de cela est que nous générons la table `_MigrationHistory` qui est utilisée par EntityFramework pour modifier le schéma de base de données lorsque les classes de modèle changent pour les futures versions des mises en production d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-237">The advantage of this is that we generate the `_MigrationHistory` table which is used by EntityFramework to modify the database schema when the model classes change for future versions of Identity releases.</span></span>

<span data-ttu-id="b9067-238">Les informations de l’utilisateur d’appartenance SQL avaient d’autres propriétés en plus de celles de la classe de modèle d’utilisateur d’identité, à savoir la messagerie, les tentatives de mot de passe, la date de la dernière connexion, la date du dernier verrouillage, etc. Il s’agit d’informations utiles et nous aimerions qu’elles soient reportées sur le système d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-238">The SQL membership user information had other properties in addition to the ones in the Identity user model class namely email, password attempts, last login date, last lock-out date etc. This is useful information and we would like it to be carried over to the Identity system.</span></span> <span data-ttu-id="b9067-239">Pour ce faire, vous pouvez ajouter des propriétés supplémentaires au modèle utilisateur et les mapper aux colonnes de la table dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="b9067-239">This can be done by adding additional properties to the user model and mapping them back to the table columns in the database.</span></span> <span data-ttu-id="b9067-240">Pour ce faire, nous pouvons ajouter une classe qui sous-classe le modèle de `IdentityUser`.</span><span class="sxs-lookup"><span data-stu-id="b9067-240">We can do this by adding a class that subclasses the `IdentityUser` model.</span></span> <span data-ttu-id="b9067-241">Nous pouvons ajouter les propriétés à cette classe personnalisée et modifier le script SQL pour ajouter les colonnes correspondantes lors de la création de la table.</span><span class="sxs-lookup"><span data-stu-id="b9067-241">We can add the properties to this custom class and edit the SQL script to add the corresponding columns when creating the table.</span></span> <span data-ttu-id="b9067-242">Le code de cette classe est décrit plus en détail dans l’article.</span><span class="sxs-lookup"><span data-stu-id="b9067-242">The code for this class is described further in the article.</span></span> <span data-ttu-id="b9067-243">Le script SQL permettant de créer la table `AspnetUsers` après l’ajout des nouvelles propriétés est</span><span class="sxs-lookup"><span data-stu-id="b9067-243">The SQL script for creating the `AspnetUsers` table after adding the new properties would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

<span data-ttu-id="b9067-244">Ensuite, nous devons copier les informations existantes de la base de données d’appartenance SQL vers les tables récemment ajoutées pour l’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-244">Next we need to copy the existing information from the SQL membership database to the newly added tables for Identity.</span></span> <span data-ttu-id="b9067-245">Pour ce faire, vous pouvez copier des données directement d’une table vers une autre à l’aide de SQL.</span><span class="sxs-lookup"><span data-stu-id="b9067-245">This can be done through SQL by copying data directly from one table to another.</span></span> <span data-ttu-id="b9067-246">Pour ajouter des données dans les lignes de la table, nous utilisons la construction `INSERT INTO [Table]`.</span><span class="sxs-lookup"><span data-stu-id="b9067-246">To add data into the rows of table, we use the `INSERT INTO [Table]` construct.</span></span> <span data-ttu-id="b9067-247">Pour effectuer une copie à partir d’une autre table, nous pouvons utiliser l’instruction `INSERT INTO` avec l’instruction `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="b9067-247">To copy from another table we can use the `INSERT INTO` statement along with the `SELECT` statement.</span></span> <span data-ttu-id="b9067-248">Pour obtenir toutes les informations utilisateur nécessaires, interrogez les tables *aspnet\_Users* et *ASPNET\_Membership* , puis copiez les données dans la table *AspNetUsers* .</span><span class="sxs-lookup"><span data-stu-id="b9067-248">To get all the user information we need to query the *aspnet\_Users* and *aspnet\_Membership* tables and copy the data to the *AspNetUsers* table.</span></span> <span data-ttu-id="b9067-249">Nous utilisons les `INSERT INTO` et `SELECT`, ainsi que les instructions `JOIN` et `LEFT OUTER JOIN`.</span><span class="sxs-lookup"><span data-stu-id="b9067-249">We use the `INSERT INTO` and `SELECT` along with `JOIN` and `LEFT OUTER JOIN` statements.</span></span> <span data-ttu-id="b9067-250">Pour plus d’informations sur l’interrogation et la copie de données entre des tables, consultez [ce](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) lien.</span><span class="sxs-lookup"><span data-stu-id="b9067-250">For more information about querying and copying data between tables, refer to [this](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) link.</span></span> <span data-ttu-id="b9067-251">En outre, les tables AspnetUserLogins et AspnetUserClaims sont vides, car il n’y a pas d’informations dans l’appartenance SQL qui est mappée à ce paramètre par défaut.</span><span class="sxs-lookup"><span data-stu-id="b9067-251">Additionally the AspnetUserLogins and AspnetUserClaims tables are empty to begin with since there is no information in SQL membership that maps to this by default.</span></span> <span data-ttu-id="b9067-252">La seule information copiée concerne les utilisateurs et les rôles.</span><span class="sxs-lookup"><span data-stu-id="b9067-252">The only information copied is for users and roles.</span></span> <span data-ttu-id="b9067-253">Pour le projet créé au cours des étapes précédentes, la requête SQL permettant de copier des informations dans la table users est</span><span class="sxs-lookup"><span data-stu-id="b9067-253">For the project created in the previous steps, the SQL query to copy information to the users table would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

<span data-ttu-id="b9067-254">Dans l’instruction SQL ci-dessus, les informations relatives à chaque utilisateur des tables *aspnet\_Users* et *ASPNET\_Membership* sont copiées dans les colonnes de la table *AspnetUsers* .</span><span class="sxs-lookup"><span data-stu-id="b9067-254">In the above SQL statement, information about each user from the *aspnet\_Users* and *aspnet\_Membership* tables is copied into the columns of the *AspnetUsers* table.</span></span> <span data-ttu-id="b9067-255">La seule modification effectuée ici est lorsque nous copions le mot de passe.</span><span class="sxs-lookup"><span data-stu-id="b9067-255">The only modification done here is when we copy the password.</span></span> <span data-ttu-id="b9067-256">Étant donné que l’algorithme de chiffrement des mots de passe dans l’appartenance SQL a utilisé « PasswordSalt » et « PasswordFormat », nous copions le mot de passe avec le mot de passe haché afin qu’il puisse être utilisé pour déchiffrer le mot de passe par identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-256">Since the encryption algorithm for passwords in SQL membership used 'PasswordSalt' and 'PasswordFormat', we copy that too along with the hashed password so that it can be used to decrypt the password by Identity.</span></span> <span data-ttu-id="b9067-257">Cela est expliqué plus en détail dans l’article lors de la connexion d’un hachage de mot de passe personnalisé.</span><span class="sxs-lookup"><span data-stu-id="b9067-257">This is explained further in the article when hooking up a custom password hasher.</span></span>

<span data-ttu-id="b9067-258">Ce fichier de script est spécifique à cet exemple.</span><span class="sxs-lookup"><span data-stu-id="b9067-258">This script file is specific to this sample.</span></span> <span data-ttu-id="b9067-259">Pour les applications qui ont des tables supplémentaires, les développeurs peuvent suivre une approche similaire pour ajouter des propriétés supplémentaires sur la classe de modèle utilisateur et les mapper aux colonnes de la table AspnetUsers.</span><span class="sxs-lookup"><span data-stu-id="b9067-259">For applications which have additional tables, developers can follow a similar approach to add additional properties on the user model class and map them to columns in the AspnetUsers table.</span></span> <span data-ttu-id="b9067-260">Pour exécuter le script,</span><span class="sxs-lookup"><span data-stu-id="b9067-260">To run the script,</span></span>

1. <span data-ttu-id="b9067-261">Ouvrez l’Explorateur de serveurs.</span><span class="sxs-lookup"><span data-stu-id="b9067-261">Open Server Explorer.</span></span> <span data-ttu-id="b9067-262">Développez la connexion « ApplicationServices » pour afficher les tables.</span><span class="sxs-lookup"><span data-stu-id="b9067-262">Expand the 'ApplicationServices' connection to display the tables.</span></span> <span data-ttu-id="b9067-263">Cliquez avec le bouton droit sur le nœud tables et sélectionnez l’option « nouvelle requête ».</span><span class="sxs-lookup"><span data-stu-id="b9067-263">Right click on the Tables node and select the 'New Query' option</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. <span data-ttu-id="b9067-264">Dans la fenêtre de requête, copiez et collez l’intégralité du script SQL à partir du fichier migrations. Sql.</span><span class="sxs-lookup"><span data-stu-id="b9067-264">In the query window, copy and paste the entire SQL script from the Migrations.sql file.</span></span> <span data-ttu-id="b9067-265">Exécutez le fichier de script en appuyant sur la flèche « exécuter ».</span><span class="sxs-lookup"><span data-stu-id="b9067-265">Run the script file by hitting the 'Execute' arrow button.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    <span data-ttu-id="b9067-266">Actualisez la fenêtre de Explorateur de serveurs.</span><span class="sxs-lookup"><span data-stu-id="b9067-266">Refresh the Server Explorer window.</span></span> <span data-ttu-id="b9067-267">Cinq nouvelles tables sont créées dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="b9067-267">Five new tables are created in the database.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    <span data-ttu-id="b9067-268">Voici comment les informations contenues dans les tables d’appartenance SQL sont mappées sur le nouveau système d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-268">Below is how the information in the SQL membership tables are mapped to the new Identity system.</span></span>

    <span data-ttu-id="b9067-269">Rôles de\_ASPNET--&gt; AspNetRoles</span><span class="sxs-lookup"><span data-stu-id="b9067-269">aspnet\_Roles --&gt; AspNetRoles</span></span>

    <span data-ttu-id="b9067-270">ASP\_netusers et ASP\_netmembre--&gt; AspNetUsers</span><span class="sxs-lookup"><span data-stu-id="b9067-270">asp\_netUsers and asp\_netMembership --&gt; AspNetUsers</span></span>

    <span data-ttu-id="b9067-271">ASPNET\_UserInRoles--&gt; AspNetUserRoles</span><span class="sxs-lookup"><span data-stu-id="b9067-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span></span>

    <span data-ttu-id="b9067-272">Comme expliqué dans la section ci-dessus, les tables AspNetUserClaims et AspNetUserLogins sont vides.</span><span class="sxs-lookup"><span data-stu-id="b9067-272">As explained in the above section, the AspNetUserClaims and AspNetUserLogins tables are empty.</span></span> <span data-ttu-id="b9067-273">Le champ « discriminant » dans la table AspNetUser doit correspondre au nom de la classe de modèle qui est défini comme étape suivante.</span><span class="sxs-lookup"><span data-stu-id="b9067-273">The 'Discriminator' field in the AspNetUser table should match the model class name which is defined as a next step.</span></span> <span data-ttu-id="b9067-274">En outre, la colonne PasswordHash se présente sous la forme « mot de passe chiffré | Salt de mot de passe | format du mot de passe ».</span><span class="sxs-lookup"><span data-stu-id="b9067-274">Also the PasswordHash column is in the form 'encrypted password |password salt|password format'.</span></span> <span data-ttu-id="b9067-275">Cela vous permet d’utiliser une logique de chiffrement d’appartenance SQL spéciale afin que vous puissiez réutiliser les anciens mots de passe.</span><span class="sxs-lookup"><span data-stu-id="b9067-275">This enables you to use special SQL membership crypto logic so that you can reuse old passwords.</span></span> <span data-ttu-id="b9067-276">Cela est expliqué dans plus loin dans cet article.</span><span class="sxs-lookup"><span data-stu-id="b9067-276">That is explained in later in the article.</span></span>

### <a name="creating-models-and-membership-pages"></a><span data-ttu-id="b9067-277">Création de modèles et de pages d’appartenance</span><span class="sxs-lookup"><span data-stu-id="b9067-277">Creating models and membership pages</span></span>

<span data-ttu-id="b9067-278">Comme indiqué précédemment, la fonctionnalité d’identité utilise Entity Framework pour communiquer avec la base de données afin de stocker les informations de compte par défaut.</span><span class="sxs-lookup"><span data-stu-id="b9067-278">As mentioned earlier, the Identity feature uses Entity Framework to talk to the database for storing account information by default.</span></span> <span data-ttu-id="b9067-279">Pour travailler avec des données existantes dans la table, nous devons créer des classes de modèle qui mappent aux tables et les raccordent dans le système d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-279">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="b9067-280">Dans le cadre du contrat d’identité, les classes de modèle doivent implémenter les interfaces définies dans la dll Identity. Core ou étendre l’implémentation existante de ces interfaces disponibles dans Microsoft. AspNet. Identity. EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="b9067-280">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span>

<span data-ttu-id="b9067-281">Dans notre exemple, les tables AspNetRoles, AspNetUserClaims, AspNetLogins et AspNetUserRole ont des colonnes similaires à l’implémentation existante du système d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-281">In our sample, the AspNetRoles, AspNetUserClaims, AspNetLogins and AspNetUserRole tables have columns that are similar to the existing implementation of the Identity system.</span></span> <span data-ttu-id="b9067-282">Par conséquent, nous pouvons réutiliser les classes existantes pour les mapper à ces tables.</span><span class="sxs-lookup"><span data-stu-id="b9067-282">Hence we can reuse the existing classes to map to these tables.</span></span> <span data-ttu-id="b9067-283">La table AspNetUser contient des colonnes supplémentaires qui sont utilisées pour stocker des informations supplémentaires à partir des tables d’appartenance SQL.</span><span class="sxs-lookup"><span data-stu-id="b9067-283">The AspNetUser table has some additional columns which are used to store additional information from the SQL membership tables.</span></span> <span data-ttu-id="b9067-284">Cela peut être mappé en créant une classe de modèle qui étend l’implémentation existante de’IdentityUser’et ajouter les propriétés supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="b9067-284">This can be mapped by creating a model class that extend the existing implementation of 'IdentityUser' and add the additional properties.</span></span>

1. <span data-ttu-id="b9067-285">Créez un dossier Models dans le projet et ajoutez un utilisateur de classe.</span><span class="sxs-lookup"><span data-stu-id="b9067-285">Create a Models folder in the project and add a class User.</span></span> <span data-ttu-id="b9067-286">Le nom de la classe doit correspondre aux données ajoutées dans la colonne « discriminant » de la table « AspnetUsers ».</span><span class="sxs-lookup"><span data-stu-id="b9067-286">The name of the class should match the data added in the 'Discriminator' column of 'AspnetUsers' table.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    <span data-ttu-id="b9067-287">La classe User doit étendre la classe IdentityUser trouvée dans la dll *Microsoft. Aspnet. Identity. EntityFramework* .</span><span class="sxs-lookup"><span data-stu-id="b9067-287">The User class should extend the IdentityUser class found in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="b9067-288">Déclarez les propriétés de la classe qui mappent aux colonnes AspNetUser.</span><span class="sxs-lookup"><span data-stu-id="b9067-288">Declare the properties in class that map back to the AspNetUser columns.</span></span> <span data-ttu-id="b9067-289">Les propriétés ID, username, PasswordHash et SecurityStamp sont définies dans le IdentityUser et sont donc omises.</span><span class="sxs-lookup"><span data-stu-id="b9067-289">The properties ID, Username, PasswordHash and SecurityStamp are defined in the IdentityUser and so are omitted.</span></span> <span data-ttu-id="b9067-290">Voici le code de la classe utilisateur qui possède toutes les propriétés</span><span class="sxs-lookup"><span data-stu-id="b9067-290">Below is the code for the User class that has all the properties</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. <span data-ttu-id="b9067-291">Une classe DbContext Entity Framework est requise pour conserver les données des modèles dans les tables et récupérer les données des tables pour remplir les modèles.</span><span class="sxs-lookup"><span data-stu-id="b9067-291">An Entity Framework DbContext class is required in order to persist data in models back to tables and retrieve data from tables to populate the models.</span></span> <span data-ttu-id="b9067-292">La dll *Microsoft. Aspnet. Identity. EntityFramework* définit la classe IdentityDbContext qui interagit avec les tables d’identité pour récupérer et stocker des informations.</span><span class="sxs-lookup"><span data-stu-id="b9067-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span></span> <span data-ttu-id="b9067-293">Le&gt; IdentityDbContext&lt;TUser prend une classe’TUser’qui peut être toute classe qui étend la classe IdentityUser.</span><span class="sxs-lookup"><span data-stu-id="b9067-293">The IdentityDbContext&lt;tuser&gt; takes a 'TUser' class which can be any class that extends the IdentityUser class.</span></span>

    <span data-ttu-id="b9067-294">Créez une nouvelle classe ApplicationDBContext qui étend IdentityDbContext sous le dossier « Models », en transmettant la classe « User » créée à l’étape 1</span><span class="sxs-lookup"><span data-stu-id="b9067-294">Create a new class ApplicationDBContext that extends IdentityDbContext under the 'Models' folder, passing in the 'User' class created in step 1</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. <span data-ttu-id="b9067-295">La gestion des utilisateurs dans le nouveau système d’identité s’effectue à l’aide de la classe UserManager&lt;TUser&gt; définie dans la dll *Microsoft. Aspnet. Identity. EntityFramework* .</span><span class="sxs-lookup"><span data-stu-id="b9067-295">User management in the new Identity system is done using the UserManager&lt;tuser&gt; class defined in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="b9067-296">Nous devons créer une classe personnalisée qui étend UserManager, en transmettant la classe « User » créée à l’étape 1.</span><span class="sxs-lookup"><span data-stu-id="b9067-296">We need to create a custom class that extends UserManager, passing in the 'User' class created in step 1.</span></span>

    <span data-ttu-id="b9067-297">Dans le dossier Models, créez une nouvelle classe UserManager qui étend UserManager&lt;utilisateur&gt;</span><span class="sxs-lookup"><span data-stu-id="b9067-297">In the Models folder create a new class UserManager that extends UserManager&lt;user&gt;</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. <span data-ttu-id="b9067-298">Les mots de passe des utilisateurs de l’application sont chiffrés et stockés dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="b9067-298">The passwords of the users of the application are encrypted and stored in the database.</span></span> <span data-ttu-id="b9067-299">L’algorithme de chiffrement utilisé dans l’appartenance SQL est différent de celui du nouveau système d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-299">The crypto algorithm used in SQL membership is different from the one in the new Identity system.</span></span> <span data-ttu-id="b9067-300">Pour réutiliser les anciens mots de passe, nous devons déchiffrer les mots de passe de manière sélective lorsque les anciens utilisateurs se connectent à l’aide de l’algorithme d’appartenances SQL lors de l’utilisation de l’algorithme de chiffrement pour les nouveaux utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="b9067-300">To reuse old passwords we need to selectively decrypt passwords when old users log in using the SQL memberships algorithm while using the crypto algorithm in Identity for the new users.</span></span>

    <span data-ttu-id="b9067-301">La classe UserManager a une propriété « PasswordHasher » qui stocke une instance d’une classe qui implémente l’interface « IPasswordHasher ».</span><span class="sxs-lookup"><span data-stu-id="b9067-301">The UserManager class has a property 'PasswordHasher' which stores an instance of a class that implements the 'IPasswordHasher' interface.</span></span> <span data-ttu-id="b9067-302">Cela permet de chiffrer/déchiffrer les mots de passe lors des transactions d’authentification utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b9067-302">This is used to encrypt/decrypt passwords during user authentication transactions.</span></span> <span data-ttu-id="b9067-303">Dans la classe UserManager définie à l’étape 3, créez une nouvelle classe SQLPasswordHasher et copiez le code ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="b9067-303">In the UserManager class defined in step 3, create a new class SQLPasswordHasher and copy the below code.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    <span data-ttu-id="b9067-304">Résolvez les erreurs de compilation en important les espaces de noms System. Text et System. Security. Cryptography.</span><span class="sxs-lookup"><span data-stu-id="b9067-304">Resolve the compilation errors by importing the System.Text and System.Security.Cryptography namespaces.</span></span>

    <span data-ttu-id="b9067-305">La méthode EncodePassword chiffre le mot de passe en fonction de l’implémentation de chiffrement par défaut de l’appartenance SQL.</span><span class="sxs-lookup"><span data-stu-id="b9067-305">The EncodePassword method encrypts the password according to the default SQL membership crypto implementation.</span></span> <span data-ttu-id="b9067-306">Cette erreur provient de la DLL System. Web.</span><span class="sxs-lookup"><span data-stu-id="b9067-306">This is taken from the System.Web dll.</span></span> <span data-ttu-id="b9067-307">Si l’ancienne application utilisait une implémentation personnalisée, elle devrait être reflétée ici.</span><span class="sxs-lookup"><span data-stu-id="b9067-307">If the old app used a custom implementation then it should be reflected here.</span></span> <span data-ttu-id="b9067-308">Nous devons définir deux autres méthodes *HashPassword* et *VerifyHashedPassword* qui utilisent la méthode *EncodePassword* pour hacher un mot de passe donné ou vérifier un mot de passe en texte brut avec celui existant dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="b9067-308">We need to define two other methods *HashPassword* and *VerifyHashedPassword* that use the *EncodePassword* method to hash a given password or verify a plain text password with the one existing in the database.</span></span>

    <span data-ttu-id="b9067-309">Le système d’appartenance SQL a utilisé PasswordHash, PasswordSalt et PasswordFormat pour hacher le mot de passe entré par les utilisateurs lorsqu’ils inscrivent ou modifient leur mot de passe.</span><span class="sxs-lookup"><span data-stu-id="b9067-309">The SQL membership system used PasswordHash, PasswordSalt and PasswordFormat to hash the password entered by users when they register or change their password.</span></span> <span data-ttu-id="b9067-310">Pendant la migration, les trois champs sont stockés dans la colonne PasswordHash de la table AspNetUser, séparés par le caractère « | ».</span><span class="sxs-lookup"><span data-stu-id="b9067-310">During the migration all the three fields are stored in the PasswordHash column in the AspNetUser table separated by the '|' character.</span></span> <span data-ttu-id="b9067-311">Lorsqu’un utilisateur se connecte et que le mot de passe comporte ces champs, nous utilisons le chiffrement d’appartenance SQL pour vérifier le mot de passe. dans le cas contraire, nous utilisons le chiffrement par défaut du système d’identité pour vérifier le mot de passe.</span><span class="sxs-lookup"><span data-stu-id="b9067-311">When a user logs in and the password has these fields, we use the SQL membership crypto to check the password; otherwise we use the Identity system's default crypto to verify the password.</span></span> <span data-ttu-id="b9067-312">De cette façon, les anciens utilisateurs n’ont pas besoin de modifier leurs mots de passe une fois l’application migrée.</span><span class="sxs-lookup"><span data-stu-id="b9067-312">This way old users would not have to change their passwords once the app is migrated.</span></span>
5. <span data-ttu-id="b9067-313">Déclarez le constructeur pour la classe UserManager et transmettez-le en tant que SQLPasswordHasher à la propriété dans le constructeur.</span><span class="sxs-lookup"><span data-stu-id="b9067-313">Declare the constructor for the UserManager class and pass this as the SQLPasswordHasher to the property in the constructor.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a><span data-ttu-id="b9067-314">Créer des pages de gestion de compte</span><span class="sxs-lookup"><span data-stu-id="b9067-314">Create new account management pages</span></span>

<span data-ttu-id="b9067-315">L’étape suivante de la migration consiste à ajouter des pages de gestion des comptes permettant à un utilisateur de s’inscrire et de se connecter.</span><span class="sxs-lookup"><span data-stu-id="b9067-315">The next step in the migration is to add account management pages that will let a user register and log in.</span></span> <span data-ttu-id="b9067-316">Les anciennes pages de compte de l’appartenance SQL utilisent des contrôles qui ne fonctionnent pas avec le nouveau système d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-316">The old account pages from SQL membership use controls that don't work with the new Identity system.</span></span> <span data-ttu-id="b9067-317">Pour ajouter les nouvelles pages de gestion des utilisateurs, suivez le didacticiel de ce lien [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) en commençant par l’étape « ajout d’Web Forms pour l’inscription des utilisateurs à votre application », car nous avons déjà créé le projet et ajouté les packages NuGet.</span><span class="sxs-lookup"><span data-stu-id="b9067-317">To add the new user management pages follow the tutorial at this link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) starting from the step 'Adding Web Forms for registering users to your application' since we have already created the project and added the NuGet packages.</span></span>

<span data-ttu-id="b9067-318">Nous devons apporter des modifications à l’exemple pour qu’il fonctionne avec le projet que nous avons ici.</span><span class="sxs-lookup"><span data-stu-id="b9067-318">We need to make some changes for the sample to work with the project we have here.</span></span>

- <span data-ttu-id="b9067-319">Les classes Register.aspx.cs et Login.aspx.cs code-behind utilisent le `UserManager` des packages d’identité pour créer un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b9067-319">The Register.aspx.cs and Login.aspx.cs code behind classes use the `UserManager` from the Identity packages to create a User.</span></span> <span data-ttu-id="b9067-320">Pour cet exemple, utilisez la UserManager ajoutée dans le dossier Models en suivant les étapes mentionnées précédemment.</span><span class="sxs-lookup"><span data-stu-id="b9067-320">For this example use the UserManager added in the Models folder by following the steps mentioned earlier.</span></span>
- <span data-ttu-id="b9067-321">Utilisez la classe d’utilisateur créée à la place de IdentityUser dans les classes Register.aspx.cs et Login.aspx.cs code-behind.</span><span class="sxs-lookup"><span data-stu-id="b9067-321">Use the User class created instead of the IdentityUser in Register.aspx.cs and Login.aspx.cs code behind classes.</span></span> <span data-ttu-id="b9067-322">Ce hook dans notre classe d’utilisateur personnalisée dans le système d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-322">This hooks in our custom user class into the Identity system.</span></span>
- <span data-ttu-id="b9067-323">La partie pour créer la base de données peut être ignorée.</span><span class="sxs-lookup"><span data-stu-id="b9067-323">The part to create the database can be skipped.</span></span>
- <span data-ttu-id="b9067-324">Le développeur doit définir l’ID de l’application pour que le nouvel utilisateur corresponde à l’ID d’application actuel.</span><span class="sxs-lookup"><span data-stu-id="b9067-324">The developer needs to set the ApplicationId for the new user to match the current application ID.</span></span> <span data-ttu-id="b9067-325">Pour ce faire, vous pouvez interroger l’ApplicationId pour cette application avant qu’un objet utilisateur soit créé dans la classe Register.aspx.cs et le définir avant de créer l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b9067-325">This can be done by querying the ApplicationId for this application before a user object is created in the Register.aspx.cs class and setting it before creating user.</span></span>

    <span data-ttu-id="b9067-326">Exemple :</span><span class="sxs-lookup"><span data-stu-id="b9067-326">Example:</span></span>

    <span data-ttu-id="b9067-327">Définir une méthode dans la page Register.aspx.cs pour interroger la table ASPNET\_applications et obtenir l’ID d’application en fonction du nom de l’application</span><span class="sxs-lookup"><span data-stu-id="b9067-327">Define a method in Register.aspx.cs page to query the aspnet\_Applications table and get the application Id according to application name</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    <span data-ttu-id="b9067-328">Maintenant, définissez cette valeur sur l’objet utilisateur</span><span class="sxs-lookup"><span data-stu-id="b9067-328">Now get set this on the user object</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="b9067-329">Utilisez l’ancien nom d’utilisateur et le mot de passe pour vous connecter à un utilisateur existant.</span><span class="sxs-lookup"><span data-stu-id="b9067-329">Use the old username and password to login an existing user.</span></span> <span data-ttu-id="b9067-330">Utilisez la page s’inscrire pour créer un nouvel utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b9067-330">Use the Register page to create a new user.</span></span> <span data-ttu-id="b9067-331">Vérifiez également que les utilisateurs sont dans les rôles comme prévu.</span><span class="sxs-lookup"><span data-stu-id="b9067-331">Also verify that the users are in roles as expected.</span></span>

<span data-ttu-id="b9067-332">Le portage vers le système d’identité permet à l’utilisateur d’ajouter l’authentification Open (OAuth) à l’application.</span><span class="sxs-lookup"><span data-stu-id="b9067-332">Porting to the Identity system helps the user add Open Authentication (OAuth) to the application.</span></span> <span data-ttu-id="b9067-333">Reportez-vous à l’exemple [ici](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) , avec OAuth activé.</span><span class="sxs-lookup"><span data-stu-id="b9067-333">Please refer to the sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) which has OAuth enabled.</span></span>

## <a name="next-steps"></a><span data-ttu-id="b9067-334">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="b9067-334">Next Steps</span></span>

<span data-ttu-id="b9067-335">Dans ce didacticiel, nous avons montré comment porter les utilisateurs de l’appartenance SQL vers ASP.NET Identity, mais nous n’avions pas de données de profil de port.</span><span class="sxs-lookup"><span data-stu-id="b9067-335">In this tutorial we showed how to port users from SQL membership to ASP.NET Identity, but we didn't port Profile data.</span></span> <span data-ttu-id="b9067-336">Dans le didacticiel suivant, nous allons examiner le portage des données de profil de l’appartenance SQL vers le nouveau système d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9067-336">In the next tutorial we'll look into porting Profile data from SQL membership to the new Identity system.</span></span>

<span data-ttu-id="b9067-337">Vous pouvez conserver vos commentaires au bas de cet article.</span><span class="sxs-lookup"><span data-stu-id="b9067-337">You can leave feedback at the bottom of this article.</span></span>

<span data-ttu-id="b9067-338">*Merci à Tom Dykstra et Rick Anderson de passer en revue l’article.*</span><span class="sxs-lookup"><span data-stu-id="b9067-338">*Thanks to Tom Dykstra and Rick Anderson for reviewing the article.*</span></span>
