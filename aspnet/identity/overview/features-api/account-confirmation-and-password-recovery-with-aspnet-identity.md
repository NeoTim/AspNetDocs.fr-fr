---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: Confirmation de compte & récupération du mot deC#passe-ASP.net Identity ()-ASP.net 4. x
author: HaoK
description: Avant de suivre ce didacticiel, vous devez d’abord créer une application Web ASP.NET MVC 5 sécurisée avec connexion, confirmation par e-mail et réinitialisation du mot de passe. Ce didacticiel...
ms.author: riande
ms.date: 01/23/2019
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 4b2c88280df39aa81d60f9508910e8fe5d6db6b8
ms.sourcegitcommit: 88fc80e3f65aebdf61ec9414810ddbc31c543f04
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/22/2020
ms.locfileid: "76519113"
---
# <a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="7d0eb-104">Confirmation de compte et récupération de mot deC#passe avec ASP.net Identity ()</span><span class="sxs-lookup"><span data-stu-id="7d0eb-104">Account confirmation and password recovery with ASP.NET Identity (C#)</span></span>

> <span data-ttu-id="7d0eb-105">Avant de suivre ce didacticiel, vous devez [d’abord créer une application web ASP.NET MVC 5 sécurisée avec connexion, confirmation par e-mail et réinitialisation du mot de passe](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-105">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="7d0eb-106">Ce didacticiel contient plus de détails et vous indique comment configurer la messagerie électronique pour la confirmation du compte local et permettre aux utilisateurs de réinitialiser leur mot de passe oublié dans ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-106">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span>

<span data-ttu-id="7d0eb-107">Un compte d’utilisateur local oblige l’utilisateur à créer un mot de passe pour le compte et ce mot de passe est stocké (en toute sécurité) dans l’application Web.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-107">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="7d0eb-108">ASP.NET Identity prend également en charge les comptes sociaux, qui ne nécessitent pas que l’utilisateur crée un mot de passe pour l’application.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-108">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="7d0eb-109">Les [comptes sociaux](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) utilisent un tiers (par exemple, Google, Twitter, Facebook ou Microsoft) pour authentifier les utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-109">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook, or Microsoft) to authenticate users.</span></span> <span data-ttu-id="7d0eb-110">Cette rubrique couvre les sujets suivants :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-110">This topic covers the following:</span></span>

- <span data-ttu-id="7d0eb-111">[Créez une application MVC ASP.net](#createMvc) et explorez les fonctionnalités de ASP.net Identity.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-111">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="7d0eb-112">Générer l’exemple Identity</span><span class="sxs-lookup"><span data-stu-id="7d0eb-112">Build the Identity sample</span></span>](#build)
- [<span data-ttu-id="7d0eb-113">Configurer la confirmation par e-mail</span><span class="sxs-lookup"><span data-stu-id="7d0eb-113">Set up email confirmation</span></span>](#email)

<span data-ttu-id="7d0eb-114">Les nouveaux utilisateurs inscrivent leur alias de messagerie, ce qui crée un compte local.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-114">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="7d0eb-115">Le fait de sélectionner le bouton inscrire envoie un e-mail de confirmation contenant un jeton de validation à son adresse de messagerie.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-115">Selecting the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="7d0eb-116">L’utilisateur reçoit un e-mail avec un jeton de confirmation pour son compte.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-116">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="7d0eb-117">La sélection du lien confirme le compte.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-117">Selecting the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="7d0eb-118">Récupération/réinitialisation du mot de passe</span><span class="sxs-lookup"><span data-stu-id="7d0eb-118">Password recovery/reset</span></span>

<span data-ttu-id="7d0eb-119">Les utilisateurs locaux qui oublient leur mot de passe peuvent avoir un jeton de sécurité envoyé à leur compte de messagerie, ce qui leur permet de réinitialiser leur mot de passe.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-119">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="7d0eb-120">L’utilisateur recevra bientôt un e-mail contenant un lien leur permettant de réinitialiser leur mot de passe.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-120">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="7d0eb-121">Si vous sélectionnez le lien, la page de réinitialisation est redéfinie.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-121">Selecting the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="7d0eb-122">Le fait de sélectionner le bouton **Réinitialiser** confirme que le mot de passe a été réinitialisé.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-122">Selecting the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="7d0eb-123">Créer une application web ASP.NET</span><span class="sxs-lookup"><span data-stu-id="7d0eb-123">Create an ASP.NET web app</span></span>

<span data-ttu-id="7d0eb-124">Commencez par installer et exécuter [Visual Studio 2017](https://visualstudio.microsoft.com/).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-124">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/).</span></span>

1. <span data-ttu-id="7d0eb-125">Créez un projet Web ASP.NET et sélectionnez le modèle MVC.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-125">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="7d0eb-126">Web Forms également prendre en charge ASP.NET Identity, vous pouvez suivre des étapes similaires dans une application Web Forms.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-126">Web Forms also support ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="7d0eb-127">Modifiez l’authentification en **comptes d’utilisateur individuels**.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-127">Change the authentication to **Individual User Accounts**.</span></span>
3. <span data-ttu-id="7d0eb-128">Exécutez l’application, sélectionnez le lien **Register** et inscrivez un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-128">Run the app, select the **Register** link and register a user.</span></span> <span data-ttu-id="7d0eb-129">À ce stade, la seule validation sur l’adresse e-mail se fait avec l'attribut [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-129">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="7d0eb-130">Dans Explorateur de serveurs, accédez à **Data Connections\DefaultConnection\Tables\AspNetUsers**, cliquez avec le bouton droit et sélectionnez **ouvrir la définition de table**.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-130">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right-click and select **Open table definition**.</span></span>

    <span data-ttu-id="7d0eb-131">L’illustration suivante montre le schéma `AspNetUsers` :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-131">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="7d0eb-132">Cliquez avec le bouton droit sur la table **AspNetUsers** et sélectionnez **afficher les données**de la table.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-132">Right-click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="7d0eb-133">À ce stade, l’adresse de messagerie n’a pas été confirmée.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-133">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="7d0eb-134">Le magasin de données par défaut pour ASP.NET Identity est Entity Framework, mais vous pouvez le configurer pour utiliser d’autres magasins de données et ajouter des champs supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-134">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="7d0eb-135">Consultez la section [ressources supplémentaires](#addRes) à la fin de ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-135">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="7d0eb-136">La [classe de démarrage OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) est appelée lorsque l’application démarre et appelle la méthode `ConfigureAuth` dans l' *application\_Start\Startup.auth.cs*, qui configure le pipeline OWIN et initialise ASP.net Identity.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-136">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="7d0eb-137">Examinez la méthode `ConfigureAuth`.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-137">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="7d0eb-138">Chaque appel de `CreatePerOwinContext` inscrit un rappel (enregistré dans le `OwinContext`) qui sera appelé une fois par demande pour créer une instance du type spécifié.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-138">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="7d0eb-139">Vous pouvez définir un point d’arrêt dans le constructeur et `Create` méthode de chaque type (`ApplicationDbContext, ApplicationUserManager`) et vérifier qu’ils sont appelés à chaque requête.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-139">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="7d0eb-140">Une instance de `ApplicationDbContext` et `ApplicationUserManager` est stockée dans le contexte OWIN, accessible dans l’ensemble de l’application.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-140">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="7d0eb-141">ASP.NET Identity des hooks dans le pipeline OWIN via l’intergiciel de cookies.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-141">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="7d0eb-142">Pour plus d’informations, consultez Gestion de la [durée de vie des demandes pour la classe usermanager dans ASP.net Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-142">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="7d0eb-143">Lorsque vous modifiez votre profil de sécurité, un nouveau tampon de sécurité est généré et stocké dans le champ `SecurityStamp` de la table *AspNetUsers* .</span><span class="sxs-lookup"><span data-stu-id="7d0eb-143">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="7d0eb-144">Notez que le champ `SecurityStamp` est différent du cookie de sécurité.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-144">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="7d0eb-145">Le cookie de sécurité n’est pas stocké dans la table `AspNetUsers` (ou n’importe où ailleurs dans la base de l’identité).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-145">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="7d0eb-146">Le jeton de cookie de sécurité est auto-signé à l’aide de [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) et est créé avec les informations de `UserId, SecurityStamp` et d’heure d’expiration.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-146">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="7d0eb-147">L’intergiciel de cookies vérifie le cookie à chaque requête.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-147">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="7d0eb-148">La méthode `SecurityStampValidator` de la classe `Startup` atteint la base de donnée et vérifie périodiquement la présence d’un tampon de sécurité, comme spécifié avec le `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-148">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="7d0eb-149">Cela se produit toutes les 30 minutes (dans notre exemple), sauf si vous modifiez votre profil de sécurité.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-149">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="7d0eb-150">L’intervalle de 30 minutes a été choisi pour limiter les allers-retours vers la base de données.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-150">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="7d0eb-151">Pour plus d’informations, consultez [le didacticiel sur l’authentification à deux facteurs](index.md) .</span><span class="sxs-lookup"><span data-stu-id="7d0eb-151">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="7d0eb-152">En fonction des commentaires du code, la méthode `UseCookieAuthentication` prend en charge l’authentification par cookie.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-152">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="7d0eb-153">Le champ `SecurityStamp` et le code associé fournissent une couche supplémentaire de sécurité à votre application. quand vous modifiez votre mot de passe, vous êtes déconnecté du navigateur avec lequel vous vous êtes connecté.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-153">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="7d0eb-154">La méthode `SecurityStampValidator.OnValidateIdentity` permet à l’application de valider le jeton de sécurité lorsque l’utilisateur se connecte, ce qui est utilisé lorsque vous modifiez un mot de passe ou utilisez la connexion externe.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-154">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="7d0eb-155">Cela est nécessaire pour garantir que tous les jetons (cookies) générés avec l’ancien mot de passe sont invalidés.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-155">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="7d0eb-156">Dans l’exemple de projet, si vous modifiez le mot de passe des utilisateurs, un nouveau jeton est généré pour l’utilisateur, tous les jetons précédents sont invalidés et le champ `SecurityStamp` est mis à jour.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-156">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="7d0eb-157">Le système d’identité vous permet de configurer votre application de sorte que le profil de sécurité des utilisateurs change (par exemple, lorsque l’utilisateur modifie son mot de passe ou modifie la connexion associée (par exemple, à partir de Facebook, Google, compte Microsoft, etc.), l’utilisateur se déconnecte de tous les instances de navigateur.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-157">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="7d0eb-158">Par exemple, l’image ci-dessous montre l’exemple d’application [SignOut unique](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) , qui permet à l’utilisateur de se déconnecter de toutes les instances de navigateur (dans ce cas, IE, Firefox et chrome) en sélectionnant un bouton.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-158">For example, the image below shows the [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by selecting one button.</span></span> <span data-ttu-id="7d0eb-159">L’exemple vous permet également de vous déconnecter d’une instance de navigateur spécifique.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-159">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="7d0eb-160">L' [exemple d’application SignOut unique](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) montre comment ASP.net Identity vous permet de régénérer le jeton de sécurité.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-160">The [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="7d0eb-161">Cela est nécessaire pour garantir que tous les jetons (cookies) générés avec l’ancien mot de passe sont invalidés.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-161">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="7d0eb-162">Cette fonctionnalité fournit une couche supplémentaire de sécurité à votre application. Lorsque vous modifiez votre mot de passe, vous êtes déconnecté de l’emplacement où vous vous êtes connecté à cette application.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-162">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="7d0eb-163">Le fichier *App\_Start\IdentityConfig.cs* contient les classes `ApplicationUserManager`, `EmailService` et `SmsService`.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-163">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="7d0eb-164">Les classes `EmailService` et `SmsService` implémentent chacune l’interface `IIdentityMessageService`. par conséquent, vous disposez de méthodes communes pour chaque classe afin de configurer la messagerie électronique et SMS.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-164">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="7d0eb-165">Bien que ce didacticiel montre uniquement comment ajouter des notifications par courrier électronique via [SendGrid](http://sendgrid.com/), vous pouvez envoyer des e-mails à l’aide de SMTP et d’autres mécanismes.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-165">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="7d0eb-166">La classe `Startup` contient également une plaque de chaudière pour ajouter des connexions sociales (Facebook, Twitter, etc.). pour plus d’informations, consultez mon didacticiel [application MVC 5 avec Facebook, Twitter, LinkedIn et l’authentification Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) .</span><span class="sxs-lookup"><span data-stu-id="7d0eb-166">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="7d0eb-167">Examinez la classe `ApplicationUserManager`, qui contient les informations d’identité des utilisateurs et configure les fonctionnalités suivantes :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-167">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="7d0eb-168">Exigences de la force du mot de passe.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-168">Password strength requirements.</span></span>
- <span data-ttu-id="7d0eb-169">Verrouillage de l’utilisateur (tentatives et temps).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-169">User lock out (attempts and time).</span></span>
- <span data-ttu-id="7d0eb-170">Authentification à deux facteurs (2FA).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-170">Two-factor authentication (2FA).</span></span> <span data-ttu-id="7d0eb-171">Je vais aborder 2FA et SMS dans un autre didacticiel.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-171">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="7d0eb-172">Raccordement de l’e-mail et des services SMS.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-172">Hooking up the email and SMS services.</span></span> <span data-ttu-id="7d0eb-173">(Je couvrirai SMS dans un autre didacticiel).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-173">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="7d0eb-174">La classe `ApplicationUserManager` dérive de la classe `UserManager<ApplicationUser>` générique.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-174">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="7d0eb-175">`ApplicationUser` dérive de [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-175">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="7d0eb-176">`IdentityUser` dérive de la classe `IdentityUser` générique :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-176">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="7d0eb-177">Les propriétés ci-dessus coïncident avec les propriétés de la table `AspNetUsers`, comme indiqué ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-177">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="7d0eb-178">Les arguments génériques sur les `IUser` vous permettent de dériver une classe à l’aide de différents types pour la clé primaire.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-178">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="7d0eb-179">Consultez l’exemple [ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK) qui montre comment modifier la clé primaire de String en int ou de GUID.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-179">See the [ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="7d0eb-180">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="7d0eb-180">ApplicationUser</span></span>

<span data-ttu-id="7d0eb-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) est défini dans *Models\IdentityModels.cs* comme suit :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="7d0eb-182">Le code en surbrillance ci-dessus génère un [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-182">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="7d0eb-183">ASP.NET Identity et l’authentification des cookies OWIN sont basées sur les revendications. par conséquent, l’infrastructure requiert que l’application génère un `ClaimsIdentity` pour l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-183">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="7d0eb-184">`ClaimsIdentity` contient des informations sur toutes les revendications pour l’utilisateur, telles que le nom de l’utilisateur, l’âge et les rôles auxquels l’utilisateur appartient.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-184">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="7d0eb-185">Vous pouvez également ajouter d’autres revendications pour l’utilisateur à ce niveau.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-185">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="7d0eb-186">La méthode OWIN `AuthenticationManager.SignIn` transmet le `ClaimsIdentity` et se connecte à l’utilisateur :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-186">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="7d0eb-187">L' [application MVC 5 avec Facebook, Twitter, LinkedIn et l’authentification Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) montre comment vous pouvez ajouter des propriétés supplémentaires à la classe `ApplicationUser`.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-187">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="7d0eb-188">Confirmation par e-mail</span><span class="sxs-lookup"><span data-stu-id="7d0eb-188">Email confirmation</span></span>

<span data-ttu-id="7d0eb-189">Il est judicieux de confirmer l’adresse de messagerie à laquelle un nouvel utilisateur s’inscrit afin de vérifier qu’il n’emprunte pas l’identité d’un autre utilisateur (autrement dit, s’il ne s’est pas inscrit auprès de l’e-mail de quelqu’un d’autre).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-189">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="7d0eb-190">Supposons que vous ayez un forum de discussion : vous voudriez empêcher `"bob@example.com"` de s'inscrire en tant que `"joe@contoso.com"`.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-190">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="7d0eb-191">ans la confirmation par courrier électronique, `"joe@contoso.com"` pourrait recevoir du courrier indésirable à partir de votre application.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-191">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="7d0eb-192">Supposons que Bob s’est inscrit accidentellement comme `"bib@example.com"` et n’avait pas remarqué qu’il ne serait pas en mesure d’utiliser la récupération de mot de passe parce que l’application n’a pas son adresse e-mail correcte.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-192">Suppose Bob accidentally registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="7d0eb-193">La confirmation par courrier électronique fournit uniquement une protection limitée des robots et ne fournit pas de protection contre les spammeurs déterminés. ils ont de nombreux alias de messagerie de travail qu’ils peuvent utiliser pour s’inscrire. Dans l’exemple ci-dessous, l’utilisateur ne peut pas modifier son mot de passe tant que son compte n’a pas été confirmé (en sélectionnant un lien de confirmation reçu sur le compte de messagerie qu’il a inscrit avec). Vous pouvez appliquer ce processus à d’autres scénarios, par exemple en envoyant un lien pour confirmer et réinitialiser le mot de passe sur les nouveaux comptes créés par l’administrateur, en envoyant un e-mail à l’utilisateur lorsqu’il a modifié son profil, et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-193">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them selecting a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="7d0eb-194">En règle générale, vous souhaitez empêcher les nouveaux utilisateurs d'envoyer des données à votre site web avant qu’ils soient confirmés par courrier électronique, par SMS ou via un autre mécanisme.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-194">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="build-a-more-complete-sample"></a><span data-ttu-id="7d0eb-195">Créer un exemple plus complet</span><span class="sxs-lookup"><span data-stu-id="7d0eb-195">Build a more complete sample</span></span>

<span data-ttu-id="7d0eb-196">Dans cette section, vous allez utiliser NuGet pour télécharger un exemple plus complet avec lequel nous allons travailler.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-196">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="7d0eb-197">Créez un projet Web ASP.NET ***vide*** .</span><span class="sxs-lookup"><span data-stu-id="7d0eb-197">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="7d0eb-198">Dans la console du gestionnaire de package, entrez les commandes suivantes :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-198">In the Package Manager Console, enter the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="7d0eb-199">Dans ce didacticiel, nous allons utiliser [SendGrid](http://sendgrid.com/) pour envoyer des courriers électroniques.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-199">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="7d0eb-200">Le package `Identity.Samples` installe le code que nous allons utiliser.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-200">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="7d0eb-201">Définissez le [projet pour utiliser SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-201">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="7d0eb-202">Testez la création du compte local en exécutant l’application, en sélectionnant le lien **Register** et en publiant le formulaire d’inscription.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-202">Test local account creation by running the app, selecting the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="7d0eb-203">Sélectionnez le lien e-mail de démonstration, qui simule la confirmation de l’e-mail.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-203">Select the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="7d0eb-204">Supprimez le code de confirmation de la liaison par e-mail de démonstration de l’exemple (le code `ViewBag.Link` dans le contrôleur de compte.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-204">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="7d0eb-205">Consultez les méthodes d’action `DisplayEmail` et `ForgotPasswordConfirmation` et les vues Razor).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-205">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!WARNING]
> <span data-ttu-id="7d0eb-206">Si vous modifiez l’un des paramètres de sécurité de cet exemple, les applications de production doivent subir un audit de sécurité qui appelle explicitement les modifications apportées.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-206">If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>

## <a name="examine-the-code-in-app_startidentityconfigcs"></a><span data-ttu-id="7d0eb-207">Examinez le code dans l’application\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="7d0eb-207">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="7d0eb-208">L’exemple montre comment créer un compte et l’ajouter au rôle d' *administrateur* .</span><span class="sxs-lookup"><span data-stu-id="7d0eb-208">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="7d0eb-209">Vous devez remplacer l’adresse de messagerie dans l’exemple par le courrier électronique que vous allez utiliser pour le compte d’administrateur.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-209">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="7d0eb-210">La méthode la plus simple pour créer un compte d’administrateur est par programmation dans la méthode `Seed`.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-210">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="7d0eb-211">Nous espérons avoir un outil à l’avenir qui vous permettra de créer et d’administrer des utilisateurs et des rôles.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-211">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="7d0eb-212">L’exemple de code vous permet de créer et de gérer des utilisateurs et des rôles, mais vous devez d’abord disposer d’un compte administrateurs pour exécuter les pages rôles et administrateur d’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-212">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="7d0eb-213">Dans cet exemple, le compte d’administrateur est créé lorsque la base de code est amorcée.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-213">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="7d0eb-214">Modifiez le mot de passe et remplacez le nom par un compte dans lequel vous pouvez recevoir des notifications par courrier électronique.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-214">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="7d0eb-215">Sécurité - Ne jamais stocker de données sensibles dans votre code source.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-215">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="7d0eb-216">Comme mentionné précédemment, l’appel de `app.CreatePerOwinContext` dans la classe Startup ajoute des rappels à la méthode `Create` du contenu de la base de données de l’application, au gestionnaire des utilisateurs et aux classes de gestionnaires de rôles.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-216">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="7d0eb-217">Le pipeline OWIN appelle la méthode `Create` sur ces classes pour chaque requête et stocke le contexte pour chaque classe.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-217">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="7d0eb-218">Le contrôleur de compte expose le gestionnaire des utilisateurs à partir du contexte HTTP (qui contient le contexte OWIN) :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-218">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="7d0eb-219">Lorsqu’un utilisateur inscrit un compte local, la méthode `HTTP Post Register` est appelée :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-219">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="7d0eb-220">Le code ci-dessus utilise les données du modèle pour créer un nouveau compte d’utilisateur à l’aide de l’adresse de messagerie et du mot de passe entrés.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-220">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="7d0eb-221">Si l’alias de messagerie se trouve dans le magasin de données, la création du compte échoue et le formulaire s’affiche à nouveau.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-221">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="7d0eb-222">La méthode `GenerateEmailConfirmationTokenAsync` crée un jeton de confirmation sécurisé et le stocke dans le magasin de données ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-222">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="7d0eb-223">La méthode [URL. action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) crée un lien contenant le `UserId` et le jeton de confirmation.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-223">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="7d0eb-224">Ce lien est ensuite envoyé par courrier électronique à l’utilisateur, l’utilisateur peut sélectionner le lien dans son application de messagerie pour confirmer son compte.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-224">This link is then emailed to the user, the user can select on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="7d0eb-225">Configurer la confirmation par e-mail</span><span class="sxs-lookup"><span data-stu-id="7d0eb-225">Set up email confirmation</span></span>

<span data-ttu-id="7d0eb-226">Accédez à la [page d’inscription à Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) et inscrivez-vous pour obtenir un compte gratuit.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-226">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="7d0eb-227">Ajoutez du code semblable au suivant pour configurer SendGrid :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-227">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="7d0eb-228">Les clients de messagerie acceptent souvent uniquement les messages texte (pas de code HTML).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-228">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="7d0eb-229">Vous devez fournir le message au format texte et HTML.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-229">You should provide the message in text and HTML.</span></span> <span data-ttu-id="7d0eb-230">Dans l’exemple SendGrid ci-dessus, cette opération est effectuée avec le `myMessage.Text` et `myMessage.Html` code indiqué ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-230">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>

<span data-ttu-id="7d0eb-231">Le code suivant montre comment envoyer un e-mail à l’aide de la classe [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) où `message.Body` retourne uniquement le lien.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-231">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="7d0eb-232">Sécurité - Ne jamais stocker de données sensibles dans votre code source.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-232">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="7d0eb-233">Le compte et les informations d’identification sont stockés dans l’appSetting.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-233">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="7d0eb-234">Sur Azure, vous pouvez stocker en toute sécurité ces valeurs sur l'onglet **[Configurer](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** dans le portail Azure.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-234">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="7d0eb-235">Consultez [les meilleures pratiques pour le déploiement des mots de passe et autres données sensibles sur ASP.NET et Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-235">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>

<span data-ttu-id="7d0eb-236">Entrez vos informations d’identification SendGrid, exécutez l’application, inscrivez-vous avec un alias de messagerie vous pouvez sélectionner le lien confirmer dans votre e-mail.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-236">Enter your SendGrid credentials, run the app, register with an email alias can select the confirm link in your email.</span></span> <span data-ttu-id="7d0eb-237">Pour savoir comment faire avec votre compte de messagerie [Outlook.com](http://outlook.com) , consultez Configuration SMTP de John atten [ C# pour l’hôte SMTP Outlook.com](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) et son[ASP.net Identity 2,0 : configuration de la validation de compte et des publications d’autorisation à deux facteurs](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) .</span><span class="sxs-lookup"><span data-stu-id="7d0eb-237">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="7d0eb-238">Une fois qu’un utilisateur a sélectionné le bouton **inscrire** , un e-mail de confirmation contenant un jeton de validation est envoyé à son adresse de messagerie.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-238">Once a user selects the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="7d0eb-239">L’utilisateur reçoit un e-mail avec un jeton de confirmation pour son compte.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-239">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="7d0eb-240">Examiner le code</span><span class="sxs-lookup"><span data-stu-id="7d0eb-240">Examine the code</span></span>

<span data-ttu-id="7d0eb-241">Le code suivant montre la méthode `POST ForgotPassword`.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-241">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="7d0eb-242">La méthode échoue en silence si la messagerie de l’utilisateur n’a pas été confirmée.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-242">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="7d0eb-243">Si une erreur a été publiée pour une adresse de messagerie non valide, des utilisateurs malveillants pouvaient utiliser ces informations pour trouver des ID d’utilisateur (alias de messagerie) valides pour attaquer.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-243">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="7d0eb-244">Le code suivant montre la méthode `ConfirmEmail` dans le contrôleur de compte qui est appelée lorsque l’utilisateur sélectionne le lien de confirmation dans le message électronique qui lui est envoyé :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-244">The following code shows the `ConfirmEmail` method in the account controller that is called when the user selects the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="7d0eb-245">Une fois qu’un jeton de mot de passe oublié a été utilisé, il est invalidé.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-245">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="7d0eb-246">La modification de code suivante dans la méthode `Create` (dans le fichier *App\_Start\IdentityConfig.cs* ) définit les jetons pour qu’ils expirent dans 3 heures.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-246">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="7d0eb-247">Avec le code ci-dessus, le mot de passe oublié et les jetons de confirmation par courrier électronique expirent dans 3 heures.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-247">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="7d0eb-248">La `TokenLifespan` par défaut est d’un jour.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-248">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="7d0eb-249">Le code suivant illustre la méthode de confirmation par courrier électronique :</span><span class="sxs-lookup"><span data-stu-id="7d0eb-249">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="7d0eb-250">Pour renforcer la sécurité de votre application, ASP.NET Identity prend en charge l’authentification à deux facteurs (2FA).</span><span class="sxs-lookup"><span data-stu-id="7d0eb-250">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="7d0eb-251">Consultez [ASP.NET Identity 2,0 : configuration de la validation de compte et de l’autorisation à deux facteurs](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) par John atten.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-251">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="7d0eb-252">Bien que vous puissiez définir le verrouillage de compte lors de tentatives de mot de passe de connexion, cette approche rend votre connexion vulnérable aux verrouillages [dos](http://en.wikipedia.org/wiki/Denial-of-service_attack) .</span><span class="sxs-lookup"><span data-stu-id="7d0eb-252">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="7d0eb-253">Nous vous recommandons d’utiliser le verrouillage de compte uniquement avec 2FA.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-253">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="7d0eb-254">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="7d0eb-254">Additional resources</span></span>

- [<span data-ttu-id="7d0eb-255">Vue d’ensemble des fournisseurs de stockage personnalisés pour ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="7d0eb-255">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="7d0eb-256">L' [application MVC 5 avec Facebook, Twitter, LinkedIn et l’authentification Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) montre également comment ajouter des informations de profil au tableau utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-256">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="7d0eb-257">[ASP.NET MVC et identity 2,0 : présentation des concepts de base](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) de John atten.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-257">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="7d0eb-258">Introduction à ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="7d0eb-258">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="7d0eb-259">[Annonce de la version RTM de ASP.net Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) par Pranav Rastogi.</span><span class="sxs-lookup"><span data-stu-id="7d0eb-259">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
