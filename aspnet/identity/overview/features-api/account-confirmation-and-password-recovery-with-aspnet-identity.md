---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: Compte Confirmation & de la récupération de mot de passe - ASP.NET Identity (C#)-ASP.NET 4.x
author: HaoK
description: Avant d’effectuer ce didacticiel, que vous devez effectuer tout d’abord créer une application web de ASP.NET MVC 5 sécurisée avec connexion, réinitialisation de confirmation et le mot de passe de messagerie. Ce didacticiel...
ms.author: riande
ms.date: 01/23/2019
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 2e4cd21d66e69590fb1642d7974e4b7f82cba0cb
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/09/2019
ms.locfileid: "59396419"
---
# <a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="a4ec0-104">Compte de récupération de confirmation et le mot de passe avec ASP.NET Identity (C#)</span><span class="sxs-lookup"><span data-stu-id="a4ec0-104">Account confirmation and password recovery with ASP.NET Identity (C#)</span></span>

> <span data-ttu-id="a4ec0-105">Avant de procéder à ce didacticiel vous devez commencer par suivre [créer une application web de ASP.NET MVC 5 sécurisée avec connexion, réinitialisation de confirmation et le mot de passe de messagerie](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-105">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="a4ec0-106">Ce didacticiel contient plus de détails et vous montrera comment paramétrer la messagerie électronique de confirmation de compte local et aux utilisateurs de réinitialiser leur mot de passe oublié dans ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-106">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span>

<span data-ttu-id="a4ec0-107">Un compte d’utilisateur local, l’utilisateur doit créer un mot de passe pour le compte et ce mot de passe est stocké (en toute sécurité) dans l’application web.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-107">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="a4ec0-108">ASP.NET Identity prend également en charge les comptes de réseaux sociaux, qui ne nécessitent pas l’utilisateur de créer un mot de passe pour l’application.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-108">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="a4ec0-109">[Comptes de réseaux sociaux](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) utiliser un tiers (par exemple, Google, Twitter, Facebook ou Microsoft) pour authentifier les utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-109">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook, or Microsoft) to authenticate users.</span></span> <span data-ttu-id="a4ec0-110">Cette rubrique aborde les thèmes suivants :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-110">This topic covers the following:</span></span>

- <span data-ttu-id="a4ec0-111">[Créer une application ASP.NET MVC](#createMvc) et Explorer les fonctionnalités d’identité ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-111">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="a4ec0-112">Générer l’exemple d’identité</span><span class="sxs-lookup"><span data-stu-id="a4ec0-112">Build the Identity sample</span></span>](#build)
- [<span data-ttu-id="a4ec0-113">Configurer la confirmation par courrier électronique</span><span class="sxs-lookup"><span data-stu-id="a4ec0-113">Set up email confirmation</span></span>](#email)

<span data-ttu-id="a4ec0-114">Nouveaux utilisateurs inscrivent leurs alias de messagerie, ce qui crée un compte local.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-114">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="a4ec0-115">En sélectionnant le bouton inscrire envoie un e-mail de confirmation contenant un jeton de validation à une adresse e-mail.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-115">Selecting the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="a4ec0-116">L’utilisateur reçoit un e-mail avec un jeton de confirmation pour leur compte.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-116">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="a4ec0-117">En sélectionnant le lien confirme le compte.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-117">Selecting the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="a4ec0-118">Récupération de mot de passe/réinitialisation</span><span class="sxs-lookup"><span data-stu-id="a4ec0-118">Password recovery/reset</span></span>

<span data-ttu-id="a4ec0-119">Les utilisateurs locaux qui oublient leur mot de passe peuvent avoir un jeton de sécurité envoyé à son compte de messagerie, ce qui leur permet de réinitialiser leur mot de passe.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-119">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="a4ec0-120">L’utilisateur sera bientôt un e-mail avec un lien leur permettant de réinitialiser leur mot de passe.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-120">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="a4ec0-121">En sélectionnant le lien mène à la page de réinitialisation.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-121">Selecting the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="a4ec0-122">En sélectionnant le **réinitialiser** bouton pour confirmer le mot de passe a été réinitialisé.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-122">Selecting the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="a4ec0-123">Créer une application web ASP.NET</span><span class="sxs-lookup"><span data-stu-id="a4ec0-123">Create an ASP.NET web app</span></span>

<span data-ttu-id="a4ec0-124">Démarrez en installant et en cours d’exécution [Visual Studio 2017](https://visualstudio.microsoft.com/).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-124">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/).</span></span>


1. <span data-ttu-id="a4ec0-125">Créez un projet Web ASP.NET et sélectionnez le modèle MVC.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-125">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="a4ec0-126">Web Forms prennent également en charge ASP.NET Identity, afin que vous pouvez suivre des étapes similaires dans une application web forms.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-126">Web Forms also support ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="a4ec0-127">Définissez l’authentification sur **comptes d’utilisateur individuels**.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-127">Change the authentication to **Individual User Accounts**.</span></span>
3. <span data-ttu-id="a4ec0-128">Exécutez l’application, sélectionnez le **inscrire** lier et inscrire un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-128">Run the app, select the **Register** link and register a user.</span></span> <span data-ttu-id="a4ec0-129">À ce stade, la seule validation sur l’adresse e-mail se fait avec l'attribut [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-129">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="a4ec0-130">Dans l’Explorateur de serveurs, accédez à **données Connections\DefaultConnection\Tables\AspNetUsers**, avec le bouton droit et sélectionnez **ouvrir la définition de la table**.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-130">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right-click and select **Open table definition**.</span></span>

    <span data-ttu-id="a4ec0-131">L’illustration suivante montre le schéma `AspNetUsers` :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-131">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="a4ec0-132">Avec le bouton droit sur le **AspNetUsers** de table et sélectionnez **afficher les données de Table**.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-132">Right-click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="a4ec0-133">À ce stade, l’adresse de messagerie n’a pas été confirmée.
</span><span class="sxs-lookup"><span data-stu-id="a4ec0-133">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="a4ec0-134">Le magasin de données par défaut pour ASP.NET Identity est Entity Framework, mais vous pouvez le configurer pour utiliser d’autres magasins de données et ajouter des champs supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-134">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="a4ec0-135">Consultez [des ressources supplémentaires](#addRes) section à la fin de ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-135">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="a4ec0-136">Le [classe de démarrage OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) est appelée lorsque l’application démarre et appelle le `ConfigureAuth` méthode dans *application\_Start\Startup.Auth.cs*, qui configure le pipeline OWIN et initialise l’identité ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-136">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="a4ec0-137">Examinez la méthode `ConfigureAuth`.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-137">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="a4ec0-138">Chaque `CreatePerOwinContext` appel enregistre un rappel (enregistré dans le `OwinContext`) qui sera appelé une fois par demande pour créer une instance du type spécifié.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-138">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="a4ec0-139">Vous pouvez définir un point d’arrêt dans le constructeur et `Create` de chaque type (méthode) (`ApplicationDbContext, ApplicationUserManager`) et vérifiez qu’ils sont appelés à chaque demande.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-139">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="a4ec0-140">Une instance de `ApplicationDbContext` et `ApplicationUserManager` est stocké dans le contexte OWIN, qui est accessible dans toute l’application.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-140">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="a4ec0-141">ASP.NET Identity raccorde le pipeline OWIN via middleware de cookie.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-141">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="a4ec0-142">Pour plus d’informations, consultez [par la gestion des demandes de durée de vie pour la classe UserManager dans ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-142">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="a4ec0-143">Lorsque vous modifiez votre profil de sécurité, un nouvel horodatage de sécurité est généré et stocké dans le `SecurityStamp` champ la *AspNetUsers* table.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-143">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="a4ec0-144">Notez que le `SecurityStamp` champ diffère le cookie de sécurité.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-144">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="a4ec0-145">Le cookie de sécurité n’est pas stocké dans le `AspNetUsers` table (ou tout autre emplacement de la base de données d’identité).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-145">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="a4ec0-146">Le jeton de cookie de sécurité est auto-signé à l’aide de [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) et est créé avec le `UserId, SecurityStamp` et les informations d’heure d’expiration.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-146">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="a4ec0-147">Le middleware de cookie vérifie le cookie à chaque demande.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-147">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="a4ec0-148">Le `SecurityStampValidator` méthode dans le `Startup` classe accède à la base de données et vérifie le tampon de sécurité régulièrement, comme spécifié par le `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-148">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="a4ec0-149">Cela se produit uniquement toutes les 30 minutes (dans notre exemple), sauf si vous modifiez votre profil de sécurité.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-149">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="a4ec0-150">L’intervalle de 30 minutes a été choisi pour réduire les allers-retours vers la base de données.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-150">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="a4ec0-151">Consultez mon [didacticiel d’authentification à deux facteurs](index.md) pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-151">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="a4ec0-152">Par les commentaires dans le code, le `UseCookieAuthentication` méthode prend en charge l’authentification des cookies.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-152">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="a4ec0-153">Le `SecurityStamp` code de champ et associé fournit une couche supplémentaire de sécurité à votre application, lorsque vous modifiez votre mot de passe, vous serez connecté en dehors du navigateur que vous êtes connecté.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-153">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="a4ec0-154">Le `SecurityStampValidator.OnValidateIdentity` méthode permet à l’application valider le jeton de sécurité lors de l’utilisateur se connecte, qui est utilisée lorsque vous modifiez un mot de passe ou utilisez la connexion externe.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-154">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="a4ec0-155">Cela est nécessaire pour vous assurer que tous les jetons (cookies) générés avec l’ancien mot de passe sont invalidés.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-155">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="a4ec0-156">Dans l’exemple de projet, si vous modifiez le mot de passe utilisateurs, puis un nouveau jeton est généré pour l’utilisateur, tous les jetons précédentes sont invalidées et `SecurityStamp` champ est mis à jour.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-156">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="a4ec0-157">Le système d’identité vous autorise à configurer votre application, lorsque le profil de sécurité des utilisateurs change (par exemple, lorsque l’utilisateur modifie son mot de passe ou les modifications associé nom de connexion (par exemple, de Facebook, Google, compte Microsoft, etc.), l’utilisateur est déconnecté tous les instances de navigateur.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-157">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="a4ec0-158">Par exemple, l’image ci-dessous montre le [exemple de déconnexion unique](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) application, ce qui permet à l’utilisateur de se déconnecter de toutes les instances de navigateur (dans ce cas, Internet Explorer, Firefox et Chrome) en sélectionnant un bouton.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-158">For example, the image below shows the [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by selecting one button.</span></span> <span data-ttu-id="a4ec0-159">Vous pouvez également l’exemple vous permet d’enregistrer uniquement en dehors d’une instance du navigateur spécifique.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-159">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="a4ec0-160">Le [exemple de déconnexion unique](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) application montre comment ASP.NET Identity vous permet de régénérer le jeton de sécurité.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-160">The [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="a4ec0-161">Cela est nécessaire pour vous assurer que tous les jetons (cookies) générés avec l’ancien mot de passe sont invalidés.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-161">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="a4ec0-162">Cette fonctionnalité fournit une couche supplémentaire de sécurité à votre application ; Lorsque vous modifiez votre mot de passe, vous allez être déconnecté d’où vous êtes connecté à cette application.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-162">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="a4ec0-163">Le *application\_Start\IdentityConfig.cs* fichier contient le `ApplicationUserManager`, `EmailService` et `SmsService` classes.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-163">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="a4ec0-164">Le `EmailService` et `SmsService` classes chaque implémentent la `IIdentityMessageService` interface, afin d’avoir des méthodes courantes dans chaque classe pour configurer l’e-mail et SMS.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-164">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="a4ec0-165">Bien que ce didacticiel montre uniquement comment ajouter la notification par courrier électronique via [SendGrid](http://sendgrid.com/), vous pouvez envoyer des e-mails à l’aide de SMTP et autres mécanismes.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-165">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="a4ec0-166">Le `Startup` classe contient également standard pour ajouter des connexions sociales (Facebook, Twitter, etc.), consultez mon didacticiel [application MVC 5 avec Facebook, Twitter, LinkedIn et authentification Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-166">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="a4ec0-167">Examiner la `ApplicationUserManager` classe, qui contient les informations d’identité utilisateurs et configure les fonctionnalités suivantes :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-167">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="a4ec0-168">Exigences de force de mot de passe.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-168">Password strength requirements.</span></span>
- <span data-ttu-id="a4ec0-169">Verrouillage utilisateur (tentatives et l’heure).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-169">User lock out (attempts and time).</span></span>
- <span data-ttu-id="a4ec0-170">Authentification à deux facteurs (2FA).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-170">Two-factor authentication (2FA).</span></span> <span data-ttu-id="a4ec0-171">Je vais aborder 2FA et SMS dans un autre didacticiel.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-171">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="a4ec0-172">Raccorder l’e-mail et les services SMS.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-172">Hooking up the email and SMS services.</span></span> <span data-ttu-id="a4ec0-173">(J’aborderai SMS dans un autre didacticiel).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-173">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="a4ec0-174">Le `ApplicationUserManager` classe est dérivée de l’objet générique `UserManager<ApplicationUser>` classe.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-174">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> `ApplicationUser` <span data-ttu-id="a4ec0-175">dérive de [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-175">derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> `IdentityUser` <span data-ttu-id="a4ec0-176">dérive le générique `IdentityUser` classe :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-176">derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="a4ec0-177">Les propriétés ci-dessus coïncident avec les propriétés dans le `AspNetUsers` table, ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-177">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="a4ec0-178">Les arguments génériques sur `IUser` vous permettent de dériver une classe à l’aide de différents types pour la clé primaire.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-178">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="a4ec0-179">Consultez le [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) exemple qui montre comment modifier la clé primaire à partir de la chaîne en int ou GUID.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-179">See the [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="a4ec0-180">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="a4ec0-180">ApplicationUser</span></span>

`ApplicationUser` <span data-ttu-id="a4ec0-181">(`public class ApplicationUserManager : UserManager<ApplicationUser>`) est défini dans *Models\IdentityModels.cs* en tant que :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-181">(`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="a4ec0-182">Le code en surbrillance ci-dessus génère un [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-182">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="a4ec0-183">ASP.NET Identity et l’authentification des cookies OWIN basée sur les revendications, par conséquent, le framework requiert l’application pour générer un `ClaimsIdentity` pour l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-183">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> `ClaimsIdentity` <span data-ttu-id="a4ec0-184">contient des informations sur toutes les revendications pour l’utilisateur, telles que le nom d’utilisateur, l’âge et les rôles de l’utilisateur appartient.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-184">has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="a4ec0-185">Vous pouvez également ajouter plusieurs revendications de l’utilisateur à ce stade.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-185">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="a4ec0-186">OWIN `AuthenticationManager.SignIn` méthode passe dans le `ClaimsIdentity` et se connecte l’utilisateur :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-186">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="a4ec0-187">[Application MVC 5 avec Facebook, Twitter, LinkedIn et authentification Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) montre comment vous pouvez ajouter des propriétés supplémentaires à la `ApplicationUser` classe.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-187">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="a4ec0-188">E-mail de confirmation</span><span class="sxs-lookup"><span data-stu-id="a4ec0-188">Email confirmation</span></span>

<span data-ttu-id="a4ec0-189">Il est judicieux de confirmer l’adresse de messagerie un nouvel utilisateur auprès de vérifier qu’ils ne sont pas emprunter l’identité d’une autre personne (autrement dit, ils n’ont pas inscrit auprès de quelqu'un d’autre e-mail).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-189">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="a4ec0-190">Supposons que vous ayez un forum de discussion : vous voudriez empêcher `"bob@example.com"` de s'inscrire en tant que `"joe@contoso.com"`.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-190">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="a4ec0-191">ans la confirmation par courrier électronique, `"joe@contoso.com"` pourrait recevoir du courrier indésirable à partir de votre application.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-191">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="a4ec0-192">Supposons que Bob accidentellement inscrit en tant que `"bib@example.com"` et vous l’auriez pas remarqué, il ne serait pas en mesure d’utiliser la récupération de mot de passe, car l’application n’a pas son adresse de messagerie correcte.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-192">Suppose Bob accidentally registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="a4ec0-193">E-mail de confirmation fournit uniquement une protection limitée des robots et ne fournit pas une protection à partir des expéditeurs de courrier indésirable déterminés, ils ont des alias de messagerie travail nombreux, qu'ils peuvent utiliser pour inscrire. Dans l’exemple ci-dessous, l’utilisateur ne pourra modifier son mot de passe jusqu'à ce que son compte a été confirmé (en les sélectionnant reçu sur le compte de messagerie avec qu'ils inscrits un lien de confirmation.) Vous pouvez appliquer ce flux de travail à d’autres scénarios, par exemple envoyer un lien pour confirmer et réinitialiser le mot de passe sur les nouveaux comptes créés par l’administrateur, en envoyant à l’utilisateur un e-mail lorsque qu’ils ont modifié leur profil et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-193">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them selecting a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="a4ec0-194">En règle générale, vous souhaitez empêcher les nouveaux utilisateurs d'envoyer des données à votre site web avant qu’ils soient confirmés par courrier électronique, par SMS ou via un autre mécanisme.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-194">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="build-a-more-complete-sample"></a><span data-ttu-id="a4ec0-195">Générer un exemple plus complet</span><span class="sxs-lookup"><span data-stu-id="a4ec0-195">Build a more complete sample</span></span>

<span data-ttu-id="a4ec0-196">Dans cette section, vous allez utiliser NuGet pour télécharger un exemple plus complet, de que nous nous efforcerons.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-196">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="a4ec0-197">Créer un nouveau ***vide*** projet Web ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-197">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="a4ec0-198">Dans la Console du Gestionnaire de Package, entrez les commandes suivantes :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-198">In the Package Manager Console, enter the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="a4ec0-199">Dans ce didacticiel, nous allons utiliser [SendGrid](http://sendgrid.com/) pour envoyer un e-mail.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-199">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="a4ec0-200">Le `Identity.Samples` package installe le code que nous travaillons avec.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-200">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="a4ec0-201">Définir le [projet pour utiliser SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-201">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="a4ec0-202">Tester la création du compte local en exécutant l’application, en sélectionnant le **inscrire** de liaison et de publier le formulaire d’inscription.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-202">Test local account creation by running the app, selecting the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="a4ec0-203">Sélectionnez le lien de messagerie de démonstration, qui simule l’e-mail de confirmation.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-203">Select the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="a4ec0-204">Supprimer le code de confirmation de lien e-mail démonstration de l’exemple (le `ViewBag.Link` code dans le contrôleur de compte.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-204">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="a4ec0-205">Consultez le `DisplayEmail` et `ForgotPasswordConfirmation` méthodes d’action et les vues razor).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-205">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!WARNING]
> <span data-ttu-id="a4ec0-206">Si vous modifiez les paramètres de sécurité dans cet exemple, les applications de productions devez sont soumis à un audit de sécurité qui appelle explicitement les modifications apportées.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-206">If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>


## <a name="examine-the-code-in-appstartidentityconfigcs"></a><span data-ttu-id="a4ec0-207">Examinez le code dans l’application\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="a4ec0-207">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="a4ec0-208">L’exemple montre comment créer un compte et l’ajouter à la *administrateur* rôle.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-208">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="a4ec0-209">Vous devez remplacer l’e-mail dans l’exemple avec l’e-mail que vous utiliserez pour le compte d’administrateur.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-209">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="a4ec0-210">Le moyen le plus simple pour créer un compte d’administrateur est par programmation dans le `Seed` (méthode).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-210">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="a4ec0-211">Nous espérons que dans le futur un outil qui vous permet de créer et administrer des utilisateurs et des rôles.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-211">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="a4ec0-212">L’exemple de code vous permet à créer et gérer des utilisateurs et des rôles, mais vous devez disposer d’un compte d’administrateurs pour exécuter les rôles et les pages d’administration utilisateur.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-212">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="a4ec0-213">Dans cet exemple, le compte d’administrateur est créé lors de la base de données est amorcée.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-213">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="a4ec0-214">Remplacez le mot de passe et le nom à un compte dans lequel vous pouvez recevoir des notifications par courrier électronique.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-214">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="a4ec0-215">Sécurité - Ne jamais stocker de données sensibles dans votre code source.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-215">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="a4ec0-216">Comme mentionné précédemment, le `app.CreatePerOwinContext` appel de la classe startup ajoute des rappels pour le `Create` méthode l’application DB contenus, manager et le rôle Gestionnaire de classes d’utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-216">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="a4ec0-217">Appels de pipeline OWIN le `Create` méthode sur ces classes pour chaque demande et stocke le contexte pour chaque classe.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-217">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="a4ec0-218">Le contrôleur de compte expose le Gestionnaire des utilisateurs à partir du contexte HTTP (qui contient le contexte OWIN) :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-218">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="a4ec0-219">Lorsqu’un utilisateur s’inscrit à un compte local, le `HTTP Post Register` méthode est appelée :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-219">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="a4ec0-220">Le code ci-dessus utilise les données du modèle pour créer un nouveau compte d’utilisateur à l’aide de l’e-mail et le mot de passe entré.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-220">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="a4ec0-221">Si l’alias de messagerie se trouve dans le magasin de données, la création du compte échoue et le formulaire s’affiche à nouveau.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-221">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="a4ec0-222">Le `GenerateEmailConfirmationTokenAsync` méthode crée un jeton de confirmation sécurisé et les stocke dans le magasin de données d’identité ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-222">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="a4ec0-223">Le [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) méthode crée un lien contenant le `UserId` et jeton de confirmation.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-223">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="a4ec0-224">Ce lien est ensuite envoyé par e-mail à l’utilisateur, l’utilisateur peut sélectionner sur le lien dans leur application de messagerie pour confirmer son compte.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-224">This link is then emailed to the user, the user can select on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="a4ec0-225">Configurer la confirmation par courrier électronique</span><span class="sxs-lookup"><span data-stu-id="a4ec0-225">Set up email confirmation</span></span>

<span data-ttu-id="a4ec0-226">Accédez à la [page d’inscription Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) et vous inscrire gratuitement compte.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-226">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="a4ec0-227">Ajoutez un code similaire à ce qui suit pour configurer SendGrid :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-227">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="a4ec0-228">Souvent, les clients de messagerie acceptent uniquement les messages de texte (aucun HTML).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-228">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="a4ec0-229">Vous devez fournir le message en texte et HTML.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-229">You should provide the message in text and HTML.</span></span> <span data-ttu-id="a4ec0-230">Dans l’exemple de SendGrid ci-dessus, cela se fait par le `myMessage.Text` et `myMessage.Html` code ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-230">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>


<span data-ttu-id="a4ec0-231">Le code suivant montre comment envoyer des e-mails à l’aide du [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) classe where `message.Body` retourne uniquement le lien.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-231">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="a4ec0-232">Sécurité - Ne jamais stocker de données sensibles dans votre code source.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-232">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="a4ec0-233">Le compte et les informations d’identification sont stockés dans l’appSetting.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-233">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="a4ec0-234"> Sur Azure, vous pouvez stocker en toute sécurité ces valeurs sur l'onglet **[Configurer](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** dans le portail Azure.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-234">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="a4ec0-235">Consultez [les meilleures pratiques pour le déploiement des mots de passe et autres données sensibles sur ASP.NET et Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-235">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>


<span data-ttu-id="a4ec0-236">Entrez vos informations d’identification SendGrid, exécuter l’application, s’enregistrer auprès d’un alias de messagerie peut sélectionner le lien de confirmation dans votre adresse de messagerie.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-236">Enter your SendGrid credentials, run the app, register with an email alias can select the confirm link in your email.</span></span> <span data-ttu-id="a4ec0-237">Pour voir comment procéder avec votre [Outlook.com](http://outlook.com) compte de messagerie, consultez de John Atten [ C# Configuration SMTP pour l’hôte SMTP de Outlook.Com](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) et son[ASP.NET Identity 2.0 : Validation de compte et l’autorisation de deux facteurs](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) valide.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-237">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="a4ec0-238">Une fois qu’un utilisateur sélectionne le **inscrire** bouton un e-mail de confirmation contenant un jeton de validation est envoyé à une adresse e-mail.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-238">Once a user selects the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="a4ec0-239">L’utilisateur reçoit un e-mail avec un jeton de confirmation pour leur compte.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-239">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="a4ec0-240">Examinez le code</span><span class="sxs-lookup"><span data-stu-id="a4ec0-240">Examine the code</span></span>

<span data-ttu-id="a4ec0-241">Le code suivant montre la méthode `POST ForgotPassword`.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-241">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="a4ec0-242">La méthode échoue sans avertissement si l’e-mail de l’utilisateur n’a pas été confirmée.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-242">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="a4ec0-243">Si une erreur a été validée pour une adresse de messagerie non valide, les utilisateurs malveillants peuvent utiliser ces informations pour rechercher le nom d’utilisateur valide (alias de messagerie) aux attaques.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-243">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="a4ec0-244">Le code suivant illustre la `ConfirmEmail` méthode dans le contrôleur de compte qui est appelé lorsque l’utilisateur sélectionne le lien de confirmation dans le message électronique qui leur sont envoyé :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-244">The following code shows the `ConfirmEmail` method in the account controller that is called when the user selects the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="a4ec0-245">Une fois qu’un jeton de mot de passe oublié a été utilisé, elle est invalidée.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-245">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="a4ec0-246">Le changement de code suivant dans le `Create` (méthode) (dans le *application\_Start\IdentityConfig.cs* fichier) définit les jetons arrivent à expiration dans les 3 heures.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-246">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="a4ec0-247">Avec le code ci-dessus, le mot de passe oublié et les jetons de confirmation de courrier électronique va expirer dans les 3 heures.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-247">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="a4ec0-248">La valeur par défaut `TokenLifespan` est un jour.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-248">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="a4ec0-249">Le code suivant illustre la méthode de confirmation de courrier électronique :</span><span class="sxs-lookup"><span data-stu-id="a4ec0-249">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="a4ec0-250">Pour renforcer la sécurité de votre application, ASP.NET Identity prend en charge l’authentification à deux facteurs (2FA).</span><span class="sxs-lookup"><span data-stu-id="a4ec0-250">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="a4ec0-251">Consultez [ASP.NET Identity 2.0 : Configuration de la Validation du compte et l’autorisation de deux facteurs](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) par John Atten.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-251">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="a4ec0-252">Bien que vous pouvez définir le verrouillage de compte sur les échecs de tentative de mot de passe de connexion, cette approche rend votre identifiant de connexion susceptibles d’être [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) verrouillages.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-252">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="a4ec0-253">Nous vous recommandons de qu'utiliser le verrouillage de compte uniquement avec 2FA.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-253">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="a4ec0-254">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="a4ec0-254">Additional resources</span></span>

- [<span data-ttu-id="a4ec0-255">Vue d’ensemble des fournisseurs de stockage personnalisés pour ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="a4ec0-255">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="a4ec0-256">[Application MVC 5 avec Facebook, Twitter, LinkedIn et authentification Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) montre également comment ajouter des informations de profil à la table d’utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-256">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="a4ec0-257">[ASP.NET MVC et identité 2.0 : Comprendre les notions de base](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) par John Atten.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-257">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="a4ec0-258">Introduction à ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="a4ec0-258">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="a4ec0-259">[Annonce de version RTM d’ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) Pranav rastogi.</span><span class="sxs-lookup"><span data-stu-id="a4ec0-259">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
